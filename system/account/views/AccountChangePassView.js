define(["jquery","underscore","abstracts/View","jface","text!system/account/tmpl/accountChangePass.html","i18n!_common/nls/common","i18n!system/nls/system","_libs/jquery/multipass/jQuery.multipass"],function(s,r,e,a,t,o,n){var i="pop-change-password",l=e.extend({constructor:function(){e.apply(this,arguments)},show:function(){a.showOverlay();var e=this;try{a.window.getById(i).trigger("jw.activate")}catch(l){a.window.open({winId:i,headerHtml:n.changePassword,contentHtml:r.template(t,{i18n:n}),footerHtml:'<button type="submit" class="btn btn-primary">'+o.save.ucFirst()+"</button>"+'<a href="javascript:;" class="btn jw-close">'+o.cancel.ucFirst()+"</a>",addForm:'<form method="post" action=""></form>',centered:!0,draggable:!0,openCallback:function(){var a=this,t=this.find("form");t.on("submit",function(){var i={},l=o.error.ucFirst();t.find("input").each(function(){i[this.name]=s.trim(s(this).val())}),t.find("input.error").removeClass("error");var p=[],d=App.getCredentials().pass;if(i.oldPassword&&i.oldPassword==d||p.push({key:"oldPassword",msg:n.oldPasswordIsWrong}),i.password){var c=!1,u=50;i.password.length>u&&(p.push({key:"password",msg:n.errPassLength.replace("#max#",u)}),c=!0);var m=/[а-яё]/i;m.test(i.password)&&(p.push({key:"password",msg:n.errPassCyr}),c=!0),-1!=i.password.indexOf(":")&&(p.push({key:"password",msg:n.errPassColon}),c=!0),c||i.passwordRepeat==i.password||p.push({key:"passwordRepeat",msg:i.password&&i.passwordRepeat!=i.password?n.pleaseRepeatCorrectly:""})}else p.push({key:"password",msg:n.errNewPass});if(p.length){var w=[];return r.each(p,function(s){t.find("[name="+s.key+"]").addClass("error"),w.push(s.msg+".")}),alert(w.join("<br />"),o.error,{closeCallback:function(){t.find(".error").first().focus()}})}return App.trigger("stopall"),a.addClass("loading"),e.model.changePassword(i).done(function(){a.trigger("jw.close")}).fail(function(r){try{var e=s.parseJSON(r.responseText);alert(e.msg,e.hdr)}catch(a){alert(n.passChangeFailed,l)}}).always(function(){a.removeClass("loading")}),!1}),s.browser.ie11&&t.find("input[type=password]").multipass()},closeCallback:function(){this.find("input").val(""),a.hideOverlay(),App.trigger("startall")}})}}});return l});