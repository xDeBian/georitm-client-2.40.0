define(["jquery","underscore","jface","./SettingsGridView","text!../tmpl/staff.html","text!../tmpl/staffForm.html"],function(t,e,n,i,a,r){a=e.template(a),r=e.template(r);var o=i.prototype,s=i.extend({constructor:function(){this._data=null,this._ns=".staffgrid",i.apply(this,arguments)},initialize:function(t){this._i18n=t.i18n,o.initialize.apply(this,arguments)},_renderLayout:function(){var e=t("#settings").find("#staff");e.html(a({i18n:this._i18n})),this.setElement(e)},_loadData:function(){var e=this,n=new t.Deferred;return this._data?n.resolve(this._data):(App.getTechnicians().done(function(t){e._data=t,n.resolve(e._data)}),n)},_getGridOptions:function(){var n=this,i=this.$el.find("table"),a=o._getGridOptions.call(this),r=this._data,s=[{data:function(t){return n._formatFullName(t)}},{data:function(t){return e.escape(t.phone)}},{data:function(t){return n._formatRowEdit(t.id)+n._formatRowDelete(t.id)},"class":"controls text-center",searchable:!1,orderable:!1}];return t.extend(!0,a,{data:r,columns:s,scrollX:i.css("width"),scrollCollapse:!1,autoWidth:!1,language:{emptyTable:this._i18n.technicianNoRecords},rowCallback:function(e,n){e&&t(e).attr("data-id",n.id)}})},_formatFullName:function(t){var n=this._i18n.namesOrder,i=[];return e.each(n,function(e){e in t&&t[e].length&&i.push(t[e])}),i.join(" ")},_initEditor:function(){var e=this;o._initEditor.call(this),this.$el.on("click","i.icon-delete",function(){var i=t(this).data("id"),a=e._i18n.technicianDeleteConfirm.msg,r=e._i18n.technicianDeleteConfirm.hdr;n.confirm(a,r,{okCallback:function(){e.trigger("rowdelete",i)}})}),this.$el.on("dblclick","tr[data-id]",function(){e.trigger("rowedit",t(this).data("id"))})},_startEdit:function(t){var e;e=null===t?{id:0,fname:"",lname:"",mname:"",phone:""}:this._getPerson(t),e&&this._openPopup(e)},_getPerson:function(t){return this._data&&e.findWhere(this._data,{id:t})},_openPopup:function(t){var e=this;n.dialog.close(),n.showOverlay(),n.window.open({addClass:"settings-edit-popup",headerHtml:t.id?this._i18n.technician:this._i18n.technicianCreate,contentHtml:this._getFormHtml(t),addForm:'<form method="post" action=""></form>',footerHtml:'<button type="submit" class="btn btn-primary">'+this._i18n.save+"</button>"+'<a href="javascript:;" class="btn jw-close">'+this._i18n.cancel.ucFirst()+"</a>",width:430,centered:!0,dieAfter:0,openCallback:function(){var t=this.find("form");e._popup=this,t.find("input[name=phone]").numeric({decimal:"+",negative:!1,forceZero:!1}),t.on("submit",function(){e.loading=!0,e._popup.addClass("loading"),t.find(".error").removeClass("error");var n=t.serializeObject(!0),i=!n.id;return i||(n.id=Number(n.id)),e._save(n,!1).done(function(t){i?(e._data.push(t),e._addRow(t)):e._updateRow(t),e._popup.trigger("jw.close")}).fail(function(t){e.showErrors(t)}).always(function(){e.loading=!1,e._popup.removeClass("loading")}),!1})},showCallback:function(){this.find("input[type=text]").first().focus()},closeCallback:function(){n.hideOverlay()},dieCallback:function(){e._popup=null}})},_getFormHtml:function(t){var e=this._i18n;return r({person:t,labels:{fname:e.firstName.ucFirst(),lname:e.lname,mname:e.mname},i18n:e})},_validate:function(t){var e=[];return t.fname||e.push({key:"fname",msg:this._i18n.errEnterTechnicianName}),t.lname||e.push({key:"lname",msg:this._i18n.errEnterTechnicianLastName}),e.length?e:null},_save:function(n){var i,a=new t.Deferred;if(e.each(n,function(e,i){"id"!=i&&(n[i]=t.trim(e))}),i=this._validate(n))a.reject(i);else{var r=!n.id;r&&delete n.id,n.positionCode=App.POSITION_CODE_TECH,t.ajax({url:App.getBaseUrl()+"staff/"+(r?"create":"edit")+"/",data:n}).done(function(t){n.id||(n.id=t.id),a.resolve(n)}).fail(function(t){a.reject(t)})}return a},_updateRow:function(n){var i=n.id,a=this._getPerson(n.id),r=this._getRow(i),o=t(r.node()),s=o.children();e.extend(a,n),r.invalidate().data(a),s[0].innerHTML=this._formatFullName(a),s[1].innerHTML=a.phone},_delete:function(e){var n=new t.Deferred;return t.ajax({url:App.getBaseUrl()+"staff/delete/",data:{id:e}}).done(function(){n.resolve(e)}).fail(function(t){n.reject(t)}),n}});return s});