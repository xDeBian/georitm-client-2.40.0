define(["leaflet"],function(t){t.Control.Coordinates=t.Control.extend({options:{position:"bottomright",decimals:4,decimalSeperator:".",labelTemplateLat:"Lat: {y}",labelTemplateLng:"Lng: {x}",labelFormatterLat:void 0,labelFormatterLng:void 0,enableUserInput:!0,useDMS:!1,useLatLngOrder:!1,centerUserCoordinates:!1,markerType:t.marker,markerProps:{}},onAdd:function(e){this._map=e;var i="leaflet-control-coordinates",n=this._container=t.DomUtil.create("div",i),a=this.options;this._labelcontainer=t.DomUtil.create("div","uiElement label",n),this._label=t.DomUtil.create("span","labelFirst",this._labelcontainer),this._inputcontainer=t.DomUtil.create("div","uiElement input uiHidden",n);var o,r;return a.useLatLngOrder?(r=t.DomUtil.create("span","",this._inputcontainer),this._inputY=this._createInput("inputY",this._inputcontainer),o=t.DomUtil.create("span","",this._inputcontainer),this._inputX=this._createInput("inputX",this._inputcontainer)):(o=t.DomUtil.create("span","",this._inputcontainer),this._inputX=this._createInput("inputX",this._inputcontainer),r=t.DomUtil.create("span","",this._inputcontainer),this._inputY=this._createInput("inputY",this._inputcontainer)),o.innerHTML=a.labelTemplateLng.replace("{x}",""),r.innerHTML=a.labelTemplateLat.replace("{y}",""),t.DomEvent.on(this._inputX,"keyup",this._handleKeypress,this),t.DomEvent.on(this._inputY,"keyup",this._handleKeypress,this),e.on("mousemove",this._update,this),e.on("dragstart",this.collapse,this),e.whenReady(this._update,this),this._showsCoordinates=!0,a.enableUserInput&&t.DomEvent.addListener(this._container,"click",this._switchUI,this),n},_createInput:function(e,i){var n=t.DomUtil.create("input",e,i);return n.type="text",t.DomEvent.disableClickPropagation(n),n},_clearMarker:function(){this._map.removeLayer(this._marker)},_handleKeypress:function(t){switch(t.keyCode){case 27:this.collapse();break;case 13:this._handleSubmit(),this.collapse();break;default:this._handleSubmit()}},_handleSubmit:function(){var e=t.NumberFormatter.createValidNumber(this._inputX.value,this.options.decimalSeperator),i=t.NumberFormatter.createValidNumber(this._inputY.value,this.options.decimalSeperator);if(void 0!==e&&void 0!==i){var n=this._marker;n||(n=this._marker=this._createNewMarker(),n.on("click",this._clearMarker,this));var a=new t.LatLng(i,e);n.setLatLng(a),n.addTo(this._map),this.options.centerUserCoordinates&&this._map.setView(a,this._map.getZoom())}},expand:function(){this._showsCoordinates=!1,this._map.off("mousemove",this._update,this),t.DomEvent.addListener(this._container,"mousemove",t.DomEvent.stop),t.DomEvent.removeListener(this._container,"click",this._switchUI,this),t.DomUtil.addClass(this._labelcontainer,"uiHidden"),t.DomUtil.removeClass(this._inputcontainer,"uiHidden")},_createCoordinateLabel:function(e){var i,n,a=this.options;return i=a.labelFormatterLng?a.labelFormatterLng(e.lng):t.Util.template(a.labelTemplateLng,{x:this._getNumber(e.lng,a)}),n=a.labelFormatterLat?a.labelFormatterLat(e.lat):t.Util.template(a.labelTemplateLat,{y:this._getNumber(e.lat,a)}),a.useLatLngOrder?n+" "+i:i+" "+n},_getNumber:function(e,i){var n;return n=i.useDMS?t.NumberFormatter.toDMS(e):t.NumberFormatter.round(e,i.decimals,i.decimalSeperator)},collapse:function(){if(!this._showsCoordinates&&(this._map.on("mousemove",this._update,this),this._showsCoordinates=!0,this.options,t.DomEvent.addListener(this._container,"click",this._switchUI,this),t.DomEvent.removeListener(this._container,"mousemove",t.DomEvent.stop),t.DomUtil.addClass(this._inputcontainer,"uiHidden"),t.DomUtil.removeClass(this._labelcontainer,"uiHidden"),this._marker)){var e=this._createNewMarker(),i=this._marker.getLatLng();e.setLatLng(i);var n=t.DomUtil.create("div",""),a=t.DomUtil.create("div","",n);a.innerHTML=this._createCoordinateLabel(i);var o=t.DomUtil.create("a","",n);o.innerHTML="Remove",o.href="#";var r=t.DomEvent.stopPropagation;t.DomEvent.on(o,"click",r).on(o,"mousedown",r).on(o,"dblclick",r).on(o,"click",t.DomEvent.preventDefault).on(o,"click",function(){this._map.removeLayer(e)},this),e.bindPopup(n),e.addTo(this._map),this._map.removeLayer(this._marker),this._marker=null}},_switchUI:function(e){t.DomEvent.stop(e),t.DomEvent.stopPropagation(e),t.DomEvent.preventDefault(e),this._showsCoordinates?this.expand():this.collapse()},onRemove:function(t){t.off("mousemove",this._update,this)},_update:function(e){var i=e.latlng,n=this.options;i&&(i=i.wrap(),this._currentPos=i,this._inputY.value=t.NumberFormatter.round(i.lat,n.decimals,n.decimalSeperator),this._inputX.value=t.NumberFormatter.round(i.lng,n.decimals,n.decimalSeperator),this._label.innerHTML=this._createCoordinateLabel(i))},_createNewMarker:function(){return this.options.markerType(null,this.options.markerProps)}}),t.control.coordinates=function(e){return new t.Control.Coordinates(e)},t.Map.mergeOptions({coordinateControl:!1}),t.Map.addInitHook(function(){this.options.coordinateControl&&(this.coordinateControl=new t.Control.Coordinates,this.addControl(this.coordinateControl))}),t.NumberFormatter={round:function(e,i,n){var a=t.Util.formatNum(e,i)+"",o=a.split(".");if(o[1]){for(var r=i-o[1].length;r>0;r--)o[1]+="0";a=o.join(n||".")}return a},toDMS:function(t){var e=Math.floor(Math.abs(t)),i=60*(Math.abs(t)-e),n=Math.floor(i),a=60*(i-n),o=Math.round(a);60==o&&(n++,o="00"),60==n&&(e++,n="00"),10>o&&(o="0"+o),10>n&&(n="0"+n);var r="";return 0>t&&(r="-"),""+r+e+"&deg; "+n+"' "+o+"''"},createValidNumber:function(t,e){if(t&&t.length>0){var i=t.split(e||".");try{var n=Number(i.join("."));return isNaN(n)?void 0:n}catch(a){return void 0}}return void 0}}});