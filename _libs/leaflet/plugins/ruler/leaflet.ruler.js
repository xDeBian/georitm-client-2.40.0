define(["jquery","../draw/leaflet.draw"],function(t){function n(t){var n=this.options.i18n;return 1e3>t?t.toFixed(0)+" "+n.m:(t/1e3).toFixed(2)+" "+n.km}var e=L.DivIcon.extend({options:{iconSize:null,el:"div",className:"leaflet-editing-icon ruler-point"},createIcon:function(){this.options;var n=t('<div class="leaflet-editing-icon ruler-point"><strong></strong><div class="bubble ruler-bubble"><span></span><i></i></div></div>');return n[0]},createShadow:function(){return null}});return L.Control.RulerControl=L.Control.extend({options:{position:"topright",title:"Ruler",onClick:null},onAdd:function(t){return this._map=t,this._ui=this._createUI(),t.whenReady(this._initEvents,this),this._ui.button},_createUI:function(){var t={};return t.button=L.DomUtil.create("div","btn leaflet-control-ruler"),t.button.title=this.options.title||"",L.DomUtil.create("i","svg-icon svg-icon-ruler",t.button),L.DomEvent.disableClickPropagation(t.button),t},_initEvents:function(){var t=this;t.options.onClick&&L.DomEvent.on(this._ui.button,"click",function(){t.options.onClick(t._ui.button)})}}),L.Ruler=L.Handler.extend({includes:L.Mixin.Events,options:{i18n:{m:"m",km:"km"}},initialize:function(t,n){if(this._map=t,this._container=t._container,this._overlayPane=t._panes.overlayPane,this._popupPane=t._panes.popupPane,this._lastMarker=null,this._poly=null,this._distances=[],n&&n.control){var e=this;n.control=L.Util.extend({onClick:function(t){e.enabled()?(e.disable(),L.DomUtil.removeClass(t,"active")):(e.enable(),L.DomUtil.addClass(t,"active"))}},n.control)}L.Util.extend(this.options,n),this._control=new L.Control.RulerControl(n.control).addTo(this._map)},addHooks:function(){if(this._map&&!this._poly){this._poly=new L.Draw.Polyline(this._map,{icon:new e,shape:{color:"#f00",weight:2,opacity:.9}});var n=this;this._poly.on("nodeadd",function(e){var i=e.marker,o=t(i._icon);o.attr("data-index",i._index).find("strong").text(i._index),i._index>0&&i._index==e.poly.getLatLngs().length-1?(n._updateLast(i),n._updateDistance(i._index)):0==i._index&&o.addClass("first")}).on("noderemove",function(e){var i=e.marker;if(i._index>1&&i._index==e.poly.getLatLngs().length)n._updateLast(n._poly.getLastMarker());else if(0==i._index){var o=n._poly.getFirstMarker();t(o._icon).addClass("first")}n._updateDistance(i._index-1)}).on("nodeindexchange",function(n){var e=n.marker;t(e._icon).attr("data-index",e._index).find("strong").text(e._index)}).on("nodechange",function(t){var e=t.marker;n._updateDistance(e._index-1)}),t(this._container).on("click.ruler",".ruler-bubble i",function(){var e=t(this).closest("[data-index]").attr("data-index");n._poly.removeMarkerByIndex(e)})}},removeHooks:function(){this._map},enable:function(){this._enabled||(L.Handler.prototype.enable.call(this),this._poly.enable(),this._map.fire("ruler:start",{ruler:this}))},disable:function(){this._enabled&&(L.Handler.prototype.disable.call(this),this._poly.destroy(),this._map.fire("ruler:stop",{ruler:this}))},_updateLast:function(n){this._lastMarker&&t(this._lastMarker._icon).removeClass("last"),this._lastMarker=n,t(n._icon).addClass("last")},_updateDistance:function(e){var i=this._poly.getMarkers(),o=i.length;if(this._distances[0]=0,e=e>0?e:1,o&&o>e)for(var a=e;o>a;a++)this._distances[a]=i[a].getLatLng().distanceTo(i[a-1].getLatLng())+this._distances[a-1],t(i[a]._icon).find("span").text(n.call(this,this._distances[a]))}}),L.ruler=function(t,n){return new L.Ruler(t,n||{})},L.Map.mergeOptions({ruler:!1}),L.Ruler});