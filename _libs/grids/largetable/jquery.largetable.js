define(["jquery"],function(){!function(t){function i(t,i){o===!1&&(o=e()),this.el=t,this.options=i,this.viewport=null,this.hCont=null,this.content=null,this.tbody=null,this.dim={viewportHeight:0,contentHeight:0,contentTop:0,dataHeight:0,scrollTop:0},this._firstIndex=0,this._nextIndex=0,this._maxIndex=0,this._scrollTimeout=null,s.init.call(this)}function e(){for(var i=1e6,e=navigator.userAgent.toLowerCase().match(/firefox/)?6e6:1e9,n=t("<div style='display:none' />").appendTo(document.body);;){var o=2*i;if(n.css("height",o),o>e||n.height()!==o)break;i=o}return n.remove(),i}var n="largetable",o=!1;t.extend(i.prototype,{requireContent:function(i){if("undefined"==typeof i)var i=!0;new t.Deferred;var e=this.options.provider,n=null,o=s.getVisibleIndexes.call(this);if(console.log(o),o.last>=this._nextIndex)if(n=e(this._nextIndex,o.last),n.done){this.el.addClass("loading");var l=this;n.done(function(t){l.el.removeClass("loading"),null!==t&&s.onReceive.call(l,t,!0)})}else null!==n&&s.onReceive.call(this,n,!0);if(o.first<this._firstIndex)if(n=e(o.first,this._firstIndex-1),n.done){this.el.addClass("loading");var l=this;n.done(function(t){l.el.removeClass("loading"),null!==t&&s.onReceive.call(l,t,!1)})}else null!==n&&s.onReceive.call(this,n,!1)},getScrollPos:function(){return this.viewport&&this.viewport[0]?this.viewport[0].scrollTop:0}});var s={prevScroll:0,init:function(){var t=this;this.viewport=this.el.find(".grid-viewport"),this.hCont=this.el.find(".grid-height"),this.content=this.el.find(".grid-content"),this.tbody=this.content.find("tbody"),this.viewport.on("scroll",function(i){s.onScroll.call(t,i)}),s.calcDimensions.call(this),this.requireContent()},calcDimensions:function(){this.dim.viewportHeight=this.viewport.height(),this.dim.contentHeight=this.content.height(),this.dim.contentTop=this.content.position().top},onScroll:function(){this._scrollTimeout&&clearTimeout(this._scrollTimeout),this._scrollTimeout=setTimeout(s.scrollUpdate.bind(this),80)},scrollUpdate:function(){var t=this.dim.scrollTop=this.viewport[0].scrollTop,i=s.prevScroll<t?!0:!1;s.prevScroll!=t&&(console.log("Delta scroll = "+(s.prevScroll-t)),this.requireContent(i),s.prevScroll=t)},getVisibleIndexes:function(){var t=this.viewport[0].scrollTop,i=this.dim.viewportHeight,e=this.options.heightPadding,n=t-i*e,o=this.options.rowHeight,s=n+i*(1+2*e),l=Math.floor(n/o),r=Math.floor(s/o);return 0>l&&(l=0),{first:l,last:r}},onReceive:function(i,e){if("undefined"==typeof e)var e=!0;var n=i.html||"",o=e?"appendTo":"prependTo";t(n)[o](this.tbody);var l=this.options.rowHeight,r=0,h=s.getVisibleIndexes.call(this);e?(this._nextIndex+=i.nbRows,this._nextIndex>this._maxIndex&&i.nbRows>0&&(this._maxIndex=this._nextIndex-1,this.dim.dataHeight=this._maxIndex*this.options.rowHeight,this.hCont[0].style.height=this.dim.dataHeight+"px"),r=h.first-this._firstIndex,r>0&&(this.tbody.find(">tr").slice(0,r).remove(),this.content[0].style.top=this.dim.contentTop+r*l+"px",this._firstIndex+=r)):(this._firstIndex-=i.nbRows,this.content[0].style.top=this.dim.contentTop-i.nbRows*l+"px",r=this._nextIndex-h.last-i.nbRows+1,r>0&&(this.tbody.find(">tr").slice(-r).remove(),this._nextIndex=this.tbody.find(">tr").last().data("index")+1)),s.calcDimensions.call(this)}},l={rowHeight:20,heightPadding:.5,provider:function(){return{nbRows:1,html:"<tr><td></td></tr>"}}};t.fn.largetable=function(){if(1==arguments.length&&t.isPlainObject(arguments[0])){var e=t.extend({},l,arguments[0]);return this.each(function(){var o=t(this),s=new i(o,e);o.data(n,s)})}if(arguments.length>0&&"string"==typeof arguments[0]){var o=t(this),s=arguments[0],r=Array.prototype.slice.call(arguments,1),h=o.data(n);s in h&&h[s].apply(h,r)}}}(jQuery)});