define(["jquery","underscore","moment","abstracts/View","./GuardViewExt","text!../tmpl/rowExt.html"],function(e,t,l,r,i,n){var a=t.template("<ul></ul>"),o=t.template("<ul></ul>");n=t.template(n);var c=r.prototype,s=r.extend({constructor:function(e){this.controller=e.controller,this._children={},this.$list=null,r.apply(this,arguments)},initialize:function(){this._bindEvents()},_bindEvents:function(){var e=this,t=this.collection,l=this.controller;this.listenTo(t,"sync",function(t,l,r){r&&r.initial&&e.render()}).listenTo(t,"remove",function(t){e._children[t.id].remove()}),l.get("showCalled")&&this.listenTo(t,"add",function(t){d.renderGuard.call(e,t)})},render:function(){var t=this.controller,l=t.getTexts(),r=this.collection;if(r.length){var i=this,n=t.get("showCalled"),c=t.get("selectedGuard"),s=n?o:a;this.$el.empty(),this.$list=e(s({i18n:l,action:l[n&&c.arrived()?"rrtCompleteCallShort":"rrtCancelCallShort"]})).appendTo(this.$el).filter("ul"),r.each(function(e){d.renderGuard.call(i,e)}),this.$btnComplete=this.$el.find(".guards-complete-call")}},setBtnCompleteText:function(e){if(this.$btnComplete){var t=this.controller.getTexts();this.$btnComplete.text(t[e?"rrtCompleteCallShort":"rrtCancelCallShort"])}},formatTime:function(e){return l(e).format("DD.MM HH:mm:ss")},clear:function(){var e=this._children;t.each(e,function(t,l){t&&(t.remove(),delete e[l])})},remove:function(){this.clear(),c.remove.call(this)},getContainer:function(){return null}}),d={renderGuard:function(l){var r=l.get("route")||null,a=l.get("guardCall"),o=this.controller.get("selectedGuard"),c=[],s=t.extend({},l.attributes,{i18n:this.controller.getTexts(),className:"",routeMeta:r?r.get("meta"):null,selected:o&&o.id==l.id,called:null!==a,hasCoords:l.get("lat")&&l.get("lon"),callTime:"",accepted:l.acceptedCall(),acceptTime:"",arrived:l.arrived(),arriveTime:""});o&&o.id==l.id&&c.push("selected"),s.called&&(s.callTime=this.formatTime(a.callTs)),s.accepted&&(c.push("accepted"),s.acceptTime=this.formatTime(a.acceptTs)),s.arrived&&(c.push("arrived"),s.arriveTime=this.formatTime(a.arriveTs)),s.className=c.join(" "),this._children[l.id]=new i({controller:this.controller,model:l,parent:this,el:e(n(s)).appendTo(this.$list)})}};return s});