var PRODUCTION=!0;if(define("_common/alerts/ObjectWithAlarmsMixin",["underscore"],function(e){var t={defaults:{isInProcess:!1,lastLog:null,guardCalled:!1,guardArrived:!1,guardCalls:null,tech:null},parse:function(t){var n=this.getSuperClass().prototype.parse.call(this,t);return e.each(["isInProcess","guardCalled","guardArrived"],function(e){n[0]=n[e]===!0}),n},addMethodsTo:function(n){e.each(["parse"],function(e){!function(e){n.prototype[e]=function(){return t[e].apply(this,arguments)}}(e)})}};return t}),define("_common/alerts/MobileWithAlarms",["underscore","_common/mobile/MobileDetails","./ObjectWithAlarmsMixin"],function(e,t,n){var i=t.prototype,s=t.extend({constructor:function(){t.apply(this,arguments)},defaults:e.extend({},i.defaults,n.defaults),getSuperClass:function(){return t}});return n.addMethodsTo(s),s}),define("_common/stat/StatDetails",["jquery","underscore","abstracts/GrObject","./StatObject","./Control"],function(e,t,n,i,s){var a=i.prototype,o=-128,r="-1",l=i.extend({constructor:function(){this.$controlsXhr=null,i.apply(this,arguments)},url:App.getBaseUrl()+"objects/obj-details/",defaults:t.extend({},a.defaults,{rev:"",imei:"",canArm:!1,areas:[],controls:[],controlsError:!1,ivideon:null,webRtcCameras:null,lastGSMConnectionTime:0,deviceTypeName:"",deviceTypeId:0,deviceTypeCode:"",description:"",temperature:null,temparatureActiveIndex:0,temperatures:null,temperaturesLoading:!0}),hasToLoadState:function(){var e=this.get("areas"),t=this.get("controls");return e&&e.length>0||t&&t.length>0},loadState:function(){var n=this.get("areas"),i=this.get("controls"),s=[];return n&&n.length>0&&s.push(this.loadAreas()),i&&i.length>0&&s.push(this.loadControls(t.pluck(i,"num"))),e.when.apply(null,s)},loadAreas:function(){var t=this;return this.$stateXhr=e.ajax({url:App.getBaseUrl()+"objects/obj-areas/",data:{objectId:this.id},statusCode:{401:function(){}},success:function(e){var n=t.mergeAndParseAreasData(e,t.get("objStatus"));t.isStateChanged(t.get("areas"),n)&&t.set("areas",n)}}),this.$stateXhr},loadTemperature:function(){var t=this,n=new e.Deferred;return t.set("temperaturesLoading",!0),e.ajax({url:App.getBaseUrl()+"objects/temperature/",data:{objectId:this.id}}).done(function(e){var i=t.adapterDetectors(t.get("tempDetectors")),s=t.adapterTemperaturesData(e),a=t.mergeTemperaturesData(s,i);t.set("temperatures",a),t.set("temperaturesLoading",!1),n.resolve()}).fail(function(){t.set("temperaturesLoading",!1),n.reject.apply(n,arguments)}),n},updateTemperature:function(){if(this.get("tempDetectors")&&this.isOnline())return this.loadTemperature();this.set("temperaturesLoading",!1);var e=this.adapterDetectors(this.get("tempDetectors")),t=this.adapterTemperaturesData(),n=this.mergeTemperaturesData(t,e);this.set("temperatures",n)},loadControls:function(t){var n=this;return this.$controlsXhr=e.ajax({url:App.getBaseUrl()+"objects/outs/",data:{objectId:this.id,outs:t},statusCode:{401:function(){}},success:function(e){n.setControlsState(e)},error:function(){n.set("controlsError",!0),n.set("controls",[])}}),this.$controlsXhr},setControlsState:function(e){var t=(this.get("controls")||[]).slice(0),n=!1;t.length&&(t.forEach(function(t){var i=t.num;i in e?(null===t.state||t.state!==e[i])&&(t.state=e[i],n=!0):(t.state=null,t.canControl=!1,n=!0)}),n&&(this.set("controls",t,{silent:!0}),this.trigger("change:controls",this,t)))},mergeControlsData:function(e){var t,n=this.get("controls")||[],i=[];return"string"==typeof e&&(e=JSON.parse(e)),e=e||[],n.forEach(function(n){t=null;var s=e.find(function(e){return e.num===n.num});s&&(t=Object.assign({},n,s)),t&&i.push(t)}),e.forEach(function(e){var t=n.find(function(t){return e.num===t.num});t||i.push(e)}),s.sortControls(i)},abortLoadState:function(){a.abortLoadState.call(this),this.$controlsXhr&&this.$controlsXhr.abort(),this.$controlsXhr=null},parse:function(e){var t=i.prototype.parse.call(this,e);if("lastGSMConnectionTime"in t&&(t.lastGSMConnectionTime*=App.MS),"areas"in t){var n=this.mergeAndParseAreasData(t.areas,t.objStatus);this.isStateChanged(this.get("areas"),n)?t.areas=n:delete t.areas}return"deviceControlOuts"in t&&!this.get("controlsError")&&(t.controls=this.mergeControlsData(t.deviceControlOuts),delete t.deviceControlOuts),t},mergeAndParseAreasData:function(e,i){var s,a,o=this,r=this.get("areas"),l=t.indexBy(r||[],"num"),c=t.indexBy(e,"num"),d=[],u=n.alarmsAllowed(i);t.each(l,function(e,n){n in c&&(s=c[n],a=t.extend({},e,s),a.zones="zones"in s?o.mergeZonesData(e.zones||[],s.zones):[],d.push(a))}),t.each(c,function(e,t){t in l||d.push(c[t])});for(var h,m=d.length;m--;)h=d[m],h.operatable=this.isAreaOperatable(h),u||(h.hasAlarm=0),h.zones=t.sortBy(h.zones,"num");return d},mergeTemperaturesData:function(e,n){if(!e||!n)return null;var i=[];return t.each(n,function(t){var n=e[t.code];t.value=n?n.value:null,i.push(t)}),i},adapterTemperaturesData:function(e){if(!e)return null;var n=this.get("temperature"),i={"-1":{code:"-1",detector:"-1",sensor:"-1",temperature:n,value:n===o?r:n}};return t.each(e,function(e,n){t.each(e,function(e,t){var s="-1"===n?"-1":n+"-"+t;i[s]={code:s,detector:n,sensor:t,temperature:e,value:e===o?r:e}})}),i},adapterDetectors:function(e){if(!e)return[];try{var t=JSON.parse(e),n=[];return t.forEach(function(e){e.sensors.forEach(function(t){var i="-1"===e.num?"-1":e.num+"-"+t.num;n.push({position:t.position,name:t.name,code:i,note:t.note})})}),n.sort(function(e,t){return e.position-t.position})}catch(i){return console.log("StatItemCardTemperatureView error",i),[]}},mergeZonesData:function(e,n){var i=t.indexBy(e||[],"num"),s=t.indexBy(n,"num"),a=[];return t.each(i,function(e,n){n in s&&a.push(t.extend({},e,s[n]))}),t.each(s,function(e,t){t in i||a.push(s[t])}),a},isStateChanged:function(e,t){return JSON.stringify(e)!=JSON.stringify(t)},getArea:function(e){var n,i=this.get("areas")||[];return(n=t.findWhere(i,{num:parseInt(e)}))?n:null},setAreaState:function(e,n){var i;(i=this.getArea(e))&&(t.extend(i,n),this.trigger("change:areas",this,this.get("areas")))},isOperatable:function(){return App.allowed("objects.arm")||App.allowed("objects.disarm")?this.get("imei")&&this.get("canArm"):!1},isAreaCanBeArmedOrDisarmed:function(e){return this.isOperatable()&&e.num>0&&(!e.isGuarded&&App.allowed("objects.arm")||e.isGuarded&&App.allowed("objects.disarm"))},isAreaOperatable:function(e){var t=this.isAreaCanBeArmedOrDisarmed(e),n=e.hasFault&&App.allowed("objects.clearfaults");return n||t}});return l}),define("_common/alerts/StatWithAlarms",["underscore","_common/stat/StatDetails","./ObjectWithAlarmsMixin"],function(e,t,n){var i=t.extend({constructor:function(){t.apply(this,arguments)},defaults:e.extend({},t.prototype.defaults,n.defaults,{boundGuards:null,groups:null,callId:null}),getSuperClass:function(){return t}});return n.addMethodsTo(i),i}),define("_common/alerts/DevicesCollection",["underscore","./MobileWithAlarms","./StatWithAlarms","abstracts/Collection"],function(e,t,n,i){var s=i.extend({constructor:function(){this.name="alarmDevicesCollection",i.apply(this,arguments)},model:function(e){var i=t;return e.objType==App.TYPE_STAT&&(i=n),new i(e,{parse:!0})}});return s}),define("_common/alerts/DeviceAlert",["underscore","abstracts/Model"],function(e,t){var n=t.extend({constructor:function(){t.apply(this,arguments)},idAttribute:"alertId",initialize:function(){}});return n}),define("_common/alerts/DeviceAlarmsCollection",["underscore","./DeviceAlert","abstracts/Collection"],function(e,t,n){var i=n.extend({constructor:function(){n.apply(this,arguments)},model:t});return i}),define("text!_common/alerts/tmpl/deviceRow.html",[],function(){return'<tr data-id="<%- device.id %>" class="row-brief device-brief">\n    <td class="img">\n        <svg class="svg-icon">\n            <use xlink:href="#smb-<%= (device.objType == App.TYPE_MOBILE ? \'car\' : \'home\') %>"></use>\n        </svg>\n    </td>\n    <td class="info">\n        <h4 class="title"><%- device.name %></h4>\n        <p><%- device.extra || \'--\' %></p>\n    </td>\n    <td class="row-action">\n        <i class="svg-icon svg-icon-chevron-right"></i>\n    </td>\n</tr>'}),define("_common/alerts/views/DevicesListView",["jquery","underscore","abstracts/View","text!../tmpl/deviceRow.html"],function(e,t,n,i){i=t.template(i);var s=n.extend({constructor:function(){this.controller=null,this.parent=null,n.apply(this,arguments)},initialize:function(e){this.controller=e.controller,this.parent=e.parent,this.render(),this._bindEvents()},render:function(){var e=this.controller.get("alarmDevices"),t=this.controller.get("device");e.length<2||t&&!t.get("hasAlarm")?this.$el.addClass("prev"):t?this.$el.addClass("prev"):this.$el.addClass("active");for(var n=e.toJSON(),i='<table class="devices-list"><tbody>',s=0,a=n.length;a>s;++s)i+=this._getRowHtml(n[s]);i+="</tbody></table>",this.$el.html(i)},_bindEvents:function(){var t=this;this.controller,this.$el.on("click","tr[data-id]",function(){t._onRowClick(e(this).data("id"))}),this.listenTo(this.collection,"add",function(e){t._onCollectionAdd(e)}).listenTo(this.collection,"remove",function(e){t._onCollectionRemove(e)})},_getRowHtml:function(e){return a._prepareDeviceData(e),i({i18n:this.controller.getTexts(),device:e})},_onCollectionAdd:function(e){this.$el.find("tbody").append(this._getRowHtml(e.attributes))},_onCollectionRemove:function(e){var t=this.$el.find("tr[data-id="+e.id+"]");t.remove()},_onRowClick:function(e){this.controller.trigger("choosedevice",e)}}),a={_prepareDeviceData:function(e){var t=[];e.objType==App.TYPE_MOBILE?(e.model&&t.push(e.model),e.licenseNumber&&t.push(e.licenseNumber)):t=[e.addressShort],e.extra=t.join(", ")}};return s}),define("text!_common/alerts/tmpl/deviceHistory.html",[],function(){return'<div class="tabs-hor-cont">\n    <ul class="tabs-hor">\n        <% if(App.allowed(\'alerts\')) {%>\n        <li class="device-alarms <% if(hasAlarm) {%>active<% } else {%>hidden<% } %>">\n\n            <div class="tab-toggle-container">\n                <a class="tab-toggle" href="#tabs-tr-1"><%= i18n.alarms.ucFirst() %></a>\n            </div>\n            <div class="tab-hor-content selectable infinite" id="tabs-tr-1">\n                <table data-key="alarms"></table>\n                <p class="no-data hidden"><%= i18n.noHistoryRows %></p>\n            </div><!--/tab-hor-content-->\n\n        </li>\n        <% } %>\n        <li class="device-alerts<% if(!hasAlarm || !App.allowed(\'alerts\')) {%> active<% } %>">\n\n            <div class="tab-toggle-container">\n                <a class="tab-toggle" href="#tabs-tr-2"><%= i18n.all.ucFirst() +\' \'+  i18n.alerts %></a>\n            </div>\n            <div class="tab-hor-content selectable infinite" id="tabs-tr-2">\n                <table data-key="alerts"></table>\n                <p class="no-data hidden"><%= i18n.noHistoryRows %></p>\n            </div><!--/tab-hor-content-->\n\n        </li><li class="device-logs">\n\n        <div class="tab-toggle-container">\n            <a class="tab-toggle" href="#tabs-tr-3"><%= i18n.objectLog %></a>\n        </div>\n        <div class="tab-hor-content selectable infinite" id="tabs-tr-3">\n            <table data-key="logs"></table>\n            <p class="no-data hidden"><%= i18n.noHistoryRows %></p>\n        </div><!--/tab-hor-content-->\n    </li>\n    </ul>\n\n    <table class="history-table"></table>\n</div><!--/tabs-hor-cont-->'}),define("text!_common/alerts/tmpl/deviceHistoryRow.html",[],function(){return'<tr data-id="<%= id %>" class="row-brief history-brief">\n    <td class="img">\n        <i class="svg-icon svg-icon-<%= icon %>"></i>\n    </td>\n    <td class="info">\n        <div class="info-wrap">\n            <% if(title) {%>\n            <h4 class="title"><%- title %></h4>\n            <% } if(extra) {%>\n            <p><%- extra %></p>\n            <% } %>\n            <strong class="time"><%= time %></strong>\n        </div>\n    </td>\n</tr>'}),define("text!_common/alerts/tmpl/deviceHistoryDateRow.html",[],function(){return'<tr data-date="<%= date %>" class="date-row">\n    <td colspan="2"><%= txt %></td>\n</tr>'}),define("_common/alerts/views/DeviceHistoryView",["jquery","underscore","abstracts/View","jqueryui","moment","text!../tmpl/deviceHistory.html","text!../tmpl/deviceHistoryRow.html","text!../tmpl/deviceHistoryDateRow.html"],function(e,t,n,i,s,a,o,r){a=t.template(a),o=t.template(o),r=t.template(r);var l=(new Date(2e3,0,1).getTime(),"DD.MM.YYYY"),c="HH:mm:ss",d=n.extend({constructor:function(){this.controller=null,this.parent=null,this._loadingTimeout=null,this._loading=!1,this._list={alarms:null,alerts:null,logs:null},this._count={alarms:0,alerts:0,logs:0},this._date={alarms:"",alerts:"",logs:""},"undefined"==typeof this._loadLimit&&(this._loadLimit=20),this._filterDate=null,n.apply(this,arguments)},initialize:function(e){this.controller=e.controller,this.parent=e.parent,this.render(),this._bindEvents()},render:function(){this.$el.html(a(t.extend({},this.model.attributes,{i18n:this.controller.getTexts()}))),u.initScrolling.call(this);var e="alerts";this.model.get("hasAlarm")&&App.allowed("alerts")&&(e="alarms"),this._buildList(e)},remove:function(){this._clearLoading(),n.prototype.remove.apply(this,arguments)},_bindEvents:function(){var e=this;this.controller,t.each(this._list,function(t,n){!function(t){e.$el.find(".device-"+t).one("toggle",function(i){i&&!e._list[t]&&e._buildList(n)})}(n)}),App.allowed("alerts")&&this.listenTo(this.model,"change:hasAlarm",function(t,n){if(n){if(!t.previous("hasAlarm")){var i=e.$el.find(".device-alarms").removeClass("hidden");i.find(".tab-toggle").trigger("tabshow")}}else e.$el.find(".device-alarms").addClass("hidden")})},_buildList:function(e){var t=this,n=this.$el.find("[data-key="+e+"]");t._setLoadingTimeout(),this.controller.loadDeviceHistory(e,this._count[e],this._loadLimit).done(function(i){t._list[e]=n,i.length?t._onReceive(e,i):t._list[e].siblings(".no-data").removeClass("hidden")}).always(function(){t._clearLoading()}),this._bindListEvents(e)},_bindListEvents:function(e){var n=this;n.listenTo(this.controller,"new"+e,function(i){if("logs"!=e||!n._filterDate){var s=t.filter(i,function(e){return e.objectId==n.model.id});s.length&&n._onReceive(e,s)}})},_indexRowsByDate:function(e,t){var n,i=this.controller.getTexts(),s={},a=0,r="",l="",c="bell",d="alertId",u=0,h="";"logs"==e&&(d="id"),t.length&&(this._date[e]=this._formatDate(this._getAlertTs(t[0])));for(var m=0,p=t.length;p>m;++m)n=t[m],a=n[d],c="bell",r="",l="",u=this._getAlertTs(n),h=this._formatDate(u),h in s||(s[h]=""),"logs"==e?(r=n.userName,l=n.comment,c="comment"):(n.isAlarm&&(c="warning-r"),"area"in n&&(r=n.area?n.areaName?n.areaName:i.objArea+" "+n.area:i.zeroAreaName),l=n.messageText,n.areaZone&&(l+=" - "+this._getAreaZoneName(n))),s[h]+=o({id:a,icon:c,title:r,extra:l,time:this._formatTime(u)});return s},_renderRows:function(n,i){var s=this,a=this.controller.getTexts(),o=this._indexRowsByDate(n,i),l=this._formatDate((new Date).getTime()),c=null,d="";t.each(o,function(t,i){c=s._list[n].find('.date-row[data-date="'+i+'"]'),c.length||(d=r({txt:l==i?a.DateTime.today:i,date:i}),c=s._parseDate(i)>s._parseDate(s._date[n])?e(d).prependTo(s._list[n]):e(d).appendTo(s._list[n])),c.after(t)})},_onReceive:function(e,t){this._list[e]&&t.length&&(this._count[e]||this._list[e].siblings(".no-data").addClass("hidden"),this._count[e]+=t.length,this._renderRows(e,t))},_onAlarmResolved:function(e){var t=this,n=this.controller.get("alarms");this._list.alarms.find("tr[data-id="+e.id+"]").remove(),this._count.alarms-=1;var i=this._getAlertTs(e.attributes),s=this._formatDate(i),a=n.filter(function(e){return t._formatDate(t._getAlertTs(e.attributes))==s});a.length||(this._list.alarms.find('tr[data-date="'+s+'"]').remove(),n.length&&(this._date.alarms=this._formatDate(this._getAlertTs(n.first().attributes))))},_getAreaZoneName:function(e){var t=this.controller.getTexts(),n=e.areaZoneName;return n||("areaZone"in e&&null!==e.areaZone?(n=e.isKey?t.key.ucFirst():t.objZone,n+=" "+e.areaZone):n="-"),n},_getAlertTs:function(e){return e.receivedAt},_formatDate:function(e){return s(e).format(l)},_formatTime:function(e){return s(e).format(c)},_formatDateTime:function(e){return s(e).format(c+" "+l)},_parseDate:function(e){return s(e,l).valueOf()},_setLoadingTimeout:function(){var e=this;this._clearLoading(),this._loadingTimeout=setTimeout(function(){e.$el.addClass("loading"),e._loading=!0},100)},_clearLoading:function(){this._loadingTimeout&&(clearTimeout(this._loadingTimeout),this._loadingTimeout=null),this._loading&&(this.$el.removeClass("loading"),this._loading=!1)}}),u={initScrolling:function(){var t=this,n=this.controller;this.$el.find(".infinite").each(function(){var i=e(this),s=i.children("[data-key]"),a=s.data("key");!function(o){i.infinite({appendTo:s,source:function(){var i=new e.Deferred;return t._setLoadingTimeout(),n.loadDeviceHistory(a,t._count[o],t._loadLimit).done(function(e){t._count[o]+=e.length,t._renderRows(o,e),i.resolve(e.length>0)}).fail(function(){t.parent.showErrors(arguments[0])}).always(function(){t._clearLoading()}),i}})}(a)})}};return d}),define("text!_common/alerts/tmpl/window.html",[],function(){return'<div class="pages">\n\n</div>'}),define("text!_common/alerts/tmpl/windowHeader.html",[],function(){return'<span class="title">\n    <a data-target="devicesList" class="back<% if(!back) {%> hidden<% } %>" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <%- title %>\n</span>'}),define("text!_common/alerts/tmpl/windowFooter.html",[],function(){return'<% if(App.allowed(\'alerts.close\')) {%>\n    <% if(!device) {%>\n    <button class="btn btn-primary btn-resolve btn-resolve-all"><%= i18n.resolveAllAlarmsShort %></button>\n    <% } else { %>\n    <button class="btn btn-primary btn-resolve btn-resolve-obj"<% if(!device.hasAlarm) {%> disabled<% } %>>\n        <%= i18n.resolveAlarms %>\n    </button>\n    <% } %>\n<% } else if(App.allowed(\'alarm.create\')) { %>\n    <% if(device) {%>\n    <button class="btn btn-danger btn-create-alarm">\n        <%= i18n.createAlarm %>\n    </button>\n    <% } %>\n<% } %>\n\n<a class="btn jw-close"><%= i18n.close.ucFirst() %></a>'}),define("text!_common/alerts/tmpl/resolveAllConfirm.html",[],function(){return'<div class="control-group">\n    <label class="control-label"><%= i18n.username.ucFirst() %></label>\n    <input type="text" class="input-block-level" name="login" value="">\n</div>\n<div class="control-group">\n    <label class="control-label"><%= i18n.password.ucFirst() %></label>\n    <input type="password" class="input-block-level" name="password" value="">\n</div>'}),define("_common/alerts/views/AlertsView",["jquery","underscore","abstracts/View","jface","jqueryui","./DevicesListView","./DeviceHistoryView","text!../tmpl/window.html","text!../tmpl/windowHeader.html","text!../tmpl/windowFooter.html","text!../tmpl/resolveAllConfirm.html","css!../css/alarms.css"],function(e,t,n,i,s,a,o,r,l,c,d){r=t.template(r),l=t.template(l),c=t.template(c),d=t.template(d);var u=n.extend({id:"win-history",constructor:function(){this.controller=null,this.i18n=null,this._eventsPrefix=".devicehistory","undefined"==typeof this._children&&(this._children={devicesList:null,deviceHistory:null}),n.apply(this,arguments)},initialize:function(e){this.controller=e.controller},render:function(){return r({i18n:this.controller.getTexts()})},openWindow:function(){if(!this.controller.get("visible")){i.dialog.close(),i.showOverlay();try{i.window.getById(this.id).trigger("jw.activate")}catch(e){i.window.open(this._getWindowParams())}}},showErrors:function(){if(arguments[0]){var t=this,n=this.controller.getTexts();if("string"==typeof arguments[0])alert(arguments[0],n.error);else if("statusText"in arguments[0]){var i=arguments[0];try{var s=e.parseJSON(i.responseText);alert(s.msg,s.hdr)}catch(a){i.status?alert(i.status+" "+i.statusText,n.error):t.controller.toggleOfflineMessage(!0)}}}},remove:function(){this.stopListening(),t.each(this._children,function(e){e&&e.remove()}),this.$el.length&&this.$el.trigger("jw.close").trigger("jw.die")},_bindEvents:function(){var e=this,t=this.controller,n=this.controller.get("alarmDevices"),i=t.get("device");i&&this._bindDeviceEvents(),this.listenTo(App,"change:totalAlarms",function(n,i){return e._toggleBtnResolve(),!i&&t.has("filtered")?(e._setHeader(),void 0):(e.$el[i?"removeClass":"addClass"]("no-devices"),e._setHeader(),void 0)}),this.listenTo(t,"change:filtered",function(t,n){App.get("totalAlarms")||(n?e.$el.removeClass("no-devices"):e.$el.addClass("no-devices"))}).listenTo(t,"change:device",function(){var n=t.previous("device");n&&e.stopListening(n),e._onChangeDevice()}).listenTo(t,"change:online",function(t,n){e.$el[n?"removeClass":"addClass"]("offline"),n||(e._toggleCommentsAndActions(!1),e._toggleBtnResolve())}).listenTo(t,"change:soundOn",function(){e.toggleSoundOnBtn.call(e)}).listenTo(t,"change:soundOnMute",function(){e.toggleSoundOnBtn.call(e)}),n&&this.listenTo(n,"add remove",function(){t.has("device")||e._setHeader()})},getSoundBtnOn:function(){return this.controller.get("soundOn")},toggleSoundOnBtn:function(){this.$el.find(".btn-sound")[this.getSoundBtnOn()?"removeClass":"addClass"]("disabled")},_bindDeviceEvents:function(){var e=this,t=this.controller.get("device");this.listenTo(t,"change:hasAlarm",function(){e._setHeader(),e._toggleBtnResolve(),t.previous("hasAlarm")||e._toggleCommentsAndActions(!0)})},_getWindowParams:function(){var e=this,t=this.controller;t.get("device");var n={winId:this.id,addClass:"history compact"+(App.get("totalAlarms")?"":" no-devices"),headerHtml:this._getHeader(),contentHtml:this.render(),footerHtml:this._getFooter(),width:400,resizable:!1,dieAfter:0,openCallback:function(){e._onOpen(this)},showCallback:function(){t.set("visible",!0),App.trigger("openalarms")},closeCallback:function(){e._onClose(),App.trigger("closealarms")}},i=t.getUserData("winLeft"),s=t.getUserData("winTop");return null===i||null===s?n.centered=!0:(0>i&&(i=0),0>s&&(s=0),n.initX=i,n.initY=s),n},_enoughSpaceForWindow:function(){return!0},_onOpen:function(e){this.setElement(e),this._bindEvents(),this._bindUIEvents(),this._initLayout(),this._makeDevicesListView(),this._makeDeviceHistoryView(this.controller.has("device"))},_makeDevicesListView:function(){var t=new a({collection:this.controller.get("alarmDevices"),el:e('<div class="page" data-view="devicesList"></div>').appendTo(this.$el.find(".pages")),parent:this,controller:this.controller});this._children.devicesList=t},_makeDeviceHistoryView:function(t){var n=this.controller.get("device");if(this._children.deviceHistory&&this._children.deviceHistory.remove(),n){var i=new o({model:n,el:e('<div class="page '+(t?"active":"next")+'" data-view="deviceHistory"></div>').appendTo(this.$el.find(".pages")),parent:this,controller:this.controller});this._children.deviceHistory=i,t&&this._setHeader()}},_bindUIEvents:function(){var t=this,n=this.controller;this._initTabs(),this.$el.on("click",".btn-sound",function(){var t=e(this);t.is(".disabled")||n.set("soundOnMute",!0)}).on("click","button[class*=btn-resolve]",function(){var i=e(this),s={};return i.is(".disabled")?!1:(i.is(".btn-resolve-obj")&&(s.objectId=n.get("device").id),s.objectId?t._resolveAlarm(s):t._openResolveAllConfirm(),!1)}).on("click",".btn-create-alarm",function(){return n.createAlarm(),!1}).on("dragstop",function(e,t){t&&(n.setUserData("winLeft",t.position.left),n.setUserData("winTop",t.position.top))}).on("click",".back",function(){var i=e(this).data("target");return"devicesList"==i&&n.set("device",null),h.setActiveView.call(t,i),!1})},_initTabs:function(){this.$el.on("click tabshow",".tab-toggle",function(){var t=e(this),n=t.closest("li"),i=n.parent();return n.is(".active")||(i.find(">li.active").removeClass("active").trigger("toggle",!1),n.addClass("active").trigger("toggle",!0)),!1})},_initLayout:function(){},_toggleCommentsAndActions:function(){},_toggleBtnResolve:function(){var e=this.controller.get("device"),t=App.get("totalAlarms");this._toggleButtons(".btn-resolve",t>0),this._toggleButtons(".popover-resolve .btn-resolve-obj",Boolean(!!e&&e.get("hasAlarm"))),this._toggleButtons(".popover-resolve .btn-resolve-all",t>0)},_toggleButtons:function(e,t){this.$el.find(e)[t?"removeClass":"addClass"]("disabled").prop("disabled",!t)},_sendComment:function(e){return this.controller.saveLog(e)},_openResolveAllConfirm:function(){var e=this,t=this.controller.getTexts();i.confirm(d({i18n:t}),t.msgConfirmAction,{showCallback:function(){this.find("input[name=login]").focus()},okCallback:function(){var t=this.find("input[name=login]").val(),n=this.find("input[name=password]").val();t&&n?e._resolveAlarm.call(e,{login:t,password:n}):e._openResolveAllConfirm()}})},_resolveAlarm:function(e){var t=this,n=this.controller;return t.$el.addClass("loading"),n.resolveAlarm(e).done(function(){t._onResolve(e)}).fail(function(e){t.showErrors(e)}).always(function(){t.$el.removeClass("loading")})},_onResolve:function(){},_onChangeDevice:function(){var e=this,t=this.controller.get("device"),n=App.get("totalAlarms");t?(this._bindDeviceEvents(),this._makeDeviceHistoryView(!1),setTimeout(function(){h.setActiveView.call(e,"deviceHistory")},20)):n&&(h.setActiveView.call(e,"devicesList"),setTimeout(function(){e._children.deviceHistory&&(e._children.deviceHistory.remove(),e._children.deviceHistory=null)},500))},_setHeader:function(){this.$el.find("h3").html(this._getHeader())},_getHeader:function(){var e=this.controller.getTexts(),t="",n=this.controller.get("device"),i=!1;if(n)t=this._getDeviceTitle(),n.get("hasAlarm")&&App.get("totalAlarms")&&(i=!0);else{t=e.alarmsOnNObjects;var s=App.get("totalAlarms"),a=this.controller.get("alarmDevices"),o=a.length;t=t.replace("#alarms#",1==s?e.alarm:e.alarms).ucFirst(),t=t.replace("#n#",o),t=t.replace("#objects#",e.onObjectsLabels[e.onObjectsWhichLabels(o)])}return l({title:t,back:i})},_setFooter:function(){this.$el.find(".jw-footer-content").html(this._getFooter())},_getFooter:function(){var e=this.controller,t=e.getTexts(),n=e.get("device");return c({i18n:t,soundOn:e.get("soundOn"),totalAlarms:App.get("totalAlarms"),device:n&&n.toJSON()||null})},_getDeviceTitle:function(e){return e=e||this.controller.get("device"),App.buildObjTitle(e)+" (#"+e.get("extId")+")"},_onClose:function(){i.hideOverlay(),this.controller.set("visible",!1)}}),h={setActiveView:function(e){var t=this.$el.find("[data-view]"),n=t.filter("[data-view="+e+"]"),i=t.filter(".active");if(n.length&&e!=i.data("view")){var s=this,a=!i.length||t.index(n)>t.index(i);i.length&&(i[0].className=i[0].className.replace("active",a?"prev":"next")),n[0].className=n[0].className.replace(a?"next":"prev","active"),setTimeout(function(){s._setHeader(),s._setFooter()},300)}}};return u}),define("text!_common/alerts/tmpl/devicesListExtended.html",[],function(){return'<h4 class="hdr nobr"></h4>\n\n<div class="module-header no-padding">\n    <form class="form-search ui-front">\n        <div class="input-append input-prepend">\n            <span class="add-on">\n                <input class="filter" name="q" type="text" autocomplete="off"\n                       placeholder="<%= i18n.searchObjects %>" value=""<% if(!totalAlarms && !\'gr-2917\') {%> disabled<% } %>>\n                <input class="autocomplete" name="q" type="text" value="" autocomplete="off"<% if(totalAlarms || \'gr-2917\') {%> disabled<% } %>>\n                <i class="icon-clear svg-icon svg-icon-circle-remove"></i>\n            </span>\n            <button class="btn add-on"><i class="svg-icon svg-icon-search"></i></button>\n        </div>\n    </form>\n</div>\n\n<p class="no-data"><%= i18n.noAlarmObjectsUseSearch %></p>\n\n<div class="grid-container alarm-objs selectable">\n    <div class="grid-header">\n        <table>\n            <thead></thead>\n        </table>\n    </div>\n    <div class="grid-viewport">\n        <div class="grid-content">\n            <table>\n                <tbody></tbody>\n            </table>\n        </div>\n    </div>\n</div>\n'}),define("text!_common/alerts/tmpl/deviceRowExtended.html",[],function(){return'<tr data-id="<%= device.id %>"\n    data-isinprocess="<%= device.isInProcess %>"\n    data-guardcalled="<%= device.guardCalled %>"\n    data-guardarrived="<%= device.guardArrived %>">\n\n    <td class="col-id"><%= device.extId %></td>\n    <td>\n        <div class="wrap">\n            <%- title %>\n            <span class="status">\n                <!--<svg class="svg-icon status-icon" data-hint="wait">\n                    <use xlink:href="#smb-sand"></use>\n                </svg>-->\n                <svg data-icon="guard" data-id="<%= device.id %>" class="svg-icon status-icon"\n                    version="1.1" xmlns="http://www.w3.org/2000/svg" width="32px" height="32px" viewBox="0 0 32 32">\n                    <path d="M3.424,17.902c-3.694,8.254,10.346,8.384,12.343,13.595c0.257,0.671,0.212,0.671,0.469,0\n	c1.999-5.211,16.038-5.341,12.343-13.595c-3.31-7.388-0.384-11.614,0.692-12.825c0.189-0.212,0.209-0.54,0.022-0.755l-3.328-3.83\n	c-0.187-0.213-0.528-0.268-0.774-0.139c-3.365,1.755-7.396,0.306-8.734-0.271c-0.254-0.109-0.656-0.109-0.91,0\n	c-1.336,0.576-5.37,2.024-8.736,0.271C6.562,0.226,6.22,0.279,6.035,0.494L2.706,4.322C2.519,4.537,2.539,4.865,2.728,5.077\n	C3.806,6.288,6.733,10.515,3.424,17.902z"/>\n                    <polygon class="check" fill="currentColor" points="14.408,22.23 8,15.823 10.869,12.955 14.408,16.495 21.131,9.77 24.001,12.64 "/>\n                </svg>\n                <svg data-icon="log" data-id="<%= device.id %>" class="svg-icon status-icon">\n                    <use xlink:href="#smb-operator"></use>\n                </svg>\n            </span>\n        </div>\n    </td>\n</tr>\n'}),define("text!_common/alerts/tmpl/popoverLog.html",[],function(){return'<h5 class="hdr"><%= username %></h5>\n<div class="time"><%= time %></div>\n<p class="comment"><%- comment %></p>'}),define("text!_common/alerts/tmpl/popoverGuard.html",[],function(){return'<h5 class="hdr"><%= title %></h5>\n<p class="comment"><%= comment %></p>'}),define("_common/alerts/views/DevicesListViewExtended",["jquery","underscore","./DevicesListView","text!../tmpl/devicesListExtended.html","text!../tmpl/deviceRowExtended.html","text!../tmpl/popoverLog.html","text!../tmpl/popoverGuard.html"],function(e,t,n,i,s,a,o){var r=n.prototype;i=t.template(i),s=t.template(s),a=t.template(a),o=t.template(o);var l=n.extend({constructor:function(){this._hdr=null,this._tbody=null,this._searchForm=null,this._searchInput=null,this._searchXhr=null,this._searchCache={},this.children={},this._currentRow=null,this._focusedIndex=null,this._focusedRow=null,this._statusPopover=null,this._statusPopoverTmt=null,this._loadingTimeout=null,n.apply(this,arguments)},initialize:function(){r.initialize.apply(this,arguments),this._hdr=this.$el.find(".hdr"),c.setHeader.call(this),c.initObjsSearch.call(this)},render:function(){this.$el.html(i({totalAlarms:App.get("totalAlarms"),i18n:this.controller.getTexts()})),this._tbody=this.$el.find("tbody"),this._statusPopover=this.parent.$el.find(".status-popover"),c.buildGrid.call(this),c.initPopovers.call(this)},removeChildren:function(e){var n=this;e=e||t.keys(this.children),t.each(e,function(e){n.children[e]&&(n.children[e].remove(),delete n.children[e])})},focusSearch:function(){this._searchForm&&this._searchForm.find("input").focus()},_bindEvents:function(){var e=this,t=this.controller;r._bindEvents.apply(this,arguments),this.listenTo(App,"change:totalAlarms",function(t,n){n?e._searchXhr&&e._searchXhr.abort():c.clearFilter.call(e),c.setHeader.call(e)}).listenTo(App,"openalarms",function(){c.clearFilter.call(e)}),this.listenTo(t,"change:device request:device",function(t,n){e._selectRowById(n?n.id:null)}),this.collection.each(function(t){e._bindDeviceEvents(t)})},_onCollectionAdd:function(e){var t=this.controller.get("filter");if(t);else{var n=s({device:e.attributes,title:App.buildObjTitle(e)});this.$el.find("tbody").append(n),c.setSelected.call(this)
}this._bindDeviceEvents(e)},_selectRowById:function(e){var t=this._currentRow;if(t){if(t.data("id")==e)return;t.removeClass("selected")}if(e){var n=this.$el.find("tr[data-id="+e+"]");n.length&&(n.addClass("selected"),this._currentRow=n)}},_bindDeviceEvents:function(e){var n=this;t.each(["isInProcess","guardCalled","guardArrived"],function(t){!function(t){n.listenTo(e,"change:"+t,function(e,i){var s=n.$el.find("tr[data-id="+e.id+"]");s.length&&s.attr("data-"+t.toLowerCase(),i)})}(t)})},_onCollectionRemove:function(e){var t=this.controller.get("filtered"),n=this.$el.find("tr[data-id="+e.id+"]"),i=n.is(".selected");this.stopListening(e),t&&t.get(e.id)||n.remove()&&i&&(this._currentRow=null)},_onRowClick:function(e){if(this.collection.get(e))r._onRowClick.call(this,e);else if(this.controller.has("filtered")){var t,n=this.controller.get("filtered");(t=n.get(e))&&App.trigger("needdevicehistory",t)}},setFocused:function(e){if(!(0>e||e>this.controller.get("filtered").length-1)&&(this.$el.find("tr.focused").removeClass("focused"),this._focusedIndex=e,this._focusedRow=null,null!==e)){var t=this.$el.find("tbody tr:eq("+e+")").not(".selected");t.length&&(t.addClass("focused"),this._focusedRow=t)}},formatTimeAgo:function(e){var t=+new Date,n=this.controller.getTexts().timeAgo;return n.replace("#t#",Date.formatSeconds((t-e)/1e3))}}),c={initColumns:function(){},initObjsSearch:function(){var e=this,t=this._searchForm=this.$el.find(".form-search"),n=this._searchInput=t.find("input[name=q]");t.on("submit",function(){return c.onSearchFormSubmit.call(e),!1}),t.on("click",".icon-clear",function(){c.clearFilter.call(e)}),n.on("keydown",function(t){var n=t.keyCode;27==n&&c.clearFilter.call(e)})},onSearchFormSubmit:function(){var t=this,n=this._searchForm,i=e.trim(n.find(".filter").val()),s=this.controller.get("filter");return this._focusedIndex=null,this._focusedRow=null,i.length?(t.$el.addClass("loading"),t.controller.searchObj({q:i}).always(function(){t.$el.removeClass("loading")}).done(function(e){n.addClass("active"),c.buildGrid.call(t),c.setHeader.call(t),1==e.length&&t._onRowClick(e[0].id)}).fail(function(){c.clearFilter.call(t),t.parent.showErrors(arguments[0])}),void 0):(s&&c.clearFilter.call(t),void 0)},getGridHeader:function(){var e=this.controller.getTexts(),t="<tr>";return t+='<th class="col-id">ID</th>',t+="<th>"+e.object.ucFirst()+"</th>",t+="</tr>"},getGridContent:function(){var e=[],t=this.controller.get("filtered")||this.collection;return t.each(function(t){e.push(s({device:t.attributes,title:App.buildObjTitle(t)}))}),e.join("")},buildGrid:function(){this.controller.get("filtered"),this.$el.find("thead").html(c.getGridHeader.call(this)),this._tbody.html(c.getGridContent.call(this)),this.$el.find(".grid-header")[0].style.paddingRight=e.fn.getScrollbarWidth()+"px",c.setSelected.call(this)},buildChildView:function(t){this.children[t.id]=new DeviceListItemView({controller:this.controller,model:t,parent:this,el:e('<tr data-id="'+t.id+'"></tr>').appendTo(this._tbody),statusPopover:this._statusPopover})},initPopovers:function(){if(e.fn.popover){var t=this,n=this.controller,i=this.$el.find(".grid-content");this._statusPopover=this.parent.$el.find(".status-popover");var s=this._statusPopover.find(".popover-content");i.popover({selector:".status-icon",popover:this._statusPopover,position:{my:"left+11px top-18px"},before:function(r){var l=e(r.originalEvent.relatedTarget||r.originalEvent.currentTarget),d=l.data("icon"),u=l.data("id"),h=n.get("alarmDevices").get(u);if(!h)return!1;var m="log"==d?"getLastObjectLog":h.get("guardArrived")?"getArrivedGuard":"getAcceptedGuardCall";s.empty(),c.setLoadingTimeout.call(t,s),n[m](u).done(function(e){var i="";if("log"==d)i=a({username:e.username||e.userName,time:t.formatTimeAgo(e.ts||e.receivedAt),comment:e.comment});else{var r=n.getTexts();i=o({title:r.rrTeamShort+": "+e.guard,comment:(h.get("guardArrived")?r.rrtArriveTime:r.rrtCallAccepted)+": "+t.formatTimeAgo(e.ts)})}s.html(i)}).fail(function(){i.popover("close")}).always(function(){c.clearLoading.call(t,s)})},open:function(e,t){t.active.data("active",!0)}}),t._statusPopover.on("mouseenter",function(){clearTimeout(t._statusPopoverTmt)}).on("mouseleave",function(){clearTimeout(t._statusPopoverTmt),t._statusPopoverTmt=setTimeout(function(){t._statusPopover.data("active")&&i.popover("close")},300)}),i.on("mouseenter",".status-icon",function(){clearTimeout(t._statusPopoverTmt);var e=this;t._statusPopoverTmt=setTimeout(function(){var t=e.getBoundingClientRect(),n=t.left+t.width/2,s=t.top+t.height/2-3,a=new MouseEvent("mouseenter",{clientX:n,clientY:s,relatedTarget:e});i.popover("open",a)},100)}).on("mouseleave",".status-icon",function(){clearTimeout(t._statusPopoverTmt),t._statusPopoverTmt=setTimeout(function(){t._statusPopover.data("active")&&i.popover("close")},300)})}},setLoadingTimeout:function(e,t){c.clearLoading.call(this,e),this._loadingTimeout=setTimeout(function(){e.addClass("loading").data("loading",1)},t||150)},clearLoading:function(e){this._loadingTimeout&&(clearTimeout(this._loadingTimeout),this._loadingTimeout=null),e.data("loading")&&e.removeClass("loading")},changeNbAlarms:function(e,t){var n=this.$el.find("tr[data-id="+e+"]");if(n.length){var i=n.find("td.col-nb-alarms"),s=parseInt(i.text());i.text(s+t)}},setSelected:function(){var e=this.controller.get("device");if(this._focusedIndex=null,this._focusedRow=null,this.$el.find("tr.focused").removeClass("focused"),e){var t=this.$el.find("tr[data-id="+e.id+"]");t.length?(t.addClass("selected"),this._currentRow=t):(this.$el.find("tr.selected").removeClass("selected"),this._currentRow=null)}else this.$el.find("tr.selected").removeClass("selected"),this._currentRow=null},setHeader:function(){var e=this.controller.getTexts(),t=this.controller.get("filtered"),n="";if(t)if(t.length){var i=this.collection,s=t.length,a=t.filter(function(e){return i.get(e.id)});n=e.searchResultLable+": "+s+(a.length?", "+e.withAlarms.toLowerCase()+" "+a.length:"")}else n=e.searchNoResults;else{var o=App.get("totalAlarms");n=e.objects.ucFirst()+" "+e.objWithAlarms+': <span class="nb-alarms">'+o+"</span>"}this._hdr.html(n)},clearFilter:function(){this.controller.get("filter")&&(this._searchForm.removeClass("active"),this._searchForm.find("input[name=q]").val(""),this._focusedIndex=null,this._focusedRow=null,this.controller.set({filter:"",filtered:null}),c.buildGrid.call(this),c.setHeader.call(this))}};return l}),define("text!_common/alerts/tmpl/deviceHistoryExtended.html",[],function(){return'<h4 class="pull-left"><span class="device-title"><%= title %></span></h4>\n\n<div class="clearfix"></div>\n\n<div class="tabs-hor-cont">\n    <ul class="tabs-hor">\n        <li class="device-alarms <% if(key == \'alarms\') {%>active<% } else if(!hasAlarm) {%>hidden<% } %>">\n\n            <div class="tab-toggle-container">\n                <a class="tab-toggle" href="#tabs-tr-1" data-code="alarms">\n                    <i class="svg-icon svg-icon-warning"></i>\n                    <%= i18n.alarms.ucFirst() %>\n                </a>\n            </div>\n            <div class="tab-hor-content selectable" id="tabs-tr-1">\n\n                <div class="grid-container">\n                    <%= gridTmpl({i18n:i18n, alarms:true}) %>\n                </div>\n\n            </div><!--/tab-hor-content-->\n\n        </li><li class="device-alerts<% if(key == \'alerts\') {%> active<% } %>">\n\n            <div class="tab-toggle-container">\n                <a class="tab-toggle" href="#tabs-tr-2" data-code="alerts">\n                    <i class="svg-icon svg-icon-bell"></i>\n                    <%= i18n.all.ucFirst() +\' \'+  i18n.alerts %>\n                </a>\n            </div>\n            <div class="tab-hor-content selectable" id="tabs-tr-2">\n                <div class="grid-container">\n                    <%= gridTmpl({i18n:i18n, alarms:false}) %>\n                </div>\n            </div><!--/tab-hor-content-->\n\n        </li><li class="device-logs<% if(key == \'logs\') {%> active<% } %>">\n\n            <div class="tab-toggle-container">\n                <a class="tab-toggle" href="#tabs-tr-3" data-code="logs">\n                    <i class="svg-icon svg-icon-comment"></i><%= i18n.objectLog %>\n                </a>\n            </div>\n            <div class="tab-hor-content selectable" id="tabs-tr-3">\n                <div class="grid-container">\n                    <div class="grid-viewport">\n                        <div class="grid-content">\n                            <table width="100%" data-key="logs">\n                                <thead>\n                                    <th><div class="th"><%= i18n.time.ucFirst() %></div></th>\n                                    <th>\n                                        <div class="th"><%= i18n.history %></div>\n                                        <!--<i class="svg-icon svg-icon-filter"></i>-->\n                                        <div class="grid-filters">\n                                            <span class="grid-filter hint hint-left grid-filter-date"\n                                                  data-hint="<%= i18n.filterByDate %>">\n                                                <svg class="svg-icon">\n                                                    <use xlink:href="#smb-calendar"></use>\n                                                </svg>\n                                                <input class="grid-filter-date-input" type="text">\n                                            </span>\n                                            <span class="grid-filter-value grid-filter-value-date hidden">\n                                                <span class="grid-filter-value-label"></span>\n                                                <svg class="svg-icon grid-filter-clear">\n                                                    <use xlink:href="#smb-remove"></use>\n                                                </svg>\n                                            </span>\n                                            <span class="grid-filter hint hint-left filter-trigger<% if(logFilter) {%> on<% } %>"\n                                                  data-hint="<% if(logFilter) { print(i18n.showEvents) } else { print(i18n.showOnlyLogEntries) } %>">\n                                                <svg class="svg-icon">\n                                                    <use xlink:href="#smb-filter"></use>\n                                                </svg>\n                                            </span>\n                                        </div>\n                                    </th>\n                                    <!--<th><div class="th"><%= i18n.user.ucFirst() %></div></th>-->\n                                    <th><!--isComment--></th>\n                                    <!--<th>alertGroup</th>-->\n                                </thead>\n                                <tbody></tbody>\n                            </table>\n                        </div><!--/grid-content-->\n                    </div><!--/grid-viewport-->\n                </div><!--/grid-container-->\n            </div><!--/tab-hor-content-->\n        </li>\n    </ul>\n</div><!--/tabs-hor-cont-->\n\n<div class="popover bottom log-popover">\n    <div class="popover-content selectable"></div>\n</div>'}),define("text!_common/alerts/tmpl/alertsGridMobile.html",[],function(){return'<div class="grid-viewport">\n    <!--<div class="grid-height">-->\n    <div class="grid-content">\n        <table width="100%" data-key="<%= alarms ? \'alarms\' : \'alerts\' %>">\n            <thead>\n                <th>\n                    <div class="th"><%= i18n.timeOfCreation %></div>\n                </th><th>\n                    <div class="th"><%= i18n.timeOfReceive %></div>\n                </th><th>\n                    <div class="th"><%= i18n.alertCode %></div>\n                </th><th>\n                    <div class="th"><%= i18n[alarms ? \'alarm\' : \'alert\'].ucFirst() %></div>\n                </th><th>\n                    <div class="th"><%= i18n.inputStream %></div>\n                </th>\n            </thead>\n            <tbody></tbody>\n        </table>\n    </div>\n    <!--</div>-->\n</div>'}),define("text!_common/alerts/tmpl/alertsGridStat.html",[],function(){return'<div class="grid-viewport">\n    <div class="grid-content">\n        <table width="100%" data-key="<%= alarms ? \'alarms\' : \'alerts\' %>">\n            <thead>\n                <th>\n                    <div class="th"><%= i18n.timeOfCreation %></div>\n                </th><th>\n                    <div class="th"><%= i18n.timeOfReceive %></div>\n                </th><th>\n                    <div class="th"><%= i18n.alertCode %></div>\n                </th><th>\n                    <div class="th"><%= i18n[alarms ? \'alarm\' : \'alert\'].ucFirst() %></div>\n                </th><th>\n                    <div class="th"><%= i18n.objZoneKey %></div>\n                </th><th>\n                    <div class="th"><%= i18n.objZoneKeyName %></div>\n                </th><th>\n                    <div class="th"><%= i18n.objArea %></div>\n                </th><th>\n                    <div class="th"><%= i18n.objAreaName %></div>\n                </th><th>\n                    <div class="th"><%= i18n.inputStream %></div>\n                </th>\n            </thead>\n            <tbody></tbody>\n        </table>\n    </div>\n</div>'}),define("_common/alerts/views/DeviceHistoryViewExtended",["jquery","underscore","./DeviceHistoryView","jqueryui","datatables","moment","text!../tmpl/deviceHistoryExtended.html","text!../tmpl/alertsGridMobile.html","text!../tmpl/alertsGridStat.html","css!_libs/grids/DataTables/css/jquery.dataTables.cropped.css","css!_libs/grids/DataTables/extensions/Scroller/css/dataTables.scroller.min.css","datatables-scroller","colresize"],function(e,t,n,i,s,a,o,r,l){o=t.template(o),r=t.template(r),l=t.template(l),n.prototype;var c=new Date(2e3,0,1).getTime(),d="d.m.Y H:i:s";e.fn.dataTable.Api.register("row.prependGridRow()",function(t,n){var i=this.iterator("table",function(i){var a=s.ext.internal,o=i.aoData.length,r=e.extend(!0,{},s.models.oRow,{src:"data",_aData:t});if(i.aoData.push(r),i.aiDisplayMaster.unshift(o),n&&i.aiDisplay.unshift(o),a._fnLengthOverflow(i),0==i._iDisplayStart&&n){a._fnCreateTr(i,o);var l=e(i.nTBody),c=i.fnDisplayEnd();l.prepend(r.nTr);var d=l.find("tr[role=row]");d.length>c&&d.last().remove()}});return this.row(i[0])});var u=n.extend({constructor:function(){this._logPopover=null,this._startKey="alerts",this._loadLimit=50,this._builtInInvisible=!1,n.apply(this,arguments)},initialize:function(e){var t=this.controller=e.controller;this.parent=e.parent,App.allowed("alerts")&&this.model.get("hasAlarm")&&(this._startKey="alarms");var n=!1,i=t.getUserData("historyActivePage");i&&("alarms"!==i||this.model.get("hasAlarm")&&App.allowed("alerts")?"alarms"!==i&&this.model.get("hasAlarm")&&App.allowed("alerts")&&(i="alarms",t.setUserData("historyActivePage",i)):i="alerts",this._startKey!==i&&(n=!0,this._startKey=i)),this.render(),this._bindEvents(),n&&this.$el.find(".tab-toggle[data-code="+this._startKey+"]").trigger("tabshow"),this._buildList(this._startKey)},render:function(){var e=this.controller.getTexts(),t=r;this.model.get("objType")==App.TYPE_STAT&&(t=l),this.$el.html(o({i18n:e,title:h.getTitle.call(this),key:this._startKey,nbAlarms:0,hasAlarm:App.allowed("alerts")&&this.model.get("hasAlarm"),gridTmpl:t,logFilter:this.controller.get("logFilter")}))},getDateTs:function(e){var t=this.controller.getTexts().DateTime,n=t.prepareDateField(e),i=n.split("-");return+new Date(i[0],i[1]-1,i[2])},setLogsDateFilter:function(e){var t=this,n=this.getDateTs(e),i=n+864e5;this._filterDate=e,this.$el.addClass("loading"),this.controller.loadDeviceHistoryByPeriod(this.model.id,n,i).done(function(e){h.toggleDateFilterValue.call(t,t._filterDate),h.setGridData.call(t,"logs",e)}).always(function(){t.$el.removeClass("loading")})},clearLogsDateFilter:function(){var e=this;this._filterDate=null,this.controller.loadDeviceHistory("logs").done(function(t){h.toggleDateFilterValue.call(e,null),h.setGridData.call(e,"logs",t)})},_bindEvents:function(){var i=this,s=this.controller;n.prototype._bindEvents.apply(this,arguments),this.listenTo(App,"openalarms",t.bind(h.resizeHeight,this)).listenTo(App,"objectsTitleChange",t.bind(h.setTitle,this)).listenTo(this.model,"change:name",t.bind(h.setTitle,this)),App.allowed("alerts")&&this.listenTo(this.model,"change:hasAlarm",function(e,t){i.$el.find(".device-alarms")[t?"removeClass":"addClass"]("hidden");var n=s.getUserData("historyActivePage");t||(h.setGridData.call(i,"alarms",[]),this._count.alarms=0),t||"alarms"!==n?t&&"alarms"!==n&&i.$el.find(".tab-toggle[data-code=alarms]").trigger("tabshow"):i.$el.find(".tab-toggle[data-code=alerts]").trigger("tabshow")}),this.$el.find(".tabs-hor > li").on("toggle",function(t,n){var a=e(this).find("a[data-code]").data("code");n?s.setUserData("historyActivePage",a):"logs"===a&&i.$el.find(".device-logs .grid-content").popover("close")}),this.listenTo(this.parent,"layoutchange",t.throttle(function(){s.get("visible")&&(h.resizeHeight.call(i),i.$el.find("table.dataTable").resize())}),100).listenTo(this.parent,"show hide",function(){i._builtInInvisible?(i._buildList(i._builtInInvisible),i._builtInInvisible=!1):t.each(i._list,function(e){if(e&&"grid"==e.attr("role")){var t=e.DataTable().settings()[0];t.oFeatures.bAutoWidth=s.get("visible"),t.oScroll.sY=s.get("visible")?200:""}})}),this.$el.find(".grid-filter-value-date .grid-filter-clear").on("click",function(){i.clearLogsDateFilter()})},_buildList:function(e){var t=this;return this.controller.get("visible")?(this._list[e]=this.$el.find("table[data-key="+e+"]"),t._setLoadingTimeout(),function(e){t.controller.loadDeviceHistory(e).done(function(n){t._count[e]=n.length;var i="buildAlertsGrid";"logs"===e&&(i="buildLogsGrid"),h[i].call(t,e,n),t._bindListEvents(e)}).fail(function(){t.parent.showErrors(arguments[0])}).always(function(){t._clearLoading()})}(e),void 0):(this._builtInInvisible=e,void 0)},_renderRows:function(){},_onReceive:function(e,n){if(this._list[e]&&n.length){var i=this._list[e].DataTable(),s=this.controller,a=0==this._count[e];this._count[e]||this._list[e].siblings(".no-data").addClass("hidden"),this._count[e]+=n.length,"alarms"==e&&h.changeNbAlarms.call(this,n.length),t.each(n,function(t){a?(i.row.add(t),i.draw(),a=!1):i.row.prependGridRow(t,"logs"!=e||!s.get("logFilter")||s.isLogEntry(t))})}},_onAlarmResolved:function(e){this._list.alarms.find("tr[data-id="+e.id+"]").remove(),this._count.alarms-=1,h.changeNbAlarms.call(this,-1)}}),h={buildAlertsGrid:function(n,i){var s=this,a=this.controller.getTexts(),o=this.model.get("objType")==App.TYPE_STAT,r=this.controller.getUserData(n+"ColWidth"+(o?"Stat":"Mobile"))||{},l=[{data:function(e,t,n){return n=e.alertTs,n>c?Date.format(d,n):a.noData},key:"alertTs",width:r.alertTs||(o?"11%":"17%")},{data:function(e){return Date.format(d,e.receivedAt)},key:"receivedAt",width:r.receivedAt||(o?"11%":"17%")},{key:"code",data:function(e){return e.code||"-"},width:r.code||(o?"8%":"10%")},{key:"messageText",data:"messageText",width:r.messageText||(o?"18%":"39%")}];o&&(l=l.concat([{data:function(e){return"undefined"!=typeof e.areaZone?e.areaZone:"--"},key:"zone",width:r.zone||"8%","class":"text-center"},{data:function(e){return s._getAreaZoneName(e)},key:"zoneName",width:r.areaZone||"12%"},{data:function(e){return"undefined"!=typeof e.area?e.area:"--"},key:"area",width:r.area||"8%","class":"text-center"},{data:function(e){return e.areaName?t.escape(e.areaName):"-"},key:"areaName",width:r.areaName||"12%"}])),l=l.concat([{data:function(e){return e.channelName?t.escape(e.channelName):"-"},key:"channelName",width:r.channelName||(o?"12%":"17%")}]);var u={columns:l,data:i,createdRow:function(t,n){var i=e(t);i.attr("data-id",n.alertId).attr("data-ts",n.alertTs||0),"undefined"!=typeof n.fgColor&&i.css("color",n.fgColor),"undefined"!=typeof n.bgColor&&i.css("background",n.bgColor)}};h.buildGrid.call(this,n,u)},buildLogsGrid:function(t,n){var i=this,s=this.controller,a=this.model.get("objType")==App.TYPE_STAT,o=s.getUserData("logsColWidth")||{},r={data:n,columns:[{data:function(e){return Date.format(d,e.receivedAt)},key:"receivedAt",width:o.receivedAt||"20%",className:"time"},{data:function(e){return h.buildHistoryRowText.call(i,e,a)},key:"text",width:o.text||"80%",className:"text"},{data:function(e){return s.isLogEntry(e)?"1":"0"},visible:!1,searchable:!0}],createdRow:function(t,n){var i=e(t);s.isLogEntry(n)?i.attr("data-id",n.id).attr("data-userid",n.userId):(i.attr("data-id",n.alertId).attr("data-ts",n.alertTs||0),"undefined"!=typeof n.fgColor&&i.css("color",n.fgColor),"undefined"!=typeof n.bgColor&&i.css("background",n.bgColor))}},l=this.$el.find(".device-logs .grid-content");h.buildGrid.call(i,"logs",r);var c=s.getTexts(),u=this._list.logs.DataTable().column(2),m=l.find(".dataTables_scrollHead .filter-trigger");1==s.get("logFilter")&&u.search("1",!1,!1).draw(),m.on("click",function(){var e=!s.get("logFilter");s.set("logFilter",e),m[e?"addClass":"removeClass"]("on").attr("data-hint",e?c.showEvents:c.showOnlyLogEntries),u.search(e?"1":"",!1,!1).draw()}),e.fn.popover&&(this._logPopover=this.$el.find(".log-popover"),l.popover({selector:"tr[data-id]",popover:this._logPopover,position:{my:"center top+11px"},before:function(t){var n=e(t.currentTarget),s=n.closest("tr");i._logPopover.find(".popover-content").text(s.find(".text").text())}}),l.find(".dataTables_scrollBody").on("scroll",function(){l.popover("close")})),h.initDateFilter.call(this)},initDateFilter:function(){var e=this,t=new Date,n=this.$el.find(".dataTables_scrollHead .grid-filter-date"),i=this.$el.find(".dataTables_scrollHead .grid-filter-date-input").datepicker({dateFormat:"dd.mm.yy",maxDate:new Date,minDate:"-3y",beforeShow:function(t,s){setTimeout(function(){var t=n.offset();h.renderDatepickerButtons.call(e,s.dpDiv,i),s.dpDiv[0].style.left=t.left+20-s.dpDiv.width()+"px",s.dpDiv[0].style.top=t.top+18+"px"},50)},onChangeMonthYear:function(t,n,s){setTimeout(function(){h.renderDatepickerButtons.call(e,s.dpDiv,i)},30)},onSelect:function(t){e.setLogsDateFilter(t)},onClose:function(){n.data("shown",!1)}});i.datepicker("widget").appendTo("#jface-windows"),i.datepicker("setDate",t),n.on("click",function(){var e=n.data("shown");i.datepicker(e?"hide":"show"),n.data("shown",!e)})},renderDatepickerButtons:function(t,n){var i=this,s=this.controller.getTexts().DateTime,o=+new Date,r="DD.MM.YYYY",l=(new a).format(r),c=new a(o-864e5).format(r);t.append('<div class="ui-datepicker-buttonpane ui-widget-content clearfix"><a href="#" data-date="'+c+'" class="grid-filter-date-link float-left">'+s.yesturday+"</a>"+'<a href="#" data-date="'+l+'" class="grid-filter-date-link float-right">'+s.today+"</a>"+"</div>"),t.find("a.grid-filter-date-link").on("click",function(){var t=e(this).data("date");return i.setLogsDateFilter(t),n.datepicker("setDate",t),n.datepicker("hide"),!1})},buildHistoryRowText:function(e,n){var i=this.controller.isLogEntry(e),s=[],a="";if(i)a=0===e.comment.indexOf(this.controller.getTexts().rrTeamShort)?"":e.userName+": ",s.push(e.comment);else if(s.push(e.messageText+" ("+e.code+")"),n&&e.area>0){var o=this.controller.getTexts(),r=e.areaName?e.areaName+" (#"+e.area+")":o.objArea+" "+e.area,l=this._getAreaZoneName(e);r=t.escape(r),e.areaZoneName&&(l=t.escape(l)+" (#"+e.areaZone+")"),s.push(r,l)}return a+s.join(", ")},gridSource:function(e,t,n){var i=this;this._setLoadingTimeout(),i.controller.loadDeviceHistory(e,t.start,t.length>0?t.length:this._loadLimit).done(function(s){var a=i._count[e];n({draw:t.draw,data:s,recordsTotal:a,recordsFiltered:a})}).fail(function(){i.parent.showErrors(arguments[0])}).always(function(){i._clearLoading()})},buildGrid:function(n,i){var s=this,a=this.controller.getTexts(),o=this._list[n];t.extend(i,{ordering:!1,searching:"logs"==n,scrollCollapse:!1,scroller:{loadingIndicator:!1},info:!1,deferRender:!0,dom:"rtiS",scrollY:200,language:{zeroRecords:a.tableNoRecords}}),o.dataTable(i),h.initColResize.call(this,n,o),setTimeout(function(){h.resizeHeight.call(s,o.closest(".dataTables_scrollBody"))},100),s.controller.set("tableDataList",i.data),o.closest(".grid-content").on("click","tr[data-ts]",function(t){s.controller.trigger("playTimeSelect",e(this).data("ts")-1e4);var n=t&&t.target,i=n&&n.parentElement,a=i&&i.dataset&&i.dataset.id;if(a){var o=s.controller.get("tableDataList"),r=o.find(function(e){return+e.alertId===+a});r&&s.controller.trigger("onTableRowClick",r)}})},initColResize:function(e,n){var i=this,s=n.closest(".grid-content"),a=n.DataTable();s.colresize({selector:".dataTables_scrollHead th"});var o=s.find(".dataTables_scrollHead th");s.on("stop.colresize",function(n,r){var l=r.index,c=a.settings()[0],d=c.aoColumns,u=parseInt(d[l].sWidth),h=r.delta,m=t.reduce(t.pluck(c.aoColumns,"sWidth"),function(e,t){return e+parseFloat(t)},0),p=100*(u+h)/m,f=100*(parseInt(d[l+1].sWidth)-h)/m,g={};g[l]=p+"%",g[l+1]=f+"%",a.columns().setWidth(g),m=s.width();var v={};o.each(function(e){d[e]&&d[e].key&&(p=100*this.offsetWidth/m,v[d[e].key]=p+"%")});var _=e+"ColWidth";"logs"!=e&&(_+=i.model.get("objType")==App.TYPE_STAT?"Stat":"Mobile"),i.controller.setUserData(_,v)})},setGridData:function(e,t){if(this._list[e]){var n=this._list[e].dataTable();n.fnClearTable(),t.length&&n.fnAddData(t,!0)}},setTitle:function(){this.$el.find(".device-title").text(h.getTitle.call(this))},toggleDateFilterValue:function(e){var t=this.$el.find(".grid-filter-date"),n=this.$el.find(".grid-filter-value-date");t[e?"addClass":"removeClass"]("on"),e?n.removeClass("hidden").find(".grid-filter-value-label").text(e):n.addClass("hidden")},getTitle:function(){return App.buildObjTitle(this.model)+" (#"+this.model.get("extId")+")"},changeNbAlarms:function(e){var t=this.$el.find(".nb-alarms");if(t.length){var n=parseInt(t.text());t.text(n+e)}},resizeHeight:function(t){var n=t||this.$el.find(".dataTables_scrollBody");n.each(function(){this.style.height=h.getGridScrollHeight(e(this))+"px"})},getGridScrollHeight:function(e){return e.closest(".grid-content").height()-e.prevAll(".dataTables_scrollHead").height()}};return u}),define("text!_common/alerts/deviceState/tmpl/objectStatus.html",[],function(){return'<div class="subheader">\n    <a data-target="summary" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%= i18n.objStatus %></h5>\n</div>\n\n<div class="operate-content clearfix">\n    <div class="fluid-wrapper">\n        <div class="fluid-container status-settings"></div>\n    </div>\n    <div class="fluid-left">\n        <div class="form-inline control-group status-list">\n            <% _.each(i18n.objStatuses, function(name, id){%>\n            <label class="radio">\n                <input name="objStatus" type="radio" value="<%= id %>" <% if(id == status) {%> checked<% } %>>\n                <%= name %>\n            </label><br>\n            <% }) %>\n        </div>\n\n        <button class="btn btn-primary btn-save-status">\n            <%= i18n.save %>\n        </button>\n    </div>\n</div>\n\n\n'}),define("text!_common/alerts/deviceState/tmpl/objectTech.html",[],function(){return"<%= i18n.till %> <strong><%= dateS %></strong><% if(duration) {%> (<%= duration %>)<% } %>,\n<%= i18n.technician.toLowerCase() %> <strong><%= fullname %></strong>"}),define("text!_common/alerts/deviceState/tmpl/techSelect.html",[],function(){return'<div class="field field-period">\n    <label><%= i18n.setServiceStatusForPeriod %></label>\n    <select name="servicePeriod">\n        <option value="-1"><%= i18n.setServiceStatusNoLimit %></option>\n        <% _.each(periods, function(p){%>\n        <option value="<%= p.value %>"><%= p.label %></option>\n        <% }) %>\n        <option value="0"><%= i18n.setServiceStatusTillDate %></option>\n    </select>\n</div>\n<div class="field field-date row-fluid hidden">\n    <input type="text" name="serviceDate" class="input-date">\n    <input type="text" name="serviceTime" class="input-time">\n</div>\n<div class="field field-tech hidden">\n    <label><%= i18n.technician %></label>\n    <select name="techId">\n        <option value="0"><%= i18n.technicianNotSelected %></option>\n        <% _.each(technicians, function(p){%>\n        <option value="<%= p.id %>"><%= p.fullname %></option>\n        <% }) %>\n    </select>\n</div>'}),define("_common/alerts/deviceState/views/DeviceStateView",["jquery","underscore","abstracts/View","text!../tmpl/objectStatus.html","text!../tmpl/objectTech.html","text!../tmpl/techSelect.html"],function(e,t,n,i,s,a){i=t.template(i),s=t.template(s),a=t.template(a);var o=n.extend({constructor:function(e){this.parent=e.parent,this.controller=e.controller,this._stateLoaded=!1,this._stateLoading=!1,this._stateLoadingTmt=null,this._technicians=null,n.apply(this,arguments)},initialize:function(){this.render(),this._bindEvents()},setActivePage:function(e){var t=this.$el.find(".content.active")[0],n=this.$el.find(".content[data-key="+e+"]")[0];t.className=t.className.replace(" active",""),n.className+=" active"},_afterRender:function(){this.controller.get("stateLoading")&&this._setStateLoading()},_bindEvents:function(){var t=this,n=this.controller;this.listenTo(n,"change:stateLoading",function(e,n){t._stateLoaded||n||(t._onStateLoadedFirstTime(),t._stateLoaded=!0),t[n?"_setStateLoading":"_clearStateLoading"]()}),this._bindDeviceEvents(),this.$el.on("click","[data-page]",function(){var n=e(this).data("page");return t.setActivePage(n),!1}).on("click",".back",function(){var n=e(this).data("target");n&&t.setActivePage(n)}),this._initStatusChange()},_bindDeviceEvents:function(){var e=this;this.listenTo(e.model,"change:objStatus",function(t,n){if(null!==n){var i=e.$el.find(".obj-status");i.text(e.controller.getTexts().objStatuses[n]),e._setIndicatorState(i.parent(),n),App.trigger("objStatus:change",t.id,n),e.controller.get("parent").loadDeviceTechnician()}}).listenTo(this.model,"change:tech",function(){e._renderTechnician.call(e)})},_setIndicatorState:function(e,t){e.attr("data-state","number"==typeof t?t:t?"1":"0")},_setStateLoading:function(){var e=this;this._stateLoadingTmt&&clearTimeout(this._stateLoadingTmt),this._stateLoadingTmt=setTimeout(function(){e._toggleStateLoading(!0)},200)},_toggleStateLoading:function(e){this._stateLoading=e,this.$el.find(".state-loading")[e?"removeClass":"addClass"]("hidden")},_clearStateLoading:function(){this._stateLoading&&this._toggleStateLoading(!1),this._stateLoadingTmt&&clearTimeout(this._stateLoadingTmt),this._stateLoadingTmt=null},_onStateLoadedFirstTime:function(){},_restartStateUpdate:function(){this.controller.reload()},_renderTechnician:function(){var e=this.model,t=e.get("tech"),n=this.$el.find(".technician"),i=this.controller.getTexts(),a="";if(t){var o=(t.to-new Date)/1e3;a=s({i18n:i,dateS:this.formatDateTime(t.to),duration:o>0?i.serviceLeftTime.replace("#t#",Date.formatSeconds(o,!0,"dhm")):"",fullname:this._getStaffFullname(t)})}else e.get("objState")==e.STATUS_SERVICE&&(a=i.technicianNotSet);n.html(a)},_getStaffFullname:function(e){var t=e.lname||"";return t+=(t?" ":"")+(e.fname?e.fname.substr(0,1)+".":"")+(e.mname?e.mname.substr(0,1)+".":"")},_initStatusChange:function(){var e=this,t="click"+this._getEventsNS();this.$el.on(t,"[data-page=status]",function(t){return t.stopPropagation(),e._renderStatusChange(),!1}).on(t,"input[name=objStatus]",function(){e._renderStatusSettings(parseInt(this.value))}).on(t,".btn-save-status",function(){return e._saveStatus(),!1})},_loadTechnicians:function(){if(this._technicians)return(new e.Deferred).resolve(this._technicians);var t=this;return t.$el.addClass("loading"),App.getTechnicians().done(function(e){t._technicians=t._sortAndFormatTechnicians(e)}).always(function(){t.$el.removeClass("loading")
})},_sortAndFormatTechnicians:function(e){var n=this;return t.each(e,function(e){e.fullname=n._buildFullName(e)}),t.sortBy(e,function(e){return e.fullname})},_buildFullName:function(e){var n=this.controller.getTexts(),i=n.namesOrder,s=[];return t.each(i,function(t){t in e&&e[t].length&&s.push(e[t])}),t.escape(s.join(" "))},_renderStatusSettings:function(e){var t=this.model,n=t.get("objStatus");if(n!=t.STATUS_SERVICE){var i=this.controller.getTexts(),s=this.$el.find(".status-settings"),o=i.setServiceStatusPeriodLabel;if(e==t.STATUS_SERVICE){var r=this;this._loadTechnicians().done(function(){r._technicians.length&&(s.html(a({i18n:i,technicians:r._technicians,periods:[{value:900,label:o.replace("#n#",15).replace("#l#",i.minutesLabels[i.whichLabels(900)])},{value:3600,label:o.replace("#n#",1).replace("#l#",i.hoursLabels[0])},{value:10800,label:o.replace("#n#",3).replace("#l#",i.hoursLabels[i.whichLabels(3)])},{value:86400,label:o.replace("#n#",1).replace("#l#",i.hours24Labels[0])},{value:604800,label:o.replace("#n#",1).replace("#l#",i.week1)}]})),r._initStatusSettings(s))})}else s.empty()}},_initStatusSettings:function(t){var n=t.find("select[name=servicePeriod]"),i=t.find(".field-date"),s=t.find("input[name=serviceDate]"),a=t.find("input[name=serviceTime]"),o=t.find(".field-tech");s.datepicker({dateFormat:"dd.mm.yy",minDate:"+1d",maxDate:"+1y",showButtonPanel:!0}),s.datepicker("widget").appendTo("#jface-windows"),s.datepicker("setDate","+1d"),e.fn.timepicker&&a.timepicker({minuteStep:1,showMeridian:!1,showInputs:!1,appendWidgetTo:i,orientation:{y:"top",x:"auto"}}),n.on("change",function(){var e=parseInt(n.val());e>=0?(o.removeClass("hidden"),0===e?i.removeClass("hidden"):i.addClass("hidden")):(o.addClass("hidden"),i.addClass("hidden"))}),o.find("select").on("change",function(){this.className=""})},_renderStatusChange:function(){var e=(this.controller||this.module).getTexts(),t=(this.model.get("objStatus"),this.$el.find(".content[data-key=status]"));t.html(i({i18n:e,status:this.model.get("objStatus")}))},_saveStatus:function(){var e=parseInt(this.$el.find("input[name=objStatus]:checked").val());if(!isNaN(e)){if(this.model.get("objStatus")==e)return this.setActivePage("summary"),void 0;var t=this,n={status:e};if(e==this.model.STATUS_SERVICE){var i=this.$el.find(".status-settings"),s=parseInt(i.find("select[name=servicePeriod]").val()),a=i.find("select[name=techId]"),o=parseInt(a.val());if(s>=0){if(0>=o)return a.addClass("error"),void 0;if(n.staffId=o,s>0)n.period=1e3*s;else{var r=this.controller.getTexts(),l=+new Date,c=i.find("input[name=serviceDate]").val(),d=r.DateTime.prepareDateField(c),u=d.split("-"),h=i.find("input[name=serviceTime]").val().split(":");2!=h.length&&(h=[0,0]);var m=+new Date(u[0],u[1]-1,u[2],h[0],h[1]);n.period=m-l}}}this.$el.addClass("loading"),this.model.saveStatus(n).done(function(){t.setActivePage("summary")}).fail(function(e){t.showErrors(e)}).always(function(){t.$el.removeClass("loading")})}},_formatConnectionTime:function(){var e="";return e=this.model.isOnline()?this.controller.getTexts().online:this.formatDateTime(this.model.get("lastGSMConnectionTime"))},_getEventsNS:function(){return""}});return o}),define("text!_common/alerts/deviceState/tmpl/deviceState.html",[],function(){return'<div class="contents">\n    <div data-key="summary" class="content active">\n\n        <table class="table-features">\n        <tr>\n            <td class="features col1">\n                <ul class="indicators">\n                    <li class="indicator indicator-obj-status" data-state="<%= objStatus !== null ? objStatus : 0 %>">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-power"></use>\n                        </svg>\n                        <%= i18n.objStatus %>:\n                        <% if(App.allowed(\'objects.status.edit\')) {%>\n                        <a href="#" class="obj-status" data-page="status">\n                            <%= objStatus !== null ? i18n.objStatuses[objStatus] : \'\' %>\n                        </a>\n                        <% } else { %>\n                        <strong class="obj-status"><%= objStatus !== null ? i18n.objStatuses[objStatus] : \'\' %></strong>\n                        <% } %>\n                        <span class="technician"></span>\n                    </li>\n                    <li class="indicator">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-location"></use>\n                        </svg>\n                        <%= i18n.address.ucFirst() %>:\n                        <strong class="address">\n                            <i class="svg-icon svg-icon-spinner icon-spin"></i>\n                        </strong>\n                    </li>\n                    <li class="indicator" data-state="1">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-speed"></use>\n                        </svg>\n                        <%= i18n.speed.ucFirst() %>:\n                        <strong><span class="speed"><%= speed < minMoveSpeed ? 0 : Math._round(speed, 2) %></span> <%= i18n.kmh %></strong>\n                    </li>\n\n                    <li class="indicator isGsmOnline" data-state="<%= isGsmOnline ? 1 : 0 %>">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-connection"></use>\n                        </svg>\n                        <%= i18n.GSMConnection %>:\n                        <strong class="lastGSMConnectionTime nobr"><%= lastGSMConnectionTimeS %></strong>\n                    </li>\n                    <li class="indicator isGpsOnline" data-state="<%= isGpsOnline ? 1 : 0 %>">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-satellite"></use>\n                        </svg>\n                        <%= i18n.coords.ucFirst() %>:\n                        <strong class="lastGPSConnectionTime nobr"><%= lastGPSConnectionTimeS %></strong>\n                    </li>\n                    <li class="indicator" data-state="<%= \'undefined\' == typeof localRID ? 0 : 1 %>">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-download"></use>\n                        </svg>\n                        <%= i18n.objTrackReading %>:\n                        <strong>\n                            <span class="localRID"><%= \'undefined\' == typeof localRID ? \'\' : localRID %></span>\n                            <%= i18n.from %>\n                            <span class="remoteRID"><%= \'undefined\' == typeof remoteRID ? \'\' : remoteRID %></span>\n                            (<span class="rid-percent"><%= ridPercent %></span>%)\n                        </strong>\n                    </li>\n                    <li class="indicator power" data-state="<%= power == 0 ? 1 : 0 %>">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-plug"></use>\n                        </svg>\n                        <%= i18n.power.ucFirst() %>:\n                        <strong class="on"><%= i18n.powerOn %></strong>\n                        <strong class="off"><%= i18n.powerOff %></strong>\n                    </li>\n\n                    <% if(App.policeCallAllowed()){ %>\n                    <li class="indicator police" data-state="<%= policeTranslation ? 1 : 0 %>">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-police"></use>\n                        </svg>\n                        <a data-page="police" href="#">\n                            <%= i18n.policeTranslation %>\n                        </a>\n                    </li>\n                    <% } %>\n\n                    <li class="indicator follow-mode" data-state="<%= isFollowed == 1 ? 1 : 0 %>">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-eye"></use>\n                        </svg>\n                        <% if(App.allowed(\'control.followed\')) {%>\n                        <a data-page="follow" href="#">\n                            <%= i18n.followedMode %>\n                        </a>\n                        <% } else { %>\n                            <%= i18n.followedMode %>\n                        <% } %>\n                    </li>\n                </ul>\n            </td>\n\n            <td class="features col2">\n                <ul class="indicators">\n                    <li class="indicator" data-state="<%= hasDriver ? 1 : 0 %>">\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-wheel"></use>\n                        </svg>\n                        <%= i18n.driver.ucFirst() %>:\n                        <strong class="driver"><%= driver %></strong>\n                    </li>\n                </ul>\n                <ul class="indicators discrets"></ul>\n                <ul class="indicators controls"></ul>\n            </td>\n        </tr>\n\n        </table>\n    </div><!--/summary-->\n\n    <div data-key="operate" class="content"></div>\n    <div data-key="status" class="content"></div>\n    <div data-key="police" class="content"></div>\n    <div data-key="follow" class="content"></div>\n\n</div><!--/contents-->\n'}),define("text!_common/alerts/deviceState/tmpl/discrets.html",[],function(){return'<% _.each(discrets, function(d){ %>\n<li class="indicator discret <%= d.state == 1 ? \'on\' : \'off\' %>" data-state="<%= d.state == 1 ? 1 : 0 %>">\n    <svg class="svg-icon">\n        <use xlink:href="#smb-arrow-circle-right"></use>\n    </svg>\n    <%- d.name %>\n</li>\n<% }); %>'}),define("text!_common/alerts/deviceState/tmpl/controls.html",[],function(){return'<% _.each(controls, function(c, index){ %>\n<li class="indicator control<% if(loading) {%> loading<% } %>" data-state="<%= c.state == 1 ? 1 : 0 %>">\n    <% if(loading) {%>\n    <i class="svg-icon svg-icon-spinner icon-spin"></i>\n    <% } else { %>\n    <svg class="svg-icon">\n        <use xlink:href="#smb-arrow-circle-left"></use>\n    </svg>\n    <% } %>\n    <% if(!loading && \'undefined\' != typeof c.possibleStates && c.possibleStates.length) {%>\n        <a href="#" data-page="operate" data-index="<%= index %>"><%- c.name %></a>\n    <% } else {%>\n        <%- c.name %>\n    <% } %>\n</li>\n<% }); %>'}),define("text!_common/alerts/deviceState/tmpl/policeTranslation.html",[],function(){return'<div class="subheader">\n    <a data-target="summary" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%= i18n.policeTranslation %></h5>\n</div>\n<div class="operate-content">\n    <div class="operate-state police" data-state="<%= policeTranslation ? 1 : 0 %>">\n        <div class="state-wrap">\n            <svg class="svg-icon">\n                <use xlink:href="#smb-police"></use>\n            </svg>\n        </div>\n    </div>\n    <div class="operate-actions">\n        <button class="btn btn-block <%= policeTranslation ? \'\' : \' btn-primary\' %> btn-save-police">\n            <%= i18n[policeTranslation ? \'turnOff\' : \'turnOn\'] %>\n        </button>\n    </div>\n</div>'}),define("text!_common/alerts/deviceState/tmpl/followMode.html",[],function(){return'<div class="subheader">\n    <a data-target="summary" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%= i18n.followedMode %></h5>\n</div>\n<div class="operate-content">\n    <div class="operate-state" data-state="<%= isFollowed == 1 ? 1 : 0 %>">\n        <div class="state-wrap">\n            <svg class="svg-icon">\n                <use xlink:href="#smb-eye"></use>\n            </svg>\n        </div>\n    </div>\n    <div class="operate-actions">\n        <button class="btn btn-block <%= isFollowed == 1 ? \'\' : \' btn-success\' %> btn-save-follow-mode">\n            <%= i18n[isFollowed == 1 ? \'turnOff\' : \'turnOn\'] %>\n        </button>\n    </div>\n</div>'}),define("_common/alerts/deviceState/views/MobileStateView",["jquery","underscore","geo","jface","./DeviceStateView","_common/mobile/watched/views/MobileInfoView","text!../tmpl/deviceState.html","text!../tmpl/discrets.html","text!../tmpl/controls.html","text!../tmpl/policeTranslation.html","text!../tmpl/followMode.html"],function($,_,Geo,$jf,DeviceStateView,CommonMobileInfoView,tmplObjState,tmplDiscrets,tmplControls,tmplPolice,tmplFollow){function formatAddr(e){var t=null==e||"null"==e?"no data":e;return t=t.replace(", ",""),t=t.replace("/( )?-, /",", ")}var _super=DeviceStateView.prototype;tmplObjState=_.template(tmplObjState),tmplDiscrets=_.template(tmplDiscrets),tmplControls=_.template(tmplControls),tmplPolice=_.template(tmplPolice),tmplFollow=_.template(tmplFollow);var NO_DRIVER="--",MobileStateView=DeviceStateView.extend({constructor:function(){this._controlIndex=null,this.$address=null,DeviceStateView.apply(this,arguments)},render:function(){var e=this.model,t=_private.getDrivers.call(this),n=_.extend({},e.attributes,{i18n:this.controller.getTexts(),minMoveSpeed:e.get("minSpeed"),driver:t,hasDriver:t!=NO_DRIVER});_.extend(n,{lastGSMConnectionTimeS:this._formatConnectionTime(),lastGPSConnectionTimeS:this.formatDateTime(this.model.get("lastGPSConnectionTime")),ridPercent:null}),n.ridPercent=0,n.remoteRID&&(n.localRID>n.remoteRID&&(n.localRID=n.remoteRID),n.ridPercent=Math.round(100*n.localRID/n.remoteRID)),this.$el.addClass("obj-info-mobile").html(tmplObjState(n)),this._renderDiscrets(),this._renderControls(),this.$address=this.$el.find(".address");var i=this.controller.get("parent").getMapsModule();i&&i.trigger("needgeoinfo",this.model.pick("lat","lon"),this),this.model.has("tech")&&this._renderTechnician(),this._afterRender()},_bindEvents:function(){var e=this,t=this.controller.getTexts();_super._bindEvents.call(this),this.on("searchsuccess",function(n){e.model.set("address",formatAddr(n.address)),e._setIndicatorState(e.$address.parent(),-1==n.address.indexOf(t.addressNotFound))}).on("searcherror",function(){var t=e.model.get("lat"),n=e.model.get("lon"),i=e.controller.getTexts().addressNotFound;t&&n&&(i=Math._round(t,4)+", "+Math._round(n,4)),e.model.set("address",i),e._setIndicatorState(e.$address.parent(),!1)}),this._initOperate(),this._initPoliceTranslation(),this._initFollowMode()},_renderPower:function(){var e=this.model.get("power"),t=this.$el.find(".indicator.power");t.attr("data-state",1==e?0:1)},_renderDiscretsOrControls:function(key){var $el=this.$el.find("."+key),data=this.model.get(key),len=_.keys(data).length,wasHidden=$el.hasClass("hidden"),tmpl=eval("tmpl"+key.ucFirst()),tmplData={i18n:this.controller.getTexts()};wasHidden&&len?$el.removeClass("hidden"):wasHidden||len||$el.addClass("hidden"),len&&(tmplData[key]=data,"controls"==key&&(tmplData.loading=this._stateLoading),$el.html(tmpl(tmplData)))},_initPoliceTranslation:function(){var e=this,t=e.model;this.$el.on("click","[data-page=police]",function(t){return t.stopPropagation(),e._renderPoliceTranslation(),!1}).on("click",".btn-save-police",function(){return e.$el.addClass("loading"),t.setPoliceTranslation(t.get("policeTranslation")?0:1).done(function(){e._onOperateSuccess()}).fail(function(t){e.showErrors(t)}).always(function(){e.$el.removeClass("loading")}),!1})},_renderPoliceTranslation:function(){var e=this.$el.find(".content[data-key=police]");e.html(tmplPolice({i18n:this.controller.getTexts(),policeTranslation:this.model.get("policeTranslation")}))},_initFollowMode:function(){var e=this,t=e.model;this.$el.on("click","[data-page=follow]",function(t){return t.stopPropagation(),e._renderFollowMode(),!1}).on("click",".btn-save-follow-mode",function(){return e.$el.addClass("loading"),t.setFollowMode(1!=t.get("isFollowed")).done(function(){e._onOperateSuccess()}).fail(function(t){e.showErrors(t)}).always(function(){e.$el.removeClass("loading")}),!1})},_renderFollowMode:function(){var e=this.$el.find(".content[data-key=follow]");e.html(tmplFollow({i18n:this.controller.getTexts(),isFollowed:this.model.get("isFollowed")}))},_bindDeviceEvents:function(){var e=this,t=this.model;_super._bindDeviceEvents.apply(this,arguments),this._bindIndicatorsChanges(),this.listenTo(t,"change:driversInfo",function(){var t=e.$el.find(".driver"),n=_private.getDrivers.call(e);t.text(n),e._setIndicatorState(t.parent(),n!=NO_DRIVER)}).listenTo(t,"change:address",function(t,n){e.$address.text(n)}).listenTo(t,"change:policeTranslation",function(t,n){e._setIndicatorState(e.$el.find(".indicator.police"),n)}).listenTo(t,"change:isFollowed",function(t,n){e._setIndicatorState(e.$el.find(".indicator.follow-mode"),1==n)})},_onStateLoadedFirstTime:function(){var e=this;this._renderControls(),this.listenTo(e.model,"change:controls",function(){e._renderControls()})},_toggleStateLoading:function(e){this._stateLoading=e,this._renderControls()}});_.each(["_bindIndicatorsChanges","_renderTrackReading","_renderDiscrets","_renderControls","_initOperate","_renderOperate","_sendOperate","_onOperateSuccess","_closeOperate","_getTexts"],function(e){!function(e){MobileStateView.prototype[e]=function(){return CommonMobileInfoView.prototype[e].apply(this,arguments)}}(e)});var _private={getDrivers:function(){var e=this.model,t=e.getCurrentStaff();return t.length?t.join(", "):NO_DRIVER}};return MobileStateView}),define("stat/nls/stat",{root:{appartment:"Flat / office",buildingShort:"bld.",gateCode:"Gate code",intercomCode:"House intercom code",noObjAreas:"There are no areas",addObjArea:"Add area description",objAreasState:"State of areas",noObjZones:"There are no zones",addObjZone:"Add zone description",canNotAddObjZone:"To add an zone at least one area must be created",objZoneNum:"Zone No",objZoneName:"Zone name",objZoneComment:"Note",objZonesNumber:"Number of zones",setObjPosition:"Set object coordinates",changeObjPosition:"Edit object coordinates",clickOnMapToSetPos:"To set valid coordinates specify location on the map.",moveObjectToSetPos:"To set valid coordinates move the object on the map.",errIncorrectLat:"Enter valid latitude.",errIncorrectLon:"Enter valid longitude.",cancelEditObjHdr:"Cancel changes?",cancelEditObjMsg:"Object coordinate changes will be cancelled.",errIncorrectAddress:"Fill in required fields please.",armSchedule:"Arming schedule",armSchedulesShort:"Schedules",armSchedulesEmpty:"No schedules have been created yet",armSchedulesParseError:"Arming schedule settings contain an invalid value",armScheduleNew:"New schedule",armScheduleName:"Schedule name",armScheduleComment:"Notes",armScheduleCreate:"Add schedule",armSchedulesCopy:"Copy schedule templates",armScheduleNotSelected:"Is not selected",armScheduleLegend:"Weekly schedule. The minimum interval is 30 minutes",armScheduleMustBeArmed:"Must be armed",armScheduleMayBeDisarmed:"Can be disarmed",armScheduleAllowDisarmLabel:"Disarming within the allowed interval for a limited time (hh:mm)",armScheduleSendNotArmedAlert:'Set the event "Not armed"',armScheduleSendEarlyDisarmedAlertAlert:'Set the event "Early disarming"',armSchedulesCopyFormLabel:"Select an object or group of objects where you want to copy this schedule list",armSchedulesCopyConfirm:"<p>Copy the&nbsp;list of&nbsp;schedules for&nbsp;this&nbsp;object to&nbsp;the selected&nbsp;objects?</p>",armScheduleDeleteConfirm:"<p>Do you really want to delete the schedule?</p><p><strong>Attention!</strong> This schedule is&nbsp;used for one or&nbsp;more areas of&nbsp;the&nbsp;object.</p><p>Once removed, it will no&nbsp;longer be used to&nbsp;handle the&nbsp;events in&nbsp;these areas.</p>"},"ru-ru":!0,"it-it":!0}),define("stat/nls/ru-ru/stat",{appartment:". / ",buildingShort:".",gateCode:" ",intercomCode:" ",noObjAreas:"   ",addObjArea:"  ",objAreasState:" ",noObjZones:"   ",addObjZone:"  ",canNotAddObjZone:"        ",objZoneNum:" ",objZoneName:" ",objZoneComment:"",objZonesNumber:" ",setObjPosition:"  ",changeObjPosition:"  ",clickOnMapToSetPos:"   ,    .",moveObjectToSetPos:"   ,    .",errIncorrectLat:"  .",errIncorrectLon:"  .",cancelEditObjHdr:" ?",cancelEditObjMsg:"    .",errIncorrectAddress:"   .",armSchedule:" ",armSchedulesShort:"",armSchedulesEmpty:"     ",armSchedulesParseError:"    ",armScheduleNew:" ",armScheduleName:" ",armScheduleComment:"",armScheduleCreate:" ",armSchedulesCopy:"  ",armScheduleNotSelected:" ",armScheduleLegend:" ,   30 ",armScheduleMustBeArmed:"   ",armScheduleMayBeDisarmed:"    ",armScheduleAllowDisarmLabel:"       , :",armScheduleSendNotArmedAlert:'  "   "',armScheduleSendEarlyDisarmedAlertAlert:'  "   "',armSchedulesCopyFormLabel:"    ,      ",armSchedulesCopyConfirm:"<p>     &nbsp;&nbsp;?</p>",armScheduleDeleteConfirm:"<p>    ?</p><p><strong>!</strong>         .</p><p>        .</p>"}),define("text!_common/stat/watched/tmpl/objInfoRestyle.html",[],function(){return'<div data-key="summary" class="content active">\n    <div class="features">\n        <ul>\n            <li data-prop="deviceTypeName"\n                class="<% if(prerender) {%>loading<% } %><% if(\'deviceTypeName\' in hiddenProps) {%> hidden<% } %>">\n                <%= i18n.objHardwareType %>:\n                <strong class="deviceTypeName">\n                    <% if(prerender) {%><i class="svg-icon svg-icon-spinner icon-spin"></i><% } %>\n                    <%= deviceTypeName || \'--\' %>\n                    <% if(rev) {%>(<%= rev %>)<% } %>\n                </strong>\n            </li>\n            <li data-prop="address"<% if(\'address\' in hiddenProps) {%> class="hidden"<% } %>>\n                <%= i18n.address.ucFirst() %>:\n                <strong class="address"><%- addressStr %></strong>\n            </li>\n        </ul>\n    </div><!--/features-->\n\n    <div class="features-col-group clearfix">\n        <div class="features-col">\n            <div class="widgets-group object-state-wrapper">\n                <div class="widget widget-guard <%= activeWidget == \'guard\' ? \'active\' : \'\' %>" data-value="guard"></div>\n\n                <% if(showTemperature) {%>\n                <div class="widget-temperature widget <%= activeWidget == \'temperature\' ? \'active\' : \'\' %>"\n                     data-state="<%= temperature > 0 ? 1 : 0%>" \n                     data-value="temperature"\n                >\n                    <div class="temperature-panel loading" />\n                </div>\n\n                <ul class="widgets-nav">\n                    <li class="widgets-nav-item widgets-nav-item-guard <%= activeWidget == \'guard\' ? \'active\' : \'\' %>"\n                        data-value="guard" data-state="" data-guarded="">\n                    </li>\n                    <li class="widgets-nav-item widgets-nav-item-temperature <%= activeWidget == \'temperature\' ? \'active\' : \'\' %>"\n                        data-value="temperature"\n                        >\n                        <svg class="svg-icon">\n                            <use xlink:href="#smb-temperature"></use>\n                        </svg>\n                    </li>\n                </ul>\n                <% } %>\n            </div>\n        </div><!--/.features-col-->\n\n        <div class="features-col">\n            <ul class="list-group indicators connections"></ul>\n            <ul class="list-group indicators areas-state-wrapper state-loading"></ul>\n            <% if(prerender) {%>\n            <div class="indicators">\n                <i class="svg-icon svg-icon-spinner icon-spin"></i>\n            </div>\n            <% } else if(hasControls) { %>\n            <ul class="list-group indicators controls state-loading"></ul>\n            <% } %>\n        </div><!--/.features-col-->\n    </div><!--/.features-col-group-->\n\n\n    <div class="row-fluid object-state-summary hidden">\n        <div class="state-wrapper areas-state-wrapper loading"></div>\n    </div>\n\n</div><!--/content summary-->\n\n<div data-key="connections" class="content"></div>\n<div data-key="guard" class="content"></div>\n<div data-key="control" class="content"></div>\n<div data-key="faults" class="content"></div>\n\n'}),define("text!_common/stat/watched/tmpl/temperaturesRestyle.html",[],function(){return'<div class="temperature-panel loading">\n    <div class="temperature-ctrl-top <%= hiddenCtrl ? \'temperature-ctrl-top_hidden\' : \'\' %>"></div>\n\n    <div class="temperature"\n        data-value="temperature"\n    >    \n        <div class="temperature-ctrl-arrow more-action more-action-left <%= hiddenCtrl ? \'temperature-ctrl-arrow_hidden\' : \'\' %>" \n            data-arrow="left"\n        >\n            <svg class="svg-icon  more-action">\n                <use xlink:href="#smb-chevron-right"></use>\n            </svg>\n        </div>\n\n        <div class="temperature-panel-value"></div>\n\n        <div class="temperature-ctrl-arrow more-action more-action-right <%= hiddenCtrl ? \'temperature-ctrl-arrow_hidden\' : \'\' %>" \n            data-arrow="right"\n        >\n            <svg class="svg-icon more-action">\n                <use xlink:href="#smb-chevron-right"></use>\n            </svg>\n        </div>\n    </div>\n\n    <div class="temperature-bottom"\n        data-value="temperature"\n    >\n        <p class="temperature-panel-units">&deg;C</p>\n        <p class="temperature-panel-name"><%= i18n.temperature %></p>\n    </div>\n</div>'}),define("text!_common/stat/watched/tmpl/baloonFooter.html",[],function(){return'<a class="unwatch" href="javascript:;"><%= i18n.removeFromMap %></a>\n<% if(routingModule) {%>\n<a href="#" class="route-to pull-right"><%= i18n.routeHere %></a>\n<% } %>'}),define("text!_common/stat/watched/tmpl/objStateRestyle.html",[],function(){return'<div class="widget-value"><%= svgIcon %></div>\n<strong class="widget-label"><%= objTitle %></strong>\n'}),define("text!_common/stat/watched/tmpl/connections.html",[],function(){return'<li class="list-group-item indicator isOnline" \n    data-state="<%= isOnline ? 1 : 0 %>"\n    <% if(isShellAllowed) {%> data-page="connections"<% } %>\n    >\n    <svg class="svg-icon list-group-item-icon">\n        <use xlink:href="#smb-connection"></use>\n    </svg>\n    <div class="info">\n        <h4><%= i18n.GSMConnection %></h4>\n        <div class="extra-online">\n            <span class="extra lastGSMConnectionTime nobr extra-online-label"><%= lastGSMConnectionTimeS %></span>\n            <% if(hasLbsData) {%>\n                <div class="lbs-control lbs-control-stat <%= lbsLoading ? \'loading\' : \'\' %> ">\n                    <i class="svg-icon svg-icon-spinner icon-spin"></i> \n                    <span class="lbs-control-label">\n                        <% if(lbsShown) {\n                            print(i18n.hideLbs)\n                        } else { \n                            print(i18n.showLbs)\n                        } %>\n                    </span>\n                </div>\n            <% } %>\n        </div>\n    </div>\n\n    <% if(isShellAllowed) {%>\n        <svg class="svg-icon more-action">\n            <use xlink:href="#smb-chevron-right"></use>\n        </svg>\n    <% } %>\n</li>\n'}),define("text!_common/stat/watched/tmpl/areasStat.html",[],function(){return'<table data-rows="<% if(areasStat) { print(_.keys(areasStat).length) } else { print(totalAreas) }%>">\n\n<% if(areasStat) { var index = 0; _.each( [\'hasAlarm\', \'hasFault\', \'isGuarded\', \'notGuarded\'], function(key) {%>\n\n    <% if(\'undefined\' != typeof areasStat[key]) {%>\n    <tr data-state="<%= key %>" class="areas-state multi row-<%= ++index %>">\n        <td class="extra">\n            <svg class="svg-icon">\n                <use xlink:href="#smb-<%= areasStat[key].icon %>"></use>\n            </svg>\n        </td><td class="info">\n            <h6><%= areasStat[key].title %></h6>\n            <p><%= areasStat[key].text %></p>\n        </td><td class="extra1">\n            <i class="svg-icon svg-icon-chevron-right"></i>\n        </td>\n    </tr>\n    <% } %>\n\n<% })} else { print( areasHtml ) } %>\n\n</table>'}),define("text!_common/stat/watched/tmpl/areasList.html",[],function(){return'<div class="subheader">\n    <a data-target="summary" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%= title %></h5>\n</div>\n\n<div class="areas-state-cont">\n    <table>\n        <%= areasHtml %>\n    </table>\n</div>\n<% if(0) {%>\n\n<div class="areas-list">\n    <table>\n        <colgroup>\n            <!--<col style="width:5%">\n            <col style="width:27%">\n            <col style="width:25%">\n            <col style="width:16%">\n            <col style="width:27%">-->\n\n            <col style="width:20px">\n            <col style="width:18px">\n            <col style="width:18px">\n            <col style="width:18px">\n        </colgroup>\n        <% _.each(areas, function(area){%>\n        <tr class="area" data-id="<%= area.id %>"\n            data-index="<%= area.num %>"\n        <% if(area.num > 0 && operatable) {%> data-page="operate"<% } %>>\n\n        <td class="text-center" title="<%= i18n.objAreaNum %>"><%- area.num %></td>\n        <td class="state-guard<% if(area.isGuarded) {%> on<% } %>"<% if(area.num > 0) {%> title="<%= area.isGuarded ? i18n.guarded : i18n.notGuarded %>"<% } %>>\n        <% if(area.num > 0) {%>\n        <i class="icon-state icon-state-guard"></i>\n        <!--<%= area.isGuarded ? i18n.guarded : i18n.notGuarded %>-->\n        <% } %>\n        </td>\n        <td class="state-alarm<% if(area.hasAlarm) {%> on<% } %>" title="<%= area.hasAlarm ? i18n.withAlarms : i18n.noAlarms %>">\n            <i class="icon-state icon-state-alarm"></i>\n            <!--<% if(area.hasAlarm) { print(i18n.alarm.ucFirst()) } %>-->\n        </td>\n\n        <td class="state-fault<% if(area.hasFault) {%> on<% } %>" title="<%= area.hasFault ? i18n.hasFault : i18n.noFault %>">\n            <i class="icon-state icon-state-fault"></i>\n            <!--<% if(area.hasFault) { print(i18n.hasFault) } %>-->\n        </td>\n        <td class="area-name text-left">\n            <%- area.num == 0 ? i18n.zeroAreaName : ( area.name || i18n.objArea + \' \' + area.num ) %>\n            <% if(area.num > 0 && operatable) {%>\n            <i class="svg-icon svg-icon-chevron-right"></i>\n            <% } %>\n        </td>\n        </tr>\n        <% }) %>\n    </table>\n</div>\n\n<% } %>'}),define("text!_common/stat/watched/tmpl/areasRestyle.html",[],function(){return'<% _.each( areas, function(area) { if(area.num == 0 && !area.hasAlarm && !area.hasFault) return;%>\n\n    <li class="list-group-item indicator areas-state <%= area.num == 0 ? \' area-system\' : \'\'  %>"\n        data-state="<%= area.mainState %>" <% if( area.operatable ) {%>data-page="guard" data-index="<%= area.num %>"<% } %>>\n\n        <svg class="svg-icon list-group-item-icon">\n            <use xlink:href="#smb-<%= area.icon %>"></use>\n        </svg>\n        <i class="svg-icon list-group-item-icon svg-icon-spinner icon-spin"></i>\n\n        <div class="info">\n            <h4><%= area.name %></h4>\n            <p class="extra"><%= area.stateLabel %></p>\n            <p class="extra state-loading-extra"><%= stateLoadingTxt %>...</p>\n        </div>\n\n        <% if(area.operatable) {%>\n        <svg class="svg-icon more-action">\n            <use xlink:href="#smb-chevron-right"></use>\n        </svg>\n        <% } %>\n    </li>\n\n<% }) %>'
}),define("text!_common/stat/watched/tmpl/controls.html",[],function(){return'<% _.each(controls, function(c){ %>\n<li class="list-group-item indicator control-state"\n    data-state="<%= c.state == 1 ? 1 : 0 %>"\n    <% if(controlAllowed && c.canControl) {%> data-page="control" data-index="<%= c.num %>"<% } %>>\n    <svg class="svg-icon list-group-item-icon">\n        <use xlink:href="#smb-sun"></use>\n    </svg>\n    <i class="svg-icon list-group-item-icon svg-icon-spinner icon-spin"></i>\n    <% if(controlAllowed && c.canControl) {%>\n    <svg class="svg-icon more-action">\n        <use xlink:href="#smb-chevron-right"></use>\n    </svg>\n    <% } %>\n    <div class="info">\n        <h4><%- c.name %></h4>\n        <p class="extra"><%= i18n[c.state === null ? \'noData\' : ( c.state == 1 ? \'switchedOnShort\' : \'switchedOffShort\' )].ucFirst() %></p>\n        <p class="extra state-loading-extra"><%= i18n.objectStateScan %>...</p>\n    </div>\n</li>\n<% }) %>\n'}),define("text!_common/stat/watched/tmpl/operateArea.html",[],function(){return'<div class="subheader">\n    <a data-target="<%= prevPage %>" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%- area.name || i18n.objArea + \' \' + area.num %></h5>\n</div>\n<div class="operate-content guard-operate-content">\n    <div class="operate-state <%= area.hasAlarm ? \'alarm\' : ( area.hasFault ? \'fault\' : ( \'guard \' + ( area.isGuarded ? \'on\' : \'off\' ) ) ) %>">\n        <div class="state-wrap">\n            <svg class="svg-icon">\n                <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#smb-<%= icon %>"></use>\n            </svg>\n        </div>\n    </div>\n    <div class="operate-actions guard-actions">\n        <% if(area.num > 0 && canArm) {%>\n        <button class="btn btn-block <%= area.isGuarded ? \' btn-success\' : \' btn-primary\' %>"\n                data-area="<%= area.num %>"\n                data-guard="<%= area.isGuarded ? \'0\' : \'1\' %>">\n            <%= i18n[area.isGuarded ? \'makeNotGuarded\' : \'makeGuarded\'] %>\n        </button>\n        <% } %>\n        <% if(faults) {%>\n        <button class="btn btn-block btn-warning"\n                data-area="<%= area.num %>"\n                data-page="faults">\n                <%= i18n.viewFaults %>\n        </button>\n        <% } %>\n    </div>\n    <div class="command-result"></div>\n</div>\n'}),define("text!_common/stat/watched/tmpl/operateControl.html",[],function(){return'<div class="subheader">\n    <a data-target="summary" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%- control.name %></h5>\n</div>\n<div class="operate-content">\n    <div class="operate-state <%= control.state == 1 ? \'on\' : \'off\' %>" data-state="<%= control.state == 1 ? 1 : 0 %>">\n        <div class="state-wrap">\n            <svg class="svg-icon">\n                <use xlink:href="#smb-power"></use>\n            </svg>\n        </div>\n    </div>\n    <div class="operate-actions control-actions">\n        <button class="btn btn-block <%= control.state == 1 ? \'\' : \' btn-success\' %>"\n                data-num="<%= control.num %>"\n                data-command="<%= control.state == 1 ? 0 : 1 %>">\n            <%= i18n[control.state == 1 ? \'turnOff\' : \'turnOn\'] %>\n        </button>\n    </div>\n</div>\n'}),define("text!_common/stat/watched/tmpl/faults.html",[],function(){return'<div class="subheader">\n    <a data-target="<%= prevPage %>" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%- area.name || i18n.objArea + \' \' + area.num %>. <%= i18n.faultsList %></h5>\n</div>\n<div class="faults-content">\n    <table class="faults-table selectable">\n        <% _.each( faults, function(fault){%>\n        <tr class="fault">\n            <td class="fault-text">\n                <% if(area.num > 0) {%>\n                    <%- fault.areaZoneName  || (i18n.objZone + \' \' + fault.areaZoneNum) %>\n                    (#<%= fault.areaZoneNum %>)<br />\n                <% } %>\n                <%- fault.messageText %>\n            </td>\n            <td class="fault-action">\n                <a href="#" data-code="<%= fault.faultCode %>"\n                    data-zone="<%= fault.areaZoneId %>"\n                    class="resolve-fault" title=""><%= i18n.resolveFault %></a>\n            </td>\n        </tr>\n        <% }) %>\n    </table>\n</div>\n'}),define("text!_common/stat/watched/tmpl/home.svg",[],function(){return'<svg class="svg" version="1.1" xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36">\n<path class="svg-path svg-path-half" fill="#F36E21" d="M30.883,20.02L18,9.29L5.119,20.02v15.024h25.764V20.02L30.883,20.02z M17.993,14.8v16.011h-8.64v-8.81\n	l8.633-7.202L17.993,14.8L17.993,14.8z"/>\n<path class="svg-path svg-path-armed" fill="#009F62" d="M5.118,20.018v15.026h25.765V20.018L18,9.289L5.118,20.018L5.118,20.018z"/>\n<path class="svg-path" d="M5.119,20.02v15.024h25.764V20.02L18,9.29L5.119,20.02L5.119,20.02z M18,14.8l8.648,7.202v8.811H9.353v-8.811L18,14.8\n	L18,14.8z"/>\n<path class="svg-path" d="M0,15.946l2.607,3.131c0,0,13.177-10.974,15.393-12.819c2.217,1.845,15.393,12.819,15.393,12.819L36,15.946L18,0.957\n	L0,15.946z"/>\n</svg>'}),define("text!_common/stat/watched/tmpl/pageConnections.html",[],function(){return'<div class="subheader">\n    <a data-target="summary" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%- i18n.connection.ucFirst() %></h5>\n</div>\n<div class="connections-content">\n    <% \n        if (channels && channels.length && tmplRow) {\n            _.each(channels, function(channel, index){\n                print(tmplRow(_.extend({\n                    channel: channel, \n                    index: index, \n                    i18n: i18n\n                })));\n            })\n        }\n    %>\n</div>\n'}),define("text!_common/stat/watched/tmpl/pageConnectionsRow.html",[],function(){return'<div class="connections-row <%= channel.isActive ? \' connections-row-active\' : \'\' %>">\n    <div class="connections-row-icon">\n        <svg class="svg-smb">\n            <use xlink:href="#smb-<%= channel.icon %>"></use>\n        </svg>\n    </div>\n\n    <p class="connections-row-item connections-row-item_name">\n        <%- channel.name %>\n    </p>\n\n    <p class="connections-row-item">\n        <%- channel.text %>\n    </p>\n</div>\n'}),define("_common/stat/watched/views/StatInfoView",["jquery","underscore","_common/stat/StatObject","_common/stat/StatDetails","_common/stat/Control","abstracts/watched/views/DeviceInfoView","i18n!_common/nls/common","i18n!stat/nls/stat","text!../tmpl/objInfoRestyle.html","text!../tmpl/temperaturesRestyle.html","text!../tmpl/baloonFooter.html","text!../tmpl/objStateRestyle.html","text!../tmpl/connections.html","text!../tmpl/areasStat.html","text!../tmpl/areasList.html","text!../tmpl/areasRestyle.html","text!../tmpl/controls.html","text!../tmpl/operateArea.html","text!../tmpl/operateControl.html","text!../tmpl/faults.html","text!../tmpl/home.svg","text!abstracts/watched/tmpl/operateSuccess.svg","text!../tmpl/pageConnections.html","text!../tmpl/pageConnectionsRow.html"],function(e,t,n,i,s,a,o,r,l,c,d,u,h,m,p,f,g,v,_,b,w,y,A,T){A=t.template(A),T=t.template(T),l=t.template(l),c=t.template(c),d=t.template(d),u=t.template(u),m=t.template(m),h=t.template(h),p=t.template(p),f=t.template(f),g=t.template(g),v=t.template(v),_=t.template(_),b=t.template(b);var C=0,x=25,k=e.extend({},o,r),S=a.prototype,M=2,I=a.extend({constructor:function(){this._areasConditions=null,this._areaNumber=null,a.apply(this,arguments)},initialize:function(){this.$el.addClass("obj-info-restyle obj-info-stat"),a.prototype.initialize.apply(this,arguments),this._renderTemperature()},remove:function(){S.remove.apply(this,arguments),this._lbsShown&&(this._lbsUpdated=!1,this._hideLbs())},getDetailedModelClass:function(){return i},getAddress:function(){var e=this.model.get("addressShort");return e||(e=Math._round(this.model.get("lat"),4)+", "+Math._round(this.model.get("lon"),4)),e},_bindEvents:function(){var e=this,t="click"+this._getEventsNS();a.prototype._bindEvents.apply(this,arguments),this._initFaults();var n=this.controller.get("parent").getMapsModule();n&&this.$el.on(t,".route-to",function(){e.trigger("close");var t=e.model.get("name");return n.openRouting([{type:"mobile"},{type:"stat",text:t,model:e.model,lat:e.model.get("lat"),lon:e.model.get("lon")}],e.$el),!1}),App.reportsAllowed("stat")&&this.$el.on(t,".cmd-report",function(){return App.trigger("needreport","stat",[e.model]),e.trigger("close"),!1})},_bindModelEvents:function(){var e=this;a.prototype._bindModelEvents.apply(this,arguments),t.each(["name","deviceTypeName","city"],function(n){e.listenTo(e.model,"change:"+n,function(i,s){e.$el.find("."+n).text(t.isNull(s)?"":s)})}),this.listenTo(this.model,"change:addressShort",function(){e.$el.find(".address").text(e.getAddress())}).listenTo(this.model,"change:coords",function(){e.model.get("addressShort")||e.$el.find(".address").text(e.getAddress())}).listenTo(this.model,"change:isOnline change:lastGSMConnectionTime",function(){e._renderConnections(),e._initLbs()}).listenTo(this.model,"change:isGsmOnline",function(t,n){e.$el.toggleClass("obj-info-online",n),e._lbsShown&&e._drawLbs()}).listenTo(this.model,"change:isGuarded change:hasFault",function(){D.renderSummary.call(e)}).listenTo(this.model,"change:temperature",function(){e._renderTemperature()}).listenTo(this.model,"change:activeWidget",function(){"temperature"===this.model.get("activeWidget")&&this.model.updateTemperature()}).listenTo(this.model,"change:temperatures",function(){this._renderTemperature()}).listenTo(this.model,"change:temperaturesLoading",function(){this.checkLoadingTemperature()})},checkLoadingTemperature:function(){var e=this.model.get("temperaturesLoading");e?this.$el.find(".temperature-panel").addClass("loading"):this.$el.find(".temperature-panel").removeClass("loading")},_onStateLoadedFirstTime:function(){var e=this.model;this._renderAreasSummary(),this._areaNumber&&this._renderOperateArea(),this.listenTo(e,"change:areas change:imei change:canArm",function(){this._renderAreasSummary(),this._areaNumber&&this._renderOperateArea()}),e.get("controlsError")?this._renderControlsError():(this._renderControls(),this.listenTo(e,"change:controls",function(){e.get("controlsError")?(this._controlIndex&&this._closeOperateControl(),this._renderControlsError()):(this._renderControls(),this._controlIndex&&this._renderOperateControl())}))},_toggleStateLoading:function(e){this.$el.find(".areas-state-wrapper").toggleClass("state-loading",e).end().find(".controls").toggleClass("state-loading",e)},_getHeaderOptions:function(){var e=a.prototype._getHeaderOptions.call(this);return t.extend(e,{tracks:!1})},_renderContent:function(e){if(this.$content){e=e===!0;var n=this.model,i=n.get("showTemperature"),s=this._getTexts(),a=i?this.controller.getUserData("activeWidget")||"guard":"guard",o=n.get("controls")||[],r=t.extend({},n.attributes,{i18n:s,prerender:e,addressStr:this.getAddress(),hiddenProps:this.controller.getHiddenProperties(),activeWidget:a,hasControls:o.length>0});this.$el.addClass("obj-info-compact"),e||(this.$content.html(l(r)),this._renderConnections(),this._initLbs()),"temperature"===a&&(this.model.updateTemperature(),this._renderTemperature()),D.renderSummary.call(this),this._toggleStateLoading(this.controller.get("stateLoading")),this._renderAreasSummary(),this._renderControls(),this._initWidgets()}},_renderConnections:function(){var e=this.model,t=e.get("isOnline"),n=this._lbsShown,i=this._lbsLoading,s=App.allowed("objects.shell"),a=t&&s;this.$el.find(".connections").html(h({isOnline:t,lbsShown:n,lbsLoading:i,isShellAllowed:s,hasLbsData:a,lastGSMConnectionTimeS:this._formatConnectionTime(),i18n:this._getTexts()}))},_renderFooter:function(){var e=this.controller.get("parent").getMapsModule();this.$el.find(".extra-actions").html(d({i18n:k,routingModule:e&&e.modules.routing||null}))},_renderAreasSummary:function(){var e=this.model.get("areas"),t="",n=this.$el.find(".areas-state-wrapper").removeClass("loading");return e.length?(t=this._renderAreas(),n.html(t),void 0):(t='<p class="no-areas">'+k.noObjAreas+"</p>",void 0)},_renderTemperature:function(){var t=this,n=this.model.get("temperatures"),i=n?n.length<M:!0,s="",a=this.$el.find(".widget-temperature");s=c({hiddenCtrl:i,i18n:k}),a.html(s),a.off("click",".temperature-ctrl-top").off("click",".temperature-ctrl-arrow"),a.on("click",".temperature-ctrl-top",function(e){e.stopPropagation();var n=e.target.dataset&&e.target.dataset.index;n&&(t.model.set("temparatureActiveIndex",+n),t.rerenderT())}).on("click",".temperature-ctrl-arrow",function(n){n.stopPropagation();var i=e(n.target).closest(".temperature-ctrl-arrow"),s=i.data("arrow");if(s){var a=t.model.get("temperatures"),o=t.model.get("temparatureActiveIndex"),r="left"===s?o-1:o+1;0>r&&(r=a.length-1),r>a.length-1&&(r=0),t.model.set("temparatureActiveIndex",+r),t.rerenderT()}}),this.checkLoadingTemperature(),this.rerenderT()},rerenderT:function(){var e=k,t=this.model.get("temperatures"),n=this.model.get("temperature"),i=this.model.get("temparatureActiveIndex"),s=t?t.length>0:!1,a=this.$el.find(".temperature-panel-value"),o=s?null===t[i].value?e.noData:t[i].value:null===n?e.noData:n;a.html(o);var r=this.$el.find(".temperature-panel-name"),l=s?t[i].name:e.temperature;r.html(l);var c=this.$el.find(".temperature-ctrl-top");c.html(this.getHtmlTemperatureCtrlTop());var d="";o>=x?d="temperature-panel-red":o>C&&(d="temperature-panel-green"),o===e.noData&&(d+=" temperature-panel-value_no-data");var u=this.$el.find(".temperature-panel");u.removeClass("temperature-panel-red"),u.removeClass("temperature-panel-green"),u.removeClass("temperature-panel-value_no-data"),u.addClass(d);var h=this.$el.find(".widgets-nav-item-temperature");h.removeClass("nav-temperature-panel-red"),h.removeClass("nav-temperature-panel-green"),h.addClass("nav-"+d)},getHtmlTemperatureCtrlTop:function(){var e=this.model.get("temperatures"),n=this.model.get("temparatureActiveIndex");return t.map(e,function(e,t){var i=t===n?"ctrl-circle_active":"";return'<div class="ctrl-circle '+i+'"'+' data-index="'+t+'"'+" ></div>"})},_renderAreas:function(e){e=e||this.model.get("areas").slice(0);var t=this.model.isOperatable();return e=this._setAreasTmplData(e),f({operatable:t,areas:e,stateLoadingTxt:this.controller.getTexts().objectStateScan})},_renderControls:function(){var e=this.model.get("controls"),t=this._controlIndex,n=this.$el.find(".controls"),i=e.length,s={i18n:k,controlAllowed:App.allowed("control")};i&&n.length?(s.controls=e,n.html(g(s))):i||n.remove(),t&&this._renderOperateControl()},_renderControlsError:function(){var e=this.$el.find(".controls");e.html('<p class="error">'+this._getTexts().errorDeviceOutsState+"</p>")},_initOperate:function(){var t=this,n="click"+this._getEventsNS();this.$el.on(n,"[data-page=guard]",function(n){return n.stopPropagation(),t._stateLoaded&&(t._areaNumber=e(this).data("index"),t._renderOperateArea()),!1}).on(n,"[data-page=control]",function(n){return n.stopPropagation(),t._stateLoaded&&(t._controlIndex=e(this).data("index"),t._renderOperateControl()),!1}).on(n,"[data-page=connections]",function(e){return e.stopPropagation(),t._initPageConnections.call(t),!1}).on(n,"[data-key=guard] .back",function(){return t._areaNumber=null,!1}).on(n,".guard-actions [data-guard]",function(){return t._toggleGuard(e(this).data("area"),e(this).data("guard")),!1}).on(n,".control-actions [data-command]",function(){return t._sendOperate(e(this).data("num"),e(this).data("command")),!1})},_renderOperateArea:function(){var e,t=this.$el.find(".content[data-key=guard]");if(e=this.model.getArea(this._areaNumber)){var n="",i=e.hasFault&&App.allowed("objects.clearfaults"),s=!1;e.num>0?(n=e.isGuarded?"lock":"unlock",s=this.model.isOperatable()):n="wrench",t.html(v({i18n:k,area:e,icon:n,prevPage:"summary",faults:i,canArm:s}))}else this._closeOperateArea()},_initPageConnections:function(){var e=this;this._channels=null,this.$el.addClass("loading"),e._renderPageConnections(),this.model.loadChannels().done(function(){e._renderPageConnections.call(e)}).fail(function(t){var n=e._getTexts();e.showErrors(t,n.errorCommandSending)}).always(function(){e.$el.removeClass("loading")})},getChannelIcon:function(e){return e?"LAN"===e.type?e.connected?"etehrnetok":"etehrnetbad":"WIFI"===e.type?"wifi"+e.level||0:0===e.inserted?"nosim":"gsm"+e.level||0:""},getChannelText:function(e,t){return e&&t?"LAN"===e.type?e.connected?t.notificationSwitchedOn.toLowerCase():t.notificationSwitchedOff.toLowerCase():e.percent?e.percent+"%":t.noNetwork.toLowerCase():""},_renderPageConnections:function(){var e=this,n=this.$el.find(".content[data-key=connections]"),i=e._getTexts(),s=[],a=e.model.get("channels"),o={SIM_1:"SIM 1",SIM_2:"SIM 2",LAN:"Ethernet",WIFI:"WI-FI"};Array.isArray(a&&a.channels)&&t.each(a.channels,function(t){var n=a[t];n&&(Object.assign(n,{name:o[t]||t,type:t,isActive:a.activeChannel===t}),s.push(Object.assign({},n,{icon:e.getChannelIcon(n),text:e.getChannelText(n,i)})))}),n.html(A({i18n:k,channels:s,tmplRow:T}))},_getLbsData:function(){var t=new e.Deferred;return e.ajax({url:App.getBaseUrl()+"lbs/stat/",data:{objectId:this.model.id}}).done(function(e){var n=e.error,i=e.position,s=null;(n||!i)&&(n||(n="Unknown restapi/lbs/stat/ response format. Attribute is absent"),t.reject(n)),i&&(s={center:[i.latitude,i.longitude],radius:i.precision},t.resolve(s))}.bind(this)).fail(function(e){t.reject(e)}),t},_renderOperateControl:function(){if(this._controlIndex){var e=this.model.get("controls"),t=this.$el.find(".content[data-key=control]"),n=e.find(function(e){return e.num===this._controlIndex}.bind(this));n?t.html(_({i18n:k,control:n})):this._closeOperateControl()}},_closeOperateControl:function(){return S._closeOperate.call(this)},_closeOperateArea:function(){this._areaNumber=null,this.setActivePage("summary")},_toggleGuard:function(e,t){var n=this;this.$el.addClass("loading"),"boolean"!=typeof t&&(t=t>0),this.model.toggleGuard(e,t).done(function(){n._onToggleGuardSuccess()}).fail(function(e){var t=n._getTexts();e===n.model.ERR_NO_AREA?e=t.areaDoesNotExist:e===n.model.ERR_AREA_UNAUTHORIZED&&(e=t.haveNoPermissionToControlArea),n.showErrors(e,k.errorCommandSending)}).always(function(){n.$el.removeClass("loading")})},_onToggleGuardSuccess:function(e){var t=this,n=this._getTexts(),i=this.$el.find(".guard-operate-content");e=e!==!1,i.addClass("command-complete success").find(".operate-state .state-wrap").html(y).end().find(".operate-actions").html('<p class="command-msg">'+n.commandSent+"</p>"),setTimeout(function(){t.model.isOnline()&&e&&t._restartStateUpdate({showStateLoading:!0}),t._closeOperateArea()},1e3)},_initFaults:function(){var n=this,i="click"+this._getEventsNS();this.$el.on(i,"[data-page=faults]",function(i){var s=e(this);i.stopPropagation(),n.$el.addClass("loading");var a=s.data("area"),o=n.model.getArea(a);return n._areaNum=a,n.model.set("faults",null),n.model.loadFaults().done(function(e){var i=t.filter(e,function(e){return e.areaNum==n._areaNum}),s=n.controller.getTexts();if(i.length){var a=n.$el.find(".content[data-key=faults]");n.model.set("faults",i),a.html(b({area:o,faults:i,i18n:s,prevPage:"guard"}))}else n.model.set("faults",null),n._areaNum=null,n.setActivePage("guard")}).always(function(){n.$el.removeClass("loading")}),!1}).on(i,"[data-key=faults] .back",function(){return n.model.set("faults",null),n._areaNum=null,!1}).on(i,".resolve-fault",function(){return n._resolveFaults.call(n,{code:e(this).data("code"),zone:e(this).data("zone")}),!1})},_resolveFaults:function(e){var t=this;this.$el.addClass("loading"),this.model.resolveFaults(e).done(function(){t.$el.find("[data-code]").filter("[data-code="+e.code+"]").filter("[data-zone="+e.zone+"]").closest(".fault").remove(),t.model.get("faults")||(t.model.setAreaState(t._areaNum,{hasFault:!1}),t.setActivePage(t.model.isAreaOperatable(t.model.getArea(t._areaNum))?"guard":"summary"),t._areaNum=null)}).fail(function(e){t.showErrors(e)}).always(function(){t.$el.removeClass("loading")})},_setAreasTmplData:function(e){var n=this,i="",s="",a=[],o="";return t.each(e,function(e){s="unlock",i="notGuarded",a=[],0==e.num?e.hasAlarm?s="warning":e.hasFault&&(s="wrench"):e.isGuarded&&(s="lock"),e.hasAlarm?i="hasAlarm":e.hasFault?i="hasFault":e.isGuarded&&(i="isGuarded"),e.hasAlarm||e.hasFault?(e.hasAlarm&&a.push(k.alarm),e.hasFault&&a.push(k.hasFault.toLowerCase())):a.push(k.objAreaStateNorm),o=0==e.num?k.zeroAreaName:"undefined"!=typeof e.name&&e.name?t.escape(e.name):k.objArea+" "+e.num,e.icon=s,e.name=o,e.mainState=i,e.stateLabel=a.join(", ").ucFirst(),e.operatable=n.model.isAreaOperatable(e)}),e},_getTexts:function(){return k}}),D={initAreas:function(){var t=this;this.$el.on("click",".multi[data-state]",function(){var n={},i=e(this).data("state");"notGuarded"==i?n.isGuarded=!1:n[i]=!0,t._areasConditions=n,D.showAreas.call(t)}).on("click",".show-areas",function(){t._areasConditions={},D.showAreas.call(t)})},renderSummary:function(){var e=this,t=e.$el.find(".widget-guard"),n=e.$el.find(".widgets-nav-item[data-value=guard]"),i=this.model,s="",a="",o=this.model.get("isGuarded"),r=App.getLocale().indexOf("ru")>=0;i.get("hasAlarm")?(s=k.alarm.ucFirst()+"!",a="hasAlarm"):i.get("hasFault")?(s=k.attention+" "+k.hasFault.toLowerCase()+"!",a="hasFault"):1===o?(s=k.object.ucFirst()+' <span class="'+(r?"nobr":"")+'">'+k.guarded.toLowerCase()+"</span>",a="isGuarded"):2===o?(s=k.object.ucFirst()+"&nbsp;"+k.guardedPartly.toLowerCase(),a="isGuarded"):(s=k.object.ucFirst()+' <span class="'+(r?"nobr":"")+'">'+k.notGuarded.toLowerCase()+"</span>",a="notGuarded"),n.html(w).attr("data-guarded",o).attr("data-state",a),t.html(u({objTitle:s,svgIcon:w})).attr("data-guarded",o).attr("data-state",a)},renderAreasList:function(){var e=this._areasConditions,n="hasFault"in e||"hasAlarm"in e||!t.keys(e).length?this.model.getAreasWhere(e):this.model.getNotZeroAreas(e);if(!n.length||!e)return this._areasConditions=null,this.setActivePage("summary"),void 0;var i="";t.keys(e).length?"undefined"!=typeof e.hasAlarm?i=e.hasAlarm?k.alarmAreas:k.notAlarmAreas:"undefined"!=typeof e.hasFault?i=e.hasFault?k.faultAreas:k.noFaultAreas:"undefined"!=typeof e.isGuarded&&(i=e.isGuarded?k.guardedAreas:k.notGuardedAreas):i=k.objAreas,this.$el.find("[data-key=areas]").html(p({i18n:k,title:i+" ("+n.length+")",areasHtml:this._renderAreas(n),operatable:this.model.isOperatable()}))}};return I}),define("text!_common/alerts/deviceState/tmpl/deviceStateStat.html",[],function(){return'<div class="contents">\n    <div data-key="summary" class="content active">\n\n        <ul class="indicators">\n            <li class="indicator indicator-obj-status" data-state="<%= objStatus !== null ? objStatus : 0 %>">\n                <svg class="svg-icon">\n                    <use xlink:href="#smb-power"></use>\n                </svg>\n                <%= i18n.objStatus %>:\n                <% if(App.allowed(\'objects.status.edit\')) {%>\n                <a href="#" class="obj-status" data-page="status">\n                    <%= objStatus !== null ? i18n.objStatuses[objStatus] : \'\' %>\n                </a>\n                <% } else { %>\n                <strong class="obj-status"><%= objStatus !== null ? i18n.objStatuses[objStatus] : \'\' %></strong>\n                <% } %>\n                <span class="technician"></span>\n            </li>\n            <li class="indicator nobr isOnline" data-state="<%= isOnline ? 1 : 0 %>">\n                <svg class="svg-icon">\n                    <use xlink:href="#smb-connection"></use>\n                </svg>\n                <%= i18n.GSMConnection %>:\n                <strong class="lastGSMConnectionTime nobr"><%= lastGSMConnectionTimeS %></strong>\n                <a href="#" class="call-device<% if(!allowStateScan) {%> hidden<% } %>"><%= i18n.objectStateScan %></a>\n                <span class="calling-device hidden"><%= i18n.stateScanProcessing %> <i class="svg-icon svg-icon-spinner icon-spin"></i></span>\n            </li>\n        </ul>\n\n        <div class="grid-container areas selectable">AREAS CONT</div>\n        <p class="no-areas hidden"><%= i18n.noObjAreas %></p>\n        <p class="state-loading hidden"><i class="svg-icon svg-icon-spinner icon-spin"></i> <%= i18n.objAreasStateLoading %></p>\n\n    </div>\n\n    <div data-key="status" class="content"></div>\n    <div data-key="guard" class="content"></div>\n    <div data-key="faults" class="content"></div>\n\n</div>\n\n'}),define("text!_common/alerts/deviceState/tmpl/areas.html",[],function(){return'<div class="grid-header">\n    <%= i18n.objAreas %>\n</div>\n<div class="grid-viewport">\n    <div class="grid-content">\n        <table class="areas-list">\n            <colgroup>\n                <col class="col-expand">\n                <col class="col-num" style="width:50px">\n                <col class="col-name">\n                <col class="col-state col-guard" style="width:<%= operatable ? \'170\' : \'80\' %>px">\n                <col class="col-state" style="width:60px">\n                <col class="col-state" style="width:15%">\n            </colgroup>\n            <% _.each(areas, function(area){ if(area.num == 0 && !area.hasAlarm && !area.hasFault) return; %>\n            <tr class="area<% if(area.hasAlarm) {%> alarm-on<% } %>\n            <% if(area.hasAlarm || area.hasFault || \'undefined\' != typeof openedAreas[area.id]) {%> opened<% } %>\n            <% if(area.hasFault) {%> fault-on<% } %>\n            <% if(area.isGuarded) {%> guard-on<% } %>\n            <% if(\'undefined\' != typeof area.zones && area.zones.length) {%>expandable<% } %>\n            <% if(area.num == 0) {%>zero<% } %>"\n                data-id="<%= area.id %>">\n                <td class="col-expand">\n                    <i class="caret"></i>\n                </td>\n                <td>\n                    <%= area.num == 0 ? i18n.zeroAreaName : i18n.objArea + \' \' + area.num %>\n                </td>\n                <td>\n                    <%- area.name && area.name != i18n.objArea + \' \' + area.num ? area.name : \'\' %>\n                </td>\n                <td class="state-guard">\n                    <!--<i class="icon-state icon-state-guard"></i>-->\n                    <% if(area.num > 0) {%>\n                    <%= area.isGuarded ? i18n.guarded : i18n.notGuarded %>\n                        <% if(area.operatable) {%>\n                        <a href="#" class="operate"\n                           data-page="guard"\n                           data-index="<%= area.num %>"><%= area.isGuarded ? i18n.makeNotGuarded : i18n.makeGuarded %></a>\n                        <% } %>\n                    <% } %>\n                </td>\n                <td class="state-alarm">\n                    <!--<i class="icon-state icon-state-alarm"></i>-->\n                    <% if(area.hasAlarm) { print(i18n.alarm.ucFirst()) } %>\n                </td>\n                <td class="state-fault">\n                    <!--<i class="icon-state icon-state-fault"></i>-->\n                    <% if(area.hasFault) {%>\n                        <%= i18n.hasFault %>\n                    <% } %>\n                </td>\n            </tr>\n            <% if(\'undefined\' != typeof area.zones && area.zones.length) {%>\n                <% _.each(area.zones, function(zone){%>\n                <tr class="zone<% if(zone.hasAlarm) {%> alarm-on<% } %><% if(zone.hasFault) {%> fault-on<% } %>\n                    <% if(!area.hasAlarm && !area.hasFault && \'undefined\' == typeof openedAreas[area.id]) {%> hidden<% } %>"\n                    data-id="<%= zone.id %>" data-areaid="<%= area.id %>">\n                    <td></td>\n                    <td>\n                        <%= i18n.objZone + \' \' + zone.num %>\n                    </td>\n                    <td>\n                        <%- zone.name && zone.name != i18n.objArea + \' \' + zone.num ? zone.name : \'\' %>\n                    </td>\n                    <td></td>\n                    <td class="state-alarm">\n                        <!--<i class="icon-state icon-state-alarm"></i>-->\n                        <% if(zone.hasAlarm) { print(i18n.objZoneStateViolated) } else { print(i18n.objZoneStateNorm) } %>\n                    </td>\n                    <td class="state-fault">\n                        <!--<i class="icon-state icon-state-fault"></i>-->\n                        <% if(zone.hasFault) {%>\n                            <%= i18n.hasFault %>\n                            <% if(App.allowed(\'objects.clearfaults\')) {%>\n                            <a href="#" class="operate"\n                               data-page="faults"\n                               data-area="<%= area.id %>"\n                               data-zone="<%= zone.id %>"><%= i18n.resolveFault %></a>\n                            <% } %>\n                        <% } %>\n                    </td>\n                </tr>\n                <% }) %>\n            <% } %>\n            <% }) %>\n        </table>\n    </div>\n</div>\n\n\n\n'}),define("text!_common/alerts/deviceState/tmpl/operateArea.html",[],function(){return'<div class="subheader">\n    <a data-target="summary" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%- area.name || i18n.objArea + \' \' + area.num %></h5>\n</div>\n<div class="operate-content guard-operate-content">\n    <div class="operate-state <%= area.hasAlarm ? \'alarm\' : ( area.hasFault ? \'fault\' : ( \'guard \' + ( area.isGuarded ? \'on\' : \'off\' ) ) ) %>">\n        <div class="state-wrap">\n            <svg class="svg-icon">\n                <use xlink:href="#smb-<%= icon %>"></use>\n            </svg>\n        </div>\n    </div>\n    <div class="operate-actions guard-actions">\n        <% if(area.num > 0 && canArm) {%>\n        <button class="btn btn-block <%= area.isGuarded ? \' btn-success\' : \' btn-primary\' %>"\n                data-area="<%= area.num %>"\n                data-guard="<%= area.isGuarded ? \'0\' : \'1\' %>">\n            <%= i18n[area.isGuarded ? \'makeNotGuarded\' : \'makeGuarded\'] %>\n        </button>\n        <% } %>\n    </div>\n    <div class="command-result"></div>\n</div>\n'}),define("text!_common/alerts/deviceState/tmpl/faults.html",[],function(){return'<div class="subheader">\n    <a data-target="<%= prevPage %>" class="back" href="#">\n        <i class="svg-icon svg-icon-chevron-circle-left"></i>\n    </a>\n    <h5><%- zone.name || i18n.objZone + \' \' + zone.num %>. <%= i18n.faultsList %></h5>\n</div>\n<div class="faults-content">\n    <table class="faults-table selectable">\n        <% _.each( faults, function(fault){%>\n        <tr class="fault">\n            <td class="fault-text"><%- fault.messageText %></td>\n            <td class="fault-action">\n                <a href="#" data-code="<%= fault.faultCode %>"\n                    data-zone="<%= fault.areaZoneId %>"\n                    class="resolve-fault" title=""><%= i18n.resolveFault %></a>\n            </td>\n        </tr>\n        <% }) %>\n    </table>\n</div>\n'}),define("text!_common/alerts/deviceState/tmpl/callResult.html",[],function(){return"<h4 class=\"obj-title selectable\">#<%= extId %> <%- objTitle %></h4>\n<% if(areas && areas.length) {%>\n<ul class=\"areas-list selectable\">\n    <% _.each(areas, function(a){ %>\n    <li class=\"area-item\">\n        <h5 class=\"area-state\">\n            <strong><%- a.name ? a.name + ' ('+a.num+')' : i18n.objArea + ' ' + a.num %></strong> - <%= a.stateText %>\n        </h5>\n        <% if(a.zones.length) { %>\n        <ul class=\"zones-list\">\n        <%_.each(a.zones, function(z){ %>\n            <li class=\"zone-item\">\n                <strong><%- z.name ? z.name + ' ('+z.num+')' : i18n.objZone + ' ' + z.num %></strong> - <%= z.stateText %>\n            </li>\n        <% }) %>\n        </ul>\n        <% } %>\n    </li>\n    <% }) %>\n</ul>\n<% } else { %>\n    <%= i18n.noAreasData %>\n<% } %>"
}),define("_common/alerts/deviceState/views/StatStateView",["jquery","underscore","jface","./DeviceStateView","_common/stat/watched/views/StatInfoView","text!../tmpl/deviceStateStat.html","text!../tmpl/areas.html","text!../tmpl/operateArea.html","text!../tmpl/faults.html","text!../tmpl/callResult.html"],function(e,t,n,i,s,a,o,r,l,c){var d=i.prototype;a=t.template(a),o=t.template(o),r=t.template(r),l=t.template(l),c=t.template(c);var u=i.extend({constructor:function(){this._openedAreas={},this.$noAreas=null,this.$areas=null,this._zoneId=null,this._scanUpdateTmt=null,this._scanUpdateXhr=null,this._popup=null,i.apply(this,arguments)},initialize:function(){this.controller.getTexts(),this._areasConditions={hasAlarm:!0},d.initialize.apply(this,arguments)},render:function(){var e=this.model,n=t.extend({},e.attributes,{i18n:this.controller.getTexts(),lastGSMConnectionTimeS:this._formatConnectionTime(),allowStateScan:App.isCsdScanAllowed()||e.get("isOnline")});this.$el.addClass("obj-info-stat").html(a(n)),this.model.has("tech")&&this._renderTechnician(),this.$noAreas=this.$el.find(".no-areas"),this.$areas=this.$el.find(".areas"),this._afterRender()},remove:function(){this.closePopup(),this._stopUpdate(),d.remove.apply(this,arguments)},closePopup:function(){this._popup&&(this._popup.trigger("jw.close"),this.controller.get("parent").get("visible")||n.hideOverlay())},_bindEvents:function(){d._bindEvents.call(this),h.initAreas.call(this),this._initOperate(),this._initFaults(),this._initCalling()},_bindDeviceEvents:function(){var e=this,t=this.model;i.prototype._bindDeviceEvents.apply(this,arguments),this.listenTo(e.model,"change:lastGSMConnectionTime change:isOnline",function(){e.$el.find(".lastGSMConnectionTime").text(e._formatConnectionTime()),t.hasChanged("isOnline")&&e._setIndicatorState(e.$el.find(".isOnline"),t.get("isOnline"))}).listenTo(t,"change:callId",function(t,n){e._showCallingState(n>0),null!==n?e._scanUpdateTmt=setTimeout(function(){e._scanUpdateTmt=null,e._update()},5e3):e._stopUpdate()}),App.isCsdScanAllowed()||this.listenTo(t,"change:isOnline",function(t,n){e.$el.find(".call-device")[n?"removeClass":"addClass"]("hidden")})},_renderAreas:function(){var e=this.model.get("areas"),t=this.$el.find(".areas"),n=this.$noAreas,i=-1==n[0].className.indexOf("hidden"),s=-1==t[0].className.indexOf("hidden"),a=e.length,r=0;if(a>0)for(;a--;)e[a].operatable&&r++;var l=o({i18n:this.controller.getTexts(),areas:e,operatable:r>0,openedAreas:this._openedAreas});e.length&&!s?(n.addClass("hidden"),t.removeClass("hidden")):e.length||i||(n.removeClass("hidden"),t.addClass("hidden")),t.html(l)},_initFaults:function(){var n=this,i="click"+this._getEventsNS();this.$el.on(i,"[data-page=faults]",function(i){var s=e(this);i.stopPropagation(),n.$el.addClass("loading"),n._zoneId=s.data("zone");var a=s.data("area"),o=t.findWhere(n.model.get("areas"),{id:a}),r=t.findWhere(o.zones,{id:n._zoneId});return n.model.set("faults",null),n.model.loadFaults().done(function(e){var i=t.filter(e,function(e){return e.areaZoneId==n._zoneId}),s=n.controller.getTexts();if(i.length){var a=n.$el.find(".content[data-key=faults]");n.model.set("faults",i),a.html(l({zone:r,faults:i,i18n:s,prevPage:"summary"}))}else n.model.set("faults",null),n._zoneId=null,n.setActivePage("summary")}).always(function(){n.$el.removeClass("loading")}),!1}).on(i,"[data-key=faults] .back",function(){return n.model.set("faults",null),n._zoneId=null,!1}).on(i,".resolve-fault",function(){return h.resolveFaults.call(n,{code:e(this).data("code"),zone:e(this).data("zone")}),!1})},_initCalling:function(){var e=this;e.model.get("callId")&&(this._showCallingState(!0),e._update()),this.$el.on("click",".call-device",function(){return e.$el.addClass("loading"),e.model.callDevice().done(function(t){1==t.scanState?e.model.set("callId",t.scanId):e._showCallResult(t)}).fail(function(t){e.showErrors(t)}).always(function(){e.$el.removeClass("loading")}),!1})},_showCallingState:function(e){this.$el.find(".call-device")[e?"addClass":"removeClass"]("hidden"),this.$el.find(".calling-device")[e?"removeClass":"addClass"]("hidden")},_showCallResult:function(e){var i=this,s=this.controller.get("device"),a=this.controller.getTexts(),o="",r=a.error;switch(e.scanState){case 0:o=a.objectStateScanIdNotFound;break;case 2:o=a.objectStateScanFailed;break;case 3:}if("validImei"in e&&!e.validImei&&(o=a.objectStateInvalidImei.replace("##")),o)return alert(o,r),void 0;this.controller.get("parent").get("visible")||n.showOverlay();try{n.window.getById("device-call-result").trigger("jw.close")}catch(l){}var d,u,h,m,p=e.partitions,f="",g=a.deviceAreaStates,v=a.deviceZoneStates,_=a.objAreaStateNorm.toLowerCase(),b=a.objZoneStateNorm.toLowerCase();t.each(p,function(e){if(f=[e.arm?'<strong data-guard="1">'+a.guarded.toLowerCase()+"</strong>":'<strong data-guard="0">'+a.notGuarded.toLowerCase()+"</strong>"],d=e.states,d.length)for(u=0,h=d.length;h>u;++u)m=d[u],m in g&&f.push('<strong data-state="'+m+'">'+g[m]+"</strong>");else f.push('<strong data-state="0">'+_+"</strong>");e.stateText=f.join(", "),e.zones&&e.zones.length&&t.each(e.zones,function(e){if(d=e.states,d.length)for(f=[],u=0,h=d.length;h>u;++u)m=d[u],m in v&&f.push('<span data-state="'+m+'">'+v[m]+"</span>");else f=['<span data-state="0">'+b+"</span>"];e.stateText=f.join(", ")})}),n.window.open({addClass:"device-call-result",winId:"device-call-result",headerHtml:a.objectStateScanResult,contentHtml:c({i18n:a,areas:p,extId:s.get("extId"),objTitle:App.buildObjTitle(s)}),width:450,resizable:!1,centered:!0,dieAfter:0,openCallback:function(){i._popup=this},closeCallback:function(){i.closePopup()}})},_update:function(){var t=this;this._scanUpdateTmt||this._scanUpdateXhr||!this.model.get("callId")||(this._scanUpdateXhr=e.ajax({url:App.getBaseUrl()+"objects/obj-scan/",data:{objectId:this.model.id,scanId:this.model.get("callId")},error:function(e){t.showErrors(e),t._stopUpdate(),t.model.set("callId",null)},success:function(e){1==e.scanState?(t._scanUpdateXhr=null,t._scanUpdateTmt=setTimeout(function(){t._scanUpdateTmt=null,t._update()},1e4)):(t._showCallResult(e),t._showCallingState(!1),t.model.set("callId",null))}}))},_stopUpdate:function(){this._scanUpdateXhr&&this._scanUpdateXhr.abort()&&(this._scanUpdateXhr=null),this._scanUpdateTmt&&clearTimeout(this._scanUpdateTmt)},_renderOperateArea:function(){var e,t=this.$el.find(".content[data-key=guard]");if(e=this.model.getArea(this._areaNumber)){var n=e.isGuarded?"lock":"unlock",i=this.model.isAreaCanBeArmedOrDisarmed(e);t.html(r({i18n:this.controller.getTexts(),area:e,icon:n,canArm:i}))}else this._closeOperateArea()},_closeOperateArea:function(){this._areaNumber=null,this.setActivePage("summary")},_toggleStateLoading:function(e){if(d._toggleStateLoading.call(this,e),e)this.$noAreas.add(this.$areas).addClass("hidden");else{var t=this.model.get("areas");t.length?this.$areas.removeClass("hidden"):this.$noAreas.removeClass("hidden")}},_onStateLoadedFirstTime:function(){this._renderAreas(),this.listenTo(this.model,"change:areas change:imei change:canArm",function(){this._renderAreas()})}});t.each(["_initOperate","_toggleGuard","_onToggleGuardSuccess","_getTexts"],function(e){!function(e){u.prototype[e]=function(){return s.prototype[e].apply(this,arguments)}}(e)});var h={initAreas:function(){var t=this;this.$el.on("click",".area",function(){var n=e(this),i=n.data("id"),s=t.$el.find(".areas"),a=-1!=this.className.indexOf("opened");n[a?"removeClass":"addClass"]("opened"),s.find("tr[data-areaid="+i+"]")[a?"addClass":"removeClass"]("hidden"),a?delete t._openedAreas[i]:t._openedAreas[i]=1})},resolveFaults:function(e){var t=this;this.$el.addClass("loading"),this.model.resolveFaults(e).done(function(){t.$el.find("[data-code]").filter("[data-code="+e.code+"]").filter("[data-zone="+e.zone+"]").closest(".fault").remove(),t.model.get("faults")||(t._zoneId=null,t.controller.reload(),setTimeout(function(){t.setActivePage("summary")},30))}).fail(function(e){t.showErrors(e)}).always(function(){t.$el.removeClass("loading")})}};return u}),define("_common/alerts/deviceState/DeviceStateController",["jquery","underscore","abstracts/Module","_common/mobile/MobileDetails","_common/stat/StatDetails","./views/MobileStateView","./views/StatStateView"],function(e,t,n,i,s,a,o){var r=n.extend({constructor:function(){this._updateTimeout=null,n.apply(this,arguments)},defaults:{stateLoading:!0,active:!0,parent:null,container:null,device:null,updatePeriod:7e3},initialize:function(){var e=this.get("device"),t=a;e.get("objType")==App.TYPE_STAT&&(t=o),this._view=new t({model:e,controller:this,el:this.get("container")}),this.reload()},reload:function(){var e=this,n=this.get("device"),i="controls";n.get("objType")==App.TYPE_STAT&&(i="areas"),this._updateTimeout&&clearTimeout(this._updateTimeout),n.abortLoadState(),this.set("stateLoading",!0),n.loadState().done(function(){var s=n.get(i);t.keys(s).length&&e._setUpdateTimeout()}).always(function(){e.set("stateLoading",!1)})},destroy:function(){this._view&&this._view.remove(),this._updateTimeout&&clearTimeout(this._updateTimeout),this.get("device").abortLoadState()},getTexts:function(){return this.get("parent").getTexts()},_setUpdateTimeout:function(){var e=this;this._updateTimeout=setTimeout(function(){e._update()},this.get("updatePeriod"))},_update:function(){var e=this;return this.get("active")&&this.get("parent").autoUpdateNeeded()?this.get("device").loadState().done(function(){e._setUpdateTimeout()}):(this._setUpdateTimeout(),void 0)}});return r}),define("_common/tracks/TrackParkPoint",["underscore","util","geo"],function(e,t,n){var i=function(e){n.Point.call(this,e),this.geoId=e.geoId||0,this.address=e.address||"",this.start=new Date(1e3*e.start),this.end=new Date(1e3*e.end)};return t.extend(i,n.Point),i}),define("text!_common/tracks/tmpl/track.gpx",[],function(){return'<?xml version="1.0" encoding="UTF-8"?>\n<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.0"\nxmlns="http://www.topografix.com/GPX/1/0" creator="glebpl"\nxsi:schemaLocation="http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd">\n  <time>2011-09-22T18:56:51Z</time>\n  <trk>\n    <name>test track</name>\n    <trkseg>\n      <% _.each(points, function(point){%>\n      <trkpt lat="<%= point.lat %>" lon="<%= point.lon %>">\n        <time><% print(Date.format(dateFormat, point.date * App.MS)) %>Z</time>\n      </trkpt>\n      <% })%>\n    </trkseg>\n  </trk>\n</gpx>'}),define("_common/tracks/Track",["underscore","moment","abstracts/Model","geo","_common/tracks/TrackParkPoint","text!_common/tracks/tmpl/track.gpx"],function(e,t,n,i,s,a){t.locale(App.getLocale().substr(0,2));var o=n.extend({constructor:function(){this._indexed=!1,this._minLat=90,this._minLon=180,this._maxLat=-90,this._maxLon=-180,this._listView=null,n.apply(this,arguments)},url:function(){return App.getBaseUrl()+"reports/ROUTE/"},defaults:{name:"Track",objectId:null,startTime:0,endTime:0,points:[],parks:[],color:"#ff0000",hidden:!1,start:null,startFromPark:!1,finish:null,finishOnPark:!1},parse:function(e){var t={},n=this.get("objectId"),i=e.body[n];if(t.points=i.route||null,t.parks=null,i.parks&&i.parks.length){t.parks=[];for(var a=0,o=i.parks.length;o>a;a++)t.parks.push(new s(i.parks[a]))}return t.startTime=1e3*e.header.sd,t.endTime=1e3*e.header.ed,t},initialize:function(){var e=this;this.on("sync",function(){r.index.call(e)})},hasData:function(){var e,t;return(t=this.get("points"))&&t.length||(e=this.get("parks"))&&e.length},clear:function(){this._view&&this._view.clear()},getBounds:function(){if(!this.get("points")||!this.get("points").length){if(!this.has("parks")||!this.get("parks").length)return null;var e=this.get("parks")[0];return{maxLat:e.lat,minLon:e.lon,minLat:e.lat,maxLon:e.lon}}return this._indexed||r.index.call(this),{maxLat:this._maxLat,minLon:this._minLon,minLat:this._minLat,maxLon:this._maxLon}},toGPX:function(){var t="Y-m-dTH:i:s",n=e.template(a,{points:this.get("points"),dateFormat:t});return n},getView:function(){return this._view},formatUTC:function(e,n){var i=App.getTimezone({id:this.get("tzId")}),s=t(n).utcOffset(i.offset);return s.format(e,n)},formatDateTime:function(e){return this.formatUTC("DD.MM.YYYY HH:mm:ss",e instanceof Date?e:e*App.MS)},destroy:function(){this.collection&&this.collection.remove(this)}}),r={index:function(){if(!this._indexed){if(r.findStartAndFinish.call(this),this.get("points")&&this.get("points").length)for(var e=0,t=0,n=this.get("points"),i=n.length,s=0;i>s;++s)t=n[s].lon,e=n[s].lat,e>this._maxLat&&(this._maxLat=e),e<this._minLat&&(this._minLat=e),t>this._maxLon&&(this._maxLon=t),t<this._minLon&&(this._minLon=t);else if(this.get("start")&&this.get("start")==this.get("finish")){var a=this.get("start");this._maxLat=this._minLat=a.lat,this._maxLon=this._minLon=a.lon}this._indexed=!0}},findStartAndFinish:function(){var e=this.get("points"),t=this.get("parks"),n=e.length,i=!1,s=!1;if(t&&t.length){if((!e[0]||t[0].start.getTime()<=e[0].date*App.MS)&&(i=!0),(!n||t.length&&t[t.length-1].end.getTime()>=e[n-1].date*App.MS)&&(s=!0),this.set("startFromPark",i),this.set("finishOnPark",s),1==t.length&&i&&s)return this.set("start",t[0]),this.set("finish",t[0]),this.set("points",[]),void 0;i&&this.set("start",t[0]),s&&this.set("finish",t[t.length-1])}!this.get("start")&&this.set("start",e[0]),!this.get("finish")&&this.set("finish",e[n-1])}};return o}),function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("paho-mqtt",t):"object"==typeof exports?exports=t():e.Paho=t()}(this,function(){var e=function(e){function t(e,t){var n=t,i=e[t],a=i>>4,o=i&=15;t+=1;var r,c=0,d=1;do{if(t==e.length)return[null,n];r=e[t++],c+=(127&r)*d,d*=128}while(0!==(128&r));var h=t+c;if(h>e.length)return[null,n];var m=new b(a);switch(a){case u.CONNACK:var p=e[t++];1&p&&(m.sessionPresent=!0),m.returnCode=e[t++];break;case u.PUBLISH:var f=3&o>>1,g=s(e,t);t+=2;var v=l(e,t,g);t+=g,f>0&&(m.messageIdentifier=s(e,t),t+=2);var _=new C(e.subarray(t,h));1==(1&o)&&(_.retained=!0),8==(8&o)&&(_.duplicate=!0),_.qos=f,_.destinationName=v,m.payloadMessage=_;break;case u.PUBACK:case u.PUBREC:case u.PUBREL:case u.PUBCOMP:case u.UNSUBACK:m.messageIdentifier=s(e,t);break;case u.SUBACK:m.messageIdentifier=s(e,t),t+=2,m.returnCode=e.subarray(t,h)}return[m,h]}function n(e,t,n){return t[n++]=e>>8,t[n++]=e%256,n}function i(e,t,i,s){return s=n(t,i,s),r(e,i,s),s+t}function s(e,t){return 256*e[t]+e[t+1]}function a(e){var t=new Array(1),n=0;do{var i=e%128;e>>=7,e>0&&(i|=128),t[n++]=i}while(e>0&&4>n);return t}function o(e){for(var t=0,n=0;n<e.length;n++){var i=e.charCodeAt(n);i>2047?(i>=55296&&56319>=i&&(n++,t++),t+=3):i>127?t+=2:t++}return t}function r(e,t,n){for(var i=n,s=0;s<e.length;s++){var a=e.charCodeAt(s);if(a>=55296&&56319>=a){var o=e.charCodeAt(++s);if(isNaN(o))throw new Error(g(p.MALFORMED_UNICODE,[a,o]));a=(a-55296<<10)+(o-56320)+65536}127>=a?t[i++]=a:2047>=a?(t[i++]=192|31&a>>6,t[i++]=128|63&a):65535>=a?(t[i++]=224|15&a>>12,t[i++]=128|63&a>>6,t[i++]=128|63&a):(t[i++]=240|7&a>>18,t[i++]=128|63&a>>12,t[i++]=128|63&a>>6,t[i++]=128|63&a)}return t}function l(e,t,n){for(var i,s="",a=t;t+n>a;){var o=e[a++];if(128>o)i=o;else{var r=e[a++]-128;if(0>r)throw new Error(g(p.MALFORMED_UTF,[o.toString(16),r.toString(16),""]));if(224>o)i=64*(o-192)+r;else{var l=e[a++]-128;if(0>l)throw new Error(g(p.MALFORMED_UTF,[o.toString(16),r.toString(16),l.toString(16)]));if(240>o)i=4096*(o-224)+64*r+l;else{var c=e[a++]-128;if(0>c)throw new Error(g(p.MALFORMED_UTF,[o.toString(16),r.toString(16),l.toString(16),c.toString(16)]));if(!(248>o))throw new Error(g(p.MALFORMED_UTF,[o.toString(16),r.toString(16),l.toString(16),c.toString(16)]));i=262144*(o-240)+4096*r+64*l+c}}}i>65535&&(i-=65536,s+=String.fromCharCode(55296+(i>>10)),i=56320+(1023&i)),s+=String.fromCharCode(i)}return s}var c="@VERSION@-@BUILDLEVEL@",d=e.localStorage||function(){var e={};return{setItem:function(t,n){e[t]=n},getItem:function(t){return e[t]},removeItem:function(t){delete e[t]}}}(),u={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14},h=function(e,t){for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n)){var i="Unknown property, "+n+". Valid properties are:";for(var s in t)t.hasOwnProperty(s)&&(i=i+" "+s);throw new Error(i)}if(typeof e[n]!==t[n])throw new Error(g(p.INVALID_TYPE,[typeof e[n],n]))}},m=function(e,t){return function(){return e.apply(t,arguments)}},p={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."},BUFFER_FULL:{code:18,text:"AMQJS0018E Message buffer is full, maximum buffer size: {0}."}},f={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"},g=function(e,t){var n=e.text;if(t)for(var i,s,a=0;a<t.length;a++)if(i="{"+a+"}",s=n.indexOf(i),s>0){var o=n.substring(0,s),r=n.substring(s+i.length);n=o+t[a]+r}return n},v=[0,6,77,81,73,115,100,112,3],_=[0,4,77,81,84,84,4],b=function(e,t){this.type=e;for(var n in t)t.hasOwnProperty(n)&&(this[n]=t[n])};b.prototype.encode=function(){var e,t=(15&this.type)<<4,s=0,r=[],l=0;switch(void 0!==this.messageIdentifier&&(s+=2),this.type){case u.CONNECT:switch(this.mqttVersion){case 3:s+=v.length+3;break;case 4:s+=_.length+3}s+=o(this.clientId)+2,void 0!==this.willMessage&&(s+=o(this.willMessage.destinationName)+2,e=this.willMessage.payloadBytes,e instanceof Uint8Array||(e=new Uint8Array(d)),s+=e.byteLength+2),void 0!==this.userName&&(s+=o(this.userName)+2),void 0!==this.password&&(s+=o(this.password)+2);break;case u.SUBSCRIBE:t|=2;for(var c=0;c<this.topics.length;c++)r[c]=o(this.topics[c]),s+=r[c]+2;s+=this.requestedQos.length;break;case u.UNSUBSCRIBE:t|=2;for(var c=0;c<this.topics.length;c++)r[c]=o(this.topics[c]),s+=r[c]+2;break;case u.PUBREL:t|=2;break;case u.PUBLISH:this.payloadMessage.duplicate&&(t|=8),t=t|=this.payloadMessage.qos<<1,this.payloadMessage.retained&&(t|=1),l=o(this.payloadMessage.destinationName),s+=l+2;var d=this.payloadMessage.payloadBytes;s+=d.byteLength,d instanceof ArrayBuffer?d=new Uint8Array(d):d instanceof Uint8Array||(d=new Uint8Array(d.buffer));break;case u.DISCONNECT:}var h=a(s),m=h.length+1,p=new ArrayBuffer(s+m),f=new Uint8Array(p);if(f[0]=t,f.set(h,1),this.type==u.PUBLISH)m=i(this.payloadMessage.destinationName,l,f,m);else if(this.type==u.CONNECT){switch(this.mqttVersion){case 3:f.set(v,m),m+=v.length;break;case 4:f.set(_,m),m+=_.length}var g=0;this.cleanSession&&(g=2),void 0!==this.willMessage&&(g|=4,g|=this.willMessage.qos<<3,this.willMessage.retained&&(g|=32)),void 0!==this.userName&&(g|=128),void 0!==this.password&&(g|=64),f[m++]=g,m=n(this.keepAliveInterval,f,m)}switch(void 0!==this.messageIdentifier&&(m=n(this.messageIdentifier,f,m)),this.type){case u.CONNECT:m=i(this.clientId,o(this.clientId),f,m),void 0!==this.willMessage&&(m=i(this.willMessage.destinationName,o(this.willMessage.destinationName),f,m),m=n(e.byteLength,f,m),f.set(e,m),m+=e.byteLength),void 0!==this.userName&&(m=i(this.userName,o(this.userName),f,m)),void 0!==this.password&&(m=i(this.password,o(this.password),f,m));break;case u.PUBLISH:f.set(d,m);break;case u.SUBSCRIBE:for(var c=0;c<this.topics.length;c++)m=i(this.topics[c],r[c],f,m),f[m++]=this.requestedQos[c];break;case u.UNSUBSCRIBE:for(var c=0;c<this.topics.length;c++)m=i(this.topics[c],r[c],f,m)}return p};var w=function(e,t){this._client=e,this._keepAliveInterval=1e3*t,this.isReset=!1;var n=new b(u.PINGREQ).encode(),i=function(e){return function(){return s.apply(e)}},s=function(){this.isReset?(this.isReset=!1,this._client._trace("Pinger.doPing","send PINGREQ"),this._client.socket.send(n),this.timeout=setTimeout(i(this),this._keepAliveInterval)):(this._client._trace("Pinger.doPing","Timed out"),this._client._disconnected(p.PING_TIMEOUT.code,g(p.PING_TIMEOUT)))};this.reset=function(){this.isReset=!0,clearTimeout(this.timeout),this._keepAliveInterval>0&&(this.timeout=setTimeout(i(this),this._keepAliveInterval))},this.cancel=function(){clearTimeout(this.timeout)}},y=function(e,t,n,i){t||(t=30);var s=function(e,t,n){return function(){return e.apply(t,n)}};this.timeout=setTimeout(s(n,e,i),1e3*t),this.cancel=function(){clearTimeout(this.timeout)}},A=function(t,n,i,s,a){if(!("WebSocket"in e&&null!==e.WebSocket))throw new Error(g(p.UNSUPPORTED,["WebSocket"]));if(!("ArrayBuffer"in e&&null!==e.ArrayBuffer))throw new Error(g(p.UNSUPPORTED,["ArrayBuffer"]));this._trace("Paho.Client",t,n,i,s,a),this.host=n,this.port=i,this.path=s,this.uri=t,this.clientId=a,this._wsuri=null,this._localKey=n+":"+i+("/mqtt"!=s?":"+s:"")+":"+a+":",this._msg_queue=[],this._buffered_msg_queue=[],this._sentMessages={},this._receivedMessages={},this._notify_msg_sent={},this._message_identifier=1,this._sequence=0;for(var o in d)(0===o.indexOf("Sent:"+this._localKey)||0===o.indexOf("Received:"+this._localKey))&&this.restore(o)};A.prototype.host=null,A.prototype.port=null,A.prototype.path=null,A.prototype.uri=null,A.prototype.clientId=null,A.prototype.socket=null,A.prototype.connected=!1,A.prototype.maxMessageIdentifier=65536,A.prototype.connectOptions=null,A.prototype.hostIndex=null,A.prototype.onConnected=null,A.prototype.onConnectionLost=null,A.prototype.onMessageDelivered=null,A.prototype.onMessageArrived=null,A.prototype.traceFunction=null,A.prototype._msg_queue=null,A.prototype._buffered_msg_queue=null,A.prototype._connectTimeout=null,A.prototype.sendPinger=null,A.prototype.receivePinger=null,A.prototype._reconnectInterval=1,A.prototype._reconnecting=!1,A.prototype._reconnectTimeout=null,A.prototype.disconnectedPublishing=!1,A.prototype.disconnectedBufferSize=5e3,A.prototype.receiveBuffer=null,A.prototype._traceBuffer=null,A.prototype._MAX_TRACE_ENTRIES=100,A.prototype.connect=function(e){var t=this._traceMask(e,"password");if(this._trace("Client.connect",t,this.socket,this.connected),this.connected)throw new Error(g(p.INVALID_STATE,["already connected"]));if(this.socket)throw new Error(g(p.INVALID_STATE,["already connected"]));this._reconnecting&&(this._reconnectTimeout.cancel(),this._reconnectTimeout=null,this._reconnecting=!1),this.connectOptions=e,this._reconnectInterval=1,this._reconnecting=!1,e.uris?(this.hostIndex=0,this._doConnect(e.uris[0])):this._doConnect(this.uri)},A.prototype.subscribe=function(e,t){if(this._trace("Client.subscribe",e,t),!this.connected)throw new Error(g(p.INVALID_STATE,["not connected"]));var n=new b(u.SUBSCRIBE);n.topics=e.constructor===Array?e:[e],void 0===t.qos&&(t.qos=0),n.requestedQos=[];for(var i=0;i<n.topics.length;i++)n.requestedQos[i]=t.qos;t.onSuccess&&(n.onSuccess=function(e){t.onSuccess({invocationContext:t.invocationContext,grantedQos:e})}),t.onFailure&&(n.onFailure=function(e){t.onFailure({invocationContext:t.invocationContext,errorCode:e,errorMessage:g(e)})}),t.timeout&&(n.timeOut=new y(this,t.timeout,t.onFailure,[{invocationContext:t.invocationContext,errorCode:p.SUBSCRIBE_TIMEOUT.code,errorMessage:g(p.SUBSCRIBE_TIMEOUT)}])),this._requires_ack(n),this._schedule_message(n)},A.prototype.unsubscribe=function(e,t){if(this._trace("Client.unsubscribe",e,t),!this.connected)throw new Error(g(p.INVALID_STATE,["not connected"]));var n=new b(u.UNSUBSCRIBE);n.topics=e.constructor===Array?e:[e],t.onSuccess&&(n.callback=function(){t.onSuccess({invocationContext:t.invocationContext})}),t.timeout&&(n.timeOut=new y(this,t.timeout,t.onFailure,[{invocationContext:t.invocationContext,errorCode:p.UNSUBSCRIBE_TIMEOUT.code,errorMessage:g(p.UNSUBSCRIBE_TIMEOUT)}])),this._requires_ack(n),this._schedule_message(n)},A.prototype.send=function(e){this._trace("Client.send",e);var t=new b(u.PUBLISH);if(t.payloadMessage=e,this.connected)e.qos>0?this._requires_ack(t):this.onMessageDelivered&&(this._notify_msg_sent[t]=this.onMessageDelivered(t.payloadMessage)),this._schedule_message(t);else{if(!this._reconnecting||!this.disconnectedPublishing)throw new Error(g(p.INVALID_STATE,["not connected"]));var n=Object.keys(this._sentMessages).length+this._buffered_msg_queue.length;if(n>this.disconnectedBufferSize)throw new Error(g(p.BUFFER_FULL,[this.disconnectedBufferSize]));e.qos>0?this._requires_ack(t):(t.sequence=++this._sequence,this._buffered_msg_queue.unshift(t))}},A.prototype.disconnect=function(){if(this._trace("Client.disconnect"),this._reconnecting&&(this._reconnectTimeout.cancel(),this._reconnectTimeout=null,this._reconnecting=!1),!this.socket)throw new Error(g(p.INVALID_STATE,["not connecting or connected"]));var e=new b(u.DISCONNECT);this._notify_msg_sent[e]=m(this._disconnected,this),this._schedule_message(e)},A.prototype.getTraceLog=function(){if(null!==this._traceBuffer){this._trace("Client.getTraceLog",new Date),this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var e in this._sentMessages)this._trace("_sentMessages ",e,this._sentMessages[e]);for(var e in this._receivedMessages)this._trace("_receivedMessages ",e,this._receivedMessages[e]);return this._traceBuffer}},A.prototype.startTrace=function(){null===this._traceBuffer&&(this._traceBuffer=[]),this._trace("Client.startTrace",new Date,c)},A.prototype.stopTrace=function(){delete this._traceBuffer},A.prototype._doConnect=function(e){if(this.connectOptions.useSSL){var t=e.split(":");t[0]="wss",e=t.join(":")}this._wsuri=e,this.connected=!1,this.socket=this.connectOptions.mqttVersion<4?new WebSocket(e,["mqttv3.1"]):new WebSocket(e,["mqtt"]),this.socket.binaryType="arraybuffer",this.socket.onopen=m(this._on_socket_open,this),this.socket.onmessage=m(this._on_socket_message,this),this.socket.onerror=m(this._on_socket_error,this),this.socket.onclose=m(this._on_socket_close,this),this.sendPinger=new w(this,this.connectOptions.keepAliveInterval),this.receivePinger=new w(this,this.connectOptions.keepAliveInterval),this._connectTimeout&&(this._connectTimeout.cancel(),this._connectTimeout=null),this._connectTimeout=new y(this,this.connectOptions.timeout,this._disconnected,[p.CONNECT_TIMEOUT.code,g(p.CONNECT_TIMEOUT)])},A.prototype._schedule_message=function(e){this._msg_queue.unshift(e),this.connected&&this._process_queue()},A.prototype.store=function(e,t){var n={type:t.type,messageIdentifier:t.messageIdentifier,version:1};switch(t.type){case u.PUBLISH:t.pubRecReceived&&(n.pubRecReceived=!0),n.payloadMessage={};for(var i="",s=t.payloadMessage.payloadBytes,a=0;a<s.length;a++)s[a]<=15?i=i+"0"+s[a].toString(16):i+=s[a].toString(16);n.payloadMessage.payloadHex=i,n.payloadMessage.qos=t.payloadMessage.qos,n.payloadMessage.destinationName=t.payloadMessage.destinationName,t.payloadMessage.duplicate&&(n.payloadMessage.duplicate=!0),t.payloadMessage.retained&&(n.payloadMessage.retained=!0),0===e.indexOf("Sent:")&&(void 0===t.sequence&&(t.sequence=++this._sequence),n.sequence=t.sequence);break;default:throw Error(g(p.INVALID_STORED_DATA,[e+this._localKey+t.messageIdentifier,n]))}d.setItem(e+this._localKey+t.messageIdentifier,JSON.stringify(n))},A.prototype.restore=function(e){var t=d.getItem(e),n=JSON.parse(t),i=new b(n.type,n);switch(n.type){case u.PUBLISH:for(var s=n.payloadMessage.payloadHex,a=new ArrayBuffer(s.length/2),o=new Uint8Array(a),r=0;s.length>=2;){var l=parseInt(s.substring(0,2),16);s=s.substring(2,s.length),o[r++]=l}var c=new C(o);c.qos=n.payloadMessage.qos,c.destinationName=n.payloadMessage.destinationName,n.payloadMessage.duplicate&&(c.duplicate=!0),n.payloadMessage.retained&&(c.retained=!0),i.payloadMessage=c;break;default:throw Error(g(p.INVALID_STORED_DATA,[e,t]))}0===e.indexOf("Sent:"+this._localKey)?(i.payloadMessage.duplicate=!0,this._sentMessages[i.messageIdentifier]=i):0===e.indexOf("Received:"+this._localKey)&&(this._receivedMessages[i.messageIdentifier]=i)},A.prototype._process_queue=function(){for(var e=null;e=this._msg_queue.pop();)this._socket_send(e),this._notify_msg_sent[e]&&(this._notify_msg_sent[e](),delete this._notify_msg_sent[e])},A.prototype._requires_ack=function(e){var t=Object.keys(this._sentMessages).length;if(t>this.maxMessageIdentifier)throw Error("Too many messages:"+t);for(;void 0!==this._sentMessages[this._message_identifier];)this._message_identifier++;e.messageIdentifier=this._message_identifier,this._sentMessages[e.messageIdentifier]=e,e.type===u.PUBLISH&&this.store("Sent:",e),this._message_identifier===this.maxMessageIdentifier&&(this._message_identifier=1)},A.prototype._on_socket_open=function(){var e=new b(u.CONNECT,this.connectOptions);e.clientId=this.clientId,this._socket_send(e)},A.prototype._on_socket_message=function(e){this._trace("Client._on_socket_message",e.data);for(var t=this._deframeMessages(e.data),n=0;n<t.length;n+=1)this._handleMessage(t[n])},A.prototype._deframeMessages=function(e){var n=new Uint8Array(e),i=[];if(this.receiveBuffer){var s=new Uint8Array(this.receiveBuffer.length+n.length);s.set(this.receiveBuffer),s.set(n,this.receiveBuffer.length),n=s,delete this.receiveBuffer}try{for(var a=0;a<n.length;){var o=t(n,a),r=o[0];if(a=o[1],null===r)break;i.push(r)}a<n.length&&(this.receiveBuffer=n.subarray(a))}catch(l){var c="undefined"==l.hasOwnProperty("stack")?l.stack.toString():"No Error Stack Available";return this._disconnected(p.INTERNAL_ERROR.code,g(p.INTERNAL_ERROR,[l.message,c])),void 0}return i},A.prototype._handleMessage=function(e){this._trace("Client._handleMessage",e);try{switch(e.type){case u.CONNACK:if(this._connectTimeout.cancel(),this._reconnectTimeout&&this._reconnectTimeout.cancel(),this.connectOptions.cleanSession){for(var t in this._sentMessages){var n=this._sentMessages[t];d.removeItem("Sent:"+this._localKey+n.messageIdentifier)}this._sentMessages={};for(var t in this._receivedMessages){var i=this._receivedMessages[t];d.removeItem("Received:"+this._localKey+i.messageIdentifier)}this._receivedMessages={}}if(0!==e.returnCode){this._disconnected(p.CONNACK_RETURNCODE.code,g(p.CONNACK_RETURNCODE,[e.returnCode,f[e.returnCode]]));break}this.connected=!0,this.connectOptions.uris&&(this.hostIndex=this.connectOptions.uris.length);var s=[];for(var a in this._sentMessages)this._sentMessages.hasOwnProperty(a)&&s.push(this._sentMessages[a]);if(this._buffered_msg_queue.length>0)for(var o=null;o=this._buffered_msg_queue.pop();)s.push(o),this.onMessageDelivered&&(this._notify_msg_sent[o]=this.onMessageDelivered(o.payloadMessage));for(var s=s.sort(function(e,t){return e.sequence-t.sequence}),r=0,l=s.length;l>r;r++){var n=s[r];if(n.type==u.PUBLISH&&n.pubRecReceived){var c=new b(u.PUBREL,{messageIdentifier:n.messageIdentifier});this._schedule_message(c)}else this._schedule_message(n)}this.connectOptions.onSuccess&&this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext});var h=!1;this._reconnecting&&(h=!0,this._reconnectInterval=1,this._reconnecting=!1),this._connected(h,this._wsuri),this._process_queue();
break;case u.PUBLISH:this._receivePublish(e);break;case u.PUBACK:var n=this._sentMessages[e.messageIdentifier];n&&(delete this._sentMessages[e.messageIdentifier],d.removeItem("Sent:"+this._localKey+e.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(n.payloadMessage));break;case u.PUBREC:var n=this._sentMessages[e.messageIdentifier];if(n){n.pubRecReceived=!0;var c=new b(u.PUBREL,{messageIdentifier:e.messageIdentifier});this.store("Sent:",n),this._schedule_message(c)}break;case u.PUBREL:var i=this._receivedMessages[e.messageIdentifier];d.removeItem("Received:"+this._localKey+e.messageIdentifier),i&&(this._receiveMessage(i),delete this._receivedMessages[e.messageIdentifier]);var m=new b(u.PUBCOMP,{messageIdentifier:e.messageIdentifier});this._schedule_message(m);break;case u.PUBCOMP:var n=this._sentMessages[e.messageIdentifier];delete this._sentMessages[e.messageIdentifier],d.removeItem("Sent:"+this._localKey+e.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(n.payloadMessage);break;case u.SUBACK:var n=this._sentMessages[e.messageIdentifier];n&&(n.timeOut&&n.timeOut.cancel(),128===e.returnCode[0]?n.onFailure&&n.onFailure(e.returnCode):n.onSuccess&&n.onSuccess(e.returnCode),delete this._sentMessages[e.messageIdentifier]);break;case u.UNSUBACK:var n=this._sentMessages[e.messageIdentifier];n&&(n.timeOut&&n.timeOut.cancel(),n.callback&&n.callback(),delete this._sentMessages[e.messageIdentifier]);break;case u.PINGRESP:this.sendPinger.reset();break;case u.DISCONNECT:this._disconnected(p.INVALID_MQTT_MESSAGE_TYPE.code,g(p.INVALID_MQTT_MESSAGE_TYPE,[e.type]));break;default:this._disconnected(p.INVALID_MQTT_MESSAGE_TYPE.code,g(p.INVALID_MQTT_MESSAGE_TYPE,[e.type]))}}catch(v){var _="undefined"==v.hasOwnProperty("stack")?v.stack.toString():"No Error Stack Available";return this._disconnected(p.INTERNAL_ERROR.code,g(p.INTERNAL_ERROR,[v.message,_])),void 0}},A.prototype._on_socket_error=function(e){this._reconnecting||this._disconnected(p.SOCKET_ERROR.code,g(p.SOCKET_ERROR,[e.data]))},A.prototype._on_socket_close=function(){this._reconnecting||this._disconnected(p.SOCKET_CLOSE.code,g(p.SOCKET_CLOSE))},A.prototype._socket_send=function(e){if(1==e.type){var t=this._traceMask(e,"password");this._trace("Client._socket_send",t)}else this._trace("Client._socket_send",e);this.socket.send(e.encode()),this.sendPinger.reset()},A.prototype._receivePublish=function(e){switch(e.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(e);break;case 1:var t=new b(u.PUBACK,{messageIdentifier:e.messageIdentifier});this._schedule_message(t),this._receiveMessage(e);break;case 2:this._receivedMessages[e.messageIdentifier]=e,this.store("Received:",e);var n=new b(u.PUBREC,{messageIdentifier:e.messageIdentifier});this._schedule_message(n);break;default:throw Error("Invaild qos="+e.payloadMessage.qos)}},A.prototype._receiveMessage=function(e){this.onMessageArrived&&this.onMessageArrived(e.payloadMessage)},A.prototype._connected=function(e,t){this.onConnected&&this.onConnected(e,t)},A.prototype._reconnect=function(){this._trace("Client._reconnect"),this.connected||(this._reconnecting=!0,this.sendPinger.cancel(),this.receivePinger.cancel(),this._reconnectInterval<128&&(this._reconnectInterval=2*this._reconnectInterval),this.connectOptions.uris?(this.hostIndex=0,this._doConnect(this.connectOptions.uris[0])):this._doConnect(this.uri))},A.prototype._disconnected=function(e,t){if(this._trace("Client._disconnected",e,t),void 0!==e&&this._reconnecting)return this._reconnectTimeout=new y(this,this._reconnectInterval,this._reconnect),void 0;if(this.sendPinger.cancel(),this.receivePinger.cancel(),this._connectTimeout&&(this._connectTimeout.cancel(),this._connectTimeout=null),this._msg_queue=[],this._buffered_msg_queue=[],this._notify_msg_sent={},this.socket&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,1===this.socket.readyState&&this.socket.close(),delete this.socket),this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1)this.hostIndex++,this._doConnect(this.connectOptions.uris[this.hostIndex]);else if(void 0===e&&(e=p.OK.code,t=g(p.OK)),this.connected){if(this.connected=!1,this.onConnectionLost&&this.onConnectionLost({errorCode:e,errorMessage:t,reconnect:this.connectOptions.reconnect,uri:this._wsuri}),e!==p.OK.code&&this.connectOptions.reconnect)return this._reconnectInterval=1,this._reconnect(),void 0}else 4===this.connectOptions.mqttVersion&&this.connectOptions.mqttVersionExplicit===!1?(this._trace("Failed to connect V4, dropping back to V3"),this.connectOptions.mqttVersion=3,this.connectOptions.uris?(this.hostIndex=0,this._doConnect(this.connectOptions.uris[0])):this._doConnect(this.uri)):this.connectOptions.onFailure&&this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:e,errorMessage:t})},A.prototype._trace=function(){if(this.traceFunction){var e=Array.prototype.slice.call(arguments);for(var t in e)"undefined"!=typeof e[t]&&e.splice(t,1,JSON.stringify(e[t]));var n=e.join("");this.traceFunction({severity:"Debug",message:n})}if(null!==this._traceBuffer)for(var t=0,i=arguments.length;i>t;t++)this._traceBuffer.length==this._MAX_TRACE_ENTRIES&&this._traceBuffer.shift(),0===t?this._traceBuffer.push(arguments[t]):"undefined"==typeof arguments[t]?this._traceBuffer.push(arguments[t]):this._traceBuffer.push("  "+JSON.stringify(arguments[t]))},A.prototype._traceMask=function(e,t){var n={};for(var i in e)e.hasOwnProperty(i)&&(n[i]=i==t?"******":e[i]);return n};var T=function(e,t,n,i){var s;if("string"!=typeof e)throw new Error(g(p.INVALID_TYPE,[typeof e,"host"]));if(2==arguments.length){i=t,s=e;var a=s.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(!a)throw new Error(g(p.INVALID_ARGUMENT,[e,"host"]));e=a[4]||a[2],t=parseInt(a[7]),n=a[8]}else{if(3==arguments.length&&(i=n,n="/mqtt"),"number"!=typeof t||0>t)throw new Error(g(p.INVALID_TYPE,[typeof t,"port"]));if("string"!=typeof n)throw new Error(g(p.INVALID_TYPE,[typeof n,"path"]));var o=-1!==e.indexOf(":")&&"["!==e.slice(0,1)&&"]"!==e.slice(-1);s="ws://"+(o?"["+e+"]":e)+":"+t+n}for(var r=0,l=0;l<i.length;l++){var c=i.charCodeAt(l);c>=55296&&56319>=c&&l++,r++}if("string"!=typeof i||r>65535)throw new Error(g(p.INVALID_ARGUMENT,[i,"clientId"]));var d=new A(s,e,t,n,i);Object.defineProperties(this,{host:{get:function(){return e},set:function(){throw new Error(g(p.UNSUPPORTED_OPERATION))}},port:{get:function(){return t},set:function(){throw new Error(g(p.UNSUPPORTED_OPERATION))}},path:{get:function(){return n},set:function(){throw new Error(g(p.UNSUPPORTED_OPERATION))}},uri:{get:function(){return s},set:function(){throw new Error(g(p.UNSUPPORTED_OPERATION))}},clientId:{get:function(){return d.clientId},set:function(){throw new Error(g(p.UNSUPPORTED_OPERATION))}},onConnected:{get:function(){return d.onConnected},set:function(e){if("function"!=typeof e)throw new Error(g(p.INVALID_TYPE,[typeof e,"onConnected"]));d.onConnected=e}},disconnectedPublishing:{get:function(){return d.disconnectedPublishing},set:function(e){d.disconnectedPublishing=e}},disconnectedBufferSize:{get:function(){return d.disconnectedBufferSize},set:function(e){d.disconnectedBufferSize=e}},onConnectionLost:{get:function(){return d.onConnectionLost},set:function(e){if("function"!=typeof e)throw new Error(g(p.INVALID_TYPE,[typeof e,"onConnectionLost"]));d.onConnectionLost=e}},onMessageDelivered:{get:function(){return d.onMessageDelivered},set:function(e){if("function"!=typeof e)throw new Error(g(p.INVALID_TYPE,[typeof e,"onMessageDelivered"]));d.onMessageDelivered=e}},onMessageArrived:{get:function(){return d.onMessageArrived},set:function(e){if("function"!=typeof e)throw new Error(g(p.INVALID_TYPE,[typeof e,"onMessageArrived"]));d.onMessageArrived=e}},trace:{get:function(){return d.traceFunction},set:function(e){if("function"!=typeof e)throw new Error(g(p.INVALID_TYPE,[typeof e,"onTrace"]));d.traceFunction=e}}}),this.connect=function(e){if(e=e||{},h(e,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",reconnect:"boolean",mqttVersion:"number",mqttVersionExplicit:"boolean",uris:"object"}),void 0===e.keepAliveInterval&&(e.keepAliveInterval=60),e.mqttVersion>4||e.mqttVersion<3)throw new Error(g(p.INVALID_ARGUMENT,[e.mqttVersion,"connectOptions.mqttVersion"]));if(void 0===e.mqttVersion?(e.mqttVersionExplicit=!1,e.mqttVersion=4):e.mqttVersionExplicit=!0,void 0!==e.password&&void 0===e.userName)throw new Error(g(p.INVALID_ARGUMENT,[e.password,"connectOptions.password"]));if(e.willMessage){if(!(e.willMessage instanceof C))throw new Error(g(p.INVALID_TYPE,[e.willMessage,"connectOptions.willMessage"]));if(e.willMessage.stringPayload=null,"undefined"==typeof e.willMessage.destinationName)throw new Error(g(p.INVALID_TYPE,[typeof e.willMessage.destinationName,"connectOptions.willMessage.destinationName"]))}if("undefined"==typeof e.cleanSession&&(e.cleanSession=!0),e.hosts){if(!(e.hosts instanceof Array))throw new Error(g(p.INVALID_ARGUMENT,[e.hosts,"connectOptions.hosts"]));if(e.hosts.length<1)throw new Error(g(p.INVALID_ARGUMENT,[e.hosts,"connectOptions.hosts"]));for(var t=!1,i=0;i<e.hosts.length;i++){if("string"!=typeof e.hosts[i])throw new Error(g(p.INVALID_TYPE,[typeof e.hosts[i],"connectOptions.hosts["+i+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(e.hosts[i])){if(0===i)t=!0;else if(!t)throw new Error(g(p.INVALID_ARGUMENT,[e.hosts[i],"connectOptions.hosts["+i+"]"]))}else if(t)throw new Error(g(p.INVALID_ARGUMENT,[e.hosts[i],"connectOptions.hosts["+i+"]"]))}if(t)e.uris=e.hosts;else{if(!e.ports)throw new Error(g(p.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));if(!(e.ports instanceof Array))throw new Error(g(p.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));if(e.hosts.length!==e.ports.length)throw new Error(g(p.INVALID_ARGUMENT,[e.ports,"connectOptions.ports"]));e.uris=[];for(var i=0;i<e.hosts.length;i++){if("number"!=typeof e.ports[i]||e.ports[i]<0)throw new Error(g(p.INVALID_TYPE,[typeof e.ports[i],"connectOptions.ports["+i+"]"]));var a=e.hosts[i],o=e.ports[i],r=-1!==a.indexOf(":");s="ws://"+(r?"["+a+"]":a)+":"+o+n,e.uris.push(s)}}}d.connect(e)},this.subscribe=function(e,t){if("string"!=typeof e&&e.constructor!==Array)throw new Error("Invalid argument:"+e);if(t=t||{},h(t,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),t.timeout&&!t.onFailure)throw new Error("subscribeOptions.timeout specified with no onFailure callback.");if("undefined"!=typeof t.qos&&0!==t.qos&&1!==t.qos&&2!==t.qos)throw new Error(g(p.INVALID_ARGUMENT,[t.qos,"subscribeOptions.qos"]));d.subscribe(e,t)},this.unsubscribe=function(e,t){if("string"!=typeof e&&e.constructor!==Array)throw new Error("Invalid argument:"+e);if(t=t||{},h(t,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),t.timeout&&!t.onFailure)throw new Error("unsubscribeOptions.timeout specified with no onFailure callback.");d.unsubscribe(e,t)},this.send=function(e,t,n,i){var s;if(0===arguments.length)throw new Error("Invalid argument.length");if(1==arguments.length){if(!(e instanceof C)&&"string"!=typeof e)throw new Error("Invalid argument:"+typeof e);if(s=e,"undefined"==typeof s.destinationName)throw new Error(g(p.INVALID_ARGUMENT,[s.destinationName,"Message.destinationName"]));d.send(s)}else s=new C(t),s.destinationName=e,arguments.length>=3&&(s.qos=n),arguments.length>=4&&(s.retained=i),d.send(s)},this.publish=function(e,t,n,i){var s;if(0===arguments.length)throw new Error("Invalid argument.length");if(1==arguments.length){if(!(e instanceof C)&&"string"!=typeof e)throw new Error("Invalid argument:"+typeof e);if(s=e,"undefined"==typeof s.destinationName)throw new Error(g(p.INVALID_ARGUMENT,[s.destinationName,"Message.destinationName"]));d.send(s)}else s=new C(t),s.destinationName=e,arguments.length>=3&&(s.qos=n),arguments.length>=4&&(s.retained=i),d.send(s)},this.disconnect=function(){d.disconnect()},this.getTraceLog=function(){return d.getTraceLog()},this.startTrace=function(){d.startTrace()},this.stopTrace=function(){d.stopTrace()},this.isConnected=function(){return d.connected}},C=function(e){var t;if(!("string"==typeof e||e instanceof ArrayBuffer||ArrayBuffer.isView(e)&&!(e instanceof DataView)))throw g(p.INVALID_ARGUMENT,[e,"newPayload"]);t=e;var n,i=0,s=!1,a=!1;Object.defineProperties(this,{payloadString:{enumerable:!0,get:function(){return"string"==typeof t?t:l(t,0,t.length)}},payloadBytes:{enumerable:!0,get:function(){if("string"==typeof t){var e=new ArrayBuffer(o(t)),n=new Uint8Array(e);return r(t,n,0),n}return t}},destinationName:{enumerable:!0,get:function(){return n},set:function(e){if("string"!=typeof e)throw new Error(g(p.INVALID_ARGUMENT,[e,"newDestinationName"]));n=e}},qos:{enumerable:!0,get:function(){return i},set:function(e){if(0!==e&&1!==e&&2!==e)throw new Error("Invalid argument:"+e);i=e}},retained:{enumerable:!0,get:function(){return s},set:function(e){if("boolean"!=typeof e)throw new Error(g(p.INVALID_ARGUMENT,[e,"newRetained"]));s=e}},topic:{enumerable:!0,get:function(){return n},set:function(e){n=e}},duplicate:{enumerable:!0,get:function(){return a},set:function(e){a=e}}})};return{Client:T,Message:C}}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});return e}),define("text!_common/alerts/tmpl/deviceInfoTabs.html",[],function(){return'<div class="tabs-hor-cont">\n    <ul class="tabs-hor">\n        <li class="active">\n\n            <div class="tab-toggle-container">\n                <a data-code="info" class="tab-toggle" href="#tabs-br-1">\n                    <i class="svg-icon svg-icon-circle-info"></i>\n                    <%= i18n.object.ucFirst() %>\n                </a>\n            </div>\n            <div class="tab-hor-content selectable obj-info-cont" id="tabs-br-1"></div><!--/tab-hor-content-->\n\n        </li><li>\n\n            <div class="tab-toggle-container">\n                <a data-code="state" class="tab-toggle" href="#tabs-br-2">\n                    <i class="svg-icon svg-icon-lamp"></i>\n                    <%= i18n.currentState %>\n                </a>\n            </div>\n            <div class="tab-hor-content selectable obj-state-cont" id="tabs-br-2"></div><!--/tab-hor-content-->\n\n        </li><li>\n\n            <div class="tab-toggle-container">\n                <a data-code="pictures" class="tab-toggle" href="#tabs-br-3">\n                    <i class="svg-icon svg-icon-photo"></i>\n                    <%= i18n.objPhoto %>\n                </a>\n            </div>\n            <div class="tab-hor-content obj-pictures-cont" id="tabs-br-3"></div><!--/tab-hor-content-->\n\n        </li><li<% if(!hasVideo) {%> class="hidden"<% } %>>\n\n            <div class="tab-toggle-container">\n                <a data-code="video" class="tab-toggle" href="#tabs-br-video">\n                    <i class="svg-icon svg-icon-camera"></i>\n                    <%= i18n.video %>\n                </a>\n            </div>\n            <div class="tab-hor-content device-video-cont" id="tabs-br-video">\n\n            </div><!--/tab-hor-content-->\n\n        </li><li>\n\n            <div class="tab-toggle-container">\n                <a data-code="map" class="tab-toggle" href="#tabs-br-4">\n                    <!--<i class="svg-icon svg-icon-location"></i>-->\n                    <svg class="svg-icon svg-icon-location">\n                        <use xlink:href="#smb-location"></use>\n                    </svg>\n                    <%= i18n.map.ucFirst() %>\n                </a>\n            </div>\n            <div class="tab-hor-content map-and-route" id="tabs-br-4">\n                <% if(App.get(\'grGuardsAvailable\')) { %>\n                <div class="pane-left closed">\n\n                    <a href="javascript:;" class="toggle-pane hidden">\n                        <i class="svg-icon svg-icon-chevron-left"></i>\n                        <i class="svg-icon svg-icon-chevron-right"></i>\n                    </a>\n                </div><!--/pane-left-->\n                <% } %>\n                <div class="pane-right">\n                    <div class="map">\n                    </div><!--/map container-->\n                    <% if(App.get(\'grGuardsAvailable\')) { %>\n                    <div class="find-nearest form-horizontal">\n                        <div class="field">\n                            <span class="help-inline">\n                                <a class="find-nearest-btn" href="#"><%= i18n.show.ucFirst() + \' \' + i18n.rrTeamShort %></a>\n                                <%= i18n.inRadius %>\n                            </span>\n                            <input class="input-mini positive" type="text" value="<%= maxRRTDist || 10 %>" name="maxDist">\n                            <span class="help-inline"><%= i18n.km %></span>\n                        </div>\n                    </div>\n                    <% } %>\n                    <div class="no-coords"><%= i18n.objectHasNoCoords %></div>\n                </div><!--/pane-right-->\n            </div><!--/tab-hor-content-->\n\n        </li><li>\n\n            <div class="tab-toggle-container">\n                <a data-code="resp" class="tab-toggle" href="#tabs-br-5">\n                    <i class="svg-icon svg-icon-users"></i>\n                    <%= i18n.responsible.header %>\n                </a>\n            </div>\n            <div class="tab-hor-content selectable obj-responsible-cont" id="tabs-br-5"></div><!--/tab-hor-content-->\n\n        </li>\n    </ul>\n</div><!--/tabs-hor-cont info tabs-->\n'}),define("text!_common/alerts/tmpl/deviceInfo.html",[],function(){return'<div class="obj-info">\n\n    <table class="table-features"><tr>\n        <td class="features">\n            <ul>\n                <% _.each(infoAttrs, function(name, key){%>\n                    <% if(key == \'owner\'){//new col%>\n                        </ul></td><td class="features"><ul>\n                    <% } %>\n                    <li>\n                        <%= name %>:\n                        <% if(key in device && device[key] && key.toLowerCase().indexOf(\'phone\') > -1){ %>\n                            <a href="tel:<%- device[key] %>"><strong class="<%= key %>"><%- device[key] %></strong></a>\n                        <% } else { %>\n\n                            <% if(key == \'shortDescription\'){%>\n                                <strong class="shortDescription_el"></strong>\n                            <% } else {%>\n                                <strong class="<%= key %>"><%- key in device && device[key] ? device[key] : \'-\' %></strong>\n                            <% } %>\n\n                        <% } %>\n                    </li>\n                <% }) %>\n\n                <li class="hidden">\n                    <%= i18n.groups %>:\n                    <strong class="groups"></strong>\n                </li>\n                <li class="hidden">\n                    <%= i18n.rrTeamShort %>:\n                    <strong class="guards"></strong>\n                </li>\n                <li>\n                    <%= i18n.comments %>:\n                    <strong class="description"><%= device.description %></strong>\n                </li>\n                <div class="btnLinks"></div>\n            </ul>\n        </td>\n    </tr></table>\n\n</div><!--/obj-info-->'}),define("text!_common/alerts/tmpl/responsiblePersons.html",[],function(){return'<div class="obj-responsible">\n    <ul class="resp-pass">\n        <li>\n            <%= i18n.responsible.pass1 %>: <b data-key="pass1"><%- \'undefined\' != typeof pass1 && pass1 ? pass1 : \'-\' %></b>\n        </li>\n        <li>\n            <%= i18n.responsible.pass2 %>: <b data-key="pass2"><%- \'undefined\' != typeof pass2 && pass2 ? pass2 : \'-\' %></b>\n        </li>\n    </ul>\n\n    <div data-key="persons">\n        <% if(\'undefined\' != typeof persons && persons.length) { %>\n        <table class="table table-condensed resp-persons">\n            <thead>\n                <tr>\n                    <th>#</th>\n                    <th class="text-center"><%= i18n.responsible.persons.key %></th>\n                    <th><%= i18n.responsible.persons.name %></th>\n                    <th><%= i18n.responsible.persons.phone1 %></th>\n                    <th><%= i18n.responsible.persons.phone2 %></th>\n                    <th><%= i18n.responsible.persons.comment %></th>\n                </tr>\n            </thead>\n            <% _.each(persons, function(person, i){ %>\n            <tr>\n                <td><%= i+1 %></td>\n                <td class="text-center"><%- person.key %></td>\n                <td><%- person.name %></td>\n                <td><a href="tel:<%- person.phone1 %>"><%- person.phone1 %></a></td>\n                <td><a href="tel:<%- person.phone2 %>"><%- person.phone2 %></a></td>\n                <td><%- person.comment %></td>\n            </tr>\n            <% }) %>\n        </table>\n        <% } else { %>\n        <p><%= i18n.responsible.persons.noData %></p>\n        <% } %>\n    </div>\n</div>'}),define("text!_common/alerts/tmpl/alertMarker.html",[],function(){return'<div class="ti-icon-alert-marker">\n    <% if(type== \'alert\') {%>\n    <div class="tl-icon tl-icon__alert">\n        <div class="tl-icon-circle">\n            <svg class="tl-icon-svg">\n                <use xlink:href="#smb-bell"></use>\n            </svg>\n        </div>\n        <svg class="tl-icon-pointer">\n            <use xlink:href="#smb-pointer"></use>\n        </svg>\n    </div>\n\n    <% } else if(type== \'comment\') { %>\n    <div class="tl-icon tl-icon__comment">\n        <div class="tl-icon-circle">\n            <svg class="tl-icon-svg">\n                <use xlink:href="#smb-user"></use>\n            </svg>\n        </div>\n        <svg class="tl-icon-pointer">\n            <use xlink:href="#smb-pointer"></use>\n        </svg>\n    </div>\n\n    <% } else if(type== \'alarm\') { %>\n    <div class="tl-icon tl-icon__alarm">\n        <div class="tl-icon-circle">\n            <svg class="tl-icon-svg">\n                <use xlink:href="#smb-warning"></use>\n            </svg>\n        </div>\n        <svg class="tl-icon-pointer">\n            <use xlink:href="#smb-pointer"></use>\n        </svg>\n    </div>\n\n    <% } else if(type== \'restore\') { %>\n    <div class="tl-icon tl-icon__restore">\n        <div class="tl-icon-circle">\n            <svg class="tl-icon-svg">\n                <use xlink:href="#smb-done"></use>\n            </svg>\n        </div>\n        <svg class="tl-icon-pointer">\n            <use xlink:href="#smb-pointer"></use>\n        </svg>\n    </div>\n\n    <% } else if(type== \'fault\') { %>\n    <div class="tl-icon tl-icon__fault">\n        <div class="tl-icon-circle">\n            <svg class="tl-icon-svg">\n                <use xlink:href="#smb-wrench"></use>\n            </svg>\n        </div>\n        <svg class="tl-icon-pointer">\n            <use xlink:href="#smb-pointer"></use>\n        </svg>\n    </div>\n\n    <% } else if(type== \'guard\') { %>\n    <div class="tl-icon tl-icon__guard">\n        <div class="tl-icon-circle">\n            <svg class="tl-icon-svg">\n                <use xlink:href="#smb-key"></use>\n            </svg>\n        </div>\n        <svg class="tl-icon-pointer">\n            <use xlink:href="#smb-pointer"></use>\n        </svg>\n    </div>\n\n    <% } else if(type== \'system\') { %>\n    <div class="tl-icon tl-icon__system">\n        <div class="tl-icon-circle">\n            <svg class="tl-icon-svg">\n                <use xlink:href="#smb-cog"></use>\n            </svg>\n        </div>\n        <svg class="tl-icon-pointer">\n            <use xlink:href="#smb-pointer"></use>\n        </svg>\n    </div>\n    <% } %>\n</div>'}),define("_common/alerts/views/DeviceInfoView",["jquery","underscore","jface","abstracts/View","abstracts/watched/views/DeviceInfoView","maps/MapsModule","../deviceState/DeviceStateController","_common/pictures/PicturesModule","_common/tracks/Track","moment","paho-mqtt","text!../tmpl/deviceInfoTabs.html","text!../tmpl/deviceInfo.html","text!../tmpl/responsiblePersons.html","text!../tmpl/alertMarker.html"],function(e,t,n,i,s,a,o,r,l,c,d,u,h,m,p){u=t.template(u),h=t.template(h),m=t.template(m),p=t.template(p);var f,g=/(https?:\/\/\S+)/gi,v=new RegExp("\\n","gi"),_='<a class="link" target="_blank" href="$1">$1</a>',b="<br/>",w=i.extend({constructor:function(e){this.parent=e.parent,this.controller=e.controller,this._infoAttrs={},this._objMapElement=null,this._alertMarker=null,this._stateModule=null,this._picturesModule=null,this._videoModule=null,i.apply(this,arguments)},initialize:function(){var e=this.controller.getTexts();t.extend(this._infoAttrs,{owner:e.objOwner,ownersPhone1:e.phone.ucFirst()+" 1",ownersPhone2:e.phone.ucFirst()+" 2",ownerPassword:e.objOwnerPass,contractNumber:e.objContract,contractDate:e.objContractDate}),this.render(),this._bindEvents();var n=this.controller.get("deviceActivePage");n&&("video"!==n||this.model.has("ivideon")?this.$el.find(".tab-toggle[data-code="+n+"]").trigger("tabshow"):this.controller.set("deviceActivePage",null))},render:function(){this.$el.addClass("loading").html(u({i18n:this.controller.getTexts(),maxRRTDist:this.controller.getUserData("maxRRTDist"),hasVideo:this.model.has("ivideon")})),this._showDeviceInfo(),this._showDeviceResponsible(),this._initMap(),this._initState(),this.model.getCamerasList().length&&this._initVideo()},remove:function(){this._stateModule&&this._stateModule.destroy(),this._picturesModule&&this._picturesModule.destroy(),this._videoModule&&this._videoModule.destroy(),y.removeEventMarker.call(this),i.prototype.remove.apply(this,arguments)},_bindEvents:function(){var n=this,i=this.controller;this._bindDeviceEvents(),this.listenTo(i,"change:deviceActivePage",function(e,t){this._videoModule&&"video"===i.previous("deviceActivePage")&&this._videoModule.pause(),"map"!==t&&y.removeEventMarker.call(n)}).listenTo(this.parent,"layoutchange",t.throttle(function(){y.onLayoutChange.call(n)}),60).listenTo(this.parent,"hide",function(){n._stateModule&&(n._stateModule.destroy(),n._stateModule=null)}).listenTo(this.parent,"show",function(){var t=i.get("deviceActivePage");n._stateModule||"state"!==t?n._videoModule||"video"!==t||n._createVideoModule():n._stateModule=new o({parent:i,device:n.model,container:e('<div class="obj-info"/>').appendTo(n.$el.find(".obj-state-cont")),active:!0})}).listenTo(this.parent,"hide",function(){n._videoModule&&(n._videoModule.destroy(),n._videoModule=null)}),this.$el.find(".tabs-hor > li").on("toggle",function(t){t&&i.set("deviceActivePage",e(this).find("a[data-code]").data("code"))}),this.$el.find("[data-code=pictures]").closest("li").on("toggle",function(e){e&&!n._picturesModule&&(n._picturesModule=new r({objectId:n.model.id,container:n.$el.find(".obj-pictures-cont")}))})},_bindDeviceEvents:function(){var e=this;this.listenTo(this.model,"change:hasAlarm",function(t,n){e._objMapElement&&e._objMapElement.trigger("toggleclass",{off:n?"":"alarm",on:n?"alarm":""})}).listenTo(this.model,"change:hwStatus",function(t,n){var i=t.previous("hwStatus");e._objMapElement&&e._objMapElement.trigger("toggleclass",{off:i,on:n})}).listenTo(this.model,"change:status",function(t,n){var i=t.previous("status");e._objMapElement&&e._objMapElement.trigger("toggleclass",{off:i,on:n})}).listenTo(this.model,"change:responsive",function(){e._showDeviceResponsible()}).listenTo(this.model,"change:videoCameras",function(t){e._videoModule&&(e._videoModule.destroy(),e._videoModule=null),t.getCamerasList().length&&e._initVideo()}).listenTo(this.model,"change:ivideon",function(t,n){if(n)e._initVideo();else{var i=e.$el.find(".device-video-cont").closest("li");e._videoModule&&(e._videoModule.destroy(),e._videoModule=null),"video"===e.controller.get("deviceActivePage")&&e.$el.find(".tab-toggle[data-code=info]").trigger("tabshow"),i.addClass("hidden")}}).listenTo(this.model,"change:groups",function(){this._renderGroups()}).listenTo(this.model,"change:shortDescription",function(){this._renderShortDescription()}).listenTo(this.model,"change:description",function(){this._renderDescription()}).listenTo(this.model,"change",function(n){t.each(n.changed,function(i,s){if(s in e._infoAttrs){var a=e.$el.find("."+s),o=t.isNull(i);if(a.text(o?"-":i),s.toLowerCase().indexOf("phone")>-1){var r=n.previous(s);r||o?r&&o?a.unwrap():o||a.parent().attr("href","tel:"+i):a.wrap('<a href="tel:'+i+'"></a>')}}})}).listenToOnce(this.model,"sync",function(){e.$el.removeClass("loading")})},_initMap:function(){var e=this,t=new a({id:this.controller.id+"/maps",container:this.$el.find(".map"),parent:this.controller,routing:{pointsEdit:!1},compass:!0,ruler:!0,search:!1,traffic:!0,coords:!1,scale:!0,minimap:!1,print:!1,autozoom:!1,layersControl:!0,clearControl:!0});this.listenToOnce(t,"ready",function(){e.controller.setMapsModule(t),e._addDeviceToMap()}),this.listenTo(App,"clearmap",y.removeEventMarker.bind(e)),this.listenTo(this.controller,"onTableRowClick",y.onTableRowClick.bind(e))},_addDeviceToMap:function(){if(this._objMapElement){this.$el.find(".no-coords")[0].className+=" hidden";var e=this.controller.getMapsModule();e.addLayersGroup({layers:[this._objMapElement],groupCssClass:"stat-simple mobile-arrows",clusters:!1}),this._zoomToObject()}App.get("grGuardsAvailable")&&this._initGuardsSearch()},_placeOnMap:function(){if(this._objMapElement){var e=this.model,t={model:e,to:{lat:e.get("lat"),lon:e.get("lon")},animate:!1};this._objMapElement.trigger("place",t),this._alertMarker||this._objMapElement.trigger("follow",{center:[e.get("lat"),e.get("lon")],cluster:null})}},_showDeviceInfo:function(){this.$el.find(".obj-info-cont").html(h({device:this.model.attributes,infoAttrs:this._infoAttrs,i18n:this.controller.getTexts()})),this.model.has("groups")&&this._renderGroups(),this._renderDescription(),this._renderShortDescription()},_renderGroups:function(){var e=this.model.get("groups"),n=this.$el.find(".obj-info .features .groups"),i=n.parent(),s=[];i.toggleClass("hidden",!e.length),e.length&&t.each(e,function(e){s.push(e.name)}),n.html(s.join(", "))},getTextWithLink:function(e){var n=t.escape(e);return n=n.replace(v,b),n=n.replace(g,_)},_renderShortDescription:function(){var e=this.$el.find(".obj-info .features .shortDescription_el"),t=this.model.get("shortDescription");this._makeExternalLinks(e,t)},_renderDescription:function(){var e=this.$el.find(".obj-info .features .description"),t=this.$el.find(".obj-info .features .btnLinks"),n=this.model.get("description"),i=this.getTextAndBtn(n);this._makeExternalLinks(e,i.txt),this._makeBtnLinks.call(this,t,i.btnLinks)},getTextAndBtn:function(e){var t={txt:e,btnLinks:[]};if(!e)return t;var n=e.indexOf("[");return n>-1&&(t.txt=e.slice(0,n),t.btnLinks=this.parseBtnLinks(e)),t},parseBtnLinks:function(e){var t=[];if(!e)return t;var n=e.split("[");return n.map(function(e){return e.trim()}).forEach(function(e,n){if("]"===e[e.length-1])try{var i,s=e.replace("]","").split("|");i=JSON.parse(s[1]),t.push({id:n,name:s[0],data:i})}catch(a){console.log("e",a)}}),t},_makeBtnLinks:function(e,t){var n=this,i=t.map(function(e){return'<span class="btnLinks-item"data-id="'+e.id+'"'+'data-name="'+e.name+'"'+'data-url="'+e.data.url+'"'+'data-port="'+e.data.port+'"'+'data-user="'+e.data.user+'"'+'data-password="'+e.data.password+'"'+'data-message="'+e.data.message+'"'+'data-topic="'+e.data.topic+'"'+">"+e.name+"</span>"}).join("");e.html(i),e.off("click").on("click",n.onBtnLinkClick)},onBtnLinkClick:function(e){function t(){var e=new d.Message(u);e.destinationName=h,f.send(e),n.growl.open(m+" OK",{position:"br"})}function i(e){0!==e.errorCode&&console.log("onConnectionLost:"+e.errorMessage)
}function s(){}e.stopPropagation();var a=e.target,o=a.dataset.url,r=a.dataset.port,l=a.dataset.user,c=a.dataset.password,u=a.dataset.message,h=a.dataset.topic,m=a.dataset.name;f=new d.Client(o,+r,"clientId"),f.onConnectionLost=i,f.onMessageArrived=s,f.connect({onSuccess:t,userName:l,password:c})},_makeExternalLinks:function(e,t){var n=this;e.each(function(){var e=t?t:this.innerHTML.trim(),i=n.getTextWithLink(e);this.innerHTML=i})},_initState:function(){var t=this;this.$el.find("[data-code=state]").closest("li").on("toggle",function(n,i){i?t._stateModule?t._stateModule.set("active",!0):t._stateModule=new o({parent:t.controller,device:t.model,container:e('<div class="obj-info"/>').appendTo(t.$el.find(".obj-state-cont")),active:!0}):t._stateModule&&t._stateModule.set("active",!1)})},_showDeviceResponsible:function(){var n=this.model,i=n.get("responsive")?e.parseJSON(n.get("responsive")):{};this.$el.find(".obj-responsible-cont").html(m(t.extend({},i,{i18n:this.controller.getTexts()})))},_zoomToObject:function(){this._objMapElement&&this._objMapElement.trigger("zoomchange",{center:[this.model.get("lat"),this.model.get("lon")],cluster:null,maxZoom:15})},_initGuardsSearch:function(){var e=this,t=this.controller,n=this.$el.find(".find-nearest"),i=this.controller.modules.guards;n.removeClass("hidden"),this.$el.find("input[name=maxDist]").numeric({decimal:".",negative:!1}),this.$el.on("click",".find-nearest-btn",function(){y.searchNearestGuards.call(e,this)}).on("click",".toggle-pane",function(){y.toggleLeftPane.call(e)}),this.listenTo(t,"action",function(n){n==t.ACTION_GUARD_CALL&&(e.$el.find(".tab-toggle[data-code=map]").trigger("tabshow"),t.modules.guards.findNearest(t.getUserData("maxRRTDist")||10))}).listenTo(t,"guards:change:called",function(t){!t.called&&e._objMapElement&&e._zoomToObject()}),this.listenTo(i,"change:loading",function(t,n){e.$el[n?"addClass":"removeClass"]("loading")}).listenTo(i,"change:visible",function(t,i){y.toggleLeftPane.call(e,i),n[i?"addClass":"removeClass"]("hidden")})},_initVideo:function(){var e=this,t=this.$el.find("[data-code=video]").closest("li");t.removeClass("hidden"),t.on("toggle",function(t){t&&!e._videoModule&&e._createVideoModule()}),this.listenTo(this.controller,"playTimeSelect",function(t){"video"===e.controller.get("deviceActivePage")&&e._videoModule&&e._videoModule.setStartTs(t)})},_createVideoModule:function(){requirejs(["_common/deviceVideo/RtpVideoController"],function(t){this._videoModule=new t({device:this.model,container:e('<div class="device-video device-video-resizable"><div class="player-container"></div></div>').appendTo(this.$el.find(".device-video-cont"))}),this.listenToOnce(this._videoModule,"destroy",function(){this._videoModule=null})}.bind(this))},_initVideoBak:function(){var t=this,n=this.$el.find("[data-code=video]").closest("li");n.removeClass("hidden"),n.on("toggle",function(n){n&&!t._videoModule&&(t._videoModule=new IvideonVideoController({device:t.model,container:e('<div class="device-video"></div>').appendTo(t.$el.find(".device-video-cont"))}),t.listenToOnce(t._videoModule,"destroy",function(){t._videoModule=null}))}),this.listenTo(this.controller,"playTimeSelect",function(e){"video"===t.controller.get("deviceActivePage")&&t._videoModule&&t._videoModule.setStartTs(e)})},_getEventsNS:function(){return""}}),y={ONE_MINUT:6e4,onLayoutChange:function(){var e;if((e=this.controller.getMapsModule())&&e.trigger("layoutchange"),this._videoModule){var t=this._videoModule;setTimeout(function(){t.getView().fitSize()},30)}},formatDateTime:function(e,t){return c.utc(e).utcOffset(t||0).format("YYYY-MM-DD HH:mm:ss")},onTableRowClick:function(t){var n=this.controller.get("deviceActivePage");if("map"===n&&t&&t.alertTs){var i=this,s=t.objectId,a=t.alertTs,o=App.getUserTimezone();i.$el.addClass("loading"),e.when(e.ajax({url:App.getBaseUrl()+"reports/ROUTE/",data:{objectId:s,from:y.formatDateTime(a-y.ONE_MINUT,o),to:y.formatDateTime(a+y.ONE_MINUT,o),tz:App.getUserTimezone()}}),e.ajax({url:App.getBaseUrl()+"alert-template/get/",data:{code:+t.code.replace(".","")}})).done(function(e,n){var a=e[0],o=n[0];a.body&&a.body[s]&&y.showEventMarker.call(i,t,a.body[s],o)}).fail(function(e){console.warn("onTableRowClick error",e)}).always(function(){i.$el.removeClass("loading")})}},getDif:function(e,t){return Math.abs(e-t)},getRouteNearCoord:function(e,t){if(!Array.isArray(e)||!e[0]||!t)return{};for(var n=e[0],i=y.getDif(t,e[0].date),s=0;s<e.length;s++){var a=e[s],o=y.getDif(t,a.date);i>o&&(n=a,i=o)}return{dif:i,coord:n}},getParksNearCoord:function(e,t){if(!Array.isArray(e)||!e[0]||!t)return{};for(var n=[],i=0;i<e.length;i++){var s=e[i];if(s.start>t<s.end)return{dif:0,coord:s};var a=Object.assign({},s,{date:s.start}),o=Object.assign({},s,{date:s.end});n.push(a),n.push(o)}var r=y.getRouteNearCoord(respons.route,t);return r},getCoord:function(e,t){if(e&&t){var n=y.getRouteNearCoord(e.route,t),i=y.getParksNearCoord(e.parks,t);return"undefined"==typeof n.dif||"undefined"==typeof i.dif?"undefined"!=typeof n.dif?n:"undefined"!=typeof i.dif?i:{}:n.dif<i.dif?n:i}},getTypeAlert:function(e,t){var n=this.controller.isLogEntry(e);if(n)return"comment";if(e.isAlarm)return"alarm";var i={2:"restore",3:"fault",4:"guard",5:"system","default":"alert"};return t?i[t.groupId]||i.default:i.default},removeEventMarker:function(){var e=this.controller.getMapsModule();e&&e.removeLayer(this._alertMarker),this._alertMarker=null,this._zoomToObject()},showEventMarker:function(e,t,i){if(e&&t){var s=Math.round(e.alertTs/1e4),a=y.getCoord(t,s);if(!(a&&a.coord&&a.coord.lat&&a.coord.lon)){var o=this.controller.getTexts();return y.removeEventMarker.call(this),n.growl.open(o.errEventHasNoCoords,{position:"br"}),void 0}var r=this.controller.getMapsModule(),l=a.coord.lat,c=a.coord.lon;this._alertMarker&&r.removeLayer(this._alertMarker);var d=y.getTypeAlert.call(this,e,i);this._alertMarker=r.getWidget().buildComplexMarker({lat:l,lon:c,html:p({type:d}),className:"alert-marker",dataId:e.alertId,animated:!1}),r.addLayersGroup({layers:[this._alertMarker],groupCssClass:"stat-simple mobile-arrows",clusters:!1}),this._alertMarker.trigger("zoomchange",{center:[l,c],cluster:null,maxZoom:15})}},searchNearestGuards:function(t){var n,i=this.$el.find(".pane-right .find-nearest");if(t){var s=e(t);n=s.closest(".find-nearest")}else n=i;var a=n.find("input[name=maxDist]"),o=a.val().replace(",",".");o>300&&(o=300,a.val(300)),this.controller.modules.guards.findNearest(o)},toggleLeftPane:function(e){var t=this.$el.find(".pane-left"),n=this.$el.find(".pane-right"),i=-1!=t[0].className.indexOf("closed");"undefined"==typeof e&&(e=i),e?i&&(t.removeClass("closed"),n[0].style.left="35%",y.onLayoutChange.call(this)):i||(t.addClass("closed"),n[0].style.left=0,y.onLayoutChange.call(this))}};return w}),define("_common/tracks/TracksCollection",["underscore","abstracts/Collection","_common/tracks/Track"],function(e,t){var n=t.extend({constructor:function(){t.apply(this,arguments)},url:function(){return App.getBaseUrl()+"reports/ROUTE/"},initialize:function(){this.on("add",function(){})}});return n}),"function"!=typeof Blob&&"object"!=typeof Blob||"undefined"==typeof URL)if("function"!=typeof Blob&&"object"!=typeof Blob||"undefined"==typeof webkitURL)var Blob=function(e){var t=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder||function(e){var t=function(e){return Object.prototype.toString.call(e).match(/^\[object\s(.*)\]$/)[1]},n=function(){this.data=[]},i=function(e,t,n){this.data=e,this.size=e.length,this.type=t,this.encoding=n},s=n.prototype,a=i.prototype,o=e.FileReaderSync,r=function(e){this.code=this[this.name=e]},l="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),c=l.length,d=e.URL||e.webkitURL||e,u=d.createObjectURL,h=d.revokeObjectURL,m=d,p=e.btoa,f=e.atob,g=e.ArrayBuffer,v=e.Uint8Array;for(i.fake=a.fake=!0;c--;)r.prototype[l[c]]=c+1;return d.createObjectURL||(m=e.URL={}),m.createObjectURL=function(e){var t,n=e.type;return null===n&&(n="application/octet-stream"),e instanceof i?(t="data:"+n,"base64"===e.encoding?t+";base64,"+e.data:"URI"===e.encoding?t+","+decodeURIComponent(e.data):p?t+";base64,"+p(e.data):t+","+encodeURIComponent(e.data)):u?u.call(d,e):void 0},m.revokeObjectURL=function(e){"data:"!==e.substring(0,5)&&h&&h.call(d,e)},s.append=function(e){var n=this.data;if(v&&(e instanceof g||e instanceof v)){for(var s="",a=new v(e),l=0,c=a.length;c>l;l++)s+=String.fromCharCode(a[l]);n.push(s)}else if("Blob"===t(e)||"File"===t(e)){if(!o)throw new r("NOT_READABLE_ERR");var d=new o;n.push(d.readAsBinaryString(e))}else e instanceof i?"base64"===e.encoding&&f?n.push(f(e.data)):"URI"===e.encoding?n.push(decodeURIComponent(e.data)):"raw"===e.encoding&&n.push(e.data):("string"!=typeof e&&(e+=""),n.push(unescape(encodeURIComponent(e))))},s.getBlob=function(e){return arguments.length||(e=null),new i(this.data.join(""),e,"raw")},s.toString=function(){return"[object BlobBuilder]"},a.slice=function(e,t,n){var s=arguments.length;return 3>s&&(n=null),new i(this.data.slice(e,s>1?t:this.data.length),n,this.encoding)},a.toString=function(){return"[object Blob]"},n}(e);return function(e,n){var i=n?n.type||"":"",s=new t;if(e)for(var a=0,o=e.length;o>a;a++)s.append(e[a]);return s.getBlob(i)}}(self);else self.URL=webkitURL;var saveAs=saveAs||navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(e){var t=e.document,n=function(){return e.URL||e.webkitURL||e},i=e.URL||e.webkitURL||e,s=t.createElementNS("http://www.w3.org/1999/xhtml","a"),a=!e.externalHost&&"download"in s,o=function(n){var i=t.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i)},r=e.webkitRequestFileSystem,l=e.requestFileSystem||r||e.mozRequestFileSystem,c=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},d="application/octet-stream",u=0,h=[],m=function(){for(var e=h.length;e--;){var t=h[e];"string"==typeof t?i.revokeObjectURL(t):t.remove()}h.length=0},p=function(e,t,n){t=[].concat(t);for(var i=t.length;i--;){var s=e["on"+t[i]];if("function"==typeof s)try{s.call(e,n||e)}catch(a){c(a)}}},f=function(t,i){var c,m,f,g=this,v=t.type,_=!1,b=function(){var e=n().createObjectURL(t);return h.push(e),e},w=function(){p(g,"writestart progress write writeend".split(" "))},y=function(){(_||!c)&&(c=b(t)),m?m.location.href=c:window.open(c,"_blank"),g.readyState=g.DONE,w()},A=function(e){return function(){return g.readyState!==g.DONE?e.apply(this,arguments):void 0}},T={create:!0,exclusive:!1};return g.readyState=g.INIT,i||(i="download"),a?(c=b(t),s.href=c,s.download=i,o(s),g.readyState=g.DONE,w(),void 0):(e.chrome&&v&&v!==d&&(f=t.slice||t.webkitSlice,t=f.call(t,0,t.size,d),_=!0),r&&"download"!==i&&(i+=".download"),(v===d||r)&&(m=e),l?(u+=t.size,l(e.TEMPORARY,u,A(function(e){e.root.getDirectory("saved",T,A(function(e){var n=function(){e.getFile(i,T,A(function(e){e.createWriter(A(function(n){n.onwriteend=function(t){m.location.href=e.toURL(),h.push(e),g.readyState=g.DONE,p(g,"writeend",t)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&y()},"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=g["on"+e]}),n.write(t),g.abort=function(){n.abort(),g.readyState=g.DONE},g.readyState=g.WRITING}),y)}),y)};e.getFile(i,{create:!1},A(function(e){e.remove(),n()}),A(function(e){e.code===e.NOT_FOUND_ERR?n():y()}))}),y)}),y),void 0):(y(),void 0))},g=f.prototype,v=function(e,t){return new f(e,t)};return g.abort=function(){var e=this;e.readyState=e.DONE,p(e,"abort")},g.readyState=g.INIT=0,g.WRITING=1,g.DONE=2,g.error=g.onwritestart=g.onprogress=g.onwrite=g.onabort=g.onerror=g.onwriteend=null,e.addEventListener("unload",m,!1),v}(self);"undefined"!=typeof module&&(module.exports=saveAs),define("_libs/fileSaver/FileSaver",function(){}),define("text!_common/tracks/tmpl/trackListItem.html",[],function(){return'<div class="content clearfix">\n    <h4>\n        <a data-item="<%= id %>" href="javascript:;" title="<%= i18n.zoomToTrack %>"><%- name%></a>\n        <div class="indicator hidden"></div>\n    </h4>\n    <p class="no-data"><%= i18n.noDataForPeriod %></p>\n    <p class="dates">\n        <span class="nobr"><% print(Date.format(i18n.DateTime.longFormat, startTime))%></span> - <span class="nobr"><% print(Date.format(i18n.DateTime.longFormat, endTime))%></span>\n        <% if(tzName) {%>\n        <br /><%= tzName %>\n        <% } %>\n    </p>\n    <a data-item="<%= id %>" href="javascript:;" class="export nobr hidden"><%= i18n.saveAsPlt %></a>\n</div>\n<div class="controls">\n    <% if(player){ %>\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-play play-track hidden hint hint-left"\n       data-hint="<%= i18n.trackPlayer %>"></i>\n    <% } %>\n\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-paint color-track hint hint-left"\n       data-hint="<%= i18n.changeColor %>"></i>\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-show toggle-track on hint hint-left"\n       data-hint="<%= i18n.showTrack %>"></i>\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-hide toggle-track off hint hint-left"\n       data-hint="<%= i18n.hideTrack %>"></i>\n    <!--<i data-item="<%= id %>" class="icon icon-edit"></i>-->\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-remove remove-track hint hint-left"\n       data-hint="<%= i18n.removeFromMap %>"></i>\n\n</div>\n<div class="clear"></div>'}),jQuery.fn.farbtastic=function(e){return $.farbtastic(this,e),this},jQuery.farbtastic=function(e,t){var e=$(e);if(e.data("farbtastic"))return e.data("farbtastic");var n=new jQuery._farbtastic(e,t);return e.data("farbtastic",n),n},jQuery._farbtastic=function(e,t){var n=this;$(e).html('<div class="farbtastic"><div class="color"></div><div class="wheel"></div><div class="overlay"></div><div class="h-marker marker"></div><div class="sl-marker marker"></div></div>');var i=$(".farbtastic",e);n.wheel=$(".wheel",e).get(0),n.radius=84,n.square=100,n.width=194,navigator.appVersion.match(/MSIE [0-6]\./)&&$("*",i).each(function(){if("none"!=this.currentStyle.backgroundImage){var e=this.currentStyle.backgroundImage;e=this.currentStyle.backgroundImage.substring(5,e.length-2),$(this).css({backgroundImage:"none",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+e+"')"})}}),n.linkTo=function(e){return"object"==typeof n.callback&&$(n.callback).unbind("keyup",n.updateValue),n.color=null,"function"==typeof e?n.callback=e:("object"==typeof e||"string"==typeof e)&&(n.callback=$(e),n.callback.bind("keyup",n.updateValue),n.callback.get(0).value&&n.setColor(n.callback.get(0).value)),this},n.updateValue=function(){this.value&&this.value!=n.color&&n.setColor(this.value)},n.setColor=function(e){var t=n.unpack(e);return n.color!=e&&t&&(n.color=e,n.rgb=t,n.hsl=n.RGBToHSL(n.rgb),n.updateDisplay()),this},n.setHSL=function(e){return n.hsl=e,n.rgb=n.HSLToRGB(e),n.color=n.pack(n.rgb),n.updateDisplay(),this},n.widgetCoords=function(e){var t,i,s=e.target||e.srcElement,a=n.wheel;if("undefined"!=typeof e.offsetX){for(var o={x:e.offsetX,y:e.offsetY},r=s;r;)r.mouseX=o.x,r.mouseY=o.y,o.x+=r.offsetLeft,o.y+=r.offsetTop,r=r.offsetParent;for(var r=a,l={x:0,y:0};r;){if("undefined"!=typeof r.mouseX){t=r.mouseX-l.x,i=r.mouseY-l.y;break}l.x+=r.offsetLeft,l.y+=r.offsetTop,r=r.offsetParent}for(r=s;r;)r.mouseX=void 0,r.mouseY=void 0,r=r.offsetParent}else{var o=n.absolutePosition(a);t=(e.pageX||0*(e.clientX+$("html").get(0).scrollLeft))-o.x,i=(e.pageY||0*(e.clientY+$("html").get(0).scrollTop))-o.y}return{x:t-n.width/2,y:i-n.width/2}},n.mousedown=function(e){document.dragging||($(document).bind("mousemove",n.mousemove).bind("mouseup",n.mouseup),document.dragging=!0);var t=n.widgetCoords(e);return n.circleDrag=2*Math.max(Math.abs(t.x),Math.abs(t.y))>n.square,n.mousemove(e),!1},n.mousemove=function(e){var t=n.widgetCoords(e);if(n.circleDrag){var i=Math.atan2(t.x,-t.y)/6.28;0>i&&(i+=1),n.setHSL([i,n.hsl[1],n.hsl[2]])}else{var s=Math.max(0,Math.min(1,-(t.x/n.square)+.5)),a=Math.max(0,Math.min(1,-(t.y/n.square)+.5));n.setHSL([n.hsl[0],s,a])}return!1},n.mouseup=function(){$(document).unbind("mousemove",n.mousemove),$(document).unbind("mouseup",n.mouseup),document.dragging=!1},n.updateDisplay=function(){var e=6.28*n.hsl[0];$(".h-marker",i).css({left:Math.round(Math.sin(e)*n.radius+n.width/2)+"px",top:Math.round(-Math.cos(e)*n.radius+n.width/2)+"px"}),$(".sl-marker",i).css({left:Math.round(n.square*(.5-n.hsl[1])+n.width/2)+"px",top:Math.round(n.square*(.5-n.hsl[2])+n.width/2)+"px"}),$(".color",i).css("backgroundColor",n.pack(n.HSLToRGB([n.hsl[0],1,.5]))),"object"==typeof n.callback?($(n.callback).css({backgroundColor:n.color,color:n.hsl[2]>.5?"#000":"#fff"}),$(n.callback).each(function(){this.value&&this.value!=n.color&&(this.value=n.color)})):"function"==typeof n.callback&&n.callback.call(n,n.color)},n.absolutePosition=function(e){var t={x:e.offsetLeft,y:e.offsetTop};if(e.offsetParent){var i=n.absolutePosition(e.offsetParent);t.x+=i.x,t.y+=i.y}return t},n.pack=function(e){var t=Math.round(255*e[0]),n=Math.round(255*e[1]),i=Math.round(255*e[2]);return"#"+(16>t?"0":"")+t.toString(16)+(16>n?"0":"")+n.toString(16)+(16>i?"0":"")+i.toString(16)},n.unpack=function(e){return 7==e.length?[parseInt("0x"+e.substring(1,3))/255,parseInt("0x"+e.substring(3,5))/255,parseInt("0x"+e.substring(5,7))/255]:4==e.length?[parseInt("0x"+e.substring(1,2))/15,parseInt("0x"+e.substring(2,3))/15,parseInt("0x"+e.substring(3,4))/15]:void 0},n.HSLToRGB=function(e){var t,n,i=e[0],s=e[1],a=e[2];return n=.5>=a?a*(s+1):a+s-a*s,t=2*a-n,[this.hueToRGB(t,n,i+.33333),this.hueToRGB(t,n,i),this.hueToRGB(t,n,i-.33333)]},n.hueToRGB=function(e,t,n){return n=0>n?n+1:n>1?n-1:n,1>6*n?e+6*(t-e)*n:1>2*n?t:2>3*n?e+6*(t-e)*(.66666-n):e},n.RGBToHSL=function(e){var t,n,i,s,a,o,r=e[0],l=e[1],c=e[2];return t=Math.min(r,Math.min(l,c)),n=Math.max(r,Math.max(l,c)),i=n-t,o=(t+n)/2,a=0,o>0&&1>o&&(a=i/(.5>o?2*o:2-2*o)),s=0,i>0&&(n==r&&n!=l&&(s+=(l-c)/i),n==l&&n!=c&&(s+=2+(c-r)/i),n==c&&n!=r&&(s+=4+(r-l)/i),s/=6),[s,a,o]},$("*",i).mousedown(n.mousedown),n.setColor("#000000"),t&&n.linkTo(t)},define("_libs/farbtastic/farbtastic",function(){}),define("_common/tracks/views/TrackListView",["jquery","underscore","abstracts/View","_libs/fileSaver/FileSaver","text!_common/tracks/tmpl/trackListItem.html","_libs/farbtastic/farbtastic","css!_libs/farbtastic/farbtastic.css"],function(e,t,n,i,s){s=t.template(s);var a=n.extend({constructor:function(){this._module=null,n.apply(this,arguments)},initialize:function(e){var t=this;e.container&&(this._module=e.module,this.listenTo(this.model,"request",function(){t.$el.addClass("loading")}).listenTo(this.model,"sync",function(){t.$el.removeClass("loading");var n=t.$el.find("h4");if(t.model.hasData()){var i=t.$el.find(".indicator").removeClass("hidden");i[0].style.background=t.model.get("color"),"Blob"in window&&(t.$el.find(".export").removeClass("hidden"),e.player&&t.model.get("points")&&t.model.get("points").length>1&&t.$el.find(".play-track").removeClass("hidden"))}else t.$el.addClass("no-data"),n.find(".indicator").remove(),n.find("a").removeAttr("title")}).listenTo(this.model,"remove",function(){t.stopListening(t.model),t.remove()}).listenTo(this.model,"change:hidden",function(e,n){n?t.$el.addClass("h"):t.$el.removeClass("h")}).listenTo(this.model,"change:color",function(e,n){t.$el.find(".indicator")[0].style.background=n}),this.render(e))},render:function(t){var n="";if(this.model.has("tzId")){var i=App.getTimezone({id:this.model.get("tzId")});i.offset!=60*App.getUserTimezone()&&(n=App.getFullTimezoneName(i))}var a=s(e.extend({},this.model.attributes,{i18n:this._module.getTexts(),tzName:n,player:t.player}));this.$el.append(a).appendTo(t.container),this._initColorPicker()},_initColorPicker:function(){var t=this,n=this.$el.find(".indicator")[0],i=t.$el.parent(),s=40,a="track-picker",o=e(window);this.$el.find(".color-track").on("click",function(r){r.stopPropagation();var l=t.model.get("color"),c=t.$el.position();e("#"+a).remove();var d=e('<div id="'+a+'" class="colorpicker"></div>').appendTo(i),u=c.top+s,h=i[0].getBoundingClientRect().top,m=195,p=o.height();p>u+h+m?d[0].style.top=u+"px":(i.parent().scrollTo(1e4),d[0].style.top=p-m-h+"px"),d.farbtastic(function(e){n.style.background=e}).on("click",function(e){e.stopPropagation()});var f=d.data("farbtastic").setColor(l);d.on("mouseup",function(){l!=f.color&&t.model.set("color",f.color)}),e(document).one("click",function(){d.remove()})})}});return a}),define("text!_common/tracks/player/tmpl/player.html",[],function(){return'<div class="player-map">\n\n</div>\n'}),define("text!_common/tracks/player/tmpl/controls.html",[],function(){return'<div class="player-main-params">\n    <table>\n        <tbody>\n        <tr>\n            <td class="th" rowspan="2" style="width:60px">\n                <input class="index input-mini no-margin" type="number" min="0" max="<%= totalPoints-1 %>" value="0" />\n            </td>\n            <td class="th"><%= i18n.time %></td>\n            <td class="th"><%= i18n.coords %></td>\n            <td class="th"><%= i18n.runDistance %>, <%= i18n.km %></td>\n            <td class="th"><%= i18n.speed %>, <%= i18n.kmh %></td>\n            <td class="th"><%= i18n.course %></td>\n            <td class="th"><%= i18n.altitude %>, <%= i18n.m %></td>\n        </tr>\n        <tr>\n            <td class="ts"><%= Date.format(i18n.DateTime.longFormat, point.date * App.MS) %></td>\n            <td class="coords">--</td>\n            <td class="distance">0.00</td>\n            <td class="speed"><% print( point.speed <= minMoveSpeed ? 0 : Math.round(point.speed) ) %></td>\n            <td class="course"><%= point.course %></td>\n            <td class="alt"><%= point.alt %></td>\n        </tr>\n        </tbody>\n    </table>\n\n</div><!--/obj-info-->\n\n<div class="player-row-fluid">\n    <div class="player-col player-col-left">\n        <div class="player-buttons">\n            <button class="btn btn-to-start"><i class="icon-step-backward"></i></button>\n            <button class="btn btn-toggle btn-play"><i class="icon-play"></i><i class="icon-pause"></i></button>\n        </div>\n        <div class="slider play-speed" title="<%= i18n.trackPlaySpeed %>"></div>\n        <div class="player-point-info"></div>\n    </div>\n    <div class="player-col player-col-right">\n        <div class="play-progress">\n            <span class="time time-start"><%= startTime %></span>\n            <span class="index-finish"><%= totalPoints-1 %></span>\n            <span class="time time-finish"><%= finishTime %></span>\n            <div class="slider"></div>\n        </div>\n        <div class="chart-cont">\n            <div class="sensors-chart"></div>\n        </div>\n    </div>\n</div>\n'}),define("text!_common/tracks/player/tmpl/sensors.html",[],function(){return'<ul class="player-sensors-list">\n    <% _.each(discrets, function(sensorData) { %>\n    <li class="player-sensors-list-item discret <% if(sensorData.state) {%>on<% } else {%>off<% } %>">\n        <%- sensorData.name %>\n    </li>\n    <% }); %>\n    <li class="player-sensors-list-item power <% if(power.state === 0) {%>on<% } else {%>off<% } %>">\n        <%- power.name %>\n    </li>\n</ul>'}),define("_common/tracks/player/views/TrackPlayerView",["jquery","jqueryui","underscore","jface","geo","_libs/charts/Chart","abstracts/View","maps/MapsModule","text!_common/tracks/player/tmpl/player.html","text!_common/tracks/player/tmpl/controls.html","text!_common/tracks/player/tmpl/sensors.html"],function(e,t,n,i,s,a,o,r,l,c,d){l=n.template(l),c=n.template(c),d=n.template(d);var u,h=300,m="DD.MM HH:mm:ss",p={},f=null,g=null,v=null,_=null,b=null,w=o.extend({constructor:function(){this.module=null,this.playing=!1,this._mapsModule=null,this._tracksModule=null,this._ts=[],this._tsIndexes={},this._playTimeout=null,this._slider=null,this._btnPlay=null,this._btnToStart=null,this._speedSlider=null,this._chart=null,o.apply(this,arguments)},initialize:function(e){this.module=e.module,p=e.module.getTexts(),this._i=0,this.render(e)},render:function(e){var t=this,n=this.model,s=n.get("points"),a=this.model.formatUTC(m,n.get("startTime")),o=this.model.formatUTC(m,n.get("endTime"));v=this.model.get("obj"),i.showOverlay(),i.window.open({winId:"track-player",headerHtml:v.get("name")+"[#"+v.get("extId")+"] "+a+"-"+o,contentHtml:l({i18n:p}),footerHtml:c({i18n:p,minMoveSpeed:v.get("minSpeed"),totalPoints:s.length,startTime:a,finishTime:o,point:s[0]}),width:1e3,centered:!0,dieAfter:0,openCallback:function(){t.setElement(this),t.$el.addClass("loading")},activateCallback:function(){y.initMap.call(t),y.fillTimestamps.call(t),App.subscribe(f.getEventsPrefix()+".ready",{context:t,callback:function(){setTimeout(function(){y.initTracksModule.call(t,e),y.drawTrack.call(t).done(function(){y.drawObject.call(t),y.initControls.call(t),y.buildSensorsChart.call(t),t.$el.removeClass("loading")})},500)}})},closeCallback:function(){i.hideOverlay(),y.onClose.call(t)}})},play:function(){var e=this,t=this.model.get("points"),n=t[this._i];return this.playing=!0,"undefined"==typeof t[++this._i]?(this._i--,this.pause(),!1):(y.setStateInPoint.call(this,n),y.moveOnMap.call(e,n,t[this._i]).done(function(){e._slider.slider("value",e._ts[e._i]),y.showPointInfo.call(e,e._i,t[e._i]),e.play()}),!0)},pause:function(){this.playing&&(this._playTimeout&&clearTimeout(this._playTimeout),this._playTimeout=null,this._btnPlay.removeClass("btn-pause").addClass("btn-play"),b&&b.trigger("stop"),this.playing=!1)},jump:function(e){var t={model:v,to:e,animate:!1};y.setStateInPoint.call(this,e),b.trigger("place",t),b.trigger("follow",{center:[e.lat,e.lon]})},clear:function(){},destroy:function(){this.$el.length&&this.$el.trigger("jw.close"),this.remove()}}),y={initMap:function(){f=new r({id:this.module.id+"/maps",container:this.$el.find(".player-map"),parent:this.module,compass:!0,ruler:!0,search:!1,traffic:!1,coords:!1,scale:!0,minimap:!1,layersControl:!0})},fillTimestamps:function(){var e=this.model.get("points");this._ts=new Array(e.length);for(var t=0,n=e.length;n>t;t++)this._ts[t]=e[t].date*App.MS,this._tsIndexes[this._ts[t]]=t},initTracksModule:function(e){g=e.tracksModule,g.setMaps(f)},initControls:function(){for(var t=this,n=this.model.get("points"),i=this._ts,s=this._tsIndexes,a=0,o=n.length;o>a;a++)i[a]=n[a].date*App.MS,s[i[a]]=a;this._slider=this.$el.find(".play-progress .slider").slider({min:i[0],max:i[o-1],stepValues:i,start:function(){t.pause()},slide:function(a,r){s[r.value];var l,c=[],d=i[o-1]-i[0];return e.each(i,function(e,t){c[e]=Math.abs(r.value-t),c[e]<d&&(d=c[e],l=e)}),d?(e(this).slider("value",i[l]),y.showPointInfo.call(t,l,n[l]),!1):void 0},stop:function(e,i){t._i=s[i.value],t.jump(n[t._i])}}),this.$el.find(".index").on("change",function(){var e=parseInt(this.value);y.forcePoint.call(t,e,n[e])}),this._btnPlay=this.$el.find(".btn-toggle").on("click",function(){t.playing?(t.pause(),t._btnPlay.addClass("btn-play").removeClass("btn-pause")):t.play()&&t._btnPlay.removeClass("btn-play").addClass("btn-pause")}),this._btnToStart=this.$el.find(".btn-to-start").on("click",function(){y.forcePoint.call(t,0,n[0])}),this._speedSlider=this.$el.find(".play-speed").slider({min:5,max:50,step:5,value:this.module.get("playSpeed"),stop:function(e,n){t.module.set("playSpeed",n.value),t.playing&&(t.pause(),t._btnPlay.removeClass("btn-play").addClass("btn-pause"),t.play())}})},drawTrack:function(){var t=this,n=new e.Deferred,i={objectId:[v.id],from:Date.sqlFormat(this.model.get("startTime")),to:Date.sqlFormat(this.model.get("endTime")),tz:App.getUserTimezone(),details:1};return this.model.fetch({data:i,silent:!0}).done(function(){var e=t.model;e.set("detailed",1),g.items.add(e),g.trigger("tracksuccess",e),e.trigger("sync"),u=e,n.resolve()}).fail(function(){n.reject()}),n},drawObject:function(){if(y.addItemToMap.call(this),b){_=f.addLayersGroup({layers:[b],groupCssClass:"mobile-arrows",clusters:!1});var e=this.model.get("points")[0];y.setStateInPoint.call(this,e),y.showPointInfo.call(this,0,e)}},addItemToMap:function(){var e=this.model,t=e.get("points"),n=t[0],i="complex-icon obj obj-mobile park",s=App.buildObjTitle(v);b=f.getWidget().buildComplexMarker({lat:n.lat,lon:n.lon,html:'<i class="i"></i><span class="name">'+s+"</span>",className:i,dataId:v.id,animated:!0,model:v}),this.listenTo(v,"change:park",function(){b.trigger("toggleclass",{name:"park"})}).listenTo(v,"change:course",function(e,t){y.onCourseChange(t)})},moveOnMap:function(t,n){var i=new e.Deferred,a={model:v,to:n},o=s.getDistanceBetweenPointsSimple(t.lat,t.lon,n.lat,n.lon);if(o>h)b.trigger("place",a),b.trigger("follow",{center:[n.lat,n.lon]}),i.resolve();else{var r=(n.date-t.date)*App.MS,l=r/this.module.get("playSpeed");a.animate=[[t.lat,t.lon],[n.lat,n.lon]],a.interval=l,b.trigger("place",a),b.trigger("follow",{center:[n.lat,n.lon]}),this._playTimeout=setTimeout(function(){i.resolve()},l)}return i},setStateInPoint:function(e){y.pointIsPark.call(this,e)?v.set({speed:0,park:!0}):v.set({speed:e.speed,park:!1}),v.set("course",e.course)},pointIsPark:function(e){for(var t,n,i=this.model.get("parks")||[],s=i.length;s--;)if(t=i[s],n=e.date*App.MS,n>=t.start.getTime()&&n<=t.end.getTime())return!0;return!1},onCourseChange:function(e){b.trigger("rotate",{angle:e})},forcePoint:function(e,t){this.pause(),this._i=e,this._slider.slider("value",this._ts[e]),y.showPointInfo.call(this,e,t),this.jump(t)},showPointInfo:function(e,t){var n=0,i=this.$el.find(".index"),s=t.date*App.MS,a=this.$el.find(".ts"),o=this.$el.find(".speed"),r=this.$el.find(".course"),l=this.$el.find(".alt"),c=this.$el.find(".distance"),u=this.$el.find(".coords"),h=y.parseSensorsState.call(this,t.state);if(i.val(e),a.text(this.model.formatUTC(m,s)),y.pointIsPark.call(this,t)||(n=Math.round(t.speed)),o.text(n),r.text(t.course),l.text("alt"in t?t.alt:"-"),c.text((t.dist/1e3).toFixed(2)),u.text(t.lat.toFixed(4)+","+t.lon.toFixed(4)),this.$el.find(".player-point-info").html(d(h)),this._chart)try{var p=this._chart.getChart(),f=p.series.items[0].realYAxis,g=f.actualVisibleMaximum,v=f.actualVisibleMinimum;if(s>=v&&g>=s){var _=(s-v)/(g-v),b=f.length*_;p._renderCrosshairs(b||1,50)}}catch(w){}},parseSensorsState:function(e){for(var t,n=this.module.get("sensorsNames"),i=n.length-1,s=new Array(i);i--;)t=Math.pow(2,i),s[i]={name:n[i],state:t&e?1:0};return{discrets:s,power:{name:n[n.length-1],state:Math.pow(2,n.length-1)&e?1:0}}},buildSensorsChart:function(){for(var e,t,n,i,s,o,r=this.$el.find(".sensors-chart"),l=this.model.get("points"),c=this.module.get("sensorsNames"),d=c.length,u=new Array(d),h={},p=r.height(),f=r.width(),g=l[0].date*App.MS,v=l[l.length-1].date*App.MS,_=[],b=0;d>b;++b)u[b]=null,h[b]=[];for(var w=0,A=l.length;A>w;++w)for(i=y.parseSensorsState.call(this,l[w].state),e=i.discrets,e[d-1]=i.power,b=0;d>b;++b)o=c[b],t=e[b].state,n=l[w].date*App.MS,d-1>b&&1===t||b===d-1&&0===t?u[b]||(u[b]=n):(d-1>b&&0===t||b===d-1&&1===t)&&u[b]&&(h[b].push([o,u[b],n]),u[b]=null,!s&&(s=[n,n]));for(!s&&(s=[l[0].date*App.MS,l[0].date*App.MS]),n=l[l.length-1].date*App.MS,b=d-1;b>=0;b--)o=c[b],u[b]&&(h[b].push([o,u[b],n]),u[b]=null),h[b].length||(h[b][0]=[o,s[0],s[0]]),_=_.concat(h[b]);this._chart=new a(r,{width:f+"px",height:p+"px",title:!1,animation:!1,shadows:{enabled:!1},border:{visible:!1},legend:{visible:!1},background:"#f5f5f5",crosshairs:{enabled:!0,hLine:!1,vLine:{strokeStyle:"#db492c"},snapToDataPoints:!1},axes:[{type:"dateTime",location:"bottom",strokeStyle:"black",lineWidth:1,margin:5,zoomEnabled:!0,labels:{stringFormat:"HH:MM dd.mm.yyyy",fillStyle:"black",font:"10px sans-serif",angle:0},crossing:g,maximum:v,bands:null},{type:"category",visible:!1,majorTickMarks:{visible:!1},lineWidth:0,labels:{visible:!1}}],series:[{type:"rangeBar",title:!1,fillStyle:"#57BA29",pointWidth:.5,data:_}]}),r.bind("tooltipFormat",function(e,t){var n=t.x,i=t.from,s=t.to,a="<strong>"+n+"</strong><br />";
return a+=this.model.formatUTC(m,i)+" - "+this.model.formatUTC(m,s)}.bind(this))},onClose:function(){this.pause(),f&&f.destroy()&&(f=null),g.items.remove(g.items.models),_.removeLayer(b),_.trigger("destroy"),this.stopListening(v),App.unsubscribe(this),v=null,b=null,_=null,g=null}};return w}),define("_common/tracks/player/TrackPlayerModule",["jquery","underscore","abstracts/Module","_common/tracks/Track","_common/tracks/player/views/TrackPlayerView"],function(e,t,n,i,s){var a=10,o="",r="",l=n.extend({constructor:function(){n.apply(this,arguments)},defaults:{playSpeed:a,sensorsNames:[]},initialize:function(){this.set("playSpeed",this.getUserData("playSpeed")||a),this._i18n=this.get("parent").getTexts(),o=this._i18n.discretSensor,r=this._i18n.power.ucFirst();var e=this.get("parent").constructor;this.modules.tracks=new e({id:this.id+"/tracks",container:!1,parent:this,options:{showPoints:this.get("parent").get("showPoints"),colorTracks:this.get("parent").get("colorTracks"),speedColors:this.get("parent").get("speedColors"),list:!1}}),c.bindEvents.call(this)},open:function(){this._view||(this._view=new s({model:this.get("track"),module:this,tracksModule:this.modules.tracks}))},close:function(){this._view&&this._view.destroy(),this._view=null},getTexts:function(){return this._i18n}}),c={bindEvents:function(){var e=this,n=this.get("parent");this.on("change:track",function(t,n){if(e.previous("track")&&e._view&&e._view.clear(),n){var i=n.get("obj").clone();i.fetch({url:App.getBaseUrl()+"objects/obj-details/",data:{objectId:[i.id],tz:App.getUserTimezone()},cache:!1}).done(function(){i.set("speed",0),i.set("course",0),i.set("sensorsState",0),i.set("park",!0);var t=c.getDiscretsNamesFromObj(i);t.push(i.get("power")&&i.get("power").name||r),e.set("sensorsNames",t),n.set("obj",i),e.open()})}else c.onNoTrack.call(e)}).on("change:playSpeed",function(t,n){e.setUserData("playSpeed",n)}),this.listenTo(n,"change",function(){t.each(["showPoints","colorTracks","speedColors"],function(t){n.hasChanged(t)&&e.modules.tracks.set(t,n.get(t))})})},getDiscretsNamesFromObj:function(e){for(var t=6,n=new Array(t),i=e.get("discrets"),s=t;s--;)n[s]=o+" "+(s+1);if(!i)return n;for(var a in i)i[a].name&&(n[a-1]=i[a].name);return n},onNoTrack:function(){this._view&&this._view.destroy(),this._view=null}};return l}),define("text!_common/tracks/tmpl/tracks.html",[],function(){return'<li id="tracks" class="<% if(loading) {%>loading<% } %><% if(active) {%> active<% } %>">\n    <div class="tab-toggle-container hint hint-right" data-hint="<%= name %>">\n        <a class="tab-toggle" href="#<%= key %>">\n            <i class="svg-icon svg-icon-track"></i>\n            <span><%- name %></span>\n        </a>\n    </div>\n    <div id="tracks-content" class="tab-hor-content">\n        <div class="box-header module-header append">\n            <h2>\n                <%= i18n.tracksCountText.replace(\'#n#\', \'<span class="nb-items">0</span>\') %>\n            </h2>\n            <div class="dropdown module-settings add-on">\n                <a class="dropdown-toggle" data-toggle="dropdown" href="#">\n                    <i class="svg-icon svg-icon-cog"></i>\n                </a>\n                <ul class="dropdown-menu nav nav-list" role="menu">\n                    <li><a href="javascript:;" class="hide-all"><%= i18n.hideAll %></a></li>\n                    <li><a href="javascript:;" class="remove-all-empty"><%= i18n.removeEmptyTracks %></a></li>\n                    <li><a href="javascript:;" class="remove-all"><%= i18n.clearTracksList %></a></li>\n                </ul>\n            </div>\n            <% if(adding) {%>\n            <div class="add-on">\n                <a class="btn-add" href="javascript:;" title="<%= i18n.add.ucFirst() %>">\n                    <i class="svg-icon svg-icon-plus"></i>\n                </a>\n            </div>\n            <% } %>\n        </div>\n        <div class="module-content tracks-list">\n            <ul class="items-briefs">\n\n            </ul>\n        </div>\n    </div>\n</li>\n\n'}),define("text!_common/tracks/tmpl/settings.html",[],function(){return'<h4><%= i18n.tracks.ucFirst() %></h4>\n\n<div class="control-group">\n    <div class="field">\n        <label data-setting="tracks.showPoints" class="checkbox stp"><input type="checkbox" <% if(showPoints) {%> checked<% } %> value="1">\n            <%= i18n.showTrackPoints %></label>\n    </div>\n    <div class="field">\n        <label data-setting="tracks.colorTracks" class="checkbox tct"><input type="checkbox" <% if(colorTracks) {%> checked<% } %> value="1">\n            <%= i18n.colorTracks %></label>\n        <ul class="mtsc">\n            <li><a title="<%= i18n.clickToChange %>" class="i-left">\n                <i class="color-picker" data-setting="tracks.speedColors" data-index="0"\n                   style="background-color:<%= speedColors[0] %>"></i></a>\n                <%= i18n.speedLessThan %> <input type="text" class="tsl input-mini positive no-margin"\n                                                 value="<%= speedLimits[0] %>" name="speedLimit1" data-index="0" /> <%= i18n.kmh %>\n            </li>\n            <li> <a title="<%= i18n.clickToChange %>" class="i-left">\n                <i class="color-picker" data-setting="tracks.speedColors" data-index="1"\n                   style="background-color:<%= speedColors[1] %>"></i></a>\n                <%= i18n.speedFrom %> <span class="speed-limit1"><%= speedLimits[0] %></span> <%= i18n.to %> <span class="speed-limit2"><%= speedLimits[1] %></span> <%= i18n.kmh %>\n            </li>\n            <li><a title="<%= i18n.clickToChange %>" class="i-left">\n                <i class="color-picker" data-setting="tracks.speedColors" data-index="2"\n                   style="background-color:<%= speedColors[2] %>"></i></a>\n                <%= i18n.speedGreaterThan %> <input type="text" class="tsl input-mini positive no-margin"\n                                                    value="<%= speedLimits[1] %>" name="speedLimit2" data-index="1" /> <%= i18n.kmh %>\n            </li>\n        </ul>\n\n        <div class="context-menu" id="speedColorsMenu">\n            <i style="background:#0000FF;"></i>\n            <i style="background:#0086E5;"></i>\n            <i style="background:#0033A8;"></i>\n            <i style="background:#2D15B1;"></i>\n            <i style="background:#580DAD;"></i>\n            <i style="background:#00FF00;"></i>\n            <i style="background:#009947;"></i>\n            <i style="background:#00FFB2;"></i>\n            <i style="background:#59FF00;"></i>\n            <i style="background:#447F00;"></i>\n            <i style="background:#FF0000;"></i>\n            <i style="background:#FF6400;"></i>\n            <i style="background:#FF9700;"></i>\n            <i style="background:#FFBB00;"></i>\n            <i style="background:#FFDB00;"></i>\n        </div>\n    </div>\n</div>'}),define("_common/tracks/views/TracksListView",["jquery","underscore","abstracts/View","_libs/fileSaver/FileSaver","_common/tracks/views/TrackListView","_common/tracks/player/TrackPlayerModule","text!_common/tracks/tmpl/tracks.html","text!_common/tracks/tmpl/settings.html"],function(e,t,n,i,s,a,o,r){var l=null,c=n.extend({constructor:function(){return n.apply(this,arguments)},initialize:function(t){var n=this;this.listenTo(this.model,"activate",function(){n.$el.addClass("active")}).listenTo(this.model,"deactivate",function(){n.$el.removeClass("active")}).listenTo(this.model.items,"add",function(e){new s({tagName:"li",className:"item-brief track-brief",model:e,module:this.model,player:1,container:n.$el.find("ul.items-briefs")});var t=n.$el.find(".tracks-list");t.scrollTop(t[0].scrollHeight),n.$el.find(".nb-items").text(n.model.items.length)}).listenTo(this.model.items,"remove",function(){n.$el.find(".nb-items").text(n.model.items.length)}).listenTo(App,"openalarms",function(){l&&l.close()}),e("#settings").length?d.initSettings.call(this):this.listenTo(App,"settingsready",function(){d.initSettings.call(n)}),this.render(t)},render:function(n){var i=n.container,s=this.model.getTexts(),r=t.template(o,{loading:!0,active:!1,key:this.model.id,name:s.tracks.ucFirst(),adding:this.model.get("options").addFromList,showPoints:this.model.get("showPoints"),color:this.model.get("color"),i18n:s});i.find("[data-placeholder="+n.placeholder+"]").replaceWith(r),this.setElement(i.find("#tracks"));var c=this;this.$el.on("click",".track-brief .toggle-track",function(){var t=c.model.items.get(e(this).attr("data-item"));t.set("hidden",!t.get("hidden"))}).on("click",".track-brief .remove-track",function(){var t=c.model.items.get(e(this).attr("data-item"));c.model.items.remove(t)}).on("click",".track-brief h4 a",function(){var t=c.model.items.get(e(this).attr("data-item"));return t.get("points")?(c.model.trigger("itemselect",t),void 0):!1}).on("click",".play-track",function(){var t=c.model.items.get(e(this).attr("data-item"));l?l.set("track",null):l=new a({id:c.model.id+"/player",parent:c.model}),l.set("track",t.clone())}),"Blob"in window&&this.$el.on("click",".export",function(){var t=c.model.items.get(e(this).attr("data-item"));return t.get("points")?(showCursor(),e.ajax({url:App.getBaseUrl()+"plt/track/",dataType:"text",data:{objectId:t.get("objectId"),from:Date.sqlFormat(t.get("startTime")),to:Date.sqlFormat(t.get("endTime")),tz:App.getUserTimezone()},success:function(e){saveAs(new window.Blob([e],{type:"text/plain;charset="+document.characterSet}),"track_obj_"+t.get("obj").get("extId")+".plt")},complete:hideCursor}),void 0):!1}),this.$el.on("click",".remove-all",function(){c.model.items.remove(c.model.items.models),c.$el.find(".nb-items").text("0")}).on("click",".remove-all-empty",function(){var e=c.model.items,t=[];e.each(function(e){e.hasData()||t.push(e)}),e.remove(t),c.$el.find(".nb-items").text(e.length)}).on("click",".hide-all",function(){c.model.items.each(function(e){e.set("hidden",!0)})}).on("click",".btn-add",function(){c.model.trigger("needtrack")}),this.$el.removeClass("loading")}}),d={initSettings:function(){var n=this,i=e("#settings").find(".tracks").removeClass("hidden"),s=this.model.get("speedColors");i.html(t.template(r,{i18n:this.model.getTexts(),colorTracks:this.model.get("colorTracks"),speedLimits:this.model.getSpeedLimits(),speedColors:s,showPoints:this.model.get("showPoints")})),e.fn.contextmenu&&(i.find("a").contextmenu({menu:e("#speedColorsMenu"),position:{my:"left top"},before:function(t,n){n.active.data("tool",e(this).find(".color-picker"))}}).on("click",function(t){e(this).contextmenu("open",t)}),e("#speedColorsMenu").on("click","i",function(){var t=e(this),i=t.parent().data("tool")||null;if(i&&i.length){var s=t.css("background-color"),a=n.model.get("speedColors").slice(0);i.css("background",s),a[i.data("index")]=s,n.model.set("speedColors",a)}})),i.find("input.tsl").numeric({decimal:".",negative:!1}).on("change",function(){var t=e(this),i=t.data("index"),s=parseFloat(e(this).val()),a=e("input.tsl[data-index="+(0==i?1:0)+"]");if(0==i)0>=s&&(s=1,t.val(s)),a.val()<=s&&a.val(s+1).trigger("change");else if(1==i){var o=Math.max(s-1,1);o>=s&&(s=o+1,t.val(s)),a.val()>=s&&a.val(o).trigger("change")}e(".speed-limit"+(i+1)).text(s),n.model.setSpeedLimit(i,s)}),i.find(".stp input").on("click",function(){n.model.set("showPoints",this.checked?1:0)}),i.find(".tct input").on("click",function(){n.model.set("colorTracks",this.checked?1:0)})}};return c}),define("text!_common/tracks/tmpl/park.html",[],function(){return'<div class="track-info park-info">\n<h5><%= title %></h5>\n<ul class="features">\n    <li><%= i18n.parkBegin %>: <strong data-value="<%= data.start.getTime() %>"><%= startStr %></strong></li>\n    <li><%= i18n.parkEnd %>: <strong data-value="<%= data.end.getTime() %>"><%= endStr %></strong></li>\n    <li><%= i18n.parkTime %>: <strong data-value="<%= data.end.getTime() - data.start.getTime() %>"><%= timeStr %></strong></li>\n    <li><%= i18n.address %>: <strong data-geoid="<%= data.geoId || 0 %>" class="address"><i class="svg-icon svg-icon-spinner icon-spin"></i>\n        <%- addressStr %>\n    </strong></li>\n    <% if(\'alt\' in data) {%>\n    <li><%= i18n.altitude %>: <strong data-value="<%= data.alt %>"><%= data.alt %> <%= i18n.m %></strong></li>\n    <% } %>\n</ul>\n</div>'}),define("text!_common/tracks/tmpl/point.html",[],function(){return'<div class="track-info">\n    <h5><%= title %></h5>\n    <ul class="features">\n        <li><%= i18n.time.ucFirst() %>: <strong data-value="<%= data.date %>"><%= dateStr %></strong></li>\n        <li><%= i18n.speed.ucFirst() %>: <strong data-value="<%= data.speed %>"><%= Math._round(data.speed,2) %> <%= i18n.kmh %></strong></li>\n        <% if(\'alt\' in data) {%>\n        <li><%= i18n.altitude %>: <strong data-value="<%= data.alt %>"><%= data.alt %> <%= i18n.m %></strong></li>\n        <% } %>\n        <% if(\'rid\' in data) {%>\n        <li>RID: <strong><%= data.rid %></strong></li>\n        <% } %>\n    </ul>\n</div>'}),define("_common/tracks/views/TrackMapView",["jquery","underscore","geo","abstracts/View","util","_common/tracks/TrackParkPoint","text!_common/tracks/tmpl/park.html","text!_common/tracks/tmpl/point.html"],function(e,t,n,i,s,a,o,r){function l(e,t){e=e.replace("#","");var n=parseInt(e,16),i=[255&n>>16,255&n>>8,255&n,t||1];return"rgba("+i.join(",")+")"}function c(e){var t=null==e||"null"==e?"no data":e;return t=t.replace(", ",""),t=t.replace("/( )?-, /",", ")}r=t.template(r),o=t.template(o);var d=1e3,u=i.extend({constructor:function(){this._module=null,this._parentView=null,this._maps,this._polyline=null,this._parksLayer=null,this._startMarker=null,this._finishMarker=null,this._popup=null,this._i18n={},i.apply(this,arguments)},initialize:function(e){this._module=e.module,this._parentView=e.parent,this._maps=e.maps,this._i18n=this._module.getTexts();var t=this;this.listenTo(App,"objectsGroupingChange",function(){h.clearMarkers.call(t),h.putMarkers.call(t)}),this.listenTo(this.model,"sync",function(){h.rebuildPolyline.call(t),t._polyline&&t._polyline.trigger("show"),h.putMarkers.call(t),h.putPoints.call(t)}).listenTo(this.model,"remove",function(){t.stopListening(t.model),t._polyline&&t._polyline.trigger("destroy"),h.clearMarkers.call(t)}).listenTo(this.model,"change:hidden",function(e,n){var i=n?"hide":"show";t._polyline&&t._polyline.trigger(i),!n&&t._module.get("showPoints")&&h.putPoints.call(t),h.triggerOnMarkers.call(t,i)}).listenTo(this.model,"change:color",function(){h.onChangeColoring.call(t),h.clearMarkers.call(t),t.model.get("hidden")?t.listenToOnce(t.model,"change:hidden",function(){h.putMarkers.call(t)}):h.putMarkers.call(t)}).listenTo(this._module,"change:showPoints",function(e,n){n?h.putPoints.call(t):h.removePoints.call(t)}).listenTo(this._module,"change:colorTracks change:speedColors",function(){h.onChangeColoring.call(t)})}}),h={makeSegments:function(){var e=[],t=this.model.get("points"),i=[];if(!t||t.length<2||this.model.get("start")==this.model.get("finish"))return e;var s=0,a=this._module.getSpeedLimits(),o=this._module.get("colorTracks")&&a.length,r=o?this._module.get("speedColors")[0]:this.model.get("color"),l={weight:2,weightArray:{9:4,12:6,15:8},color:r,opacity:.8,dashArray:null,decor:!0,decorMinZoom:14},c=null,u=0,h=t[0].date,m=(t[t.length-1].date-h,0),p={};if(o){var f=this._module.get("speedColors"),g=0;p[0]=f[0]}i[0]=t[0],o&&(m=t[0].speed,m>a[1]?g=2:m>a[0]&&(g=1),p[0]=f[g],l.color=f[g]);for(var v=1,_=t.length;_>v;++v)m=t[v].speed,u=Math.round(100*(v/_)),s=n.getDistanceBetweenPointsSimple(t[v].lat,t[v].lon,t[v-1].lat,t[v-1].lon),s>d?(i.length>1&&(e.push(this._maps.buildPolyline(i,l)),i=[]),c=[t[v-1],t[v]],l.dashArray=[5,15]):c&&(c=null,l.dashArray=null),o?g>0?m>a[1]?(1==g?(i.push(t[v]),e.push(this._maps.buildPolyline(c?c:i,l)),g=2,p[u]=f[2],l.color=f[g],c||(i=[])):c&&e.push(this._maps.buildPolyline(c,l)),c&&(c=null,l.dashArray=null)):m>a[0]?(2==g?(i.push(t[v]),e.push(this._maps.buildPolyline(c?c:i,l)),g=1,p[u]=f[1],l.color=f[g],c||(i=[])):c&&e.push(this._maps.buildPolyline(c,l)),c&&(c=null,l.dashArray=null)):(i.push(t[v]),e.push(this._maps.buildPolyline(c?c:i,l)),g=0,p[u]=f[0],l.color=r,c?(c=null,l.dashArray=null):i=[]):(m>a[1]?(g=2,p[u]=f[2]):m>a[0]&&(g=1,p[u]=f[1]),m>a[0]?(i.push(t[v]),e.push(this._maps.buildPolyline(c?c:i,l)),l.color=f[g],c||(i=[])):c&&e.push(this._maps.buildPolyline(c,l)),c&&(c=null,l.dashArray=null)):c&&(e.push(this._maps.buildPolyline(c,l)),c=null,l.dashArray=null),i.push(t[v]);return o&&this.model.set("colorsMap",p),e.push(this._maps.buildPolyline(c?c:i,l)),e},rebuildPolyline:function(){this._polyline&&this._polyline.trigger("destroy")&&(this._polyline=null);var e=h.makeSegments.call(this);e.length&&(this._polyline=this._maps.getWidget().buildComplexPolyline());for(var t=0,n=e.length;n>t;t++)this._polyline.addSegment(e[t])},putPoints:function(){var e=this;return this._polyline&&this._module.get("showPoints")?(this._polyline.showPoints({minZoom:12,onMouseOver:function(t,n){e._parentView.showPointInfo(t,n,e.model)},onMouseOut:function(){e._parentView.hidePointInfo()}}),void 0):!1},removePoints:function(){this._polyline&&this._polyline.removePoints()},putMarkers:function(){var e=this,t=this.model,n=t.get("points"),i=t.get("parks")?t.get("parks").slice(0):[];if(n&&n.length||i&&i.length){if(!n||n.length<2||t.get("start")===t.get("finish"))return i.length&&h.buildAsOnePark.call(e,i[0]),void 0;var s=t.get("start"),a=t.get("finish"),o=t.get("startFromPark"),c=t.get("finishOnPark");i&&i.length&&(o&&i.splice(0,1),c&&i.splice(i.length-1,1));var d=this._parentView.getMapsModule(),u={borderColor:l(this.model.get("color"),"0.8")};this._startMarker=d.putMarker({lat:s.lat,lon:s.lon,className:"track-marker start"+(o?" park":""),data:s,style:u}),this._finishMarker=d.putMarker({lat:a.lat,lon:a.lon,className:"track-marker finish"+(c?" park":""),data:a,style:u});var m=[];if(i&&i.length)for(var p=0,f=i.length;f>p;++p)m.push(h.buildParkMarker.call(this,i[p]));if(o?h.bindPopup.call(this,this._startMarker,s):this._startMarker.bindPopup(r({title:this.model.get("name"),data:s,dateStr:this.model.formatDateTime(s.date),i18n:this._i18n})),c?h.bindPopup.call(this,this._finishMarker,a):this._finishMarker.bindPopup(r({title:this.model.get("name"),data:a,dateStr:this.model.formatDateTime(a.date),i18n:this._i18n})),m.length){var g=App.getUserData("objectsGrouping");this._parksLayer=d.addLayersGroup({layers:m,clusters:g.usedGrouping&&{maxClusterRadius:30,icon:{html:'<sup class="nb">#count#</sup>',className:"track-marker park",style:u}},popup:!0})}}},buildAsOnePark:function(e){this._parksLayer=this._maps.addLayersGroup({layers:[h.buildParkMarker.call(this,e)],clusters:!1})},buildParkMarker:function(e){var t=this._parentView.getMapsModule().buildMarker({lat:e.lat,lon:e.lon,className:"track-marker park",data:e,style:{borderColor:l(this.model.get("color"),"0.8")}});return h.bindPopup.call(this,t,e),t},triggerOnMarkers:function(e){this._startMarker&&this._startMarker.trigger(e),this._finishMarker&&this._finishMarker.trigger(e),this._parksLayer&&this._parksLayer.trigger(e)},clearMarkers:function(){h.triggerOnMarkers.call(this,"destroy"),this._startMarker=this._finishMarker=this._parksLayer=null},bindPopup:function(n,i){if(i instanceof a){var s=this;n.bindPopup(function(){var a=this.getContainer();return s._popup=this,e(a).addClass("track-info selectable").data("marker",n),"undefined"==typeof i.address||i.address||null===i.address||this.on("open",function(){var n=e(a).find(".address"),o=n.parent();o.addClass("loading"),s.once("searchcomplete",function(){o.removeClass("loading")}),s.once("searchsuccess",function(e){n.text(c(e.address))}),s._maps.trigger("needgeoinfo",t.pick(i,"geoId","lat","lon"),s)}).on("close",function(){s._popup=null}),o({title:s.model.get("name"),data:i,startStr:s.model.formatDateTime(i.start),endStr:s.model.formatDateTime(i.end),timeStr:Date.formatSeconds((i.end.getTime()-i.start.getTime())/App.MS),addressStr:i.address?i.address:Math._round(i.lat,4)+", "+Math._round(i.lon,4),i18n:s._i18n})},{autoPan:!0,autoPanPadding:[80,60]})}},onChangeColoring:function(){h.rebuildPolyline.call(this),this._module.get("showPoints")&&h.removePoints.call(this),this.model.get("hidden")||(this._polyline&&this._polyline.trigger("show"),this._module.get("showPoints")&&h.putPoints.call(this))},getLineWidth:function(){var e=this._widget.getZoom();return e>14?8:e>11?6:e>9?4:2}};return u}),define("_common/tracks/views/TracksMapView",["jquery","underscore","moment","abstracts/View","_common/tracks/views/TrackMapView","text!_common/tracks/tmpl/point.html"],function(e,t,n,i,s,a){n.locale(App.getLocale().substr(0,2)),a=t.template(a);var o=i.extend({constructor:function(){this._maps=null,this._viewsMap={},this._i18n={},this._pointInfo=null,this._pointInfoShown=!1,i.apply(this,arguments)},initialize:function(){var n=this;this._maps=this.model.get("options").mapsModule||null,this._maps&&(this._i18n=this.model.getTexts(),this._pointInfo=e('<div class="ui-tooltip track-point-info hidden"></div>').appendTo("body"),this.listenTo(this._maps,"zoomstart",function(){n._pointInfoShown&&n.hidePointInfo()}),this.listenTo(this.model,"tracksuccess",function(e,i){if(t.isArray(e)){for(var s=e.length;s--;)r.addItemToMap.call(n,e[s]);e.length&&i!==!1&&n._maps.setBounds(r.getTracksBounds.call(n,e))}else n.model.items.last()==e&&i!==!1&&n._maps.setBounds(e.getBounds()),r.addItemToMap.call(n,e)}).listenTo(this.model.items,"remove",function(e){n._viewsMap[e.id]=null}).listenTo(this.model,"change:showPoints",function(){n.hidePointInfo()}))},setMaps:function(e){if(e){var t=this._maps;this._maps=e,t||this.initialize()}},showPointInfo:function(e,t,n){var i=a({title:n.get("name"),data:t,dateStr:n.formatDateTime(t.date),i18n:this._i18n});this._pointInfo.removeClass("hidden").html(i).css({left:e.pageX,top:e.pageY}),this._pointInfoShown=!0},hidePointInfo:function(){this._pointInfoShown&&(this._pointInfo.addClass("hidden"),this._pointInfoShown=!1)},getMapsModule:function(){return this._maps},destroy:function(){this.remove(),this.hidePointInfo(),this._pointInfo.remove()}}),r={addItemToMap:function(e){var t=this._viewsMap[e.id]=new s({model:e,module:this.model,parent:this,maps:this._maps});return t},getTracksBounds:function(e){for(var t=e.length,n={},i={minLat:90,minLon:180,maxLat:-90,maxLon:-180};t--;)n=e[t].getBounds(),n&&(n.maxLat>i.maxLat&&(i.maxLat=n.maxLat),n.minLat<i.minLat&&(i.minLat=n.minLat),n.maxLon>i.maxLon&&(i.maxLon=n.maxLon),n.minLon<i.minLon&&(i.minLon=n.minLon));return i}};return o}),define("_common/tracks/TracksModule",["jquery","underscore","abstracts/Module","util","_common/mobile/MobileObjectsCollection","_common/tracks/Track","_common/tracks/TracksCollection","_common/tracks/views/TracksListView","_common/tracks/views/TracksMapView","i18n!_common/nls/common","css!_common/tracks/css/tracks"],function(e,t,n,i,s,a,o,r,l,c){var d=["#ff0000","#00CC00","#740000","#005d00","#ff4900","#742100","#00AF64","#00502d","#2a6b4f","#ff7400","#743500","#009999","#004646","#245d5d"],u=n.extend({constructor:function(){this.items=new o,this._listView=null,this._newTrackId=0,this._processing=!1,n.apply(this,arguments)},defaults:{showPoints:0,colorTracks:0,speedColors:["#0000ff","#00ff00","#ff0000"]},initialize:function(){var e=this,n=this.get("options");t.each(["showPoints","colorTracks","speedColors"],function(t){"undefined"!=typeof n[t]&&e.set(t,n[t])}),n.list&&this.get("container")&&(this._listView=new r({container:this.get("container"),placeholder:this.get("placeholder"),model:this})),this._view=new l({model:this}),h.bindEvents.call(this),this.publish("ready",this)},setMaps:function(e){e&&(this.set("options",t.extend({},this.get("options"),{mapsModule:e})),this._view.setMaps(e))},hideAll:function(){this.items.each(function(e){e.set("hidden",!0)})},showAll:function(){this.items.each(function(e){e.set("hidden",!1)})},getTexts:function(){return c},getSpeedLimits:function(){return App.getSpeedLimits()},setSpeedLimit:function(e,t){var n=this.getSpeedLimits();n[e]=t,this.setUserData("speedLimits",n),App.publish("speedlimitschange",n)},getSinglePolyline:function(){var e=this.items.where({hidden:!1});return e.length>1?!1:e[0].get("points")},remove:function(){this.stopListening()},destroy:function(){this.items.remove(this.items.models),this._listView&&this._listView.remove(),this.stopListening()}}),h={bindEvents:function(){var e=this,n=this.get("parent");this.listenTo(n,"buildtrack",function(t,i){if(i){if(i&&i.last)return h.buildLastTracks.call(e,i),void 0;if(i.trackId){var a;if(a=e.items.get(i.trackId))return e.trigger("itemselect",a),n.trigger("buildstartsuccess"),void 0}if(e._processing)return alert("Sorry, you can not build new tracks until previous task will be complete");var o=h.validateParams.call(e,i);if(o)return alert(o.join("<br />"),c.error.ucFirst());if(null==t){if(!i.objectId)return;return n.trigger("buildstartsuccess"),t=new s,t.fetch({data:{objectId:i.objectId},silent:!0}).done(function(){h.buildTracks.call(e,t,i)}),void 0}n.trigger("buildstartsuccess"),h.buildTracks.call(e,t,i)}}),this.listenTo(App,"clearmap",function(t){t&&t==e?e.items.remove(e.items.models):e.items.each(function(e){e.set("hidden",!0)})}),this.on("needtrack",function(){arguments.length||n.trigger("needtrack")}).on("needgeoinfo",function(t,n){var i;(i=e.get("options").mapsModule)&&i.trigger("needgeoinfo",t,n)}),this.on("change",function(){t.each(["showPoints","colorTracks","speedColors"],function(t){if(e.hasChanged(t)){var n=e.get(t);e.setUserData(t,n),e.get("parent").trigger("tracksoptionchange",t,n)}})}),this.on("itemselect",function(t){if(!(t instanceof a))return!1;var n;(n=e.get("options").mapsModule)&&(t.set("hidden",!1),n.setBounds(t.getBounds()))})},buildLastTracks:function(n){var i=this;if(!("tzId"in n)){var s=App.getTimezone({offset:60*App.getUserTimezone()});n.tzId=s.id}e.ajax({url:App.getBaseUrl()+"reports/LIMITEDROUTE/",data:n.data,statusCode:{401:null},success:t.bind(function(e){t.each(n.data.objectId,t.bind(function(t){var s=new a({id:h.getNewTrackId.call(i),objectId:t,module:this,name:n.name,tzId:n.tzId});s.set(s.parse(e)),this.items.add(s),s.get("points")&&(this.trigger("tracksuccess",s,n.zoom),s.trigger("sync",s,e))},this))},this),error:t.bind(function(e,t,n){this.trigger("trackerror",e||null,t||0,n||"")},this),complete:function(){}})},buildTracks:function(n,i){var s=this;n.models&&(n=n.models);var o=[],r=[],l={objectId:r,from:Date.sqlFormat(i.startTime),to:Date.sqlFormat(i.endTime)};if("undefined"!=typeof i.tzId?l.tzId=i.tzId:l.tz=App.getUserTimezone(),t.each(n,function(e){var t=new a({id:h.getNewTrackId.call(s),obj:e.clone(),objectId:e.id,name:e.get("name")+" [#"+e.get("extId")+"]",startTime:i.startTime,endTime:i.endTime,color:"color"in i?i.color:h.getNewTrackColor.call(s),module:s});"undefined"!=typeof i.tzId&&t.set("tzId",i.tzId),o.push(t),r.push(e.id),s.items.add(t),t.trigger("request",t)}),n.length>1&&(s._processing=!0),i.sourceElement&&i.sourceElement.trigger("loadstart"),"timeRanges"in i){var d=i.timeRanges,u=[];r.forEach(function(e){u.push({id:e,ranges:d})}),delete l.objectId,delete l.from,delete l.to,l.objectIds=u}e.ajax({url:o[0].url(),data:l,success:function(e){for(var t,n=o.length;n--;)t=o[n],t.set(t.parse(e)),s.items.get(t)?t.get("points")&&1==o.length&&(s.trigger("tracksuccess",t),t.trigger("sync")):t=null;if(o.length>1)for(s.trigger("tracksuccess",o),n=o.length;n--;)o[n].trigger("sync");i.sourceElement&&i.sourceElement.trigger("loadsuccess",o)},error:function(){alert(c.msgCanNotBuildTracks,c.error.ucFirst());for(var e=o.length;e--;)o[e].trigger("error"),s.items.remove(o[e]);i.sourceElement&&i.sourceElement.trigger("loaderror")},complete:function(){s._processing=!1,i.sourceElement&&i.sourceElement.trigger("loadcomplete")}})},getNewTrackId:function(){return++this._newTrackId},validateParams:function(e){var t=[];return e.startTime&&e.endTime||t.push("Start time and/or end time is absent"),e.startTime>=e.endTime&&t.push(c.errors.startMoreTnanEndTime),t.length?t:null},getNewTrackColor:function(){return this.items.length?d[t.last(this.items.models).id%d.length]:d[0]}};return u}),define("_common/alerts/views/MobileInfoView",["jquery","underscore","geo","jface","./DeviceInfoView","_common/tracks/TracksModule"],function(e,t,n,i,s,a){var o=100,r=s.extend({constructor:function(){this._tracksModule=null,s.apply(this,arguments)},initialize:function(){var e=this.controller.getTexts();this._infoAttrs={name:e.objName,extId:e.objIdNumber,shortDescription:e.description,licenseNumber:e.licenseNumber,model:e.objModel,year:e.objYear,color:e.color.ucFirst(),vin:e.objVin},s.prototype.initialize.apply(this,arguments)},remove:function(){this.stopListening(this.controller.getMapsModule()),this._tracksModule&&this._tracksModule.remove(),s.prototype.remove.call(this)},_bindEvents:function(){var e=this;s.prototype._bindEvents.call(this),this.$el.find("[data-code=map]").closest("li").one("toggle",function(){l.initTracks.call(e),e._objMapElement&&l.showTrack.call(e,e.model)}),this.listenTo(this.controller,"change:trackLength",function(){if(e._tracksModule){var t=e._tracksModule.items;t.remove(t.models),l.showTrack.call(e,e.model)}})},_bindDeviceEvents:function(){var e=this,t=this.model;s.prototype._bindDeviceEvents.apply(this,arguments),this.listenTo(t,"change:coords",function(t,i){if(!e._objMapElement&&i[0]&&i[1]&&e._addDeviceToMap(),e._objMapElement){e._placeOnMap();var s=t.previous("lat"),a=t.previous("lon"),r=n.getDistanceBetweenPoints(s,a,t.get("lat"),t.get("lon"));r>o&&(l.onAddressChange.call(e),l.showTrack.call(e))}}).listenTo(t,"change:course",function(t){t.get("speed")>=t.get("minSpeed")&&l.onCourseChange.call(e)}).listenTo(t,"change:speed",function(){l.onSpeedChange.call(e)}).listenTo(t,"change:trackedSensorState",function(){e._objMapElement&&e._objMapElement.trigger("toggleclass",{name:"obj-alert"})})},_addDeviceToMap:function(){var e=this.model,n=this.controller.getMapsModule(),i=" obj-mobile "+e.get("status"),a=e.get("lat"),o=e.get("lon");return a&&o?(e.get("hasAlarm")&&(i+=" alarm"),e.get("speed")<e.get("minSpeed")&&(i+=" park"),1==e.get("trackedSensorState")&&(i+=" obj-alert"),e.has("hwStatus")&&(i+=" "+e.get("hwStatus")),this._objMapElement=n.getWidget().buildComplexMarker({lat:a,lon:o,html:'<i class="i"></i><span class="name">'+App.buildObjTitle(e)+"</span>",className:"complex-icon obj"+i,dataId:e.id,animated:!1,model:e}),s.prototype._addDeviceToMap.call(this),l.onAddressChange.call(this),this.listenTo(n,"mapchanged",t.bind(l.onAddressChange,this)),l.onCourseChange.call(this),l.showTrack.call(this),void 0):(l.onAddressChange.call(this),App.get("grGuardsAvailable")&&this._initGuardsSearch(),void 0)}}),l={initTracks:function(){this._tracksModule=new a({id:this.controller.get("id")+"/tracks",container:!1,parent:this.controller,options:{list:!1,mapsModule:this.controller.getMapsModule()}})},onSpeedChange:function(){if(this._objMapElement){var e=this.model,n=e.get("speed"),i=e.previous("speed"),s=e.get("minSpeed"),a=n>=s&&s>i,o=s>n&&i>=s;(a||o)&&this._objMapElement.trigger("toggleclass",{name:"park"}),a&&l.onCourseChange.call(this),this.$el.find(".speed").text(t.isNull(n)?"":Math._round(n,2))}},onCourseChange:function(){this._objMapElement&&this._objMapElement&&this._objMapElement.trigger("rotate",{angle:this.model.get("course")})},onAddressChange:function(){if(this._stateModule){var e=this.controller.getMapsModule();e.trigger("needgeoinfo",this.model.pick("lat","lon"),this._stateModule.getView())}},showTrack:function(){if(this._tracksModule){var e=this.model;this.controller.trigger("buildtrack",[e],{id:e.get("id"),last:!0,zoom:!1,name:e.get("name")+" [#"+e.get("extId")+"]",data:{objectId:[e.get("id")],nMetres:this.controller.get("trackLength"),tz:App.getUserTimezone()}})}}};return r}),define("_common/alerts/views/StatInfoView",["jquery","underscore","jface","./DeviceInfoView","_common/stat/watched/views/StatInfoView","text!_common/stat/watched/tmpl/home.svg"],function(e,t,n,i,s,a){var o=i.extend({constructor:function(){i.apply(this,arguments)
},initialize:function(){var e=this.controller.getTexts();this._infoAttrs={name:e.objName,extId:e.objIdNumber,shortDescription:e.description,region:e.region.ucFirst(),city:e.city,street:e.street,house:e.house.ucFirst(),building:e.building,appNumber:e.appartment,gateCode:e.gateCode,intercomCode:e.intercomCode},i.prototype.initialize.apply(this,arguments)},_bindDeviceEvents:function(){var e=this,t=this.model;i.prototype._bindDeviceEvents.apply(this,arguments),this.listenTo(t,"change:coords",function(t,n){!e._objMapElement&&n[0]&&n[1]?e._addDeviceToMap():!e._objMapElement||n[0]&&n[1]||(e._objMapElement.trigger("destroy"),e._objMapElement=null),e._objMapElement&&e._placeOnMap()}).listenTo(t,"change:addressShort",function(t,n){e.$el.find(".address").text(n)}).listenTo(t,"change:boundGuards",function(t,n){r.renderGuards.call(e),e.$el.find(".find-manually")[n.length>0?"removeClass":"addClass"]("hidden")})},_showDeviceInfo:function(){i.prototype._showDeviceInfo.apply(this,arguments),this.model.has("boundGuards")&&r.renderGuards.call(this)},_addDeviceToMap:function(){var e=this.model,t=this.controller.getMapsModule(),n=" obj-stat "+e.get("status"),s=e.get("lat"),o=e.get("lon");s&&o&&(e.get("hasAlarm")&&(n+=" alarm"),e.has("hwStatus")&&(n+=" "+e.get("hwStatus")),this._objMapElement=t.getWidget().buildComplexMarker({lat:s,lon:o,html:'<i class="i">'+a+'</i><span class="name">'+App.buildObjTitle(e)+"</span>",className:"complex-icon obj"+n,dataId:e.id,animated:!1,model:e}),i.prototype._addDeviceToMap.call(this))},_initGuardsSearch:function(){var e=this;i.prototype._initGuardsSearch.call(this),this.$el.on("click",".find-manually",function(){return e.controller.modules.guards.findBoundGuards(),!1})}}),r={renderGuards:function(){var e=this.model.get("boundGuards"),n=this.$el.find(".obj-info .features .guards"),i=n.parent(),s=[];if(i.toggleClass("hidden",!e.length),e.length){var a=[];t.each(e,function(e){a=[e.name],e.person&&a.push(e.person),e.phone&&a.push('<a href="tel:'+e.phone+'">'+e.phone+"</a>"),s.push(a.join(", "))})}n.html(s.join(";<br/>"))}};return o}),define("text!_common/alerts/tmpl/windowExtended.html",[],function(){return'<div class="l">\n    <div class="tl devices-list">\n        <!--container-->\n    </div><!--/topleft tl-->\n\n    <div class="bl alarm-actions">\n        <div class="content">\n        <% if(alertsAllowed) {%>\n            <a class="btn btn-block btn-large btn-sound<% if(!soundBtnOn) {%> disabled<% } %>" href="javascript:;">\n                <span><!--GR-943 <i class="icon-volume-off icon-white"></i>&nbsp;--><%= i18n.turnOffSound %></span>\n            </a>\n        <% } %>\n\n        <% if(alertsEditAllowed || alarmCreationAllowed) {%>\n            <a class="btn btn-block btn-large btn-action disabled" href="javascript:;" data-popover="popover-actions">\n                <span><!--<i class="icon-check icon-white"></i>&nbsp;--><%= i18n.chooseAction %></span>\n            </a>\n\n            <% if(alertsEditAllowed) { %>\n            <a class="btn btn-block btn-large btn-comment disabled" href="javascript:;" data-popover="popover-comments">\n                <span><!--<i class="icon-comment icon-white"></i>&nbsp;--><%= i18n.addComment %></span>\n            </a>\n            <% } %>\n\n            <% if(alertsResolveAllowed) { %>\n            <a class="btn btn-block btn-large btn-resolve disabled" href="javascript:;" data-popover="popover-resolve">\n                <span><!--<i class="icon-remove-sign"></i>&nbsp;--><%= i18n.resolveAlarm %></span>\n            </a>\n            <% } %>\n        <% } %>\n\n    </div></div><!--/bottom left bl-->\n</div><!--/left-->\n\n<div class="r">\n    <div class="content">\n\n        <div class="tr">\n            <!--<div class="obj-history">\n                &lt;!&ndash;container&ndash;&gt;\n            </div>-->\n        </div><!--/top right tr-->\n\n        <div class="br">\n\n            <div class="alarms-popover popover-actions"></div>\n            <div class="alarms-popover popover-comments"></div>\n\n            <%= resolveHtml %>\n\n            <div class="device-state">\n                <!--container-->\n            </div>\n\n        </div><!--/bottom right br-->\n\n    </div>\n</div><!--/right r-->\n\n<div class="popover right status-popover">\n    <div class="popover-content selectable"></div>\n</div>\n\n'}),define("text!_common/alerts/tmpl/actions.html",[],function(){return'<a class="close">&times;</a>\n<% if(actions.length) {%>\n<div class="actions-list clearfix">\n    <div class="row-fluid">\n        <% var rowNum = 0, nbCells = 0; _.each(actions, function(action, i){%>\n        <% if(nbCells >= 12) { rowNum++; nbCells = 0;%>\n        </div><div class="row-fluid">\n        <% } %>\n        <button\n            <% if(\'option\' in action) { %>data-option="<%= action.option %>"<% } %>\n            data-action="<%= action.actionType %>"\n            class="btn btn-action span3 comment"\n        >\n            <%= action.name %>\n        </button>\n        <% nbCells += 3; }) %>\n    </div>\n</div>\n<% } %>\n'}),define("text!_common/alerts/tmpl/comments.html",[],function(){return'<a class="close">&times;</a>\n<% if(comments.length) {%>\n<div class="actions-list clearfix">\n    <div class="row-fluid">\n        <% var rowNum = 0, nbCells = 0; _.each(comments, function(comment, i){ %>\n        <% if(nbCells >= 12) { rowNum++; nbCells = 0;%>\n        </div><div class="row-fluid">\n        <% } %>\n        <button class="btn btn-comment span3 comment"><%= comment.msg %></button>\n        <% nbCells += 3; }) %>\n    </div>\n</div>\n<% } %>\n<form method="post" action="" class="form-horizontal comment-form">\n    <textarea name="action" placeholder="<%= i18n[comments.length ? \'typeAnotherComment\' : \'typeComment\'] %>..."></textarea>\n    <button type="submit" class="btn">\n        <%= i18n.submitComment %>\n    </button>\n</form>'}),define("text!_common/alerts/tmpl/resolve.html",[],function(){return'<div class="alarms-popover popover-resolve" style="color: #125db3">\n    <a class="close">&times;</a>\n    <div class="actions-list clearfix">\n        <div class="row-fluid">\n            <button disabled class="btn btn-resolve span6 btn-resolve-obj disabled"><%= i18n.resolveAllAlarmsOnObj %></button>\n            <button class="btn btn-resolve span6 btn-resolve-all"><%= i18n.resolveAllAlarms %></button>\n        </div>\n    </div>\n\n</div><!--/popover-resolve-->'}),define("_common/alerts/views/AlertsViewExtended",["jquery","underscore","./AlertsView","jface","jqueryui","./DevicesListViewExtended","./DeviceHistoryViewExtended","./MobileInfoView","./StatInfoView","text!../tmpl/windowExtended.html","text!../tmpl/actions.html","text!../tmpl/comments.html","text!../tmpl/resolve.html","css!mobile/css/mobile.css","css!stat/css/stat.css","css!guards/css/guard.css"],function(e,t,n,i,s,a,o,r,l,c,d,u,h){var m=n.prototype;c=t.template(c),d=t.template(d),u=t.template(u),h=t.template(h);var p=800,f=600,g=250,v=p-g,_=250,b=0,w=0,y=n.extend({constructor:function(){this.maximized=!1,this._l=null,this._r=null,this._tl=null,this._tr=null,this._bl=null,this._br=null,this._popover=null,this._popoverComments=null,this._popoverActions=null,this._children={devicesList:null,deviceInfo:null,deviceHistory:null},n.apply(this,arguments)},initialize:function(e){this.maximized=!!e.controller.getUserData("alarmsMaximized"),n.prototype.initialize.apply(this,arguments)},openWindow:function(){return this.controller.get("visible")?void 0:App.isAlarmOperator()?(this.controller.set("visible",!0),this.setElement(e('<div class="history extended"></div>').appendTo(App.getView().$el)),this.$el.html(this.render()),this._onOpen(this.$el),void 0):m.openWindow.call(this)},render:function(){var e=this.controller,t=e.getTexts(),n=App.allowed("alerts"),i=App.allowed("alerts.edit"),s=App.allowed("alerts.close"),a=App.allowed("alarm.create");return c({resolveHtml:s?h({i18n:t}):"",alertsAllowed:n,alertsEditAllowed:i,alertsResolveAllowed:s,alarmCreationAllowed:a,soundBtnOn:this.getSoundBtnOn(),i18n:t})},getGuardsListContainer:function(){return this._children.deviceInfo.$el.find(".pane-left")},remove:function(){e("body").off(this._eventsPrefix),n.prototype.remove.apply(this,arguments)},_bindEvents:function(){var e=this,i=this.controller,s=App.allowed("alerts.edit");n.prototype._bindEvents.apply(this,arguments),this.listenTo(App,"change:totalAlarms",function(){this.$el.find(".jw-hdr h3").html(this._getHeader())}).listenTo(i,"change:alarmDevices",function(n,i){i?(e.$el.addClass("loading"),e.listenToOnce(i,"sync",function(){e.$el.removeClass("loading"),e._makeDevicesListView()})):t.each(e._children,function(e){e&&e.remove()})}).listenTo(i,"request:device",function(e,t){this._br.addClass("loading"),this._makeDeviceHistoryView(t),this._children.deviceInfo&&(this._children.deviceInfo.remove(),this._children.deviceInfo=null)}),s&&(App.get("grGuardsAvailable")&&this.listenTo(i,"guards:change:called",function(t){var n,s=i.getTexts(),a=e._popoverActions,o=i.ACTION_GUARD_CANCEL,r=i.ACTION_GUARD_COMPLETE,l=".btn-action[data-action="+o+"],.btn-action[data-action="+r+"]",c=a.find(".btn-action[data-action="+i.ACTION_GUARD_ACCEPT+"]"),d=a.find(".btn-action[data-action="+i.ACTION_GUARD_ARRIVE+"]");t.called?(n=a.find(l),n.prop("disabled",!1),t.arrived?(d.prop("disabled",!0),n.attr("data-action",r).text(s.rrtCompleteCall)):t.accepted?(d.prop("disabled",!1),c.prop("disabled",!0)):c.prop("disabled",!1)):(n=a.find(l),n.attr("data-action",o).text(s.rrtCancelCall).prop("disabled",!0),c.prop("disabled",!0),d.prop("disabled",!0))}),this.listenTo(i,"change:comments",function(){A.renderComments.call(this)}).listenTo(i,"change:actions",function(){A.renderActions.call(this)}),this.on("layoutchange",function(){var e=Math.min(Math.sqrt(this._br.width())/1.75,Math.sqrt(this._br.height())/1.15);this._popoverComments.add(this._popoverActions).find(".actions-list .btn").css("font-size",e)}))},_getWindowParams:function(){var t=this,s=this.controller,a=n.prototype._getWindowParams.call(this);return a.footerHtml="",a.addClass=a.addClass.replace("compact","extended"),a.dieAfter=28800,a.resizable=!0,a.minWidth=p,a.minHeight=f,a.width=s.getUserData("winWidth")||p,a.showCallback=function(){t.maximized&&(i.windowshome[0].className+=" jf-windows-maximized",t.$el.resizable("disable").draggable("disable")),s.set("visible",!0),t._fitSizes()&&(t.trigger("layoutchange"),App.trigger("openalarms")),t.trigger("show")},a.dieCallback=function(){e("body").off(t._eventsPrefix),e(window).off(t._eventsPrefix)},a},_enoughSpaceForWindow:function(){if(App.isAlarmOperator())return!0;var t=e(window),n=t.width(),i=t.height();return n>=p&&i>=f},_onOpen:function(){m._onOpen.apply(this,arguments);var e=App.allowed("alerts.edit"),t=e||App.allowed("alarm.create");t||this.$el.addClass("no-actions"),App.get("totalAlarms")||this.$el.addClass("no-devices");var n=this.controller.get("device");t&&(this._popoverActions=this.$el.find(".popover-actions"),A.renderActions.call(this)),e&&(this._popoverComments=this.$el.find(".popover-comments"),this._toggleBtnResolve(),A.renderComments.call(this)),(e||t)&&this._toggleCommentsAndActions(!!n),this._makeDeviceInfoView()},_makeDevicesListView:function(){if(App.allowed("alerts")){var t=new a({collection:this.controller.get("alarmDevices"),el:e("<div></div>").appendTo(this._tl),parent:this,controller:this.controller});this._children.devicesList=t}},_makeDeviceInfoView:function(){var t=this.controller.get("device");if(this._children.deviceInfo&&(this._children.deviceInfo.remove(),this._children.deviceInfo=null),t){var n=r;t.get("objType")==App.TYPE_STAT&&(n=l),this._children.deviceInfo=new n({model:t,el:e("<div></div>").appendTo(this.$el.find(".device-state")),parent:this,controller:this.controller})}},_makeDeviceHistoryView:function(n){if(n=t.isObject(n)?n:this.controller.get("device"),this._children.deviceHistory&&(this._children.deviceHistory.remove(),this._children.deviceHistory=null),n){var i=new o({model:n,el:e('<div class="device-history"></div>').appendTo(this._tr),parent:this,controller:this.controller});this._children.deviceHistory=i}},_bindUIEvents:function(){var i=this,s=this.controller,a=[];App.get("grGuardsAvailable")&&(a=a.concat([s.ACTION_GUARD_CALL,s.ACTION_GUARD_CANCEL,s.ACTION_GUARD_ACCEPT,s.ACTION_GUARD_ARRIVE,s.ACTION_GUARD_COMPLETE])),s.isAlarmDelegationAllowed()&&(a=a.concat([s.ACTION_DELEGATE_PROCESSING])),App.allowed("alarm.create")&&a.push(s.ACTION_CREATE_ALARM),n.prototype._bindUIEvents.call(this),e("body").on("keypress"+this._eventsPrefix,function(e){if(i._children.devicesList&&s.get("visible")&&32==e.keyCode){var t=/INPUT|SELECT|TEXTAREA/i,n=!0;if(t.test(e.target.tagName)&&(n=!1),n)return i._children.devicesList.focusSearch(),!1}}),this.$el.on("click",".btn[data-popover]",function(){var t=e(this),n=t.data("popover"),s=i.$el.find("."+n);return s.is(".active")||t.is(".disabled")?!1:(A.closeActivePopover.call(i),i._popover=s,s.addClass("active"),t.addClass("active"),A.matchPopover.call(i,s,t),n.indexOf("comments")>-1&&s.find("textarea").focus(),void 0)}).on("click",".alarms-popover .close",function(){A.closeActivePopover.call(i)}).on("click","button.comment",function(){if(this.disabled)return!1;var n,o=e(this);if(n=o.data("action")){var r=o.data("option");t.indexOf(a,n)>-1?s.trigger("action",n,r):i._sendComment(o.text())}else i._sendComment(o.text());return A.closeActivePopover.call(i),!1}),this.$el.data("ui-resizable")&&this.$el.resizable("option","stop",function(e,t){t&&t.element&&t.element[0]==i.$el[0]&&(i.$el.resizer[0].style.width="auto",t.size.width!=t.originalSize.width&&(s.setUserData("winWidth",t.size.width),s.setUserData("winLeft",t.position.left),A.fitColumnsWidth.call(i,t.size.width,!0)),t.size.height!=t.originalSize.height&&(s.setUserData("winHeight",t.size.height),A.fitRowsHeight.call(i,t.size.height,!0)),i.trigger("layoutchange"))}),e(window).on("resizestop"+this._eventsPrefix,function(t){t.originalEvent&&t.originalEvent.target==window&&i._fitSizes(!1)&&(i.trigger("layoutchange"),i.$el.data("ui-resizable")&&(i.$el.resizable("option","maxWidth",e(window).width()),i.$el.resizable("option","maxHeight",e(window).height())))}),e("body").on("keyup"+this._eventsPrefix,function(t){t.keyCode==e.ui.keyCode.ESCAPE&&i._popover&&A.closeActivePopover.call(i)})},_initLayout:function(){var t=this,n=this.controller;n.get("device");var i=e('<a href="#" class="jw-maximize svg-icon svg-icon-'+(this.maximized?"contract":"expand")+'"></a>').prependTo(this.$el.find(".jw-controls"));i.on("click",function(){A.toggleMaximize.call(t)}),this._l=this.$el.find(".l"),this._r=this.$el.find(".r"),this._tl=this.$el.find(".tl"),this._tr=this.$el.find(".tr"),this._bl=this.$el.find(".bl"),this._br=this.$el.find(".br"),b=45,w=f-_-b;var s=Math.max(f,n.getUserData("winHeight")),a=Math.max(g,n.getUserData("winLeftWidth")),o=Math.max(_,n.getUserData("winTopHeight"));App.isAlarmOperator()||(this.el.style.height=s+"px"),App.allowed("alerts")||App.allowed("alerts.edit")||App.allowed("alarm.create")?(this._l[0].style.width=a+"px",this._r[0].style.left=a+"px",this._l.resizable({handles:"e",minWidth:g,maxWidth:t.$el.width()-v,resize:function(e,n){t._r[0].style.left=n.size.width+"px"},stop:function(e,i){n.setUserData("winLeftWidth",i.size.width),t.trigger("layoutchange")}})):(this._l.addClass("hidden"),this._r[0].style.left=0),this._tr[0].style.height=o+"px",this._br[0].style.top=o+"px",this._tr.resizable({handles:"s",minHeight:_,maxHeight:t.$el.height()-f+_,resize:function(e,n){t._br[0].style.top=n.size.height+"px"},stop:function(e,i){n.setUserData("winTopHeight",i.size.height),t.trigger("layoutchange")}})},_fitSizes:function(t){if(!this.controller.get("visible"))return!1;if(this._enoughSpaceForWindow()){if(this.maximized){var n=e(window).width(),i=e(window).height();return A.fitColumnsWidth.call(this,n,t),A.fitRowsHeight.call(this,i,t),!0}var s=e.fn.getScrollbarWidth(),n=e(window).width()-s,i=e(window).height()-s,a=this.$el.width(),o=this.$el.height(),r=parseInt(this.el.style.left),l=parseInt(this.el.style.top);return l+o>i&&(this.el.style.top=0,o>i&&(this.el.style.height=i+"px",A.fitRowsHeight.call(this,i,t))),r+a>n&&(this.el.style.left=0,a>n&&(this.el.style.width=n+"px",A.fitColumnsWidth.call(this,n,t))),!0}return this.$el.trigger("jw.close"),alert(this.controller.getTexts().windowTooSmallForAlarms),!1},_onChangeDevice:function(){var e=this.controller.get("device");this._br.removeClass("loading"),e?(this._bindDeviceEvents(),this._toggleCommentsAndActions(!0),App.get("grGuardsAvailable")&&A.renderActions.call(this)):this._toggleCommentsAndActions(!1),e&&this._children.deviceHistory&&this._children.deviceHistory.model.id==e.id||this._makeDeviceHistoryView(),this._toggleBtnResolve(),this._makeDeviceInfoView()},_toggleCommentsAndActions:function(e){this._toggleButtons(".btn-action, .btn-comment",e)},_setFooter:function(){},_getFooter:function(){return""},_sendComment:function(e){var t=this;return this.controller.saveLog(e).done(function(){A.closeActivePopover.call(t)})},_resolveAlarm:function(e){var t=this,n=this.$el.find(".popover-resolve"),i=!1,s=setTimeout(function(){i=!0,n.addClass("loading")},200);return this.controller.resolveAlarm(e).done(function(){t._onResolve(e)}).fail(function(e){t.showErrors(e)}).always(function(){s&&clearTimeout(s),i&&n.removeClass("loading")})},_onResolve:function(){A.closeActivePopover.call(this)},_getHeader:function(){var e=this.controller.getTexts(),t=e.objectAlertsAndLog;if(App.allowed("alerts")){var n=App.get("totalAlarms");t=0>=n?e.alarmWindowHeaderNoAlarms:e.alarmWindowHeader.replace("#n#",n).replace("#t#",e.objectsLabels1[e.whichLabels(n)])}return t},_onClose:function(){i.hideOverlay(),this.controller.set("visible",!1),this.maximized&&(i.windowshome[0].className=i.windowshome[0].className.replace(" jf-windows-maximized","")),this.trigger("hide")}}),A={toggleMaximize:function(){var e=i.windowshome[0],t=this.$el.find(".jw-maximize")[0];this.maximized?(e.className=e.className.replace(" jf-windows-maximized",""),t.className=t.className.replace("contract","expand"),A.fitColumnsWidth.call(this,this.$el.width(),!1),A.fitRowsHeight.call(this,this.$el.height(),!1)):(e.className+=" jf-windows-maximized",t.className=t.className.replace("expand","contract"),this._l.data("ui-resizable")&&this._l.resizable("option","maxWidth",this.$el.width()-v),this._tr.resizable("option","maxHeight",this.$el.height()-f+_)),this.$el.resizable(this.maximized?"enable":"disable").draggable(this.maximized?"enable":"disable"),this.maximized=!this.maximized,this.trigger("layoutchange"),this.controller.setUserData("alarmsMaximized",this.maximized)},fitColumnsWidth:function(e,t){if(this._l.data("ui-resizable")){var n=e-v,i=this._r.width();if(this._l.resizable("option","maxWidth",Math.max(g,n)),v>i){var s=v-i,a=this._r.position().left-s;this._r[0].style.left=a+"px",this._l[0].style.width=a+"px",t&&this.controller.setUserData("winLeftWidth",a)}}},fitRowsHeight:function(e,t){var n=e-f+_,i=this._br.outerHeight();if(this._tr.resizable("option","maxHeight",Math.max(_,n)),w>i){var s=w-i,a=this._br.position().top-s;this._br[0].style.top=a+"px",this._tr[0].style.height=a+"px",t&&this.controller.setUserData("winTopHeight",a)}this._popover&&A.matchPopover(this._popover,this.$el.find(".btn.active"))},matchPopover:function(e,t){e[0].style.marginTop="0px";var n=e.offset(),i=t.offset(),s=e.outerHeight(),a=t.outerHeight(),o=10,r=0;n.top>i.top-o?(r=n.top-i.top+o,e[0].style.marginTop=-r+"px"):n.top+s<i.top+a+o&&(r=i.top+a+o-n.top-s,e[0].style.marginTop=r+"px")},closeActivePopover:function(){this._popover&&this._popover.removeClass("active"),this.$el.find(".btn.active[data-popover]").removeClass("active"),this._popover=null},renderComments:function(){var t=this,n=this.controller,i=n.getTexts(),s=n.getComments(),a=this._popoverComments;a.toggleClass("empty",!s.length).html(u({comments:s,i18n:i})),a.find("form.comment-form").on("submit",function(){var n=e(this).find("textarea"),i=n.val();return t._sendComment(i).done(function(){n.val("")}).fail(function(){t.showErrors(arguments[0])}),!1}),a.find("textarea[name=action]").on("keypress",function(t){13!=t.keyCode||t.shiftKey||e(this).closest("form").submit()})},renderActions:function(){var e=this.controller,n=e.getTexts(),i=e.getActions(),s=this._popoverActions;s.html(d({actions:i,i18n:n})),e.useExternalGuards()||t.each(["CANCEL","ACCEPT","ARRIVE"],function(t){s.find(".btn-action[data-action="+e["ACTION_GUARD_"+t]+"]").prop("disabled",!0)})}};return y}),define("text!_common/alerts/tmpl/notification.html",[],function(){return'<i class="svg-icon svg-icon-warning-w"></i><i class="icon-spin svg-icon svg-icon-spinner-w"></i>\n<span class="hidden-xs"><%= i18n.withAlarms %>:</span> <span class="nb-alarms"></span>\n<audio class="alarms-audio" preload="auto">\n    <source src="<%= alarmSoundSrc%>">\n</audio>'}),define("_common/alerts/views/AlarmsNotificationView",["jquery","underscore","jface","abstracts/View","text!../tmpl/notification.html","css!../css/alarms.css"],function(e,t,n,i,s){s=t.template(s);var a=i.extend({constructor:function(){this.soundOn=!1,this._audio=null,this._playInterval=null,i.apply(this,arguments)},tagName:"a",className:"notification-small red pull-right alarms-notification hidden",initialize:function(){var e=this.model.getTexts();this.model.get("online")&&(this.el.className+=" online"),this.$el.html(s({i18n:e,alarmSoundSrc:requirejs.toUrl(this.model.getAlarmSoundFile())})),this.$el.appendTo("#main-hdr .navbar-inner"),this._audio=this.$el.find("audio")[0]||null,o.bindEvents.call(this)},hide:function(){this.$el.addClass("hidden")},repeatSound:function(){return this.soundOn?!1:(o.playSound.call(this)&&(this._playInterval=setInterval(t.bind(o.playSound,this),this.model.get("soundInt")),this.soundOn=!0),void 0)},stopSound:function(){this._audio&&this._audio.pause&&this._audio.pause(),this._playInterval&&clearInterval(this._playInterval)&&(this._playInterval=null),this.soundOn=!1}}),o={bindEvents:function(){var e=this;this.$el.on("click",function(){e.model.openWindow()}),this.listenTo(App,"change:totalAlarms",function(t,n){var i=e.$el.find(".nb-alarms")[0];0>=n?App.previous("totalAlarms")&&(e.model.set("soundOn",!1),e.hide(),i.innerHTML=0):(e.$el.removeClass("hidden"),i.innerHTML=n)}).listenTo(this.model,"change:online",function(t,n){!n&&e.stopSound(),e.$el[n?"addClass":"removeClass"]("online")}).listenTo(this.model,"change:alarmSound change:soundInt",function(){e.soundOn&&(e.stopSound(),e.repeatSound())}).listenTo(this.model,"change:soundOn",function(t,n){o.toggleSoundThrottle.call(e,n)})},toggleSoundThrottle:t.throttle(function(e){e?this.repeatSound():this.stopSound()},60),playSound:function(){return this._audio&&this._audio.play?(this._audio.src=this.model.getAlarmSoundFile(),this._audio.play(),!0):!1}};return a}),define("text!_common/alerts/tmpl/settings.html",[],function(){return'<div class="nav">\n    <h3><%= i18n.alarmsWindow %></h3>\n    <ul>\n        <li>\n            <a data-section="common" class="active" href="#"><%= i18n.commonAlertsSettings %></a>\n            <a data-section="comments" href="#"><%= i18n.commentsList %></a>\n            <a data-section="actions" href="#"><%= i18n.actionsList %></a>\n        </li>\n    </ul>\n</div>\n<div data-section="common" class="section active"></div>\n<div data-section="comments" class="section section-grid"></div>\n<div data-section="actions" class="section section-grid"></div>'}),define("text!_common/alerts/tmpl/settingsCommon.html",[],function(){return'<h3><%= App.allowed(\'alerts\') ? i18n.alarmsWindow : i18n.historyWindow %></h3>\n<div class="params-group pull-left">\n\n    <% if(!App.isAlarmOperator()) {%>\n    <h4><%= i18n.alarmsAndAlertsSettings[App.allowed(\'alerts\') ? \'windowMode\' : \'historyWindowMode\'] %></h4>\n    <div class="control-group">\n        <label class="radio">\n            <input type="radio" name="extended" value="false"<% if(!extended) {%> checked<% } %>>\n            <%= i18n.alarmsAndAlertsSettings.windowModeCompact %>\n        </label><label class="radio">\n            <input type="radio" name="extended" value="true"<% if(extended) {%> checked<% } %>>\n            <%= i18n.alarmsAndAlertsSettings.windowModeExtended %>\n        </label>\n    </div>\n    <% } %>\n\n    <% if (isAdmin) {%>\n    <h4><%= i18n.alarmsAndAlertsSettings.windowOpenMode %></h4>\n    <div class="control-group">\n        <label class="radio">\n            <input type="radio" name="windowAutoOpen" value="false"<% if(!windowAutoOpen) {%> checked<% } %>>\n            <%= i18n.alarmsAndAlertsSettings.windowOpenManually %>\n        </label><label class="radio">\n            <input type="radio" name="windowAutoOpen" value="true"<% if(windowAutoOpen) {%> checked<% } %>>\n            <%= i18n.alarmsAndAlertsSettings.windowAutoOpen %>\n        </label>\n    </div>\n    <% } %>\n\n    <h4><%= i18n.alarmsAndAlertsSettings.alarmSoundHeader %></h4>\n    <div class="control-group form-horizontal sound">\n        <div class="field">\n            <select name="alarmSound">\n                <option <% if (alarmSound == \'alarm\') { %>selected <% } %>value="alarm"><%= i18n.sound %> 1</option>\n                <option <% if (alarmSound == \'music-one\') { %>selected <% } %>value="music-one"><%= i18n.sound %> 2</option>\n                <option <% if (alarmSound == \'music-two\') { %>selected <% } %>value="music-two"><%= i18n.sound %> 3</option>\n            </select>\n            <div class="btn-play icon-play"></div>\n\n            <audio repeat="false" preload="true">\n                <source src="<%= soundPath %>">\n            </audio>\n        </div>\n    </div>\n\n    <h4><%= i18n.alarmsAndAlertsSettings.soundInterval %></h4>\n    <div class="control-group">\n        <div class="slider" style="width:235px"></div>\n        <span class="value"><%= soundInt/1000 %></span> <%= i18n.sec %>\n    </div>\n\n    <h4><%= i18n.alarmsAndAlertsSettings.trackLength %> (100 <%= i18n.m %> - 2000 <%= i18n.m %>)</h4>\n    <div class="control-group">\n        <input name="trackLength" type="text" class="input-mini integer" value="<%= trackLength %>" maxlength="4">\n    </div>\n</div>'}),define("text!_common/alerts/tmpl/settingsComments.html",[],function(){return'<h3><%= i18n.commentsList %></h3>\n<button class="btn btn-default btn-save"><%= i18n.saveChanges %></button>\n<div class="grid comments-grid">\n    <table class="dataTable display comments-table">\n        <colgroup>\n            <col />\n            <col style="width: 100px" />\n        </colgroup>\n        <tbody class="comments-tbody"></tbody>\n    </table>\n</div>\n<div class="footer">\n    <a href="javascript:;" class="add-row-link"><%= i18n.addComment %></a>\n    <a href="javascript:;" class="restore-defaults-link"><%= i18n.setDefaultComments %></a>\n</div>'}),define("text!_common/alerts/tmpl/settingsCommentRow.html",[],function(){return'<tr>\n    <td>\n        <input class="input-block-level comments-input" type="text" name="msg" value="<%- data.msg %>" maxlength="64">\n    </td>\n    <td class="controls text-center">\n        <i class="icon-up svg-icon svg-icon-chevron-up"></i>\n        <i class="icon-down svg-icon svg-icon-chevron-down"></i>\n        <i class="icon-remove svg-icon svg-icon-remove"></i>\n    </td>\n</tr>'}),define("text!_common/alerts/tmpl/settingsActions.html",[],function(){return'<h3><%= i18n.actionsList %></h3>\n<button class="btn btn-default btn-save"><%= i18n.saveChanges %></button>\n<div class="grid comments-grid">\n    <table class="dataTable display comments-table">\n        <colgroup>\n            <col />\n            <col />\n            <col style="width: 100px" />\n        </colgroup>\n        <thead>\n            <tr>\n                <th><%= i18n.actionTitle %></th>\n                <th><%= i18n.actionExecuted %></th>\n                <th>&nbsp;</th>\n            </tr>\n        </thead>\n        <tbody class="comments-tbody"></tbody>\n    </table>\n</div>\n<div class="footer">\n    <a href="javascript:;" class="add-row-link"><%= i18n.addAction %></a>\n    <a href="javascript:;" class="restore-defaults-link"><%= i18n.setDefaultActions %></a>\n</div>'}),define("text!_common/alerts/tmpl/settingsActionRow.html",[],function(){return'<tr>\n    <td>\n        <input class="input-block-level comments-input" type="text" name="name" value="<%-data.name%>" maxlength="64">\n    </td>\n    <td>\n        <select name="actionType" class="action-type-select input-block-level">\n            <% _.each(actionTypes, function(type) { %>\n            <option value="<%= type.actionType %>" <% if(data.actionType === type.actionType) {%>selected<% } %>>\n                <%= type.name %>\n            </option>\n            <% }) %>\n        </select>\n    </td>\n    <td class="controls text-center">\n        <i class="icon-up svg-icon svg-icon-chevron-up"></i>\n        <i class="icon-down svg-icon svg-icon-chevron-down"></i>\n        <i class="icon-remove svg-icon svg-icon-remove"></i>\n    </td>\n</tr>'}),define("_common/alerts/views/AlarmsSettingsView",["jquery","underscore","jface","abstracts/View","text!../tmpl/settings.html","text!../tmpl/settingsCommon.html","text!../tmpl/settingsComments.html","text!../tmpl/settingsCommentRow.html","text!../tmpl/settingsActions.html","text!../tmpl/settingsActionRow.html"],function(e,t,n,i,s,a,o,r,l,c){s=t.template(s),a=t.template(a),o=t.template(o),r=t.template(r),l=t.template(l),c=t.template(c);var d=24,u=24,h=i.extend({constructor:function(){this._activePage="common",this._soundOn=!1,this._audio=null,this._playInterval=null,this.$commentsSection=null,this.$commentsTbody=null,this.$actionsSection=null,this.$actionsTbody=null,i.apply(this,arguments)},initialize:function(){var t=this;e("#settings").length?m.initSettings.call(t):this.listenTo(App,"settingsready",function(){m.initSettings.call(t)})}}),m={initSettings:function(){var n=e("#settings").find("#alerts-settings"),i=this.model.getTexts(),o=App.isAdmin(),r=o?s:a,l=t.extend({},this.model.attributes,{soundPath:requirejs.toUrl(this.model.getAlarmSoundFile()),isAdmin:o,i18n:i});n.html(r(o?{i18n:i}:l)),this.setElement(n),o&&(this.$el.find(">.section[data-section=common]").html(a(l)),this.$commentsSection=this.$el.find(">.section[data-section=comments]"),m.renderCommentsSettings.call(this),this.$actionsSection=this.$el.find(">.section[data-section=actions]"),m.renderActionsSettings.call(this)),this._audio=this.$el.find("audio")[0]||null,m.bindEvents.call(this)},bindEvents:function(){var t=this,n=this.model;App.isAdmin()?(this.$el.on("click","input[name=windowAutoOpen]",function(){this.checked&&n.set("windowAutoOpen","true"==this.value)}),m.initCommentsOrActions.call(this,this.$commentsTbody,this.$commentsSection),m.initCommentsOrActions.call(this,this.$actionsTbody,this.$actionsSection)):this.$el.find(".alerts-lists").hide(),this.$el.find(">.nav").on("click","[data-section]",function(){m.setActivePage.call(t,e(this).data("section"))}),this.$el.on("click","input[name=extended]",function(){this.checked&&n.set("extended","true"==this.value)}),this.$el.find(".sound").on("click",".btn-play",function(){var e=-1!=this.className.indexOf("icon-play");e?m.repeatSound.call(t):m.stopSound.call(t)}).find("select").on("change",function(){var i=e(this).val();n.set("alarmSound",i),t._audio.src=requirejs.toUrl(n.getAlarmSoundFile()),m.stopSound.call(t)}),e.ui.slider&&this.$el.find(".slider").slider({value:n.get("soundInt"),min:1e3,max:1e4,step:1e3,slide:function(i,s){n.set("soundInt",s.value),e(this).next(".value").text(s.value/1e3),t._soundOn&&(m.stopSound.call(t),m.repeatSound.call(t))}});var i=this.$el.find("[name=trackLength]");i.numeric({decimal:!1,negative:!1}).on("blur",function(){var e=parseInt(this.value),t=100,i=2e3;isNaN(e)||0>=e?this.value=500:t>e?this.value=t:e>i&&(this.value=i),n.set("trackLength",parseInt(this.value))}),this.listenTo(App,"settingsclose",function(){t._soundOn&&m.stopSound.call(t)})},setActivePage:function(e){e!=this._activePage&&(this.$el.find(">.section.active").removeClass("active"),this.$el.find(">.nav .active").removeClass("active"),this.$el.find('>.section[data-section="'+e+'"]').addClass("active"),this.$el.find('>.nav [data-section="'+e+'"]').addClass("active"),this._activePage=e)
},renderCommentsSettings:function(){var e=this.$commentsSection;e.html(o({i18n:this.model.getTexts()})),this.$commentsTbody=e.find("tbody"),m.renderCommentsOrActionsRows.call(this,this.model.getComments(),r,this.$commentsTbody)},renderActionsSettings:function(){var e=this.$actionsSection,t=this.model,n=t.getActions().filter(function(e){return e.actionType!==t.ACTION_DELEGATE_PROCESSING});e.html(l({i18n:t.getTexts()})),this.$actionsTbody=e.find("tbody"),m.renderCommentsOrActionsRows.call(this,n,c,this.$actionsTbody)},initCommentsOrActions:function(t,i){var s=this,a=i.data("section"),o="comments"===a;t.on("click",".icon-up",function(){m.moveCommentOrAction.call(s,e(this).closest("tr"),t,!0)}).on("click",".icon-down",function(){m.moveCommentOrAction.call(s,e(this).closest("tr"),t,!1)}).on("click",".icon-remove",function(){m.removeCommentOrAction.call(s,e(this).closest("tr"))}),i.on("click",".btn-save",function(){m[o?"saveComments":"saveActions"].call(s)}).on("click",".add-row-link",function(){return m[o?"addComment":"addAction"].call(s),!1}).on("click",".restore-defaults-link",function(){var e=s.model.getTexts(),t=o?e.setDefaultCommentsConfirm:e.setDefaultActionsConfirm;return n.confirm(t.msg,t.hdr,{btnNames:{ok:e.restore},okCallback:function(){m.restoreDefaultCommentsOrActions.call(s,a)}}),!1})},renderCommentsOrActionsRows:function(e,n,i){var s="",a=this.model.getActionTypes();t.each(e,function(e){s+=n({data:e,actionTypes:a})}),i.html(s)},addComment:function(){var t=this.$commentsTbody.find("tr").length;if(u>t){var n=e(r({data:{msg:""}})).appendTo(this.$commentsTbody);n.find("input").focus(),this.$commentsSection.find(".grid").scrollTo(n)}},addAction:function(){var t=this.$actionsTbody.find("tr").length;if(d>t){var n=e(c({data:{name:"",actionType:this.model.ACTION_COMMENT},actionTypes:this.model.getActionTypes()})).appendTo(this.$actionsTbody);n.find("input").focus(),this.$actionsSection.find(".grid").scrollTo(n)}},moveCommentOrAction:function(e,t,n){var i=t.find("tr"),s=i.index(e);return 0===s&&n||s===i.length-1&&!n?!1:(n?e.insertBefore(e.prev()):e.insertAfter(e.next()),void 0)},removeCommentOrAction:function(e){e.remove()},saveComments:function(){var t=this,n=this.$commentsTbody.find("input"),i=[],s="";n.each(function(n){s=e.trim(e(this).val()),s.length&&i.push({num:n,msg:s,actionType:t.model.ACTION_COMMENT})}),m.requestCommentsOrActionsSave.call(this,"comments",i)},saveActions:function(){var t=this.$actionsTbody.find("input"),n=this.$actionsTbody.find("select"),i=[],s="",a=0,o={},r=!1;t.each(function(t){s=e.trim(e(this).val()),a=parseInt(n.get(t).value),s.length&&(a in o||(o[a]=0),o[a]++,i.push({num:t,actionType:a,name:s}))});for(var l in o)Number(l)!==this.model.ACTION_COMMENT&&o[l]>1&&(r=!0);if(r){var c=this.model.getTexts();alert(c.sameActionsError,c.error)}else m.requestCommentsOrActionsSave.call(this,"actions",i)},requestCommentsOrActionsSave:function(t,n){var i=this,s={};s[t]=n,this.$el.addClass("loading"),e.ajax({url:App.getBaseUrl()+"alert-"+t+"/save/",data:s}).done(function(){i.model.set(t,n)}).always(function(){i.$el.removeClass("loading")})},restoreDefaultCommentsOrActions:function(n){var i=this,s="comments"===n;this.$el.addClass("loading"),e.ajax({url:App.getBaseUrl()+"alert-"+n+"/restore/",data:{}}).done(function(){setTimeout(function(){e.ajax({url:App.getBaseUrl()+"alert-"+n+"/get/"}).done(function(e){var a=t.sortBy(e,"num");i.model.set(n,a),m.renderCommentsOrActionsRows.call(i,a,s?r:c,s?i.$commentsTbody:i.$actionsTbody)}).always(function(){i.$el.removeClass("loading")})},100)}).error(function(){i.$el.removeClass("loading")})},repeatSound:function(){return this._soundOn||this.model.get("soundOn")?!1:(m.playSound.call(this)&&(this.$el.find(".btn-play").removeClass("icon-play").addClass("icon-stop"),this._playInterval=setInterval(t.bind(m.playSound,this),this.model.get("soundInt")),this._soundOn=!0),void 0)},playSound:function(){return this._audio&&this._audio.play&&!this.model.get("soundOn")?(this._audio.play(),!0):!1},stopSound:function(){this.$el.find(".btn-play").removeClass("icon-stop").addClass("icon-play"),this._audio&&this._audio.pause&&this._audio.pause(),this._playInterval&&clearInterval(this._playInterval)&&(this._playInterval=null),this._soundOn=!1}};return h}),define("_common/alerts/guards/AlertsGuardsCollection",["_common/guards/GuardsCollection"],function(e){var t=e.extend({constructor:function(){this.name="nearest",e.apply(this,arguments)},comparator:function(e,t){var n=e.get("isBound"),i=t.get("isBound");if(n^i)return n?-1:1;if((e.has("route")||t.has("route"))&&t.has("route")){if(e.has("route")){var s=e.get("route").get("meta"),a=t.get("route").get("meta");return"undefined"==typeof s.trafficTime||"undefined"==typeof a.trafficTime?s.time>a.time?1:-1:s.trafficTime>a.trafficTime?1:-1}return 1}return e.has("distance")&&t.has("distance")?e.get("distance")>t.get("distance")?1:-1:-1},anyArrived:function(){return this.find(function(e){return e.arrived()})},anyAccepted:function(){return this.find(function(e){return e.acceptedCall()})}});return t}),define("_common/alerts/guards/views/GuardView",["jquery","underscore","abstracts/View"],function(e,t,n){n.prototype;var i=n.extend({constructor:function(e){this.controller=e.controller,this.parent=e.parent,n.apply(this,arguments)},initialize:function(){this._bindEvents()},_bindEvents:function(){var e=this,n=this.controller,i=this.model;t.each(["name","phone","person"],function(t){e.listenTo(e.model,"change:"+t,function(n,i){e.$el.find("."+t).text(i||"--")})}),this.listenTo(i,"change:route",function(t,n){var s=i.previous("route");s&&e.stopListening(s),n&&e._bindRouteEvents()}),this.model.has("guardCall")&&this.listenTo(i,"change:guardCall",function(t,s){if(s){var a=i.previous("guardCall"),o=!a.acceptTs&&s.acceptTs,r=!a.arrivedAt&&s.arriveTs;o?e.$el.addClass("accepted").find(".call-not-accepted").remove().end().find(".accept-time").text(e.parent.formatTime(s.acceptTs)):r&&(e.$el.addClass("arrived").find(".guard-route").remove().end().find(".arrive-time").text(e.parent.formatTime(s.arriveTs)),t.id==n.get("selectedGuard").id&&e.parent.setBtnCompleteText(!0))}}),this.model.has("route")&&e._bindRouteEvents(),this.listenTo(n,"change:selectedGuard",function(t,n){var s=-1!=e.el.className.indexOf("selected");!s||n&&n.id==i.id?!s&&n&&n.id==i.id&&e.$el.addClass("selected"):e.$el.removeClass("selected")}),this.$el.on("click",function(){n.setSelectedGuard(i)})},_bindRouteEvents:function(){var e=this,t=this.model.get("route");this.listenTo(t,"change:meta",function(t,n){e.$el.find(".time").html(n.roundTimeS).attr("data-value",n.time),e.$el.find(".length").html(n.roundLengthS).attr("data-value",n.length)})}});return i}),define("text!_common/alerts/guards/tmpl/list.html",[],function(){return'<ul></ul>\n<div class="guards-list-actions">\n    <a href="#" class="btn btn-block btn-action guard-send-call">\n        <%= i18n.assignRRT %>\n    </a>\n    <a href="#" class="guard-cancel-search">\n        <%= i18n.cancel.ucFirst() %>\n    </a>\n</div>'}),define("text!_common/alerts/guards/tmpl/calledList.html",[],function(){return'<ul></ul>\n<div class="guards-list-actions">\n    <a href="#" class="btn btn-block btn-action guards-complete-call">\n        <%= action %>\n    </a>\n</div>'}),define("text!_common/alerts/guards/tmpl/row.html",[],function(){return'<li class="guards-list-item <%= className %>" data-id="<%= id %>" data-isbound="<%= isBound %>">\n    <% if(!called && hasCoords && routeMeta) {%>\n        <h5 class="is-nearest"><%= i18n.nearestRRT %></h5>\n    <% } %>\n\n    <h4 class="guard-header"><span data-prop="name"><%- name %></span></h4>\n\n    <p class="guard-feature">\n        <strong><%= i18n.rrtPerson %>:</strong>\n        <span class="person"><%- person || \'--\' %></span>\n    </p>\n    <p class="guard-feature">\n        <strong><%= i18n.phone.ucFirst() %>:</strong>\n        <span class="phone"><%- phone || \'--\' %></span>\n    </p>\n\n    <% if(guardCall) {%>\n        <p class="guard-feature">\n            <strong><%= i18n.rrtCallTime %>:</strong>\n            <span class="call-time"><%= callTime %></span>\n        </p>\n        <% if(!accepted) {%>\n            <p class="guard-feature call-not-accepted">\n                <strong><%= i18n.rrtCallNotAccepted %></strong>\n            </p>\n        <% } %>\n        <p class="guard-feature call-accepted">\n            <strong><%= i18n.rrtCallAccepted %>:</strong>\n            <span class="accept-time"><%= acceptTime %></span>\n        </p>\n        <p class="guard-feature guard-arrived">\n            <strong><%= i18n.rrtArriveTime %>:</strong>\n            <span class="arrive-time"><%= arriveTime %></span>\n        </p>\n    <% } else { %>\n    <!--No guard call-->\n    <% } %>\n\n    <% if(!arrived && hasCoords) {%>\n        <div class="guard-route">\n            <% if(routeMeta) {%>\n                <% if(\'undefined\' == typeof routeMeta.trafficTime) {%>\n                <p class="msg alert"><%= i18n.routeNoTrafficAlert %></p>\n                <% } %>\n                <p class="data no-margin"><%= i18n.rrtRouteTime %>: <strong class="time" data-value="<%= routeMeta.time || \'\' %>"><%= routeMeta.roundTimeS || \'\' %></strong></p>\n                <p class="data no-margin"><%= i18n.distance %>: <strong class="length" data-value="<%= routeMeta.length || \'\' %>"><%= routeMeta.roundLengthS || \'\' %></strong></p>\n            <% } else if(isGpsOnline) { %>\n                <p class="msg error no-margin"><%= i18n.errCanNotBuildRoute %></p>\n            <% } %>\n        </div>\n    <% } %>\n\n    <% if(isBound) {%>\n    <svg class="svg-icon icon-bound">\n        <use xlink:href="#smb-star"></use>\n    </svg>\n    <% } %>\n\n</li>'}),define("text!_common/alerts/guards/tmpl/empty.html",[],function(){return'<div class="find-nearest">\n    <div class="centered-wrapper">\n        <div class="find-nearest-content centered-block">\n            <% _.each(messages, function(msg){ %>\n            <p class="msg"><%= msg %></p>\n            <% }) %>\n\n            <a href="#" class="find-manually<% if(!boundGuards) {%> hidden<% } %>"><%= i18n.rrtSelectManually %></a>\n\n            <div class="field">\n                <span class="help-inline"><%= i18n.anotherRadius %>, <%= i18n.km %></span>\n                <input class="input-mini positive" type="text" value="<%= maxRRTDist || 10 %>" name="maxDist">\n            </div>\n        </div>\n    </div>\n    <div class="guards-list-actions">\n        <button class="btn btn-block btn-action find-nearest-btn"><%= i18n.repeatSearch %></button>\n    </div>\n</div>\n'}),define("_common/alerts/guards/views/GuardsListView",["jquery","underscore","moment","abstracts/View","./GuardView","text!../tmpl/list.html","text!../tmpl/calledList.html","text!../tmpl/row.html","text!../tmpl/empty.html"],function(e,t,n,i,s,a,o,r,l){a=t.template(a),o=t.template(o),r=t.template(r),l=t.template(l);var c=i.prototype,d=i.extend({constructor:function(e){this.controller=e.controller,this._children={},this.$list=null,this.$btnComplete=null,i.apply(this,arguments)},initialize:function(){this._bindEvents()},_bindEvents:function(){var e=this,t=this.collection,n=this.controller;this.listenTo(t,"sync",function(t,n,i){i&&i.initial&&e.render()}).listenTo(t,"remove",function(t){e._children[t.id].remove()}),n.get("showCalled")&&this.listenTo(t,"add",function(t){u.renderGuard.call(e,t)}),this.listenTo(n,"change:selectedGuard",function(t,n){e.setBtnCompleteText(n.arrived())}),this.$el.on("click",".guard-send-call",function(){n.has("selectedGuard")&&n.callGuard(n.get("selectedGuard"))}).on("click",".guard-cancel-search",function(){n.cancelSearch()}).on("click",".guards-complete-call",function(){n.has("selectedGuard")&&n.completeCall(n.get("selectedGuard"))})},render:function(){var n=this.controller,i=n.getTexts(),s=this.collection;if(s.length){var r=this,c=n.get("showCalled"),d=n.get("selectedGuard"),h=c?o:a;this.$el.empty(),this.$list=e(h({i18n:i,action:i[c&&d.arrived()?"rrtCompleteCallShort":"rrtCancelCallShort"]})).appendTo(this.$el).filter("ul"),s.each(function(e){u.renderGuard.call(r,e)}),this.$btnComplete=this.$el.find(".guards-complete-call")}else{var m=t.filter(n.get("parent").get("device").get("boundGuards"),function(e){return!e.lastCall||e.lastCall.doneTs});this.$el.html(l({i18n:i,maxRRTDist:n.get("parent").getUserData("maxRRTDist"),messages:this.controller.get("messages"),boundGuards:m&&m.length>0})),this.$btnComplete=null}},setBtnCompleteText:function(e){if(this.$btnComplete){var t=this.controller.getTexts();this.$btnComplete.text(t[e?"rrtCompleteCallShort":"rrtCancelCallShort"])}},formatTime:function(e){return n(e).format("DD.MM HH:mm:ss")},clear:function(){var e=this._children;t.each(e,function(t,n){t&&(t.remove(),delete e[n])})},remove:function(){this.clear(),c.remove.call(this)},getContainer:function(){return null}}),u={renderGuard:function(n){var i=n.get("route")||null,a=n.get("guardCall"),o=this.controller.get("selectedGuard"),l=[],c=t.extend({},n.attributes,{i18n:this.controller.getTexts(),className:"",routeMeta:i?i.get("meta"):null,selected:o&&o.id==n.id,called:null!==a,hasCoords:n.get("lat")&&n.get("lon"),callTime:"",accepted:n.acceptedCall(),acceptTime:"",arrived:n.arrived(),arriveTime:""});o&&o.id==n.id&&l.push("selected"),c.called&&(c.callTime=this.formatTime(a.callTs)),c.accepted&&(l.push("accepted"),c.acceptTime=this.formatTime(a.acceptTs)),c.arrived&&(l.push("arrived"),c.arriveTime=this.formatTime(a.arriveTs)),c.className=l.join(" "),this._children[n.id]=new s({controller:this.controller,model:n,parent:this,el:e(r(c)).appendTo(this.$list)})}};return d}),define("_common/alerts/guards/watched/views/AlertsGuardsWatchedView",["underscore","_common/guards/watched/views/GuardsMapView"],function(e,t){var n=t.prototype,i=t.extend({constructor:function(){t.apply(this,arguments)},remove:function(){var t=this;e.each(this._viewsMap,function(e){t._singlesLayer.removeLayer(e)}),this._viewsMap={},n.remove.call(this)}});return i}),define("_common/alerts/guards/watched/AlertsGuardsWatchedModule",["underscore","_common/guards/watched/GuardsWatchedModule","./views/AlertsGuardsWatchedView"],function(e,t,n){var i=t.prototype,s=t.extend({constructor:function(e){this.items=e.parent.getWatchedCollection(),t.apply(this,arguments)},_viewClass:n,defaults:e.extend({},i.defaults,{showBaloon:!1}),destroy:function(){this.stopListening(),App.unsubscribe(this),this._view.remove()},getWatchedItemsIds:function(){return this.get("parent").getWatchedCollection().pluck("id")},_bindEvents:function(){i._bindEvents.call(this),this.off("change:bounds")}});return s}),define("_common/alerts/guards/AlertsGuardsModule",["jquery","underscore","geo","abstracts/BaseModule","_common/guards/Guard","./AlertsGuardsCollection","./views/GuardsListView","./watched/AlertsGuardsWatchedModule","_common/guards/update/GuardsUpdateModule","_common/guards/watched/GuardsWatchedModule","_common/guards/watched/views/GuardsMapView"],function(e,t,n,i,s,a,o,r,l){var c=i.prototype,d=50,u=[40,40],h=i.extend({constructor:function(e){this.guards=new a,this.calledGuards=new a,this.calledGuards.name="called",this.nbNewCalls=0,this.calledByMe={},this.completeByMe={},this._searchXhr=null,this._maps=e.mapsModule,this._nbOffline=0,this._nbBusy=0,this._nbBoundBusy=0,i.apply(this,arguments)},defaults:t.extend({},c.defaults,{deviceId:0,loading:!1,updating:!1,messages:[],selectedGuard:null,showCalled:!1}),clearCollection:function(){m.clearCollection.call(this,this.guards)},initialize:function(){var e=this,t=this.get("parent"),n=t.get("device").id;this._i18n=t.getTexts(),this.set("deviceId",n),m.buildListView.call(this),m.loadCalledGuards.call(this,n).done(function(n){n.length&&t.get("device").id==e.get("deviceId")?(e.nbNewCalls=n.length,m.setCalledGuards.call(e,n)):(e.get("parent").trigger("guards:change:called",{called:!1}),m.waitForSocketCalls.call(e))})},buildModules:function(){var e=this,n=this.modules,i={watched:r,update:l};t.each(i,function(t,i){n[i]=new t({id:e.id+"/"+i,parent:e,options:e._getModuleOptions(i)})}),this._bindEvents(),this.set("ready",!0)},setSelectedGuard:function(e){var t=this.get("selectedGuard");t&&t.id==e.id||this.set("selectedGuard",e),m.zoom.call(this,e)},findNearest:function(n){if(!this.get("loading")){var i=this,a=5,o=this.get("parent"),r=o.get("device"),l=r.get("coords"),n=parseFloat(n),c=l&&l[1],d=l&&l[0],u=this.getTexts(),h=this.get("showCalled"),p=this.get("selectedGuard");isNaN(n)||0>=n||d&&c&&(this.set("deviceId",r.id),o.setUserData("maxRRTDist",n),o.saveLog(u.searchRRTWithin.replace("#r#",n)),this.reset(),this.set({selectedGuard:null,loading:!0,showCalled:!1,messages:[]}),this._nbOffline=0,this._nbBusy=0,this._searchXhr=e.ajax({url:App.getBaseUrl()+"guards/find-nearest/",data:{maxDist:1e3*n,lat:d,lon:c,limit:500,objectId:r.id},success:function(e){var r=0,l=0,c=[];if(t.each(e,function(e){e.isGpsOnline=e.coordinatesTime>0&&+new Date-e.coordinatesTime<s.prototype.COORDS_EXPIRE_TIME,e.guardCall?r++:e.isOnline&&e.isGpsOnline?c.push(e):l++}),e.length)c.length||(i._nbBusy=r,i._nbOffline=l,m.saveSearchFailLogs.call(i));else{var d=u.noRRTWithin.replace("#r#",n);o.saveLog(d),i.set("messages",[d])}if(h){if(m.toggleRoutesAttr.call(i,i.calledGuards,"hidden",!0),p){var f;(f=p.get("route"))&&f.set("active",!1)}m.buildListView.call(i)}m.setFoundGuards.call(i,c.slice(0,a),!0)},error:function(e){i.get("parent").getView().showErrors(e),i.set({visible:!1,loading:!1})}}))}},findBoundGuards:function(){var e=this,n=this.get("parent");this.set("loading",!0),this._nbBoundBusy=0,n.getDeviceGuards().done(function(n){var i=t.filter(n,function(e){return!e.lastCall||e.lastCall.doneTs});i.length?m.buildListView.call(e):(e._nbBoundBusy=n.length,m.saveSearchFailLogs.call(e)),m.setFoundGuards.call(e,i,!1)}).fail(function(){e.set("loading",!1)})},cancelSearch:function(){m.clearCollection.call(this,this.guards),this.reset(),this.calledGuards.length?(this.set("showCalled",!0),this.setSelectedGuard(this.calledGuards.at(0)),m.buildListView.call(this).render(),this.buildModules(),m.toggleRoutesAttr.call(this,this.calledGuards,"hidden",!1)):this.set({selectedGuard:null,visible:!1})},buildRoute:function(t){var i=this,s=this._maps,a=this.get("parent").get("device"),o=a.get("coords"),r=new e.Deferred;return o&&o[0]&&o[1]&&t.lat&&t.lon&&t.isGpsOnline?(setTimeout(function(){s.buildRoute([{type:"guard",lat:t.lat,lon:t.lon,text:t.name},{type:a.get("objType")==App.TYPE_STAT?"stat":"mobile",lat:o[0],lon:o[1],text:a.get("name")}],{active:!1}).done(function(e){i.get("deviceId")==i.get("parent").get("device").id&&(t.route=e,r.resolve(e))}).fail(function(){i.get("deviceId")==i.get("parent").get("device").id&&(t.distance=n.getDistanceBetweenPoints(t.lat,t.lon,o[0],o[1]),r.reject())})},100),r):r.resolve()},callGuard:function(t){var n=this,i=this.get("parent"),s=n._i18n.rrtCalled;return n.set("loading",!0),e.ajax({url:App.getBaseUrl()+"guards/call-guard/",data:{guardId:t.id,objectId:i.get("device").id,msg:s+": "+m.makeLogList.call(n,[t])}}).done(function(e){t.set("guardCall",e,{silent:!0}),m.switchToCalledGuards.call(n,t),i.trigger("guards:change:called",{called:!0,arrived:!1,accepted:!1})}).fail(function(e){i.getView().showErrors(e)}).always(function(){n.set("loading",!1)})},completeCall:function(t){var n=this,i=t?[t.id]:this.calledGuards.pluck("id"),s=this.get("parent");return n.set("loading",!0),e.ajax({url:App.getBaseUrl()+"guards/call-complete/",data:{guardId:i}}).done(function(){for(var e=i.length;e--;)i[e]in n.calledByMe&&delete n.calledByMe[i[e]],n.completeByMe[i[e]]=1;t?m.excludeGuard.call(n,t):(m.clearCollection.call(n,n.calledGuards),n.get("showCalled")&&n.set("visible",!1),s.trigger("guards:change:called",{called:!1}))}).fail(function(e){s.getView().showErrors(e)}).always(function(){n.set("loading",!1)})},forceCallAccept:function(){var n=this,i=this.calledGuards.pluck("id"),s=this.get("parent");i.length&&(n.set("loading",!0),t.each(i,function(i){!function(i){e.ajax({url:App.getBaseUrl()+"guards/accept-call/",data:{guardId:i}}).done(function(){s.trigger("guards:change:called",{called:!0,accepted:!0});var e=n.calledGuards.get(i),a=e.get("guardCall");e.set("guardCall",t.extend({},a,{acceptTs:+new Date}))}).fail(function(e){s.getView().showErrors(e)}).always(function(){n.set("loading",!1)})}(i)}))},forceCallArrive:function(){var n=this,i=this.calledGuards.pluck("id"),s=this.get("parent");i.length&&(n.set("loading",!0),t.each(i,function(t){!function(t){e.ajax({url:App.getBaseUrl()+"guards/arrive-call/",data:{guardId:t}}).done(function(){s.trigger("guards:change:called",{called:!0,arrived:!0})}).fail(function(e){s.getView().showErrors(e)}).always(function(){n.set("loading",!1)})}(t)}))},getWatchedCollection:function(){return this.get("showCalled")?this.calledGuards:this.guards},reset:function(){var e=this.modules;return this.off("change:selectedGuard"),this.stopListening(),App.unsubscribe(this),t.each(e,function(t,n){t.destroy(),delete e[n]}),this},destroy:function(){this.reset()},_getPathes:function(){return[]},_getModuleOptions:function(e){return"watched"==e?{showBaloon:!1}:null},_bindEvents:function(){var e=this,n=this.get("parent"),i=n.get("device");c._bindEvents.call(this),this.stopListening(App,"clearmap"),this.listenTo(App,"closealarms",function(){m.pauseUpdate.call(e)}).listenTo(App,"openalarms",function(){m.resumeUpdate.call(e)}).listenTo(App,"change:visible",function(t,n){n?m.resumeUpdate.call(e):m.pauseUpdate.call(e)}),m.waitForSocketCalls.call(this),this.listenTo(n,"action",function(t){t===n.ACTION_GUARD_CANCEL||t===n.ACTION_GUARD_COMPLETE?e.completeCall():t===n.ACTION_GUARD_ACCEPT?e.forceCallAccept():t===n.ACTION_GUARD_ARRIVE&&e.forceCallArrive()}),this.listenTo(i,"change:coords",function(t,n){e.get("visible")&&(n&&n[0]&&n[1]?e.getWatchedCollection().each(function(t){m.updateRoute.call(e,t,n,!0)}):m.clearRoutes.call(e))}),e.getWatchedCollection().each(function(t){m.bindGuardEvents.call(e,t)}),this.listenTo(this._maps,"mapchanged",t.bind(m.onMapSourceChanged,this)),this.on("change:selectedGuard",function(){var t=e.previous("selectedGuard");t&&t.has("route")&&t.get("route").set("active",!1)})},_addRoutes:function(){},_collectWatchedItemIds:function(){return this.modules.watched?this.modules.watched.getItemIdsForUpdate():(new e.Deferred).resolve([])}}),m={buildListView:function(){return this._view&&this._view.remove(),this._view=new o({controller:this,collection:this.getWatchedCollection(),el:e('<div class="guards-list"></div>').appendTo(this.get("parent").getView().getGuardsListContainer())}),this._view},loadCalledGuards:function(t){return e.ajax({url:App.getBaseUrl()+"guards/by-object/",data:{objectId:t}})},setFoundGuards:function(e,n){var i=this,s=(this.get("parent"),this.get("showCalled"),this.guards);this.set({visible:!0,loading:!0}),m.buildGuardsRoutes.call(this,e).done(function(){m.clearCollection.call(i,s),e.length&&(s.add(e,{parse:!0}),i.setSelectedGuard(s.at(0)),n&&m.saveFoundLog.call(i,s.models)),s.trigger("sync",s,e,{initial:!0}),i.set({updating:!0}),i.trigger("addmulti",t.pluck(e,"id")),i.buildModules()}).always(function(){i.set({loading:!1})})},setCalledGuards:function(e){var t=this,n=this.calledGuards,i=this.get("parent");this.set({visible:!0,loading:!0,showCalled:!0}),m.buildGuardsRoutes.call(t,e).done(function(){n.add(e,{parse:!0}),t.setSelectedGuard(n.at(0)),m.buildListView.call(t),n.trigger("sync",n,e,{initial:!0}),t.set({updating:!0,loading:!1}),t.buildModules(),i.trigger("guards:change:called",{called:!0,accepted:n.anyAccepted(),arrived:n.anyArrived()})})},addCalledGuardsWithRoutes:function(e){var t=this;return m.buildGuardsRoutes.call(this,e).done(function(){m.addCalledGuards.call(t,e)})},addCalledGuards:function(e){var n=this.calledGuards,i=n.length;t.each(e,function(e){n.add(e,{parse:!0})}),i||this.get("parent").trigger("guards:change:called",{called:!0,arrived:n.anyArrived()})},switchToCalledGuards:function(e){m.clearCollection(this.guards,e?e.id:!1),this.reset(),e&&this.calledGuards.add(e),this.set("showCalled",!0),m.buildListView.call(this).render(),this.buildModules(),m.toggleRoutesAttr.call(this,this.calledGuards,"hidden",!1)},onExternalCalls:function(e,n){var i=this,s=i.calledGuards,a=this.get("parent").get("device").id,o=s.length,r=n.length,l=e.length&&o||r;r&&(this.nbNewCalls+=r,this.nbNewCalls<=o&&(l=!1)),l&&m.loadCalledGuards.call(i,a).done(function(a){var o=t.indexBy(a,"id");if(e.length&&s.each(function(e){e.id in o||m.excludeGuard.call(i,e)}),n.length){var r=[];t.each(o,function(e,t){s.get(t)||r.push(e)}),r.length&&(i.get("showCalled")?m.addCalledGuardsWithRoutes.call(i,r):i.calledGuards.length?(m.switchToCalledGuards.call(i),i.set("loading",!0),m.addCalledGuardsWithRoutes.call(i,r).done(function(){i.set("loading",!1)})):m.setCalledGuards.call(i,r))}})},waitForSocketCalls:function(){var e=this;this.listenTo(this.get("parent"),"guards:calls",function(t,n){m.onExternalCalls.call(e,t,n)})},bindGuardEvents:function(e){var t=this,n=t.get("parent");this.listenTo(e,"change:coords",function(e){var i=n.get("device").get("coords");i&&i[0]&&i[1]&&m.updateRoute.call(t,e,i,!1)}),e.collection==this.guards?this.listenTo(e,"change:isOnline",function(n,i){i||(t._nbOffline++,m.excludeGuard.call(t,e))}).listenTo(e,"change:guardCall",function(n,i){i&&(t._nbBusy++,m.excludeGuard.call(t,e))}):this.listenTo(e,"change:guardCall",function(e){var t=e.previous("guardCall");(e.arrived()&&!t||null===t.arriveTs)&&n.trigger("guards:called:changed",{called:!0,arrived:!0})})},saveFoundLog:function(e){var t=this.get("parent").getUserData("maxRRTDist"),n=this.getTexts().foundRRTWithin.replace("#r#",t).replace("#list#",m.makeLogList.call(this,e));n.length>255&&(n=n.substr(0,252)+"..."),this.get("parent").saveLog(n)},makeLogList:function(t){for(var n,i=t.length,s=new Array(i),a=null,i=0,o=t.length;o>i;++i)n=t[i],s[i]=n.get&&n.get("name")||n.name,a=null,n.has&&n.has("route")?a=n.get("route").get("meta"):n.route&&(a=n.route.get("meta")),a&&(s[i]+=" ("+e.trim(a.roundTimeS.replace(new RegExp("&nbsp;","g")," "))+"/"+e.trim(a.roundLengthS.replace(new RegExp("&nbsp;","g")," "))+")");return s.join(", ")},saveSearchFailLogs:function(){var e=[],n=this.getTexts(),i=this.get("parent"),s=i.getUserData("maxRRTDist");this._nbBusy>0&&e.push(n.noVacantRRTWithin.replace("#n#",this._nbBusy).replace("#r#",s)),this._nbBoundBusy>0&&e.push(n.noVacantBoundRRT.replace("#n#",this._nbBoundBusy)),this._nbOffline>0&&e.push(n.noOnlineRRTWithin.replace("#n#",this._nbOffline).replace("#r#",s)),e.length&&t.each(e,function(e){i.saveLog(e)}),this.set("messages",e)},buildGuardsRoutes:function(n){var i=this,s=this.getMapsModule(),a=s.getMap(),o=this.getTexts(),r=new e.Deferred;return n.length?(a.routing()?a.loadRouting().fail(function(e){alert(e,o.error),r.resolve()}).done(function(){var s=[];t.each(n,function(e){!function(e){e.lat&&e.lon&&s.push(i.buildRoute(e))}(e)}),e.when.apply(window,s).always(function(){r.resolve()})}):(alert(o.errNoRoutingOnMap,o.error),r.resolve()),r):r.resolve()},updateRoute:function(e,t,i){var s=e.get("lat"),a=e.get("lon");if(e.has("route")){var o=e.get("route"),r=o.get("points")[i?1:0],l=i?t[0]:s,c=i?t[1]:a;n.getDistanceBetweenPoints(r.lat,r.lon,l,c)>d&&(o.setPointParams(0,{lat:s,lon:a}),o.setPointParams(1,{lat:t[0],lon:t[1]}),o.build().fail(function(){e.set({distance:n.getDistanceBetweenPoints(s,a,t[0],t[1])})}))}else{var u=this.get("selectedGuard");this.buildRoute(e.attributes).done(function(t){e.set({route:t}),u&&e.id==u.id&&t.set("active",!0)}).fail(function(){e.set({distance:n.getDistanceBetweenPoints(s,a,t[0],t[1])})})}},clearRoutes:function(){this.getWatchedCollection().each(function(e){e.has("route")&&e.set({route:null,distance:null})})},onMapSourceChanged:function(e){if(e.scode!=this._mapSourceCode){this._mapSourceCode=e.scode;var t=this.getWatchedCollection();if(t.length)if(e.routing()){var n=this,i=t.length,s=0;this.set("loading",!0),t.each(function(a){var o=a.get("route")||null;o?(n.listenToOnce(o,"sync",function(){++s>=i&&m.sortAndSync.call(n,t)}).listenToOnce(o,"error",function(){a.set("route",null),o.collection&&o.collection.remove(o),++s>=i&&m.sortAndSync.call(n,t)}),o.set("source",e)):n.buildRoute(a.attributes).always(function(){++s>=i&&m.sortAndSync.call(n,t)})})}else t.each(function(e){var t=e.get("route")||null;t&&(e.set("route",null),t.collection.remove(t))}),m.sortAndSync.call(this,t)}},sortAndSync:function(e){e.sort(),this.set("selectedGuard",e.at(0)),e.trigger("sync",e,[],{initial:!0}),this.set("loading",!1),m.zoom.call(this,this.get("selectedGuard"))},excludeGuard:function(e){var t,n=e.collection;(t=e.get("route"))&&t.collection&&t.collection.remove(t),n.remove(e),n.length?e.id==this.get("selectedGuard").id&&this.setSelectedGuard(n.at(0)):(n==this.calledGuards?(this.set("visible",!1),this.get("parent").trigger("guards:change:called",{called:!1})):(m.saveSearchFailLogs.call(this),n.trigger("sync",n,[],{initial:!0})),this.reset(),m.waitForSocketCalls.call(this))},clearCollection:function(e,t){e.each(function(e){if(!t||e.id!=t){var n;(n=e.get("route"))&&n.collection.remove(n)}}),e.remove(e.models)},toggleRoutesAttr:function(e,t,n){e.each(function(e){var i;(i=e.get("route"))&&i.set(t,n)})},pauseUpdate:function(){this.get("updating")&&(this.trigger("stopwatching"),this.set("updating",!1))},resumeUpdate:function(){this.get("updating")||(this.trigger("startwatching"),this.set("updating",!0))},zoom:function(e){var t=e.get("route");if(t)if(t.get("active")){var n=t.get("meta").bounds;this._maps.setBounds(n,{maxZoom:App.get("commonBoundsMaxZoom"),padding:u})}else t.set("active",!0);else{var i=this.get("parent").get("device"),n=[[],[]],s=i.get("lat"),a=i.get("lon"),o=e.get("lat"),r=e.get("lon");s&&a?o&&r?(n[0][0]=Math.min(s,o),n[0][1]=Math.min(a,r),n[1][0]=Math.max(s,o),n[1][1]=Math.max(a,r)):(n[0][0]=s,n[0][1]=a,n[1][0]=s,n[1][1]=a):(n[0][0]=o,n[0][1]=r,n[1][0]=o,n[1][1]=r),this._maps.setBounds(n,{maxZoom:App.get("commonBoundsMaxZoom"),padding:u})}}};return h}),define("_common/guards/GuardExt",["underscore","jquery","abstracts/Model"],function(e,t,n){function i(e){return null!==e&&"coords"in e&&"latitude"in e.coords&&"longitude"in e.coords&&"timestamp"in e}var s=n.extend({COORDS_EXPIRE_TIME:3e5,constructor:function(){n.apply(this,arguments)},defaults:{extId:0,name:"",isOnline:!1,isVacant:!0,geoRitmObjectId:0,hwStatus:"offline",position:null,lat:0,lon:0,coords:[0,0]},parse:function(e){e.hwStatus=s.detectHardwareStatus(e);var t=e.position||{};return t.coords=t.coords||{latitude:0,longitude:0},e.lat=t.coords.latitude,e.lon=t.coords.longitude,e.coords=[t.coords.latitude,t.coords.longitude],e},acceptedCall:function(){var e=this.get("guardCall");return e&&null!==e.acceptTs},arrived:function(){return!1},hasTargetInfo:function(){var e=this.get("guardCall");return e&&"id"in e.target},cancelCall:function(){return(new t.Deferred).reject("Call can not be cancelled for external guard")}});return s.detectHardwareStatus=function(e){if(e.isOnline){var t=e.position;if(!i(t))return"fault";var n=t.timestamp;return+new Date-n>=s.prototype.COORDS_EXPIRE_TIME?"fault":"online"}return"offline"},s}),define("_common/alerts/guards/AlertsGuardsModuleExt",["jquery","underscore","geo","abstracts/Module","_common/guards/GuardExt","text!_common/guards/watched/tmpl/mapIcon.svg"],function(e,t,n,i,s,a){function o(e,t){return l(e.filter(function(e){return e.geoRitmObjectId===t}))}function r(e,t){var n=!0;return e.length!==t.length?n=!1:e.forEach(function(e,i){e.id!==t[i].id&&(n=!1)}),n}function l(e){return e.sort(function(e,t){return e.id-t.id})}i.prototype;var c=[40,40],d=i.extend({constructor:function(e){this.guards=[],this._maps=e.mapsModule,this._xhr=null,this._updateTimeout=null,this._expireTimeout=null,this._zoom=this._zoom.bind(this),this._handleChangeMapVisible=this._handleChangeMapVisible.bind(this),this._handleChangeCoords=this._handleChangeCoords.bind(this),this._handleChangeHwStatus=this._handleChangeHwStatus.bind(this),i.apply(this,arguments)},initialize:function(){this._bindEvents(),this._isVisible()&&this._update()
},getObjectId:function(){return this.get("parent").get("device").id},getDataSource:function(){return this.get("options").dataSource},getTexts:function(){return this.get("parent").getTexts()},getUpdatePeriod:function(){return this.get("options").updatePeriod},stopUpdate:function(){this._clearUpdateTimeout(),this._xhr&&this._xhr.abort()&&(this._xhr=null)},destroy:function(){this.stopUpdate(),this.stopListening()},_bindEvents:function(){var e=this.get("parent");e.get("device"),this.listenTo(App,"change:visible",this._handleChangeMapVisible).listenTo(e,"change:deviceActivePage",this._handleChangeMapVisible).listenTo(e,"change:visible",this._handleChangeMapVisible)},_handleChangeMapVisible:function(){this._isVisible()?this._update():this._clearUpdateTimeout()},_isVisible:function(){var e=this.get("parent");return App.get("visible")&&"map"===e.get("deviceActivePage")&&e.get("visible")},_handleChangeCoords:function(e,t){if(this._isVisible()){var n=e.get("marker"),i={model:e,to:{lat:t[0],lon:t[1]},animate:!1};n.trigger("place",i)}},_handleChangeHwStatus:function(e,t){if(this._isVisible()){var n=e.get("marker"),i=e.previous("hwStatus");n.trigger("toggleclass",{off:i,on:t})}},_setUpdateTimeout:function(){this._clearUpdateTimeout(),this._updateTimeout=setTimeout(this._update.bind(this),this.getUpdatePeriod())},_clearUpdateTimeout:function(){this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null)},_update:function(){this._requestData().done(function(e){var t=o(e,this.getObjectId());r(t,this.guards)?this.guards.forEach(function(e,n){e.set(e.parse(t[n]))}):(this.guards=t.map(function(e){var t=new s;return t.set(t.parse(e)),t.on("change:coords",this._handleChangeCoords),t.on("change:hwStatus",this._handleChangeHwStatus),t}.bind(this)),this._isVisible()&&this._showGuardsOnMap(this.guards)),this._isVisible()&&this._setUpdateTimeout()}.bind(this)).fail(function(){this._isVisible()&&this._setUpdateTimeout()}.bind(this))},_requestData:function(){return this.getDataSource().fetchList()},_showGuardsOnMap:function(e){this._clearMapLayer();var t=[];e.forEach(function(e){var n=this._buildMapElement(e);e.set("marker",n),t.push(n)}.bind(this)),this._createMapLayer(t),setTimeout(this._zoom,50)},_createMapLayer:function(e){this._guardsLayer=this._maps.addLayersGroup({layers:e||[],clusters:!1})},_clearMapLayer:function(){this._guardsLayer&&this._guardsLayer.trigger("destroy")},_buildMapElement:function(e){var n=["complex-icon","obj","guard",e.get("hwStatus"),"busy"],i=this._maps.getWidget().buildComplexMarker({lat:e.get("lat"),lon:e.get("lon"),html:'<i class="i">'+a+'</i><span class="name">'+t.escape(e.get("name"))+"</span>",className:n.join(" "),dataId:e.id,animated:!1,model:e});return i},_zoom:function(){var e=this.guards,t=this.get("parent").get("device"),n=e.slice(0),i=t.get("lat"),s=t.get("lon"),a=[[90,180],[-90,-180]];i&&s&&n.push(t),n.forEach(function(e){var t=e.get("lat"),n=e.get("lon");a[0][0]=Math.min(a[0][0],t),a[0][1]=Math.min(a[0][1],n),a[1][0]=Math.max(a[1][0],t),a[1][1]=Math.max(a[1][1],n)}),this._maps.setBounds(a,{maxZoom:App.get("commonBoundsMaxZoom"),padding:c})}});return d}),define("_common/alerts/nls/alerts",{root:{alarmsWindow:"Alarm window",historyWindow:"Event window",alarmsOnNObjects:"#alarms# at #n# #objects#",onObjectsWhichLabels:function(e){return 1==e?0:1},onObjectsLabels:["object","objects"],action:"Action",actions:"Actions",comments:"Comments",objectLog:"Log",showEvents:"Show events",showOnlyLogEntries:"Show only log entries",filterByDate:"Filter by date",resolveAlarm:"Resolve alarm",resolveAlarms:"Resolve alarms",resolveAllAlarmsOnObj:"Resolve all alarms at the selected object",resolveAllAlarms:"Resolve all alarms at all objects",resolveAllAlarmsShort:"Resolve all alarms",createAlarm:"Generate an alarm",typeAction:"Enter an action",typeAnotherAction:"Enter another action",submitAction:"Submit",typeComment:"Enter a comment",typeAnotherComment:"Enter another comment",submitComment:"Save",sound:"Sound",windowTooSmallForAlarms:"Screen size do not allow alarm window processing",noAlarmObjects:"There are no objects with alarms.",noAlarmObjectsUseSearch:"There are no objects with alarms, please use the search function.",noAlarmsOnSelectedObject:"There are no alarms at the selected object.",objectHasNoCoords:"Object coordinates are not defined.",noHistoryRows:"No entries.",searchRRTWithin:"Search of RRT in #r# km radius",abortSearchRRTWithin:"Search of RRT in #r# km radius is aborted",noRRTWithin:"There are no RRT in #r# km radius",noVacantRRTWithin:"#n# RRTs in #r# km radius on callout",noVacantBoundRRT:"#n# assigned RRTs on callout",noOnlineRRTWithin:"#n# RRTs in #r# km radius offline",foundRRTWithin:"RRTs are found in #r# km radius: #list#",RRTAssigned:"#info# RRT is assigned",RRTCancelled:"#info# RRT assignment is cancelled",RRTArrived:"RRT has arrived at the object",nearestRRT:"The nearest RRT",rrtRouteTime:"Time of arrival",rrtRouteTimeUnknown:"Is not defined",assignRRT:"Call RRT",cancelRRT:"Cancel call",completeRRTCall:"Complete call",commentsList:"Comments list",commonAlertsSettings:"General settings",setDefaultComments:"Reset comments to default",setDefaultCommentsConfirm:{hdr:"Reset?",msg:"Reset comments to default? Existing comments will be deleted."},actionsList:"Action list",addAction:"Add action",actionTitle:"Action name",actionExecuted:"Active job",setDefaultActions:"Set defaults",sameActionsError:"Set buttons with the same actions is prohibited, except for logging.",setDefaultActionsConfirm:{hdr:"Set defaults?",msg:"Set button texts and active jobs defaults?"},errors:{canNotLoadInitialData:"Failed to load data for initialisation of alarm processing.",longText:"Text can not contain more than #n# symbols",canNotResolveAlarms:"Server error. Failed to resolve #t#.",canNotSaveLog:"Server error. Failed to save data."},alarmsAndAlertsSettings:{windowMode:"Alarm window view",historyWindowMode:"Event window view",windowModeCompact:"Compact",windowModeExtended:"Extended",alarmSoundHeader:"Alarm sound",windowOpenMode:"Alarm window display",windowOpenManually:"Only manually",windowAutoOpen:"Automatically on new alarm notification",soundInterval:"Recurrence interval",trackLength:"Length of the displayed track"},maxAllowedWarningComments:"Maximum of allowed comments is reached",maxAllowedWarningActions:"Maximum of allowed actions is reached",confirmDeleteAction:{text:"Delete the action?",title:""},confirmDeleteComment:{text:"Delete the comment?",title:""},errTrackLength:"Track length can be from #min# to #max# metres.",key:"Key",errNotOnline:"Connection to the server is absent.",errCanNotSearchNearestRRT:"Coordinates of the object are not defined, unable to complete search for the nearest RRTs.",delegateProcessingTo:'Delegate to "#name#"',delegateProcessingToExternal:"Delegate to external guard",selectCompanyToDelegate:"Select external guard",delegateProcessingCmd:"Send",accessToObjectLost:"You no longer have access to the selected object.",errNoOperatorsToDelegate:"All operators are offline. Delegation is not possible.",errEventHasNoCoords:"The selected event has no coordinates"},"ru-ru":!0,"it-it":!0}),define("_common/alerts/nls/ru-ru/alerts",{alarmsWindow:" ",historyWindow:" ",alarmsOnNObjects:"#alarms#  #n# #objects#",onObjectsWhichLabels:function(e){var t=e%10,n=Math.floor(e%100/10),i=1;return 1==t&&1!=n&&(i=0),i},onObjectsLabels:["",""],action:"",actions:"",comments:"",objectLog:"",showEvents:" ",showOnlyLogEntries:"   ",filterByDate:"  ",resolveAlarm:" ",resolveAlarms:" ",resolveAllAlarmsOnObj:"     ",resolveAllAlarms:"     ",resolveAllAlarmsShort:"  ",createAlarm:" ",typeAction:" ",typeAnotherAction:"  ",submitAction:"",typeComment:" ",typeAnotherComment:"  ",submitComment:"",sound:"",windowTooSmallForAlarms:"       ",noAlarmObjects:"   .",noAlarmObjectsUseSearch:"   ,  .",noAlarmsOnSelectedObject:"    .",objectHasNoCoords:"   .",noHistoryRows:" .",searchRRTWithin:"    #r# ",abortSearchRRTWithin:"    #r#  ",noRRTWithin:"    #r# ",noVacantRRTWithin:"#n#    #r#   ",noVacantBoundRRT:"#n#   ",noOnlineRRTWithin:"#n#    #r#    ",foundRRTWithin:"    #r# : #list#",RRTAssigned:"  #info#",RRTCancelled:"   #info#",RRTArrived:"   ",nearestRRT:" ",rrtRouteTime:" ",rrtRouteTimeUnknown:" ",assignRRT:" ",cancelRRT:" ",completeRRTCall:" ",commentsList:" ",commonAlertsSettings:" ",setDefaultComments:"   ",setDefaultCommentsConfirm:{hdr:"?",msg:"   &nbsp;?<br/>   ."},actionsList:" ",addAction:" ",actionTitle:" ",actionExecuted:" ",setDefaultActions:"   ",sameActionsError:"      ,    .",setDefaultActionsConfirm:{hdr:"?",msg:"        &nbsp;?"},errors:{canNotLoadInitialData:"       .",longText:"     #n# ",canNotResolveAlarms:" .    #t#.",canNotSaveLog:" .    ."},alarmsAndAlertsSettings:{windowMode:"  ",historyWindowMode:"  ",windowModeCompact:"",windowModeExtended:"",alarmSoundHeader:"  ",windowOpenMode:"  ",windowOpenManually:" ",windowAutoOpen:"    ",soundInterval:" ",trackLength:"  "},maxAllowedWarningComments:"    ",maxAllowedWarningActions:"    ",confirmDeleteAction:{text:" ?",title:""},confirmDeleteComment:{text:" ?",title:""},errTrackLength:"     #min#  #max# .",key:"",errNotOnline:"   .",errCanNotSearchNearestRRT:"    ,    .",delegateProcessingTo:' &nbsp;"#name#"',delegateProcessingToExternal:" &nbsp; ",selectCompanyToDelegate:"  ",delegateProcessingCmd:"",accessToObjectLost:"     &nbsp; .",errNoOperatorsToDelegate:"   .  .",errEventHasNoCoords:"    "}),define("_common/alerts/AlertsModule",["jquery","underscore","jface","abstracts/Module","abstracts/GrObject","_common/guards/Guard","./MobileWithAlarms","./StatWithAlarms","./DevicesCollection","./DeviceAlarmsCollection","./views/AlertsView","./views/AlertsViewExtended","./views/AlarmsNotificationView","./views/AlarmsSettingsView","./guards/AlertsGuardsModule","./guards/AlertsGuardsModuleExt","i18n!_common/nls/common","i18n!./nls/alerts","i18n!mobile/nls/mobile","i18n!stat/nls/stat"],function(e,t,n,i,s,a,o,r,l,c,d,u,h,m,p,f,g,v,_,b){function w(e,t){return Math.floor(Math.random()*(t-e+1))+e}var y=e.extend(!0,{},g,v,_,b),A=500,T=1e3,C=4002,x=4003,k=4010,S=1,M=3,I={36:!0},D=App.getBaseUrl()+"objects/obj-search/",E="ObjectAlert",O="ObjectAlertLog",j="_common/alerts/audio/",R=".mp3";"testlog_"+w(1,100)+"_";var L=i.extend({ACTION_RESOLVE_ALARM:1,ACTION_COMMENT:2,ACTION_GUARD_CALL:6,ACTION_GUARD_CANCEL:9,ACTION_GUARD_COMPLETE:11,ACTION_GUARD_ACCEPT:7,ACTION_GUARD_REJECT:8,ACTION_GUARD_ARRIVE:10,ACTION_CREATE_ALARM:12,ACTION_DELEGATE_PROCESSING:1e3,constructor:function(){"WebSocket"in window?(this._openCause=null,this._updateXhr=null,this._updateTimeout=null,this._xhr={history:null,guard:null},this._settingsView=null,this._withAlarmsMap={},this._ws=null,this._wsTimeout=null,this._wsOptions=null,this._sockActivity=!1,this._offlineTimeout=null,this._CSDCalls={},this._CSDCallsTimeouts={},i.apply(this,arguments)):alert("You can not use alarms module because WebSocket technology is not supported by your Browser!")},defaults:{online:!0,visible:!1,extended:!0,device:null,history:null,alarmDevices:null,soundOn:!1,soundOnMute:!1,alarmSound:"alarm",soundInt:4e3,trackLength:500,windowAutoOpen:!0,offlineMessage:!1,filter:"",filtered:null,logFilter:!1,updatePeriod:7e3,comments:[],actions:[],actionTypes:[],deviceActivePage:null,options:{useExternalGuards:!1,alarmDelegationAllowed:!1}},useExternalGuards:function(){return this.get("options").useExternalGuards},isAlarmDelegationAllowed:function(){return this.get("options").alarmDelegationAllowed},initialize:function(){var n=this,i=this.getTexts(),s=App.isAdmin(),a=this.useExternalGuards(),o=this.isAlarmDelegationAllowed(),r=App.isExternalAlarmOperator();t.each(["extended","alarmSound","soundInt","trackLength","logFilter","deviceActivePage"],function(e){var t=n.getUserData(e);("undefined"==typeof t||null===t)&&(t=n.defaults[e]),n.set(e,t)}),App.isAlarmOperator()&&n.set("extended",!0),App.isAdmin()&&this.set("windowAutoOpen",this.getUserData("windowAutoOpen")||!1),this.get("extended")&&N.makeView.call(this),this._settingsView=new m({model:this}),N.bindEvents.call(n);var l=[N.getTotalAlarmsNumber.call(this),e.ajax({url:App.getBaseUrl()+"alert-actions/get/"}),e.ajax({url:App.getBaseUrl()+"alert-comments/get/"})];s&&l.push(e.ajax({url:App.getBaseUrl()+"alert-actions/types/"})),e.when.apply(null,l).done(function(e,l,c,d){var u=App.allowed("alerts.edit"),m=App.allowed("alarm.create"),p=[this.ACTION_GUARD_CALL,this.ACTION_GUARD_ARRIVE,this.ACTION_GUARD_CANCEL,this.ACTION_GUARD_ACCEPT],f=[this.ACTION_COMMENT];a||App.isExternalAlarmOperator()||(f=f.concat(p));var g=t.sortBy(l[0],"num"),v=g.filter(function(e){var t=e.actionType;return a?(m||t!==this.ACTION_CREATE_ALARM)&&p.indexOf(t)<0:t!==this.ACTION_GUARD_COMPLETE&&(m||t!==this.ACTION_CREATE_ALARM)&&(u||f.indexOf(t)<0)}.bind(this));if(o&&!r){var _=this.ACTION_DELEGATE_PROCESSING;v=[{actionType:_,num:-1,name:i.delegateProcessingToExternal}].concat(v)}if(this.set({actions:v,comments:t.sortBy(c[0],"num")}),s){var b=d[0];a&&(b=b.filter(function(e){return p.indexOf(e.actionType)<0})),this.set({actionTypes:b})}if(this._notificationView=new h({model:n}),N.makeSocket.call(n,N.getSockParams.call(n)),App.allowed("alerts")){var w=e,y=App.isAlarmOperator();App.set("totalAlarms",w.count),(y||n.get("windowAutoOpen")&&w.count>0)&&n.openWindow().done(function(){n.set("soundOn",w.hasAlarmNotInProgress)}).fail(function(){N.showErrors.apply(n,arguments)})}}.bind(this))},reloadData:function(){var e=this,t=this.get("alarmDevices"),n=null!==t;t&&(t.remove(t.models,{reload:!0}),this.set({alarmDevices:null})),this._withAlarmsMap={};var i=this.has("device")?this.get("device").toJSON():null;App.allowed("alerts")?N.getTotalAlarmsNumber.call(this).done(function(t){App.set("totalAlarms",t.count),App.set("hasAlarmNotInProgress",t.hasAlarmNotInProgress),e.get("windowAutoOpen")&&t.count>0?(e.set("soundOn",t.hasAlarmNotInProgress),e.openWindow(i).fail(function(){e.set("soundOn",!1),N.showErrors.apply(e,arguments)})):n&&N.getInitialData.call(e,i)}):n&&N.getInitialData.call(this,i)},openWindow:function(t){var n=this,i=new e.Deferred,s=!1,a=null;return this.get("online")?(a=setTimeout(function(){App.loading("show"),s=!0},200),N.getInitialData.call(this,t||null).done(function(){n._view||N.makeView.call(n),n._view.openWindow(),n.get("extended")||setTimeout(function(){n.set("soundOn",!1)},5e3),i.resolve()}).fail(function(){N.showErrors.apply(n,arguments)}).always(function(){clearTimeout(a),s&&App.loading("hide")}),i):(this.toggleOfflineMessage(!0),i.reject())},searchObj:function(n){var i=this;return e.ajax({url:D,timeout:5e3,data:n}).done(function(e){var s=i.get("alarmDevices"),a=new l;t.each(e,function(e){a.add(s.get(e.id)||e)}),i.set({filter:n.q,filtered:a})})},loadDeviceHistory:function(t,n,i){var s=this,a=new e.Deferred,o=this.get("history"),r="undefined"!=typeof n&&"undefined"!=typeof i,l=this.get("device").id;return o&&o[t]?r?a.resolve(o[t].slice(n,n+i)):a.resolve(o[t]):(this._xhr.history&&(this._xhr.history.abort(),this._xhr.history=null),this._xhr.history=e.ajax({url:App.getBaseUrl()+"alerts/"+("alarms"===t?"history-from-last-alarm":"history-by-obj")+"/",data:{objectId:l},statusCode:{401:function(){N.onObjectAccessDenied.call(s,l)}},success:function(e){o="alarms"===t?{alarms:N.filterAlarms.call(s,e),alerts:null,logs:null}:{alarms:o&&o.alarms||null,alerts:N.filterAlerts.call(s,e),logs:s.get("extended")?e:N.filterLogs.call(s,e)},s.set("history",o),r?a.resolve(o[t].slice(n,n+i)):a.resolve(o[t])},error:function(e){a.reject(4==e.readyState?e:null)}}),a)},loadDeviceHistoryByPeriod:function(t,n,i){return e.ajax({url:App.getBaseUrl()+"alerts/history-on-obj/",data:{objectId:t,from:n,to:i}})},loadAlertsDetails:function(n){var i=new e.Deferred,s=t.pluck(n,"alertId");return s.length?e.ajax({url:App.getBaseUrl()+"alerts/data-all-on-obj/",data:{objectId:this.get("device").id,alertIds:s}}):i.resolve()},isLogEntry:function(e){return e&&e.type&&e.type===O},isAlertEntry:function(e){return e&&e.type&&e.type===E},isCommentType:function(e){return"undefined"==typeof I[e]},isCommentEntry:function(e){return e&&e.type&&e.type===O?this.isCommentType(e.actionType):!1},saveLog:function(t,n){var i=new e.Deferred,s=this.getTexts();return this.has("device")?t.length?t.length>255?i.reject(s.errors.longText.replace("#n#",255)):e.ajax({url:App.getBaseUrl()+"alerts/save-log/",statusCode:{500:function(){App.trigger("serverlost")}},data:{objectId:this.get("device").id,logComment:t,actionType:n||this.ACTION_COMMENT},error:function(){alert(s.errors.canNotSaveLog,s.error)}}):i.reject():i.resolve()},resolveAlarm:function(n){var i=this,s=new e.Deferred,a=this.getTexts(),o="close-open-alarm-all",r=a.commentAlarmResolved,l=1;n.objectId?o="close-open-alarm-on-obj":l=this.get("alarmDevices").length;var c={url:App.getBaseUrl()+"alerts/"+o+"/",data:t.extend(n,{closeComment:r}),500:function(){App.trigger("serverlost")},complete:function(e){if(e.status>=200&&e.status<300){var t=!1,n=setTimeout(function(){s.resolve(),t=!0},Math.max(Math.min(1e3*l,2e4),2e3));i.once("change:device",function(){t||(clearTimeout(n),s.resolve())})}else s.reject(e.status?e:y.errNotOnline)}};return n.alertId||n.objectId||(c.statusCode={401:function(){}}),e.ajax(c),s},setMapsModule:function(e){if(N.destroyChild.call(this,"maps"),this.modules.maps=e,this.get("extended")&&(App.get("grGuardsAvailable")||this.useExternalGuards())){N.destroyChild.call(this,"guards");var t=this.useExternalGuards(),n=t?f:p;this.modules.guards=new n({id:this.id+"/guards",parent:this,mapsModule:e,options:t?{dataSource:this.get("options").extGuardsDataSource,updatePeriod:this.get("options").extGuardsUpdatePeriod}:{}})}},getMapsModule:function(){return this.modules.maps},getDevicesData:function(e){return this.get("extended")?this.getDevicesExtendedData(e):App.getDevicesData(e)},getDevicesExtendedData:function(n){var i=this,s=new e.Deferred;return n.length?(e.when(App.getDevicesData(n),this.getAlarmProcessingStatus(n)).done(function(e,n){for(var i=t.indexBy(e[0],"id"),a=n[0],o=a.length,r=new Array(o);o--;)r[o]=t.extend(a[o],i[a[o].id]);s.resolve(r)}).fail(function(){s.reject(i.getTexts().errors.callServerFailed)}),s):s.resolve([])},getDeviceGuards:function(){var n=new e.Deferred,i=this.get("device");return this.useExternalGuards()?n.resolve([]):i&&i.get("objType")!=App.TYPE_MOBILE?(e.ajax({url:App.getBaseUrl()+"objects/obj-guards/",data:{objectId:i.id}}).done(function(e){t.map(e,function(e){return e.isBound=!0,e}),i.set("boundGuards",e),n.resolve(e)}).fail(function(e){n.reject(e)}),n):n.reject()},loadDeviceTechnician:function(){var n=new e.Deferred,i=this.get("device");return i.get("objStatus")!=i.STATUS_SERVICE?(i.set("tech",null),n.resolve(null)):(i.getStaff().done(function(e){var s=t.findWhere(e,{positionCode:App.POSITION_CODE_TECH});s&&i.set("tech",s),n.resolve(s)}).fail(function(){n.reject()}),n)},getDeviceGroups:function(){var t=new e.Deferred,n=this.get("device");return n?(e.ajax({url:App.getBaseUrl()+"objects/obj-groups/",data:{objectId:n.id},statusCode:{401:function(){}}}).done(function(e){n.set("groups",e),t.resolve(e)}).fail(function(e){t.reject(e)}),t):t.reject()},loadDeviceExtraSettings:function(){var t=new e.Deferred,n=this.get("device"),i=n.id;return n?(e.ajax({url:App.getBaseUrl()+"objects/obj-settings/",data:{objectId:[i],keys:["DESCRIPTION","shortDescription"]},statusCode:{401:function(){}}}).done(function(e){i in e&&(n.set("description",e[i].DESCRIPTION||""),n.set("shortDescription",e[i].shortDescription||""))}).fail(function(e){t.reject(e)}),t):t.reject()},getAlarmProcessingStatus:function(t){return e.ajax({url:App.getBaseUrl()+"alerts/alarm-status/",data:{objectId:t}})},getLastObjectLog:function(t){var n=new e.Deferred,i=this.get("alarmDevices").get(t);if(i){var s=i.get("lastLog");null==s?e.ajax({url:App.getBaseUrl()+"alerts/user-by-alarm/",data:{objectId:t}}).done(function(e){i.set("lastLog",e),n.resolve(e)}).fail(function(){n.reject()}):n.resolve(s)}else n.reject();return n},getAcceptedGuardCall:function(t){return e.ajax({url:App.getBaseUrl()+"alerts/guard-accepted-by-alarm/",data:{objectId:t}})},getArrivedGuard:function(t){return e.ajax({url:App.getBaseUrl()+"alerts/guard-arrival-by-alarm/",data:{objectId:t}})},getActions:function(){return this.get("actions")},getActionTypes:function(){return this.get("actionTypes")},getComments:function(){return this.get("comments")},getAlarmSoundFile:function(){return j+this.get("alarmSound")+R},autoUpdateNeeded:function(){return this.get("online")&&this.has("device")&&this.get("visible")&&App.get("visible")},getTexts:function(){return y},toggleOfflineMessage:function(e){if(!(e&&this.get("offlineMessage")||n.dialog.activeDialog)&&(e||this.get("offlineMessage"))){if(e){var t=this.getTexts();alert(t.errNotOnline,t.error)}else n.dialog.close();this.set("offlineMessage",e)}},delegateProcessing:function(){var t=new e.Deferred,i=this.get("device");return e.ajax({url:App.getBaseUrl()+"users/security-guards/",data:{}}).done(function(e){var s=this.getTexts();if(e.length)if(1===e.length)this._requestDelegate(i.id,e[0]).done(t.resolve).fail(t.reject);else{var a=e.map(function(e,t){return'<label class="radio"><input type="radio" name="securityGuardName" value="'+e+'"'+(0===t?"checked":"")+" />"+e+"</label>"}),o=this._requestDelegate.bind(this);n.confirm(a.join(""),s.selectCompanyToDelegate,{btnNames:{ok:s.delegateProcessingCmd},okCallback:function(){var e=this,n=e.find("input:checked");return n.length?(o(i.id,n[0].value).done(t.resolve).fail(t.reject),void 0):!1}})}else t.reject(s.errNoOperatorsToDelegate)}.bind(this)).fail(t.reject),t},_requestDelegate:function(t,n){return e.ajax({url:App.getBaseUrl()+"users/delegate/",data:{objectId:t,delegee:n}})},createAlarm:function(){var t=this.get("device");return e.ajax({url:App.getBaseUrl()+"alerts/create-general-alarm/",data:{objectId:t.id}}).done(function(){}.bind(this))}}),N={makeView:function(){var e=this,t=d;this._view&&this._view.remove(),e.get("extended")&&(t=u),e._view=new t({controller:e})},bindEvents:function(){var n=this,i=N.showErrors.bind(this);this.listenTo(App,"needdevicehistory",function(e){e&&(e.toJSON&&(e=e.toJSON()),n.openWindow(e).fail(i))}).listenTo(App,"openalarms",function(){n.get("extended")&&n.autoUpdateNeeded()&&N.updateObj.call(n)}).listenTo(App,"closealarms",function(){if(n.get("extended")){var e=n.get("device");e?e.get("hasAlarm")?N.stopUpdateObj.call(n):n.set("device",null):n._view&&(n._view.remove(),n._view=null)}else n._view&&(n._view.remove(),n._view=null),n.set("device",null)}).listenTo(App,"logout",function(){n._ws&&n._ws.close(C)}).listenTo(App,"stopall",function(){n._ws&&n._ws.close(x),N.setOfflineTimeout.call(n),n.listenToOnce(App,"startall",function(){n.toggleOfflineMessage(!1),N.clearOfflineTimeout.call(n),N.makeSocket.call(n,n._wsOptions),n.set("online",!0)})}).listenTo(App,"change:visible",function(e,t){n.get("extended")&&n.has("device")&&(t?n.autoUpdateNeeded()&&N.updateObj.call(n):N.stopUpdateObj.call(n))}),App.allowed("alerts")&&this.listenTo(App,"objStatus:change",function(e,i){var a=n.get("device");if(s.alarmsAllowed(i))a&&e==a.id&&a.set("objStatus",i);else if(n.has("alarmDevices")){var o,r=n.get("alarmDevices");(o=r.get(e))?(r.remove(e),N.onAlarmsOnDeviceResolved.call(n,o)):e==a.id&&a.set("objStatus",i)}else e in n._withAlarmsMap&&(delete n._withAlarmsMap[e],App.set("totalAlarms",t.keys(n._withAlarmsMap).length))}),App.allowed("alerts.edit")&&this.on("action",function(e){e===this.ACTION_DELEGATE_PROCESSING&&this.delegateProcessing().fail(i)}),App.allowed("alarm.create")&&this.on("action",function(e){e===this.ACTION_CREATE_ALARM&&this.createAlarm().fail(i)}),e(window).unload(function(){n._ws&&n._ws.close(C)}).on("beforeunload",function(){!e.browser.ie&&n._ws&&n._ws.close(C)}),t.each(["extended","alarmSound","soundInt","trackLength","windowAutoOpen","logFilter","deviceActivePage"],function(e){!function(e){n.on("change:"+e,function(t,i){n.setUserData(e,i)})}(e)}),this.on("newalarms",function(e){N.onNewAlarms.call(n,e)}).on("choosedevice",function(e){if(!e||n.get("device")&&n.get("device").id==e)return!1;var t=n.get("alarmDevices").get(e);t?n.set("device",t):App.trigger("needdevicehistory",n.items.get(data.id))}).on("change:extended",function(e,t){n.set({history:null}),t?N.makeView.call(n):(n._view.remove(),n._view=null,n.set({device:null,filter:"",filtered:null}))}).on("change:online",function(e,t){if(t)n.reloadData();else{var i=n.get("device");n.get("extended")||n._view&&App.allowed("alerts")&&(!i||i.get("hasAlarm"))&&(n._view.remove(),n._view=null,n.set("device",null))}}).on("change:alarmDevices",function(e,t){var i=n.previous("alarmDevices");i&&n.stopListening(i),t&&n.listenTo(t,"remove",function(e,t,i){i&&i.reload||N.onAlarmsOnDeviceResolved.call(n,e)}).listenTo(t,"add",function(e){1!=t.length||n.has("device")||n.set("device",e)})}).on("change:device",function(e,t,i){N.onDeviceChange.call(n,i)}).on("change:soundOnMute",function(){N.checkSoundOn.call(n)})},destroyChild:function(e){this.modules[e]&&(this.stopListening(this.modules[e]),this.modules[e].destroy(),delete this.modules[e])},makeSocket:function(e){if(e.url&&(!this._ws||this._ws.readyState!=S)){var n=this,i="ws";App.isHttpsServer()&&(i="wss"),this._wsOptions=e,this._ws=new WebSocket(i+"://"+e.url),this._wsTimeout=setTimeout(function(){n._ws.readyState==M&&N.onerror.call(n)},200),n._ws,N.initSocket.call(n).done(function(){t.each(["onmessage","onerror","onclose"],function(t){n._ws[t]=function(i){N[t]&&N[t].call(n,i),e[t]&&e[t].call(n,i)}}),N.clearOfflineTimeout.call(n)}).fail(function(){})}},getSockParams:function(){var e=this;return{url:App.getBaseUrl().replace(/http:\/\/|https:\/\//,"")+"socket/alerts?authorization="+encodeURIComponent(App.getBasic()),onmessage:function(t){N.onSocketReceive.call(e,t.data)}}},initSocket:function(){var t=new e.Deferred,n=this,i=this._ws;return i.onopen=function(){n._wsTimeout&&clearTimeout(n._wsTimeout),t.resolve()},t},setReopenTimeout:function(){var e=this;this._wsTimeout=setTimeout(function(){N.makeSocket.call(e,e._wsOptions)},A)},onclose:function(e){this._ws=null,this._sockActivity=!1,e.code===T?N.setReopenTimeout.call(this):e.code===k?App.trigger("logout"):e.code!==C&&e.code!==x&&N.onerror.call(this)},onerror:function(){this._wsTimeout&&clearTimeout(this._wsTimeout),App.trigger("serverlost")},getTotalAlarmsNumber:function(){var t=new e.Deferred;return App.allowed("alerts")?(N.loadDevicesWithAlarms.call(this).done(function(e,n){t.resolve({count:e.length,hasAlarmNotInProgress:n})}).fail(function(e){t.reject(e)}),t):t.resolve()},loadDevicesWithAlarms:function(){var t,n=this,i=new e.Deferred;return e.ajax({url:App.getBaseUrl()+"alerts/objects-in-alarm/",data:"{}"}).done(function(e){if(n._withAlarmsMap={},!Array.isArray(e))return i.resolve([]);for(var s=0,a=e.length;a>s;++s)t=e[s],t.guardArrived&&(t.guardCalled=!0),n._withAlarmsMap[t.id]=t;var o=e.some(function(e){return!e.isInProcess});i.resolve(e,o)}).fail(function(e){i.reject(e)}),i},getInitialData:function(n){var i=this,s=new e.Deferred,a=this.get("alarmDevices");return a?(N.onDeviceDataLoaded.call(i,n).done(function(){s.resolve()}).fail(function(){s.reject(arguments[0])}),s):App.allowed("alerts")?(i.set("alarmDevices",new l),i.getDevicesData(t.map(t.keys(i._withAlarmsMap),function(e){return parseInt(e)})).done(function(e){var a=i.get("alarmDevices"),o=t.indexBy(e,"id");t.each(i._withAlarmsMap,function(e,n){e!==!0&&a.add(t.extend(e,o[n]||{}),{parse:!0})}),N.onDeviceDataLoaded.call(i,n).done(function(){s.resolve()}).fail(function(){s.reject(arguments[0])})}).fail(function(){s.reject(arguments[0])}),s):(i.set("alarmDevices",new l),N.onDeviceDataLoaded.call(i,n).done(function(){s.resolve()}).fail(function(){s.reject(arguments[0])}),s)},onDeviceDataLoaded:function(t){var n,i=this,s=i.get("alarmDevices"),a=new e.Deferred;return s.trigger("sync"),!t&&this.has("device")?a.resolve():(t?n=s.get(t.id)?s.get(t.id):N.createDevice.call(i,t):s.length&&(i.get("extended")||1==s.length)&&(n=s.at(0)),n?(i.set("device",n,{silent:!0}),this.get("extended")?(N.stopUpdateObj.call(i),N.clearData.call(i),i.trigger("request:device",i,n),N.updateObj.call(i).done(function(){i.trigger("change:device",i,n,{updateStarted:!0}),N.loadDeviceExtraData.call(i),a.resolve()}).fail(function(){a.reject(arguments[0])})):N.fetchObjOnce.call(i).done(function(){i.trigger("change:device",i,n,{updateStarted:!1}),a.resolve()}).fail(function(){a.reject(arguments[0])})):a.resolve(),a)},fetchObjOnce:function(){var e=this.get("device");return e.fetch({data:{objectId:[e.id],tz:App.getUserTimezone(),callDevice:!1}})},createDevice:function(e){var t=o;return e.objType==App.TYPE_STAT&&(t=r),new t(e)},onSocketReceive:function(t){var n=e.parseJSON(t);n&&(this._sockActivity=!0,N.onReceiveNewData.call(this,n))},onReceiveNewData:function(e){var n=this,i=this.get("history"),s=N.filterAlerts.call(this,e),a={alerts:s,alarms:N.filterAlarms.call(this,s),logs:n.get("extended")?e:N.filterLogs.call(this,e)};e.length&&(t.each(a,function(e,t){if(i)if(null===i[t]);else{var s=n.get("device").id,a=e.filter(function(e){return e.objectId===s});a.length&&(i[t]=a.concat(i[t]))}"alarms"===t?App.allowed("alerts")&&N.onReceiveAlarms.call(n,e):(App.trigger("new"+t,e),N["onReceive"+t.ucFirst()].call(n,e))}),N.checkSoundOn.call(n))},checkSoundOn:function(){var e=this.get("soundOnMute");if(e)return this.set("soundOn",!1),void 0;var t=!1,n=this.get("alarmDevices");Array.isArray(n)&&(t=n.some(function(e){return!e.get("isInProcess")})),!t&&n&&Array.isArray(n.models)&&(t=n.models.some(function(e){return!e.get("isInProcess")})),this.set("soundOn",t)},filterAlarms:function(e){return t.filter(e,function(e){return!(!e.isAlarm||e.closedAt||"objStatus"in e&&!s.alarmsAllowed(e.objStatus))})},filterAlerts:function(e){return t.filter(e,function(e){return e.type==E||e.isAlarm})},filterLogs:function(e){var n=this;return t.filter(e,function(e){return n.isLogEntry(e)})},filterGuardCompleteActions:function(e){var n=this.ACTION_GUARD_COMPLETE,i=this.ACTION_GUARD_CANCEL,s=this.ACTION_GUARD_REJECT;return t.filter(e,function(e){return"actionType"in e&&(e.actionType==n||e.actionType==i||e.actionType==s)
})},filterResolveActions:function(e){return N.filterActionsByType(e,this.ACTION_RESOLVE_ALARM)},filterActionsByType:function(e,n,i){return t.filter(e,function(e){return i&&e.objectId!=i?void 0:"actionType"in e&&e.actionType==n})},onReceiveAlarms:function(e){for(var n,i=this,s=0,a=[],o=this.get("alarmDevices"),r=0,l=e.length;l>r;++r)if(n=e[r],s=n.objectId,s in i._withAlarmsMap);else{var c=App.getDevice(s);i._withAlarmsMap[s]=c?c.toJSON():!0,a.push(s)}a.length?(App.set("totalAlarms",t.keys(this._withAlarmsMap).length),o?this.getDevicesData(a).done(function(t){var n=t.length,s=i.get("device");if(s)for(;n--;)t[n].hasAlarm=!0,t[n].isInProcess=!1,s.id==t[n].id&&(s.set({hasAlarm:!0,isInProcess:!1}),t.splice(n,1,s));o.add(t),i.trigger("newalarms",e)}):i.trigger("newalarms",e)):i.trigger("newalarms",e)},onReceiveAlerts:function(e){var n=this.get("device");if(n){var i=t.filter(e,function(e){return e.objectId==n.id});i.length&&this.trigger("newalerts",i)}},onReceiveLogs:function(e){if(App.allowed("alerts")){var n=N.filterResolveActions.call(this,e);n.length&&N.onAlarmsResolved.call(this,n)}for(var i=this,s=this.get("device"),a={},o=[],r=0,l=!1,c=[],d=0,u=e.length;u>d;++d){var h=e[d];r=h.objectId,(i.isLogEntry(h)||i.isAlertEntry(h))&&(a[r]=a[r]||[],a[r].push(h)),s&&r==s.id&&o.push(h)}t.each(a,function(e,t){l=N.updateAlarmProcessingStatus.call(i,t,{lastLog:e[e.length-1]},e),l&&App.get("grGuardsAvailable")&&N.guardCallsProcessingRequired.call(i,t)&&(N.processGuardsActions.call(i,t,e)||c.push(parseInt(t)))}),c.length&&this.getAlarmProcessingStatus(c).done(function(e){t.each(e,function(e){N.updateAlarmProcessingStatus.call(i,e.id,t.extend({isInProcess:!1,guardCalled:!1,guardArrived:!1},t.pick(e,"isInProcess","guardCalled","guardArrived")))})}),o.length&&N.onReceiveLogsForCurrentObject.call(this,o)},guardCallsProcessingRequired:function(e){var t=null,n=this.get("alarmDevices");if(n){var i;(i=n.get(e))&&(t=i.attributes)}else e in this._withAlarmsMap&&(t=this._withAlarmsMap[e]);return t&&!t.guardArrived},processGuardsActions:function(e,n){var i,s,a=this,o=(this.get("alarmDevices"),!1),r=!1,l=!1,c=!1;if(i=t.filter(n,function(e){return"actionType"in e&&(e.actionType==a.ACTION_GUARD_COMPLETE||e.actionType==a.ACTION_GUARD_ARRIVE)}),i.length)o=!0,r=!0,c=!0;else if(i=t.filter(n,function(e){return"actionType"in e&&(e.actionType==a.ACTION_GUARD_ACCEPT||e.actionType==a.ACTION_GUARD_REJECT||e.actionType==a.ACTION_GUARD_CANCEL)}),i.length)switch(s=i[i.length-1],s.actionType){case a.ACTION_GUARD_REJECT:case a.ACTION_GUARD_CANCEL:l=!0;break;case a.ACTION_GUARD_ACCEPT:o=!0,r=!1,c=!0}return c&&N.updateAlarmProcessingStatus.call(this,e,{guardCalled:o,guardArrived:r}),!l},getDataWithIsInProcess:function(e,t,n){for(var i=this,s=Array.isArray(n)?n.sort(function(e,t){return e.receivedAt-t.receivedAt}).filter(function(e){return i.isAlertEntry(e)?e.isAlarm:!0}):[],a=e&&e.isInProcess&&"boolean"==typeof e.isInProcess?e.isInProcess:t,o=a,r=s.length;r>0;r--){var l=s[r-1];if(i.isAlertEntry(l)){o=!1;break}if(i.isCommentEntry(l)){o=!0;break}}var c=Object.assign(e,{isInProcess:o});return c},updateAlarmProcessingStatus:function(e,n,i){var s=this,a=this.get("alarmDevices");if(a){var o=a.get(e);if(o){var r=o.get("isInProcess");return o.set(N.getDataWithIsInProcess.call(s,n,r,i)),!0}}else if(e in this._withAlarmsMap){var l=this._withAlarmsMap[e],r=l&&l.isInProcess;return t.extend(this._withAlarmsMap[e],N.getDataWithIsInProcess.call(s,n,r,i)),!0}return!1},onReceiveLogsForCurrentObject:function(e){if(e.length){var t=this.get("device");if(this.trigger("newlogs",e),App.get("grGuardsAvailable")){var n=N.filterGuardCompleteActions.call(this,e),i=N.filterActionsByType(e,this.ACTION_GUARD_CALL,t.id),s=N.filterActionsByType(e,this.ACTION_GUARD_ARRIVE,t.id);s.length&&this.trigger("guards:change:called",{called:!0,arrived:!0}),(n.length||i.length)&&this.trigger("guards:calls",n,i)}}},onNewAlarms:function(e){if(e.length&&this.get("windowAutoOpen")){var t,n=this,i=0,s=this.get("visible");this._openCause=e[e.length-1],i=e[0].objectId,this.set("soundOnMute",!1),N.checkSoundOn.call(n),this.openWindow().done(function(){if(t=n.get("alarmDevices").get(i)){var e=n.get("device");e?t.id==e.id?n._openCause=null:s||n.trigger("choosedevice",i):n.trigger("choosedevice",i)}}).fail(function(){n.set("soundOn",!1),N.showErrors.apply(n,arguments)})}},onAlarmsResolved:function(e){for(var n,i=this.get("alarmDevices"),s=[],a=e.length,o=0;a--;)n=e[a],o=n.objectId,o in this._withAlarmsMap&&(s.push(o),i?i.remove(o):delete this._withAlarmsMap[o]);s.length&&App.set("totalAlarms",t.keys(this._withAlarmsMap).length)},onObjectAccessDenied:function(e){var n=this.getTexts(),i=this.get("alarmDevices");App.trigger("object:unauthorized",e),alert(n.accessToObjectLost,n.attention),e in this._withAlarmsMap&&(i?i.remove(e):delete this._withAlarmsMap[e],App.set("totalAlarms",t.keys(this._withAlarmsMap).length))},updateObj:function(){var t=this,n=this.get("device"),i=new e.Deferred;return!n||this._updateXhr||this._updateTimeout?i.reject():(this._updateXhr=n.fetch({data:{objectId:[n.id],tz:App.getUserTimezone(),callDevice:!1},statusCode:{401:function(){N.onObjectAccessDenied.call(t,n.id)}},success:function(){t._updateXhr=null,t._updateTimeout=setTimeout(function(){t._updateTimeout=null,t.autoUpdateNeeded()&&N.updateObj.call(t)},t.get("updatePeriod")),i.resolve()},error:function(){N.stopUpdateObj.call(t),i.reject(arguments[0])}}),i)},stopUpdateObj:function(){this._updateTimeout&&clearTimeout(this._updateTimeout),this._updateTimeout=null,this._updateXhr&&this._updateXhr.abort(),this._updateXhr=null},updateCSDCalls:function(){t.each(this._CSDCalls,function(){})},updateCSDCall:function(){},stopCSDCallsUpdate:function(){t.each(this._CSDCallsTimeouts,function(e){clearTimeout(e)})},onDeviceChange:function(e){var n=this,i=this.get("device"),s=e&&e.updateStarted,a=this.previous("device");t.each(this._xhr&&!s,function(e,t){e&&(e.abort(),n._xhr[t]=null)}),a&&!s&&N.stopUpdateObj.call(this),N.clearData.call(this),this.get("extended")?!i&&this.modules.maps&&(N.destroyChild.call(this,"guards"),N.destroyChild.call(this,"maps")):!this._view||i||App.get("totalAlarms")||(this._view.remove(),this._view=null),i&&!s&&this.get("extended")&&N.updateObj.call(this).done(function(){N.loadDeviceExtraData.call(n)})},loadDeviceExtraData:function(){this.getDeviceGuards(),this.getDeviceGroups(),this.loadDeviceTechnician(),this.loadDeviceExtraSettings()},onAlarmsOnDeviceResolved:function(e){var n=e.id,i=this.get("alarmDevices"),s=this.get("extended"),a=this.get("filtered"),o=this.get("device"),r=o&&o.id===n,l=o&&o.get("hasAlarm");return n in this._withAlarmsMap&&delete this._withAlarmsMap[n],App.set("totalAlarms",t.keys(this._withAlarmsMap).length),s&&a&&a.get(n)?(r&&l&&o.set("hasAlarm",!1),void 0):(i.length?r&&l&&o.set("hasAlarm",!1):this._view&&!s&&(this._view.remove(),this._view=null),void 0)},clearData:function(){this.set({history:null})},setOfflineTimeout:function(){var e=this;N.clearOfflineTimeout.call(this),this._offlineTimeout=setTimeout(function(){e.set("online",!1)},500)},clearOfflineTimeout:function(){this._offlineTimeout&&clearTimeout(this._offlineTimeout),this._offlineTimeout=null},showErrors:function(e){e&&this.getView().showErrors(e)}};return L}),define("_common/alerts/nls/directory",{root:{alertsLog:"Event list",alarmsWindow:"Alarm window",alertRelaying:"Relay",alertFgColor:"Text color",alertBgColor:"Background color",alertEdit:"Event options",alertAdd:"Add event",alertCreate:"New event",alertDelete:"Delete event",alertRestore:"Restore default",alertsRestoreAll:"Set default event options",alertChooseGroup:"Select a group",alertApplyColorsToGroup:"Apply selected colors to all group events",confirmDeleteAlert:{msg:"Delete event?",hdr:"Delete?"},confirmRestoreAlert:{msg:"Restore default event options?",hdr:"Restore?"},confirmRestoreAllAlerts:{msg:"Restore default options for all events?",hdr:"Restore?"},errAlertCode:"Length of an event code should be from #min# to #max# digits",errAlertMessage:"Enter event name",errAlertChooseGroup:"Select a group for the event",errAlertExists:"Message with this code already exists in the system"},"ru-ru":!0,"it-it":!0}),define("_common/alerts/nls/ru-ru/directory",{alertsLog:" ",alarmsWindow:" ",alertRelaying:"",alertFgColor:" ",alertBgColor:" ",alertEdit:" ",alertAdd:" ",alertCreate:" ",alertDelete:" ",alertRestore:"  ",alertsRestoreAll:"    ",alertChooseGroup:" ",alertApplyColorsToGroup:"      ",confirmDeleteAlert:{msg:" ?",hdr:"?"},confirmRestoreAlert:{msg:"    ?",hdr:"?"},confirmRestoreAllAlerts:{msg:"     ?",hdr:"?"},errAlertCode:"      #min#  #max# ",errAlertMessage:"  ",errAlertChooseGroup:"   ",errAlertExists:"       "}),define("text!_common/alerts/tmpl/settingsMessages.html",[],function(){return'<h3><%= i18n.alertsDirectory %></h3>\n\n<!--<div class="grid-container selectable">-->\n<div class="grid selectable">\n    <table class="display" width="100%">\n        <thead>\n            <tr>\n                <th class="text-left"><%= i18n.alertCode %></th>\n                <th class="text-left"><%= i18n.alertMessage %></th>\n                <th class="text-left"><%= i18n.alertsGroup %></th>\n                <th><%= i18n.alertsLog %></th>\n                <th><%= i18n.alarmsWindow %></th>\n                <!--<th><%= i18n.alertRelaying %></th>-->\n                <th>&nbsp;</th>\n            </tr>\n        </thead>\n    </table>\n    <!--<div class="grid-header">\n        <table>\n            <thead>\n            <tr>\n                <th class="col-code"><%= i18n.alarmCode %></th>\n                <th>Text and presentation</th>\n                <th>Group</th>\n                <th class="col-checkbox">Is Alarm</th>\n                <th class="col-checkbox">Is Alarm</th>\n                <th class="col-checkbox">Is Alarm</th>\n                <th class="col-icon">&nbsp;</th>\n            </tr>\n            </thead>\n        </table>\n    </div>\n    <div class="grid-viewport">\n        <div class="grid-content">\n            <table>\n                <tbody></tbody>\n            </table>\n        </div>\n    </div>-->\n</div>\n\n<div class="footer">\n    <a href="javascript:;" class="add-row-link"><%= i18n.alertAdd %></a>\n    <a href="javascript:;" class="restore-defaults-link"><%= i18n.alertsRestoreAll %></a>\n</div>\n\n<ul class="nav nav-list context-menu" style="display:none">\n    <li><a href="#" data-action="rowedit"><%= i18n.alertEdit %></a></li>\n    <li><a href="#" data-action="rowdelete"><%= i18n.alertDelete %></a></li>\n</ul>\n\n\n'}),define("text!_common/alerts/tmpl/messageForm.html",[],function(){return'<div class="form-horizontal">\n    <div class="control-group">\n        <label class="control-label"><%= i18n.alertCode %></label>\n        <div class="controls">\n            <input<%if(code){%> readonly<% } %> name="code" type="text" value="<%= codeS || \'\' %>" class="integer"\n                maxlength="<%= maxCodeLength %>">\n        </div>\n    </div>\n\n    <div class="control-group">\n        <label class="control-label"><%= i18n.alertMessage %></label>\n        <div class="controls">\n            <input name="message" type="text" value="<%- message || \'\' %>"\n                   style="color: <%= fgColor %>;background-color: <%= bgColor %>">\n        </div>\n    </div>\n\n    <div class="control-group">\n        <label class="control-label"><%= i18n.alertsGroup %></label>\n        <div class="controls">\n            <select name="groupId">\n                <%if (!code){%>\n                <option value="0"><%= i18n.alertChooseGroup %></option>\n                <% } %>\n                <% _.each(groups, function(group, id){%>\n                <option value="<%= id %>"<%if (\'undefined\' != typeof groupId && groupId == id){%> selected<% } %>><%= group.name %></option>\n                <% }) %>\n            </select>\n        </div>\n    </div>\n\n    <div class="control-group">\n        <label for="is-visible-check" class="control-label"><%= i18n.alertsLog %></label>\n        <div class="controls">\n            <input name="isVisible" id="is-visible-check" type="checkbox"\n                   value="1"<% if(isVisible) {%> checked<% } %><% if(isAlarm) {%> readonly<% } %>>\n        </div>\n    </div>\n\n    <div class="control-group">\n        <label for="is-alarm-check" class="control-label"><%= i18n.alarmsWindow %></label>\n        <div class="controls">\n            <input name="isAlarm" id="is-alarm-check" type="checkbox" value="1"<% if(isAlarm) {%> checked<% } %>>\n        </div>\n    </div>\n\n    <!--<div class="control-group">\n        <label for="is-relayed-check" class="control-label"><%= i18n.alertRelaying %></label>\n        <div class="controls">\n            <input name="isRelayed" id="is-relayed-check" type="checkbox" value="1"<% if(isRelayed) {%> checked<% } %>>\n        </div>\n    </div>-->\n    <% if(isRelayed) {%>\n    <input name="isRelayed" type="hidden" value="1">\n    <% } %>\n\n    <div class="control-group has-picker fgcolor">\n        <label class="control-label"><%= i18n.alertFgColor %></label>\n        <div class="controls">\n            <div class="example" style="color: <%= fgColor %>">A</div>\n            <input name="fgColor" type="text" value="<%= fgColor %>" maxlength="7">\n        </div>\n    </div>\n\n    <div class="control-group has-picker bgcolor no-margin">\n        <label class="control-label"><%= i18n.alertBgColor %></label>\n        <div class="controls">\n            <div class="example" style="background-color: <%= bgColor %>"></div>\n            <input name="bgColor" type="text" value="<%= bgColor %>" maxlength="7">\n        </div>\n    </div>\n\n    <div class="control-group" style="margin:10px 0 0">\n        <label for="apply-colors-check" class="control-label no-margin no-padding"><%= i18n.alertApplyColorsToGroup %></label>\n        <div class="controls">\n            <input name="applyColors" id="apply-colors-check" type="checkbox" value="1">\n        </div>\n    </div>\n</div>'}),define("_common/alerts/views/AlarmsDirectoryView",["jquery","underscore","jface","system/views/SettingsGridView","datatables","_libs/farbtastic/farbtastic","i18n!../nls/directory","text!../tmpl/settingsMessages.html","text!../tmpl/messageForm.html","css!_libs/farbtastic/farbtastic.css","css!_libs/grids/DataTables/css/jquery.dataTables.cropped.css"],function(e,t,n,i,s,a,o,r,l){function c(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}r=t.template(r),l=t.template(l);var d=4,u=8,h=i.prototype,m=i.extend({constructor:function(){this._data={groups:null,alerts:null},this._ns=".alertsgrid",this._hasContext=!0,this._picker=null,this._curCode=null,i.apply(this,arguments)},initialize:function(e){this._i18n=this._i18n||t.extend(e.i18n,o),h.initialize.apply(this,arguments)},formatCode:function(e){var t=String(e);return 4==t.length&&(t=t.substr(0,3)+"."+t.substr(3)),t},_renderLayout:function(){var t=e("#settings").find("#alerts-directory");t.html(r({i18n:this._i18n})),this.setElement(t)},_loadData:function(){var t=this,n=new e.Deferred;return this._data.alerts&&this._data.groups?n.resolve(this._data):(e.when(e.ajax({url:App.getBaseUrl()+"alert-template-group/list/",data:"{}"}),e.ajax({url:App.getBaseUrl()+"alert-template/list/",data:"{}"})).done(function(e,i){for(var s=e[0],a=i[0],o={},r=a.length;r--;)o[a[r].code]=a[r];for(t._data.alerts=a,o={},r=s.length;r--;)o[s[r].id]=s[r];t._data.groups=o,n.resolve(t._data)}),n)},_loadAlert:function(t){return e.ajax({url:App.getBaseUrl()+"alert-template/get/",data:{code:t}})},_getGridOptions:function(){var n=this,i=h._getGridOptions.call(this),s=this._data,a=s.groups,o=[{data:function(e){return n.formatCode(e.code)},width:"8%"},{data:"message","class":"message",width:"48%"},{data:function(e){return a[e.groupId].name},width:"15%"},{data:function(e){return n._formatRowCheck(e.isVisible)},"class":"text-center",width:"8%",searchable:!1},{data:function(e){return n._formatRowCheck(e.isAlarm)},"class":"text-center",width:"8%",searchable:!1},{data:function(e){return n._formatRowEdit(e.code)},"class":"text-center",width:"5%",searchable:!1,orderable:!1}];return t.extend(i,{data:s.alerts,columns:o,rowCallback:function(t,n){t&&(t.children[1].style.backgroundColor=n.bgColor||"#fff",t.children[1].style.color=n.fgColor||"#000",e(t).attr("data-code",n.code).data("isdefault",n.isBaseCode))}})},_formatRowEdit:function(e){return'<i data-code="'+e+'" class="icon-edit svg-icon svg-icon-cog"></i>'},_initEditor:function(){var t=this;h._initEditor.call(this),this.$el.on("click",".restore-defaults-link",function(){return n.confirm(t._i18n.confirmRestoreAllAlerts.msg,t._i18n.confirmRestoreAllAlerts.hdr,{okCallback:function(){t.$el.addClass("loading"),e.ajax({url:App.getBaseUrl()+"alert-template/delete-all/",data:"{}"}).always(function(e){t.$el.removeClass("loading"),e.status>=200&&e.status<300?(t._data={groups:null,alerts:null},t._destroyGrid(),t.render()):t.showErrors(e)})}})}),this.$el.on("dblclick","tr[data-code]",function(){t.trigger("rowedit",e(this).data("code"),e(this).data("isdefault"))})},_initContextMenu:function(){var t=this,i=this.$el.find(".context-menu");e.fn.contextmenu&&i.length&&(i.appendTo("body"),this.$el.contextmenu({selector:"tr[data-code]",menu:i,position:{my:"left top"},before:function(n,s){var a=e(n.currentTarget).closest("[data-code]"),o=a.data("isdefault"),r=a.data("code");if(!r)return!1;var l=i.find("[data-action=rowdelete]")[0];l.innerHTML=o?t._i18n.alertRestore:t._i18n.alertDelete,s.active.data("code",r),s.active.data("isdefault",o)}}),i.on("click","[data-action]",function(){var s,a=e(this).data("action"),o=i.data("isdefault");if(s=i.data("code"))if("rowedit"==a)t.trigger("rowedit",s);else if("rowdelete"==a){var r=o?t._i18n.confirmRestoreAlert.msg:t._i18n.confirmDeleteAlert.msg,l=o?t._i18n.confirmRestoreAlert.hdr:t._i18n.confirmDeleteAlert.hdr;n.confirm(r,l,{okCallback:function(){t.trigger("rowdelete",s,o)}})}}))},_startEdit:function(e){if(!(e&&this._curCode==e||this.loading)){var t=this;this._curCode=e,e?(showCursor(),this.loading=!0,this._loadAlert(e).done(function(e){p.openPopup.call(t,e)}).always(function(){hideCursor(),t.loading=!1})):p.openPopup.call(this,{code:"",message:"",isVisible:!0,isAlarm:!1,isRelayed:!1,fgColor:"#000000",bgColor:"#FFFFFF"})}},_validate:function(e){var t=[];return(!e.code||(""+e.code).length<d||(""+e.code).length>u)&&t.push({key:"code",msg:this._i18n.errAlertCode.replace("#min#",d).replace("#max#",u)}),e.message&&e.message.length||t.push({key:"message",msg:this._i18n.errAlertMessage}),e.groupId||t.push({key:"groupId",msg:this._i18n.errAlertChooseGroup}),t.length?t:null},_save:function(n,i){var s=this;return this._popup.addClass("loading"),this.loading=!0,t.each(["isVisible","isAlarm","isRelayed","applyColors"],function(e){n[e]=n[e]?!0:!1}),t.each(["fgColor","bgColor"],function(e,t){var i=n[e]||"";i&&c(i)||(i=0==t?"#000000":"#FFFFFF"),"#"!=i.substr(0,1)&&(i="#"+i),n[e]=i}),e.ajax({url:App.getBaseUrl()+"alert-template/save/",data:n}).done(function(e){i?(s._data.alerts.push(e),s._addRow(e)):s._updateRow(e),n.applyColors&&s._updateGroupColors(e.groupId,e.fgColor,e.bgColor),s._popup.trigger("jw.close")}).fail(function(e){s.showErrors(e)}).always(function(){s._popup.removeClass("loading"),s.loading=!1})},_getRow:function(e){return this._grid.DataTable().row(this.$el.find("tr[data-code="+e+"]"))},_updateRow:function(e){for(var t=e.code,n=this._data.alerts,i=n.length,s=this._grid;i--;)if(n[i].code==t){n[i]=e;break}var a=s.find("tr[data-code="+t+"]"),o=a.children();s.DataTable().row(a).invalidate().data(e),o[0].innerHTML=this.formatCode(t),o[1].innerHTML=e.message,o[1].style.color=e.fgColor,o[1].style.backgroundColor=e.bgColor,o[2].innerHTML=this._data.groups[e.groupId].name,o[3].innerHTML=this._formatRowCheck(e.isVisible),o[4].innerHTML=this._formatRowCheck(e.isAlarm),o[5].innerHTML=this._formatRowEdit(t)},_updateGroupColors:function(e,t,n){for(var i=this._data.alerts,s=i.length,a=this._grid,o=a.DataTable(),r=null,l=null,c=null;s--;)i[s].groupId==e&&(r=i[s],r.fgColor=t,r.bgColor=n,l=a.find("tr[data-code="+r.code+"]"),l.length&&(c=l.children()[1],o.row(l).invalidate().data(r),c.style.color=t,c.style.backgroundColor=n))},_delete:function(t,n){var i=new e.Deferred;return e.ajax({url:App.getBaseUrl()+"alert-template/delete/",data:{code:t},complete:function(e){e.status>=200&&e.status<300?i.resolve(t,n):i.reject(e)}}),i},_onDeleteSuccess:function(e,t){if(t){var n=this;showCursor(),this.loading=!0,this._loadAlert(e).done(function(e){n._updateRow(e)}).always(function(){hideCursor(),n.loading=!1})}else h._onDeleteSuccess.apply(this,arguments)},_deleteFromData:function(e){for(var t=this._data.alerts,n=t.length;n--;)if(t[n].code==e){t.splice(n,1);break}}}),p={openPopup:function(t){var i=this;return n.dialog.close(),n.showOverlay(),this._popup?(this._popup.content.html(p.getFormHtml.call(this,t)),this._popup.header.html(t.code?this._i18n.alertEdit:this._i18n.alertCreate),this._popup.find(".integer").numeric({decimal:!1,negative:!1}),this._popup.trigger("jw.activate"),void 0):(n.window.open({addClass:"settings-edit-popup",headerHtml:t.code?this._i18n.alertEdit:this._i18n.alertCreate,contentHtml:p.getFormHtml.call(this,t),addForm:'<form method="post" action=""></form>',footerHtml:'<button type="submit" class="btn btn-primary">'+this._i18n.save+"</button>"+'<a href="javascript:;" class="btn jw-close">'+this._i18n.cancel.ucFirst()+"</a>",width:430,centered:!0,dieAfter:300,openCallback:function(){var t=this,n=this.find("form");i._popup=this,n.on("submit",function(){n.find(".error").removeClass("error");var e,t=n.serializeObject();if(t.code=parseInt(String(t.code).replace(".","")),e=i._validate(t))i.showErrors(e);else{var s=!i._curCode;s||t.code!=i._curCode?(showCursor(),i._loadAlert(t.code).done(function(e){e&&e.code?i.showErrors([{key:"code",msg:i._i18n.errAlertExists}]):i._save(t,s)}).error(function(){i._save(t,s)}).always(hideCursor)):i._save(t,!1)}return!1}),t.on("click",".has-picker label, .has-picker input, .has-picker .example",function(n){n.stopPropagation();var s=e(this).closest(".control-group"),a=s.find("input"),o=a.val(),r=s.find(".example")[0],l=t.find("input[name=message]")[0],c=-1!=s[0].className.indexOf("fgcolor")?"color":"backgroundColor";e("#picker").remove(),s.append('<div id="picker" class="colorpicker"></div>'),i._picker=e("#picker").farbtastic(function(e){r.style[c]=e,l.style[c]=e,a.val()!=e&&a.val(e)}).on("click",function(e){e.stopPropagation()}).data("farbtastic").setColor(o),e(document).one("click",function(){e("#picker").remove()})}).on("keyup",".has-picker input",function(){i._picker.setColor(this.value)}).on("click","input[name=isAlarm], input[name=isVisible]",function(){p.setDependantInputsState.call(i)})},closeCallback:function(){i._curCode=null,n.hideOverlay()},dieCallback:function(){i._popup=null}}),void 0)},getFormHtml:function(e){return l(t.extend(e,{codeS:this.formatCode(e.code),groups:this._data.groups,minCodeLength:d,maxCodeLength:u,i18n:this._i18n}))},setDependantInputsState:function(){var e=this._popup.find("input[name=isAlarm]"),t=this._popup.find("input[name=isVisible]");e.prop("checked")?t.prop("checked",!0).prop("readonly",!0):t.prop("readonly",!1)}};return m}),define("_common/geozones/Geozone",["underscore","abstracts/Model"],function(e,t){var n=t.extend({constructor:function(){t.apply(this,arguments)},url:App.getBaseUrl()+"zones/",parse:function(t){var n=e.isArray(t)?t[0]:t;return n.points&&(n.bounds=this.calculateBounds(n.points)),n},calculateBounds:function(){return null}});return n}),define("_common/geozones/GeozoneRadial",["underscore","./Geozone","geo"],function(e,t,n){var i=t.extend({defaults:{points:null,bounds:null,center:null,radius:0,square:0,type:1,groupId:0},constructor:function(){t.apply(this,arguments)},parse:function(e){return e=t.prototype.parse.call(this,e),e.points&&2==e.points.length?(e.center=[e.points[0].lat,e.points[0].lon],e.radius=this.calculateRadius(e.points)):(e.radius=0,e.center=null),e},calculateBounds:function(e){var e=e||this.get("points"),t=[[null,null],[null,null]];if(2!=e.length)return t;var n=this.calculateRadius(e),i=360*(n/40075017),s=i/Math.cos(Math.D2R*e[0].lat);return[[e[0].lat-i,e[0].lon-s],[e[0].lat+i,e[0].lon+s]]},calculateRadius:function(e){var e=e||this.get("points");return n.getDistanceBetweenPoints(e[0].lat,e[0].lon,e[1].lat,e[1].lon)}});return i}),define("_common/geozones/GeozonePoly",["underscore","./Geozone"],function(e,t){var n=89,i=0,s=180,a=-180,o=t.extend({defaults:{points:null,bounds:null,center:null,square:0,type:0,groupId:0},constructor:function(){t.apply(this,arguments)},calculateBounds:function(e){for(var t,o,e=e||this.get("points"),r=[[null,null],[null,null]],l=e.length;l--;)t=e[l].lat,o=e[l].lon||e[l].lng,t>i&&n>t&&((t>r[1][0]||null===r[1][0])&&(r[1][0]=t),(t<r[0][0]||null===r[0][0])&&(r[0][0]=t)),o>a&&s>o&&((o>r[1][1]||null===r[1][1])&&(r[1][1]=o),(o<r[0][1]||null===r[0][1])&&(r[0][1]=o));return r}});return o}),define("_common/geozones/GeozonesCollection",["underscore","abstracts/Collection","./GeozoneRadial","./GeozonePoly"],function(e,t,n,i){var s=1,a=t.extend({constructor:function(){t.apply(this,arguments)},url:App.getBaseUrl()+"zones/",model:function(e,t){return e.type==s?new n(e,t):new i(e,t)},parse:function(e){return e.items||e.group&&e.group.items||e}});return a}),define("text!_common/alerts/devicesGeozones/tmpl/list.html",[],function(){return'<h4><i class="icon-reload svg-icon svg-icon-reload" title="<%= i18n.reload.ucFirst() %>"></i> <%= title %></h4>\n<div class="list-mode">\n    <div class="switch-toggle" onclick="">\n        <input id="<%= key %>-radio-mode-all" name="<%= key %>-mode" type="radio" value="all"<%= mode == \'all\' ? \' checked\' : \'\' %>>\n        <label for="<%= key %>-radio-mode-all" onclick="">\n            <%= i18n.all.ucFirst() %>\n        </label>\n\n        <input id="<%= key %>-radio-mode-filter" name="<%= key %>-mode" type="radio" value="filter"<%= mode == \'filter\' ? \' checked\' : \'\' %>>\n        <label for="<%= key %>-radio-mode-filter" onclick="">\n            <%= i18n.filteredOnly %>\n        </label>\n        <a class="btn btn-primary"></a>\n    </div>\n</div>\n<form class="form-search">\n    <div class="input-append input-prepend">\n        <span class="add-on">\n            <input name="q" type="text" placeholder="<%= searchPlaceholder %>" value="" autocomplete="off">\n            <i class="icon-clear svg-icon svg-icon-circle-remove"></i>\n        </span>\n        <button class="btn add-on btn-search"><i class="svg-icon svg-icon-search"></i></button>\n    </div>\n</form>\n<form class="list-content">\n    <ul class="hidden"></ul>\n    <p class="no-data"><%= noData %></p>\n</form>'}),define("_common/alerts/devicesGeozones/views/ListView",["jquery","underscore","abstracts/View","text!../tmpl/list.html","jquerytiny"],function(e,t,n,i){i=t.template(i);var s=n.extend({constructor:function(){this.controller=null,this.key="",this._searchForm=null,this._ul=null,this._noData=null,this._mode="all",this._count=0,this._loadLimit=50,this._filtered=null,this._lastSelected=!1,n.apply(this,arguments)},className:"list-cont",initialize:function(e){this.controller=e.controller,this.key=e.key,this._mode=this.controller.getUserData(this.key+".mode")||"all",this.$el.addClass(this.key+" mode-"+this._mode),this._bindEvents(),this.render()},render:function(){this.$el.html(i({title:this._getTitle(),mode:this._mode,key:this.key,searchPlaceholder:this._getSearchPlaceholder(),noData:this._getNoData(),i18n:this.controller.getTexts()})).appendTo(this.controller.get("container")),this._searchForm=this.$el.find(".form-search"),this._ul=this.$el.find("ul"),this._noData=this.$el.find(".no-data"),this._initScrolling(),this._initSearch()},_bindEvents:function(){var t=this,n=this.controller;this.listenTo(this.collection,"request",function(){t.$el.addClass("loading")}).listenTo(this.collection,"sync",function(){t._onCollectionSync()}).listenTo(this.collection,"sync error",function(){t.$el.removeClass("loading")}),this.listenTo(n,"change:activeView",function(e,n){t._onChangeActiveView(n)}).listenTo(n,"change:mapped",function(){t._isDependantView()&&("filter"==t._mode?(t._clear(),t._filter()):t._highlight())}),this.$el.on("click",".icon-reload",function(){t._clearSearch(),n.reload(t.key)}).on("click",".brief",function(e){t._onItemClick.call(t,this,e)}).on("click",".check",function(e){e.stopPropagation()}).on("click","input[type=checkbox]",function(i){i.stopPropagation(),t.$el.addClass("loading");var s=this.checked,a=e(this).closest(".brief"),o=!t._isDependantView(),r=parseInt(this.value);n[s?"map":"unmap"](t.key,r,o).done(function(){s?o||"all"!=t._mode||a.addClass("mapped"):o?(t.$el.addClass("loading"),n.trigger("deselect",r),a.removeClass("selected").find("input").prop("checked",!1),n.loadMap(t.key).always(function(){t.$el.removeClass("loading")})):"filter"==t._mode?a.remove():a.removeClass("mapped")}).fail(function(){t._showErrors(arguments[0])}).always(function(){t.$el.removeClass("loading")})}).on("click",".switch-toggle input",function(){this.checked&&(t._mode=this.value,n.setUserData(t.key+".mode",t._mode),t._clear(),t._filter())})},_initScrolling:function(){var e=this,t=e._ul;this.$el.find(".list-content").infinite({appendTo:t,source:function(){return e._filter()}})},_initSearch:function(){var n=this,i=this._searchForm.find("input");this._searchForm.on("submit",function(){var s=e.trim(i.val()).toLowerCase();return s.length?(n.$el.addClass("loading"),n.controller.search(n.key,s).done(function(e){n._searchForm.addClass("active"),n._filtered=t.pluck(e,"id"),n._clear(),n._filter()}).fail(function(){n._showErrors(arguments[0])}).always(function(){n.$el.removeClass("loading")}),!1):!1}),this._searchForm.find(".icon-clear").on("click",function(){n._clearSearch(),n._clear(),n._filter()})},_onItemClick:function(n,i){var s=this,a=this.controller,o=e(n),r=o.data("id"),l=i&&"ctrlKey"in i?i.ctrlKey:!1,c=i&&"shiftKey"in i?i.shiftKey:!1,d=a.get("selected"),u=r in d;if(!u||l||1!=t.keys(d).length){if(this.$el.addClass("loading"),u)l?(a.trigger("deselect",r),o.removeClass("selected").find("input").prop("checked",!1)):c||(this.$el.find(".selected").not(n).removeClass("selected").find("input").prop("checked",!1),a.trigger("select",r,!1,this));else{var d=this.$el.find(".selected");if(l||c){if(c){var n,h=this.$el.find("li[data-id]"),m=d.first(),p=h.index(m),f=d.last(),g=h.index(f),v=h.index(o),_=p,b=v;p>v&&g>v&&(_=v,b=g),r=[];for(var w=_;b>=w;++w)n=e(h[w]),r.push(n.addClass("selected").data("id")),n.find("input").prop("checked",!0)}}else d.removeClass("selected").find("input").prop("checked",!1);a.trigger("select",r,l||c,this),c||o.addClass("selected").find("input").prop("checked",!0)}a.loadMap(s.key).always(function(){s.$el.removeClass("loading")})}},_isActiveView:function(){return this.controller.has("activeView")&&this.controller.get("activeView")==this},_isDependantView:function(){return this.controller.has("activeView")&&this.controller.get("activeView")!=this},_filter:function(){var t,n=new e.Deferred,i=[],s=null,a=0;if(this._isDependantView()&&"filter"==this._mode&&(t=this.controller.get("mapped")),this._filtered)for(var o=0,r=this._filtered.length;r>o;++o)s=null,a=this._filtered[o],t?a in t&&(s=this.collection.get(a))&&i.push(s):(s=this.collection.get(a))&&i.push(s);else if(t)for(var l in t)s=null,(s=this.collection.get(l))&&i.push(s);else(!this.controller.has("activeView")||this._isActiveView()||"all"==this._mode)&&(i=this.collection.models);
return i=i.slice(this._count,this._count+this._loadLimit),this._count+=i.length,this._renderItems(i),n.resolve(i.length>0),n},_renderItems:function(e){for(var t="",n=this.controller,i=this._isActiveView()&&n.get("selected"),s=this._isDependantView()&&n.get("mapped"),a=0,o=e.length;o>a;++a)t+=this._renderItem(e[a],i&&e[a].id in i,s&&e[a].id in s);this._ul.append(t)},_renderItem:function(){return"Not applied"},_getTitle:function(){return"TODO make titles"},_getSearchPlaceholder:function(){return""},_getNoData:function(){return"No items to display"},_highlight:function(){this._clearSelection();var e=this.controller.get("mapped");for(var t in e)this._ul.find("li[data-id="+t+"]").addClass("mapped").find("input").prop("checked",!0)},_onCollectionSync:function(){this._clear(),this.collection.length?(this._ul.removeClass("hidden"),this._noData.addClass("hidden"),this._filter()):(this._noData.removeClass("hidden"),this._ul.addClass("hidden"))},_onChangeActiveView:function(e){var t=this.controller.previous("activeView");t&&(t==this?(this.$el.removeClass("list-active"),this.$el.find(".selected").removeClass("selected").find("input").prop("checked",!1)):(this.$el.removeClass("list-dependant"),this._clearSelection())),e&&(e==this?this.$el.addClass("list-active"):this.$el.addClass("list-dependant")),this._filter()},_clearSelection:function(){this._ul.find(".mapped").removeClass("mapped"),this._ul.find("input[type=checkbox]").prop("checked",!1)},_clearSearch:function(){this._searchForm.removeClass("active").find("input").val(""),this._filtered=null},_clear:function(){this._ul.empty(),this._count=0},_showErrors:function(){var t=this.controller.getTexts(),n=[];if("string"==typeof arguments[0])n.push(arguments[0]);else if(arguments[0].responseText)try{var i=e.parseJSON(arguments[0].responseText);n.push(i.msg)}catch(s){n.push(t.errors.callServerFailed)}n.length&&alert(n.join("<br />"),t.error)}});return s}),define("text!_common/alerts/devicesGeozones/tmpl/item.html",[],function(){return'<li data-id="<%= id %>" class="brief<%= selected ? \' selected\' : (mapped ? \' mapped\' : \'\') %>">\n    <label class="check">\n        <input type="checkbox" value="<%= id %>"<%= mapped ? \' checked\' : \'\' %>>\n    </label>\n\n    <%- title %>\n    <!--<h5></h5>\n    <div class="checkbox">\n        <input type="checkbox">\n    </div>-->\n</li>'}),define("_common/alerts/devicesGeozones/views/DevicesListView",["jquery","underscore","./ListView","text!../tmpl/item.html"],function(e,t,n,i){i=t.template(i);var s=n.extend({constructor:function(){n.apply(this,arguments)},_getTitle:function(){return this.controller.getTexts().vehicles},_getSearchPlaceholder:function(){return this.controller.getTexts().searchObjects},_renderItem:function(e,t,n){return i({id:e.id,title:App.buildObjTitle(e)+" (#"+e.get("extId")+")",selected:t,mapped:n})}});return s}),define("_common/alerts/devicesGeozones/views/GeozonesListView",["jquery","underscore","./ListView","text!../tmpl/item.html"],function(e,t,n,i){i=t.template(i);var s=n.extend({constructor:function(){n.apply(this,arguments)},_renderItem:function(e,t,n){return i({id:e.id,title:e.get("name"),selected:t,mapped:n})},_getTitle:function(){return this.controller.getTexts().geozones.ucFirst()},_getSearchPlaceholder:function(){return this.controller.getTexts().searchZones}});return s}),define("_common/alerts/devicesGeozones/DevicesGeozonesController",["jquery","underscore","abstracts/Module","_common/mobile/MobileObjectsCollection","_common/geozones/GeozonesCollection","./views/DevicesListView","./views/GeozonesListView","i18n!_common/nls/common"],function(e,t,n,i,s,a,o,r){var l=r,c=n.extend({constructor:function(){this.devices=new i,this.devices.comparator="name",this.geozones=new s,this.views={devices:null,geozones:null},this._destroyTmt=null,n.apply(this,arguments)},defaults:{container:null,selected:{},mapped:{},activeView:null},initialize:function(){this._destroyTmt&&clearTimeout(this._destroyTmt),d.bindEvents.call(this),this.views.devices=new a({controller:this,key:"devices",collection:this.devices}),this.views.geozones=new o({controller:this,key:"geozones",collection:this.geozones}),d.loadDevices.call(this),d.loadGeozones.call(this)},search:function(e,t){var n="search"+e.ucFirst();return d[n].call(this,t)},loadMap:function(n){var i=this,s=new e.Deferred,a=t.keys(this.get("selected")),o="devices"==n?"objects/get-zone-controls/":"zones/get-object-controls/",r={};return a=t.map(a,function(e){return Number(e)}),"devices"==n?r.objectIds=a:r.zoneIds=a,e.ajax({url:App.getBaseUrl()+o,data:r,success:function(e){i.set("mapped",t.object(t.pluck(e,"id"),1)),s.resolve(e)},fail:function(){s.reject(arguments[0])}}),s},map:function(e,t,n){return d.saveMap.call(this,e,t,!0,n)},unmap:function(e,t,n){return d.saveMap.call(this,e,t,!1,n)},reload:function(t){var n=this,i=new e.Deferred;return d["load"+t.ucFirst()].call(this,!0).done(function(e){var s=n.get("activeView");if(s&&s==n.views[t]){var a=n.get("selected"),o=!1;for(var r in n.get("selected"))e.get(r)||(delete a[r],o=!0);o&&n.trigger("change:selected",n,a)}s&&n.loadMap(s.key).done(function(e){i.resolve(e)}).fail(function(){i.reject(arguments[0])})}).fail(function(){i.reject(arguments[0])}),i},getTexts:function(){return l},destroy:function(){this._destroyTmt&&clearTimeout(this._destroyTmt),t.each(this.views,function(e){e&&e.remove()}),this.views={devices:null,geozones:null},this.devices.reset(),this.geozones.reset();var e=t.clone(this.defaults);delete e.container,this.set(e)}}),d={bindEvents:function(){var e=this;this.off(),this.stopListening(),this.listenTo(App,"settingsclose",function(){e._destroyTmt&&clearTimeout(e._destroyTmt),e._destroyTmt=setTimeout(function(){e.destroy()},6e4)}).listenTo(App,"settingsopen",function(){var t=e.get("container").parent();this.views.devices?t.hasClass("hidden")||e._destroyTmt&&clearTimeout(e._destroyTmt):t.hasClass("hidden")?t.one("showsection",function(){e.initialize()}):e.initialize()}),this.on("select",function(n,i,s){s!=e.get("activeView")&&(e.set("activeView",s),e.set("selected",{}));var a=i?e.get("selected"):{};if(t.isArray(n))for(var o=n.length;o--;)a[n[o]]=1;else a[n]=1;e.set("selected",a)}).on("deselect",function(t){var n=e.get("selected");t in n&&(delete n[t],e.trigger("change:selected",e,n))})},loadDevices:function(t){var n=this,i=new e.Deferred;return this.devices.trigger("request"),App.getAllDevices(App.TYPE_MOBILE,t).done(function(e){n.devices.set(e.toJSON()),n.devices.trigger("sync"),i.resolve(n.devices)}),i},loadGeozones:function(){var t=this,n=new e.Deferred;return this.geozones.trigger("request"),e.ajax({url:App.getBaseUrl()+"zones-groups/zones-tree/",data:{order:"name"},success:function(e){for(var i=0,s=e.length;s>i;++i)for(var a=0,o=e[i].items.length;o>a;++a)t.geozones.add(e[i].items[a]);t.geozones.trigger("sync"),n.resolve(t.geozones)},error:function(){t.geozones.trigger("error"),n.reject(arguments[0])}}),n},searchDevices:function(e){var t={q:e,type:"objects",objType:App.TYPE_MOBILE};return App.search(t)},searchGeozones:function(t){return e.ajax({url:App.getBaseUrl()+"zones/search/",data:{q:t}})},saveMap:function(n,i,s,a){var o=new e.Deferred,r=t.keys(this.get(a?"mapped":"selected")),l=this.get(a?"selected":"mapped"),c=s?"objects/add-zone-control/":"objects/remove-zone-control/",d={};return i=Number(i),r.length?(r=t.map(r,function(e){return Number(e)}),"devices"==n?(d.objectIds=[i],d.zoneIds=r):(d.zoneIds=[i],d.objectIds=r),e.ajax({url:App.getBaseUrl()+c,data:d,success:function(){s?l[i]=!0:delete l[i],o.resolve()},error:function(){o.reject(arguments[0])}}),o):o.resolve()}};return c});