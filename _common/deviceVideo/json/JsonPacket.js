define(["underscore","./web-gzip","./md5","./utils"],function(t,n,s,e){function r(){this.commands=[],this.sessionId=0,this.error=null,this.forceChecksum=null}return t.extend(r.prototype,{addCommand:function(t){this.commands.push(t)},deleteCommand:function(n){var s=t.findWhere(this.commands,{seqNum:n});return s&&(this.commands=t.without(this.commands,s)),s||null},reset:function(){this.commands=[]},toBytes:function(){var t=this.toJson(),n=JSON.stringify(t);return new Uint8Array(e.str2hex(n))},toReadableBytes:function(){},toArrayBuffer:function(){return this.toBytes().buffer},toDeflatedArrayBuffer:function(){return n.deflateDataToArrayBuffer(this.toJson())},toJson:function(){var t={};return t[r.COMMANDS]=this._commandsToJson(),t[r.SESSION_ID]=this.sessionId,t[r.CHECKSUM]="",this._addChecksum(t)},toString:function(){return JSON.stringify(this.toJson())},_addChecksum:function(n){var s=t.extend({},n);return s[r.CHECKSUM]=this.forceChecksum||r.calculateJsonChecksum(n),s},_commandsToJson:function(){return t.map(this.commands,function(t){var n={};return n[r.COMMAND]=t.command.id,n[r.SEQ_NUM]=t.seqNum,n[r.PARAMS]=t.params,n})}}),r.COMMANDS="commands",r.COMMAND="command",r.SESSION_ID="sid",r.SEQ_NUM="sn",r.PARAMS="params",r.RESULTS="results",r.RESULT="result",r.CHECKSUM="md5",r.calculateJsonChecksum=function(t){return r.calculateChecksum(JSON.stringify(t))},r.calculateChecksum=function(t){return s(t.substr(0,t.lastIndexOf(r.CHECKSUM)))},r});