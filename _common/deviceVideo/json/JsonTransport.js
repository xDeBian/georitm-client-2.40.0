define(["underscore","./utils","./web-gzip","./WebsocketClient","./JsonResult","./JsonPacket","./JsonAnswerPacket","./JsonError","./TransportRequest","i18n!./nls/messages"],function(n,e,t,r,o,u,s,i,c,f){function a(n,e){return e="undefined"==typeof e?null:e,n in x?x[n]:e}function l(n,e,t){return e in n?n[e]:a(e,t)}function d(n){var e=f.errors;return n in e?e[n]:e[i.ERR_COMMON]+" (code "+n+")"}function S(r){var f,l=a("deflate",!1);if(l){var S=new Uint8Array(r,J);f=t.inflateUint8(S).toString()}else{if("string"!=typeof r)return;f=r}var m,E=u.calculateChecksum(f);try{m=JSON.parse(f)}catch(h){m=null}if(null!==m){console.log(e.pnow()+": <== JSON. Received "+f);var R=s.fromJson(m),p=m[u.CHECKSUM];p!==E&&(R.error=new i(i.ERR_CHECKSUM),console.error(e.pnow()+": <== JSON. Invalid md5 in received packet "+p+", required is "+E));var U=R.results;U.forEach(function(e){var t=e.seqNum,r=T(t);r&&(e.command||(e.command=n.extend({},r.sequence.command)),r.status!==c.STATUS_SENT||(R.error?A(R.error,r,m):e.code!==o.CODE_SUCCESS?(r.status=c.STATUS_ERROR,A(new i(e.code,d(e.code)),r)):(r.status=c.STATUS_SUCCESS,v(r,e)))),g(t)})}else console.error("Invalid JSON in packet")}function m(){M=[]}function T(n){return I.find(function(e){return e.sequence.commands.length&&e.sequence.commands[0].seqNum===n})}function E(n){return n.commands.map(function(n){return T(n.seqNum)})}function v(n,e){n.status!==c.STATUS_ABORTED&&n.resolve(e),h()}function A(n,e){if(e.status!==c.STATUS_ABORTED){e.status=c.STATUS_ERROR;var t="number"==typeof n?new i(n,d(n)):n;e.reject(t)}h()}function h(){if(M.length){var n=M[0],e=E(n).filter(function(n){return n.status===c.STATUS_NEW||n.status===c.STATUS_SENT});e.length||(M=M.slice(1),N())}}function R(n,t){n=e.asArray(n);var r=new u;return r.sessionId=l(t||{},"fromAddress",b.fromAddress),n.forEach(function(n){n.seqNum=++B,r.addCommand(n)}),r}function g(n){n in k&&(clearTimeout(k[n]),delete k[n])}function p(n,e){k[n]=setTimeout(function(){g(n);var e=T(n);e&&A(i.ERR_TIMEOUT,e)},e)}function U(n){var e=E(n).filter(function(n){return n.status!==c.STATUS_ABORTED});e.length&&(M.push(n),N())}function N(){if(M.length){var e=M.filter(function(n){var e=E(n);return e.filter(function(n){return n.status===c.STATUS_ABORTED}).length>0});if(e.length)e.forEach(function(e){M=n.without(M,e)}),N();else{var t=M.find(function(n){var e=E(n);return e.filter(function(n){return n.status===c.STATUS_NEW}).length>0});t&&C(t)}}}function C(n){var t,r=T(n.commands[0].seqNum),o=a("deflate",!1);if(o){var u=n.toDeflatedArrayBuffer();t=e.concatBuffers(new Uint8Array(e.uintToBytes(u.byteLength,J)).buffer,u)}else t=n.toString();D.send(t)?(console.log(e.pnow()+": ==> JSON. Send"+n.toString()),r.status=c.STATUS_SENT):A(i.ERR_SENDING_FAILED,r)}function _(e,t){t=t||{};var r=[],o=[],u=l(t,"timeout",b.timeout),s=R(e,t);return s.commands.forEach(function(e){var i=new Promise(function(e,r){var u=new c({sequence:s,resolve:e,reject:r,options:n.extend({},x,t)});o.push(u),I.push(u)});r.push(i),p(e.seqNum,u)}),o.length&&U(s),1===s.commands.length?r[0]:r}function O(e,t){D=new r(e.url,{onMessage:S,onOpen:e.onOpen||function(){},onClose:function(n){e.onClose&&e.onClose(n),m(n)},onError:e.onError||function(){}}),n.extend(x,t)}function w(){D.connect()}function q(){D.disconnect()}function y(){return D.isConnected()}var J=4,D=null,B=0,k=[],I=[],M=[],b={deflate:!0,timeout:2e4,fromAddress:255},x=n.extend({},b);return{setup:O,connect:w,request:_,disconnect:q,isConnected:y}});