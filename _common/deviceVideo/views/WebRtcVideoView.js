define(["jquery","underscore","jface","abstracts/View","../constants","./RitmVideoView","text!../tmpl/webRtc.html","css!../css/camera.css"],function(e,t,n,r,i,o){var s=o.prototype,a=null,c=2e4,l=o.extend({constructor:function(){this._webRtcClient=null,this._handleError=this._handleError.bind(this),o.apply(this,arguments)},render:function(){var e=this.controller;this._ratio=704/576,showCursor(),this._loadDependencies.call(this).done(function(t){a=t,_.connect.call(this).done(function(){e.has("container")?(this._popupMode=!1,this.setElement(e.get("container")),this._onContainerReady()):this._openWindow()}.bind(this)).fail(this._handleError).always(hideCursor)}.bind(this)).fail(function(e){hideCursor(),this._handleError(e)})},_getErrorMessage:function(e){var t=this.controller.getTexts(),n=t.errVideoUnknownError;return n=a?a.WebRtcClient.ERR_NO_ICE_SERVERS===e?t.errNoIceServers:a.WebRtcClient.ERR_USER_NOT_FOUND===e?t.errVideoDeviceOffline:a.WebRtcClient.ERR_WS_CLOSE_ABNORMAL===e?t.errSignalServerUnavailable:s._getErrorMessage.call(this,e):s._getErrorMessage.call(this,e)},_loadDependencies:function(){var t=new e.Deferred;if(null!==a)return t.resolve(a);var n="webrtc";return requirejs([n],function(e){t.resolve(e)}.bind(this),function(){t.reject(i.ERR_NO_LIB)}.bind(this)),t},_onContainerReady:function(){var e=this.getCameraNames();if(!e.length)return this._handleError(i.ERR_NO_CAMERAS);var t=a.HlsPlayer,n="HLS_LOG_LEVEL"in window?window.HLS_LOG_LEVEL:a.Logger.LOG_LEVEL.ERROR;this.$playerContainer=this.$el.find(".player-container");var r={};r[t.OPTION_WEBRTC_CLIENT]=this._webRtcClient,r[t.OPTION_PROVIDER]=this.getTargetImei(),r[t.OPTION_ARCHIVE]=!1,r[t.OPTION_CAMERA]=camera,r[t.OPTION_CAMERAS]=e,r[t.OPTION_RATIO]=60/49,r[t.OPTION_LOG_LEVEL]=n,r[t.OPTION_LOCALE]=App.getLocale().substr(0,2),r[t.OPTION_ENABLE_WORKER]=!0,window._georitmPlayer=this._player=new t(this.$playerContainer[0],r)},_destroyTransport:function(){this._webRtcClient&&(this._webRtcClient.destroy(),window.webRtcClient=this._webRtcClient=null)}}),_={connect:function(){var t=this,n=new e.Deferred,r=this.getTargetImei(),o=this.options.webRtcOptions,s=a.SignalClient,l=a.WebRtcClient,O=o.port,h="WEBRTC_LOG_LEVEL"in window?window.WEBRTC_LOG_LEVEL:a.Logger.LOG_LEVEL.ERROR,E=s.uuid(),R=o.protocol+"//"+o.host+(80===O||443===O?"":":"+O),d={};d[l.OPTION_USER_ID]=E,d[l.OPTION_SIGNAL_URL]=R,d[l.OPTION_SIGNAL_PROTOCOL]=s.PROTOCOL_SIGNAL,d[l.OPTION_LOG_LEVEL]=h;var u=window.webRtcClient=this._webRtcClient=new l(d),L=function(e){t._clearConnectionTimeout(),n.reject(e)};return u.on("error",L),u.on("open",function(){t._clearConnectionTimeout(),u.removeListener("error",L),u.on("close",_.onChannelClose.bind(t)),n.resolve(u)}),u.on("ready",function(){u.connectTo(r)}),this._connectionTimeout=setTimeout(function(){n.reject(i.ERR_CONNECTION_FAIL)},c),n},onChannelClose:function(){this._destroyPlayer(),this._onFatalError()}};return l});