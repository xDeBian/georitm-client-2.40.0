define(["jquery","underscore","jface","abstracts/View","../constants","../utils","./RitmVideoView","../json/commands","../json/JsonCommand","../json/JsonError","../json/JsonTransport","../MediaServerSourceProvider","_libs/video-player/player.bundle-1.3.0","css!../css/camera.css"],function(e,n,t,i,o,r,s,a,d,c,l,_,m){var u=s.prototype,h=m,f={DISCONNECTED:0,RECEIVING_SHELL_INFO:1,HAS_SHELL_INFO:2,CONNECTED:3,AUTHORIZED:4},E=12e4,T=s.extend({constructor:function(){this._removed=!1,this._onlineVideoStarting=!1,this._deviceConnectionStatus=f.DISCONNECTED,this._startCommandTimeout=null,this._startCommandLastTs=0,this._playRetryTimeout=null,this._retryToPlayArchive=null,this._sourceProvider=null,this._handleError=this._handleError.bind(this),this.startOnlineOnDevice=this.startOnlineOnDevice.bind(this),this._disconnectFromDevice=this._disconnectFromDevice.bind(this),this._handleDeviceDisconnected=this._handleDeviceDisconnected.bind(this),this._handleCommandError=this._handleCommandError.bind(this),this._handlePlayerError=this._handlePlayerError.bind(this),this._handlePlayerPlay=this._handlePlayerPlay.bind(this),this._handlePlayerTimeUpdate=null,s.apply(this,arguments)},initialize:function(){u.initialize.apply(this,arguments),this.on("resizestop",function(){this._player&&this._player.resize()})},resizable:!0,render:function(){var e=this.controller;this._ratio=1920/1080,this._loadDependencies().done(function(){e.has("container")?(this._popupMode=!1,this.setElement(e.get("container")),this._onContainerReady()):this._openWindow()}.bind(this))},fitSize:function(){this._player&&n.isFunction(this._player.resize)&&this._player.resize()},setStartTs:function(e){this._player&&this._sourceProvider&&this._player.play(e)},pause:function(){this._player&&this._player.pause()},remove:function(){this._removed=!0,this.stopListeningTimeUpdate(),this.clearPlayRetryTimeout(),this._clearStartCommandTimeout(),this._disconnectFromDevice(),this._sourceProvider&&this._sourceProvider.stopListening(),u.remove.apply(this,arguments)},startOnlineOnDevice:function(e,n){function t(e){var n="color: #B36100";console.log("%c"+r.pnow()+": RtpVideoView. startOnlineOnDevice: "+e,n)}function i(e){d._removed||(e.code&&d._player&&d._player.setError(e.code),e.message?alert(e.message,d.controller.getTexts().error):d.showErrors(e))}function s(){d._isSendingOfStartCommandPossible()&&(n?(t("Handle connected, send stop_online_video and then start_online_video"),d._sendStopCommand().then(function(){d._startCommandLastTs=0,d._sendStartCommand(e,!0)},i)):(t("Handle connected, send start_online_video"),d._sendStartCommand(e,!1)))}if(t("called with uuid: "+e+", stopFirst: "+n),!this._isSendingOfStartCommandPossible()){var a="Unknown reason";return this._isSendingOfCommandsToDevicePossible()?this._onlineVideoStarting?a="Online video already starting":this.model.getMediaServerRtspInputUrl()||(a="No media server rtsp input url"):a="Sending of commands is not possible",t("Sending of start command is not possible: "+a),void 0}n=n!==!1;var d=this,c=this.getTargetImei();if(this._onlineVideoStarting=!1,this._isConnectedToDevice())s();else if(this._deviceConnectionStatus===f.DISCONNECTED)t("Status is DISCONNECTED, connect with device"),this._connectWithDevice(c).done(s).fail(i);else{t("Already connecting, wait until authorized (dcs:change)");var l=function(e,n){e===f.AUTHORIZED?(t("Connected and authed, call handleConnected"),d.off("dcs:change",l),s()):n>e&&(t("Connection failed, show error ERR_CONNECTION_FAIL"),d.off("dcs:change",l),i({code:o.ERR_CONNECTION_FAIL}))};this.on("dcs:change",l)}},_beforeArchiveDataReceiving:function(){function e(){}if(!this._isSendingOfCommandsToDevicePossible())return e("Sending of commands is not possible, reject"),Promise.reject();var n=this,t=this.getTargetImei();return new Promise(function(i,o){function r(t){e("handleError, reject with",t),n._removed||o(t)}function s(){n._removed||i()}if(n._isConnectedToDevice())s();else if(n._deviceConnectionStatus===f.DISCONNECTED)e("disconnected, try to connect"),n._connectWithDevice(t).done(s).fail(r);else{e("already connecting, wait until authorized");var a=function(e,t){e===f.AUTHORIZED?(n.off("dcs:change",a),s()):t>e&&(n.off("dcs:change",a),r())};n.on("dcs:change",a)}})},getDeviceArchiveDays:function(e,n,t){function i(e){var n="color: #009957";console.log("%cRtpVideoView. getDeviceArchiveDays: "+e,n)}var o=this;return new Promise(function(s){o._beforeArchiveDataReceiving().then(function(){l.request(new d({command:a.findCommandById(a.CMD_GET_VIDEO_DAYS),params:{uuid:e,p_begin:r.getMonthStartAsUTCString(n,t),p_end:r.getMonthEndAsUTCString(n,t)}})).then(function(e){i("Got response with periods: "+JSON.stringify(e.params.periods));var n=r.utcPeriodsToDateRanges(e.params.periods);i("Produced ranges: "+JSON.stringify(n));var o=[];n.forEach(function(e){for(var n=e[0].getTime(),i=e[1].getTime(),r=864e5;i>n;){var s=new Date(n),a=s.getMonth()+1,d=s.getDate();t===a&&o.indexOf(d)<0&&o.push(d),n+=r}}),i("Produced days: "+JSON.stringify(o)),s(o)},function(e){console.warn("Fetching of day periods from device has failed with reason:",e),s([])})},function(){s([])})})},getDeviceArchiveRanges:function(e,n){var t=this;return new Promise(function(i){t._beforeArchiveDataReceiving().then(function(){var t=new Date(r.getDayStart(n)),o=new Date(t.getTime()+864e5-1e3);l.request(new d({command:a.findCommandById(a.CMD_GET_VIDEO_MINUTES),params:{uuid:e,p_begin:r.formatDateAsUTC(t),p_end:r.formatDateAsUTC(o)}})).then(function(e){if(Array.isArray(e.params.periods)){var n=r.utcPeriodsToDateRanges(e.params.periods);i(n.map(function(e){return e.map(Number)}))}else console.warn("No periods in device response for get_video_minutes"),i([])},function(e){console.warn("Got Error with code "+e.code+" for get_video_minutes"),i([])})},function(){console.warn("_beforeArchiveDataReceiving failed, resolve with empty array"),i([])})})},startFileTransmission:function(e,n){var t=this;return new Promise(function(i,o){t._isSendingOfArchiveTransmissionCommandPossible()?t._beforeArchiveDataReceiving().then(function(){if(t._isSendingOfArchiveTransmissionCommandPossible()){var s=t.model.getMediaServerUrl();s+=("/"===s.slice(-1)?"":"/")+"file/upload",l.request(new d({command:a.findCommandById(a.CMD_ADD_VIDEO_QUEUE),params:{archive_server:s,uuid:e,begin:r.formatDateAsUTC(n[0]),end:r.formatDateAsUTC(n[1]),number_of_attempts:3,authorization:""}})).then(function(){i()},function(){o()})}else o()},function(){console.log("RtpVideoView sending of command is impossible"),o()}):o()})},_loadDependencies:function(){return(new e.Deferred).resolve(h)},_isConnectedToDevice:function(){return this._deviceConnectionStatus>=f.AUTHORIZED},_isSendingOfCommandsToDevicePossible:function(){return this.model.isOnline()&&!this._removed&&this._player},_isSendingOfArchiveTransmissionCommandPossible:function(){return this._isSendingOfCommandsToDevicePossible()&&!!this.model.getMediaServerRtspInputUrl()},_isSendingOfStartCommandPossible:function(){return this._isSendingOfCommandsToDevicePossible()&&!this._onlineVideoStarting&&!!this.model.getMediaServerRtspInputUrl()},_connectWithDevice:function(n){var t=this,i=new e.Deferred;return this._isConnectedToDevice()?i.resolve():(t._setDeviceConnectionStatus(f.RECEIVING_SHELL_INFO),this._getShellInfo(n).done(function(e,n,o){if(t._isSendingOfCommandsToDevicePossible())console.log("RtpVideoView: connectWithDevice: Shell info received, set STATUS.HAS_SHELL_INFO, call _startConnection"),t._setDeviceConnectionStatus(f.HAS_SHELL_INFO),t._startConnection(e,n,o).done(function(){i.resolve()}).fail(function(e){console.log("RtpVideoView: connectWithDevice: Failed to start connection reject with:",e),t._setDeviceConnectionStatus(f.DISCONNECTED),i.reject(e)});else if(!t._removed){var r="unknown";t.model.isOnline()?t._player||(r="No player instance"):r="Device is offline",console.log("RtpVideoView: connectWithDevice: Shell info received but sending of commands is not possible ("+r+"), set STATUS.DISCONNECTED"),t._setDeviceConnectionStatus(f.DISCONNECTED),i.reject()}}).fail(function(e){console.error("RtpVideoView: connectWithDevice: getShellInfo failed set STATUS.DISCONNECTED, reject with",e),t._setDeviceConnectionStatus(f.DISCONNECTED),i.reject(e)}),i)},_setDeviceConnectionStatus:function(e){var n=this._deviceConnectionStatus;this._deviceConnectionStatus=e,e!==n&&this.trigger("dcs:change",e,n)},_startConnection:function(n,t,i){var r=this,s=new e.Deferred;return l.setup({url:n,onOpen:function(){r._setDeviceConnectionStatus(f.CONNECTED),r._sendToken(t).then(function(){r._setDeviceConnectionStatus(f.AUTHORIZED),s.resolve()},function(e){r._disconnectFromDevice(),s.reject(e)})},onClose:r._handleDeviceDisconnected,onError:function(){var e=r.controller.getTexts();s.reject({code:o.ERR_CONNECTION_FAIL,message:e.errVideoIdpConnectionFailed})}},{fromAddress:i}),l.connect(),s},_sendToken:function(e){return l.request(new d({command:a.findCommandById(a.CMD_SEND_SECURITY_TOKEN),params:{security_token:e}}))},_handleCommandError:function(e){this._disconnectFromDevice(),this._removed||alert(e.message)},_disconnectFromDevice:function(){l.isConnected()?l.disconnect():this._handleDeviceDisconnected()},_handleDeviceDisconnected:function(){this._clearStartCommandTimeout(),this._setDeviceConnectionStatus(f.DISCONNECTED),this._onlineVideoStarting=!1},_getShellInfo:function(n){var t=new e.Deferred;return e.ajax({url:App.getBaseUrl()+"iserver-shell/json-shell-info/",data:{imei:Number(n)}}).then(function(e){var n=App.isHttpsClient()&&"webSocketSecuredPort"in e,i=n?e.webSocketSecuredPort:e.webSocketPort,o=e.host,r="/idp-web"+e.webSocketPath,s=(n?"wss":"ws")+"://"+o+":"+i+r;t.resolve(s,e.token,e.address)}.bind(this)).fail(t.reject),t},_sendStartCommand:function(e,n){if(!this._isSendingOfStartCommandPossible())return console.log(r.pnow()+": RtpVideoView: _sendStartCommand: _isSendingOfStartCommandPossible returned false"),void 0;n=n===!0;var i=this,o=Date.now()-this._startCommandLastTs;if(E>o){this._onlineVideoStarting=!1;var s=E-o;return console.log(r.pnow()+": RtpVideoView: _sendStartCommand: "+"We sent the command less than 2 minutes ago ("+this._startCommandLastTs+"), "+"no need to send now, reset timeout with delay: "+s),i._setStartCommandTimeout(e,s),void 0}var c=this.model.getMediaServerRtspInputUrl();this._onlineVideoStarting=!0,l.request(new d({command:a.findCommandById(a.CMD_START_ONLINE_VIDEO),params:{uuid:e,stream:1,online_server:c}})).then(function(){i._startCommandLastTs=Date.now(),n&&t.growl.open(i.controller.getTexts().commandSent),i._onlineVideoStarting=!1,i._setStartCommandTimeout(e)},i._handleCommandError)},_sendStopCommand:function(){return l.request(new d({command:a.findCommandById(a.CMD_STOP_ONLINE_VIDEO),params:{uuid:"*",stream:1}}))},_setStartCommandTimeout:function(e,n){console.log("%c"+r.pnow()+": RtpVideoView. _clearStartCommandTimeout before setting of new","#0d2d34"),this._clearStartCommandTimeout(),n=n||E,this._removed||(console.log(r.pnow()+": RtpVideoView. Set timeout to send start_online_video after "+n/1e3+" seconds"),this._startCommandTimeout=setTimeout(function(){this._sendStartCommand(e)}.bind(this),n))},_clearStartCommandTimeout:function(){this._startCommandTimeout&&(clearTimeout(this._startCommandTimeout),this._startCommandTimeout=null)},_onContainerReady:function(){var e=this,n=this.getCamerasList(),t=this.getCameraNames(),i=this.controller.getTexts();if(!n.length)return this._handleError(o.ERR_NO_CAMERAS);this.$playerContainer=this.$el.find(".player-container");var s=this._sourceProvider=window.mediaServerSourceProvider=new _({cameras:n,mediaServerUrl:this.model.getMediaServerUrl(),deviceConnector:this}),a=m.Player,d=m.Logger,l=a.getDefaults(),u="VIDEO_LOG_LEVEL"in window?window.VIDEO_LOG_LEVEL:d.LOG_LEVEL.ERROR,h={};h[a.OPTION_CLASSNAME]=l[a.OPTION_CLASSNAME]+" ritm-player",h[a.OPTION_LOG_LEVEL]=u,h[a.OPTION_LOCALE]=App.getLocale().substr(0,2),h[a.OPTION_RATIO]=this._ratio,h[a.OPTION_LIVE]=!0,h[a.OPTION_ARCHIVE]=!0,h[a.OPTION_SOURCE_PROVIDER]=s,h[a.OPTION_MERGE_RANGES]=!1,h[a.OPTION_ROUND_TO_MINUTES]=!1,h[a.OPTION_SPEED_LEVELS]=[1,2,4],h[a.OPTION_CAMERAS]=t,h[a.OPTION_CAMERA]=t.findIndex(function(e){return null!==e}),h[a.OPTION_HLS_CONFIG]=null;var f={};f[c.ERR_TIMEOUT]=function(e,n){e.innerHTML=n.tmpl({msg:i.errVideoCommandSendingFail,retryText:""})},f[o.ERR_CAMERA_STARTING]=function(e,n){e.innerHTML=this.model.isOnline()?n.tmpl({msg:i.errVideoCameraIsStarting,retryText:""}):n.tmpl({msg:i.errVideoObjectIsOffline})}.bind(this),f[o.ERR_CONNECTION_FAIL]=function(e,n){e.innerHTML=n.tmpl({msg:i.errVideoStreamNotFound})}.bind(this),f[o.ERR_ARCHIVE_FILE_NEEDS_TRANSMISSION]=function(e,n){e.innerHTML=n.tmpl({msg:i.videoFilesWillBeTransmitted})},f[o.ERR_ARCHIVE_FILE_TRANSMITTING]=function(e,n){e.innerHTML=n.tmpl({msg:i.videoFilesAreBeingTransmitted})},f[o.ERR_ARCHIVE_FILE_TRANSMISSION_FAIL]=function(e,n){e.innerHTML=n.tmpl({msg:i.videoFilesTransmissionHasFailed})},h[a.OPTION_CUSTOM_ERRORS]=f;var E=window._georitmPlayer=this._player=new a(this.$playerContainer[0],h);E.on(a.EVENT_BEFORE_START,function(n){e.clearPlayRetryTimeout(),s.stop(n.url)}),E.on(a.EVENT_PLAY,this._handlePlayerPlay),E.on(a.EVENT_PAUSE,function(){e.stopListeningTimeUpdate(),console.log("%c"+r.pnow()+": RtpVideoView. _clearStartCommandTimeout on Player.EVENT_PAUSE","#0d2d34"),e._clearStartCommandTimeout(),s.pause()}),E.on(a.EVENT_STOP,function(){e.stopListeningTimeUpdate(),e.clearPlayRetryTimeout(),console.log("%c"+r.pnow()+": RtpVideoView. _clearStartCommandTimeout on Player.EVENT_STOP","#0d2d34"),e._clearStartCommandTimeout(),s.stop()}),E.on(a.EVENT_ERROR,this._handlePlayerError)},clearPlayRetryTimeout:function(){this._playRetryTimeout&&(clearTimeout(this._playRetryTimeout),this._playRetryTimeout=null)},stopListeningTimeUpdate:function(){this._handlePlayerTimeUpdate&&this._player&&(this._player.off(m.Player.EVENT_TIMEUPDATE,this._handlePlayerTimeUpdate),this._handlePlayerTimeUpdate=null)},_handlePlayerError:function(e){function n(e){var n="color: #990342";console.log("%c"+r.pnow()+": RtpVideoView. _handlePlayerError: "+e,n)}var t=this,i=0,s=this._sourceProvider,a=this._player,d=m.Player,c=e.error,l=e.data||{},_=function(e,r){t.clearPlayRetryTimeout(),i++,40>=i?(n("Set timeout to check if online video started, try: "+i),t._playRetryTimeout=setTimeout(function(){t._deviceConnectionStatus!==f.DISCONNECTED&&t._player&&t._player.isLive?s.connectAndCheckCamera(e,null).then(function(n){t._player&&t._player.isLive&&(n.isAlive?(i=0,r()):_(e,r))}):(i=0,n("Timeout handler: There is no connection, no more retries"))},3e3)):a.setError(o.ERR_CONNECTION_FAIL)},u=function(e,r,d){t.clearPlayRetryTimeout(),i++;var c=function(){s.removeProcessingPeriod(e,r),a&&!a.isPlaying&&a.setError(o.ERR_ARCHIVE_FILE_TRANSMISSION_FAIL)};30>=i?(n("Set timeout to check if archive file appeared, try: "+i),t._playRetryTimeout=setTimeout(function(){t._deviceConnectionStatus!==f.DISCONNECTED?(n("Check if file appeared for camera: "+e+", and startTs: "+r),s.checkFilesAppearance(e).then(function(t){var o=t.find(function(e){return e[0]<=r&&e[1]>r});n("Got result with new file ranges: "+JSON.stringify(t)+", search for startTs: "+r+(o?", found: "+JSON.stringify(o):", NOT FOUND")),o?(i=0,d(o)):u(e,r,d)})):(i=0,n("Timeout handler: There is no connection, no more retries"),c())},1e4)):c()},h=function(){n("Retry to play live possibility: "+(a&&!a.isPlaying)),a&&!a.isPlaying&&a.play()},E=function(e,t){var i=function(e){n("Got found range "+JSON.stringify(e)+", can play: "+(a&&!a.isPlaying)+", start from range[0]"),a&&!a.isPlaying&&a.play(e[0])};return i.startTs=t,i.cameraNumber=e,i};if(c===d.MEDIA_ERR_NETWORK&&"none"!==navigator.connection.type)n("handle MEDIA_ERR_NETWORK code, and we have internet"),_(e.camera,h);else if(c===o.ERR_CAMERA_STARTING)i=0,n("handle ERR_CAMERA_STARTING"),_(e.camera,h);else if(c===o.ERR_ARCHIVE_FILE_NEEDS_TRANSMISSION){t.clearPlayRetryTimeout(),n("handle ERR_ARCHIVE_FILE_NEEDS_TRANSMISSION, passed data: "+JSON.stringify(l)),i=0;var T=l.cameraNumber,S=l.startTs,v=t._retryToPlayArchive;v&&v.startTs===S&&v.cameraNumber===T||(v&&s.removeProcessingPeriod(T,v.startTs),t._retryToPlayArchive=E(T,S)),u(T,S,t._retryToPlayArchive)}else c===o.ERR_ARCHIVE_FILE_TRANSMITTING&&n("handle ERR_ARCHIVE_FILE_TRANSMITTING, passed data: "+JSON.stringify(l))},_handlePlayerPlay:function(e){function t(e){var n="color: #246655";console.log("%c"+r.pnow()+": handlePlayerPlay: "+e,n)}this.stopListeningTimeUpdate(),this._sourceProvider;var i=e.mediaElement,o=i.duration;if(Number.isFinite(o)){o*=1e3;var s=1e3*i.currentTime;t("Duration: "+o+" currentTime: "+s+", start listening of timeupdate"),this._handlePlayerTimeUpdate=this._makeTimeUpdateHandler(n.extend({},e.state)),this._player.on(m.Player.EVENT_TIMEUPDATE,this._handlePlayerTimeUpdate)}},_makeTimeUpdateHandler:function(e){function t(e){var n="color: #246655";console.log("%c"+r.pnow()+": handlePlayerTimeUpdate: "+e,n)}var i=e.startTs,s=e.camera;return function(e){function a(e){return d._player&&!d._removed&&d._player.isPlaying&&i===e.startTs&&!e.isLive&&e.camera===s}var d=this,c=this._sourceProvider,l=e.state;if(!a(l))return d.stopListeningTimeUpdate(),void 0;var _=e.mediaElement,m=1e3*_.duration,u=1e3*_.currentTime,h=e.state;if(u>=m-Math.min(3e4,m/2)){d.stopListeningTimeUpdate();var f=h.currentTs,E=f+m-u+2e3,T=new Date(E),S=r.rangesCacheKey(s,o.SERIE_ID_PROCESSING,T),v=5e3,p=c.findInCache(S);if(E>=Date.now()-v||p.find(function(e){return e[0]===E}))return;t("Cur media TS: "+u+", Camera: "+s+", search next range"),c.getRangeSeries(s,[T]).then(function(e){if(a(d._player.state)){var i,l=n.findWhere(e,{id:o.SERIE_ID_SERVER});if(l){t("Found "+o.SERIE_ID_SERVER+" serie for required date: "+T);var _=l.ranges[0];if(i=r.findRangeByStartTs(E,_))return t("Found "+o.SERIE_ID_SERVER+" range to be requested for date: ["+new Date(i[0])+", "+new Date(i[1])+"] no need to request"),void 0}var m=n.findWhere(e,{id:o.SERIE_ID_DEVICE});if(m){t("Found "+o.SERIE_ID_DEVICE+" serie for required date: "+T);var u=m.ranges[0];i=r.findRangeByStartTs(E,u);var h=59e3;if(i&&i[1]-E>v){var f=c.findCameraUuid(s);t("Found "+o.SERIE_ID_DEVICE+" range to be requested for date: ["+new Date(i[0])+", "+new Date(i[1])+"]"+", uuid: "+f);var p=[E,Math.min(E+h,i[1])];d.startFileTransmission(f,p).then(function(){var e=c.addRangeToCache(S,p);c.notify(c.CHANNEL_RANGE_SERIES_UPDATE,{date:T,series:[{id:o.SERIE_ID_PROCESSING,ranges:e}]})},function(){})}else t("NOT Found "+o.SERIE_ID_DEVICE+" range for required date")}else t("NOT Found "+o.SERIE_ID_DEVICE+" serie for required date")}})}}.bind(this)}});return T});