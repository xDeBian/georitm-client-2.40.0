define(["jquery","underscore","jqueryui","jface","abstracts/View","text!../tmpl/camera.html","css!../css/camera.css","_libs/camera-player/js/camera-player","css!_libs/camera-player/css/camera-player.min.css"],function(e,t,i,r,n,o){o=t.template(o);var l=1152,a=1440,s=n.extend({constructor:function(){this.controller=null,this._popupMode=!0,this._player=null,this._quarter=!1,n.apply(this,arguments)},initialize:function(e){this.controller=e.controller,c.bindEvents.call(this),this.render()},render:function(){var e=this.controller;e.has("container")?(this._popupMode=!1,this.setElement(e.get("container")),c.onContainerReady.call(this)):c.openWindow.call(this)},fitSize:function(e){e=e||this.controller.get("camera");var t=e.width,i=e.height,r=i/t,n=this.$el.find(".cp-video"),o=this.$el.find(".cp-video-wrap"),l=(o.width(),this.$el.find(".cp-bottom").outerHeight()),a=this.$el.height(),s=a-l,c=Math.round(s/r);n[0].style.height=s+"px",o[0].style.paddingBottom="0px",o[0].style.height=s+"px",o[0].style.width=c+"px",this._player.trigger("resize")},fitSizeInPopup:function(t){var i=t.width,r=t.height,n=r/i,o=this.$el.find(".cp-video-wrap"),l=o.width(),a=l*n,s=this.$el.find(".cp-bottom").outerHeight(),c=this.$el.find(".jw-hdr").outerHeight(),h=this.$el.find(".jw-content"),d=a+s+c,u=e(window).height()-this.$el.offset().top-20;if(d>u){var p=u-s-c,f=Math.round(p/n);this.el.style.width=f+"px",o[0].style.height=p+"px",h.height(p+s)}else h.height(a+s)},remove:function(){this._player&&(this._player.destroy(),this._player=null),this.stopListening(),this._popupMode||this.$el.remove()}}),c={openWindow:function(){var e=this,t=this.controller,i=t.getTexts(),n={winId:"win-device-video",addClass:"device-video",headerHtml:i.cameraOnObject.replace("#title#",App.buildObjTitle(this.model)),contentHtml:o({i18n:i}),width:700,dieAfter:0,openCallback:function(){e.setElement(this),c.onContainerReady.call(e)},activateCallback:function(){},closeCallback:function(){r.hideOverlay(),e.controller.destroy()}},l=t.getUserData("winLeft"),a=t.getUserData("winTop");null===l||null===a?n.centered=!0:(0>l&&(l=0),0>a&&(a=0),n.initX=l,n.initY=a),r.showOverlay(),r.window.open(n)},onContainerReady:function(){var e=this;c.bindUIEvents.call(this),this.controller.load().done(function(t){c.initPlayer.call(e,t)}).fail(function(){e.showErrors(arguments[0]),e._popupMode?e.$el.trigger("jw.close"):e.controller.destroy()})},bindEvents:function(){var e=this;this.listenTo(this.controller,"destroy",function(){e.remove()}).listenTo(this.controller,"change:loading",function(t,i){e.$el[i?"addClass":"removeClass"]("loading")}).listenTo(this.controller,"change:playTime",function(i,r){if(e._player){var n=e._player.controls.timeline,o=t.once(function(){n.off("viewreset",o);var e=n.getRangeIndex(r);e>=0&&n.trigger("select",r)});n.on("viewreset",o),n.setCenter(r)}})},bindUIEvents:function(){var e=this.controller;this.$el.on("dragstop",function(t,i){i&&(e.setUserData("winLeft",i.position.left),e.setUserData("winTop",i.position.top))})},initPlayer:function(t){if("cplayer"in window){var i=this,r=this.controller,n=r.getTexts(),o=this.controller.get("sessionId"),s=864e5,h=s*(Math.floor((new Date).getTime()/s)+.5)+6e4*App.getUserTimezone(),d=this._popupMode?this.$el.find(".jw-content"):this.$el;o||alert("No session id"),t=t||this.controller.get("camera");var u=s/24,p=cplayer.Timeline.defaults.zoomLevels.slice(0);p=p.concat([u/12,u/30]);var f={debug:!1,swfFolder:"_libs/camera-player/swf",playerSwf:"flowplayer.swf",i18n:{err:n.error,errStreamNotFound:n.errVideoStreamNotFound,errCommon:n.errVideoUnknownError},sources:function(e,i){var n="",o={type:"flv",autoPlay:1,ratio:t.height/t.width};return 0>e?(n=r.getLiveUrl(),o.url=n,o.live=!0):(n=r.getArchiveUrl(e,i||{}),o.url=n,o.live=!1,o.startTime=e,o.duration=i.duration||36e5),[o]},controls:{buttonLive:{text:""},timeIndicator:{format:function(e,t){var i="";if(e>0){var r=t.getSource();i="<strong>"+(r.live?n.videoOnline:n.videoArchive)+" "+t.formatTime(e,!0)+"</strong> "+t.formatDate(e)}return i}},timeline:{center:h,position:"11",zoom:1,zoomLevels:p,minTime:Math.round(1e3*t.first_online),rangeColor:"#007bb8",ranges:function(t,i){var o=new e.Deferred;return r.loadArchive(t,i,!1).done(function(e){o.resolve(e)}).fail(function(){alert(n.errVideoArchiveLoading,n.error),o.reject(arguments[0])}),o},days:function(t,i){var o=new e.Deferred;return r.loadArchive(t,i,!0).done(function(e){o.resolve(e)}).fail(function(){alert(n.errVideoArchiveLoading,n.error),o.reject(arguments[0])}),o},loadingRangesText:n.videoLoadingArchive}}};t.width==a&&t.height==l&&(f.controls.overlayControl={dblclick:function(e,r){c.toggleQaurter.call(i,t,r)}}),this._player=new cplayer.Player(d,f),d.find(".cp-btn").addClass("btn btn-primary"),this._popupMode?this.fitSizeInPopup(t):this.fitSize(t)}},toggleQaurter:function(e,t){var i=(this._player,this.$el),r=i.find(".cp-video"),n=!this._quarter,o=r.width()/2,l=r.height()/2,a=1;t[0]>o?a=t[1]>l?4:2:t[1]>l&&(a=3),n?i.attr("data-quarter",a):i.removeAttr("data-quarter"),this._quarter=n}};return s});