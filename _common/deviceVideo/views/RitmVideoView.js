define(["jquery","underscore","jface","abstracts/View","../constants","text!../tmpl/playerContainer.html","css!../css/camera.css"],function(e,t,i,n,r,o){o=t.template(o);var s=n.extend({constructor:function(){this.controller=null,this.options={},this._children={},this._popupMode=!0,this._popupOpened=!1,this._connectionTimeout=null,this._player=null,this._ratio=1,this.$playerContainer=null,n.apply(this,arguments)},resizable:!0,initialize:function(e){this.options=e,this.controller=e.controller,this._bindEvents();var t=this.getTargetImei();t?this.getCamerasList().length?this.render():this._handleError(r.ERR_NO_CAMERAS):this._handleError(r.ERR_NO_IMEI)},render:function(){},getTargetImei:function(){var e=this.model.get("imei");return e?String(e):""},getCamerasList:function(){var e=this.model.getCamerasList();if(e.length){var i=1;e.forEach(function(e){i=Math.max(i,e.num+1)}),e=t.range(0,i).map(function(i){var n=t.findWhere(e,{num:i});return n||null})}return e},getCameraNames:function(){return t.map(this.getCamerasList(),function(e){return null!==e?e.name:null})},remove:function(){this.stopListening(),this._destroyPlayer(),this._destroyTransport(),this._popupMode||this.$el.remove()},_bindEvents:function(){var e=this.controller;this.listenTo(e,"destroy",function(){this.remove()}).listenTo(e,"change:loading",function(e,t){this.$el[t?"addClass":"removeClass"]("loading")})},_getErrorMessage:function(e){var t=this.controller.getTexts(),i=t.errVideoUnknownError;return e===r.ERR_NO_LIB?i=t.errVideoPlayerLibUnavailable:e===r.ERR_NO_IMEI?i=t.errVideoNoImei:e===r.ERR_NO_CAMERAS?i=t.errVideoNoCameras:e===r.ERR_CONNECTION_FAIL&&(i=t.errVideoConnection),i},_handleError:function(e){var t=this.controller.getTexts(),i=this._getErrorMessage(e);alert(i,t.error),this._onFatalError()},_loadDependencies:function(){return(new e.Deferred).reject()},_getHtml:function(){var e=this.controller,t={i18n:e.getTexts()};return o(t)},_openWindow:function(){function t(){var e=n.$el.find(".jw-resize"),t=n.$el.height()-n.$el.find(".jw-hdr").outerHeight();t<e.height()&&(e[0].style.height=t+"px")}var n=this,r=this.controller,o=r.getTexts(),s=this.resizable,a=400,l=a*this._ratio,h={winId:"win-device-video",addClass:"device-video device-video-ritm"+(s?" device-video-resizable":""),headerHtml:o.cameraOnObject.replace("#title#",App.buildObjTitle(this.model)),contentHtml:this._getHtml(),dieAfter:0,resizable:s,width:l,minWidth:l,minHeight:a,openCallback:function(){if(n._popupOpened=!0,n.setElement(this),n.$el.on("dragstop",function(e,t){t&&(r.setUserData("winLeft",t.position.left),r.setUserData("winTop",t.position.top))}),s){var i=r.getUserData("winHeight"),o=n.$el.find(".jw-resize");i&&(i=Math.min(.95*e(window).height(),i),n.el.style.height=i+"px",o[0].style.height=i-42+"px"),n.$el.resizable("option","stop",function(e,i){n.trigger("resizestop",i),t(),i.size.width!==i.originalSize.width&&(r.setUserData("winWidth",i.size.width),r.setUserData("winLeft",i.position.left)),i.size.height!==i.originalSize.height&&(r.setUserData("winHeight",i.size.height),r.setUserData("winLeft",i.position.left))})}},showCallback:function(){n._onContainerReady(),s&&t()},closeCallback:function(){n._popupOpened=!1,i.hideOverlay(),n.controller.destroy()}},c=r.getUserData("winLeft"),d=r.getUserData("winTop");if(null===c||null===d?h.centered=!0:(0>c&&(c=0),0>d&&(d=0),h.initX=c,h.initY=d),s){var u=e(window).width();h.width=Math.min(r.getUserData("winWidth"),.95*u)||l}i.showOverlay(),i.window.open(h)},_onContainerReady:function(){},_onFatalError:function(){this._popupMode&&this._popupOpened?this.$el.trigger("jw.close"):this.controller.destroy()},_destroyPlayer:function(){this._player&&(this._player.destroy(),window._georitmPlayer=this._player=null)},_destroyTransport:function(){},_clearConnectionTimeout:function(){this._connectionTimeout&&(clearTimeout(this._connectionTimeout),this._connectionTimeout=null)}});return s});