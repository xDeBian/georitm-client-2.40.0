define(["jquery","underscore","abstracts/Module","_common/mobile/MobileDetails","_common/stat/StatDetails","./views/IvideonVideoView","i18n!_common/nls/common"],function(e,s,i,t,r,n,o){var a="https://streaming.ivideon.com",d=i.extend({constructor:function(){this._xhr=null,i.apply(this,arguments)},defaults:{loading:!1,container:null,device:null,sessionId:"",camera:null,playTime:-1},initialize:function(){var e=App.get("ivSessions"),s=this.get("device"),i=s.get("ivideon");i.ivlogin in e&&this.set("sessionId",e[i.ivlogin]),this._view=new n({model:this.get("device"),controller:this})},setStartTs:function(e){this.set("playTime",e)},pause:function(){console.warn("Pause is not applied for IVideon")},load:function(){var i=this,t=this.get("device"),r=new e.Deferred,n=t.get("ivideon"),o={login:n.ivlogin,password:n.ivpassword},a=this.get("sessionId");return this.set("loading",!0),a&&(o.sessionId=a),this._xhr=e.ajax({url:App.getBaseUrl()+"ivideon/list-cameras/",data:o,success:function(e){var t,o=String(n.ivcamid);if(e.sessionId){var a=App.get("ivSessions");a[n.ivlogin]=e.sessionId,App.set("ivSessions",s.clone(a))}(t=s.find(e.cameras,function(e){if(-1==o.indexOf("/"))return e.id==o;var s=o.split("/");return e.server.id==s[0]&&e.id==s[1]}))?t.server.live&&t.services.enabled?(i.set({sessionId:e.sessionId,camera:t}),r.resolve(t)):r.reject(i.getTexts().errCameraNotOnlineOrNotPaid):r.reject(i.getTexts().errCameraNotAvailable)},error:function(){r.reject(i.getTexts().errCamerasListLoad)},complete:function(){i.set("loading",!1)}}),r},loadArchive:function(s,i,t){var r=this.get("camera"),n=new e.Deferred;return e.ajax({url:a+"/archive/"+(t?"days":"list"),data:{sessionId:this.get("sessionId"),server:r.server.id,camera:r.id,startTime:s,endTime:i},cache:!1,dataType:"jsonp",jsonp:"jsonp",type:"get",processData:!0,beforeSend:function(){},success:function(e){var s;s=t?c.parseDays(e):c.parseRanges(e),n.resolve(s)},error:function(){n.reject(arguments[0])}}),n},getLiveUrl:function(){var e=this.get("sessionId"),s=this.get("camera");return a+"/flv/live?sessionId="+e+"&server="+s.server.id+"&camera="+s.id+"&q=2"+"&vcodec=h264&vcodec=flv"},getArchiveUrl:function(e,s){var i=this.get("sessionId"),t=this.get("camera"),r=e,n=r+(s.duration||36e5);return a+"/flv/archive?sessionId="+i+"&server="+t.server.id+"&camera="+t.id+"&q="+(s.quality||(s.speed>1?1:2))+"&speed="+(s.speed||1)+"&startTime="+r+"&endTime="+n+"&vcodec=h264&vcodec=flv"+"&_="+Math.random()},destroy:function(){this.stopListening(),this._xhr&&(this._xhr.abort(),this._xhr=null),this.trigger("destroy"),this._view=null},getTexts:function(){return o}}),c={parseRanges:function(e){for(var s,i,t=[],r=0,n=e.length;n>r;++r)s=e[r].startTime,i=s+e[r].duration,t.push([s,i]);return t},parseDays:function(e){for(var s={},i=e.length;i--;)s[1e3*e[i].date]=1;return s}};return d});