define(["jquery","_libs/video-player/mp4-stream-client-1.0.2","_libs/video-player/player.bundle-1.3.0","./SourceProvider","./constants","./utils"],function(e,t,n,i,r,a){function s(e){this._baseUrl=e}function o(e){return new s(e)}function c(e){var t=/^(\d{1,2})\-(\d{1,2})/.exec(e);return t?[Number(t[1]),Number(t[2])]:null}function u(e,t,n){return{uuid:e,year:t.getFullYear(),month:t.getMonth()+1,day:t.getDate(),hour:t.getHours(),timezoneId:n}}function h(e,t,n){var i=a.getDateParts(new Date(t)),r=i.year,s=a.pad(i.month),o=a.pad(i.day),c=a.pad(i.hour),u=a.pad(i.minute),h=a.pad(i.second);return"/files/arc/"+r+"/"+s+"/"+o+"/"+e.replace(/-/g,"")+"/"+c+"/"+u+"-"+h+"."+n}function f(e){var t=new Date;return["getFullYear","getMonth","getDate"].every(function(n){return e[n]()===t[n]()})}var d=n.Player;e.extend(s.prototype,{url:function(e){var t=e&&"/"!==e?"/"===e.substr(0,1)?e:"/"+e:"";return this._baseUrl+t},get:function(t){return e.ajax({url:this.url(t),method:"GET",beforeSend:function(){}})},postJson:function(t,n){return new Promise(function(i,r){e.ajax({url:this.url(t),method:"POST",data:JSON.stringify(n.data),beforeSend:function(){}}).done(i).fail(r)}.bind(this))}});var l=i.extend({constructor:function(){this._cache={},this._client=null,this._mp4StreamClient=null,this._mse=null,this._mseUrl="",this._curCameraNumber=-1,this._curRequiredStartTs=-1,i.apply(this,arguments)},CHANNEL_RANGE_SERIES_UPDATE:"rangeSeriesUpdate",defaults:{cameras:[],debug:!0,mediaServerUrl:"",checkerPeriod:1e4,isRitmDevice:null},initialize:function(){var e=this.get("mediaServerUrl");e="/"===e.substr(-1)?e.slice(0,-1):e,this.set("mediaServerUrl",e),this._client=o(e),this.listenTo(this.getDeviceConnector(),"test:event",function(){console.log("MSP handler of deviceConnector test:event")}),i.prototype.initialize.apply(this,arguments)},hasOption:function(e){return this.has(e)},getOption:function(e){return this.get(e)},getDeviceConnector:function(){return this.getOption("deviceConnector")},getSource:function(e,t){return this._curCameraNumber=e,this._curRequiredStartTs=t,new Promise(function(n,i){this.connectAndCheckCamera(e,t).then(function(s){var o=this.findCamera(e);if(o){var c=o.uuid;if(t>0){var u=new Date(t);this.getRangeSeries(e,[u]).then(function(s){for(var o,u,f=0;f<s.length&&(o=s[f],!(u=a.findRangeByStartTs(t,o.ranges[0])));++f);if(u)if(this.debug("Found range for "+new Date(t)+" in serie "+o.id+", "+JSON.stringify(u)),o.id===r.SERIE_ID_SERVER){var l=h(c,u[0],"mp4"),_=this._client.url(l);this.debug("Url for range "+_+", resolve with it as location"),n({location:_,realStartTs:u[0]})}else if(o.id===r.SERIE_ID_PROCESSING)i({error:r.ERR_ARCHIVE_FILE_TRANSMITTING,data:{hideMedia:!0,startTs:t,cameraNumber:e}});else{var g=t,E=59e3;t-u[0]<E?g=u[0]:u[1]-t<E&&(g=Math.max(u[0],u[1]-E));var S=Math.min(u[1],g+E),v=[g,S];this.getDeviceConnector().startFileTransmission(c,v).then(function(){var t=new Date(a.getDayStart(g)),n=a.rangesCacheKey(e,r.SERIE_ID_PROCESSING,t),s=this.addRangeToCache(n,v);this.notify(this.CHANNEL_RANGE_SERIES_UPDATE,{date:t,series:[{id:r.SERIE_ID_PROCESSING,ranges:s}]}),i({error:r.ERR_ARCHIVE_FILE_NEEDS_TRANSMISSION,data:{hideMedia:!0,startTs:g,cameraNumber:e}})}.bind(this),function(){i({error:r.ERR_ARCHIVE_FILE_TRANSMISSION_FAIL})})}else console.error("Can not find range for "+new Date(t)),i({error:d.ERR_STREAM_NOT_FOUND})}.bind(this))}else{this.debug("Set isRitmDevice to "+s.isClient);var f=s.isClient;this.set("isRitmDevice",f);var l=s.isAlive;l?(this._mse=this._createMediaSource(c),this._mseUrl=window.URL.createObjectURL(this._mse),n({location:this._mseUrl}),f&&this.getDeviceConnector().startOnlineOnDevice(c,!1)):f?(this.getDeviceConnector().startOnlineOnDevice(c,!0),i({error:r.ERR_CAMERA_STARTING,data:{hideMedia:!0}})):i({error:d.ERR_CAMERA_OFFLINE,data:{hideMedia:!0}})}}else i({error:d.ERR_STREAM_NOT_FOUND,data:{hideMedia:!0}})}.bind(this))}.bind(this))},getPreviewImageUrl:function(e,t){var n=Date.now();if(t>=n||t<this.getMinTime())return null;var i=new Date(t),s=a.rangesCacheKey(e,r.SERIE_ID_SERVER,i),o=this.findInCache(s);if(o){var c=this.findCamera(e),u=c.uuid,f=a.findRangeByStartTs(t,o);if(f){var d=h(u,f[0],"jpg");return this._client.url(d)}}return null},checkFilesAppearance:function(e){var t=this,n=this._cache,i=this.findCameraUuid(e),s=["r",a.pad(e),r.SERIE_ID_PROCESSING].join(":"),o=this.makeDebug("#4d4d80","checkFilesAppearance"),h=Object.keys(n).filter(function(e){return e.indexOf(s)>-1});return new Promise(function(n){function s(i,s){if(g.push({key:i,files:s}),g.length>=_.length){var u=[],h=[];o("Files are ready to check, arrHoursData: "+JSON.stringify(g)),g.forEach(function(n){var i=new Date(n.key),s=i.getTime(),o=a.rangesCacheKey(e,r.SERIE_ID_SERVER,i),f=t.findInCache(o)||[];n.files.forEach(function(e){var t=c(e);if(t){var n=s+6e4*t[0]+1e3*t[1],i=n+6e4,r=[n,i];u.push(r),f.findIndex(function(e){return e[0]===n})<0&&h.push(r)}})});var d=t._findCoveredRanges(f,u);d.length&&t._handleRangesProcessed(e,d),o("New files for camera "+e+": "+JSON.stringify(h)),h.length&&t._handleRangesAppeared(e,h),n(u)}}var f=[];h.forEach(function(e){var n=t.findInCache(e);f=f.concat(n)}.bind(this)),f.length||n([]);var d=t.getOption("timezoneId"),l={};f.forEach(function(e){var t=e[0],n=e[1],r=new Date(a.getHourStart(t-6e4)),s=new Date(a.getHourStart(t)),o=new Date(a.getHourStart(n));if(r.getHours()!==s.getHours()){var c=r.toString(),h=l[c]=l[c]||{hour:r,ranges:[],requestParams:u(i,r,d)};h.ranges.push(e)}var f=s.toString(),_=l[f]=l[f]||{hour:s,ranges:[],requestParams:u(i,s,d)};if(_.ranges.push(e),o.getHours()!==s.getHours()){var g=o.toString(),E=l[g]=l[g]||{hour:s,ranges:[],requestParams:u(i,o,d)};E.ranges.push(e)}});var _=Object.keys(l),g=[];_.forEach(function(e){t._fetchMediaServerArchiveData(l[e].requestParams).then(function(t){s(e,t.files)},function(){s(e,[])})})})},_findCoveredRanges:function(e,t){var n=[];return e.forEach(function(e){var i=e[0],r=e[1],a=t.filter(function(e){e[0];var t=e[1];return r>t&&t>i});a.length&&n.push(e)}),n},removeProcessingPeriod:function(e,t){var n=new Date(a.getDayStart(t)),i=a.rangesCacheKey(e,r.SERIE_ID_PROCESSING,n),s=(this.findInCache(i)||[]).filter(function(e){return e[0]!==t});this._storeInCache(i,s),this._curCameraNumber===e&&this.notify(this.CHANNEL_RANGE_SERIES_UPDATE,{date:n,series:[{id:r.SERIE_ID_PROCESSING,ranges:s}]})},_handleRangesProcessed:function(e,t){var n=this;t.forEach(function(t){n.removeProcessingPeriod(e,t[0])})},_handleRangesAppeared:function(e,t){var n=this;t.forEach(function(t){var i=new Date(a.getDayStart(t[0])),s=a.rangesCacheKey(e,r.SERIE_ID_SERVER,i),o=n.addRangeToCache(s,t);n._curCameraNumber===e&&n.notify(n.CHANNEL_RANGE_SERIES_UPDATE,{date:i,series:[{id:r.SERIE_ID_SERVER,ranges:o}]})})},_createMediaSource:function(e){var n=new MediaSource;return n.addEventListener("sourceopen",function(){var i,r=function(){},a=t.create({url:this._url("/fmpeg/"+e).replace("http","ws"),sdpTimeout:1e4,dataTimeout:15e3,chunkTimeout:1e4,onSdp:function(e){var t=e.media.filter(function(e){return"video"===e.type}).map(function(e){return e.mime}).join(", "),a='video/mp4; codecs="'+t+'"';i=n.addSourceBuffer(a),i.addEventListener("updateend",function(){r&&r()})}.bind(this),onData:function(e,t){if(r=t,i.updating)t();else try{i.appendBuffer(e)}catch(n){}},onStop:function(e){e!==t.CLOSE_CODE_EXTERNAL&&n.endOfStream("network")}});this._mp4StreamClient=a}.bind(this),{once:!0}),n},getUsedRangeSeries:function(){var e=[{id:r.SERIE_ID_SERVER,priority:0,color:r.SERIE_COLOR_SERVER}];return this.getOption("isRitmDevice")!==!1&&(e=e.concat([{id:r.SERIE_ID_PROCESSING,priority:5,color:r.SERIE_COLOR_PROCESSING},{id:r.SERIE_ID_DEVICE,priority:10,color:r.SERIE_COLOR_DEVICE,glued:!0}])),e},_fetchMonthIfNeeded:function(e,t,n){return new Promise(function(i){var r=a.monthCacheKey(e,t,n),s=this.findInCache(r,1/0);if(s)i(s);else{var o=this.findCameraUuid(e);this._fetchDaysFromMediaServer(o,t,n).then(function(e){this.getOption("isRitmDevice")?this.getDeviceConnector().getDeviceArchiveDays(o,t,n).then(function(t){var n=_.unique(e.concat(t)).sort();this._storeInCache(r,n),i(n)}.bind(this)):(this._storeInCache(r,e),i(e))}.bind(this),function(e){this.debug("Fetch days from media server has failed with reason: "+JSON.stringify(e)),i([])}.bind(this))}}.bind(this))},_fetchDaysFromMediaServer:function(e,t,n){return new Promise(function(i,r){this._connect().then(function(){this._fetchMediaServerArchiveData({uuid:e,year:t,month:n,timezoneId:this.getOption("timezoneId")}).then(function(e){i(e.days)},r)}.bind(this))}.bind(this))},_fetchRangesFromMediaServer:function(e,t){var n=this,i=this.findCameraUuid(e),r=a.getDateParts(t),s=r.year,o=r.month,u=r.day,h={uuid:i,year:s,month:o,day:u,timezoneId:this.getOption("timezoneId")};return new Promise(function(e){this._fetchMediaServerArchiveData(h).then(function(t){function i(t,n){if(a.push({hour:t,files:n}),a.length>=r.length){var i=[],h=new Date(s,o-1,u).getTime(),f=(new Date).getTime();a.sort(function(e,t){return e.hour-t.hour}).forEach(function(e){var t=36e5*e.hour;e.files.forEach(function(e){var n=c(e);if(n){var r=h+t+6e4*n[0]+1e3*n[1];f>r&&i.push([r,Math.min(f,r+59900)])}})}),e(i)}}var r=t.hours||[],a=[];r.length?r.forEach(function(e){!function(e){n._fetchMediaServerArchiveData(Object.assign(h,{hour:e})).then(function(t){i(e,t.files)},function(){i(e,[])})}(e)}):e([])},function(){return e([])})}.bind(this))},_fetchSerieRangesIfNeeded:function(e,t,n){var i=this,s=this.makeDebug(void 0,"Timeline: MSSP: fetchSerieRangesIfNeeded",!0);return s("Serie "+t+", and date "+n.toString()),new Promise(function(o){var c=a.rangesCacheKey(e,t,n),u=f(n)?6e4:1/0,h=i.getOption("isRitmDevice");if(h&&t===r.SERIE_ID_SERVER){var d=i.findInCache(a.rangesCacheKey(e,r.SERIE_ID_PROCESSING,n));d&&d.length&&(u=0)}else if(h===!1&&(t===r.SERIE_ID_PROCESSING||t===r.SERIE_ID_DEVICE))return o([]),void 0;var l=i.findInCache(c,u);if(l)s("Found ranges for serie "+t+" in cache by key: "+c+", resolve with them"),o(l);else if(s("Not found in cache by key: "+c+", start fetching for serie "+t),t===r.SERIE_ID_SERVER)i._fetchRangesFromMediaServer(e,n).then(function(t){if(s("Got data from MS, store in cache using key: "+c+", resolve with length"+t.length),i._storeInCache(c,t),i.getOption("isRitmDevice")){var u=i.findInCache(a.rangesCacheKey(e,r.SERIE_ID_PROCESSING,n));if(u&&u.length){var h=i._findCoveredRanges(u,t);h.length&&i._handleRangesProcessed(e,h)}i.notify(i.CHANNEL_RANGE_SERIES_UPDATE,{date:n,series:[{id:r.SERIE_ID_SERVER,ranges:t}]})}o(t)});else if(t===r.SERIE_ID_DEVICE){h=i.getOption("isRitmDevice");var _=i.findCameraUuid(e),g=i.getDeviceConnector(),E=function(e){s("Got result with ranges: "+JSON.stringify(e)),i._storeInCache(c,e),o(e)};h?g.getDeviceArchiveRanges(_,n).then(E):null===h&&(s("We still do not know real isRitmDevice value, make listener"),i.once("change:isRitmDevice",function(e,t){t?(s("change:isRitmDevice handler, isRitmDevice == true, call getDeviceArchiveRanges"),g.getDeviceArchiveRanges(_,n).then(E)):o([])}))}else o([])})},_fetchMediaServerArchiveData:function(e){return this._client.postJson("/archive",{data:e})},_connect:function(){return Promise.resolve()},_checkCamera:function(e){return new Promise(function(t){var n=this.findCameraUuid(e);this._client.get("/live/"+n).then(t,function(){t({isAlive:!1,isClient:!1})})}.bind(this))},connectAndCheckCamera:function(e,t){return this._connect().then(function(){return t?Promise.resolve():this._checkCamera(e)}.bind(this))},_storeInCache:function(e,t){this._cache[e]={data:t,ts:(new Date).getTime()}},findInCache:function(e,t){if(e in this._cache){t="undefined"==typeof t?1/0:t;var n=this._cache[e];if((new Date).getTime()-n.ts<t)return n.data}return null},addRangeToCache:function(e,t){var n=this.findInCache(e)||[],i=n?n.slice(0):[];return i.findIndex(function(e){return e[0]===t[0]})<0&&(i.push(t),i=i.sort(function(e,t){return e[0]-t[0]}),this._storeInCache(e,i)),i},findCameraUuid:function(e){var t=this.findCamera(e)||{};return t.uuid||"nocamerauuid"+e},findCamera:function(e){return this.get("cameras").find(function(t){return null!==t&&t.num===e})},_url:function(e){return this.get("mediaServerUrl")+e},pause:function(){this.stop()},stop:function(e){e!==this._mseUrl&&this._mp4StreamClient&&this._mp4StreamClient.connected&&(this._mp4StreamClient.stop(t.CLOSE_CODE_EXTERNAL),this._mp4StreamClient=null)},debug:function(e){this.getOption("debug")&&console.log("%c"+a.pnow()+": MSSP: "+String(e),"color: #00818C")}});return l});