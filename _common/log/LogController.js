var PRODUCTION=!0;define("_common/log/LogDevicesCollection",["abstracts/Collection"],function(e){var t=e.extend({constructor:function(){e.apply(this,arguments)}});return t}),define("text!_common/log/tmpl/log.html",[],function(){return'<div class="module-header box-header append">\n    <h2><%= i18n.alertsLog %></h2>\n\n    <div class="module-settings add-on">\n        <a class="btn-settings hint hint-left" href="#"\n           data-hint="<%= i18n.alertsLogFilters %>">\n            <i class="svg-icon svg-icon-cog"></i>\n        </a>\n    </div><div class="add-on">\n        <!--<a class="btn btn-small btn-play-pause" href="#">-->\n        <a class="btn-play-pause hint hint-left" href="#"\n           data-hintstop="<%= i18n.stopAlertsLog %>"\n           data-hintresume="<%= i18n.resumeAlertsLog %>">\n            <i class="svg-icon svg-icon-stop icon-stop"></i>\n            <i class="svg-icon svg-icon-play icon-play"></i>\n        </a>\n    </div><div class="add-on filters form-search">\n        <!--<div class="filters">-->\n            <input type="text" name="q" value="" class="filter" placeholder="<%= i18n.objIdNumber %>">\n            <i class="icon-clear svg-icon svg-icon-circle-remove"></i>\n        <!--</div>-->\n    </div>\n    <!--<a class="btn btn-small btn-play-pause" href="#">\n        <i class="svg-icon svg-icon-stop icon-stop"></i>\n        <i class="svg-icon svg-icon-play icon-play"></i>\n    </a>-->\n</div>\n<div class="module-content history">\n    <div class="grid-content selectable">\n        <table>\n            <thead>\n                <th><div class="th"><%= i18n.timeOfCreation %></div></th>\n                <th><div class="th"><%= i18n.timeOfReceive %></div></th>\n                <th><div class="th"><%= i18n.objIdNumber %></div></th>\n                <th><div class="th"><%= i18n.objTitle %></div></th>\n                <th><div class="th"><%= i18n.alertCode %></div></th>\n                <th><div class="th"><%= i18n.alert.ucFirst() %></div></th>\n                <th><div class="th"><%= i18n.alertsGroup %></div></th>\n                <th><div class="th"><%= i18n.objArea %></div></th>\n                <th><div class="th"><%= i18n.objZoneKey %></div></th>\n                <th><div class="th"><%= i18n.inputStream %></div></th>\n            </thead>\n            <tbody></tbody>\n        </table>\n    </div><!--/grid-content-->\n</div>\n'}),define("text!_common/log/tmpl/logFilters.html",[],function(){return'<label><%= i18n.objects.ucFirst() %></label>\n<div class="control-group devices">\n    <div class="controls">\n        <select name="devices"\n                data-placeholder="<%= i18n.allObjects %>"\n                class="input-block-level"\n                multiple>\n        </select>\n    </div>\n</div>\n\n<label><%= i18n.alerts.ucFirst() %></label>\n<div class="row-fluid row-alerts">\n    <div class="alert-groups control-group span6">\n        <select name="alertGroups"\n                data-placeholder="<%= i18n.allAlertsGroups %>"\n                class="input-block-level"\n                multiple>\n        </select>\n    </div><div class="alerts control-group span6">\n        <select name="alerts"\n                data-placeholder="<%= i18n.allAlertsOffSelectedGroups %>"\n                class="input-block-level"\n                multiple>\n        </select>\n    </div>\n</div>\n\n'}),define("_common/log/views/LogView",["jquery","underscore","abstracts/View","jface","jqueryui","datatables","text!../tmpl/log.html","text!../tmpl/logFilters.html","css!../css/log.css","css!_libs/grids/DataTables/css/jquery.dataTables.cropped.css","css!_libs/grids/DataTables/extensions/Scroller/css/dataTables.scroller.min.css","datatables-scroller","colresize"],function(e,t,i,n,l,s,a,r){a=t.template(a),r=t.template(r),e.fn.dataTable.Api.register("sortDraw()",function(){return this.iterator("table",function(t){t.oFeatures.bSort=!0;var i=new e.fn.dataTable.Api(t);s.ext.internal._fnLengthOverflow(t),i.draw(!0)})}),e.fn.dataTable.Api.register("removeLast()",function(t){return this.iterator("table",function(i){for(var n,l=s.ext.internal,a=i.aiDisplayMaster,r=i.aoData,o=a.length,c=a.slice(-t),u=0,d=0,h=0,f=c.length;f>h;++h)u=c[h],n=r[u],d=o-h-1,r.splice(u,1),l._fnDeleteIndex(a,d),l._fnDeleteIndex(i.aiDisplay,d),n.nTr&&d>i._iDisplayStart+i._iDisplayLength&&e(n.nTr).remove()})}),e.fn.dataTable.Api.register("row.prependAlertRow()",function(t){var i=this.iterator("table",function(i){var n=s.ext.internal,l=i.aoData.length,a=i.oPreviousSearch,r=!0,o=e.extend(!0,{},s.models.oRow,{src:"data",_aData:t});if(i.aoData.push(o),a.sSearch){var c=n._fnFilterCreateSearch(a.sSearch,a.bRegex,a.bSmart,!1);c.test(" "+t.extId+" ")||(r=!1)}if(i.aiDisplayMaster.unshift(l),r&&(i.aiDisplay.unshift(l),n._fnLengthOverflow(i),0==i._iDisplayStart)){n._fnCreateTr(i,l);var u=e(i.nTBody),d=i.fnDisplayEnd();u.prepend(o.nTr);var h=u.find("tr[role=row]");h.length>d&&h.last().remove()}});return this.row(i[0])}),e.fn.ajaxChosen=function(t,i,n){var l,s,a,r,o={};return t=t||{},n=n||{},s={minTermLength:2,afterTypeDelay:200,jsonTermKey:"q",keepTypingMsg:"Keep typing...",lookingForMsg:"Looking for"},r=this,l=null,a=e.extend({},s,t),this.chosen(n?n:{}),this.each(function(){return e(this).next(".chosen-container").find(".search-field > input, .chosen-search > input").on("keyup",function(){var t,n,s,c=e(this),u={};if(n=c.val(),s=e.trim(n),t=s.length<a.minTermLength?a.keepTypingMsg:a.lookingForMsg+(" '"+s+"'"),c.next(".chzn-container").find(".no-results").text(t),s===c.data("prevVal"))return!1;if(c.data("prevVal",s),c.data("timer")&&clearTimeout(c.data("timer")),s.length<a.minTermLength)return!1;if(u.url=a.url||"",u.data=a.data||{},u.data[a.jsonTermKey]=s,u.success=function(t){var l,a,u;if(null!=t)return o[s]=t,u=[],r.find("option").each(function(){return e(this).is(":selected")?u.push(e(this).val()+"-"+e(this).text()):e(this).remove()}),l=null!=i?i(t,c):t,a=0,e.each(l,function(t,i){var n="",l="";return a++,"string"==typeof i?(l=t,n=i):(l=i.value,n=i.text),-1===e.inArray(l+"-"+n,u)?e('<option value="'+l+'">'+n+"</option>").appendTo(r):void 0}),a?r.trigger("chosen:updated"):(r.data().chosen.no_results_clear(),r.data().chosen.no_results(s)),c.val(n)},s in o)return u.success(o[s]),void 0;var d=setTimeout(function(){return l&&l.abort(),l=e.ajax(u)},a.afterTypeDelay);c.data("timer",d)})})};var o=new Date(2e3,0,1).getTime(),c="d.m.Y H:i:s",u=i.extend({id:"alerts-log",constructor:function(){this.controller=null,this._loadingTimeout=null,this._loading=!1,this._grid=null,this.$cont=null,this.$table=null,this.$filters=null,this.$search=null,this.$btnPlayPause=null,this._popup=null,this.$devicesSelect=null,this.$alertGroupsSelect=null,this.$alertsSelect=null,this._count=0,this._eventsPrefix=".alertslog",this._searchTimeout=null,i.apply(this,arguments)},initialize:function(e){this.controller=e.controller,this.controller.get("paused")&&this.pause(),this.render(),d.bindEvents.call(this)},render:function(){var e=this;this.$cont=App.getView().$el.find(".pane-right-bottom"),this.$el.appendTo(this.$cont),this.$el.html(a({i18n:this.controller.getTexts()})).addClass("loading"),this.$filters=this.$el.find(".filters"),this.$search=this.$filters.find(".filter"),this.$btnPlayPause=this.$el.find(".btn-play-pause"),this.controller.loadAlertsAndGroups().always(function(){d.buildList.call(e),e.$el.removeClass("loading"),e.$el.find(".btn-settings").on("click",function(){d.openSettings.call(e)}),d.initSearch.call(e)})},pause:function(){this.$el.addClass("paused")},resume:function(){d.clearList.call(this),this.$el.removeClass("paused")},remove:function(){e(window).off(this._eventsPrefix),this.$table&&this.$table.DataTable().destroy(),this._popup&&this._popup.trigger("jw.close"),i.prototype.remove.apply(this,arguments)}}),d={bindEvents:function(){var t=this,i=this.controller;this.listenTo(i,"change:paused",function(e,i){t[i?"pause":"resume"]()}).listenTo(i,"change:filter change:depth",function(){d.clearList.call(t)}).listenTo(i,"destroy",function(){t.remove()}),this.$btnPlayPause.on("click",function(){i.set("paused",!i.get("paused"))}),this.$cont.on("toggle",function(e,i){i||setTimeout(function(){d.adjustGridSize.call(t)},50)}),this.$el.on("dblclick","tr[data-objectid]",function(){App.trigger("needdevicehistory",{id:e(this).data("objectid"),objType:e(this).data("objecttype")})}),e(window).on("resizestop"+this._eventsPrefix,function(e){if(t.$table){var i=e.srcElement||e.currentTarget;(i=window)&&setTimeout(function(){d.adjustGridSize.call(t)},100)}})},adjustGridSize:function(){if(this._grid&&!this.$cont.hasClass("closed")){var e=d.getGridScrollHeight.call(this);this._grid.fnSettings().oScroll.sY=e,this.$el.find(".dataTables_scrollBody").height(e),this._grid.fnAdjustColumnSizing()}},buildList:function(){var e=this;this.$table=this.$el.find("table"),d.buildAlertsGrid.call(e),d.bindListEvents.call(e)},buildAlertsGrid:function(){var t=this,i=this.$table,n={data:[],columns:d.getColumns.call(this),createdRow:function(t,i){var n=e(t);n.attr("data-id",i.alertId).attr("data-objectid",i.objectId).attr("data-objecttype","area"in i?App.TYPE_STAT:App.TYPE_MOBILE),"undefined"!=typeof i.fgColor&&n.css("color",i.fgColor),"undefined"!=typeof i.bgColor&&n.css("background",i.bgColor)},ordering:!1,order:[[1,"desc"]],searching:!0,scroller:{loadingIndicator:!1},info:!1,deferRender:!1,dom:"rtS",scrollCollapse:!1,scrollY:200,language:{zeroRecords:"--"}};this._grid=i.dataTable(n),d.initColResize.call(this,i),setTimeout(function(){d.adjustGridSize.call(t)},100)},getColumns:function(){var e=this.controller.getTexts(),t=this.controller.getUserData("colWidth")||{},i=[{data:function(t,i,n){return n=t.alertTs,n>o?Date.format(c,n):e.noData},searchable:!1,key:"alertTs",width:t.alertTs||"8%"},{data:function(e){return Date.format(c,e.receivedAt)},searchable:!1,key:"receivedAt",width:t.receivedAt||"8%"},{searchable:!0,key:"extId",data:"extId",width:t.extId||"7%"},{searchable:!1,key:"objTitle",data:"objTitle",width:t.objTitle||"14%"},{searchable:!1,key:"code",data:"code",width:t.code||"7%"},{searchable:!1,key:"messageText",data:"messageText",width:t.messageText||"25%"},{searchable:!1,key:"group",data:"group",width:t.group||"8%"},{key:"area",searchable:!1,data:function(e){var t="-";return"area"in e&&(t=e.area),t},width:t.area||"7%"},{key:"zone",searchable:!1,data:function(e){var t="-";return"areaZone"in e&&(t=e.areaZone),t},width:t.zone||"6%"},{key:"channelName",searchable:!1,data:function(e){var t="-";return"channelName"in e&&(t=e.channelName),t},width:t.channelName||"10%"}];return i},initColResize:function(e){var i=this,n=e.closest(".grid-content"),l=e.DataTable();n.colresize({selector:".dataTables_scrollHead th"});var s=n.find(".dataTables_scrollHead th");n.on("stop.colresize",function(e,a){var r=a.index,o=l.settings()[0],c=o.aoColumns,u=parseInt(c[r].sWidth),d=a.delta,h=t.reduce(t.pluck(o.aoColumns,"sWidth"),function(e,t){return e+parseFloat(t)},0),f=100*(u+d)/h,p=100*(parseInt(c[r+1].sWidth)-d)/h,g={};g[r]=f+"%",g[r+1]=p+"%",l.columns().setWidth(g),h=n.width();var v={};s.each(function(e){c[e]&&c[e].key&&(f=100*this.offsetWidth/h,v[c[e].key]=f+"%")}),i.controller.setUserData("colWidth",v)})},bindListEvents:function(){this.listenTo(App,"newalerts",t.bind(d.onReceive,this))},onReceive:function(e){if(this.$table&&e.length&&!this.controller.get("paused")){e=e.slice(0);var t,i,n,l=this.controller,s=l.get("depth"),a=this.$table.DataTable(),r=this._count+e.length-s;r>0&&a.removeLast(r);for(var o=0,c=e.length;c>o;o++)n=e[o],l.alertMatchFilter(n)&&(t=App.getDevice(n.objectId),t&&(n.extId=t.get("extId"),n.objTitle=App.buildObjTitle(t),n.code=n.code||"",i=l.getGroupByCode(n.code),n.group=i?i.name:"Unknown",a.row.prependAlertRow(n),this._count++));r>0&&(this._count=s)}},openSettings:function(){var t=this,i=this.controller,l=i.getTexts();n.showOverlay(),n.window.open({winId:"win-log-filters",addForm:'<form method="post" action=""></form>',headerHtml:l.alertsLogFilters,contentHtml:r({i18n:l}),footerHtml:'<button type="submit" class="btn btn-primary btn-save">'+l.save+"</button>"+'<a href="javascript:;" class="btn jw-close">'+l.cancel.ucFirst()+"</a>",initY:100,initX:e(window).width()/2-300,dieAfter:0,resizable:!1,width:600,openCallback:function(){t._popup=this},showCallback:function(){this.find("form").on("submit",function(){return d.saveFilters.call(t),t._popup.trigger("jw.close"),!1}),d.initMultiSelects.call(t)},closeCallback:function(){t.$devicesSelect=null,t.$alertGroupsSelect=null,t.$alertsSelect=null,n.hideOverlay()}})},saveFilters:function(){var e=this._popup.find("form"),t=d.serializeForm.call(this,e);this.controller.setFilterValues(t)},serializeForm:function(){var e={},t=0,i=0;e.device=[],e.group=[],e.code=[];var n=d.getSelectValues(this.$devicesSelect);for(t=0,i=n.length;i>t;++t)e.device.push(n[t]);for(n=d.getSelectValues(this.$alertGroupsSelect),t=0,i=n.length;i>t;++t)e.group.push(n[t]);for(n=d.getSelectValues(this.$alertsSelect),t=0,i=n.length;i>t;++t)e.code.push(n[t]);return e},getSelectValues:function(e){var i=e.val()||[];return t.map(i,function(e){return Number(e)})},initFiltersForm:function(){var t=new e.Deferred;return t},initMultiSelects:function(){var e=this,i=this._popup,n=this.controller.getTexts(),l=this.controller.get("filterValues"),s=t.keys(l.group||{});this.$devicesSelect=i.find("select[name=devices]"),this.$alertGroupsSelect=i.find("select[name=alertGroups]"),this.$alertsSelect=i.find("select[name=alerts]"),d.buildDevices.call(this),d.buildAlertGroups.call(this),d.buildAlerts.call(this,d.filterAlerts.call(e,t.map(s,function(e){return parseInt(e)}))),i.find(".row-alerts select").chosen({disable_search:!1,disable_search_threshold:10,no_results_text:n.searchNoResults}),i.find("select[name=devices]").ajaxChosen({url:App.getBaseUrl()+"objects/obj-search/"},function(e){var i=[];return t.each(e,function(e){i.push({value:e.id,text:"#"+e.extId+" "+App.buildObjTitle(e)})}),i},{disable_search:!1,no_results_text:n.searchNoResults}),this.$alertGroupsSelect.on("change",function(){var t=d.getSelectValues(e.$alertGroupsSelect);d.buildAlerts.call(e,d.filterAlerts.call(e,t)),e.$alertsSelect.trigger("chosen:updated")})},filterAlerts:function(e){var i=t.values(this.controller.getAlerts());if(!e.length)return i;var n=t.filter(i,function(i){return-1!=t.indexOf(e,i.groupId)});return n},buildDevices:function(){var e,i="",n=this.controller.get("filterValues"),l=n.device||{};t.each(l,function(n,l){(e=App.getDevice(l))&&(i+='<option value="'+l+'" selected>#'+e.get("extId")+" "+t.escape(App.buildObjTitle(e))+"</option>")}),this.$devicesSelect.html(i)},buildAlertGroups:function(){var e="",i=this.controller.getGroups(),n=this.controller.get("filterValues"),l=n.group||{};t.each(i,function(t){e+='<option value="'+t.id+'"'+(t.id in l?" selected":"")+">"+t.name+"</option>"}),this.$alertGroupsSelect.html(e)},buildAlerts:function(e){var i="",n=this.controller.get("filterValues"),l=n.code||{};t.each(e,function(e){i+='<option value="'+e.code+'"'+(e.code in l?" selected":"")+">"+d.formatCode(e.code)+" "+e.message+"</option>"}),this.$alertsSelect.html(i)},initSearch:function(){var t=this,i=this.$search;i.on("keyup",function(){var n=e.trim(i.val());t._searchTimeout&&clearTimeout(t._searchTimeout),t._searchTimeout=setTimeout(function(){d.search.call(t,n)},200)}),i.siblings(".icon-clear").on("click",function(){i.val(""),d.search.call(t,"")})},search:function(e){var t=this.$table.DataTable();e?(this.$search.addClass("active"),e="^(\\s+)?"+e+"(\\s+)?$",t.search(e,!0,!1)):(this.$search.removeClass("active"),t.search("")),t.draw()},formatCode:function(e){var t=String(e);return 4==t.length&&(t=t.substr(0,3)+"."+t.substr(3)),t},clearList:function(){if(this.$table){var e=this.$table.DataTable();e.clear(),e.draw(),this._count=0}},getGridScrollHeight:function(){return this.$el.find(".grid-content").height()-this.$el.find(".dataTables_scrollHead").outerHeight()-2}};return u}),define("_common/log/LogController",["jquery","underscore","abstracts/Module","./LogDevicesCollection","./views/LogView","i18n!_common/nls/common"],function(e,t,i,n,l,s){var a=i.extend({constructor:function(){this._data={},this._groupsByCode={},i.apply(this,arguments)},defaults:{loading:!1,paused:!1,depth:500,filter:{device:null,group:null,code:null},filterValues:{device:null,group:null,code:null}},initialize:function(){this.set("depth",this.getUserData("depth")||this.defaults.depth),this.set("filterValues",this.getUserData("filterValues")||this.defaults.filterValues),this._view=new l({controller:this})},loadAlertsAndGroups:function(){var i=this,n=new e.Deferred;return this._data.alerts&&this._data.groups?n.resolve(this._data):(e.when(e.ajax({url:App.getBaseUrl()+"alert-template-group/list/",data:"{}"}),e.ajax({url:App.getBaseUrl()+"alert-template/list/",data:"{}"})).done(function(e,l){var s=e[0],a=l[0];i._data.alerts=t.indexBy(a,"code"),i._data.groups=t.indexBy(s,"id"),n.resolve(i._data)}),n)},getGroups:function(){return this._data.groups},getAlerts:function(){return this._data.alerts},getGroupByCode:function(e){if(!e)return null;if(e in this._groupsByCode)return this._groupsByCode[e];var t=null,i=this._data.alerts[e.replace(".","")];return i&&(t=this._data.groups[i.groupId]||null),this._groupsByCode[e]=t,t},alertMatchFilter:function(e){var t=this.get("filter");for(var i in t)if(t[i]&&!t[i].call(this,e))return!1;return!0},setFilterValues:function(e){var i,n=t.clone(this.get("filter")),l=this.get("filterValues"),s=null;t.each(e,function(e,t){if(i=r["filterBy"+t.ucFirst()],e&&e.length){n[t]=i;var a=e.length;for(s={};a--;)s[e[a]]=!0}else n[t]=null;l[t]=s}),this.setUserData("filterValues",l),this.set({filterValues:l,filter:n})},loadAlertGroups:function(){var i=this,n=new e.Deferred;return e.ajax({url:App.getBaseUrl()+"alert-template-group/list/",data:"{}"}).done(function(e){i.groupsById=t.indexBy(e,"id"),n.resolve()}).fail(function(){n.reject()}),n},destroy:function(){this.stopListening(),this.trigger("destroy"),this._view=null},getTexts:function(){return s}}),r={filterByDevice:function(e){return e.objectId?e.objectId in this.get("filterValues").device:!1},filterByGroup:function(e){var t,i=this.get("filterValues").group;return(t=this.getGroupByCode(e.code||""))?t.id in i:!1},filterByCode:function(e){return e.code?e.code.replace(".","")in this.get("filterValues").code:!1}};return a});