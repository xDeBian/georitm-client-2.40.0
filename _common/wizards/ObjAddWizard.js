define(["jquery","abstracts/Module","abstracts/Model","_common/wizards/views/ObjAddView","i18n!_common/nls/common","i18n!_common/wizards/nls/objAdd"],function(e,t,r,u,n,i){var s=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i,o=t.extend({constructor:function(){this._xhr=null,this._groups=null,this._groupsXhr=null,t.apply(this,arguments)},defaults:{step:1,addAndSetup:!0,addToAccount:!0,deviceFound:null,setupError:!1,complete:!1,IMEI:"",objType:0,name:"",groupId:0,groupName:"",newGroupName:"",email:""},initialize:function(){this._i18n=e.extend({},n,i);var t=App.getUsername();s.test(t)&&this.set("email",t);var r=this;this.on("change:addAndSetup",function(){r.set({deviceFound:null,setupError:!1},{silent:!0})}).on("change:IMEI",function(){r.previous("IMEI")&&(r.set({deviceFound:null,setupError:!1}),r._groups=null)}).on("change:objType",function(){r._groupsXhr&&r._groupsXhr.abort(),r._groups=null,r.set({groupId:0,groupName:""})}),this._view=new u({model:this})},processStep:function(t){var r,u=this,n=new e.Deferred,i=!1;if(r=a.validate.call(this,t))return n.reject(r);if("IMEI"in t)this.set("IMEI",t.IMEI),i=!0;else if("findDevice"in t)this.get("deviceFound")&&(i=!0),this.set("setupError",!1),a.findByIMEI.call(this,this.get("IMEI")).done(function(e){u.set({deviceFound:e,objType:"deviceType"in e?e.deviceType:e.objType}),n.resolve()}).fail(function(){u.set("setupError",!0),u.set("deviceFound",!1),setTimeout(function(){n.reject()},300)});else if("addToAccount"in t){var s=1==t.addToAccount;this.set("addToAccount",s),s?i=!0:(App.trigger("devicesetup",this.get("deviceFound")),this.destroy())}else"name"in t&&("groupId"in t||"groupName"in t||"newGroupName"in t)?(this.set({name:t.name,groupId:parseInt(t.groupId||0),groupName:t.groupName||"",newGroupName:t.newGroupName||""}),this.get("addAndSetup")?a.createObject.call(this).done(function(){u.set("complete",!0),n.resolve()}).fail(function(e){n.reject(e)}):i=!0):"email"in t?(this.set("email",t.email),a.createObject.call(this).done(function(){u.set("complete",!0),n.resolve()}).fail(function(e){n.reject(e)})):i=!0;return i&&n.resolve(),n},destroy:function(e){this._xhr&&this._xhr.abort(),this._groupsXhr&&this._groupsXhr.abort(),this.trigger("destroy",e||!1)},stop:function(){this._xhr&&this._xhr.abort()},getGroups:function(){var t=this,r=new e.Deferred;if(this._groups)return setTimeout(function(){r.resolve(t._groups)},350),r;var u=[],n=App.getAllDevicesGroups(this.get("objType"));return n&&n.each(function(e){u.push(e.pick("id","name"))}),t._groups=u,setTimeout(function(){r.resolve(u)},350),r},getTexts:function(){return this._i18n}}),a={validate:function(e){var t=this.get("step"),r=[];if(1==t)return null;var u=this.getTexts();if(this.get("addAndSetup"))switch(t){case 2:"IMEI"in e&&/[\d]{1,16}/gi.test(e.IMEI)||r.push({key:"IMEI",msg:u.errImei});break;case 5:var n;(n=a.validateNameAndGroup.call(this,e))&&(r=r.concat(n))}else switch(t){case 3:var n;(n=a.validateNameAndGroup.call(this,e))&&(r=r.concat(n));break;case 4:"email"in e&&s.test(e.email)||r.push({key:"email",msg:u.errEmail})}return r.length?r:null},validateNameAndGroup:function(t){var r=this.getTexts(),u=[];if("groupId"in t&&"groupName"in t||"newGroupName"in t)if("groupId"in t&&t.groupId>0){var n=_.findWhere(this._groups,{name:t.groupName});t.groupId=n?n.id:0}else"newGroupName"in t?t.newGroupName=e.trim(t.newGroupName):t.groupName&&(t.newGroupName=e.trim(t.groupName));return"name"in t&&e.trim(t.name).length||u.push({key:"name",msg:r.errName}),this._groups.length&&"groupId"in t&&!t.groupId&&!t.groupName?u.push({key:"groupName"in t?"groupName":"groupId",msg:r.errGroup}):"newGroupName"in t&&!t.newGroupName.length&&u.push({key:"newGroupName",msg:r.errEnterGroupName}),u.length?u:null},findByIMEI:function(t){return this._xhr=e.ajax({url:App.getBaseUrl()+"devices/find-unregistered/",data:{imei:t},timeout:6e5}),this._xhr},createObject:function(){var t=this,r=new e.Deferred;return this.get("groupId")?a.save.call(this):(this._xhr=e.ajax({url:App.getBaseUrl()+"objs-groups/create/",data:{groupType:this.get("objType"),name:this.get("newGroupName"),parentId:null},success:function(e){t.set("groupId",e.id),a.save.apply(t).done(function(e){r.resolve(e)}).fail(function(){r.reject()})},error:function(e){a.showAjaxError.call(t,e,t.getTexts().errCanNotCreateGroup),r.reject()}}),r)},save:function(){var t=this,r=this.get("IMEI"),u={name:this.get("name"),objType:this.get("objType"),objsGroupsIds:[this.get("groupId")],firmware:this.get("deviceFound").firmware};return r?u.imei=r:u.email=this.get("email"),this._xhr=e.ajax({url:App.getBaseUrl()+"objects/create/",data:u,success:function(e){t.trigger("objectadded",_.extend(u,e))},error:function(e){a.showAjaxError.call(t,e,t.getTexts().errCanNotCreateObject)}}),this._xhr},showAjaxError:function(t,r){try{var u=e.parseJSON(t.responseText);alert(u.msg,u.hdr)}catch(n){alert(r,this.getTexts().error)}}};return o});