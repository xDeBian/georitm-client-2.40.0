define(["jquery","underscore","jqueryui","jface","abstracts/View","text!_common/wizards/tmpl/wizard.html","text!_common/wizards/tmpl/objAddFooter.html","text!_common/wizards/tmpl/objAddPage.html","text!_common/wizards/tmpl/objAddStart.html","text!_common/wizards/tmpl/objAddImei.html","text!_common/wizards/tmpl/objAddFound.html","text!_common/wizards/tmpl/objAddNameAndGroup.html","text!_common/wizards/tmpl/objAddObjType.html","text!_common/wizards/tmpl/objAddEmail.html","css!_common/wizards/css/wizards.css"],function(e,t,n,i,o,a,d,s,r,c,l,m,p,u){a=t.template(a),d=t.template(d),s=t.template(s),r=t.template(r),c=t.template(c),l=t.template(l),m=t.template(m),p=t.template(p),u=t.template(u);var h=t.template('<p><%= i18n.switchOnHelp1 %></p><p><%= i18n.switchOnHelp2 %></p><p><%= i18n.switchOnHelp3 %></p><input class="hidden" name="findDevice" value="1">'),f=t.template("<p><%= i18n.deviceNotFound1 %></p><p><%= i18n.deviceNotFound2 %></p>"),g=t.template("<p><%= i18n.objAddSuccess1 %></p><p><%= i18n.objAddSuccess4 %></p><p><%= i18n.objAddSuccess3 %></p>"),v=t.template("<p><%= i18n.objAddSuccess1 %></p><p><%= i18n.objAddSuccess2 %></p><p><%= i18n.objAddSuccess3 %></p>"),_=6e4,w=o.extend({constructor:function(){this._wizard=null,this._header=null,this._content=null,this._footer=null,this._waitingTimeout=null,this._waitConfirm=!1,this._eventNs=".objaddwiz",o.apply(this,arguments)},className:"wizard-wrapper centered-wrapper",initialize:function(){b.bindEvents.call(this),this.render()},render:function(){var t=this.model.getTexts();this.$el.html(a({id:"obj-add-wizard",title:t.objAddWizard,i18n:t})).appendTo("body"),this._wizard=this.$(".wizard"),this._header=this.$(".header"),this._content=this.$(".content"),this._footer=this.$(".footer"),b.renderFooter.call(this),e.fn.draggable&&this._wizard.draggable({containment:this.$el,distance:4,handle:">.header",scroll:!1}),b.start.call(this)},remove:function(){e(document).off(this._eventNs),this._waitingTimeout&&clearTimeout(this._waitingTimeout),o.prototype.remove.call(this)}}),b={bindEvents:function(){var t=this;this.$el.on("submit","form.page",function(){return!1}),e(document).on("keyup"+this._eventNs,function(n){if(13==n.keyCode){if(4==t.model.get("step")&&!t.model.get("deviceFound"))return;var i=e(n.target);b.nextStep.call(t),i.is("input,textarea")&&i.blur()}}).on("keydown"+this._eventNs,function(n){if(8==n.keyCode){if(e(n.target).is("input,textarea"))return!0;n.stopPropagation();var i=t.model.get("step");return i>1&&!t.model.get("complete")?t.model.set("step",i-1):t.model.destroy(),!1}}),this.$el.on("click",".back",function(){var e=t.model.get("step");e>1&&!t.model.get("complete")&&t.model.set("step",e-1)}).on("click",".btn-cancel",function(){t.model.destroy()}).on("click",".btn-continue",function(){b.nextStep.call(t)}).on("click",".btn-complete",function(){t.model.destroy()}).on("click",".btn-add-more",function(){t.model.destroy(!0)}).on("change","input[name=addAndSetup]",function(){this.checked&&t.model.set("addAndSetup",1==this.value)}).on("change","input[name=objType]",function(){this.checked&&t.model.set("objType",parseInt(this.value))}).on("click",".admin-login-link",function(){return App.loginAsAdmin(),!1}),this.listenTo(this.model,"destroy",function(){t.remove()}).listenTo(this.model,"change:addAndSetup",function(){t._content.find(".page.next").remove(),b.renderPage.call(this,2,"next").done(function(e){t._content.append(e)}),t._content.find(".integer").numeric({decimal:!1,negative:!1})}).listenTo(this.model,"change:addToAccount",function(e,n){n?b.renderPage.call(this,5,"next").done(function(e){t._content.append(e)}):t._content.find(".page.next").remove()}).listenTo(this.model,"change:deviceFound",function(e,n){b.onDeviceFoundChange.call(t,n)}).listenTo(this.model,"change:objType",function(){var e=t._wizard.find("[name=groupId]").closest(".page"),n=e.data("step");e.remove(),b.renderPage.call(this,n,"next").done(function(e){t._content.append(e)})}).listenTo(this.model,"change:complete",function(e,n){n&&t._content.find(".page.prev").remove(),b.renderFooter.call(t)}).listenTo(this.model,"change:step",function(e,n){b.onStepChange.call(t,n)})},nextStep:function(){var e=this,t=this.model.get("step"),n=this._content.find(".page.active"),o=n.serializeObject(!0);n.find("p.error").remove().end().find(".error").removeClass("error");var a=!1,d=setTimeout(function(){e._wizard.addClass("loading"),a=!0,"findDevice"in o&&b.setWaitingTimeout.call(e)},200);this.model.processStep(o).done(function(){e.model.set("step",t+1)}).fail(function(n){n?b.showErrors.call(e,n):e.model.get("deviceFound")===!1&&e.model.set("step",t+1)}).always(function(){clearTimeout(d),a&&(e._waitingTimeout&&clearTimeout(e._waitingTimeout),e._waitConfirm&&i.dialog.close(),e._wizard.removeClass("loading"))})},onStepChange:function(e){var t=this,n=this.model.previous("step"),i=this._content.find(".page.active")[0],o=this._content.find(".page[data-step="+e+"]")[0];e>n?(o.className=o.className.replace("next","active"),i.className=i.className.replace("active","prev")):(o.className=o.className.replace("prev","active"),i.className=i.className.replace("active","next")),setTimeout(function(){t._content.find(".page.active").find("input[type=text]").first().focus()},310),this._content.find(".page[data-step="+(e+1)+"]").length||b.renderPage.call(this,e+1,"next").done(function(e){t._content.append(e)}),b.renderFooter.call(this)},onDeviceFoundChange:function(t){var n=this,i=this.$el.find(".type-name");return null===this.model.previous("deviceFound")&&t?(this._wizard.find(".page[data-step=4] .extra").html(b.getDeviceImageHtml.call(this)).addClass("device-found"),i.text(t.name),void 0):(this._content.find(".page.next").filter(function(){return e(this).data("step")>3}).remove(),b.renderPage.call(this,4,"next").done(function(e){n._content.append(e)}),t?i.text(t.name):this._wizard.find(".extra").empty().removeClass("device-found"),void 0)},start:function(){var t=this;e.when(b.renderPage.call(this,1,"active"),b.renderPage.call(this,2,"next")).done(function(e,n){t._content.html(e+n),t._content.find(".integer").numeric({decimal:!1,negative:!1})})},renderPage:function(n,i){var o=new e.Deferred,a=b.chooseTemplate.call(this,n);if(!a)return o.reject();var d=this.model.getTexts(),r=t.extend({},this.model.attributes,{i18n:d}),c={step:n,addClass:i};if(this.model.get("deviceFound")&&n>3&&(c.extraClassName="device-found",c.extra=b.getDeviceImageHtml.call(this)),a==m){var l=this;c.addClass+=" loading",c.content="",function(n){l.model.getGroups().done(function(i){var o=l._wizard.find(".page[data-step="+n+"]");o.removeClass("loading").find(".main").html(m(t.extend({},l.model.attributes,{groups:i,i18n:d})));var a=o.find("input[name=groupId]")[0];o.find(".autocomplete[name=groupName]").autocomplete({minLength:2,appendTo:l._wizard,source:function(n,o){var d=e.trim(n.term.toLowerCase()),s=[];t.filter(i,function(e){var t=e.name.toLowerCase();return-1!=t.indexOf(d)?(s.push({id:e.id,label:e.name,value:e.name}),!0):!1}),s.length||(a.value=0),o(s)},select:function(e,t){var n=parseInt(t.item.id);a.value=n}});var s=o.find("[name=newGroupName]"),r=o.find("select[name=groupId]");s.length&&r.length&&o.on("click",".add-group",function(){s.prop("disabled",!1).parent().removeClass("hidden"),r.prop("disabled",!0).parent().addClass("hidden")}).on("click",".clear-group-name",function(){s.val("").prop("disabled",!0).parent().addClass("hidden"),r.prop("disabled",!1).parent().removeClass("hidden")}),o.hasClass("active")&&o.find("input[name=name]").focus()})}(n)}return c.content=a(r),o.resolve(s(c)),o},renderFooter:function(){var e=this.model.getTexts(),t=this.model.get("complete"),n=this.model.get("setupError"),i=this.model.get("step");this._footer.html(d({canGoBack:!t&&i>1,hideContinue:n&&4==i,complete:t,i18n:e}))},chooseTemplate:function(e){if(1==e)return r;var n=null;if(this.model.get("addAndSetup"))switch(e){case 2:n=c;break;case 3:n=h;break;case 4:n=!this.model.has("deviceFound")||this.model.get("deviceFound")?l:f;break;case 5:n=this.model.get("addToAccount")?m:t.template("NOT DESCRIBED");break;case 6:n=g}else switch(e){case 2:n=p;break;case 3:n=m;break;case 4:n=u;break;case 5:n=v}return n},showErrors:function(e){if(!e||!e.length)return!1;var n=this;t.each(e,function(e){n.$el.find("[name="+e.key+"]").addClass("error").after('<p class="error">'+e.msg+"</p>")}),n.$el.find(".error[name]").first().focus()},setWaitingTimeout:function(){var e=this,t=this.model.getTexts();this._waitingTimeout&&clearTimeout(this._waitingTimeout),this._waitingTimeout=setTimeout(function(){e._waitConfirm=!0,i.confirm(t.waitMoreMsg,t.waitMoreHdr,{okCallback:function(){b.setWaitingTimeout.call(e)},cancelCallback:function(){e.model.stop()}})},_)},getDeviceImageHtml:function(){if(!this.model.get("deviceFound"))return"";var e=this.model.get("deviceFound"),t="picture"in e?e.picture:"img/devices/unknown.jpg";return'<img src="'+t+'">'+"<p>"+e.name+"<br />("+e.firmware+")</p>"}};return w});