var PRODUCTION=!0;define("text!_common/geozones/tmpl/geozonesModule.html",[],function(){return'<li id="<%= moduleId %>" class="geozones-module items-tree loading<% if(active) {%> active<% } %>">\n    <div class="tab-toggle-container hint hint-right" data-hint="<%= name %>">\n        <a class="tab-toggle" href="#<%= key %>">\n            <i class="svg-icon svg-icon-geozones"></i>\n            <span><%- name %></span>\n        </a>\n    </div>\n    <div class="tab-hor-content">\n        <div class="box-header module-header append">\n\n            <form class="form-search">\n                <div class="input-append input-prepend">\n                    <span class="add-on">\n                        <input name="q" type="text" placeholder="<%= i18n.searchZones %>" autocomplete="off">\n                        <i class="icon-clear svg-icon svg-icon-circle-remove"></i>\n                    </span>\n                    <button class="btn add-on"><i class="svg-icon svg-icon-search"></i></button>\n                </div>\n            </form>\n\n            <div class="dropdown module-settings add-on">\n                <a class="dropdown-toggle" data-toggle="dropdown" href="#">\n                    <i class="svg-icon svg-icon-cog"></i>\n                </a>\n                <ul class="dropdown-menu nav nav-list" role="menu">\n\n                </ul>\n            </div>\n\n            <% if(allowCreate){ %>\n            <div class="dropdown add-on">\n                <a class="dropdown-toggle" data-toggle="dropdown" href="#">\n                    <i class="svg-icon svg-icon-plus"></i>\n                </a>\n                <ul class="dropdown-menu nav nav-list" role="menu">\n                    <li>\n                        <a class="add-item hidden" data-type="1" href="javascript:;"><%= i18n.addZone.radial %></a>\n                    </li><li>\n                        <a class="add-item hidden" data-type="0" href="javascript:;"><%= i18n.addZone.poly %></a>\n                    </li><li>\n                        <a class="add-group" href="javascript:;"><%= i18n.editGroup.add %></a>\n                    </li>\n                </ul>\n            </div>\n            <% } %>\n\n        </div>\n        <div class="module-content">\n            <div class="tree tree-grid slick-tree"></div>\n        </div>\n    </div>\n</li>'}),define("_common/geozones/views/GeozonesModuleView",["jquery","underscore","abstracts/ModuleView","text!../tmpl/geozonesModule.html","css!../css/geozones.css"],function(e,t,n,o){var i=n.extend({constructor:function(){this._tmpl=t.template(o),n.apply(this,arguments)},getName:function(){return this.model.getTexts().geozones.ucFirst()},getContainer:function(e){return"tree"==e?this.$el.find(".tree"):"editor"==e?this.getModuleContent():null},_bindEvents:function(){var t=this,n=this.model;this.$el.on("click",".add-group",function(){n.trigger("groupedit")}).on("click",".add-item",function(){n.trigger("itemedit",null,e(this).data("type"))}),this.listenToOnce(n,"ready",function(){var e=n.modules.tree,o=t.$el.find(".add-item");e.groups.length?o.removeClass("hidden"):t.listenToOnce(e,"change:loading",function(t,n){!n&&e.groups.length&&o.removeClass("hidden")}),t.listenTo(n,"groupadded",function(){-1!=o[0].className.indexOf("hidden")&&o.removeClass("hidden")}).listenTo(n,"groupremoved",function(){e.groups.length<1&&o.addClass("hidden")})}),this._initSearch()}});return i}),define("_common/geozones/Geozone",["underscore","abstracts/Model"],function(e,t){var n=t.extend({constructor:function(){t.apply(this,arguments)},url:App.getBaseUrl()+"zones/",parse:function(t){var n=e.isArray(t)?t[0]:t;return n.points&&(n.bounds=this.calculateBounds(n.points)),n},calculateBounds:function(){return null}});return n}),define("_common/geozones/GeozonePoly",["underscore","./Geozone"],function(e,t){var n=89,o=0,i=180,s=-180,r=t.extend({defaults:{points:null,bounds:null,center:null,square:0,type:0,groupId:0},constructor:function(){t.apply(this,arguments)},calculateBounds:function(e){for(var t,r,e=e||this.get("points"),a=[[null,null],[null,null]],l=e.length;l--;)t=e[l].lat,r=e[l].lon||e[l].lng,t>o&&n>t&&((t>a[1][0]||null===a[1][0])&&(a[1][0]=t),(t<a[0][0]||null===a[0][0])&&(a[0][0]=t)),r>s&&i>r&&((r>a[1][1]||null===a[1][1])&&(a[1][1]=r),(r<a[0][1]||null===a[0][1])&&(a[0][1]=r));return a}});return r}),define("_common/geozones/GeozoneRadial",["underscore","./Geozone","geo"],function(e,t,n){var o=t.extend({defaults:{points:null,bounds:null,center:null,radius:0,square:0,type:1,groupId:0},constructor:function(){t.apply(this,arguments)},parse:function(e){return e=t.prototype.parse.call(this,e),e.points&&2==e.points.length?(e.center=[e.points[0].lat,e.points[0].lon],e.radius=this.calculateRadius(e.points)):(e.radius=0,e.center=null),e},calculateBounds:function(e){var e=e||this.get("points"),t=[[null,null],[null,null]];if(2!=e.length)return t;var n=this.calculateRadius(e),o=360*(n/40075017),i=o/Math.cos(Math.D2R*e[0].lat);return[[e[0].lat-o,e[0].lon-i],[e[0].lat+o,e[0].lon+i]]},calculateRadius:function(e){var e=e||this.get("points");return n.getDistanceBetweenPoints(e[0].lat,e[0].lon,e[1].lat,e[1].lon)}});return o}),define("_common/geozones/GeozonesGroup",["jquery","underscore","abstracts/Group"],function(e,t,n){var o=n.extend({constructor:function(){n.apply(this,arguments)}});return o}),define("_common/geozones/nls/geozones",{root:{radial:"Radial",poly:"Polygonal",showZonesNamesOnMap:"Show geofence names on the map",sortBy:"Filtering",sortByZoneName:"By geofence name",sortByZoneId:"By geofence ID",removeZonesGroup:"Remove the group",removeZone:"Remove the geofence",removeZones:"Remove selected geofences",errors:{field:{empty:"Error! The field is not completed",emptyZoneName:"Enter an geofence name",emptyGroupName:"Enter geofence group name",nameLength:"The name must be at most 3 characters",group:"Select a group for the geofence"},wrongRadius:"The radius must be between 10 and 100000 meters",noObject:"Error! No objects on the map!",noRadialObject:"There are no center coordinates<br>The radius of the radial geofence must be at least 1 m",noPolyObject:"Not enough points for geofence creation. Plot points on the map",geofenceWidth:"The geofence width must be at least 10 meters.",noDeleteEditedObject:"Error! Unable to delete this object, as it is in the editing process"},confirm:{"delete":{header:"Remove the geofence?",text:"Are you sure you want to remove the geofence"},deleteMulti:{header:"Remove geofences?",text:"Are you sure you want to remove all selected geofences?"},deleteGroup:{header:"Remove the group?",text:"Are you sure you want to remove the group of geofences"},create:{radial:"Are you sure you want to cancel the radial geofence creation?",poly:"Are you sure you want to cancel the polygonal geofence creation?"}},addZone:{radial:"Add a radial geofence",poly:"Add a polygonal geofence",byTrack:"Create the geofence by track"},editZone:{contextItem:"Edit the geofence",enterName:"Enter an geofence name",enterNewName:"Enter the new name of the geofence (group)",chooseGroup:"Select a group for the geofence",enterWidth:"Enter the corridor width",enterRadius:"Enter the geofence radius (in meters)",enterAddress:"Enter the address or the location on the map"},editGroup:{add:"Add the geofence group",enterName:"Enter a geofence group name"},emptyTreeMsg:"No geofence groups are created yet",configureAccess:"Configure access",findUser:"Find and add a user"},"ru-ru":!0,"it-it":!0}),define("_common/geozones/nls/ru-ru/geozones",{radial:"Радиальная",poly:"Полигональная",showZonesNamesOnMap:"Показывать имена геозон на карте",sortBy:"Сортировка",sortByZoneName:"По имени геозоны",sortByZoneId:"По ID-номеру геозоны",removeZonesGroup:"Удалить группу",removeZone:"Удалить геозону",removeZones:"Удалить выбранные геозоны",errors:{field:{empty:"Ошибка! Поле не заполнено",emptyZoneName:"Введите имя геозоны",emptyGroupName:"Введите имя группы геозон",nameLength:"Имя должно быть более 3 символов",group:"Выберите группу для геозоны"},wrongRadius:"Радиус должен быть в пределах от 10 до 100000 метров",noObject:"Ошибка! Нет объекта на карте!",noRadialObject:"Отсутствуют координаты центра<br>Радиус радиальной геозоны должен быть не менее 1м",noPolyObject:"Недостаточно точек для создания геозоны. Нанесите точки на карту",zoneWidth:"Ширина геозоны должна быть не меньше 10 метров.",noDeleteEditedObject:"Ошибка! Не могу удалить этот объект, так как он редактируется"},confirm:{"delete":{header:"Удалить геозону?",text:"Вы действительно хотите удалить геозону?"},deleteMulti:{header:"Удалить геозоны?",text:"Вы действительно хотите удалить все выбранные геозоны?"},deleteGroup:{header:"Удалить группу?",text:"Вы действительно хотите удалить группу геозон "},create:{radial:"Вы действительно хотите отменить создание радиальной геозоны?",poly:"Вы действительно хотите отменить создание полигональной геозоны?"}},addZone:{radial:"Добавить радиальную геозону",poly:"Добавить полигональную геозону",byTrack:"Пoстроить геозону по треку"},editZone:{contextItem:"Редактировать геозону",enterName:"Введите имя геозоны",enterNewName:"Введите новое имя геозоны (группы)",chooseGroup:"Выберите группу для геозоны",enterWidth:"Введите ширину корридора",enterRadius:"Введите радиус геозоны (в метрах)",enterAddress:"Укажите адрес или место на карте"},editGroup:{add:"Добавить группу геозон",enterName:"Введите имя группы геозон"},emptyTreeMsg:"Пока не создано ни одной группы геозон",configureAccess:"Настроить доступ",findUser:"Найти и добавить пользователя"}),define("_common/geozones/GeozonesModule",["jquery","underscore","abstracts/Module","./views/GeozonesModuleView","./Geozone","./GeozonePoly","./GeozoneRadial","./GeozonesGroup","i18n!_common/nls/common","i18n!_common/geozones/nls/geozones"],function(e,t,n,o,i,s,r,a,l,d){var c={tree:"_common/geozones/tree/GeozonesTreeModule",watched:"_common/geozones/watched/GeozonesWatchedModule",editor:"_common/geozones/edit/GeozonesEditModule"},u=n.extend({constructor:function(){this._modules=["tree","watched"],this._zoomItem=null,(App.allowed("zones.create")||App.allowed("zones.edit"))&&this._modules.push("editor"),n.apply(this,arguments)},initialize:function(){var n=this;this._i18n=e.extend({},l,d);var i=t.map(this._modules,function(e){return c[e]});if(this.get("container")&&(this._view=new o({container:this.get("container"),placeholder:this.get("placeholder"),model:this,allowCreate:App.allowed("zones.create")})),this._view){var s=this.get("options")||{};this.set("buildByPolyline",s.buildByPolyline||!1),m.bindCommonEvents.call(n),requirejs(i,function(){var e=0;t.each(arguments,function(t){var o=n._modules[e];n.modules[o]=new t({id:n.id+"/"+o,container:"watched"!=o?n._view.getContainer(o):null,parent:n,mapsModule:n.get("parent").getMapsModule(),allowCreate:App.allowed("zones.create"),allowEdit:App.allowed("zones.edit"),allowRemove:App.allowed("zones.delete")}),e++}),m.bindEvents.call(n),n.trigger("ready")})}},getSelectedItemsIds:function(){return this.getUserData("watched.items")},getMapsModule:function(){return this.get("parent").getMapsModule()},getGroupsList:function(){return this.modules.tree?this.modules.tree.groups.toJSON():[]},getWatchedItemsIds:function(){return this.modules.watched?this.modules.watched.items.pluck("id"):[]},zoomToZone:function(e){this.modules.tree&&this.modules.tree.trigger("action","item_show",e)},setZoomItem:function(e){this._zoomItem=e},getZoomItem:function(){return this._zoomItem},getPolylineForZone:function(){var t,n=new e.Deferred;return(t=this.get("parent").getPolylineForZone())?n.resolve(t):n.reject(),n},getTexts:function(){return this._i18n}}),m={bindCommonEvents:function(){var e=this;this.on("groupremove",function(){m.removeGroup.apply(e,arguments)}).on("itemremove",function(){m.removeItem.apply(e,arguments)})},bindEvents:function(){var e=this,n=e.modules.tree;if(this.on("activate",function(){n.trigger("activate")}).on("deactivate",function(){n.trigger("deactivate")}).on("filtertree",function(e){n.set("q",e)}),this.on("needitemzoom",function(t){e.modules.watched.trigger("itemzoom",t)}),this.modules.editor){var o=this.modules.editor,l=this.modules.watched;this.on("groupedit",function(e){e?t.isNumber(e)&&(e=null):e=new a,e&&o.set("model",e)}).on("itemedit",function(e,n){if(e?e instanceof i||t.isNumber(e)&&(e=null):e=1==n?new r:new s,e){var a;!e.id||e.has("points")?(o.set("model",e),e.id&&((a=l.items.get(e.id))&&l.getView().toggleShow(e,!1),l.trigger("itemzoom",e))):(a=l.items.get(e.id))?(e.set(a.toJSON()),o.set("model",e),l.trigger("itemzoom",e),l.getView().toggleShow(e,!1)):(showCursor(),e.fetch({data:{id:[e.id]}}).done(function(){o.set("model",e),l.trigger("itemzoom",e)}).always(hideCursor))}}).listenTo(o,"toggleform",function(t){e.modules.tree.setTop(t||0)}).listenTo(o,"change:model",function(e,t){if(null==t){var n=o.previous("model");n instanceof i&&l.items.get(n.id)&&l.getView().toggleShow(n,!0)}})}},removeGroup:function(n){if(n){var o=0,i=this;if(t.isObject(n)){if(o=n.id||0,n.nbItems)return}else o=Number(n);o&&e.ajax({url:App.getBaseUrl()+"zones-groups/zones-group-delete/",data:{id:o},complete:function(e){e.status>=200&&e.status<300?i.trigger("groupremoved",o):i.trigger("groupremoveerror",o)}})}},removeItem:function(n){if(n){var o=0,i=this;o=t.isObject(n)?n.id||0:Number(n),o&&e.ajax({url:App.getBaseUrl()+"zones/zone-delete/",data:{id:o},complete:function(e){e.status>=200&&e.status<300?i.trigger("itemremoved",n):i.trigger("itemremoveerror",n)}})}}};return u}),define("_common/geozones/GeozonesCollection",["underscore","abstracts/Collection","./GeozoneRadial","./GeozonePoly"],function(e,t,n,o){var i=1,s=t.extend({constructor:function(){t.apply(this,arguments)},url:App.getBaseUrl()+"zones/",model:function(e,t){return e.type==i?new n(e,t):new o(e,t)},parse:function(e){return e.items||e.group&&e.group.items||e}});return s}),define("text!_common/geozones/watched/tmpl/settings.html",[],function(){return'<h4><%= i18n.geozones.ucFirst() %></h4>\n<div class="control-group">\n    <label class="checkbox"><input type="checkbox" class="showZoneName" name="showZoneName" <% if (!_.isUndefined(showZoneName) && showZoneName) {%> checked<%} %>/> <%= i18n.showZonesNamesOnMap %></label>\n</div>'}),define("_common/geozones/watched/views/GeozonesWatchedView",["jquery","jqueryui","underscore","abstracts/watched/views/WatchedView","text!../tmpl/settings.html"],function(e,t,n,o,i){var s=89,r=0,a=180,l=-180,d=1,c=o.prototype,u=o.extend({constructor:function(){o.apply(this,arguments)},_useClusters:!1,initialize:function(){c.initialize.apply(this,arguments),e("#settings").length?m.initSettings.call(this):this.listenTo(App,"settingsready",n.bind(m.initSettings,this))},addWatchedMulti:function(e){if(e){var t,n,o=e.length,i=this.model.items,s=[];if(e.length){for(var r,a=this.model.get("parent"),l=a.getZoomItem(),d=this._cloneCurrentBounds();o--;)(n=i.get(e[o]))&&(this._bindModelEvents(n),(t=this._buildMapElement(n))&&s.push(t),r=n.get("bounds"),r&&(d=this._extendBounds(d,r)));this.model.set("bounds",d),l?(this.zoomToItem(l),a.setZoomItem(null)):this.model.zoomToBounds()}s.length&&(null===this._singlesLayer?this._createSinglesLayer(s):this._singlesLayer.addLayers(s))}},toggleShow:function(e,t){var n,t=t||!1;(n=this._viewsMap[e.id])&&this._singlesLayer[t?"addLayer":"removeLayer"](n)},updateBounds:function(e,t){if(e.has("bounds")){var n=this._cloneCurrentBounds(),o=e.get("bounds");if(t)n=this._extendBounds(n,o),this.model.set("bounds",n),this.model.zoomToBounds();else{var i=!1;o[0][0]>r&&o[0][0]<s&&o[1][0]>r&&o[1][0]<s&&(o[1][0]>=n[1][0]||o[0][0]<=n[0][0])&&(i=!0),o[0][1]>l&&o[0][1]<a&&o[1][1]>l&&o[1][1]<a&&(o[1][1]>=n[1][1]||o[0][1]<=n[0][1])&&(i=!0),i&&this._calculateBounds(!1)}}},zoomToItem:function(e){if(e&&(n.isNumber(e)||e.id)){var t,o=this._maps,i=15;t=n.isNumber(e)?this.model.items.get(e):e,t.has&&t.has("bounds")?o.setBounds(t.get("bounds"),{maxZoom:i}):this.listenToOnce(this.model.items,"add",function(t){e.id==t.id&&o.setBounds(t.get("bounds"),{maxZoom:i})})}},_bindEvents:function(){c._bindEvents.apply(this,arguments),this.listenTo(this.model,"change:showNames",function(t,n){e(".zone-name-layer").each(function(){var e=this.getAttribute("class");n?e=e.replace(" hidden",""):e+=" hidden",this.setAttribute("class",e)})})},_onModuleReady:function(){var e=this.model.items;if(e.length){var t,n,o=this,i=[],s=this._getNullBounds();e.each(function(e){e.has("points")&&(n=e.get("bounds"),o._bindModelEvents(e),(t=o._buildMapElement(e))&&i.push(t),n&&(s=o._extendBounds(s,n)))}),e.length&&this.model.set("bounds",s),this._createSinglesLayer(i)}},_calculateBounds:function(e){var t=this,n=this._getNullBounds();this.model.items.each(function(e){var o=e.get("bounds");o&&(n=t._extendBounds(n,o))}),this.model.set("bounds",n),e&&this.model.zoomToBounds()},_extendBounds:function(e,t){return t[0][0]>r&&t[0][0]<s&&t[1][0]>r&&t[1][0]<s&&((t[1][0]>e[1][0]||null===e[1][0])&&(e[1][0]=t[1][0]),(t[0][0]<e[0][0]||null===e[0][0])&&(e[0][0]=t[0][0])),t[0][1]>l&&t[0][1]<a&&t[1][1]>l&&t[1][1]<a&&((t[1][1]>e[1][1]||null===e[1][1])&&(e[1][1]=t[1][1]),(t[0][1]<e[0][1]||null===e[0][1])&&(e[0][1]=t[0][1])),e},_bindModelEvents:function(e){var t=this;this.model.get("showNames"),this.listenTo(e,"change:name",function(){}).listenTo(e,"change:points",function(e,n){var o;if(o=t._viewsMap[e.id]){if(console.log("change:points handler"),e.get("type")==d)return;for(var i=n.length,s=new Array(i),r=0;i>r;++r)s[r]=[n[r].lat,n[r].lon||n[r].lng];o.setLatLngs(s)}else if(n.length){var o;(o=t._buildMapElement(e))&&(t._checkLayersAndAddView(o),t.updateBounds(e,!0))}}).listenTo(e,"change:radius",function(e,n){var o;(o=t._viewsMap[e.id])&&o.setRadius(n)}).listenTo(e,"change:center",function(e,n){var o;(o=t._viewsMap[e.id])&&(console.log("change:center handler"),o.setLatLng(n))}).listenTo(e,"change:bounds",function(e){var n;(n=t._viewsMap[e.id])&&t.updateBounds(e,!1)})},_buildMapElement:function(e){if(e.has("points")){var t,n=this.model.get("showNames"),o=this._maps.getWidget(),i={addClass:"zone-name-layer"+(n?"":" hidden"),content:function(){return e.get("name")}};return t=e.get("type")==d?o.buildRadial({center:e.get("center"),radius:e.get("radius"),info:i}):o.buildPolygon({latlng:e.get("points"),info:i}),this._viewsMap[e.id]=t,t}},_buildInfoView:function(){}}),m={initSettings:function(){var t=this,o=this.model.get("parent"),s=e("#settings").find(".geozones-watched").removeClass("hidden");s.html(n.template(i,{i18n:o.getTexts(),showZoneName:t.model.get("showNames")})),s.find(".showZoneName").on("click",function(){t.model.set("showNames",this.checked)})}};return u}),define("_common/geozones/watched/GeozonesWatchedModule",["underscore","abstracts/watched/WatchedModule","../GeozonePoly","../GeozoneRadial","../GeozonesCollection","./views/GeozonesWatchedView"],function(e,t,n,o,i,s){var r=t.prototype,a=t.extend({url:App.getBaseUrl()+"zones/",constructor:function(){this.items=new i,this.zoomOnRemove=!1,t.apply(this,arguments)},_viewClass:s,defaults:e.extend({},r.defaults,{updating:!1}),initialize:function(){this.set("showNames",this.getUserData("showNames")||!1),r.initialize.call(this)},buildItemTitle:function(e){return e.name},zoomToBounds:function(){this.get("parent").getMapsModule().setBounds(this.get("bounds"))},_bindEvents:function(){var e=this,t=this.get("parent");r._bindEvents.call(this),this.on("change:showNames",function(t,n){e.setUserData("showNames",n)}).listenTo(t,"itemadded",function(t){t.get("checked")&&(e.items.add(t.clone()),e.setUserData("items",e.items.pluck("id")))}).listenTo(App,"clearmap",function(n){t.getMapsModule()==n&&e.setItems([])})},_onItemChanged:function(e){for(var t,n=e.length;n--;)e[n].id&&(t=this.items.get(e[n].id))&&t.set(t.parse(e[n]))}});return a}),define("_common/geozones/GeozonePolylinePoly",["underscore","util","_common/geozones/GeozonePoly"],function(e,t,n){var o=60,i=50,s=17,r=n.extend({defaults:{width:i,maps:null,points:null,bounds:null,center:null,square:0,type:0,groupId:0},constructor:function(){this._original=[],this._polyline=null,this._nodes=[],this._fakeZoom=s,this._accuracy=o,n.apply(this,arguments)},initialize:function(){this.maps=this.get("maps");var e=this;this.maps.on("mapchanged",function(){e._polyline=null,e.build()}),this.on("change:width",function(){e.build()})},setPolyline:function(e){this._original=e&&e.length?e:[],this._polyline=null},build:function(){return this._nodes=[],this._original.length?(a.calcNodes.call(this),a.calcPoints.call(this),this.set("bounds",this.calculateBounds()),void 0):!1}}),a={calcNodes:function(){if(!this._nodes.length&&this._original.length){a.projectOriginalPoints.call(this);for(var e=Math.pow(2,this._fakeZoom-this.maps.getZoom()),t=Math.simplifyDouglasPeucker(this._polyline,this._accuracy),n=0,o=t.length;o>n;++n)t[n].x/=e,t[n].y/=e;this._nodes=t}},projectOriginalPoints:function(){var e,t=this._original,n=this.maps.getMap(),o=n.getZoom(),i=t.length,s=new Array(i);this._fakeZoom=n.getMaxZoom(),n.setZoom(this._fakeZoom);for(var r=0;i>r;++r)e={x:n.lonToX(t[r].lon),y:n.latToY(t[r].lat)},s[r]=e;n.setZoom(o),this._polyline=s},calcPoints:function(){if(this._nodes.length&&this.maps){var e,t,n=this.maps,o=null,i=this._nodes.length,s=1,r=null,a=null,c=2,u=0,m=new Array(2*i),h=1;i&&(s=n.getMetersInPx(this._original[0].lat),console.log(this.get("width")),h=this.get("width")/2/s);for(var p=0;i>p;p++)o=this._nodes[p],0==p?(e={x:this._nodes[p+1].x-o.x,y:this._nodes[p+1].y-o.y},u=c/d(e),t=l({x1:o.x-2*e.x*u,y1:o.y-2*e.y*u,x2:o.x-e.x*u,y2:o.y-e.y*u},{x1:o.x-e.x*u,y1:o.y-e.y*u,x2:o.x,y2:o.y},h)):p==i-1?(e={x:o.x-this._nodes[p-1].x,y:o.y-this._nodes[p-1].y},u=c/d(e),t=l({x1:o.x,y1:o.y,x2:o.x+e.x*u,y2:o.y+e.y*u},{x1:o.x+e.x*u,y1:o.y+e.y*u,x2:o.x+2*e.x*u,y2:o.y+2*e.y*u},h)):t=l({x1:this._nodes[p-1].x,y1:this._nodes[p-1].y,x2:o.x,y2:o.y},{x1:o.x,y1:o.y,x2:this._nodes[p+1].x,y2:this._nodes[p+1].y},h),r=n.pointToLatLon([t[0].x,t[0].y]),a=n.pointToLatLon([t[1].x,t[1].y]),m[p]=r,m[2*i-1-p]=a;this.set("points",m)}}},l=function(e,t,n){var o,i,s=[],r={x:e.x2-e.x1,y:e.y2-e.y1},a={x:t.x2-t.x1,y:t.y2-t.y1},l=d(r),u=d(a),m=l*(t.x2-e.x1)/(l+u),h=l*(t.y2-e.y1)/(l+u),p={x:e.x1+m-e.x2,y:e.y1+h-e.y2},g=d(p);return g>.01?(o={x:e.x2+n*p.x/g,y:e.y2+n*p.y/g},i={x:e.x2-n*p.x/g,y:e.y2-n*p.y/g},s=c(r,{x:e.x2-o.x,y:e.y2-o.y})<0?[o,i]:[i,o]):s=[{x:e.x2+n*-r.y/l,y:e.y2+n*r.x/l},{x:e.x2-n*-r.y/l,y:e.y2-n*r.x/l}],s},d=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},c=function(e,t){return e.x*t.y-e.y*t.x>0?1:e.x*t.y-e.y*t.x<0?-1:0};return r}),define("text!_common/geozones/edit/tmpl/poly.html",[],function(){return'<input name="name" type="text" class="input-block-level" placeholder="<%= i18n.editZone.enterName %>" value="<%= name %>" maxlength="100">\n<select class="input-block-level" name="groupId">\n    <option value="0"><%= i18n.editZone.chooseGroup %></option>\n    <% _.each(groups, function(group){%>\n    <option value="<%= group.id %>"<% if(groupId == group.id) {%> selected<% } %>><%= group.name %></option>\n    <% }) %>\n</select>\n<% if(buildByPolyline) {%>\n<div class="polyline-block">\n    <a class="build-by-polyline<% if(\'undefined\' != typeof width) {%> hidden<% } %>" href="javascript:;"><%= i18n.addZone.byTrack %></a>\n    <div class="field field-width<% if(\'undefined\' == typeof width) {%> hidden<% } %>">\n        <label><%= i18n.editZone.enterWidth %>, <%= i18n.m %></label>\n        <!--<input id="zone-width" type="number" class="input-mini integer no-margin" maxlength="3" max="500" min="10" value="50" name="zoneWidth" autocomplete="off" />-->\n        <input id="zone-width" type="text" class="input-mini integer no-margin" maxlength="3" value="50" name="zoneWidth" autocomplete="off" />\n        <a href="javascript:;" class="redraw-by-polyline help-inline"><%= i18n.rebuild.ucFirst() %></a>\n        <div class="clear"></div>\n    </div>\n</div>\n<% } %>\n\n'}),define("text!_common/geozones/edit/tmpl/radial.html",[],function(){return'<% if(\'undefined\' == typeof id || !id) {%>\n<div id="zone-search" class="control-group form-address-search form-search">\n    <div class="input-append input-prepend">\n        <span class="add-on">\n            <input name="address" type="text" placeholder="<%= i18n.editZone.enterAddress %>">\n            <i class="icon-clear svg-icon svg-icon-circle-remove"></i>\n        </span>\n        <a href="javascript:;" class="btn add-on btn-search"><i class="svg-icon svg-icon-search"></i></a>\n    </div>\n</div>\n<% } %>\n\n<input name="name" type="text" class="input-block-level" placeholder="<%= i18n.editZone.enterName %>" value="<%= name %>" maxlength="100">\n\n<div class="form-inline control-group">\n    <span class="help-inline"><%= i18n.radius.ucFirst() %>, <%= i18n.m %></span>\n    <input name="radius" type="number" data-min="10" data-max="100000" class="input-mini expanded" value="100">\n</div>\n\n<select class="input-block-level no-margin" name="groupId">\n    <option value="0"><%= i18n.editZone.chooseGroup %></option>\n    <% _.each(groups, function(group){%>\n    <option value="<%= group.id %>"<% if(groupId == group.id) {%> selected<% } %>><%= group.name %></option>\n    <% }) %>\n</select>\n'}),define("text!_common/geozones/edit/tmpl/group.html",[],function(){return'<input class="input-block-level no-margin" name="name" type="text"\n       placeholder="<%= i18n.enterGroupName %>" value="<%- name %>" maxlength="255">'}),define("_common/geozones/edit/views/GeozonesEditModuleView",["jquery","jqueryui","underscore","abstracts/editor/views/EditorView","text!../tmpl/poly.html","text!../tmpl/radial.html","text!../tmpl/group.html","jface"],function(e,t,n,o,i,s,r,a){function l(e){if(!e||!e.length)return[];if(n.isArray(e[0]))return e;if(e[0].lng)return e;for(var t=e.length,o=new Array(t),i=0;t>i;++i)o[i]=[e[i].lat,e[i].lon||e[i].lng];return o}var d=1;i=n.template(i),s=n.template(s);var c=o.extend({constructor:function(){this._tmplGroup=n.template(r),o.apply(this,arguments)},getZonePoints:function(){if(!this._editLayer)return null;var e=this._editLayer.getPoints();if(!e)return[];for(var t=e.length,n=new Array(t),o=0;t>o;++o)n[o]={lat:e[o][0],lon:e[o][1]};return n},_bindEvents:function(){var t=this,n=this.model,i=n.get("parent");o.prototype._bindEvents.apply(this,arguments),this.off("searchsuccess searchcomplete"),this.on("searchsuccess",function(e){n.get("model").get("type")==d&&t._editLayer&&e[0]&&(t._editLayer.setCenter([e[0].lat,e[0].lon]),t.$el.find("input[name=name]").val(e[0].title))}).on("searchcomplete",function(){t._addressSearchBlock.addClass("active")}),this.listenTo(i,"groupremoved",function(e){if(n.get("model")){var o=n.get("model");o.has("type")&&(t.$el.find("select[name=groupId] option[value="+e+"]").remove(),t.$el.find("select[name=groupId] option").length<2&&n.set("model",null))}}),this.$el.on("click","a.build-by-polyline",function(){e(this),i.getPolylineForZone().done(function(e){!t._editLayer||e.length<2||n.trigger("needzonebypolyline",e)}).fail(function(){})}).on("click","a.redraw-by-polyline",function(){var o=parseInt(e(this).siblings("input").val());if(10>o){var i=n.getTexts().errors.zoneWidth;return t._showErrors.call(t,[{key:"zone-width",msg:i}])}n.get("model").set("width",o)})},_renderItemForm:function(t){var t=t||this.model.get("model"),o=this.model.getTexts(),r=t.get("type")==d?s:i,a=this.model.getGroupsList();if(this._body.html(r(n.extend({},t.attributes,{i18n:o,groups:a,buildByPolyline:this.model.get("parent").get("buildByPolyline")}))),1==a.length&&this._body.find("select[name=groupId] option").last().prop("selected",!0),t.get("type")==d){var l=this;t.id||this._initAddressSearch(),this._body.find("input[name=radius]").on("change",function(){l._editLayer&&l._editLayer.setRadius(e(this).val())})}},_initEditableObject:function(){var e=this,t=this.model.get("mapsModule"),n=this.model.get("model");this._editLayer&&(t.removeLayer(this._editLayer),this._editLayer=null),n.get("type")==d?(this._editLayer=u.buildEditableCircle.call(this,n),this._editLayer.on("resize",function(t){var n=t.radius,o=e.$el.find("input[name=radius]");o.length&&o.val(Math.round(n))})):(this._editLayer=u.buildEditablePoly.call(this,n),this.listenTo(n,"change:points",function(t,n){e._editLayer.setLatLngs(n)})),t.addLayer(this._editLayer)},_onCancel:function(e,t){var n=this.model,o=this.model[e?"previous":"get"]("model"),i=n.getTexts(),s=!1;if(o instanceof n.GroupsClass?!e&&n.set("model",null):this._editLayer&&this._editLayer.isModified()&&(s=!0),s){var r=i.allChangesCancel;o.id||(r=i.confirm.create[o.get("type")==d?"radial":"poly"]),a.confirm(r,i.cancelChanges,{okCallback:function(){n.modelChanged=!1,t?t():n.set("model",null)},cancelCallback:function(){e&&n.set("model",o,{silent:!0})}})}else n.modelChanged=!1,t?t():n.set("model",null)}}),u={buildEditableCircle:function(e){var t=this.model.getTexts(),n=this.model.get("mapsModule"),o={info:{addClass:"zone-size-info radial-zone-size-info",content:function(){var e=[],n=this.getArea(),o=this.getRadius();if(o&&n){var i=parseInt(o/1e3),s=parseInt(o%1e3),r=Math.abs(n/1e4);return i>0?e.push((t.radius.ucFirst()||"")+": "+i+" "+(t.km||"")+(s>0?" "+s+" "+(t.m||""):"")):e.push(t.radius.ucFirst()+": "+Math.round(o)+" "+(t.m||"")),r>0&&e.push((t.square.ucFirst()||"")+": "+r.toFixed(2)+" "+(t.ha||"")),e.join("<br>")}return""}}};return e.id?e.has("points")&&(o.latlng=l(e.get("points")),o.radius=e.get("radius")):o.addPoints=!0,n.getWidget().buildEditableRadial(o)},buildEditablePoly:function(e){var t=this.model.getTexts(),n=this.model.get("mapsModule"),o={info:{addClass:"zone-size-info",content:function(){var e=[],n=this.getArea(),o=this.getPerimeter();if(o&&n){var i=parseInt(o/1e3),s=parseInt(o%1e3),r=Math.abs(n/1e4);return i>0?e.push((t.perimeter.ucFirst()||"")+": "+i+" "+(t.km||"")+" "+s+" "+(t.m||"")):e.push(t.perimeter.ucFirst()+": "+Math.round(o)+" "+(t.m||"")),r>0&&e.push((t.square.ucFirst()||"")+": "+r.toFixed(2)+" "+(t.ha||"")),e.join("<br>")}return""}}};if(e.id||e.has("points")){var i=l(e.get("points"));o.latlng=i}else o.addPoints=!0;return n.getWidget().buildEditablePolygon(o)}};return c}),define("_common/geozones/edit/GeozonesEditModule",["jquery","underscore","abstracts/editor/EditorModule","_common/geozones/Geozone","_common/geozones/GeozonePoly","_common/geozones/GeozoneRadial","_common/geozones/GeozonePolylinePoly","_common/geozones/GeozonesGroup","_common/geozones/edit/views/GeozonesEditModuleView"],function(e,t,n,o,i,s,r,a,l){var d=1,c=0,u=n.extend({constructor:function(){n.apply(this,arguments)},initialize:function(){this.ItemsClass=o,this.GroupsClass=a,this._itemEditUrl=App.getBaseUrl()+"zones/save/",this._itemCreateUrl=this._itemEditUrl,this._groupEditUrl=App.getBaseUrl()+"zones-groups/zones-group-save/",this._groupCreateUrl=this._groupEditUrl,n.prototype.initialize.call(this,l);var e=this;this.listenTo(this.get("parent"),"groupremoved",function(t){if(e.has("model")){var n=e.get("model");n.has("type")||n.id!=t||e.set("model",null)}}).listenTo(this.get("parent"),"itemremoved",function(t){if(e.has("model")){var n=e.get("model");n.has("type")&&n.id==t.id&&e.set("model",null)}}).on("needzonebypolyline",function(t){if(!t||t.length<2)return!1;var n=new r({maps:e.get("mapsModule")});n.setPolyline(t),n.build(),e.set("model",n),e.get("mapsModule").setBounds(n.get("bounds"),{maxZoom:16,animate:!1})}).listenTo(App,"clearmap",function(t){t==e.get("mapsModule")&&e.has("model")&&e.get("model").has("type")&&e.set("model",null)})},saveModel:function(t){var r=this,a=new e.Deferred,l=r.get("parent");if(!this.has("model"))return a.reject();var c=this.get("model");return c.id&&(t.id=c.id),c instanceof o?(t.points=this._view.getZonePoints(),t.type=c.get("type"),r._saveItem(t).done(function(e){if(c.id)l.trigger("itemchanged",[e],r);else{var n=t.type==d?s:i;l.trigger("itemadded",new n(e,{parse:!0}))}r.set("model",null)}).fail(function(e){a.reject(e)})):n.prototype.saveModel.call(r,t)},_saveItem:function(t){var n,o=new e.Deferred;return t.address&&!t.name&&(t.name=t.address),"undefined"!=typeof t.address&&delete t.address,"undefined"!=typeof t.zoneWidth&&delete t.zoneWidth,(n=this._validateItem(t))?o.reject(n):(e.ajax({url:t.id?this._itemEditUrl:this._itemCreateUrl,data:[t],success:function(e){o.resolve(e[0])
},error:function(e){o.reject(e)}}),o)},_validateItem:function(e){var t=[],n=this.getTexts();return e.name=String(e.name),e.name?e.name.length<3&&t.push({msg:n.errors.field.nameLength,key:"name"}):t.push({msg:n.errors.field.emptyZoneName,key:"name"}),e.groupId||t.push({msg:n.errors.field.group,key:"groupId"}),e.type==d?e.points.length<2?t.push({msg:n.errors.noRadialObject}):(e.radius<10||e.radius>1e7)&&t.push({key:"radius",msg:n.errors.wrongRadius}):e.type==c&&e.points.length<3&&t.push({msg:n.errors.noPolyObject}),t.length?t:null},_validateGroup:function(e){var t=this.getTexts();return n.prototype._validateGroup.call(this,e,{name:{empty:t.errors.field.emptyGroupName}})}});return u}),define("_common/geozones/GeozonesGroupsCollection",["underscore","abstracts/Collection","./GeozonesGroup"],function(e,t,n){var o=t.extend({constructor:function(){this.module=null,t.apply(this,arguments)},model:n,parse:function(e){return e.groups||e.group&&e.group.groups||e}});return o}),define("text!_common/geozones/tree/tmpl/title.html",[],function(){return'<div class="cell-row" style="left: <%= (20 * indent) %>px;" data-action="check">\n    <% if(isgroup) { %>\n        <% if(id == 0) { %><% } else if ( \'undefined\' != typeof items && items.length ) { %>\n            <i class="icon icon-exp toggle <%= closed ? \'collapse\': \'expand\' %>"></i>\n        <% } else { %>\n            <i class="icon icon-exp toggle"></i>\n        <% } %>\n    <% } else { %>\n        <!--<i class="toggle"></i>-->\n    <% } %>\n\n    <% if (isgroup && ( \'undefined\' == typeof items || !items.length )) { %>\n        <i class="item-check-false"></i>\n    <% } else { %>\n        <i data-action="check" class="icon icon-check item-check<%= checked === 1 ? \' checked\': (checked === 2 ? \' indeterminate\': \'\') %>" ></i>\n    <% } %>\n\n    <% if(isgroup) { %>\n        <strong class="row-title group-title" data-action="check"><%= name %></strong>\n    <% } else { %>\n        <span class="row-title item-title" data-grid-itemid="<%= id %>"><%= name %> (#<%= id %>)</span>\n    <% } %>\n</div>'}),define("text!_common/geozones/tree/tmpl/type.html",[],function(){return'<% if (isgroup) { %>\n    <span data-action="check" class="nb-items">(<%= \'undefined\' != typeof items ? items.length : \'0\' %>)</span>\n<% } else { %>\n    <% if(type == 1) { %>\n    <i data-action="check" class="icon-radial" title="<%= i18n.radial %> <%= i18n.geozone %>"></i>\n    <% } else { %>\n    <i data-action="check" class="icon-poly" title="<%= i18n.polygonal %> <%= i18n.geozone %>"></i>\n    <% } %>\n<% } %>\n<% if (hasContext) { %>\n    <i class="icon icon-edit svg-icon svg-icon-caret-down"></i>\n<% } %>'}),define("text!_common/geozones/tree/tmpl/contextMenu.html",[],function(){return'<% if(isgroup) {%>\n    <% if(App.allowed(\'zones.create\') || App.allowed(\'zones.edit\')) {%>\n    <li>\n        <a href="#" data-action="group_edit"><%= i18n.renameGroup %></a>\n    </li>\n    <li>\n        <a href="#" data-action="configure_access"><%= i18n.configureAccess %></a>\n    </li>\n    <% } %>\n    <% if(( !items || !items.length ) && App.allowed(\'zones.delete\')) {%>\n    <li>\n        <a href="#" data-action="group_delete"><%= i18n.removeZonesGroup %></a>\n    </li>\n    <% } %>\n<% } else {%>\n    <% if(App.allowed(\'zones.create\') || App.allowed(\'zones.edit\')) {%>\n    <li>\n        <a href="#" data-action="item_edit"><%= i18n.editZone.contextItem %></a>\n    </li>\n    <% } %>\n    <% if(App.allowed(\'zones.delete\')) {%>\n    <li>\n        <a href="#" data-action="item_delete"><%= i18n.removeZone %></a>\n    </li>\n    <% } %>\n<% } %>\n'}),define("text!_common/geozones/tree/tmpl/settings.html",[],function(){return'<li>\n    <h5 class="nav-header"><%= i18n.sort %></h5>\n    <ul class="options-list">\n        <li>\n            <label>\n                <input type="radio" name="sortBy" value="name"<% if(sortType == \'name\') {%> checked<% } %>>\n                <%= i18n.sortByZoneName %>\n            </label>\n        </li><li>\n            <label>\n                <input type="radio" name="sortBy" value="id"<% if(sortType == \'id\') {%> checked<% } %>>\n                <%= i18n.sortByZoneId %>\n            </label>\n        </li>\n    </ul>\n</li>\n<% if(App.allowed(\'zones.delete\')) {%>\n<li class="nav-delimiter">\n    <a href="#" data-action="item_delete_multi"><%= i18n.removeZones %></a>\n</li>\n<% } %>'}),define("text!_common/geozones/tree/tmpl/accessMenu.html",[],function(){return'<div class="box">\n    <div class="channels control-group">\n        <select name="<%= names[0] %>"\n            data-placeholder="<%= i18n.findUser %>"\n            class="input-block-level"\n            multiple\n        >\n        </select>\n    </div>\n    <div class="accessUsers">\n        <%= accessUsersHtml %>\n    </div>\n</div>\n'}),define("_common/geozones/tree/views/GeozonesTreeView",["jquery","underscore","jface","abstracts/tree/views/TreeView","text!../tmpl/title.html","text!../tmpl/type.html","text!../tmpl/contextMenu.html","text!../tmpl/settings.html","text!../tmpl/accessMenu.html"],function(e,t,n,o,i,s,r,a,l){var d=o.prototype;i=t.template(i),s=t.template(s),r=t.template(r),a=t.template(a),l=t.template(l);var c=t.template('<div class="btn-row"><a href="#" class="btn btn-primary btn-ok"><%= btns[0] %></a><a href="#" class="btn btn-cancel" ><%= btns[1] %></a></div>'),u=o.extend({constructor:function(){this._initAccessUserData(),this._popup=null,o.apply(this,arguments)},PARAM_CONFIGURE_ACCESS:"configure_access",_initAccessUserData:function(){this.accessUsers=[],this.accessUsersChildren=[],this.accessUsersSelected=[]},_getColumns:function(){return[{id:"name",name:"Name",field:"name",minWidth:10,maxWidth:2e3,width:300,cssClass:"cell-title",formatter:t.bind(this.titleFormatter,this)},{id:"nbItems",name:"",field:"nbItems",minWidth:50,width:70,maxWidth:70,cssClass:"cell-icon",formatter:t.bind(this.typeFormatter,this)}]},titleFormatter:function(e,n,o,s,r){return i(t.extend(r))},typeFormatter:function(e,n,o,i,r){return s(t.extend(r,{hasContext:this._contextAllowed(r),i18n:this.model.getTexts()}))},_bindEvents:function(){d._bindEvents.apply(this,arguments);var e=this,t=this.model.get("parent");this.listenTo(t,"groupremove itemremove",function(){e.$el.addClass("loading")}).listenTo(t,"groupremoved groupremoveerror itemremoved itemremoveerror",function(){e.$el.removeClass("loading")}).listenTo(t,"groupremoved",function(){e.model.groups.length||e._showNoData()}).listenTo(t,"configureaccess",function(t){e.showConfigureAccessModal(t)})},_buildSettingsMenu:function(){var e=this,t=this.model.getTexts();this.$el.closest(".tab-hor-content").find(".module-settings .dropdown-menu").append(a({sortType:this.model.get("sortType")||"name",i18n:t})).on("click",'a[data-action="item_delete_multi"]',function(){e.model.trigger("action","item_delete_multi")})},_getItemCSSClasses:function(e){var t=[];return e.isgroup&&t.push("group"),1===e.checked&&t.push("selected"),t},_contextAllowed:function(e){return 0==e.id?!1:e.isgroup?App.allowed("zones.create")||App.allowed("zones.edit")||(!e.items||!e.items.length)&&App.allowed("zones.delete"):App.allowed("zones.create")||App.allowed("zones.edit")||App.allowed("zones.delete")},_initContextMenu:function(){this._contextMenu=e(this._buildContextMenu()).appendTo("body"),this._contextMenu[0].id="gz-context",e.fn.contextmenu&&this._contextMenu.length&&this.$el.contextmenu({selector:".slick-row",menu:this._contextMenu,position:{my:"left top"},before:t.bind(function(n){var o=this._contextMenu,i=this.grid.getCellFromEvent(n.originalEvent),s="undefined"!=typeof i.row?i.row:null,r=this.grid.getData().getItem(s);this._contextAllowed(r)?(o.html(this._buildContextMenuItems(r)),o.off("click","").on("click","[data-action]",t.bind(function(t,n){var o=e(n.target).attr("data-action");this.model.trigger("action",o,t)},this,r))):n.preventDefault()},this)})},_buildContextMenuItems:function(e){return r(t.extend({},e,{i18n:this.model.getTexts()}))},closePopup:function(){this._popup&&(this._initAccessUserData(),this._popup.trigger("jw.close"),n.hideOverlay())},showConfigureAccessModal:function(e){this.popupGroupZone=e;var o=this,i=this.model.getTexts(),s={accessUsersHtml:m.getHtmlAccessUsers(this.accessUsers),i18n:i,names:[this.PARAM_CONFIGURE_ACCESS]};this.closePopup(),n.showOverlay(),n.window.open({addClass:"win-configure-access",headerHtml:i.configureAccess,contentHtml:l(t.extend({},s)),footerHtml:c({btns:["Ok",i.cancel]}),dieAfter:0,centered:!0,width:350,openCallback:function(){o._popup=this,o._popup.addClass("loading"),m.loadZoneUsers(e).done(function(e,t){o.accessUsersChildren=e[0],o.accessUsers=t[0],m.rerenderConfigureAccessModal.call(o)}).always(function(){o._popup.removeClass("loading")})},showCallback:function(){var e=o._popup;e.on("click",".btn-ok",function(){m.saveAccessUsers.call(o)}).on("click",".btn-cancel",function(){o.closePopup()}).on("click",".accessUsers_item_remove",function(e){e.preventDefault();var t=e&&e.target,n=t&&t.parentElement,i=n&&n.dataset&&+n.dataset.id;if(i&&Array.isArray(o.accessUsers)){var s=o.accessUsers.find(function(e){return e.id===i});s&&(s.remove=!0),m.renderAccessUsers.call(o,o._popup,o.accessUsers)}})},closeCallback:function(){o.closePopup()}})}}),m={saveAccessUsers:function(){var t=this,n=t.popupGroupZone&&t.popupGroupZone.id;if("undefined"==typeof n||n===!1||!Array.isArray(t.accessUsersSelected)||!Array.isArray(t.accessUsers))return t.closePopup(),void 0;t._popup.addClass("loading");var o=[],i=App.getBaseUrl(),s=i+"zones-groups/bind-to-user/",r=i+"zones-groups/unbind-from-user/";t.accessUsers.forEach(function(t){t.remove&&o.push(e.ajax({url:r,data:{userId:t.id,zoneGroupId:n}}))}),t.accessUsersSelected.forEach(function(t){o.push(e.ajax({url:s,data:{userId:t,zoneGroupId:n}}))}),e.when(o).always(function(){t._popup.removeClass("loading"),t.closePopup()})},rerenderConfigureAccessModal:function(){m.initConfigureAccessMultiSelects.call(this),m.renderAccessUsers.call(this)},loadZoneUsers:function(t){if(!t||!t.id)return e.when;var n=[e.ajax({url:App.getBaseUrl()+"users/children/"}),e.ajax({url:App.getBaseUrl()+"zones-groups/get-users/",data:{zoneGroupId:t.id}})];return e.when.apply(null,n)},initConfigureAccessMultiSelects:function(){var e=this,t=e._popup,n=this.PARAM_CONFIGURE_ACCESS,o=t.find("select[name="+n+"]");m.renderAccessList.call(this,o,this.accessUsersChildren,this.accessUsersSelected),o.chosen(m.getChosenOptions.call(this)),o.on("change",function(){e.accessUsersSelected=m.getSelectValues(o)})},canRemoveUser:function(e,n){return-1!==t.indexOf(n,e)?!0:!1},getHtmlAccessUsers:function(){var e="",n=this.accessUsers,o=t.map(this.accessUsersChildren,function(e){return e.username});return t.each(n,function(t){if(!t.remove){var n=m.canRemoveUser(t.username,o)?'<span class="accessUsers_item_remove">&#10006;</span>':"";e+='<div data-id="'+t.id+'" class="accessUsers_item">'+"<span>"+t.username+"</span>"+n+"</div>"}}),e},renderAccessUsers:function(e){var e=this._popup,t=m.getHtmlAccessUsers.call(this),n=e.find(".accessUsers");n.html(t)},renderAccessList:function(e,n,o){o=o||m.getSelectValues(e);var i="",s=t.filter(this.accessUsers,function(e){return!e.remove}),r=t.map(s,function(e){return e.id});t.each(n,function(e){if(null===e)return"<option></option>";var n=t.indexOf(o,e.id)>-1?" selected":"",s=t.indexOf(r,e.id)>-1?" disabled":"";i+='<option value="'+e.id+'"'+n+s+">"+e.username+"</option>"}),e.html(i),e.data("chosen")&&e.trigger("chosen:updated")},getSelectValues:function(e){var n=e.val()||[];return t.map(n,function(e){return Number(e)})},getChosenOptions:function(){return{disable_search:!1,disable_search_threshold:10,no_results_text:this.model.getTexts().searchNoResults}}};return u}),define("_common/geozones/tree/GeozonesTreeModule",["jquery","underscore","jface","abstracts/tree/TreeModule","_common/geozones/GeozonesCollection","_common/geozones/GeozonesGroupsCollection","_common/geozones/tree/views/GeozonesTreeView"],function(e,t,n,o,i,s,r){var a=o.extend({constructor:function(){this.groups=new s,this.items=new i,this.searchCollection=new i,this.searchCollection.url=App.getBaseUrl()+"zones/search/",this._hasTopGroup=!1,o.apply(this,arguments)},defaults:t.extend({},o.prototype.defaults,{propertyId:"geozoneuid",sortType:"name",sortParam:"order",updating:!1}),url:App.getBaseUrl()+"zones-groups/zones-tree/",initialize:function(){this.get("parent"),this.set("sortType",this.getUserData("sortType")||"name"),this._openedGroups=this.getUserData("openedGroups")||[],this._view=new r({el:this.get("container"),model:this}),o.prototype.initialize.apply(this,arguments)},_bindEvents:function(){var e=this,t=this.get("parent");o.prototype._bindEvents.call(this),this.on("action",function(o,i){var s=e.getTexts(),r="",a="";switch(o){case"group_delete":var l=e.groups.get(i.id);r=s.confirm.deleteGroup,a=r.text+' <strong>"'+l.get("name")+'"</strong>',n.confirm(a,r.header,{okCallback:function(){e.getParent().trigger("groupremove",l)}});break;case"configure_access":var l=e.groups.get(i.id);t.trigger("configureaccess",l);break;case"item_edit":t.trigger("itemedit",e.items.get(i.id));break;case"item_delete":var d=e.items.get(i.id);r=s.confirm.delete,a=r.text+' <strong>"'+d.get("name")+'"</strong>',n.confirm(a,r.header,{okCallback:function(){t.trigger("itemremove",d)}});break;case"item_delete_multi":var c=t.getSelectedItemsIds();c.length&&(r=s.confirm.deleteMulti,a=r.text,n.confirm(a,r.header,{okCallback:function(){for(var n=c.length;n--;)t.trigger("itemremove",e.items.get(c[n]))}}))}}).listenTo(t,"groupremoved",function(t){e.groups.remove(t),e.dataView.deleteItem(t)}).listenTo(t,"itemadded",function(t){e._addItemToTree(t)}).listenTo(t,"itemremoved",function(t){e._removeItemFromTree(t,t.get("groupId"))})},_clearTree:function(){this.treeData=[],this.groups=new s,this.items=new i},buildItemTitle:function(e){return e.name},_each:function(e,n,o,i){o="undefined"!=typeof o?o:0,i=0===o?null:i;for(var s=0,r=e.length;r>s;++s){var a=e[s],l="undefined"!=typeof a.items;l&&(a.objs=t.clone(a.items),a.nbItems=a.objs.length,delete a.items),n(a,l,o,i),l&&(this._each(a.objs,n,o+1,a),delete a.objs)}},_copyParams:function(e,n){t.each(["name","type","points","groupId"],function(t){"undefined"!=typeof e[t]&&(n[t]=e[t])})},_onItemChange:function(e){var n=this,o=this._getObjectItemsByIDs(t.pluck(e,"id")),i=null;t.each(o,function(o){i=t.findWhere(e,{id:o.id}),n._copyParams(i,o);var s;if(s=n.items.get(o.id)){s.set(s.parse(i));var r=s.previous("groupId");r!=i.groupId&&(n._removeItemFromTree(s,r,!0),n._addItemToTree(s))}}),this._view.refreshGrid()},_updateObjectModel:function(e){var t=this.items.get(e.id);return t&&t.set({name:e.name,type:e.type}),t},_removeItemFromTree:function(e,n,o){var i=e.id,o=o||!1,s=this.get("propertyId"),r=this.groups.get(n),a=this.getTreeGroupById(r.id);if(a){var l=this._getObjectItemsByIDs(i),d=l[0],c=d[s];d.checked&&!o&&this.trigger("toggleselect",d),this.dataView.deleteItem(c),a.nbItems--,a.items=t.without(a.items,c),r.set({nbItems:r.get("nbItems")-1,items:a.items,objs:t.filter(r.get("objs"),function(e){return e.id!=i})}),a.nbItems<1?(a.closed=!0,a.checked=0,r.set({checked:0,closed:!0}),this.trigger("group.collapse",r)):this._setGroupStatus(r.id),this.dataView.updateItem(a[s],a),!o&&this.items.remove(i)}},_addItemToTree:function(e){var n=e.toJSON(),o=this.get("propertyId"),i=this.groups.get(e.get("groupId")),s=this.getTreeGroupById(i.id);if(s){s.closed&&(s.closed=!1,i.set("closed",!1),this.trigger("group.expand",i));var r;r=s.items.length>1?this.dataView.getIdxById(t.last(s.items)):this.dataView.getIdxById(s[o]),this.prepareTreeObject(n,!1,1,s,n.checked),this.dataView.insertItem(r+1,n),s.nbItems++,s.items.push(n[o]),i.set("nbItems",i.get("nbItems")+1),i.get("objs").push(n),this._setObjectsCheckedStatus(n.checked?e.id:[],n.checked?[]:e.id),this._view.refreshGrid()}}});return a});