var PRODUCTION=!0;if(define("_common/tracks/TrackParkPoint",["underscore","util","geo"],function(t,e,n){var i=function(t){n.Point.call(this,t),this.geoId=t.geoId||0,this.address=t.address||"",this.start=new Date(1e3*t.start),this.end=new Date(1e3*t.end)};return e.extend(i,n.Point),i}),define("text!_common/tracks/tmpl/track.gpx",[],function(){return'<?xml version="1.0" encoding="UTF-8"?>\n<gpx xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.0"\nxmlns="http://www.topografix.com/GPX/1/0" creator="glebpl"\nxsi:schemaLocation="http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd">\n  <time>2011-09-22T18:56:51Z</time>\n  <trk>\n    <name>test track</name>\n    <trkseg>\n      <% _.each(points, function(point){%>\n      <trkpt lat="<%= point.lat %>" lon="<%= point.lon %>">\n        <time><% print(Date.format(dateFormat, point.date * App.MS)) %>Z</time>\n      </trkpt>\n      <% })%>\n    </trkseg>\n  </trk>\n</gpx>'}),define("_common/tracks/Track",["underscore","moment","abstracts/Model","geo","_common/tracks/TrackParkPoint","text!_common/tracks/tmpl/track.gpx"],function(t,e,n,i,s,a){e.locale(App.getLocale().substr(0,2));var o=n.extend({constructor:function(){this._indexed=!1,this._minLat=90,this._minLon=180,this._maxLat=-90,this._maxLon=-180,this._listView=null,n.apply(this,arguments)},url:function(){return App.getBaseUrl()+"reports/ROUTE/"},defaults:{name:"Track",objectId:null,startTime:0,endTime:0,points:[],parks:[],color:"#ff0000",hidden:!1,start:null,startFromPark:!1,finish:null,finishOnPark:!1},parse:function(t){var e={},n=this.get("objectId"),i=t.body[n];if(e.points=i.route||null,e.parks=null,i.parks&&i.parks.length){e.parks=[];for(var a=0,o=i.parks.length;o>a;a++)e.parks.push(new s(i.parks[a]))}return e.startTime=1e3*t.header.sd,e.endTime=1e3*t.header.ed,e},initialize:function(){var t=this;this.on("sync",function(){r.index.call(t)})},hasData:function(){var t,e;return(e=this.get("points"))&&e.length||(t=this.get("parks"))&&t.length},clear:function(){this._view&&this._view.clear()},getBounds:function(){if(!this.get("points")||!this.get("points").length){if(!this.has("parks")||!this.get("parks").length)return null;var t=this.get("parks")[0];return{maxLat:t.lat,minLon:t.lon,minLat:t.lat,maxLon:t.lon}}return this._indexed||r.index.call(this),{maxLat:this._maxLat,minLon:this._minLon,minLat:this._minLat,maxLon:this._maxLon}},toGPX:function(){var e="Y-m-dTH:i:s",n=t.template(a,{points:this.get("points"),dateFormat:e});return n},getView:function(){return this._view},formatUTC:function(t,n){var i=App.getTimezone({id:this.get("tzId")}),s=e(n).utcOffset(i.offset);return s.format(t,n)},formatDateTime:function(t){return this.formatUTC("DD.MM.YYYY HH:mm:ss",t instanceof Date?t:t*App.MS)},destroy:function(){this.collection&&this.collection.remove(this)}}),r={index:function(){if(!this._indexed){if(r.findStartAndFinish.call(this),this.get("points")&&this.get("points").length)for(var t=0,e=0,n=this.get("points"),i=n.length,s=0;i>s;++s)e=n[s].lon,t=n[s].lat,t>this._maxLat&&(this._maxLat=t),t<this._minLat&&(this._minLat=t),e>this._maxLon&&(this._maxLon=e),e<this._minLon&&(this._minLon=e);else if(this.get("start")&&this.get("start")==this.get("finish")){var a=this.get("start");this._maxLat=this._minLat=a.lat,this._maxLon=this._minLon=a.lon}this._indexed=!0}},findStartAndFinish:function(){var t=this.get("points"),e=this.get("parks"),n=t.length,i=!1,s=!1;if(e&&e.length){if((!t[0]||e[0].start.getTime()<=t[0].date*App.MS)&&(i=!0),(!n||e.length&&e[e.length-1].end.getTime()>=t[n-1].date*App.MS)&&(s=!0),this.set("startFromPark",i),this.set("finishOnPark",s),1==e.length&&i&&s)return this.set("start",e[0]),this.set("finish",e[0]),this.set("points",[]),void 0;i&&this.set("start",e[0]),s&&this.set("finish",e[e.length-1])}!this.get("start")&&this.set("start",t[0]),!this.get("finish")&&this.set("finish",t[n-1])}};return o}),define("_common/tracks/TracksCollection",["underscore","abstracts/Collection","_common/tracks/Track"],function(t,e){var n=e.extend({constructor:function(){e.apply(this,arguments)},url:function(){return App.getBaseUrl()+"reports/ROUTE/"},initialize:function(){this.on("add",function(){})}});return n}),"function"!=typeof Blob&&"object"!=typeof Blob||"undefined"==typeof URL)if("function"!=typeof Blob&&"object"!=typeof Blob||"undefined"==typeof webkitURL)var Blob=function(t){var e=t.BlobBuilder||t.WebKitBlobBuilder||t.MozBlobBuilder||t.MSBlobBuilder||function(t){var e=function(t){return Object.prototype.toString.call(t).match(/^\[object\s(.*)\]$/)[1]},n=function(){this.data=[]},i=function(t,e,n){this.data=t,this.size=t.length,this.type=e,this.encoding=n},s=n.prototype,a=i.prototype,o=t.FileReaderSync,r=function(t){this.code=this[this.name=t]},l="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),c=l.length,d=t.URL||t.webkitURL||t,u=d.createObjectURL,h=d.revokeObjectURL,m=d,p=t.btoa,f=t.atob,g=t.ArrayBuffer,v=t.Uint8Array;for(i.fake=a.fake=!0;c--;)r.prototype[l[c]]=c+1;return d.createObjectURL||(m=t.URL={}),m.createObjectURL=function(t){var e,n=t.type;return null===n&&(n="application/octet-stream"),t instanceof i?(e="data:"+n,"base64"===t.encoding?e+";base64,"+t.data:"URI"===t.encoding?e+","+decodeURIComponent(t.data):p?e+";base64,"+p(t.data):e+","+encodeURIComponent(t.data)):u?u.call(d,t):void 0},m.revokeObjectURL=function(t){"data:"!==t.substring(0,5)&&h&&h.call(d,t)},s.append=function(t){var n=this.data;if(v&&(t instanceof g||t instanceof v)){for(var s="",a=new v(t),l=0,c=a.length;c>l;l++)s+=String.fromCharCode(a[l]);n.push(s)}else if("Blob"===e(t)||"File"===e(t)){if(!o)throw new r("NOT_READABLE_ERR");var d=new o;n.push(d.readAsBinaryString(t))}else t instanceof i?"base64"===t.encoding&&f?n.push(f(t.data)):"URI"===t.encoding?n.push(decodeURIComponent(t.data)):"raw"===t.encoding&&n.push(t.data):("string"!=typeof t&&(t+=""),n.push(unescape(encodeURIComponent(t))))},s.getBlob=function(t){return arguments.length||(t=null),new i(this.data.join(""),t,"raw")},s.toString=function(){return"[object BlobBuilder]"},a.slice=function(t,e,n){var s=arguments.length;return 3>s&&(n=null),new i(this.data.slice(t,s>1?e:this.data.length),n,this.encoding)},a.toString=function(){return"[object Blob]"},n}(t);return function(t,n){var i=n?n.type||"":"",s=new e;if(t)for(var a=0,o=t.length;o>a;a++)s.append(t[a]);return s.getBlob(i)}}(self);else self.URL=webkitURL;var saveAs=saveAs||navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(t){var e=t.document,n=function(){return t.URL||t.webkitURL||t},i=t.URL||t.webkitURL||t,s=e.createElementNS("http://www.w3.org/1999/xhtml","a"),a=!t.externalHost&&"download"in s,o=function(n){var i=e.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,t,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i)},r=t.webkitRequestFileSystem,l=t.requestFileSystem||r||t.mozRequestFileSystem,c=function(e){(t.setImmediate||t.setTimeout)(function(){throw e},0)},d="application/octet-stream",u=0,h=[],m=function(){for(var t=h.length;t--;){var e=h[t];"string"==typeof e?i.revokeObjectURL(e):e.remove()}h.length=0},p=function(t,e,n){e=[].concat(e);for(var i=e.length;i--;){var s=t["on"+e[i]];if("function"==typeof s)try{s.call(t,n||t)}catch(a){c(a)}}},f=function(e,i){var c,m,f,g=this,v=e.type,k=!1,b=function(){var t=n().createObjectURL(e);return h.push(t),t},y=function(){p(g,"writestart progress write writeend".split(" "))},_=function(){(k||!c)&&(c=b(e)),m?m.location.href=c:window.open(c,"_blank"),g.readyState=g.DONE,y()},w=function(t){return function(){return g.readyState!==g.DONE?t.apply(this,arguments):void 0}},T={create:!0,exclusive:!1};return g.readyState=g.INIT,i||(i="download"),a?(c=b(e),s.href=c,s.download=i,o(s),g.readyState=g.DONE,y(),void 0):(t.chrome&&v&&v!==d&&(f=e.slice||e.webkitSlice,e=f.call(e,0,e.size,d),k=!0),r&&"download"!==i&&(i+=".download"),(v===d||r)&&(m=t),l?(u+=e.size,l(t.TEMPORARY,u,w(function(t){t.root.getDirectory("saved",T,w(function(t){var n=function(){t.getFile(i,T,w(function(t){t.createWriter(w(function(n){n.onwriteend=function(e){m.location.href=t.toURL(),h.push(t),g.readyState=g.DONE,p(g,"writeend",e)},n.onerror=function(){var t=n.error;t.code!==t.ABORT_ERR&&_()},"writestart progress write abort".split(" ").forEach(function(t){n["on"+t]=g["on"+t]}),n.write(e),g.abort=function(){n.abort(),g.readyState=g.DONE},g.readyState=g.WRITING}),_)}),_)};t.getFile(i,{create:!1},w(function(t){t.remove(),n()}),w(function(t){t.code===t.NOT_FOUND_ERR?n():_()}))}),_)}),_),void 0):(_(),void 0))},g=f.prototype,v=function(t,e){return new f(t,e)};return g.abort=function(){var t=this;t.readyState=t.DONE,p(t,"abort")},g.readyState=g.INIT=0,g.WRITING=1,g.DONE=2,g.error=g.onwritestart=g.onprogress=g.onwrite=g.onabort=g.onerror=g.onwriteend=null,t.addEventListener("unload",m,!1),v}(self);"undefined"!=typeof module&&(module.exports=saveAs),define("_libs/fileSaver/FileSaver",function(){}),define("text!_common/tracks/tmpl/trackListItem.html",[],function(){return'<div class="content clearfix">\n    <h4>\n        <a data-item="<%= id %>" href="javascript:;" title="<%= i18n.zoomToTrack %>"><%- name%></a>\n        <div class="indicator hidden"></div>\n    </h4>\n    <p class="no-data"><%= i18n.noDataForPeriod %></p>\n    <p class="dates">\n        <span class="nobr"><% print(Date.format(i18n.DateTime.longFormat, startTime))%></span> - <span class="nobr"><% print(Date.format(i18n.DateTime.longFormat, endTime))%></span>\n        <% if(tzName) {%>\n        <br /><%= tzName %>\n        <% } %>\n    </p>\n    <a data-item="<%= id %>" href="javascript:;" class="export nobr hidden"><%= i18n.saveAsPlt %></a>\n</div>\n<div class="controls">\n    <% if(player){ %>\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-play play-track hidden hint hint-left"\n       data-hint="<%= i18n.trackPlayer %>"></i>\n    <% } %>\n\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-paint color-track hint hint-left"\n       data-hint="<%= i18n.changeColor %>"></i>\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-show toggle-track on hint hint-left"\n       data-hint="<%= i18n.showTrack %>"></i>\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-hide toggle-track off hint hint-left"\n       data-hint="<%= i18n.hideTrack %>"></i>\n    <!--<i data-item="<%= id %>" class="icon icon-edit"></i>-->\n    <i data-item="<%= id %>"\n       class="svg-icon svg-icon-remove remove-track hint hint-left"\n       data-hint="<%= i18n.removeFromMap %>"></i>\n\n</div>\n<div class="clear"></div>'}),jQuery.fn.farbtastic=function(t){return $.farbtastic(this,t),this},jQuery.farbtastic=function(t,e){var t=$(t);if(t.data("farbtastic"))return t.data("farbtastic");var n=new jQuery._farbtastic(t,e);return t.data("farbtastic",n),n},jQuery._farbtastic=function(t,e){var n=this;$(t).html('<div class="farbtastic"><div class="color"></div><div class="wheel"></div><div class="overlay"></div><div class="h-marker marker"></div><div class="sl-marker marker"></div></div>');var i=$(".farbtastic",t);n.wheel=$(".wheel",t).get(0),n.radius=84,n.square=100,n.width=194,navigator.appVersion.match(/MSIE [0-6]\./)&&$("*",i).each(function(){if("none"!=this.currentStyle.backgroundImage){var t=this.currentStyle.backgroundImage;t=this.currentStyle.backgroundImage.substring(5,t.length-2),$(this).css({backgroundImage:"none",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+t+"')"})}}),n.linkTo=function(t){return"object"==typeof n.callback&&$(n.callback).unbind("keyup",n.updateValue),n.color=null,"function"==typeof t?n.callback=t:("object"==typeof t||"string"==typeof t)&&(n.callback=$(t),n.callback.bind("keyup",n.updateValue),n.callback.get(0).value&&n.setColor(n.callback.get(0).value)),this},n.updateValue=function(){this.value&&this.value!=n.color&&n.setColor(this.value)},n.setColor=function(t){var e=n.unpack(t);return n.color!=t&&e&&(n.color=t,n.rgb=e,n.hsl=n.RGBToHSL(n.rgb),n.updateDisplay()),this},n.setHSL=function(t){return n.hsl=t,n.rgb=n.HSLToRGB(t),n.color=n.pack(n.rgb),n.updateDisplay(),this},n.widgetCoords=function(t){var e,i,s=t.target||t.srcElement,a=n.wheel;if("undefined"!=typeof t.offsetX){for(var o={x:t.offsetX,y:t.offsetY},r=s;r;)r.mouseX=o.x,r.mouseY=o.y,o.x+=r.offsetLeft,o.y+=r.offsetTop,r=r.offsetParent;for(var r=a,l={x:0,y:0};r;){if("undefined"!=typeof r.mouseX){e=r.mouseX-l.x,i=r.mouseY-l.y;break}l.x+=r.offsetLeft,l.y+=r.offsetTop,r=r.offsetParent}for(r=s;r;)r.mouseX=void 0,r.mouseY=void 0,r=r.offsetParent}else{var o=n.absolutePosition(a);e=(t.pageX||0*(t.clientX+$("html").get(0).scrollLeft))-o.x,i=(t.pageY||0*(t.clientY+$("html").get(0).scrollTop))-o.y}return{x:e-n.width/2,y:i-n.width/2}},n.mousedown=function(t){document.dragging||($(document).bind("mousemove",n.mousemove).bind("mouseup",n.mouseup),document.dragging=!0);var e=n.widgetCoords(t);return n.circleDrag=2*Math.max(Math.abs(e.x),Math.abs(e.y))>n.square,n.mousemove(t),!1},n.mousemove=function(t){var e=n.widgetCoords(t);if(n.circleDrag){var i=Math.atan2(e.x,-e.y)/6.28;0>i&&(i+=1),n.setHSL([i,n.hsl[1],n.hsl[2]])}else{var s=Math.max(0,Math.min(1,-(e.x/n.square)+.5)),a=Math.max(0,Math.min(1,-(e.y/n.square)+.5));n.setHSL([n.hsl[0],s,a])}return!1},n.mouseup=function(){$(document).unbind("mousemove",n.mousemove),$(document).unbind("mouseup",n.mouseup),document.dragging=!1},n.updateDisplay=function(){var t=6.28*n.hsl[0];$(".h-marker",i).css({left:Math.round(Math.sin(t)*n.radius+n.width/2)+"px",top:Math.round(-Math.cos(t)*n.radius+n.width/2)+"px"}),$(".sl-marker",i).css({left:Math.round(n.square*(.5-n.hsl[1])+n.width/2)+"px",top:Math.round(n.square*(.5-n.hsl[2])+n.width/2)+"px"}),$(".color",i).css("backgroundColor",n.pack(n.HSLToRGB([n.hsl[0],1,.5]))),"object"==typeof n.callback?($(n.callback).css({backgroundColor:n.color,color:n.hsl[2]>.5?"#000":"#fff"}),$(n.callback).each(function(){this.value&&this.value!=n.color&&(this.value=n.color)})):"function"==typeof n.callback&&n.callback.call(n,n.color)},n.absolutePosition=function(t){var e={x:t.offsetLeft,y:t.offsetTop};if(t.offsetParent){var i=n.absolutePosition(t.offsetParent);e.x+=i.x,e.y+=i.y}return e},n.pack=function(t){var e=Math.round(255*t[0]),n=Math.round(255*t[1]),i=Math.round(255*t[2]);return"#"+(16>e?"0":"")+e.toString(16)+(16>n?"0":"")+n.toString(16)+(16>i?"0":"")+i.toString(16)},n.unpack=function(t){return 7==t.length?[parseInt("0x"+t.substring(1,3))/255,parseInt("0x"+t.substring(3,5))/255,parseInt("0x"+t.substring(5,7))/255]:4==t.length?[parseInt("0x"+t.substring(1,2))/15,parseInt("0x"+t.substring(2,3))/15,parseInt("0x"+t.substring(3,4))/15]:void 0},n.HSLToRGB=function(t){var e,n,i=t[0],s=t[1],a=t[2];return n=.5>=a?a*(s+1):a+s-a*s,e=2*a-n,[this.hueToRGB(e,n,i+.33333),this.hueToRGB(e,n,i),this.hueToRGB(e,n,i-.33333)]},n.hueToRGB=function(t,e,n){return n=0>n?n+1:n>1?n-1:n,1>6*n?t+6*(e-t)*n:1>2*n?e:2>3*n?t+6*(e-t)*(.66666-n):t},n.RGBToHSL=function(t){var e,n,i,s,a,o,r=t[0],l=t[1],c=t[2];return e=Math.min(r,Math.min(l,c)),n=Math.max(r,Math.max(l,c)),i=n-e,o=(e+n)/2,a=0,o>0&&1>o&&(a=i/(.5>o?2*o:2-2*o)),s=0,i>0&&(n==r&&n!=l&&(s+=(l-c)/i),n==l&&n!=c&&(s+=2+(c-r)/i),n==c&&n!=r&&(s+=4+(r-l)/i),s/=6),[s,a,o]},$("*",i).mousedown(n.mousedown),n.setColor("#000000"),e&&n.linkTo(e)},define("_libs/farbtastic/farbtastic",function(){}),define("_common/tracks/views/TrackListView",["jquery","underscore","abstracts/View","_libs/fileSaver/FileSaver","text!_common/tracks/tmpl/trackListItem.html","_libs/farbtastic/farbtastic","css!_libs/farbtastic/farbtastic.css"],function(t,e,n,i,s){s=e.template(s);var a=n.extend({constructor:function(){this._module=null,n.apply(this,arguments)},initialize:function(t){var e=this;t.container&&(this._module=t.module,this.listenTo(this.model,"request",function(){e.$el.addClass("loading")}).listenTo(this.model,"sync",function(){e.$el.removeClass("loading");var n=e.$el.find("h4");if(e.model.hasData()){var i=e.$el.find(".indicator").removeClass("hidden");i[0].style.background=e.model.get("color"),"Blob"in window&&(e.$el.find(".export").removeClass("hidden"),t.player&&e.model.get("points")&&e.model.get("points").length>1&&e.$el.find(".play-track").removeClass("hidden"))}else e.$el.addClass("no-data"),n.find(".indicator").remove(),n.find("a").removeAttr("title")}).listenTo(this.model,"remove",function(){e.stopListening(e.model),e.remove()}).listenTo(this.model,"change:hidden",function(t,n){n?e.$el.addClass("h"):e.$el.removeClass("h")}).listenTo(this.model,"change:color",function(t,n){e.$el.find(".indicator")[0].style.background=n}),this.render(t))},render:function(e){var n="";if(this.model.has("tzId")){var i=App.getTimezone({id:this.model.get("tzId")});i.offset!=60*App.getUserTimezone()&&(n=App.getFullTimezoneName(i))}var a=s(t.extend({},this.model.attributes,{i18n:this._module.getTexts(),tzName:n,player:e.player}));this.$el.append(a).appendTo(e.container),this._initColorPicker()},_initColorPicker:function(){var e=this,n=this.$el.find(".indicator")[0],i=e.$el.parent(),s=40,a="track-picker",o=t(window);this.$el.find(".color-track").on("click",function(r){r.stopPropagation();var l=e.model.get("color"),c=e.$el.position();t("#"+a).remove();var d=t('<div id="'+a+'" class="colorpicker"></div>').appendTo(i),u=c.top+s,h=i[0].getBoundingClientRect().top,m=195,p=o.height();p>u+h+m?d[0].style.top=u+"px":(i.parent().scrollTo(1e4),d[0].style.top=p-m-h+"px"),d.farbtastic(function(t){n.style.background=t}).on("click",function(t){t.stopPropagation()});var f=d.data("farbtastic").setColor(l);d.on("mouseup",function(){l!=f.color&&e.model.set("color",f.color)}),t(document).one("click",function(){d.remove()})})}});return a}),define("text!_common/tracks/player/tmpl/player.html",[],function(){return'<div class="player-map">\n\n</div>\n'}),define("text!_common/tracks/player/tmpl/controls.html",[],function(){return'<div class="player-main-params">\n    <table>\n        <tbody>\n        <tr>\n            <td class="th" rowspan="2" style="width:60px">\n                <input class="index input-mini no-margin" type="number" min="0" max="<%= totalPoints-1 %>" value="0" />\n            </td>\n            <td class="th"><%= i18n.time %></td>\n            <td class="th"><%= i18n.coords %></td>\n            <td class="th"><%= i18n.runDistance %>, <%= i18n.km %></td>\n            <td class="th"><%= i18n.speed %>, <%= i18n.kmh %></td>\n            <td class="th"><%= i18n.course %></td>\n            <td class="th"><%= i18n.altitude %>, <%= i18n.m %></td>\n        </tr>\n        <tr>\n            <td class="ts"><%= Date.format(i18n.DateTime.longFormat, point.date * App.MS) %></td>\n            <td class="coords">--</td>\n            <td class="distance">0.00</td>\n            <td class="speed"><% print( point.speed <= minMoveSpeed ? 0 : Math.round(point.speed) ) %></td>\n            <td class="course"><%= point.course %></td>\n            <td class="alt"><%= point.alt %></td>\n        </tr>\n        </tbody>\n    </table>\n\n</div><!--/obj-info-->\n\n<div class="player-row-fluid">\n    <div class="player-col player-col-left">\n        <div class="player-buttons">\n            <button class="btn btn-to-start"><i class="icon-step-backward"></i></button>\n            <button class="btn btn-toggle btn-play"><i class="icon-play"></i><i class="icon-pause"></i></button>\n        </div>\n        <div class="slider play-speed" title="<%= i18n.trackPlaySpeed %>"></div>\n        <div class="player-point-info"></div>\n    </div>\n    <div class="player-col player-col-right">\n        <div class="play-progress">\n            <span class="time time-start"><%= startTime %></span>\n            <span class="index-finish"><%= totalPoints-1 %></span>\n            <span class="time time-finish"><%= finishTime %></span>\n            <div class="slider"></div>\n        </div>\n        <div class="chart-cont">\n            <div class="sensors-chart"></div>\n        </div>\n    </div>\n</div>\n'}),define("text!_common/tracks/player/tmpl/sensors.html",[],function(){return'<ul class="player-sensors-list">\n    <% _.each(discrets, function(sensorData) { %>\n    <li class="player-sensors-list-item discret <% if(sensorData.state) {%>on<% } else {%>off<% } %>">\n        <%- sensorData.name %>\n    </li>\n    <% }); %>\n    <li class="player-sensors-list-item power <% if(power.state === 0) {%>on<% } else {%>off<% } %>">\n        <%- power.name %>\n    </li>\n</ul>'}),define("_common/tracks/player/views/TrackPlayerView",["jquery","jqueryui","underscore","jface","geo","_libs/charts/Chart","abstracts/View","maps/MapsModule","text!_common/tracks/player/tmpl/player.html","text!_common/tracks/player/tmpl/controls.html","text!_common/tracks/player/tmpl/sensors.html"],function(t,e,n,i,s,a,o,r,l,c,d){l=n.template(l),c=n.template(c),d=n.template(d);var u,h=300,m="DD.MM HH:mm:ss",p={},f=null,g=null,v=null,k=null,b=null,y=o.extend({constructor:function(){this.module=null,this.playing=!1,this._mapsModule=null,this._tracksModule=null,this._ts=[],this._tsIndexes={},this._playTimeout=null,this._slider=null,this._btnPlay=null,this._btnToStart=null,this._speedSlider=null,this._chart=null,o.apply(this,arguments)},initialize:function(t){this.module=t.module,p=t.module.getTexts(),this._i=0,this.render(t)},render:function(t){var e=this,n=this.model,s=n.get("points"),a=this.model.formatUTC(m,n.get("startTime")),o=this.model.formatUTC(m,n.get("endTime"));v=this.model.get("obj"),i.showOverlay(),i.window.open({winId:"track-player",headerHtml:v.get("name")+"[#"+v.get("extId")+"] "+a+"-"+o,contentHtml:l({i18n:p}),footerHtml:c({i18n:p,minMoveSpeed:v.get("minSpeed"),totalPoints:s.length,startTime:a,finishTime:o,point:s[0]}),width:1e3,centered:!0,dieAfter:0,openCallback:function(){e.setElement(this),e.$el.addClass("loading")},activateCallback:function(){_.initMap.call(e),_.fillTimestamps.call(e),App.subscribe(f.getEventsPrefix()+".ready",{context:e,callback:function(){setTimeout(function(){_.initTracksModule.call(e,t),_.drawTrack.call(e).done(function(){_.drawObject.call(e),_.initControls.call(e),_.buildSensorsChart.call(e),e.$el.removeClass("loading")})},500)}})},closeCallback:function(){i.hideOverlay(),_.onClose.call(e)}})},play:function(){var t=this,e=this.model.get("points"),n=e[this._i];return this.playing=!0,"undefined"==typeof e[++this._i]?(this._i--,this.pause(),!1):(_.setStateInPoint.call(this,n),_.moveOnMap.call(t,n,e[this._i]).done(function(){t._slider.slider("value",t._ts[t._i]),_.showPointInfo.call(t,t._i,e[t._i]),t.play()}),!0)},pause:function(){this.playing&&(this._playTimeout&&clearTimeout(this._playTimeout),this._playTimeout=null,this._btnPlay.removeClass("btn-pause").addClass("btn-play"),b&&b.trigger("stop"),this.playing=!1)},jump:function(t){var e={model:v,to:t,animate:!1};_.setStateInPoint.call(this,t),b.trigger("place",e),b.trigger("follow",{center:[t.lat,t.lon]})},clear:function(){},destroy:function(){this.$el.length&&this.$el.trigger("jw.close"),this.remove()}}),_={initMap:function(){f=new r({id:this.module.id+"/maps",container:this.$el.find(".player-map"),parent:this.module,compass:!0,ruler:!0,search:!1,traffic:!1,coords:!1,scale:!0,minimap:!1,layersControl:!0})},fillTimestamps:function(){var t=this.model.get("points");this._ts=new Array(t.length);for(var e=0,n=t.length;n>e;e++)this._ts[e]=t[e].date*App.MS,this._tsIndexes[this._ts[e]]=e},initTracksModule:function(t){g=t.tracksModule,g.setMaps(f)},initControls:function(){for(var e=this,n=this.model.get("points"),i=this._ts,s=this._tsIndexes,a=0,o=n.length;o>a;a++)i[a]=n[a].date*App.MS,s[i[a]]=a;this._slider=this.$el.find(".play-progress .slider").slider({min:i[0],max:i[o-1],stepValues:i,start:function(){e.pause()},slide:function(a,r){s[r.value];var l,c=[],d=i[o-1]-i[0];return t.each(i,function(t,e){c[t]=Math.abs(r.value-e),c[t]<d&&(d=c[t],l=t)}),d?(t(this).slider("value",i[l]),_.showPointInfo.call(e,l,n[l]),!1):void 0},stop:function(t,i){e._i=s[i.value],e.jump(n[e._i])}}),this.$el.find(".index").on("change",function(){var t=parseInt(this.value);_.forcePoint.call(e,t,n[t])}),this._btnPlay=this.$el.find(".btn-toggle").on("click",function(){e.playing?(e.pause(),e._btnPlay.addClass("btn-play").removeClass("btn-pause")):e.play()&&e._btnPlay.removeClass("btn-play").addClass("btn-pause")}),this._btnToStart=this.$el.find(".btn-to-start").on("click",function(){_.forcePoint.call(e,0,n[0])}),this._speedSlider=this.$el.find(".play-speed").slider({min:5,max:50,step:5,value:this.module.get("playSpeed"),stop:function(t,n){e.module.set("playSpeed",n.value),e.playing&&(e.pause(),e._btnPlay.removeClass("btn-play").addClass("btn-pause"),e.play())}})},drawTrack:function(){var e=this,n=new t.Deferred,i={objectId:[v.id],from:Date.sqlFormat(this.model.get("startTime")),to:Date.sqlFormat(this.model.get("endTime")),tz:App.getUserTimezone(),details:1};return this.model.fetch({data:i,silent:!0}).done(function(){var t=e.model;t.set("detailed",1),g.items.add(t),g.trigger("tracksuccess",t),t.trigger("sync"),u=t,n.resolve()}).fail(function(){n.reject()}),n},drawObject:function(){if(_.addItemToMap.call(this),b){k=f.addLayersGroup({layers:[b],groupCssClass:"mobile-arrows",clusters:!1});var t=this.model.get("points")[0];_.setStateInPoint.call(this,t),_.showPointInfo.call(this,0,t)}},addItemToMap:function(){var t=this.model,e=t.get("points"),n=e[0],i="complex-icon obj obj-mobile park",s=App.buildObjTitle(v);b=f.getWidget().buildComplexMarker({lat:n.lat,lon:n.lon,html:'<i class="i"></i><span class="name">'+s+"</span>",className:i,dataId:v.id,animated:!0,model:v}),this.listenTo(v,"change:park",function(){b.trigger("toggleclass",{name:"park"})}).listenTo(v,"change:course",function(t,e){_.onCourseChange(e)})},moveOnMap:function(e,n){var i=new t.Deferred,a={model:v,to:n},o=s.getDistanceBetweenPointsSimple(e.lat,e.lon,n.lat,n.lon);if(o>h)b.trigger("place",a),b.trigger("follow",{center:[n.lat,n.lon]}),i.resolve();else{var r=(n.date-e.date)*App.MS,l=r/this.module.get("playSpeed");a.animate=[[e.lat,e.lon],[n.lat,n.lon]],a.interval=l,b.trigger("place",a),b.trigger("follow",{center:[n.lat,n.lon]}),this._playTimeout=setTimeout(function(){i.resolve()},l)}return i},setStateInPoint:function(t){_.pointIsPark.call(this,t)?v.set({speed:0,park:!0}):v.set({speed:t.speed,park:!1}),v.set("course",t.course)},pointIsPark:function(t){for(var e,n,i=this.model.get("parks")||[],s=i.length;s--;)if(e=i[s],n=t.date*App.MS,n>=e.start.getTime()&&n<=e.end.getTime())return!0;return!1},onCourseChange:function(t){b.trigger("rotate",{angle:t})},forcePoint:function(t,e){this.pause(),this._i=t,this._slider.slider("value",this._ts[t]),_.showPointInfo.call(this,t,e),this.jump(e)},showPointInfo:function(t,e){var n=0,i=this.$el.find(".index"),s=e.date*App.MS,a=this.$el.find(".ts"),o=this.$el.find(".speed"),r=this.$el.find(".course"),l=this.$el.find(".alt"),c=this.$el.find(".distance"),u=this.$el.find(".coords"),h=_.parseSensorsState.call(this,e.state);if(i.val(t),a.text(this.model.formatUTC(m,s)),_.pointIsPark.call(this,e)||(n=Math.round(e.speed)),o.text(n),r.text(e.course),l.text("alt"in e?e.alt:"-"),c.text((e.dist/1e3).toFixed(2)),u.text(e.lat.toFixed(4)+","+e.lon.toFixed(4)),this.$el.find(".player-point-info").html(d(h)),this._chart)try{var p=this._chart.getChart(),f=p.series.items[0].realYAxis,g=f.actualVisibleMaximum,v=f.actualVisibleMinimum;if(s>=v&&g>=s){var k=(s-v)/(g-v),b=f.length*k;p._renderCrosshairs(b||1,50)}}catch(y){}},parseSensorsState:function(t){for(var e,n=this.module.get("sensorsNames"),i=n.length-1,s=new Array(i);i--;)e=Math.pow(2,i),s[i]={name:n[i],state:e&t?1:0};return{discrets:s,power:{name:n[n.length-1],state:Math.pow(2,n.length-1)&t?1:0}}},buildSensorsChart:function(){for(var t,e,n,i,s,o,r=this.$el.find(".sensors-chart"),l=this.model.get("points"),c=this.module.get("sensorsNames"),d=c.length,u=new Array(d),h={},p=r.height(),f=r.width(),g=l[0].date*App.MS,v=l[l.length-1].date*App.MS,k=[],b=0;d>b;++b)u[b]=null,h[b]=[];for(var y=0,w=l.length;w>y;++y)for(i=_.parseSensorsState.call(this,l[y].state),t=i.discrets,t[d-1]=i.power,b=0;d>b;++b)o=c[b],e=t[b].state,n=l[y].date*App.MS,d-1>b&&1===e||b===d-1&&0===e?u[b]||(u[b]=n):(d-1>b&&0===e||b===d-1&&1===e)&&u[b]&&(h[b].push([o,u[b],n]),u[b]=null,!s&&(s=[n,n]));for(!s&&(s=[l[0].date*App.MS,l[0].date*App.MS]),n=l[l.length-1].date*App.MS,b=d-1;b>=0;b--)o=c[b],u[b]&&(h[b].push([o,u[b],n]),u[b]=null),h[b].length||(h[b][0]=[o,s[0],s[0]]),k=k.concat(h[b]);this._chart=new a(r,{width:f+"px",height:p+"px",title:!1,animation:!1,shadows:{enabled:!1},border:{visible:!1},legend:{visible:!1},background:"#f5f5f5",crosshairs:{enabled:!0,hLine:!1,vLine:{strokeStyle:"#db492c"},snapToDataPoints:!1},axes:[{type:"dateTime",location:"bottom",strokeStyle:"black",lineWidth:1,margin:5,zoomEnabled:!0,labels:{stringFormat:"HH:MM dd.mm.yyyy",fillStyle:"black",font:"10px sans-serif",angle:0},crossing:g,maximum:v,bands:null},{type:"category",visible:!1,majorTickMarks:{visible:!1},lineWidth:0,labels:{visible:!1}}],series:[{type:"rangeBar",title:!1,fillStyle:"#57BA29",pointWidth:.5,data:k}]}),r.bind("tooltipFormat",function(t,e){var n=e.x,i=e.from,s=e.to,a="<strong>"+n+"</strong><br />";return a+=this.model.formatUTC(m,i)+" - "+this.model.formatUTC(m,s)}.bind(this))},onClose:function(){this.pause(),f&&f.destroy()&&(f=null),g.items.remove(g.items.models),k.removeLayer(b),k.trigger("destroy"),this.stopListening(v),App.unsubscribe(this),v=null,b=null,k=null,g=null}};return y}),define("_common/tracks/player/TrackPlayerModule",["jquery","underscore","abstracts/Module","_common/tracks/Track","_common/tracks/player/views/TrackPlayerView"],function(t,e,n,i,s){var a=10,o="",r="",l=n.extend({constructor:function(){n.apply(this,arguments)},defaults:{playSpeed:a,sensorsNames:[]},initialize:function(){this.set("playSpeed",this.getUserData("playSpeed")||a),this._i18n=this.get("parent").getTexts(),o=this._i18n.discretSensor,r=this._i18n.power.ucFirst();var t=this.get("parent").constructor;this.modules.tracks=new t({id:this.id+"/tracks",container:!1,parent:this,options:{showPoints:this.get("parent").get("showPoints"),colorTracks:this.get("parent").get("colorTracks"),speedColors:this.get("parent").get("speedColors"),list:!1}}),c.bindEvents.call(this)},open:function(){this._view||(this._view=new s({model:this.get("track"),module:this,tracksModule:this.modules.tracks}))},close:function(){this._view&&this._view.destroy(),this._view=null},getTexts:function(){return this._i18n}}),c={bindEvents:function(){var t=this,n=this.get("parent");this.on("change:track",function(e,n){if(t.previous("track")&&t._view&&t._view.clear(),n){var i=n.get("obj").clone();i.fetch({url:App.getBaseUrl()+"objects/obj-details/",data:{objectId:[i.id],tz:App.getUserTimezone()},cache:!1}).done(function(){i.set("speed",0),i.set("course",0),i.set("sensorsState",0),i.set("park",!0);var e=c.getDiscretsNamesFromObj(i);e.push(i.get("power")&&i.get("power").name||r),t.set("sensorsNames",e),n.set("obj",i),t.open()})}else c.onNoTrack.call(t)}).on("change:playSpeed",function(e,n){t.setUserData("playSpeed",n)}),this.listenTo(n,"change",function(){e.each(["showPoints","colorTracks","speedColors"],function(e){n.hasChanged(e)&&t.modules.tracks.set(e,n.get(e))})})},getDiscretsNamesFromObj:function(t){for(var e=6,n=new Array(e),i=t.get("discrets"),s=e;s--;)n[s]=o+" "+(s+1);if(!i)return n;for(var a in i)i[a].name&&(n[a-1]=i[a].name);return n},onNoTrack:function(){this._view&&this._view.destroy(),this._view=null}};return l}),define("text!_common/tracks/tmpl/tracks.html",[],function(){return'<li id="tracks" class="<% if(loading) {%>loading<% } %><% if(active) {%> active<% } %>">\n    <div class="tab-toggle-container hint hint-right" data-hint="<%= name %>">\n        <a class="tab-toggle" href="#<%= key %>">\n            <i class="svg-icon svg-icon-track"></i>\n            <span><%- name %></span>\n        </a>\n    </div>\n    <div id="tracks-content" class="tab-hor-content">\n        <div class="box-header module-header append">\n            <h2>\n                <%= i18n.tracksCountText.replace(\'#n#\', \'<span class="nb-items">0</span>\') %>\n            </h2>\n            <div class="dropdown module-settings add-on">\n                <a class="dropdown-toggle" data-toggle="dropdown" href="#">\n                    <i class="svg-icon svg-icon-cog"></i>\n                </a>\n                <ul class="dropdown-menu nav nav-list" role="menu">\n                    <li><a href="javascript:;" class="hide-all"><%= i18n.hideAll %></a></li>\n                    <li><a href="javascript:;" class="remove-all-empty"><%= i18n.removeEmptyTracks %></a></li>\n                    <li><a href="javascript:;" class="remove-all"><%= i18n.clearTracksList %></a></li>\n                </ul>\n            </div>\n            <% if(adding) {%>\n            <div class="add-on">\n                <a class="btn-add" href="javascript:;" title="<%= i18n.add.ucFirst() %>">\n                    <i class="svg-icon svg-icon-plus"></i>\n                </a>\n            </div>\n            <% } %>\n        </div>\n        <div class="module-content tracks-list">\n            <ul class="items-briefs">\n\n            </ul>\n        </div>\n    </div>\n</li>\n\n'
}),define("text!_common/tracks/tmpl/settings.html",[],function(){return'<h4><%= i18n.tracks.ucFirst() %></h4>\n\n<div class="control-group">\n    <div class="field">\n        <label data-setting="tracks.showPoints" class="checkbox stp"><input type="checkbox" <% if(showPoints) {%> checked<% } %> value="1">\n            <%= i18n.showTrackPoints %></label>\n    </div>\n    <div class="field">\n        <label data-setting="tracks.colorTracks" class="checkbox tct"><input type="checkbox" <% if(colorTracks) {%> checked<% } %> value="1">\n            <%= i18n.colorTracks %></label>\n        <ul class="mtsc">\n            <li><a title="<%= i18n.clickToChange %>" class="i-left">\n                <i class="color-picker" data-setting="tracks.speedColors" data-index="0"\n                   style="background-color:<%= speedColors[0] %>"></i></a>\n                <%= i18n.speedLessThan %> <input type="text" class="tsl input-mini positive no-margin"\n                                                 value="<%= speedLimits[0] %>" name="speedLimit1" data-index="0" /> <%= i18n.kmh %>\n            </li>\n            <li> <a title="<%= i18n.clickToChange %>" class="i-left">\n                <i class="color-picker" data-setting="tracks.speedColors" data-index="1"\n                   style="background-color:<%= speedColors[1] %>"></i></a>\n                <%= i18n.speedFrom %> <span class="speed-limit1"><%= speedLimits[0] %></span> <%= i18n.to %> <span class="speed-limit2"><%= speedLimits[1] %></span> <%= i18n.kmh %>\n            </li>\n            <li><a title="<%= i18n.clickToChange %>" class="i-left">\n                <i class="color-picker" data-setting="tracks.speedColors" data-index="2"\n                   style="background-color:<%= speedColors[2] %>"></i></a>\n                <%= i18n.speedGreaterThan %> <input type="text" class="tsl input-mini positive no-margin"\n                                                    value="<%= speedLimits[1] %>" name="speedLimit2" data-index="1" /> <%= i18n.kmh %>\n            </li>\n        </ul>\n\n        <div class="context-menu" id="speedColorsMenu">\n            <i style="background:#0000FF;"></i>\n            <i style="background:#0086E5;"></i>\n            <i style="background:#0033A8;"></i>\n            <i style="background:#2D15B1;"></i>\n            <i style="background:#580DAD;"></i>\n            <i style="background:#00FF00;"></i>\n            <i style="background:#009947;"></i>\n            <i style="background:#00FFB2;"></i>\n            <i style="background:#59FF00;"></i>\n            <i style="background:#447F00;"></i>\n            <i style="background:#FF0000;"></i>\n            <i style="background:#FF6400;"></i>\n            <i style="background:#FF9700;"></i>\n            <i style="background:#FFBB00;"></i>\n            <i style="background:#FFDB00;"></i>\n        </div>\n    </div>\n</div>'}),define("_common/tracks/views/TracksListView",["jquery","underscore","abstracts/View","_libs/fileSaver/FileSaver","_common/tracks/views/TrackListView","_common/tracks/player/TrackPlayerModule","text!_common/tracks/tmpl/tracks.html","text!_common/tracks/tmpl/settings.html"],function(t,e,n,i,s,a,o,r){var l=null,c=n.extend({constructor:function(){return n.apply(this,arguments)},initialize:function(e){var n=this;this.listenTo(this.model,"activate",function(){n.$el.addClass("active")}).listenTo(this.model,"deactivate",function(){n.$el.removeClass("active")}).listenTo(this.model.items,"add",function(t){new s({tagName:"li",className:"item-brief track-brief",model:t,module:this.model,player:1,container:n.$el.find("ul.items-briefs")});var e=n.$el.find(".tracks-list");e.scrollTop(e[0].scrollHeight),n.$el.find(".nb-items").text(n.model.items.length)}).listenTo(this.model.items,"remove",function(){n.$el.find(".nb-items").text(n.model.items.length)}).listenTo(App,"openalarms",function(){l&&l.close()}),t("#settings").length?d.initSettings.call(this):this.listenTo(App,"settingsready",function(){d.initSettings.call(n)}),this.render(e)},render:function(n){var i=n.container,s=this.model.getTexts(),r=e.template(o,{loading:!0,active:!1,key:this.model.id,name:s.tracks.ucFirst(),adding:this.model.get("options").addFromList,showPoints:this.model.get("showPoints"),color:this.model.get("color"),i18n:s});i.find("[data-placeholder="+n.placeholder+"]").replaceWith(r),this.setElement(i.find("#tracks"));var c=this;this.$el.on("click",".track-brief .toggle-track",function(){var e=c.model.items.get(t(this).attr("data-item"));e.set("hidden",!e.get("hidden"))}).on("click",".track-brief .remove-track",function(){var e=c.model.items.get(t(this).attr("data-item"));c.model.items.remove(e)}).on("click",".track-brief h4 a",function(){var e=c.model.items.get(t(this).attr("data-item"));return e.get("points")?(c.model.trigger("itemselect",e),void 0):!1}).on("click",".play-track",function(){var e=c.model.items.get(t(this).attr("data-item"));l?l.set("track",null):l=new a({id:c.model.id+"/player",parent:c.model}),l.set("track",e.clone())}),"Blob"in window&&this.$el.on("click",".export",function(){var e=c.model.items.get(t(this).attr("data-item"));return e.get("points")?(showCursor(),t.ajax({url:App.getBaseUrl()+"plt/track/",dataType:"text",data:{objectId:e.get("objectId"),from:Date.sqlFormat(e.get("startTime")),to:Date.sqlFormat(e.get("endTime")),tz:App.getUserTimezone()},success:function(t){saveAs(new window.Blob([t],{type:"text/plain;charset="+document.characterSet}),"track_obj_"+e.get("obj").get("extId")+".plt")},complete:hideCursor}),void 0):!1}),this.$el.on("click",".remove-all",function(){c.model.items.remove(c.model.items.models),c.$el.find(".nb-items").text("0")}).on("click",".remove-all-empty",function(){var t=c.model.items,e=[];t.each(function(t){t.hasData()||e.push(t)}),t.remove(e),c.$el.find(".nb-items").text(t.length)}).on("click",".hide-all",function(){c.model.items.each(function(t){t.set("hidden",!0)})}).on("click",".btn-add",function(){c.model.trigger("needtrack")}),this.$el.removeClass("loading")}}),d={initSettings:function(){var n=this,i=t("#settings").find(".tracks").removeClass("hidden"),s=this.model.get("speedColors");i.html(e.template(r,{i18n:this.model.getTexts(),colorTracks:this.model.get("colorTracks"),speedLimits:this.model.getSpeedLimits(),speedColors:s,showPoints:this.model.get("showPoints")})),t.fn.contextmenu&&(i.find("a").contextmenu({menu:t("#speedColorsMenu"),position:{my:"left top"},before:function(e,n){n.active.data("tool",t(this).find(".color-picker"))}}).on("click",function(e){t(this).contextmenu("open",e)}),t("#speedColorsMenu").on("click","i",function(){var e=t(this),i=e.parent().data("tool")||null;if(i&&i.length){var s=e.css("background-color"),a=n.model.get("speedColors").slice(0);i.css("background",s),a[i.data("index")]=s,n.model.set("speedColors",a)}})),i.find("input.tsl").numeric({decimal:".",negative:!1}).on("change",function(){var e=t(this),i=e.data("index"),s=parseFloat(t(this).val()),a=t("input.tsl[data-index="+(0==i?1:0)+"]");if(0==i)0>=s&&(s=1,e.val(s)),a.val()<=s&&a.val(s+1).trigger("change");else if(1==i){var o=Math.max(s-1,1);o>=s&&(s=o+1,e.val(s)),a.val()>=s&&a.val(o).trigger("change")}t(".speed-limit"+(i+1)).text(s),n.model.setSpeedLimit(i,s)}),i.find(".stp input").on("click",function(){n.model.set("showPoints",this.checked?1:0)}),i.find(".tct input").on("click",function(){n.model.set("colorTracks",this.checked?1:0)})}};return c}),define("text!_common/tracks/tmpl/park.html",[],function(){return'<div class="track-info park-info">\n<h5><%= title %></h5>\n<ul class="features">\n    <li><%= i18n.parkBegin %>: <strong data-value="<%= data.start.getTime() %>"><%= startStr %></strong></li>\n    <li><%= i18n.parkEnd %>: <strong data-value="<%= data.end.getTime() %>"><%= endStr %></strong></li>\n    <li><%= i18n.parkTime %>: <strong data-value="<%= data.end.getTime() - data.start.getTime() %>"><%= timeStr %></strong></li>\n    <li><%= i18n.address %>: <strong data-geoid="<%= data.geoId || 0 %>" class="address"><i class="svg-icon svg-icon-spinner icon-spin"></i>\n        <%- addressStr %>\n    </strong></li>\n    <% if(\'alt\' in data) {%>\n    <li><%= i18n.altitude %>: <strong data-value="<%= data.alt %>"><%= data.alt %> <%= i18n.m %></strong></li>\n    <% } %>\n</ul>\n</div>'}),define("text!_common/tracks/tmpl/point.html",[],function(){return'<div class="track-info">\n    <h5><%= title %></h5>\n    <ul class="features">\n        <li><%= i18n.time.ucFirst() %>: <strong data-value="<%= data.date %>"><%= dateStr %></strong></li>\n        <li><%= i18n.speed.ucFirst() %>: <strong data-value="<%= data.speed %>"><%= Math._round(data.speed,2) %> <%= i18n.kmh %></strong></li>\n        <% if(\'alt\' in data) {%>\n        <li><%= i18n.altitude %>: <strong data-value="<%= data.alt %>"><%= data.alt %> <%= i18n.m %></strong></li>\n        <% } %>\n        <% if(\'rid\' in data) {%>\n        <li>RID: <strong><%= data.rid %></strong></li>\n        <% } %>\n    </ul>\n</div>'}),define("_common/tracks/views/TrackMapView",["jquery","underscore","geo","abstracts/View","util","_common/tracks/TrackParkPoint","text!_common/tracks/tmpl/park.html","text!_common/tracks/tmpl/point.html"],function(t,e,n,i,s,a,o,r){function l(t,e){t=t.replace("#","");var n=parseInt(t,16),i=[255&n>>16,255&n>>8,255&n,e||1];return"rgba("+i.join(",")+")"}function c(t){var e=null==t||"null"==t?"no data":t;return e=e.replace("Россия, ",""),e=e.replace("/(город )?Санкт-Петербург, /","СПб, ")}r=e.template(r),o=e.template(o);var d=1e3,u=i.extend({constructor:function(){this._module=null,this._parentView=null,this._maps,this._polyline=null,this._parksLayer=null,this._startMarker=null,this._finishMarker=null,this._popup=null,this._i18n={},i.apply(this,arguments)},initialize:function(t){this._module=t.module,this._parentView=t.parent,this._maps=t.maps,this._i18n=this._module.getTexts();var e=this;this.listenTo(App,"objectsGroupingChange",function(){h.clearMarkers.call(e),h.putMarkers.call(e)}),this.listenTo(this.model,"sync",function(){h.rebuildPolyline.call(e),e._polyline&&e._polyline.trigger("show"),h.putMarkers.call(e),h.putPoints.call(e)}).listenTo(this.model,"remove",function(){e.stopListening(e.model),e._polyline&&e._polyline.trigger("destroy"),h.clearMarkers.call(e)}).listenTo(this.model,"change:hidden",function(t,n){var i=n?"hide":"show";e._polyline&&e._polyline.trigger(i),!n&&e._module.get("showPoints")&&h.putPoints.call(e),h.triggerOnMarkers.call(e,i)}).listenTo(this.model,"change:color",function(){h.onChangeColoring.call(e),h.clearMarkers.call(e),e.model.get("hidden")?e.listenToOnce(e.model,"change:hidden",function(){h.putMarkers.call(e)}):h.putMarkers.call(e)}).listenTo(this._module,"change:showPoints",function(t,n){n?h.putPoints.call(e):h.removePoints.call(e)}).listenTo(this._module,"change:colorTracks change:speedColors",function(){h.onChangeColoring.call(e)})}}),h={makeSegments:function(){var t=[],e=this.model.get("points"),i=[];if(!e||e.length<2||this.model.get("start")==this.model.get("finish"))return t;var s=0,a=this._module.getSpeedLimits(),o=this._module.get("colorTracks")&&a.length,r=o?this._module.get("speedColors")[0]:this.model.get("color"),l={weight:2,weightArray:{9:4,12:6,15:8},color:r,opacity:.8,dashArray:null,decor:!0,decorMinZoom:14},c=null,u=0,h=e[0].date,m=(e[e.length-1].date-h,0),p={};if(o){var f=this._module.get("speedColors"),g=0;p[0]=f[0]}i[0]=e[0],o&&(m=e[0].speed,m>a[1]?g=2:m>a[0]&&(g=1),p[0]=f[g],l.color=f[g]);for(var v=1,k=e.length;k>v;++v)m=e[v].speed,u=Math.round(100*(v/k)),s=n.getDistanceBetweenPointsSimple(e[v].lat,e[v].lon,e[v-1].lat,e[v-1].lon),s>d?(i.length>1&&(t.push(this._maps.buildPolyline(i,l)),i=[]),c=[e[v-1],e[v]],l.dashArray=[5,15]):c&&(c=null,l.dashArray=null),o?g>0?m>a[1]?(1==g?(i.push(e[v]),t.push(this._maps.buildPolyline(c?c:i,l)),g=2,p[u]=f[2],l.color=f[g],c||(i=[])):c&&t.push(this._maps.buildPolyline(c,l)),c&&(c=null,l.dashArray=null)):m>a[0]?(2==g?(i.push(e[v]),t.push(this._maps.buildPolyline(c?c:i,l)),g=1,p[u]=f[1],l.color=f[g],c||(i=[])):c&&t.push(this._maps.buildPolyline(c,l)),c&&(c=null,l.dashArray=null)):(i.push(e[v]),t.push(this._maps.buildPolyline(c?c:i,l)),g=0,p[u]=f[0],l.color=r,c?(c=null,l.dashArray=null):i=[]):(m>a[1]?(g=2,p[u]=f[2]):m>a[0]&&(g=1,p[u]=f[1]),m>a[0]?(i.push(e[v]),t.push(this._maps.buildPolyline(c?c:i,l)),l.color=f[g],c||(i=[])):c&&t.push(this._maps.buildPolyline(c,l)),c&&(c=null,l.dashArray=null)):c&&(t.push(this._maps.buildPolyline(c,l)),c=null,l.dashArray=null),i.push(e[v]);return o&&this.model.set("colorsMap",p),t.push(this._maps.buildPolyline(c?c:i,l)),t},rebuildPolyline:function(){this._polyline&&this._polyline.trigger("destroy")&&(this._polyline=null);var t=h.makeSegments.call(this);t.length&&(this._polyline=this._maps.getWidget().buildComplexPolyline());for(var e=0,n=t.length;n>e;e++)this._polyline.addSegment(t[e])},putPoints:function(){var t=this;return this._polyline&&this._module.get("showPoints")?(this._polyline.showPoints({minZoom:12,onMouseOver:function(e,n){t._parentView.showPointInfo(e,n,t.model)},onMouseOut:function(){t._parentView.hidePointInfo()}}),void 0):!1},removePoints:function(){this._polyline&&this._polyline.removePoints()},putMarkers:function(){var t=this,e=this.model,n=e.get("points"),i=e.get("parks")?e.get("parks").slice(0):[];if(n&&n.length||i&&i.length){if(!n||n.length<2||e.get("start")===e.get("finish"))return i.length&&h.buildAsOnePark.call(t,i[0]),void 0;var s=e.get("start"),a=e.get("finish"),o=e.get("startFromPark"),c=e.get("finishOnPark");i&&i.length&&(o&&i.splice(0,1),c&&i.splice(i.length-1,1));var d=this._parentView.getMapsModule(),u={borderColor:l(this.model.get("color"),"0.8")};this._startMarker=d.putMarker({lat:s.lat,lon:s.lon,className:"track-marker start"+(o?" park":""),data:s,style:u}),this._finishMarker=d.putMarker({lat:a.lat,lon:a.lon,className:"track-marker finish"+(c?" park":""),data:a,style:u});var m=[];if(i&&i.length)for(var p=0,f=i.length;f>p;++p)m.push(h.buildParkMarker.call(this,i[p]));if(o?h.bindPopup.call(this,this._startMarker,s):this._startMarker.bindPopup(r({title:this.model.get("name"),data:s,dateStr:this.model.formatDateTime(s.date),i18n:this._i18n})),c?h.bindPopup.call(this,this._finishMarker,a):this._finishMarker.bindPopup(r({title:this.model.get("name"),data:a,dateStr:this.model.formatDateTime(a.date),i18n:this._i18n})),m.length){var g=App.getUserData("objectsGrouping");this._parksLayer=d.addLayersGroup({layers:m,clusters:g.usedGrouping&&{maxClusterRadius:30,icon:{html:'<sup class="nb">#count#</sup>',className:"track-marker park",style:u}},popup:!0})}}},buildAsOnePark:function(t){this._parksLayer=this._maps.addLayersGroup({layers:[h.buildParkMarker.call(this,t)],clusters:!1})},buildParkMarker:function(t){var e=this._parentView.getMapsModule().buildMarker({lat:t.lat,lon:t.lon,className:"track-marker park",data:t,style:{borderColor:l(this.model.get("color"),"0.8")}});return h.bindPopup.call(this,e,t),e},triggerOnMarkers:function(t){this._startMarker&&this._startMarker.trigger(t),this._finishMarker&&this._finishMarker.trigger(t),this._parksLayer&&this._parksLayer.trigger(t)},clearMarkers:function(){h.triggerOnMarkers.call(this,"destroy"),this._startMarker=this._finishMarker=this._parksLayer=null},bindPopup:function(n,i){if(i instanceof a){var s=this;n.bindPopup(function(){var a=this.getContainer();return s._popup=this,t(a).addClass("track-info selectable").data("marker",n),"undefined"==typeof i.address||i.address||null===i.address||this.on("open",function(){var n=t(a).find(".address"),o=n.parent();o.addClass("loading"),s.once("searchcomplete",function(){o.removeClass("loading")}),s.once("searchsuccess",function(t){n.text(c(t.address))}),s._maps.trigger("needgeoinfo",e.pick(i,"geoId","lat","lon"),s)}).on("close",function(){s._popup=null}),o({title:s.model.get("name"),data:i,startStr:s.model.formatDateTime(i.start),endStr:s.model.formatDateTime(i.end),timeStr:Date.formatSeconds((i.end.getTime()-i.start.getTime())/App.MS),addressStr:i.address?i.address:Math._round(i.lat,4)+", "+Math._round(i.lon,4),i18n:s._i18n})},{autoPan:!0,autoPanPadding:[80,60]})}},onChangeColoring:function(){h.rebuildPolyline.call(this),this._module.get("showPoints")&&h.removePoints.call(this),this.model.get("hidden")||(this._polyline&&this._polyline.trigger("show"),this._module.get("showPoints")&&h.putPoints.call(this))},getLineWidth:function(){var t=this._widget.getZoom();return t>14?8:t>11?6:t>9?4:2}};return u}),define("_common/tracks/views/TracksMapView",["jquery","underscore","moment","abstracts/View","_common/tracks/views/TrackMapView","text!_common/tracks/tmpl/point.html"],function(t,e,n,i,s,a){n.locale(App.getLocale().substr(0,2)),a=e.template(a);var o=i.extend({constructor:function(){this._maps=null,this._viewsMap={},this._i18n={},this._pointInfo=null,this._pointInfoShown=!1,i.apply(this,arguments)},initialize:function(){var n=this;this._maps=this.model.get("options").mapsModule||null,this._maps&&(this._i18n=this.model.getTexts(),this._pointInfo=t('<div class="ui-tooltip track-point-info hidden"></div>').appendTo("body"),this.listenTo(this._maps,"zoomstart",function(){n._pointInfoShown&&n.hidePointInfo()}),this.listenTo(this.model,"tracksuccess",function(t,i){if(e.isArray(t)){for(var s=t.length;s--;)r.addItemToMap.call(n,t[s]);t.length&&i!==!1&&n._maps.setBounds(r.getTracksBounds.call(n,t))}else n.model.items.last()==t&&i!==!1&&n._maps.setBounds(t.getBounds()),r.addItemToMap.call(n,t)}).listenTo(this.model.items,"remove",function(t){n._viewsMap[t.id]=null}).listenTo(this.model,"change:showPoints",function(){n.hidePointInfo()}))},setMaps:function(t){if(t){var e=this._maps;this._maps=t,e||this.initialize()}},showPointInfo:function(t,e,n){var i=a({title:n.get("name"),data:e,dateStr:n.formatDateTime(e.date),i18n:this._i18n});this._pointInfo.removeClass("hidden").html(i).css({left:t.pageX,top:t.pageY}),this._pointInfoShown=!0},hidePointInfo:function(){this._pointInfoShown&&(this._pointInfo.addClass("hidden"),this._pointInfoShown=!1)},getMapsModule:function(){return this._maps},destroy:function(){this.remove(),this.hidePointInfo(),this._pointInfo.remove()}}),r={addItemToMap:function(t){var e=this._viewsMap[t.id]=new s({model:t,module:this.model,parent:this,maps:this._maps});return e},getTracksBounds:function(t){for(var e=t.length,n={},i={minLat:90,minLon:180,maxLat:-90,maxLon:-180};e--;)n=t[e].getBounds(),n&&(n.maxLat>i.maxLat&&(i.maxLat=n.maxLat),n.minLat<i.minLat&&(i.minLat=n.minLat),n.maxLon>i.maxLon&&(i.maxLon=n.maxLon),n.minLon<i.minLon&&(i.minLon=n.minLon));return i}};return o}),define("_common/tracks/TracksModule",["jquery","underscore","abstracts/Module","util","_common/mobile/MobileObjectsCollection","_common/tracks/Track","_common/tracks/TracksCollection","_common/tracks/views/TracksListView","_common/tracks/views/TracksMapView","i18n!_common/nls/common","css!_common/tracks/css/tracks"],function(t,e,n,i,s,a,o,r,l,c){var d=["#ff0000","#00CC00","#740000","#005d00","#ff4900","#742100","#00AF64","#00502d","#2a6b4f","#ff7400","#743500","#009999","#004646","#245d5d"],u=n.extend({constructor:function(){this.items=new o,this._listView=null,this._newTrackId=0,this._processing=!1,n.apply(this,arguments)},defaults:{showPoints:0,colorTracks:0,speedColors:["#0000ff","#00ff00","#ff0000"]},initialize:function(){var t=this,n=this.get("options");e.each(["showPoints","colorTracks","speedColors"],function(e){"undefined"!=typeof n[e]&&t.set(e,n[e])}),n.list&&this.get("container")&&(this._listView=new r({container:this.get("container"),placeholder:this.get("placeholder"),model:this})),this._view=new l({model:this}),h.bindEvents.call(this),this.publish("ready",this)},setMaps:function(t){t&&(this.set("options",e.extend({},this.get("options"),{mapsModule:t})),this._view.setMaps(t))},hideAll:function(){this.items.each(function(t){t.set("hidden",!0)})},showAll:function(){this.items.each(function(t){t.set("hidden",!1)})},getTexts:function(){return c},getSpeedLimits:function(){return App.getSpeedLimits()},setSpeedLimit:function(t,e){var n=this.getSpeedLimits();n[t]=e,this.setUserData("speedLimits",n),App.publish("speedlimitschange",n)},getSinglePolyline:function(){var t=this.items.where({hidden:!1});return t.length>1?!1:t[0].get("points")},remove:function(){this.stopListening()},destroy:function(){this.items.remove(this.items.models),this._listView&&this._listView.remove(),this.stopListening()}}),h={bindEvents:function(){var t=this,n=this.get("parent");this.listenTo(n,"buildtrack",function(e,i){if(i){if(i&&i.last)return h.buildLastTracks.call(t,i),void 0;if(i.trackId){var a;if(a=t.items.get(i.trackId))return t.trigger("itemselect",a),n.trigger("buildstartsuccess"),void 0}if(t._processing)return alert("Sorry, you can not build new tracks until previous task will be complete");var o=h.validateParams.call(t,i);if(o)return alert(o.join("<br />"),c.error.ucFirst());if(null==e){if(!i.objectId)return;return n.trigger("buildstartsuccess"),e=new s,e.fetch({data:{objectId:i.objectId},silent:!0}).done(function(){h.buildTracks.call(t,e,i)}),void 0}n.trigger("buildstartsuccess"),h.buildTracks.call(t,e,i)}}),this.listenTo(App,"clearmap",function(e){e&&e==t?t.items.remove(t.items.models):t.items.each(function(t){t.set("hidden",!0)})}),this.on("needtrack",function(){arguments.length||n.trigger("needtrack")}).on("needgeoinfo",function(e,n){var i;(i=t.get("options").mapsModule)&&i.trigger("needgeoinfo",e,n)}),this.on("change",function(){e.each(["showPoints","colorTracks","speedColors"],function(e){if(t.hasChanged(e)){var n=t.get(e);t.setUserData(e,n),t.get("parent").trigger("tracksoptionchange",e,n)}})}),this.on("itemselect",function(e){if(!(e instanceof a))return!1;var n;(n=t.get("options").mapsModule)&&(e.set("hidden",!1),n.setBounds(e.getBounds()))})},buildLastTracks:function(n){var i=this;if(!("tzId"in n)){var s=App.getTimezone({offset:60*App.getUserTimezone()});n.tzId=s.id}t.ajax({url:App.getBaseUrl()+"reports/LIMITEDROUTE/",data:n.data,statusCode:{401:null},success:e.bind(function(t){e.each(n.data.objectId,e.bind(function(e){var s=new a({id:h.getNewTrackId.call(i),objectId:e,module:this,name:n.name,tzId:n.tzId});s.set(s.parse(t)),this.items.add(s),s.get("points")&&(this.trigger("tracksuccess",s,n.zoom),s.trigger("sync",s,t))},this))},this),error:e.bind(function(t,e,n){this.trigger("trackerror",t||null,e||0,n||"")},this),complete:function(){}})},buildTracks:function(n,i){var s=this;n.models&&(n=n.models);var o=[],r=[],l={objectId:r,from:Date.sqlFormat(i.startTime),to:Date.sqlFormat(i.endTime)};if("undefined"!=typeof i.tzId?l.tzId=i.tzId:l.tz=App.getUserTimezone(),e.each(n,function(t){var e=new a({id:h.getNewTrackId.call(s),obj:t.clone(),objectId:t.id,name:t.get("name")+" [#"+t.get("extId")+"]",startTime:i.startTime,endTime:i.endTime,color:"color"in i?i.color:h.getNewTrackColor.call(s),module:s});"undefined"!=typeof i.tzId&&e.set("tzId",i.tzId),o.push(e),r.push(t.id),s.items.add(e),e.trigger("request",e)}),n.length>1&&(s._processing=!0),i.sourceElement&&i.sourceElement.trigger("loadstart"),"timeRanges"in i){var d=i.timeRanges,u=[];r.forEach(function(t){u.push({id:t,ranges:d})}),delete l.objectId,delete l.from,delete l.to,l.objectIds=u}t.ajax({url:o[0].url(),data:l,success:function(t){for(var e,n=o.length;n--;)e=o[n],e.set(e.parse(t)),s.items.get(e)?e.get("points")&&1==o.length&&(s.trigger("tracksuccess",e),e.trigger("sync")):e=null;if(o.length>1)for(s.trigger("tracksuccess",o),n=o.length;n--;)o[n].trigger("sync");i.sourceElement&&i.sourceElement.trigger("loadsuccess",o)},error:function(){alert(c.msgCanNotBuildTracks,c.error.ucFirst());for(var t=o.length;t--;)o[t].trigger("error"),s.items.remove(o[t]);i.sourceElement&&i.sourceElement.trigger("loaderror")},complete:function(){s._processing=!1,i.sourceElement&&i.sourceElement.trigger("loadcomplete")}})},getNewTrackId:function(){return++this._newTrackId},validateParams:function(t){var e=[];return t.startTime&&t.endTime||e.push("Start time and/or end time is absent"),t.startTime>=t.endTime&&e.push(c.errors.startMoreTnanEndTime),e.length?e:null},getNewTrackColor:function(){return this.items.length?d[e.last(this.items.models).id%d.length]:d[0]}};return u});