var PRODUCTION=!0;define("_common/poi/Poi",["underscore","jquery","abstracts/Model"],function(e,t,i){var o=i.extend({constructor:function(){i.apply(this,arguments)},initialize:function(){i.prototype.initialize.apply(this,arguments)},defaults:{name:"",groupId:0,type:null,address:"",geoId:0,lat:0,lon:0,coordinates:[]},parse:function(t){if(t.osm_id)return this.parseOSM(t);var i={},o=this;return i.id=t.id,"geometry"in t&&"Point"==t.geometry.type&&(i.coordinates=t.geometry.coordinates),"properties"in t&&e.each(t.properties,function(e,t){t in o.defaults&&(i[t]=e)}),i},parseOSM:function(e){var t={};return t.id=e.id,t.coordinates=[e.lat,e.lon],t.name=e.name_ru,t.address=e.addr_full_name,t}});return o}),define("_common/poi/PoiCollection",["underscore","jquery","abstracts/Collection","_common/poi/Poi","_common/poi/PoiGroup"],function(e,t,i,o){var n=i.extend({model:o,url:"./test/poiGeojson.json",constructor:function(){this._group=null,i.apply(this,arguments)},initialize:function(){i.prototype.initialize.apply(this,arguments)},parse:function(e){return e.features},getGroup:function(){return this._group}});return n}),define("_common/poi/PoiGroup",["underscore","jquery","abstracts/Group","_common/poi/PoiCollection"],function(e,t,i){var o=i.extend({constructor:function(){i.apply(this,arguments)},initialize:function(){i.prototype.initialize.apply(this,arguments),this.on("change:checked",function(){})},defaults:{name:"",bounds:null,closed:!0,checked:!1,nbItems:0},parse:function(t){var i=t.length&&t[0]||t,o=this.collection.module||null,n=this.collection.types;if(o&&(i.closed=o.isGroupClosed(i.id)),i.types){var s,r=[];e.each(i.types,function(t,i){s=e.clone(n[i]),s.nbItems=t,r.push(s)}),i.types=r}return i.pois&&e.each(i.pois,function(t){t.type=e.clone(n[t.type]),t.groupId=i.id}),i},calcBounds:function(){var e=0,t=0,i=this.get("pois"),o=i.length,n=[[90,180],[-90,-180]];if(o){for(var s=0;o>s;++s)t=i[s].lon,e=i[s].lat,e>n[1][0]&&(n[1][0]=e),e<n[0][0]&&(n[0][0]=e),t>n[1][1]&&(n[1][1]=t),t<n[0][1]&&(n[0][1]=t);this.set("bounds",n)}},hasData:function(){return this.items&&this.items.length}});return o}),define("_common/poi/PoiTypesCollection",["underscore","jquery","abstracts/Collection"],function(e,t,i){var o=i.extend({constructor:function(){i.apply(this,arguments)}});return o}),define("_common/poi/PoiGroupsCollection",["underscore","jquery","abstracts/Collection","_common/poi/PoiGroup","_common/poi/PoiTypesCollection"],function(e,t,i,o){var n=i.extend({model:o,constructor:function(){this.module=null,this.types={},i.apply(this,arguments)},initialize:function(){i.prototype.initialize.apply(this,arguments)},url:App.getBaseUrl()+"poi-groups/",parse:function(e){return this.types=e.types,e.groups}});return n}),define("text!_common/poi/tmpl/poiModule.html",[],function(){return'<li id="<%= moduleId %>" class="poi-module loading<% if(active) {%> active<% } %>">\n    <div class="tab-toggle-container hint hint-right" data-hint="<%= name %>">\n        <a class="tab-toggle" href="#<%= key %>">\n            <!--<i class="svg-icon svg-icon-location"></i>-->\n            <svg class="svg-icon">\n                <use xlink:href="#smb-location"></use>\n            </svg>\n            <span><%- name %></span>\n        </a>\n    </div>\n    <div class="tab-hor-content">\n        <div class="box-header module-header append">\n\n            <form class="form-search">\n                <div class="input-append input-prepend">\n                    <span class="add-on">\n                        <input name="q" type="text" placeholder="<%= i18n.poiTreeSearchPlaceholder %>" autocomplete="off">\n                        <i class="icon-clear svg-icon svg-icon-circle-remove"></i>\n                    </span>\n                    <button class="btn add-on btn-search"><i class="svg-icon svg-icon-search"></i></button>\n                </div>\n            </form>\n\n            <div class="dropdown module-settings add-on">\n                <a class="dropdown-toggle" data-toggle="dropdown" href="#">\n                    <i class="svg-icon svg-icon-cog"></i>\n                </a>\n                <ul class="dropdown-menu nav nav-list" role="menu">\n                    <li>\n                        <a class="hide-all" href="javascript:;"><%= i18n.hideAll %></a>\n                    </li><li>\n                        <a class="show-all" href="javascript:;"><%= i18n.showAll %></a>\n                    </li><li>\n                        <a class="reload" href="javascript:;"><%= i18n.reload.ucFirst() %></a>\n                        <!--<h5 class="nav-header">Sort by:</h5>\n                        <ul class="options-list">\n\n                        </ul>-->\n                    </li>\n                </ul>\n            </div>\n\n            <% if(allowCreate){ %>\n            <div class="dropdown module-settings add-on">\n                <a class="dropdown-toggle" data-toggle="dropdown" href="#">\n                    <i class="svg-icon svg-icon-plus"></i>\n                </a>\n                <ul class="dropdown-menu nav nav-list" role="menu">\n                    <li>\n                        <a class="add-group" href="javascript:;"><%= i18n.addGroup %></a>\n                    </li><li>\n                        <a class="add-item" href="javascript:;"><%= i18n.addPoi %></a>\n                    </li><% if(App.allowed(\'poi.import\')){ %><li>\n                        <a class="import-poi" href="javascript:;"><%= i18n.importFromFile %></a>\n                    </li><% } %>\n                </ul>\n            </div>\n            <% } %>\n\n        </div>\n        <div class="module-content">\n\n        </div>\n    </div>\n\n    <%= iconsDefs %>\n\n</li>\n\n'}),define("text!_common/poi/images/poi-icons.svg",[],function(){return'<svg width="0" height="0" style="position:absolute"><defs><svg viewBox="-5 -2 32 32" enable-background="new -5 -2 32 32" id="poi-icon-cafe"><path fill="#fff" d="M9.857-.857v11.43c0 .725-.21 1.386-.634 1.98-.423.595-.973 1.01-1.652 1.25v13.91c0 .62-.226 1.155-.678 1.608-.453.455-.987.68-1.606.68H3c-.62 0-1.154-.225-1.606-.68-.453-.452-.68-.988-.68-1.606v-13.91c-.678-.24-1.228-.656-1.65-1.25-.422-.596-.634-1.256-.634-1.982V-.858c0-.308.113-.576.34-.802.225-.227.492-.34.8-.34.31 0 .578.113.805.34.226.225.34.493.34.802v7.43c0 .308.112.576.338.803.227.226.495.34.804.34.31 0 .577-.114.803-.34.227-.227.34-.495.34-.804V-.857c0-.31.113-.577.34-.803.226-.227.494-.34.803-.34.31 0 .577.113.803.34s.34.493.34.802v7.43c0 .308.112.576.338.803.228.226.496.34.804.34.31 0 .577-.114.804-.34.226-.227.34-.495.34-.804V-.857c0-.31.113-.577.338-.803.227-.227.495-.34.804-.34.31 0 .577.113.804.34.226.225.34.493.34.803zm13.714 0v28.57c0 .62-.226 1.155-.677 1.608-.454.455-.99.68-1.607.68H19c-.618 0-1.154-.225-1.606-.68-.452-.452-.68-.988-.68-1.606V18.57h-4c-.154 0-.287-.055-.4-.168-.115-.112-.17-.246-.17-.402V3.714c0-1.572.56-2.917 1.678-4.035C14.94-1.44 16.286-2 17.857-2h4.57c.31 0 .578.113.805.34.226.225.34.493.34.803z"/></svg><svg viewBox="-3 -2 32 32" enable-background="new -3 -2 32 32" id="poi-icon-carservice"><path fill="#fff" d="M4.077 24.188c0-.338-.124-.63-.37-.877s-.54-.37-.878-.37c-.34 0-.63.124-.88.37-.245.248-.37.54-.37.878s.125.63.37.878c.25.246.54.37.88.37.336 0 .63-.124.876-.37.247-.248.37-.54.37-.878zm12.558-8.19L3.337 29.3c-.48.48-1.065.72-1.755.72-.676 0-1.267-.24-1.774-.72l-2.066-2.106C-2.754 26.725-3 26.14-3 25.438c0-.688.246-1.28.74-1.774l13.28-13.28c.507 1.274 1.25 2.402 2.232 3.383.98.982 2.11 1.727 3.384 2.233zm12.362-8.48c0 .506-.148 1.195-.448 2.066-.61 1.742-1.68 3.155-3.208 4.24-1.526 1.085-3.207 1.63-5.04 1.63-2.405 0-4.462-.856-6.17-2.566-1.71-1.71-2.565-3.766-2.565-6.17 0-2.405.854-4.462 2.564-6.172s3.77-2.564 6.172-2.564c.754 0 1.544.107 2.368.32.826.217 1.524.52 2.097.908.21.144.313.326.313.547 0 .222-.104.404-.313.547L19.054 3.6v4.368l3.765 2.086c.062-.04.576-.354 1.538-.945S26.2 7.99 27 7.527c.8-.462 1.257-.692 1.376-.692.193 0 .346.064.457.194.11.13.167.293.167.49l-.003-.002z"/></svg><svg viewBox="0 0 24 24" id="poi-icon-gasstation"><path fill="#fff" d="M22.276 5.64l.02-.02L17.332.665 15.918 2.08l2.813 2.813c-1.253.48-2.146 1.687-2.146 3.107 0 1.84 1.493 3.333 3.332 3.333.475 0 .928-.1 1.334-.28v9.613c0 .733-.6 1.334-1.334 1.334-.732 0-1.333-.6-1.333-1.334v-6c0-1.474-1.192-2.666-2.666-2.666h-1.333V2.667C14.584 1.193 13.39 0 11.917 0h-8C2.443 0 1.25 1.193 1.25 2.667V24h13.334V14h2v6.666c0 1.84 1.493 3.334 3.332 3.334 1.84 0 3.334-1.493 3.334-3.334V8c0-.92-.372-1.753-.974-2.36zm-10.36 3.693h-8V2.667h8v6.666zm8 0c-.732 0-1.333-.6-1.333-1.333s.6-1.333 1.333-1.333 1.334.6 1.334 1.333-.6 1.333-1.334 1.333z"/></svg><svg viewBox="0 0 32 32" id="poi-icon-home"><path fill="#fff" d="M32 19.044L16 6.304 0 19.043V13.85L16 1.108 32 13.85v5.194zm-4-.462v12.31h-8v-8.207h-8v8.207H4v-12.31L16 9.35l12 9.232z"/></svg><svg viewBox="233.441 233.441 32 32" enable-background="new 233.441 233.441 32 32" id="poi-icon-office"><path fill="#fff" d="M262.367 247.504h-11.992c-.672 0-1.216.36-1.216.804v17.133c0 .03 5.53 0 5.53 0v-4.422h3.464v4.423h5.428v-16.327c0-1.25-.545-1.61-1.215-1.61zm-6.82 5.733h-4.392v-4.125h4.39v4.125zm6.038 0h-4.39v-4.125h4.39v4.125zm-6.038 5.713h-4.39v-4.124h4.39v4.124zm6.04 0h-4.392v-4.124h4.39v4.124zM253.79 246.356v-11.48c0-.792-.64-1.435-1.434-1.435h-14.16c-.792 0-1.436.644-1.436 1.436v30.565c1.148 0 6.21.014 6.53 0l.01-5.468h3.947l-.012-11.664c0-.848.683-1.686 1.58-1.96l4.975.008zm-9.36-3.565h-5.053v-5.826h5.053v5.827zm6.743 0h-5.052v-5.827h5.053v5.827zm-6.742 7.877h-5.052v-5.827h5.053v5.827zm0 7.877h-5.052v-5.826h5.053v5.826z"/></svg><svg viewBox="204.349 204.35 32 32" enable-background="new 204.349 204.35 32 32" id="poi-icon-parking"><path fill="#fff" d="M212.308 231.175c-1.024 0-1.823-.874-1.823-1.893 0-1.063.842-1.893 1.823-1.893 1.023 0 1.822.828 1.822 1.892 0 1.063-.8 1.893-1.822 1.893zm13.955-11.304c-.486-1.062-.937-1.29-1.996-1.29h-8.002c-1.067 0-1.51.234-1.997 1.29l-2.49 5.447h17.02l-2.535-5.446zm8.664-4.2l-11.284-9.23c-.937-.74-2.135-1.155-3.333-1.155-1.198 0-2.396.37-3.333 1.154l-11.292 9.23c-1.154.875-1.336 1.757-1.336 3.092v15.604c0 1.108.84 1.984 1.91 1.984h2.308v-8.636c0-.74.087-1.29.443-2.075l3.646-7.896c.443-.92 1.554-1.66 2.534-1.66h10.312c.98 0 2.134.74 2.533 1.66l3.653 7.895c.355.784.442 1.334.442 2.074v8.628h2.31c1.066 0 1.91-.875 1.91-1.984v-15.596c-.088-1.388-.27-2.217-1.423-3.092zm-6.71 11.72c-1.023 0-1.822.83-1.822 1.893 0 1.063.8 1.893 1.822 1.893 1.024 0 1.823-.874 1.823-1.893s-.8-1.893-1.823-1.893zm-15.684 8.907H228v-2.813h-15.467v2.813z"/></svg><svg viewBox="290 380 32 32" enable-background="new 290 380 32 32" id="poi-icon-parking1"><path fill="#fff" d="M295.595 380.66c2.214-.377 5.325-.66 9.708-.66 4.43 0 7.587.848 9.71 2.544 2.072 1.6 3.39 4.24 3.39 7.352 0 3.11-.99 5.797-2.92 7.54-2.452 2.262-6.08 3.347-10.32 3.347-.944 0-1.793-.048-2.452-.188V412h-7.115v-31.34zm7.117 14.42c.613.142 1.32.19 2.403.19 3.82 0 6.174-1.933 6.174-5.138 0-2.92-2.028-4.665-5.657-4.665-1.414 0-2.403.094-2.922.235v9.38z"/></svg><svg viewBox="8 8 32 32" enable-background="new 8 8 32 32" id="poi-icon-regular"><path fill="#fff" d="M12.333 31.12s2-1.787 6-1.787c4.693 0 8.46 3.334 12.52 3.334 3.467 0 6-1.5 7.373-2.88.44-.44.774-1.2.774-1.913V11.62c0-.813-.56-1.48-1.38-1.48-.554 0-.973.334-1.394.754-.566.565-2.226 1.773-6.206 1.773-3.633 0-6.514-3.333-11.207-3.333-4.52 0-6.48 1.473-6.48 1.473v-1.14c0-.92-.746-1.667-1.666-1.667S9 8.747 9 9.667v28.667c0 .92.747 1.666 1.667 1.666s1.667-.747 1.667-1.667V31.12zM15 14.668v10.667c0 .733-.6 1.334-1.333 1.334s-1.333-.6-1.333-1.334V14.667c0-.733.6-1.333 1.333-1.333s1.333.6 1.333 1.333z"/></svg><svg viewBox="0 0 32 32" id="poi-icon-shop"><path d="M29 14H3c-.553 0-1-.447-1-1s.447-1 1-1h2l6-11c0-.553.447-1 1-1h2c.553 0 1 .447 1 1L9 12h14L17 1c0-.553.447-1 1-1h3c.553 0 1 .447 1 1l5 11h2c.553 0 1 .447 1 1s-.447 1-1 1zM3 16h26c.553 0 1 .447 1 1l-2 14c0 .553-.447 1-1 1H5c-.553 0-1-.447-1-1L2 17c0-.553.447-1 1-1zm19 12h2c.553 0 1-.447 1-1l1-6c0-.553-.447-1-1-1h-2c-.553 0-1 .447-1 1l-1 6c0 .553.447 1 1 1zm-8-1c0 .553.447 1 1 1h2c.553 0 1-.447 1-1v-6c0-.553-.447-1-1-1h-2c-.553 0-1 .447-1 1v6zm-7 0c0 .553.447 1 1 1h2c.553 0 1-.447 1-1l-1-6c0-.553-.447-1-1-1H7c-.553 0-1 .447-1 1l1 6z" fill="#fff"/></svg><svg viewBox="-2 -2 32 32" enable-background="new -2 -2 32 32" id="poi-icon-stop"><path fill="#fff" d="M7.143 19.714c0-.632-.223-1.17-.67-1.616-.446-.446-.985-.67-1.615-.67s-1.17.224-1.616.67c-.446.447-.67.984-.67 1.616s.224 1.17.67 1.616c.446.446.985.67 1.615.67s1.17-.224 1.616-.67c.447-.446.67-.984.67-1.616zm18.285 0c0-.632-.223-1.17-.67-1.616-.445-.446-.984-.67-1.615-.67s-1.17.224-1.616.67c-.446.447-.67.984-.67 1.616s.224 1.17.67 1.616.985.67 1.616.67 1.17-.224 1.616-.67.668-.984.668-1.616zm-.822-7.07L23.32 5.786c-.06-.273-.193-.497-.4-.67-.21-.173-.45-.26-.725-.26H5.803c-.273 0-.515.087-.724.26-.21.172-.344.396-.403.67L3.39 12.64c-.058.358.025.673.252.947.226.272.518.41.875.41H23.48c.358 0 .648-.138.876-.41.226-.275.31-.59.25-.947zM20.57 1.713c0-.237-.083-.44-.25-.605-.167-.167-.368-.25-.606-.25H8.286c-.238 0-.44.082-.607.25-.167.165-.25.368-.25.605 0 .238.082.44.25.606.166.17.37.252.606.252h11.428c.24 0 .44-.083.607-.25.166-.167.25-.37.25-.607zm7.144 12.947v10.77h-2.286v2.284c0 .632-.223 1.17-.67 1.616s-.985.67-1.615.67-1.17-.224-1.616-.67-.67-.984-.67-1.616V25.43H7.143v2.284c0 .632-.223 1.17-.67 1.616-.446.446-.985.67-1.616.67s-1.17-.224-1.616-.67c-.445-.446-.668-.984-.668-1.616V25.43H.286V14.66c0-1.333.15-2.66.447-3.98L2.57 2.573c.11-.93.69-1.745 1.743-2.448 1.052-.702 2.42-1.23 4.107-1.59C10.105-1.82 11.965-2 14-2s3.895.18 5.58.536 3.055.887 4.107 1.59c1.053.702 1.634 1.518 1.74 2.446l1.875 8.107c.276 1.214.412 2.54.412 3.98z"/></svg><svg viewBox="290 380 32 32" enable-background="new 290 380 32 32" id="poi-icon-storage"><path fill="#fff" d="M318.45 398.815l-10.395 5.743c-.368-.26-.784-.447-1.225-.574l-9.868-21.954-6.962 2.94 1 2.28 5.098-2.417 8.425 19.15c-1.83.643-3 1.75-3 3.98 0 2.297 1.864 4.157 4.158 4.157 2.297 0 4.188-1.86 4.16-4.158-.007-.68.176-.85-.207-1.483l8.85-5.064 2.184 1.583 1.174-2.247-3.39-1.938zm-12.754 10.553c-.77 0-1.395-.622-1.395-1.393 0-.77.623-1.394 1.396-1.394.77 0 1.395.623 1.395 1.395 0 .77-.625 1.393-1.394 1.393zM308.194 402.075l11.25-5.365-5.358-11.253-11.252 5.363zM302.25 389.638l5.903-2.816-2.81-5.906-5.906 2.815zM313.346 384.257l-4.264 2.034-2.034-4.263 4.264-2.034z"/></svg></defs></svg>'}),define("_common/poi/views/PoiModuleView",["jquery","underscore","abstracts/ModuleView","text!../tmpl/poiModule.html","text!../images/poi-icons.svg","css!../css/poi.css"],function(e,t,i,o,n){var s=i.extend({constructor:function(){this._tmpl=t.template(o),i.apply(this,arguments)},_getModuleTmplData:function(e){var t=i.prototype._getModuleTmplData.call(this,e);return t.iconsDefs=n,t},getName:function(){return this.model.getTexts().pois.ucFirst()},_bindEvents:function(){var e=this.model;this.$el.on("click",".show-all",function(){e.trigger("toggleall",!0)}).on("click",".hide-all",function(){e.trigger("toggleall",!1)}).on("click",".import-poi",function(){e.trigger("poiimport")}),i.prototype._bindEvents.call(this)}});return s}),define("_common/poi/nls/poi",{root:{poi1:"points",pois1:"points",poiTreeSearchPlaceholder:"Search for groups and types",addPoi:"Add point",importFromFile:"Import from file",enterPoiAddress:"Enter the address or the location on the map",poiCoordinatesAreNotDetected:"Coordinates for the point are not defined",enterPoiAddressOrName:"Enter name or address of the point",selectPoiGroup:"Select group",errorSelectPoiGroup:"Select group for the point",selectPoiType:"Select the point type",errorSelectPoiType:"Select the point type",enterPoiName:"Enter point name",removePoiGroup:"Remove group",poiGroupRemovingHeader:"Remove the point group?",poiEmptyGroupRemovingText:"Are you sure you want to remove the group",poiGroupRemovingText:"Are you sure you want to remove the group from #n# #t#",removePoi:"Remove point",poiRemovingText:"Are you sure you want to remove the point",errorPoiGroupName:"Enter group name",errorGroupsSearchStringMinLength:"Enter at least 3 characters please",commonPoiServerError:"Failed to load point data from the server"},"ru-ru":!0,"it-it":!0}),define("_common/poi/nls/ru-ru/poi",{poi1:"метки",pois1:"меток",poiTreeSearchPlaceholder:"Поиск групп и типов",addPoi:"Добавить метку",importFromFile:"Импорт из файла",enterPoiAddress:"Укажите адрес или место на карте",poiCoordinatesAreNotDetected:"Не определены координаты для метки",enterPoiAddressOrName:"Введите имя или адрес метки",selectPoiGroup:"Выберите группу",errorSelectPoiGroup:"Выберите группу для метки",selectPoiType:"Выберите тип метки",errorSelectPoiType:"Выберите тип метки",enterPoiName:"Введите имя метки",removePoiGroup:"Удалить группу",poiGroupRemovingHeader:"Удалить группу меток?",poiEmptyGroupRemovingText:"Вы действительно хотите удалить группу",poiGroupRemovingText:"Вы действительно хотите удалить группу из #n# #t#",removePoi:"Удалить метку",poiRemovingText:"Вы действительно хотите удалить эту метку",errorPoiGroupName:"Введите имя группы",errorGroupsSearchStringMinLength:"Пожалуйста введите минимум 3 символа",commonPoiServerError:"Не удалось загрузить с сервера данные о метках"}),define("_common/poi/PoiModule",["underscore","jquery","jface","abstracts/Module","_common/poi/Poi","_common/poi/PoiGroup","_common/poi/PoiGroupsCollection","_common/poi/views/PoiModuleView","i18n!_common/nls/common","i18n!_common/poi/nls/poi","css!_common/poi/css/poi"],function(e,t,i,o,n,s,r,a,l,d){function c(e){var i="",o="";try{var n=t.parseJSON(e.responseText);i=n.msg,o=n.hdr}catch(s){i=u.errors.callServerFailed+" ("+e.statusText+")",o=u.error+" ("+e.status+")"}alert(i,o)}var p={tree:"_common/poi/tree/PoiTreeModule",watched:"_common/poi/watched/PoiWatchedModule",editor:"_common/poi/editor/PoiEditorModule"},u=t.extend({},l,d);App.getBaseUrl()+"poi/groups/",App.getBaseUrl()+"poi/list/";var h=o.extend({constructor:function(){this.groups=new r,this.types=null,this._modules=["watched","tree"],(App.allowed("poi.create")||App.allowed("poi.edit"))&&this._modules.push("editor"),this.watchedTypesIds=null,o.apply(this,arguments)},initialize:function(){var t=this,i=e.map(this._modules,function(e){return p[e]});this.get("container")&&(this._view=new a({container:this.get("container"),placeholder:this.get("placeholder"),model:this,allowCreate:App.allowed("poi.create")})),this._view&&(this.watchedTypesIds=this.getUserData("watched.types")||{},m.bindCommonEvents.call(t),requirejs(i,function(){var i=0;e.each(arguments,function(e){var o=t._modules[i];t.modules[o]=new e({id:t.id+"/"+o,container:"watched"!=o?t._view.getModuleContent():null,parent:t,mapsModule:t.get("parent").getMapsModule(),allowCreate:App.allowed("poi.create"),allowEdit:App.allowed("poi.edit"),allowRemove:App.allowed("poi.delete")}),i++}),m.bindEvents.call(t),t.publish("ready",t)}))},getInitiallySelected:function(){return this.watchedTypesIds},getGroupsList:function(){return this.groups?this.groups.toJSON():[]},getPoiActions:function(){var e=this.get("parent").getFoundAddressActions();return e},getTexts:function(){return u}}),m={bindCommonEvents:function(){var e=this;this.on("toggleall",function(t){e.groups.each(function(i){e.trigger("grouptoggle",i,t,{silent:!0})})}).on("grouptoggle",function(){m.toggleGroup.apply(e,arguments)}).on("groupremove",function(){m.removeGroup.apply(e,arguments)}).on("groupremoved",function(t){t in e.watchedTypesIds&&(delete e.watchedTypesIds[t],e.setUserData("watched.types",e.watchedTypesIds)),e.groups.remove(t)}).on("typetoggle",function(t,i,o){m.toggleType.call(e,t,e.types[i],o)}).on("itemadded",function(t){var i;(i=e.groups.get(t))&&i.set("nbItems",i.get("nbItems")+1)}).on("poiremoved",function(t,i){var o;(o=e.groups.get(i||t.get("groupId")))&&o.set("nbItems",o.get("nbItems")-1)}),this.listenTo(App,"clearmap",function(t){e.get("parent").getMapsModule()==t&&e.trigger("toggleall",!1)})},bindEvents:function(){var t=this;if(this.modules.tree){var o=this.modules.tree;this.listenToOnce(o.groups,"sync",function(){m.updateGroups.call(t,o.groups)}).listenTo(o.groups,"error",function(){}),this.on("groupadded",function(e){e?(o.set("q","",{silent:!0}),o.reload(),t.groups.add(e.clone())):t.trigger("reload")}).on("filtertree",function(e){o.set("q",e)}).on("reload",function(){t.listenToOnce(o.groups,"sync",function(){m.updateGroups.call(t,o.groups)})})}if(this.modules.watched){var r=this.modules.watched;this.on("neednearest",function(e,i,o){t.get("parent").trigger("neednearest",e,i,o)}),this.listenTo(r,"poiremove",function(e){var o=t.getTexts();i.confirm(o.poiRemovingText,o.removePoi+"?",{okCallback:function(){m.removePoi.call(t,e)}})}),this.modules.editor&&this.listenTo(this.modules.editor,"change:model",function(e,t){t||r.trigger("poieditclose",e.previous("model"))}).listenTo(r,"poiedit",function(e){t.trigger("itemedit",e)})}this.modules.editor&&this.on("groupedit",function(i){i?i instanceof s||e.isNumber(i)&&(i=null):i=new s,i&&t.modules.editor.set("model",i)}).on("itemedit",function(i){i?i instanceof n||e.isNumber(i)&&(i=null):i=new n,i&&t.modules.editor.set("model",i)}).on("poiimport",function(){t.modules.editor.trigger("needimport")}).listenTo(this.modules.editor,"toggleform",function(e){t.modules.tree.setTop(e||0)})},updateGroups:function(e){var i=new Array(e.length),o=0;e.each(function(e){i[o]=new s(t.extend(!0,{},e.attributes)),o++}),this.groups.set(i)},toggleGroup:function(t,i){if(t instanceof s&&t.id){var o=t.id;if(t.set("checked",i?1:0),i){var n=this.groups.get(t.id);n.get("types").length&&(this.watchedTypesIds[o]=e.pluck(n.get("types"),"code"))}else delete this.watchedTypesIds[o];this.setUserData("watched.types",this.watchedTypesIds)}},toggleType:function(t,i,o){if(t instanceof s&&t.id&&i){var n=t.id,r=i.code,a=this.watchedTypesIds[n]||[];o?-1==e.indexOf(a,r)&&a.push(r):a=e.without(a,r),a.length?this.watchedTypesIds[n]=a:delete this.watchedTypesIds[n],this.setUserData("watched.types",this.watchedTypesIds)}},removeGroup:function(i){if(i){var o=0,n=this;o=e.isObject(i)?i.id||0:Number(i),o&&t.ajax({url:App.getBaseUrl()+"poi-groups/delete/",data:{id:o},complete:function(e){e.status>=200&&e.status<300||c(e),n.trigger("groupremoved",o)}})}},removePoi:function(e){if(e instanceof n){var i=0,o=this;i=e.id||0,i&&t.ajax({url:App.getBaseUrl()+"poi/delete/",data:{id:i},complete:function(t){t.status>=200&&t.status<300||c(t),o.trigger("poiremoved",e)}})}}};return h}),define("_common/poi/PoiType",["underscore","jquery","abstracts/Group","_common/poi/PoiCollection"],function(e,t,i){var o=i.extend({constructor:function(){i.apply(this,arguments)},defaults:{name:"",bounds:null,checked:!1,nbItems:0},getBounds:function(){}});return o}),define("text!_common/poi/editor/tmpl/formGroup.html",[],function(){return'<input class="input-block-level no-margin" name="name" type="text"\n       placeholder="<%= i18n.enterGroupName %>" value="<%- name %>" maxlength="255">'}),define("text!_common/poi/editor/tmpl/formPoi.html",[],function(){return'<!--<input class="input-block-level" name="address" type="text" placeholder="<%= i18n.enterPoiAddress %>" value="<%- address || \'\' %>">-->\n<div class="form-search">\n    <div class="input-append input-prepend">\n        <span class="add-on">\n            <input name="address" type="text" placeholder="<%= i18n.enterPoiAddress %>" value="<%- address || \'\' %>">\n            <i class="icon-clear svg-icon svg-icon-circle-remove"></i>\n        </span>\n        <span class="btn add-on btn-search"><i class="svg-icon svg-icon-search"></i></span>\n    </div>\n</div>\n\n<input type="hidden" name="lat" value="<%= lat %>">\n<input type="hidden" name="lon" value="<%= lon %>">\n\n<input class="input-block-level" name="name" type="text"\n       placeholder="<%= i18n.enterPoiName %>" value="<%- name && name == address ? \'\' : name %>">\n\n<select class="input-block-level placeholder group-select" name="poiGroupId">\n    <% if(groups.length > 1) { %>\n    <option value="0"><%= i18n.selectPoiGroup %></option>\n    <% } %>\n    <% _.each(groups, function(group){%>\n    <option value="<%= group.id %>"<% if(groupId && groupId == group.id) {%> selected<% } %>><%- group.name %></option>\n    <% }) %>\n</select>\n<select class="input-block-level placeholder no-margin" name="poiTypeId">\n    <% if(types.length > 1) { %>\n    <option value="0"><%= i18n.selectPoiType %></option>\n    <% } %>\n    <% _.each(types, function(t){%>\n    <option value="<%= t.id %>"<% if(type && type.id == t.id) {%> selected<% } %>><%- t.name %></option>\n    <% }) %>\n</select>\n\n\n'}),define("text!_common/poi/editor/tmpl/formImport.html",[],function(){return'<a data-placeholder="<%= i18n.chooseFile %>..." class="btn btn-file btn-block text-left" style="padding-left:10px">\n    <%= i18n.chooseFile %>...\n</a>\n<div style="height:0;width:0;overflow:hidden">\n    <input type="file" name="file" accept="text/*">\n</div>'}),define("_common/poi/editor/views/PoiEditorView",["jquery","jqueryui","underscore","jface","_libs/jquery/jquery.form","abstracts/editor/views/EditorView","text!_common/poi/editor/tmpl/formGroup.html","text!_common/poi/editor/tmpl/formPoi.html","text!_common/poi/editor/tmpl/formImport.html","css!_common/poi/css/poi.css"],function(e,t,i,o,n,s,r,a,l){a=i.template(a),l=i.template(l);var d=s.extend({constructor:function(){this._tmplGroup=i.template(r),s.apply(this,arguments)},_bindEvents:function(){var t=this,i=this.model;s.prototype._bindEvents.apply(this,arguments),this.listenTo(i,"needimport",function(){t.$el.removeClass("hidden"),i.previous("model")?c.onCancel.call(t,function(){c.renderImportForm.call(t)},function(){i.set("model",i.previous("model"),{silent:!0})}):c.renderImportForm.call(t)}),this._form.off("submit").ajaxForm({data:{authorization:App.getBasic()},beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+App.getBasic())},beforeSerialize:function(e,i){return e.find("input[type=file]").length?(e[0].enctype="multipart/form-data",i.url=App.getBaseUrl()+"poi/upload/mvk",void 0):(t._onSubmit(),!1)},beforeSubmit:function(e,i){if(t.loading)return!1;var o=i.find("input[type=file]");return o.length&&!o.val()?!1:(t.loading=!0,t.$el.addClass("loading"),void 0)},uploadProgress:function(){},success:function(){t._close(),t.model.get("parent").trigger("groupadded")},error:function(i,o){var n=t.model.getTexts();if("timeout"==o)var s=n.errors.serverConnectionTimeout;else try{var r=e.parseJSON(i.responseText),s=r.msg}catch(a){var s=n.errors.callServerFailed}s&&t._showErrors(s)},complete:function(){t.$el.removeClass("loading"),t.loading=!1}})},_renderItemForm:function(e){var e=e||this.model.get("model"),t=this.model.getTexts();this._body.html(a(i.extend({},e.attributes,{i18n:t,groups:this.model.getGroupsList(),types:this.model.getTypesList()}))),this._initAddressSearch()},_initEditableObject:function(){var e=this.model.get("model");if(e.id){var t=this;this.listenTo(e,"change:coordinates",function(e,i){t._body.find("input[name=lat]").val(i[0]).end().find("input[name=lon]").val(i[1])})}else s.prototype._initEditableObject.apply(this,arguments)},_putAddressMarker:function(e){var t=this.model.get("model");if(t.id){var i=[parseFloat(e[0].lat),parseFloat(e[0].lon)];i[0]&&i[1]&&t.set({lat:i[0],lon:i[1],coordinates:i})}else s.prototype._putAddressMarker.apply(this,arguments)},_onCancel:function(e,t){if(this._form.find("input[type=file]").length)this._close();else{var i=this.model[e?"previous":"get"]("model");if(i.has("prevCoordinates")&&i.id){var o=i.get("prevCoordinates"),n=t||function(){};t=function(){i.set({lat:o[0],lon:o[1],coordinates:o},{zoom:!1}),n()}}s.prototype._onCancel.call(this,e,t)}}}),c={renderImportForm:function(){if(!this.loading){var t=this.model.getTexts();this._body.html(l({i18n:t}));var i=this._body.find("input[name=file]"),o=this._body.find(".btn-file").on("click",function(){i.click()});i.on("change",function(){var i,n=e(this).val();if(this.files&&this.files.length&&this.files[0].size>1048576&&(alert(t.errorFileSize.replace("#s#","1Mb"),t.error),this.value=null),n){var s=n.lastIndexOf(n.charAt(n.indexOf(":")+1));i=n.substring(s+1)}o.text(i||n||o.data("placeholder"))}),this.model.trigger("toggleform",this._form.height())}}};return d}),define("_common/poi/editor/PoiEditorModule",["jquery","underscore","abstracts/editor/EditorModule","_common/poi/Poi","_common/poi/PoiGroup","_common/poi/editor/views/PoiEditorView"],function(e,t,i,o,n,s){var r=i.extend({constructor:function(){i.apply(this,arguments)},initialize:function(){this.ItemsClass=o,this.GroupsClass=n,this._itemEditUrl=App.getBaseUrl()+"poi/edit/",this._itemCreateUrl=App.getBaseUrl()+"poi/create/",this._groupEditUrl=App.getBaseUrl()+"poi-groups/edit/",this._groupCreateUrl=App.getBaseUrl()+"poi-groups/create/",i.prototype.initialize.call(this,s);var e=this;this.listenTo(App,"clearmap",function(t){t==e.get("mapsModule")&&e.get("model")instanceof o&&e.set("model",null)})},saveModel:function(n){var s=this,r=new e.Deferred;if(!this.has("model"))return r.reject();var a=this.get("model");return a.id&&(n.id=a.id),a instanceof o?s._saveItem(n).done(function(e){var i=e.groups[0],o=i.pois[0],n=o.type;s.set("model",null),a.set({groupId:i.id});var r=a.get("name")!==o.name;if(t.each(["name","lat","lon","geoId"],function(e){a.set(e,o[e])}),a.id){var l=a.get("type");l.id!=n&&a.set({type:t.clone(e.types[n])}),r&&s.get("parent").trigger("poinamechanged",a)}else a.set({id:o.id,type:t.clone(e.types[n])}),s.get("parent").trigger("itemadded",i.id,a)}).fail(function(e){r.reject(e)}):i.prototype.saveModel.call(s,n)},getTypesList:function(){return t.values(this.get("parent").types)},_saveItem:function(t){var i,o=new e.Deferred;return(i=this._validateItem(t))?o.reject(i):(t.address&&!t.name&&(t.name=t.address),t.address&&delete t.address,t.lat=parseInt(1e6*t.lat),t.lon=parseInt(1e6*t.lon),e.ajax({url:t.id?this._itemEditUrl:this._itemCreateUrl,data:t,success:function(e){o.resolve(e)},error:function(e){o.reject(e)}}),o)},_validateItem:function(e){var t=[],i=this.getTexts();return e.lat&&e.lon||t.push({msg:i.poiCoordinatesAreNotDetected,key:"address"}),e.name=String(e.name),e.name||e.address||t.push({msg:i.enterPoiAddressOrName,key:["name","address"]}),e.poiGroupId||t.push({msg:i.errorSelectPoiGroup,key:"poiGroupId"}),e.poiTypeId||t.push({msg:i.errorSelectPoiType,key:"poiTypeId"}),t.length?t:null},_validateGroup:function(e){var t=this.getTexts();return i.prototype._validateGroup.call(this,e,{name:{empty:t.errorPoiGroupName}})}});return r}),define("text!_common/tmpl/itemTreeElement.html",[],function(){return'<i class="icon icon-leaf" data-item="<%= id %>"></i>\n<div class="row leaf-row">\n    <table><tr>\n        <td class="col0">\n            <a href="javascript:;" data-item="<%= id %>">\n                <em class="name" title="# <%= id %>"><%- name %></em>\n            </a>\n        </td>\n        <% if( extraCols ){ _.each(extraCols, function(col,i){ %>\n        <td class="col<%= i+1 %><%if(col.addClass){ print(\' \' + col.addClass); }%>"><%= col.value %></td>\n        <% }); } %>\n        <% if( editable ){ %>\n        <td class="col-act"><i class="icon icon-edit"></i></td>\n        <% } %>\n        <% if( removable ){ %>\n        <td class="col-act"><i class="icon icon-remove"></i></td>\n        <% } %>\n    </tr></table>\n</div>\n'}),define("_common/views/ItemTreeView",["jquery","underscore","abstracts/View","text!_common/tmpl/itemTreeElement.html"],function(e,t,i,o){var n=i.extend({constructor:function(){this.parent=null,this.module=null,this.name=null,this.extraCols=[],i.apply(this,arguments)},initialize:function(e){var t=this;this.parent=e.parent,this.module=e.module,this.listenTo(this.model,"change",function(){t.onModelChange()}).listenTo(this.parent,"clear",function(){t.remove()}).listenTo(this.module,"change:itemsCols",function(){t.render()}),this.module.checkedItems&&this.listenTo(this.model,"add",function(e,i){i==this.module.checkedItems&&t.$el.addClass("checked")}).listenTo(this.model,"remove",function(e,i){i==t.module.checkedItems&&t.$el.removeClass("checked")
})},render:function(){var e=this;return this.extraCols=[],this.module.get("itemsCols")&&t.each(this.module.get("itemsCols"),function(t,i){t&&e.extraCols.push({prop:i,addClass:i,value:e.model.has(i)?e.model.get(i):""})}),this.$el.html(t.template(o,t.extend({},this.model.attributes,{extraCols:e.extraCols},{editable:this.module.get("editItems"),removable:this.module.get("deleteItems")}))),this.name=this.name||this.$el.find(".name"),this.$el},onModelChange:function(){var e=this.model,i=this;e.hasChanged("name")&&this.name.text(e.get("name")),t.each(this.extraCols,function(t){e.hasChanged(t.prop)&&i.$el.find("."+t.addClass).text(e.get(t.prop))})}});return n}),define("text!_common/tmpl/groupTreeElement.html",[],function(){return'<i class="icon icon-exp"></i>\n<i class="icon icon-check"></i>\n<div class="row branch-row">\n    <table>\n        <tr>\n            <td class="col0">\n                <a class="row-title name" href="javascript:;"><%- name %></a>\n            </td>\n            <td class="col1 nb-items">(<%= nbItems %>)</td>\n            <% if( \'undefined\' != typeof editable && editable ){ %>\n            <td class="col-act"><i class="svg-icon svg-icon-caret-down icon-edit"></i></td>\n            <% } %>\n            <% if( \'undefined\' != typeof removable && removable ){ %>\n            <td class="col-act"><i class="svg-icon svg-icon-remove icon-remove"></i></td>\n            <% } %>\n        </tr>\n    </table>\n</div>\n<ul class="sub">\n    <li class="placeholder"></li>\n</ul><!--/sub-list l-1-->'}),define("_common/views/GroupTreeView",["jquery","underscore","abstracts/View","_common/views/ItemTreeView","text!_common/tmpl/groupTreeElement.html"],function(e,t,i,o,n){var n=t.template(n),s=1,r=2,a=i.extend({tagName:"li",className:"branch closed",attributes:{"data-group":!0},constructor:function(){this.sub=null,this.parent=null,this.module=null,i.apply(this,arguments)},initialize:function(e){e&&(this.parent=e.parent||null,this.module=e.module);var t=this;this.model&&(this.updateChecked(),this.listenTo(this.model,"request",function(){}).listenTo(this.model,"sync error",function(){}).listenTo(this.model,"change:closed",function(e,i){t.$el[i?"addClass":"removeClass"]("closed")}).listenTo(this.model,"change:nbItems",function(e,i){t.$el.find(">.row-branch .nb-items").text("("+i+")")})),this.parent&&this.listenTo(this.parent,"clear",function(){t.remove()}),this.$el.data("id",this.model.id)},render:function(){var e=this.model,i={};(App.allowed("poi.edit")||App.allowed("poi.delete"))&&(i.editable=!0);var o=n(t.extend(i,e.attributes));return this.updateChecked(),this.$el.html(o),this.sub=this.$el.find("ul.sub"),e.get("closed")?this.$el.addClass("closed"):this.$el.removeClass("closed"),this.$el},updateChecked:function(){var e=this.model.get("checked"),t=this.el.className;e==s?(-1!=t.indexOf("partly")&&this.$el.removeClass("partly"),-1==t.indexOf("checked")&&this.$el.addClass("checked")):e==r?(-1!=t.indexOf("checked")&&this.$el.removeClass("checked"),-1==t.indexOf("partly")&&this.$el.addClass("partly")):this.$el.removeClass("checked partly")},remove:function(){i.prototype.remove.apply(this,arguments),this.trigger("clear")}});return a}),define("text!_common/poi/tree/tmpl/typeTreeElement.html",[],function(){return'<li class="leaf<% if(checked) {%> checked <% } %>" data-type="true" data-id="<%= id %>">\n    <i class="icon icon-check" data-action="check" data-id="<%= id %>"></i>\n    <div class="row" data-action="check" data-id="<%= id %>">\n        <table>\n            <tr>\n                <td class="col0">\n                    <a class="row-title type-title" href="javascript:;"><%- name %></a>\n                </td>\n                <td class="col1 nb-items">(<%= nbItems %>)</td>\n            </tr>\n        </table>\n    </div>\n</li>'}),define("_common/poi/tree/views/PoiGroupView",["jquery","underscore","_common/views/GroupTreeView","text!_common/poi/tree/tmpl/typeTreeElement.html"],function(e,t,i,o){var o=t.template(o),n=1,s=2,r=i.extend({constructor:function(){this.module=null,i.apply(this,arguments)},initialize:function(e){var t=this;this.module=e.module,this.listenTo(this.model,"change:name",function(e,i){t.$el.find(">.row .name").text(i)}).listenTo(this.model,"change:nbItems",function(e,i){t.$el.find(">.row .nb-items").text("("+i+")")}),i.prototype.initialize.apply(this,arguments)},render:function(){var e=this.model,t=e.get("checked");i.prototype.render.apply(this,arguments),t==s&&(this.module.watchedTypesIds[e.id]||[]);var o;return(o=e.get("types"))&&(o.length?(this.$el.addClass("expandable"),e.get("closed")||this.renderTypes()):this.$el.removeClass("expandable")),this.$el},renderTypes:function(){var e=this.model,i=e.get("checked"),r="",a=e.get("types");if(i==s)var l=this.module.watchedTypesIds[e.id]||[];t.each(a,function(e){e.checked=!1,(i==n||i==s&&-1!=t.indexOf(l,e.code))&&(e.checked=!0),r+=o(e)}),this.sub.html(r)}});return r}),define("text!_common/poi/tree/tmpl/contextMenu.html",[],function(){return'<ul class="nav nav-list context-menu" style="display:none">\n    <% if(App.allowed(\'poi.edit\')) {%>\n    <li><a href="#" data-action="groupedit"><%= i18n.renameGroup %></a></li>\n    <% } if(App.allowed(\'poi.delete\')) {%>\n    <li><a href="#" data-action="groupremove"><%= i18n.removePoiGroup %></a></li>\n    <% } %>\n</ul>\n'}),define("_common/poi/tree/views/PoiTreeView",["jquery","underscore","jface","abstracts/View","_common/poi/tree/views/PoiGroupView","text!_common/poi/tree/tmpl/contextMenu.html","css!_common/poi/css/poi.css"],function(e,t,i,o,n,s){s=t.template(s);var r=o.extend({tagName:"ul",className:"tree tree-grid poi-tree",constructor:function(){this._cont=null,this._groupViews={},o.apply(this,arguments)},initialize:function(){var e=this,i=this.model.get("parent");this._cont=this.model.get("container"),this.listenTo(this.model.groups,"request",function(){e.$el.addClass("loading").empty(),e._groupViews={}}).listenTo(this.model.groups,"sync",function(i){var o=e.model.get("q");i.each(function(i){var s=new n({model:i,module:e.model,attributes:{"data-group":!0,"data-id":i.id}});if(o){o=o.toLowerCase();var r=i.get("types"),a=!1;r&&t.each(r,function(e){-1!=e.name.toLowerCase().indexOf(o)&&(a=!0)}),i.set("closed",!a)}e.$el.append(s.render()),e._groupViews[i.id]=s}),e.$el.removeClass("loading")}).listenTo(this.model.groups,"error",function(){e.$el.removeClass("loading")}).listenTo(this.model.groups,"remove",function(t){e.$el.find(".branch[data-id="+t.id+"]").remove(),e._groupViews[t.id]=null}).listenTo(i,"grouptoggle",function(t,o){var n=e._groupViews[t.id],s=i.groups.get(t.id);n&&s.get("types").length&&(n.$el.removeClass("partly")[o?"addClass":"removeClass"]("checked"),n.sub.find("li")[o?"addClass":"removeClass"]("checked"))}).listenTo(i,"typetoggle",function(t,o,n){var s=e._groupViews[t.id];if(s){var r=s.sub.find("li[data-id="+o+"]");r[n?"addClass":"removeClass"]("checked");var a=0,l=i.groups.get(t.id);i.watchedTypesIds[t.id]&&(a=i.watchedTypesIds[t.id].length),a==l.get("types").length?s.$el.removeClass("partly").addClass("checked"):a?s.$el.removeClass("checked").addClass("partly"):s.$el.removeClass("checked partly")}}).listenTo(i,"itemadded",function(t,i){var o,n;if(e.model.get("q"))e.model.set("q","");else if((o=e.model.groups.get(t))&&(n=e._groupViews[t])){var s=n.sub.find(".branch[data-id="+t+"]");i.type||i.get("type").id,s.replaceWith(n.render())}}).listenTo(i,"poiremoved",function(){a.removePoi.apply(e,arguments)}),this.render()},render:function(){this.$el.appendTo(this._cont),this._cont.append(s({i18n:this.model.getTexts()}));var t=this,o=this._cont.find(".context-menu"),n=this.model,r=n.getTexts();e.fn.contextmenu&&o.length&&(App.allowed("poi.edit")||App.allowed("poi.delete"))&&(o.appendTo("body"),this._cont.contextmenu({selector:".branch>.row",menu:o,position:{my:"left top"},before:function(t,i){var o=e(t.currentTarget).closest(".branch"),s=o.data("id");return s?(n.groups.get(s),i.active.data("model",n.groups.get(s)),void 0):!1}}),this.$el.on("click",".icon-edit",function(e){return e.preventDefault(),t._cont.contextmenu("open",e),!1}),o.on("click","[data-action]",function(){var t,s=e(this).data("action");if(t=o.data("model"))if("groupremove"==s){var a=t.get("nbItems"),l="";l=a>0?r.poiGroupRemovingText.replace("#n#",a).replace("#t#",r[1==a%10&&11!=a%100?"poi1":"pois1"]):r.poiEmptyGroupRemovingText,i.confirm(l,r.poiGroupRemovingHeader,{okCallback:function(){n.get("parent").trigger("groupremove",t)}})}else n.get("parent").trigger(s,t)})),a.bindEvents.call(this)}}),a={bindEvents:function(){var t=this,i=this.model,o=t.model.get("parent");i.getTexts(),this.$el.on("click","li[data-group]>.row, li[data-group]>.icon-check",function(){var t,n=e(this).closest("[data-group]"),s=n.data("id");(t=i.groups.get(s))&&o.trigger("grouptoggle",t,n.is(".checked")||n.is(".partly")?!1:!0)}).on("click",'[data-action="check"]',function(){var t,n=e(this),s=n.closest("[data-group]"),r=n.data("id"),a=s.data("id");(t=i.groups.get(a))&&o.trigger("typetoggle",t,r,n.closest("[data-type]").is(".checked")?!1:!0)}).on("click",".icon-exp",function(o){o.preventDefault();var n,s=e(this).closest("[data-group]").data("id");if(n=i.groups.get(s)){var r=!n.get("closed");n.set("closed",r),i.trigger("groupexpand",n.id,r);var a=t._groupViews[n.id];r?a.sub.html('<li class="placeholder"></li>'):a.renderTypes()}})},removePoi:function(e,t){var i,o;t=t||e.get("groupId"),(i=this.model.groups.get(t))&&(o=this._groupViews[t])&&o.render()}};return r}),define("_common/poi/tree/PoiTreeModule",["jquery","underscore","abstracts/Module","_common/poi/PoiCollection","_common/poi/PoiGroupsCollection","_common/poi/tree/views/PoiTreeView"],function(e,t,i,o,n,s){var r=0,a=1,l=2,d=i.extend({constructor:function(){this.groups=new n,this.groups.module=this,this._openedGroups=[],this.watchedTypesIds=null,i.apply(this,arguments)},defaults:{container:null,parent:null,q:"",loading:!1},initialize:function(){if(this.get("container")){this._openedGroups=this.getUserData("openedGroups")||[],this.watchedTypesIds=this.get("parent").watchedTypesIds,c.bindEvents.call(this),this._view=new s({model:this});var e=this.get("parent").get("active");e?this.reload():this.listenToOnce(this.get("parent"),"change:active",this.reload)}},reload:function(){var e=this,t={},i=this.groups.url,o=this.getTexts();this.get("q")&&(i+="query/",t.q=this.get("q")),this.groups.fetch({url:i,statusCode:{500:function(){alert(o.commonPoiServerError,o.error)}},data:t,success:function(){!t.q&&(e.get("parent").types=e.groups.types)}})},isGroupClosed:function(e){return-1==t.indexOf(this._openedGroups,e)},isGroupEditable:function(){return this.get("allowEdit")},isGroupRemovable:function(){return this.get("allowRemove")},setTop:function(e){this._view.el.style.top=e+"px"},getTexts:function(){return this.get("parent").getTexts()}}),c={bindEvents:function(){var e=this,i=this.get("parent");this.get("parent").getEventsPrefix(),this.listenTo(this.groups,"sync",function(e){var o,n=i.watchedTypesIds;e.each(function(e){if(e.set("checked",r),e.id in n&&(o=n[e.id],o.length)){var s;if(s=i.groups.get(e.id)){var d=t.pluck(s.get("types"),"code");o.length==d.length?e.set("checked",a):e.set("checked",l)}else{var c=t.pluck(e.get("types"),"code");o.length==c.length?e.set("checked",a):e.set("checked",l)}}})}).listenTo(i,"groupremoved",function(i){e.groups.remove(i),e.isGroupClosed(i)||(e._openedGroups=t.without(e._openedGroups,i),e.setUserData("openedGroups",e._openedGroups))}).listenTo(i,"reload",function(){e.set("q","",{silent:!0}),e.reload()}).listenTo(i,"itemadded",function(o,n){var s;if(s=e.groups.get(o)){s.set("nbItems",s.get("nbItems")+1);var r,d=s.get("types")||[],c=n.type||n.get("type").id,p=!d.length;(r=t.findWhere(d,{id:c}))?r.nbItems+=1:(r=t.clone(i.types[c]),r.nbItems=1,r.checked=!1,d.push(r),s.get("checked")==a&&s.set("checked",l)),p&&(s.set("types",d),s.set("closed",!1),e._openedGroups.push(Number(o)),e.setUserData("openedGroups",e._openedGroups))}}).listenTo(i,"poiremoved",function(){c.removePoi.apply(e,arguments)}),this.on("groupexpand",function(i,o){i&&(o?(e._openedGroups=t.without(e._openedGroups,i),e.setUserData("openedGroups",e._openedGroups)):e.isGroupClosed()&&(e._openedGroups.push(i),e.setUserData("openedGroups",e._openedGroups)))}).on("change:q",function(){e.reload()})},filter:function(){function i(e){return-1!=e.toLowerCase().indexOf(o)}var o=e.trim(this.get("q")).toLowerCase(),n=this.getTexts();if(o.length<3)return alert(n.errorGroupsSearchStringMinLength,n.error);var s=[],r=[],a=this.get("parent").types;t.each(a,function(e){i(e.name)&&r.push(e.id)}),console.log(r),s=this.groups.filter(function(e){return i(e.get("name"))}),console.log(s)},removePoi:function(e,i,o){var n,s=this.get("parent");if(i=i||e.get("groupId"),o=o||e.get("type").id,n=this.groups.get(i)){n.set("nbItems",n.get("nbItems")-1);var d,c=n.get("types")||[],p=!c.length,u=!1;if(p)return;if((d=t.findWhere(c,{id:o}))&&(d.nbItems-=1,d.nbItems<=0&&(u=!0,c=t.without(c,d),d.checked&&s.trigger("typetoggle",n,o,!1))),n.set("types",c),c.length){if(u&&n.get("checked")==l){for(var h=!0,m=c.length;m--;)if(!c[m].checked){h=!1;break}h&&n.set("checked",a)}}else n.get("checked")==a&&s.trigger("grouptoggle",n,!1),n.set("checked",r),n.set("closed",!0)}}};return d}),define("text!_common/poi/watched/tmpl/poi.html",[],function(){return'<div class="poi-icon">\n	<svg viewBox="0 0 26 32" class="svg-marker">\n		<path class="svg-path" d="M4,0h18c2.209,0,4,1.791,4,4v17.999c0,2.209-1.791,4-4,4H4c-2.209,0-4-1.791-4-4V4C0,1.791,1.791,0,4,0z M7,25.999h12.001 L13,32L7,25.999z"/>\n	</svg>\n	<svg viewBox="0 0 18 18" class="svg-poi-icon">\n		<use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#poi-icon-<%= type %>"></use>\n	</svg>\n</div>\n<div class="poi-name">\n	<%- name %>\n</div>\n'}),define("_common/poi/watched/views/PoiTypeMapView",["jquery","underscore","abstracts/View","text!../tmpl/poi.html","_libs/leaflet/leaflet-src"],function(e,t,i,o){o=t.template(o);var n=i.extend({constructor:function(){this.parent=null,this.module=null,this._maps=null,this._viewsMap={},this._bounds=null,i.apply(this,arguments)},initialize:function(e){var i=this,n=i._viewsMap;return this.parent=e.parent,this.module=e.module,this._maps=this.module.get("mapsModule"),this._maps?(this.listenTo(this.module,"change:showNames",function(e,i){t.keys(n).forEach(function(e){var t=n[e],o=t.options.icon.options;o.className="poi-marker"+(i?" show-name":""),t.setIcon(new L.ComplexIcon(o))})}).listenTo(this.module.get("parent"),"poinamechanged",function(e){if(e.id in n){var t=n[e.id],i=t.options.icon.options;i.html=o({type:e.get("type").code,name:e.get("name")}),t.setIcon(new L.ComplexIcon(i))}}),void 0):console&&console.error("PoiTypeMapView: No Maps module for POI watching")},buildPoiMarker:function(e){if(e.attributes&&(e=e.attributes),e.lat&&e.lon){var t="",i=this.module.get("showNames");i&&(t=" show-name");var n=this._viewsMap[e.id]=this._maps.buildMarker({lat:e.lat,lon:e.lon,className:"poi-marker"+t,html:o({type:e.type.code,name:e.name}),data:e,attributes:{"data-code":e.type.code}});return n}},removePoi:function(e){e.id in this._viewsMap&&(this.parent.removePoi(this._viewsMap[e.id]),delete this._viewsMap[e.id],t.keys(this._viewsMap).length||this.remove())},remove:function(e){var i=this,o=this.parent,n=!1;if(this.stopListening(this.module),this.stopListening(this.model),!e)var s=setTimeout(function(){App.loading("show"),n=!0},200);setTimeout(function(){t.each(i._viewsMap,function(e){o.removePoi(e)}),i._viewsMap={},s&&clearTimeout(s),n&&App.loading("hide")},0)},getPoiViews:function(){return t.values(this._viewsMap)}});return n}),define("text!_common/poi/watched/tmpl/poiInfo.html",[],function(){return'<div class="header clearfix">\n    <div class="header-main">\n        <h4>\n            <% if(\'undefined\' != typeof name && name) {%>\n            <%= name %>\n            <% } else if(\'undefined\' != typeof type.name) {%>\n            <%= type.name %>\n            <% } %>\n        </h4>\n        <% if(\'undefined\' != typeof name && name && \'undefined\' != typeof type.name && type.name) {%>\n        <h5><%= type.name %></h5>\n        <% } %>\n    </div>\n    <div class="header-left">\n        <i class="icon-special"></i>\n    </div>\n</div>\n\n<% if(\'undefined\' != typeof addressStr) {%>\n<address data-geoid="<%= geoId %>" class="address"><i class="svg-icon svg-icon-spinner icon-spin"></i> <%= addressStr %></address>\n<% } %>\n\n<!--<%= lat %>, <%= lon %>-->\n<% _.each(actions, function(action){%>\n    <% if(!action.html) {%>\n    <a href="javascript:;" class="<%= action.class %>">\n        <%- action.text %>\n    </a>\n    <% } else if(\'string\' == typeof action.html) { %>\n        <%= action.html %>\n    <% } else if(_.isFunction(action.html)) {%>\n        <%= action.html() %>\n    <% } %>\n<% }); %>\n\n<a href="<%= externalLink %>" target="_blank" class="external-link<% if(isYandex){%> ydx <% } %>"><i class="icon"></i> <%= i18n[isYandex ? \'showOnYandexMap\' : \'showOnGoogleMap\'] %></a>\n\n<% if(removable || routingModule){%>\n<div class="poi-actions">\n    <% if(removable){%>\n    <a href="javascript:;" class="poi-delete"><%= i18n.delete.ucFirst() %></a>\n    <% } %>\n    <% if(editable){%>\n    <a href="#poi" class="poi-edit"><%= i18n.edit.ucFirst() %></a>\n    <% } %>\n    <% if(routingModule){%>\n    <a href="javascript:;" class="route-to pull-right"><%= i18n.routeHere %></a>\n    <% } %>\n</div>\n<% } %>'}),define("_common/poi/watched/views/PoiInfoView",["jquery","underscore","abstracts/View","text!_common/poi/watched/tmpl/poiInfo.html"],function(e,t,i,o){o=t.template(o);var n=i.extend({constructor:function(){this.module=null,this.parent=null,this.address=null,i.apply(this,arguments)},initialize:function(e){var t=this;this.module=e.module,this.parent=e.parent,this.listenTo(this.model,"remove",function(){t.trigger("close")}),this.on("close",function(){t.stopListening(t.model)}).on("searchstart",function(){t.address&&t.address.addClass("loading")}).on("searchcomplete",function(){t.address&&t.address.removeClass("loading")}).on("searchsuccess",function(e){e.address==t.model.get("name")?t.address&&t.address.addClass("hidden"):t.address&&t.address.text(e.address),t.model.set("address",e.address)}).on("searcherror",function(){t.address&&t.address.append(". Error")})},render:function(){var e=this.module.getPoiActions(this.model),i=this.model.get("address")||"",n=this.module.get("mapsModule"),r=-1!=n.get("usedMap").indexOf("andex"),a=Math._round(this.model.get("lat"),4),l=Math._round(this.model.get("lon"),4),d=i?i:a+", "+l,c="https://www.google.com/maps/place/"+a+"+"+l+"/@"+a+","+l+",17z";r&&(c="https://maps.yandex.ru/2/saint-petersburg/?ll="+l+","+a+"&z=17");var p=t.extend({},this.model.attributes,{geoId:this.model.has("geoId")?this.model.get("geoId"):0,addressStr:d,actions:e,removable:App.allowed("poi.delete"),editable:App.allowed("poi.edit"),routingModule:n.modules.routing||null,isYandex:r,externalLink:c,i18n:this.module.getTexts()});this.$el.html(o(p)),this.address=this.$el.find(".address"),i||s.loadAddress.call(this);var u=this;return this.$el.on("click","a.poi-delete",function(){u.module.trigger("poiremove",u.model)}).on("click","a.poi-edit",function(){u.trigger("poiedit")}).on("click","a.route-to",function(){var e=u.model.get("address");n.openRouting([null,{type:"address",text:e?e:a+", "+l,lat:a,lon:l}],u.$el)}),this.$el.find(".positive").numeric({decimal:".",negative:!1}),this.$el}}),s={loadAddress:function(){if(this.address&&this.address.length){var e=this.module.get("mapsModule");e.trigger("needgeoinfo",this.model.pick("lat","lon"),this)}}};return n}),define("text!_common/poi/watched/tmpl/settings.html",[],function(){return'<h4><%= i18n.pois %></h4>\n<div class="control-group">\n    <label class="checkbox"><input type="checkbox" class="showNames" <% if (!_.isUndefined(showNames) && showNames) {%> checked<%} %>/> <%= i18n.showPoiNamesOnMap %></label>\n</div>'}),define("_common/poi/watched/views/PoiWatchedView",["jquery","underscore","abstracts/View","_common/poi/Poi","_common/poi/PoiType","_common/poi/watched/views/PoiTypeMapView","_common/poi/watched/views/PoiInfoView","text!../tmpl/settings.html","css!_common/poi/css/poi.css"],function(e,t,i,o,n,s,r,a){var l=i.extend({constructor:function(){this._maps=null,this._mapViews={},this._layer=null,this._infoView=null,this._popup=null,i.apply(this,arguments)},initialize:function(){this._maps=this.model.get("mapsModule"),d.bindEvents.call(this),e("#settings").length?d.initSettings.call(this):this.listenTo(App,"settingsready",t.bind(d.initSettings,this))},addMulti:function(t,i){for(var o,n,s=this,r=t.length,a=[],l=!1,c=setTimeout(function(){App.loading("show"),l=!0},200);r--;)n=t[r],(o=i.buildPoiMarker(n))&&(!function(t){t.bindPopup(function(){var i=t.options.data;if(s.prepareInfoView(i)){var o=this,n=this.getContainer();return e(n).addClass("marker-info poi-info selectable").attr("data-code",i.type.code).data("marker",t),s.listenTo(s._infoView,"poiedit",function(){var e=s._infoView.model;d.onPoiEdit.call(s,e,t),o.close()}).listenToOnce(s._infoView,"close",function(){s.stopListening(s._infoView),s._infoView=null}),this.on("close",function(){s._infoView&&s._infoView.trigger("close")}),s._infoView.render()}return!1})}(o),a.push(o));a.length&&(null===this._layer?d.createLayer.call(this,a):this._layer.addLayers(a)),c&&clearTimeout(c),l&&App.loading("hide")},removePoi:function(e){this._layer&&this._layer.removeLayer(e)},clear:function(){t.each(this._mapViews,function(e){t.each(e,function(e){e.remove()})}),this._layer&&this._layer.trigger("destroy"),this._mapViews={},this._layer=null},prepareInfoView:function(e){return this._infoView&&this._infoView.model.id==e.id?!1:(this._removeInfoView(),this._infoView=new r({className:"poi-info-content",model:new o(e),module:this.model,parent:this}),!0)},_removeInfoView:function(){this._infoView&&(this.stopListening(this._infoView),this._infoView.remove(),this._infoView=null)}}),d={bindEvents:function(){var e=this,i=this.model,o=i.get("parent");this.listenTo(o,"grouptoggle",function(t,i){i?d.onGroupChecked.call(e,t):t.id in e._mapViews&&d.onGroupUnchecked.call(e,t.id)}).listenTo(o,"typetoggle",function(i,o,n){n?d.onTypeChecked.call(e,i,o):i.id in e._mapViews&&o in e._mapViews[i.id]&&(e._mapViews[i.id][o].remove(),delete e._mapViews[i.id][o],t.keys(e._mapViews[i.id]).length||delete e._mapViews[i.id])}).listenTo(i,"groupload",function(i,o){var n,s,r={},o=o||{},a=0;if(!(i.id in e._mapViews)){if(!o.createViews)return;d.onGroupChecked.call(e,i)}if(n=i.get("pois")){for(!o.silent&&e._maps.fitBounds(i.get("bounds"),{animate:!1,maxZoom:15}),a=n.length;a--;)s=r[n[a].type.id]||[],s.push(n[a]),!r[n[a].type.id]&&(r[n[a].type.id]=s);t.each(e._mapViews[i.id],function(t,i){r[i]&&e.addMulti(r[i],t)})}}).listenTo(i,"typeload",function(t,i,o,n){if(n=n||{},!(t.id in e._mapViews&&i.id in e._mapViews[t.id])){if(!n.createViews)return;d.onTypeChecked.call(e,t,i.id)}n.silent||e._maps.fitBounds(t.get("bounds"),{animate:!1,maxZoom:15}),e.addMulti(o,e._mapViews[t.id][i.id])}).listenTo(o,"groupremoved",function(t){t in e._mapViews&&d.onGroupUnchecked.call(e,t)}).listenTo(o,"itemadded",function(t,i){if(t in e._mapViews){var o=e._mapViews[t],n=i.type||i.get("type").id;n in o&&e.addMulti([i],o[n])}}).listenTo(o,"poiremoved",function(){d.removePoi.apply(e,arguments)}),this.listenTo(App,"clearmap",function(t){t&&t===e._maps&&(o.groups.length?o.trigger("toggleall",!1):(o.setUserData("watched.types",{}),o.watchedTypesIds=i.watchedTypesIds={},this.clear()))})},initSettings:function(){var i=this,o=this.model.get("parent"),n=e("#settings").find(".poi-watched").removeClass("hidden");n.html(t.template(a,{i18n:o.getTexts(),showNames:i.model.get("showNames")})),n.find(".showNames").on("click",function(){i.model.set("showNames",this.checked)})},createLayer:function(e){var t=App.getUserData("objectsGrouping");this._layer=this._maps.addLayersGroup({layers:e||[],clusters:t.usedGrouping&&{maxClusterRadius:30,icon:{html:"<div><span>#count#</span></div>",className:"poi-cluster"}}})},onGroupChecked:function(e){var i=this,o=this._mapViews[e.id]||{},n=e.get("types");t.each(n,function(t){t.id in o||d.createTypeView.call(i,e.id,t)})},onGroupUnchecked:function(e){var i=this._mapViews[e];t.each(i,function(e){e.remove()}),delete this._mapViews[e]},onTypeChecked:function(e,i){var o=this._mapViews[e.id]||{};if(!(i in o)){var n,s=e.get("types");(n=t.findWhere(s,{id:i}))&&d.createTypeView.call(this,e.id,n)}},createTypeView:function(e,t){var i=this._mapViews[e]||{};i[t.id]=new s({model:new n(t),module:this.model,parent:this}),!this._mapViews[e]&&(this._mapViews[e]=i)},onPoiEdit:function(e,t){var i=this,o=this.model;e.set("prevCoordinates",[e.get("lat"),e.get("lon")]),t.dragging.enable(),t.on("dragend",function(){var o=t.getLatLon();e.set({lat:o[0],lon:o[1],coordinates:o},{source:i})}),this.listenTo(e,"change:coordinates",function(e,o,n){if(n.source!=i){t.setLatLng(o);var s=!n||n.zoom!==!1;s&&i._maps.zoomTo(o,{maxZoom:15})}}).listenTo(e,"change",function(){if(e.hasChanged("name")&&(t.options.data.name=e.get("name")),e.hasChanged("type")||e.hasChanged("groupId")){var i=o.get("parent"),n=i.groups.get(e.get("groupId"));o.watchedTypesIds,e.get("type").id,i.trigger("poiremoved",e,e.previous("groupId"),e.previous("type").id),i.trigger("itemadded",n.id,e)}}),o.trigger("poiedit",e),this.listenToOnce(o,"poieditclose",function(o){o.id==e.id&&(i.stopListening(e,"change:coordinates"),t.off("dragend"),t.dragging.disable())})},removePoi:function(e,i,o){i=i||e.get("groupId");var n=this._mapViews[i];if(n){o=o||e.get("type").id;var s=n[o];s&&(this._infoView&&this._infoView.model.id==e.id&&this._removeInfoView(),s.removePoi(e),s.getPoiViews().length||(delete n[o],t.keys(n).length||delete this._mapViews[i]))}}};return l}),define("_common/poi/watched/PoiWatchedModule",["jquery","underscore","abstracts/Module","_common/poi/Poi","_common/poi/PoiGroupsCollection","_common/poi/watched/views/PoiWatchedView"],function(e,t,i,o,n,s){var r=i.extend({constructor:function(){this.watchedTypesIds=null,i.apply(this,arguments)},defaults:t.extend({},i.prototype.defaults,{showNames:!1}),initialize:function(){this.set("showNames",this.getUserData("showNames")||!1),this.watchedTypesIds=this.get("parent").watchedTypesIds,a.bindEvents.call(this),this._view=new s({model:this}),this.reload()},reload:function(){this._view.clear();var e=this,i={groups:[]};t.each(this.watchedTypesIds,function(e,t){i.groups.push({id:Number(t),types:e})}),i.groups.length&&a.loadPoi.call(this,i).done(function(i){var o=new n(i,{parse:!0});o.each(function(i){i.calcBounds(),i.get("types").length==t.keys(e.watchedTypesIds[i.id]).length&&e.trigger("groupload",i,{createViews:!0,silent:!0})})})},getPoiActions:function(){return this.get("parent").getPoiActions()},getTexts:function(){return this.get("parent").getTexts()}}),a={bindEvents:function(){var e=this,t=this.get("parent");this.on("change:showNames",function(t,i){e.setUserData("showNames",i)}).listenTo(t,"toggleall",function(t){t&&e.reload()}).listenTo(t,"grouptoggle",function(i,o,s){var s=s||{},r=t.groups.get(i.id);o&&!s.silent&&r.get("types").length&&a.loadPoi.call(e,{groups:[{id:i.id}]}).done(function(t){var i=new n(t,{parse:!0});i.each(function(t){t.calcBounds(),e.trigger("groupload",t,s)})})}).listenTo(t,"typetoggle",function(i,o,s){if(s){var r=t.types[o];a.loadPoi.call(e,{groups:[{id:i.id,types:[r.code]}]}).done(function(t){var o=new n(t,{parse:!0}),s=o.get(i.id);s.calcBounds(),e.trigger("typeload",s,r,s.get("pois"))})}}).listenTo(t,"reload",function(){e.reload()}).listenTo(App,"objectsGroupingChange",function(){e.reload()})},loadPoi:function(t){return e.ajax({url:App.getBaseUrl()+"poi-groups/filtered/",data:t})}};return r});