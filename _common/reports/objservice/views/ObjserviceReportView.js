define(["jquery","underscore","../../views/ReportView","text!../tmpl/reportMeta.html","text!../../tmpl/reportTable.html","text!../tmpl/thead.html","text!../tmpl/detailedThead.html","text!../tmpl/row.html","text!../tmpl/detailedRow.html","text!../tmpl/summaryRow.html"],function(e,t,a,s,r,d,i,o,n,l){var p=a.prototype;s=t.template(s),r=t.template(r),d=t.template(d),i=t.template(i),o=t.template(o),n=t.template(n),l=t.template(l);var m=a.extend({constructor:function(){a.apply(this,arguments)},render:function(){var s=new e.Deferred;a.prototype.render.apply(this,arguments),this.$el.addClass("objservice-report"),this.buildMetaInfo(),this.content.append(r({key:this.model.get("key"),theadHtml:""}));var d=this.content.find(".rep-table tbody"),i="";return this.model.get("detailed")?(i+=this._renderDetailedHead(),i+=this._renderDetailedRows()):(i+=this._renderHead(),i+=this._renderRows(),d.find(".grade-details [data-grade]").on("click",function(){var a=_private.filterObjectsByGrade.call(self,e(this).data("grade"));a.length&&report.buildChildReport(t.pluck(a,"id"))})),d.append(i),this._bindRowClicks(),s.resolve(),s},buildMetaInfo:function(){if(this.content){var e=this.model;if(e.get("detailed")){var a=e.get("objectId"),r=e.get("body")[a[0]];this.content.append(s({title:r.name+" (#"+r.extId+")",i18n:e.getTexts(),properties:t.without(e.get("properties"),"name","extId"),names:this.mobileProps,values:r,startTime:e.get("startTime"),endTime:e.get("endTime")}))}else p.buildMetaInfo.call(this)}},_renderHead:function(){var e=this.model;return d({properties:e.get("properties"),propNames:this.mobileProps,statuses:e.get("statuses"),statusNames:this._getStatusNames()})},_renderRows:function(){for(var e,a,s,r=this.model,d=(r.getTexts(),r.get("body")),i=r.get("header").keyOrder,n=r.get("properties"),l=r.get("statuses"),p="",m=0,u=i.length;u>m;++m)e=i[m],a=d[e],s=[],t.each(l,function(e){s.push(Date.formatSeconds(e in a?a[e]:0))}),p+=o({data:a,id:e,properties:n,durations:s,isLast:m==u-1,rowClass:(m+1)%2?"odd":"even"});return p},_renderDetailedHead:function(){var e=this.model;return i({i18n:e.getTexts(),statuses:e.get("statuses"),statusNames:this._getStatusNames()})},_renderDetailedRows:function(){var e,a,s=this.model,r=this,d="",i=s.get("objectId"),o=i[0],p=s.get("body")[o],m=0,u=(t.keys(p.data).length,s.get("statuses")),h={};return t.each(p.data,function(s,i){a=[],t.each(u,function(t){e=t in s?s[t]:0,a.push(Date.formatSeconds(e)),h[t]=h[t]||0,h[t]+=e}),d+=n({id:o,date:App.MS*i,dateS:r.formatDate(i),durations:a,rowClass:(m+1)%2?"odd":"even",isLast:!1}),m++}),d+=l({i18n:s.getTexts(),durations:t.map(h,function(e){return Date.formatSeconds(e)})})},_getStatusNames:function(){var e=this.model.getTexts();return{served:e.objServed,service:e.service,notServed:e.objNotServed,control:e.alertsControl}},_bindRowClicks:function(){var a,s=this.model,r=s.get("detailed"),d=s.get("header"),i=this.getDaysPeriods(d.sd,d.ed),o=s.get("body"),n=t.keys(i).length>1&&!r,l=s.get("type");this.content.on("mousedown",".rep-row[data-id]",function(){var t=e(this).data("id");a={ts:+new Date,id:t,data:o[t]},n||(a.date=e(this).data("date"))}).on("mouseup",".rep-row[data-id]",function(){if(a){var t=e(this).data("id"),r=+new Date;t==a.id&&r-a.ts<300&&s.buildChildReport(n?l:"objjournal",{objectId:a.id,startTime:!n&&a.date?a.date:s.get("startTime")})}})}});return m});