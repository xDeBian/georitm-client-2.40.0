var PRODUCTION=!0;define("_common/reports/schedule/ScheduleTaskModel",["jquery","abstracts/Model"],function(e,t){var i=App.getTimezone({offset:60*App.getUserTimezone()}).id,n=t.extend({constructor:function(){t.apply(this,arguments)},idAttribute:"uuid",defaults:{editable:!0,addresses:[],name:"",parameters:{objectId:[]},period:"day",start:null,end:null,schedule:{hour:"0",minute:"0"},type:"RUN",objType:App.TYPE_MOBILE,uuid:null,tzId:i},initialize:function(){console.log()},parse:function(t){var i=t;if("parameters"in i)try{var n=e.parseJSON(i.parameters);i.objType=n.objType}catch(s){}return App.reportAllowedByType(i.type)||(i.editable=!1),/OUTTEMP|DEVTEMP|COOLTEMP/i.test(i.type)&&(i.type="TEMPERATURE"),i},set:function(i){if(t.prototype.set.apply(this,arguments),"object"==typeof i.parameters?this.attributes.parameters=i.parameters:"string"==typeof i.parameters&&(this.attributes.parameters=e.parseJSON(i.parameters)),"undefined"!=typeof i.schedule){var n={};"object"==typeof i.schedule?n=i.schedule:"string"==typeof i.schedule&&(n=e.parseJSON(i.schedule)),"undefined"!=typeof n.dayOfWeek?n.dayOfWeek=n.dayOfWeek.split(","):"undefined"!=typeof n.dayOfMonth&&(n.dayOfMonth=n.dayOfMonth.split(",")),this.attributes.schedule=n}}});return n}),define("_common/reports/schedule/ScheduleTasksCollection",["abstracts/Collection","./ScheduleTaskModel"],function(e,t){var i=e.extend({url:App.getBaseUrl()+"rsch/list/",model:t,comparator:function(e,t){var i=String(e.get("name")),n=String(t.get("name")),s=i>n?1:i==n?0:-1;return s},constructor:function(){e.apply(this,arguments)}});return i}),define("text!_common/reports/schedule/tmpl/list.html",[],function(){return'<h3><%= i18n.reportsList %></h3>\n<ul id="tasks-list"></ul>\n<div class="actions">\n    <% if(creation) {%>\n    <a class="command-add" href="#"><%= i18n.createScheduleTask %></a>\n    <% } %>\n    <a class="command-remove hidden" href="#"><%= i18n.delete.ucFirst() %> <%= i18n.report %></a>\n</div>\n'}),define("text!_common/reports/schedule/tmpl/scheduleItem.html",[],function(){return'<li<% if(!editable) {%> class="task-error"<% } %>>\n    <a data-id="<%= uuid %>" href="javascript:;"><%- name %></a>\n</li>'}),define("_common/reports/schedule/views/ScheduleListView",["jquery","underscore","jface","abstracts/View","text!../tmpl/list.html","text!../tmpl/scheduleItem.html"],function(e,t,i,n,s,a){s=t.template(s),a=t.template(a);var r=n.extend({constructor:function(){this.module=null,this.loading=!1,n.apply(this,arguments)},className:"nav",initialize:function(t){this.module=t.module;var n=this,s=this.module.getTexts();this.render(),this.listenTo(this.collection,"request",function(){n.$el.addClass("loading")}).listenTo(this.collection,"error sync",function(){n.$el.removeClass("loading")}).listenTo(this.collection,"sync add remove",function(){o.renderList.call(n)}).listenTo(this.module,"change:currentTask",function(e,t){var i=e.previous("currentTask");i&&(n.stopListening(i),i.id&&n.$el.find("a[data-id="+i.id+"]").removeClass("active")),n.$el.find(".command-remove")[t&&t.id?"removeClass":"addClass"]("hidden"),t&&(o.bindTaskEvents.call(n,t),t.id&&n.$el.find("a[data-id="+t.id+"]").addClass("active"))}),this.$el.on("click","[data-id]",function(){n.module.editTask(e(this).data("id"))}).on("click",".command-add",function(){n.module.editTask(null)}).on("click",".command-remove",function(){return i.confirm(s.scheduleTaskdeleteConfirmMsg,s.delete.ucFirst()+"?",{okCallback:function(){n.module.removeTask()}})})},render:function(){this.$el.html(s({creation:this.module.get("creation"),i18n:this.module.getTexts()})),this.$el.appendTo(this.module.get("container"))}}),o={renderList:function(){var e="",i=this.module.getTexts();this.collection.each(function(n){e+=a(t.extend({},n.attributes,{i18n:i}))}),this.$el.find("ul").html(e);var n=this.module.get("currentTask");n&&n.id&&this.$el.find("a[data-id="+n.id+"]").addClass("active")},bindTaskEvents:function(e){var t=this;e.id||this.listenToOnce(e,"change:uuid",function(){t.$el.find(".command-remove").removeClass("hidden")}),this.listenTo(e,"change:name",function(i,n){t.$el.find("a[data-id="+e.id+"]").text(n)})}};return r}),define("text!_common/reports/tmpl/deviceProps.html",[],function(){return'<fieldset class="obj-props<% if(\'undefined\' != typeof hidden && hidden){ %> hidden<% } %>">\n    <legend><%= i18n.objProps %></legend>\n    <input type="hidden" name="properties" value="fake"><% //else we will have defaults in Report %>\n    <div class="row-fluid">\n        <div class="span6">\n            <label class="checkbox">\n                <input type="checkbox" value="extId" name="properties"<% if(_.indexOf(properties, \'extId\') != -1) { %> checked<% } %>>\n                <%= i18n.objIdNumberShort %>\n            </label>\n            <label class="checkbox">\n                <input type="checkbox" value="name" name="properties"<% if(_.indexOf(properties, \'name\') != -1) { %> checked<% } %>>\n                <%= i18n.objName %>\n            </label>\n            <label class="checkbox">\n                <input type="checkbox" value="groups" name="properties"<% if(_.indexOf(properties, \'groups\') != -1) { %> checked<% } %>>\n                <%= i18n.objGroup %>\n            </label>\n            <label class="checkbox">\n                <input type="checkbox" value="carId" name="properties"<% if(_.indexOf(properties, \'carId\') != -1) { %> checked<% } %>>\n                <%= i18n.licenseNumber %>\n            </label>\n\n            <% if(\'undefined\' != typeof showHardwareType) {%>\n            <label class="checkbox">\n                <input type="checkbox" value="deviceTypeName" name="properties"<% if(_.indexOf(properties, \'deviceTypeName\') != -1) { %> checked<% } %>>\n                <%= i18n.objHardwareType %>\n            </label>\n            <% } %>\n\n        </div><div class="span6">\n            <label class="checkbox">\n                <input type="checkbox" value="model" name="properties"<% if(_.indexOf(properties, \'model\') != -1) { %> checked<% } %>>\n                <%= i18n.objModel %>\n            </label>\n            <label class="checkbox">\n                <input type="checkbox" value="type" name="properties"<% if(_.indexOf(properties, \'type\') != -1) { %> checked<% } %>>\n                <%= i18n.vehicleType %>\n            </label>\n            <label class="checkbox">\n                <input type="checkbox" value="vin" name="properties"<% if(_.indexOf(properties, \'vin\') != -1) { %> checked<% } %>>\n                <%= i18n.objVin %>\n            </label>\n            <label class="checkbox">\n                <input type="checkbox" value="year" name="properties"<% if(_.indexOf(properties, \'year\') != -1) { %> checked<% } %>>\n                <%= i18n.objYear %>\n            </label>\n        </div>\n    </div>\n</fieldset>'}),define("_common/reports/ReportsMixin",["jquery","underscore","text!_common/reports/tmpl/deviceProps.html"],function(e,t,i){function n(e,i,n){return function(s){e.find(".alert-groups-list");var a=e.find('select[name="alertGroupId"]'),r="";t.each(s,function(e){r+='<option value="'+e.id+'"'+(t.isArray(n)&&t.indexOf(n,e.id)>-1?" selected":"")+">"+e.name+"</option>"}),a.html(r),a.chosen({disable_search:!0,no_results_text:i.searchNoResults})}}function s(e,i,n){function s(e,i){if(!i.length)return this._alerts;var n=t.filter(e,function(e){return t.indexOf(i,e.groupId)>-1});return n}function a(e){var t=String(e);return 4===t.length?String(Number(t)/10):t}function r(e,i,n){if("undefined"==typeof n){var r=e.val()||[];n=t.map(r,Number)}var d="",l=i,c=o.filter(":checked");if(c.length>0&&c.length<o.length){var u=c.map(function(){return Number(this.value)});l=s(i,u)}t.each(l,function(e){d+='<option value="'+e.code+'"'+(t.isArray(n)&&t.indexOf(n,e.code)>-1?" selected":"")+">"+a(e.code)+" "+e.message+"</option>"}),e.html(d),e.data("chosen")&&e.trigger("chosen:updated")}var o=e.find('.alert-groups-list input[name="alertGroupId"]');return function(t){var s=e.find(".alerts-list"),a=e.find('select[name="alertMessageCode"]');r(a,t,n),o.on("click",function(){r(a,t)}),a.on("chosen:showing_dropdown",function(e,t){var i=t.chosen.container;i.find(".chosen-results li").each(function(){this.setAttribute("title",this.innerText)})}),a.on("chosen:ready change",function(){s.find(".search-choice > span").each(function(){this.setAttribute("title",this.innerText)})}),a.chosen({disable_search:!1,disable_search_threshold:10,no_results_text:i.searchNoResults})}}function a(e,i,n,s,a){return function(r){var o=e.find(".comments-group-params"),d=o.closest("fieldset"),l=e.find(".comments-list"),c=!!a,u=[];u=u.concat(t.map(r.comments,function(e){return e.msg}));var p=t.map(u,function(e){return n({name:"logComment",value:e,label:e,checked:!s||s.indexOf(e)>-1})}).join("");p+=n({name:"_customLogComment",value:1,label:i.otherComments,checked:c}),l.html(p);var m=o.find(".custom-comment-group"),h=m.find("input");if(c&&(m.removeClass("hidden"),h.prop("disabled",!1).val(a)),o.find('input[name="_customLogComment"]').on("click",function(){m.toggleClass("hidden",!this.checked),h.prop("disabled",!this.checked),this.checked&&h.focus()}),!s||s.length){var f=!s||s.length>=u.length,v=d.find("input.select-all");v.prop("checked",f).prop("indeterminate",!f)}(c||s&&s.length)&&d.addClass("opened"),d.selectAll({indeterminates:!0,selector:'input[name="logComment"]'})}}function r(e,i,n){return function(s){var a=s.channels,r=e.find(".channels-list"),o=r.closest("fieldset"),d=n&&n.length;if(a.length){o.removeClass("hidden"),d&&o.addClass("opened");var l=1===a.length,c=[],u=!l&&t.isArray(n),p=l||!u;n&&(c=n.filter(function(e){return a.indexOf(e)>-1}),p=p||c.length===a.length);var m=t.map(a,function(e){return i({name:"channelName",value:e,label:e,checked:p||n.indexOf(e)>-1,readonly:l})}).join("");if(p||c.length){var h=o.find("input.select-all");h.prop("checked",p).prop("indeterminate",!p)}l&&e.find('input[name="allChannelName"]').prop("disabled",!0),r.html(m),o.selectAll({indeterminates:!0,selector:'input[name="channelName"]'})}else o.remove()}}function o(i){var n=new e.Deferred,s=[e.ajax({url:i+"alert-actions/get/"}),e.ajax({url:i+"alert-comments/get/"})];return e.when.apply(null,s).done(function(e,i){n.resolve({actions:t.sortBy(e[0],"num"),comments:t.sortBy(i[0],"num")})}).fail(n.reject),n}i=t.template(i);var d={_buildParameterReportFields:function(t,n,s){var a=new e.Deferred,r=this,o="number"==typeof s?s:s.length;return requirejs(["text!mobile/reports/"+t+"/tmpl/params.html"],function(e){var s=d._renderParameterReportFields.call(r,t,n,o>1,e,i);a.resolve(s[0],s[1])},function(){a.reject()}),a},_renderParameterReportFields:function(e,i,n,s,a){var r=this,o=this.getStoredParam(e,"properties")||["extId","name"],d=this.getStoredParam(e,"dataSource")||i.dataSource,l=i.thresholds,c=this.getStoredParam(e,d+".thresholds")||l[d],u=this.getStoredParam(e,"mintime"),p=this.getTexts();t.isNull(u)&&(u=i.mintime);var m=Math.floor(u/60);return[t.template(s,{i18n:p,propertiesHtml:a({hidden:!n,properties:o,i18n:p}),dataSource:d,thresholds:c,minutes:m,seconds:u-60*m}),function(t){i.showProperies=n,r._initParameterReportFields(e,t,i)}]},_initParameterReportFields:function(i,n,s){var a=this,r=s.minThresholdsDiff,o=n.find("input[name=thresholds]").numeric({decimal:".",negative:s.allowNegative});o.on("change",function(){var i=e(this),a=i.data("index"),d=parseFloat(i.val()),l=i.data("min"),c=i.data("max"),u=o.filter("[data-index="+(0==a?1:0)+"]");if(t.isNaN(d)){var p=s.dataSource,m=n.find("input[name=dataSource]:checked");m.length&&(p=m.val()),d=s.thresholds[p][a],i.val(d)}else l>d?(d=l,i.val(d)):d>c&&(d=c,i.val(d));if(0==a)u.val()<=d&&u.val(d+r);else if(1==a){var h=Math.max(d-r,u.data("min"));h>=d&&i.val(h+r),u.val()>=d&&u.val(h)}}),n.find("input[name=dataSource]").on("click",function(){if(this.checked){var e=a.getStoredParam(i,this.value+".thresholds")||s.thresholds[this.value];o.first().val(e[0]),o.last().val(e[1])}});var d=n.find("input[name=minutes]")[0],l=n.find("input[name=seconds]")[0];e(d).on("change",function(){var e=parseInt(d.value);0>e&&(d.value="0",e=0),60==e?(l.disabled=!0,l.value="0"):(l.disabled=!1,l.max="59",0==e||(l.min="0"))}),e(l).on("change",function(){var e=parseInt(l.value);e<l.min&&(l.value=l.min,e=parseInt(l.min))})},buildTemperatureExtraFields:function(e){var i=t.find(["OUTTEMP","DEVTEMP","COOLTEMP"],function(e){return App.reportAllowedByType(e)});return this._buildParameterReportFields("temperature",{mintime:300,dataSource:i,thresholds:{DEVTEMP:[-40,85],OUTTEMP:[2,6],COOLTEMP:[70,105]},allowNegative:!0,minThresholdsDiff:1},e)},buildVoltageExtraFields:function(e){var i=t.find(["CARPOWER","ACC"],function(e){return App.reportAllowedByType(e)});return this._buildParameterReportFields("voltage",{mintime:300,dataSource:i,thresholds:{CARPOWER:[11,29],ACC:[3.7,4.2]},allowNegative:!1,minThresholdsDiff:.01},e)},buildEngspeedExtraFields:function(e){return this._buildParameterReportFields("engspeed",{dataSource:"default",mintime:0,thresholds:{"default":[0,600,3e3]},allowNegative:!1,minThresholdsDiff:1},e)},_renderDrivesafetyExtraFields:function(n,s,a){var r,o=this.getStoredParam(n,"properties")||["extId","name"],d=new e.Deferred,l=this.getTexts(),c=App.isMapMatchingAllowed()?"paramsMapMatching":"params";return requirejs(["text!mobile/reports/"+n+"/tmpl/"+c+".html"],function(e){var c={i18n:l,isSummary:a,propertiesHtml:i({properties:o,i18n:l})};t.each(s,function(e,t){r=this.getStoredParam(n,t),c[t]=null===r?e:r}.bind(this)),d.resolve(t.template(e,c))}.bind(this)),d},_toggleDrifesafetyCheckboxes:function(e,t){var i=e.find(".checkbox-single"),n=e.find(".checkbox-summary"),s=t?n:i,a=t?i:n;a.addClass("hidden").find("input").prop("disabled",!0),s.removeClass("hidden").find("input").prop("disabled",!1)},_initDrivesafetyExtraFields:function(i,n,s,a){var r=this,o=arguments,l=r.model&&r.model.get("parameters"),c=l?l.zoneId:this.getStoredParam(i,"zoneId")||[];if(d.buildSelectorZone.call(this,{htmlBlock:a,i18n:r._i18n,selected:c}),a.find(".set-defaults").on("click",function(){return t.each(n,function(e,t){r.clearStoredParam(i,t)}),r._renderDrivesafetyExtraFields(i,n,s).done(function(e){a.html(e),r._initDrivesafetyExtraFields.apply(r,o)}),!1}),a.find(".integer").numeric({decimal:!1,negative:!1}),a.find(".positive").numeric({decimal:".",negative:!1}),a.find(".negative").numeric({decimal:".",negative:!0}),App.isMapMatchingAllowed()){var u=a.find('input[name="speedExcessUnits"]'),p=a.find('input[name="speedExcessLimits"]'),m=a.find(".excess-unit");u.on("click",function(){var e=this.value,t=r.getStoredParam("drivesafety","speedExcessLimits")||n.speedExcessLimits;p.each(function(i){this.value=t[e][i]}),m.html("kmh"===e?r.getTexts().kmh:"%")})}else{var h,f=a.find("[data-limitsgroup]");f.each(function(){var t=e(this);h=t.find("input[data-index]"),function(i){var n=i.length;i.on("change",function(){for(var i,s=e(this),a=s.data("index"),r=a,o=s.val(),d=Number(o);r--;)i=t.find('input[data-index="'+r+'"]'),Number(i.val())>=d&&i.val(Math.max(0,d-(a-r)));for(r=a;++r<n;)i=t.find('input[data-index="'+r+'"]'),Number(i.val())<=d&&i.val(d+(r-a))})}(h)})}},buildDrivesafetyExtraFields:function(t){var i=this,n=t.length>1,s=new e.Deferred,a="drivesafety";return requirejs(["mobile/reports/"+a+"/DrivesafetyReport"],function(e){var t=n,r=e.prototype.defaults,o=App.getReportsAndTracksProcessor(),l=o?o.options.objectsDefined:!1;i._renderDrivesafetyExtraFields(a,r,n).done(function(e){s.resolve(e,function(e){if(i._initDrivesafetyExtraFields(a,r,n,e),d._toggleDrifesafetyCheckboxes(e,n),!l){var s=function(i){return i.length?(t=n,n=i.length>1,n!=t&&d._toggleDrifesafetyCheckboxes(e,n),void 0):(App.off("toggleobjects",s),void 0)};App.on("toggleobjects",s),App.once("processorsubmit",function(){App.off("toggleobjects",s)})}},function(){s.reject()})})}),s},_initObjectsPropertiesToggle:function(e,t){var i=e.find("fieldset.obj-props"),n=App.getReportsAndTracksProcessor(),s=n?n.options.objectsDefined:!1;if(t===!1&&i.addClass("hidden"),!s){var a=function(e){i[e.length>1?"removeClass":"addClass"]("hidden")};App.on("toggleobjects",a),App.once("processorsubmit",function(){App.off("toggleobjects",a)})}},buildGuardscallcountExtraFieldsBak:function(){var i=new e.Deferred,n=this;return i.reject(),requirejs(["text!_common/reports/guardscallcount/tmpl/params.html"],function(e){var s=n.get("parent");i.resolve(t.template(e,{i18n:n._i18n,minNumber:s.getUserData("guardscallcount.minNumber")||1}),function(e){e.find("input[name=minNumber]").numeric({decimal:!1,negative:!1})})},function(){i.reject()}),i},getDrivesafetyDefaultParameters:function(){return{accelerationMintime:3,speedingMintime:20,showStatistics:!1,showCalculation:!1,accelerationLimit:2,accelerationWeight:1,brakingLimit:-2,brakingWeight:1,speedLimits:[60,90,110,130],speedWeights:[0,1,3,5],gradeThresholds:[4,7],showSummary:!0,showTop:!0,showListWithViolations:!0,showListWithSumScore:!0,zoneId:[]}},getDrivesafetyMapMatchingDefaultParameters:function(){return Object.assign(t.omit(this.getDrivesafetyDefaultParameters(),"gradeThresholds","showListWithViolations","showListWithSumScore"),{speedingMintime:3,speedExcessLimits:{kmh:[0,20,40,60],percentage:[0,20,50,100]},speedExcessWeights:[0,10,50,100],speedExcessUnits:"kmh",useMileageOrQuantity:"mileage",showObjectsStatistics:!1})},buildObjserviceExtraFields:function(){var i=new e.Deferred,n=this,s="objservice";return requirejs(["text!_common/reports/"+s+"/tmpl/params.html"],function(e){var a=n.getStoredParam(s,"statuses")||["served","service","notServed"],r=n.getStoredParam(s,"roundToDays")!==!1,o=n.getTexts();i.resolve(t.template(e,{i18n:o,statuses:a,roundToDays:r,propertiesHtml:n._renderPropertiesCheckboxes(s)}))},function(){i.reject("templates require failed")}),i},_getObjectPropertiesForReport:function(e){return this.getStoredParam(e,"properties")||["extId","name"]},_renderPropertiesCheckboxes:function(e){var t=this._getObjectPropertiesForReport(e);return i({properties:t,showHardwareType:!0,i18n:this.getTexts()})},buildAlertjournalExtraFields:function(i){var d=new e.Deferred,l=this,c=Number(i[0].get("objType"))===App.TYPE_STAT;return requirejs(["text!_common/reports/alertjournal/tmpl/params.html","text!_common/reports/alertjournal/tmpl/paramCheckbox.html"],function(i,u){u=t.template(u),l.get("parent");var p="alertjournal",m=l._i18n,h=App.getBaseUrl(),f=l.getStoredParam(p,"alertGroupId"),v=l.getStoredParam(p,"alertMessageCode"),g=l.getStoredParam(p,"channelName"),b=l.getStoredParam(p,"logComment"),y=l.getStoredParam(p,"customLogComment"),x=l.getStoredParam(p,"params"),k=function(e){return!x||x.indexOf(e)>-1},T=[{key:"receivedAt",name:m.timeOfReceive,readonly:!0,checked:k("receivedAt")},{key:"alertTs",name:m.timeOfCreation,checked:k("alertTs")},{key:"code",name:m.alertCode,checked:k("code")},{key:"message",name:m.alertOrCommentMessage,checked:k("message"),readonly:!0},{key:"group",name:m.alertsGroup,checked:k("group")},{key:"extId",name:m.objIdNumber,checked:k("extId")},{key:"address",name:m.address.ucFirst(),checked:k("address"),isStationary:!0},{key:"objectName",name:m.objTitle,checked:k("objectName")},{key:"areaNum",name:m.objArea,checked:k("areaNum"),isStationary:!0},{key:"areaName",name:m.objAreaName,checked:k("areaName"),isStationary:!0},{key:"zoneNum",name:m.objZoneKey,checked:k("zoneNum"),isStationary:!0},{key:"zoneName",name:m.objZoneKeyName,checked:k("zoneName"),isStationary:!0},{key:"channelName",name:m.inputStream,checked:k("channelName")},{key:"userId",name:m.userid,checked:k("userId")},{key:"userName",name:m.username.ucFirst(),checked:k("userName")}];d.resolve(t.template(i,{i18n:m,isStationary:c,params:T}),function(t){var i=n(t,m,f),d=[e.ajax({url:h+"alert-template-group/list/"}).done(function(n){i(n),e.ajax({url:h+"alert-template/list/"}).done(s(t,m,v))}),o(h).done(a(t,m,u,b,y)),e.ajax({url:h+"alerts/channels/",data:{}}).done(r(t,u,g))];e.when(d).always(function(){var i=t.closest(".processor");t.on("click",".group-toggle",function(){var t=e(this).closest("fieldset");t.toggleClass("opened",!t.is(".opened")),i.trigger("contentchange")}),setTimeout(function(){i.trigger("contentchange")},500),setTimeout(function(){t.find(".loading").removeClass("loading"),i.trigger("contentchange")},1800)});var l=t.find("fieldset:last-child"),c=!x||x.length>=T.length;l.selectAll({indeterminates:!0,selector:'input[name="params"]'}),l.find("input.select-all").prop("checked",c).prop("indeterminate",!c)})},d.reject),d},buildSelectorZone:function(e){var i=e.htmlBlock,n=e.selected,s=e.i18n||{},a=t.isArray(n)?n:t.isNumber(n)?[n]:[],r="",o=i.find("select[name=zoneId]"),d=App.get("geozones");t.each(d,function(e){r+='<option value="'+e.id+'"'+(t.indexOf(a,e.id)>-1?" selected":"")+">"+e.name+"</option>"}),o.html(r),o.chosen({disable_search:!0,no_results_text:s.searchNoResults})}};return d}),define("text!_common/reports/schedule/tmpl/task.html",[],function(){return'<div class="header">\n    <h3><% if(uuid) { %><%- name %><% } else { %><%= i18n.newReport %><% } %></h3>\n</div>\n\n<div class="content">\n    <fieldset class="task-params">\n\n        <% if(allowMobile && allowStat) { %>\n        <div class="params-group">\n            <h4><%= i18n.reportObjType %></h4>\n            <div class="field form-horizontal">\n                <label class="radio" style="width:auto; margin-right:10px">\n                    <input name="objType" type="radio" value="<%= App.TYPE_MOBILE %>"\n                    <% if(objType == App.TYPE_MOBILE) { %> checked<% } %>>\n                    <%= i18n.vehicles %>\n                </label>\n                <label class="radio">\n                    <input name="objType" type="radio" value="<%= App.TYPE_STAT %>"\n                    <% if(objType == App.TYPE_STAT) { %> checked<% } %>>\n                    <%= i18n.stationary %>\n                </label>\n            </div>\n        </div>\n        <% } else { %>\n            <input name="objType" type="hidden"\n                   value="<%= ( allowStat ? App.TYPE_STAT : App.TYPE_MOBILE ) %>">\n        <% } %>\n\n        <div class="params-group">\n            <h4><%= i18n.propertiesReport %></h4>\n            <input type="hidden" name="format" value="xls" />\n            <div class="field">\n                <label><%= i18n.title.ucFirst() %></label>\n                <input type="text" class="itext" name="name" value="<%= name %>" />\n            </div><div class="field">\n                <label><%= i18n.typeOfReport %></label>\n                <select name="type">\n                    <% _.each(reportsGroups, function(items, key){ %>\n                    <optgroup<% if(!/tech|history/.test(key)) { %> data-mobile="true"<% } %>\n                        label="<%= i18n.reportGroupNames[key] %>">\n                        <% _.each(items, function(r, key){ %>\n                        <option value="<%= r.type %>"><%= r.name %></option>\n                        <% }) %>\n                    </optgroup>\n                    <% }) %>\n                </select>\n            </div><div class="field">\n                <label><%= i18n.recipientEmails %></label>\n                <textarea name="addresses"><%= addresses %></textarea>\n            </div>\n        </div>\n\n        <div class="params-group">\n            <h4><%= i18n.objectsWhichReport %></h4>\n            <div class="field">\n                <label><%= i18n.searchingObjectsAndGroups %></label>\n                <input type="text" class="itext ignore" name="q" value="" />\n            </div><div class="field">\n                <label class="nb-objs" style="line-height:25px">\n                    <%= i18n.selectedObjects %>:\n                    <input type="text" class="offscreen ignore" name="nbobjs" value="<%= parameters.objectId.length %>">\n                    <i class="nb-objs-value"><%= parameters.objectId.length %>"></i>\n                </label>\n                <div class="selected-objects">\n                    <!--<div class="list"></div>-->\n                </div><!-- /schedule-objs -->\n            </div>\n        </div>\n\n        <div class="params-group report-period">\n            <h4><%= i18n.reportPeriod %></h4>\n            <div class="field select-block">\n                <select name="period"<% if(type==\'OBJST\') { %> disabled<% } %>>\n                    <option value="day"<% if(period==\'day\') { %> selected<% } %>><%= i18n.previousDay %></option>\n                    <option value="week"<% if(period==\'week\') { %> selected<% } %>><%= i18n.previousWeek %></option>\n                    <option value="month"<% if(period==\'month\') { %> selected<% } %>><%= i18n.previousMonth %></option>\n                    <option value="current-month"<% if(period==\'current-month\') { %> selected<% } %>><%= i18n.currentMonth %></option>\n                </select>\n            </div>\n            <div class="field form-horizontal report-period-limit<% if(period != \'day\') { %> hidden<% } %>">\n                <div class="control-group">\n                    <label><%=i18n.time.ucFirst() + \' \' + i18n.fromDate %>:</label>\n                    <div class="input-append bootstrap-timepicker no-margin">\n                        <input type="text" name="start" value="00:00" class="input-time input-small"\n                            <% if(period != \'day\') { %> disabled<% } %>>\n                        <span class="add-on">\n                            <i class="icon-time"></i>\n                        </span>\n                    </div>\n                </div>\n                <div class="control-group">\n                    <label><%=i18n.time.ucFirst() + \' \' + i18n.to %>:</label>\n                    <div class="input-append bootstrap-timepicker no-margin">\n                        <input type="text" name="end" value="00:00" class="input-time input-small"\n                            <% if(period != \'day\') { %> disabled<% } %>>\n                        <span class="add-on">\n                            <i class="icon-time"></i>\n                        </span>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <div class="params-group">\n            <h4><%= i18n.timezoneGenerateReport %></h4>\n            <div class="field select-block">\n                <select name="tzId">\n                    <% var sel = false; _.each(App.getTimezonesList(), function(tz){\n                    var selected = !sel\n                        && (\n                            ( \'undefined\' != typeof tzId && tzId == tz.id )\n                            || ( \'undefined\' != typeof tzMin && tzMin == tz.offset )\n                            || ( \'undefined\' != typeof tz && tz * 60 == tz.offset )\n                        )\n                    %>\n                    <option value="<%= tz.id %>"\n                    <% if(selected) { sel = true;%> selected<% } %>>\n                    <%= App.getFullTimezoneName(tz) %>\n                    </option>\n                    <% }) %>\n                </select>\n            </div>\n        </div>\n\n        <div class="params-group">\n            <h4>\n                <%= i18n.scheduleReportGeneration %>\n            </h4>\n            <div class="field">\n                <label><%= i18n.startTime %></label>\n                <input type="number" min="0" max="23" class="itext input-small ignore" name="schedule.hour" value="<%= schedule.hour %>" /> <%= i18n.hour %>&nbsp;\n                <input type="number" min="0" max="59" class="itext input-small ignore" name="schedule.minute" value="<%= schedule.minute %>" /> <%= i18n.minute %>\n            </div>\n            <div class="field radio field-run-daily<% if(period !== null && period !== \'day\') { %> hidden<% } %>">\n                <label>\n                    <input type="radio" class="ignore" name="when" value="daily" <% if(period === \'day\' || ( \'undefined\' === typeof schedule.dayOfWeek && \'undefined\' === typeof schedule.dayOfMonth ) ) { %> checked="checked"<% } %> />\n                    <%= i18n.daily.ucFirst() %></label>\n            </div>\n            <div class="field radio field-run-weekdays<% if(period === \'month\') { %> hidden<% } %>">\n                <label>\n                    <input type="radio" class="ignore" name="when" value="dayOfWeek"<% if(period === \'week\' || \'undefined\' !== typeof schedule.dayOfWeek) { %> checked="checked"<% } %> /><%= i18n.selectedDaysOfWeek %>\n                    <input type="hidden" name="dayOfWeekSelected" value="1"><!-- for validation in reports scheduled task -->\n                </label>\n                <table class="checkbox-rows">\n                    <tr>\n                        <% for(var i = 1; i < 8; i++) { %>\n                        <td><label class="date-month"><input type="checkbox" class="ignore" name="schedule.dayOfWeek" value="<%= daysCodes[i%7] %>"\n                            <% if(\'undefined\' != typeof schedule.dayOfWeek && _.indexOf(schedule.dayOfWeek, daysCodes[i%7]) != -1) { %> checked="checked"<% } %>\n                            <% if(\'undefined\' == typeof schedule.dayOfWeek) { %> disabled="disabled"<% } %> />\n                            <%= i18n.DateTime.dayNamesMin[i%7] %></label></td>\n                        <% } %>\n                    </tr>\n                </table>\n            </div>\n            <div class="field radio field-run-monthdays">\n                <label>\n                    <input type="radio" class="ignore" name="when" value="dayOfMonth"<% if(period && period.indexOf(\'month\') != -1 || \'undefined\' != typeof schedule.dayOfMonth) { %> checked="checked"<% } %> /><%= i18n.selectedDaysOfMonth %>\n                    <input type="hidden" name="dayOfMonthSelected" value="1"><!-- for validation in reports scheduled task -->\n                </label>\n                <table class="checkbox-rows">\n                    <tr>\n                        <% for(var i = 1; i <= 31; i++) { %>\n                        <td><label class="date-month"><input type="checkbox" class="ignore" name="schedule.dayOfMonth" value="<%= i %>"\n                            <% if(\'undefined\' != typeof schedule.dayOfMonth && _.indexOf(schedule.dayOfMonth, String(i)) != -1) { %> checked="checked"<% } %>\n                            <% if(\'undefined\' == typeof schedule.dayOfMonth) { %> disabled<% } %> />\n                            <%= i %></label></td>\n                        <% if(i%7 == 0) { %>\n                    </tr><tr>\n                    <% } %>\n                    <% } %>\n                    </tr>\n                </table>\n            </div>\n        </div>\n\n    </fieldset>\n\n    <fieldset class="rep-params">\n        <h4><%= i18n.reportParameters %></h4>\n        <div class="rep-params-content">\n\n        </div><!--/.rep-params-content-->\n    </fieldset><!--/.rep-params-->\n</div>\n<div class="actions">\n    <a class="btn btn-default command-run<% if (!uuid) { %> hidden<% } %>" href="#"><%= i18n.runImmediately %></a>\n    <button type="submit" class="btn btn-primary btn-save"><%= i18n.save.ucFirst() %></button>\n</div>\n<div class="actions params-actions<% if (!uuid) { %> hidden<% } %>">\n    <div class="dropdown">\n        <a class="btn btn-link dropdown-toggle command-copy-params" data-toggle="dropdown" href="#"><%= i18n.copyReportParameters %></a>\n        <div class="dropdown-menu"></div>\n    </div>\n\n</div>'}),define("text!_common/reports/schedule/tmpl/copyParamsMenu.html",[],function(){return'<% if(tasks.length) {%>\n<div class="dropdown-menu-header">\n    <label class="checkbox checkbox-all">\n        <input type="checkbox" value="all"> <%= i18n.selectAll %>\n    </label>\n</div>\n<ul class="nav nav-list">\n    <% _.each(tasks, function(t) {%>\n    <li>\n        <label class="checkbox">\n            <input type="checkbox" value="<%= t.id || t.uuid %>"> <%- t.name %>\n        </label>\n    </li>\n    <% }) %>\n</ul>\n<div class="dropdown-menu-footer">\n    <a href="#" class="btn btn-primary btn-copy"<% if(!tasks.length) {%> disabled<% } %>><%= i18n.copy %></a>\n</div>\n<% } else {%>\n<%= i18n.noTasksToCopyReportParameters %>\n<% } %>'
}),define("_common/reports/schedule/views/ScheduleTaskView",["jquery","jqueryui","underscore","jface","validation","_common/reports/ReportsMixin","abstracts/View","text!../tmpl/task.html","text!_common/tmpl/objectsSearchTag.html","text!../tmpl/copyParamsMenu.html","jquerytiny"],function(e,t,i,n,s,a,r,o,d,l){function c(e){var t=e.split(":");return parseInt(36e5*t[0])+parseInt(6e4*t[1])}o=i.template(o),d=i.template(d),l=i.template(l),jQuery.validator.addMethod("taskname",function(e){return!/[\\\/\?%\*\:|\"<>\.]/gi.test(e)},""),jQuery.validator.addMethod("multiemails",function(t,i){for(var n=t.split(/[\,|\r|\r\n|;|:]\s*?/),s=[],a=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i,r="",o=0,d=n.length;d>o;++o)r=e.trim(n[o]),a.test(r)||s.push(r);return e(i).data("errorEmails",s),s.length?!1:!0},""),jQuery.validator.addMethod("requireScheduleDays",function(t,i,n){var s=e(i).closest("form").find('input[name="'+n.name+'"]').not(":disabled");return!s.length||s.filter(":checked").length>0},""),jQuery.validator.addMethod("time",function(e){var t=c(e);return!isNaN(t)},""),jQuery.validator.addMethod("start_time",function(e,t,i){var n=c(e),s=i.val(),a="00:00"==s?864e5:c(i.val());return isNaN(n)||isNaN(a)?!1:a>n},""),e.validator.addMethod("require_from_group",function(t,i,n){var s=e(n[1],i.form),a=s.eq(0),r=a.data("valid_req_grp")?a.data("valid_req_grp"):e.extend({},this),o=s.filter(function(){return r.elementValue(this)}).length>=n[0];return a.data("valid_req_grp",r),e(i).data("being_validated")||(s.data("being_validated",!0),s.each(function(){r.element(this)}),s.data("being_validated",!1)),o},e.validator.format("Please fill at least {0} of these fields."));var u=r.extend({constructor:function(){this.module=null,this.loading=!1,this._objectId=[],this._groupId=[],this.$_typeSelect=null,this.$_objectsQty=null,this.$_selectedObjects=null,this.$_periodLimit=null,r.apply(this,arguments)},id:"task-details",tagName:"form",className:"section active",attributes:{method:"post",action:""},initialize:function(e){if(this.module=e.module,this.model.get("editable"))this.render();else{var t=this.module.getTexts();this.$el.html('<p class="not-editable">'+t.tasksEditIsImpossible+" "+t.accountRightsAreLimited+"</p>").appendTo(this.module.get("container"))}},render:function(){var e=this,t=this.module.getTexts(),n=this.model,s=n.get("type"),a=this.module.reportsAllowed("mobile"),r=this.module.reportsAllowed("stat"),d=i.extend({},n.attributes,{i18n:t,daysCodes:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],settings:this.module.attributes,allowMobile:a,allowStat:r});d.reportsGroups=this.module.getGroupedReports(),"string"==typeof d.schedule.dayOfWeek&&(d.schedule.dayOfWeek=d.schedule.dayOfWeek.split(",")),"string"==typeof d.schedule.dayOfMonth&&(d.schedule.dayOfMonth=d.schedule.dayOfMonth.split(",")),this.$el.html(o(d)),this.$el.appendTo(this.module.get("container")),this.$_objectsQty=this.$el.find(".nb-objs-value"),this.$_selectedObjects=this.$el.find(".selected-objects"),this.$_periodLimit=this.$el.find(".report-period-limit"),this.$_typeSelect=this.$el.find("select[name=type]");var l=this.$_typeSelect;l.val(),n.get("objType")==App.TYPE_STAT&&(l.find("optgroup[data-mobile]").hide(),n.id||l.val("OBJST]")),n.id&&l.val("DRIVESAFETYSUM"==s?"DRIVESAFETY":s),p.bindEvents.call(this),p.initValidation.call(this),p.renderObjects.call(this),p.initSearch.call(this),p.initTimepickers.call(this),p.getReportExtraFields.call(e,s).done(function(t,i){var n=e.$el.find(".rep-params-content").html(t);i&&i(n)}).fail(function(){e.$el.find(".rep-params-content").html("")})},_initFuelNormSelect:function(e){var t=e.find("input[type=checkbox]").filter("[data-fuel-consumption]"),i=e.find("input[name=season]"),n=function(){var e=t.filter(":checked").length<=0;i.prop("disabled",e).parent().toggleClass("disabled",e)};t.on("click",n),n()},buildRunExtraFields:function(){var t=this,n=new e.Deferred,s=this.model.get("parameters"),a=this.module.getTexts(),r=!this.model.id;return requirejs(["text!mobile/reports/run/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e,o){var d,l,c,u,p=t.module.getUserData("params.run"),m=t.module.getReportPredefinedParams("run",{properties:["extId","name"],params:["moveStartEndTime","moveTime","parkTime","avgSpeed"],season:"auto",hideDetails:null===p?1:0});r?(d=m.properties,l=m.params,c=m.season,u=!m.hideDetails):(d=s.properties,l=s.params,c="season"in s?s.season:m.season,u=1!==s.hideDetails),i.intersection(["moveStart","moveEnd"],l).length&&l.push("moveStartEndTime"),i.intersection(["moveStartPlace","moveEndPlace"],l).length&&l.push("moveStartEndPlace"),n.resolve(i.template(e,{i18n:a,propertiesHtml:i.template(o,{properties:d,i18n:a}),params:l,season:c,showDetails:u}),function(e){t._initFuelNormSelect(e)})},function(){n.reject()}),n},buildAccesscardExtraFields:function(){var t=this,n=new e.Deferred,s=this.module.getTexts();return requirejs(["text!mobile/reports/accesscard/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e,a){var r=t.module.getUserData("accesscard.properties")||["extId","name"],o=t.module.getUserData("accesscard.showAddress");null===o&&(o=!1),n.resolve(i.template(e,{i18n:s,showAddress:o,propertiesHtml:i.template(a,{properties:r,i18n:s})}),function(){})},function(){n.reject()}),n},buildMoveparkExtraFields:function(){var t=new e.Deferred,n=this,s=this.module.getTexts(),a=!this.model.id,r=n.model.get("parameters");return requirejs(["text!mobile/reports/movepark/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e,o){var d,l,c,u,p=n.module.getReportPredefinedParams("movepark",{properties:["extId","name"],season:"auto",showMoves:1,showParks:1});a?(c=p.properties,u=p.season,d=p.showMoves,l=p.showParks):(c="undefined"==typeof r.properties?["extId","name"]:r.properties,d="undefined"==typeof r.showMoves||r.showMoves,l="undefined"==typeof r.showParks||r.showParks,u=r.season||p.season),t.resolve(i.template(e,{i18n:s,season:u,showMoves:d,showParks:l,propertiesHtml:i.template(o,{properties:c,i18n:s})}))},function(){t.reject()}),t},buildSpeeding1bExtraFields:function(){return this.buildSpeedingExtraFields.call(this,!0)},buildSpeedingExtraFields:function(t){t=t===!0;var n=new e.Deferred,s=this.module,r=s.getTexts(),o=this.model.get("parameters"),d=-1!=this.model.get("type").indexOf("SPEEDING"),l=!this.model.id,c=t?[s.get("spdLimit1")]:[s.get("spdLimit1"),s.get("spdLimit2")],u=t?"speeding1b":"speeding";return u.toUpperCase(),requirejs(["text!mobile/reports/speeding1b/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(p,m){var h=s.getUserData("params."+u),f=s.getReportPredefinedParams(u,{properties:["extId","name"],mintime:20,hideDetails:l&&null===h?1:0,b1:c[0],b2:t?!1:c[1]}),v=o.properties||f.properties,g=1!==o.hideDetails&&1!==f.hideDetails,b=!!t;n.resolve(i.template(p,{i18n:r,mintime:d&&o.mintime||f.mintime,showDetails:g,b1:d&&o.b1||f.b1,b2:t?!1:d&&o.b2||f.b2,showSelectorZone:b,propertiesHtml:i.template(m,{properties:v,i18n:r})}),function(i){var n=i.find("input[name=b1],input[name=b2]"),s=o.zoneId||[];b&&a.buildSelectorZone.call(this,{htmlBlock:i,i18n:r,selected:s}),i.find("input[name=mintime]").numeric({decimal:!1,negative:!1}),n.numeric({decimal:".",negative:!1}),t||n.on("change",function(){var t=e(this),n=Number(this.name.replace("b","")),s=parseFloat(t.val()),a=i.find("input[name=b"+(1==n?2:1)+"]");if(1==n)0>=s&&(s=1,t.val(s)),a.val()<=s&&a.val(s+1);else if(2==n){var r=Math.max(s-1,1);r>=s&&t.val(r+1),a.val()>=s&&a.val(r)}}).trigger("change")})},function(){n.reject()}),n},buildAccelerationExtraFields:function(){var t=new e.Deferred,n=this.module,s=n.getTexts(),r=this.model.get("parameters"),o=this.model.get("type"),d=!this.model.id,l=[n.get("accLimit1"),n.get("accLimit2")];return requirejs(["text!mobile/reports/acceleration/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e,c){var u=(n.getUserData("params.acceleration"),{properties:["extId","name"],mintime:3,hideDetails:d?1:0,hideCorners:d?1:0,hideAccel:0,hideBraking:0,b1:l[0],b2:l[1]}),p=r.properties||u.properties,m=1!==r.hideDetails&&1!==u.hideDetails,h=1!==r.hideCorners&&1!==u.hideCorners,f=1!==r.hideBraking&&1!==u.hideBraking,v=1!==r.hideAccel&&1!==u.hideAccel;t.resolve(i.template(e,{i18n:s,mintime:"ACCELERATION"===o&&r.mintime||u.mintime,showDetails:m,showAccel:v,showBraking:f,showCorners:h,b1:"ACCELERATION"==o&&r.b1||u.b1,b2:"ACCELERATION"==o&&r.b2||u.b2,propertiesHtml:i.template(c,{properties:p,i18n:s})}),function(e){var t=r.zoneId||[];a.buildSelectorZone.call(this,{htmlBlock:e,i18n:self._i18n,selected:t}),e.find("input[name=mintime]").numeric({decimal:!1,negative:!1}),e.find("input[name=b1]").numeric({decimal:".",negative:!1}),e.find("input[name=b2]").numeric({decimal:".",negative:!0})})},function(){t.reject()}),t},buildDrivesafetyExtraFields:function(){var t=this,i=this.totalObjects>1,n=new e.Deferred,s="drivesafety";return t._i18n=this.module.getTexts(),requirejs(["mobile/reports/"+s+"/DrivesafetyReport"],function(e){var r=i,o=e.prototype.defaults;t._renderDrivesafetyExtraFields(s,o,i).done(function(e){n.resolve(e,function(e){t._initDrivesafetyExtraFields(s,o,i,e),a._toggleDrifesafetyCheckboxes(e,i),t.on("totalobjects:change",function(){r=i,i=t.totalObjects>1,i!=r&&a._toggleDrifesafetyCheckboxes(e,i)})},function(){n.reject()})})}),n},buildObjstExtraFields:function(){var t=new e.Deferred,n=this,s=(this.model.get("parameters"),this.model.get("objType"));return requirejs(["text!"+(s==App.TYPE_MOBILE?"mobile":"stat")+"/reports/objst/tmpl/params.html"],function(a){var r,o=i.extend({noGpsMinutes:0,noGsmMinutes:0,alerts_days:1,alerts_hours:0,alerts_minutes:0,properties:["extId"],stateFields:[]},n.module.getUserData("params.objst_"+s)||{});r=s==App.TYPE_MOBILE?p.prepareMobileObjstFieldsData.call(n,o):p.prepareStatObjstFieldsData.call(n,o),t.resolve(i.template(a,r),function(t){t.on("click","input[readonly=readonly]",function(e){e.preventDefault()}),t.on("keypress","input[type=text]",function(t){var n=t.keyCode||t.charCode,s=e(t.target).val()+(32>n?"":String.fromCharCode(n));-1==i.indexOf([8,37,38,39,40,46],n)&&s.match(/\D/)&&t.preventDefault()}),t.find("fieldset").each(function(){e(this).selectAll({selector:"input[name="+e(this).data("key")+"]:not([readonly])"})})})},function(){t.reject()}),t},buildDeviceExtraFields:function(){function t(e){requirejs(["text!mobile/reports/device/tmpl/params.html"],function(t){s.resolve(i.template(t,e),function(e){e.find("input[name=dur]").numeric({decimal:!1,negative:!1}),e.selectAll({selector:"input[name^=dev]"})})},function(){s.reject()})}var n,s=new e.Deferred,a=this,r=a.model.get("parameters"),o=this.module.getReportPredefinedParams("device",{dev:127,dur:5}),d=r.dev||o.dev,l=i.map(Number(d).toString(2).split("").reverse(),function(e){return"1"===e}),c=r.objectId||[],u=r.groupId||[],p=this.module.getTexts(),m=0,h={i18n:p,dur:r.dur||o.dur,checked:l,powerName:p.power.ucFirst(),powerChecked:"undefined"==typeof l[6]?l[6]:!0,simul:r.simul||!1},f=0;if(l&&l.length)for(f=0,n=l.length;n>f;f++)l[f]&&m++;else for(l=[],f=0;6>f;f++)l[f]=!0,m++;if(h.nbChecked=m,c.length||u.length){var v=i.clone(c),g=a.$el.find(".rep-params").addClass("loading");i.each(u,function(e){v=v.concat(App.getAllDeviceIdsInGroup(e))}),a.$el.find(".rep-params").addClass("loading"),this.module.getDiscretsNames(i.uniq(v)).done(function(e){h.discrets=e,t(h)}).fail(function(e){s.reject(e)}).always(function(){g.removeClass("loading")})}else{for(var b=7,y=new Array(b);b--;)y[b]=p.discretSensor+" "+b;h.discrets=y,t(h)}return s},buildDevicerunExtraFields:function(){return this.buildDeviceExtraFields.apply(this,arguments)},buildCandevicerunExtraFields:function(){var t=new e.Deferred,n=this;return n.model.get("objType"),requirejs(["text!mobile/reports/can/tmpl/params.html","i18n!_common/reports/nls/canReport"],function(s,a){var r=n.module.getTexts(),o=n.model.get("parameters"),d=n.module.getReportPredefinedParams("candevicerun",{dev:0,dur:5}),l="dev"in o?o.dev:d.dev,c=i.map(Number(l).toString(2).split("").reverse(),function(e){return"1"===e}),u=[1,1,1],p=24,m={},h=0;if(!c||!c.length)for(c=[],h=0;p>h;h++)c[h]=0;h=0,i.each(a.names,function(e){m[++h]=e});var f=p/3;for(h=0;h<u.length;h++)for(var v=f*h;f*(h+1)>v;v++)if(!c[v]){u[h]=0;break}t.resolve(i.template(s,{names:m,checked:c,checkedGroups:u,dur:o.dur||d.dur,i18n:i.extend({},r,a)}),function(t){t.find("input[name=dur]").numeric({decimal:!1,negative:!1}),t.on("click",".select-all",function(){var t=e(this).closest("fieldset");t.find("input[name^=dev]").prop("checked",this.checked)}).on("click","input[name^=dev]",function(){for(var t=e(this).closest("fieldset"),i=t.find("input.select-all"),n=t.find("input[name^=dev]"),s=!0,a=n.length;a--;)if(!n[a].checked){s=!1;break}i.prop("checked",s)})})},function(){t.reject()}),t},buildAlertsumExtraFields:function(){var t=new e.Deferred,n=this,s=n.model.get("parameters"),a=!this.model.id,r=this.module.getTexts();return requirejs(["text!_common/reports/alertssummary/tmpl/params.html"],function(e){var o,d;if(a){var l=n.module.getReportPredefinedParams("alertsum",{hideDetails:0});o=!l.hideDetails,d="general"}else o=1!==s.hideDetails,d=s.reportSubtype;t.resolve(i.template(e,{i18n:r,showDetails:o,reportSubtype:d}))},function(){t.reject()}),t},_initParameterReportFields:function(e,t){var i=this,n=t.find("fieldset.obj-props");this.on("totalobjects:change",function(){n[i.totalObjects>1?"removeClass":"addClass"]("hidden")}),a._initParameterReportFields.apply(this,arguments)},getDrivesafetyStoredParam:function(e){var t,n=this.model.get("parameters"),s=this.module.getUserData("params.drivesafety")||{},r=function(){return e in s?s[e]:null};return"speedExcessLimits"===e?"speedLimits"in n&&"isPercents"in n?(t=i.extend({},a.getDrivesafetyMapMatchingDefaultParameters().speedExcessLimits),t[n.isPercents===!0?"percentage":"kmh"]=n.speedLimits):t=r():t="speedExcessWeights"===e?"speedWeights"in n?n.speedWeights:r():"speedExcessUnits"===e?"isPercents"in n?n.isPercents===!0?"percentage":"kmh":r():"useMileageOrQuantity"===e?"useCount"in n?n.useCount===!0?"quantity":"mileage":r():"showObjectsStatistics"===e?"showStatistics"in n?n.showStatistics===!0:r():e in n?n[e]:r(),t},getStoredParam:function(e,t){if("drivesafety"===e&&App.isMapMatchingAllowed())return this.getDrivesafetyStoredParam(t);var i=t.lastIndexOf("."),n=this.model.get("parameters"),s=this.module.getUserData("params."+e)||{};if(-1!=t.indexOf("thresholds")){var a=t.substr(0,i),r=n.dataSource;if(a!=r){var o=this.module.getUserData("params."+a.toLowerCase());return o?o.thresholds:null}}return i>-1&&(t=t.substr(i+1)),t in n?n[t]:t in s?s[t]:null},clearStoredParam:function(e,t){var i=this.model.get("parameters"),n=this.module.getUserData("params."+e)||{};t in i&&delete i[t],t in n&&delete n[t],this.module.setUserData("params."+e,n)},getTexts:function(){return this.module.getTexts()}}),p={bindEvents:function(){var t=this,s=this.module;this.$el.on("click",".tag i",function(){var i=e(this).parent(),n=parseInt(i.data("id")),s=-1!=i[0].className.indexOf("group");p.deleteObject.call(t,n,s),i.remove()}).on("click",".command-run",function(){s.runTask().done(function(){var e=s.getTexts();n.growl.open(e.taskRun,{position:"br"})}).fail(i.bind(t.showErrors,t))}).on("change","input[name=objType]",function(){this.checked&&p.onChangeObjectsType.call(t,parseInt(this.value))}).on("change","select[name=period]",function(){p.onChangePeriod.call(t,e(this).val())}).on("change","input[name=when]",function(){p.onChangeWhenToSend.call(t,e(this).val())}),this.$_typeSelect.on("change",function(){p.onChangeReportType.call(t,e(this).val().toLowerCase())}),this.model.id?p.bindTaskEvents.call(this):this.listenToOnce(this.model,"change:uuid",function(){t.$el.find(".command-run").removeClass("hidden");var e=t.model.get("type").toLowerCase().ucFirst();t["build"+e+"ExtraFields"]&&t.$el.find(".params-actions").removeClass("hidden"),t.$el.find(".header h3").text(t.model.get("name")),p.bindTaskEvents.call(this)});var a=this.$el.find(".params-actions"),r=a.find(".dropdown"),o=a.find(".dropdown-menu");a.on("click",".dropdown-menu",function(e){return e.stopPropagation(),!1}).on("click",".checkbox-all",function(e){e.stopPropagation(),a.find(".nav input").prop("checked",this.querySelector("input").checked)}).on("click",".nav .checkbox",function(e){e.stopPropagation(),p.onReportToCopyChecked.call(t,a)}).on("click",".btn-copy",function(e){e.stopPropagation();var n=[],s=a.find(".nav input:checked");return s.length&&(i.each(s,function(e){n.push(e.value)}),p.copyReportParams.call(t,n,r)),!1}),r.on("show.bs.dropdown",function(){var e=p.getTasksToCopyParams.call(t);o.toggleClass("no-data",!e.length),o.html(l({i18n:t.module.getTexts(),tasks:e}))})},getTasksToCopyParams:function(){var e=this.model,t=e.get("type"),i=e.get("objType"),n=this.module.items,s=[];return n.each(function(n){n.get("type")==t&&n.get("objType")==i&&n.id!=e.id&&s.push(n.attributes)}),s},onReportToCopyChecked:function(e){var t=e.find(".checkbox-all input"),i=e.find(".nav input"),n=!0;i.filter(":checked").length<i.length&&(n=!1),t.prop("checked",n)},copyReportParams:function(e,t){var n=this.model,s=(n.get("objType"),n.get("parameters")),a=this.module.items,r=i.indexBy(e),o=a.filter(function(e){return e.id in r?(e.set("parameters",p.mergeReportParams(e.get("parameters"),s)),!0):!1});o.length&&(this.$el.addClass("loading"),this.module.saveMultipleTasks(o).done(function(){t.find(".dropdown-toggle").click()}).fail(function(e){this.showErrors(e)}.bind(this)).always(function(){this.$el.removeClass("loading")}.bind(this)))},mergeReportParams:function(e,t){var n={},s=i.indexBy(["objectId","groupId","objType","locale"]),a=i.extend({},e,t);return i.each(a,function(i,a){a in s?n[a]=e[a]:a in t&&(n[a]=t[a])}),n},bindTaskEvents:function(){var e=this;this.listenTo(this.model,"remove",function(){e.remove()}).listenTo(this.model,"change:name",function(){e.$el.find(".header h3").text(e.model.get("name"))})},initValidation:function(){var t=this.module.getTexts(),i=this;this.$el.validate({submitHandler:function(){p.onSubmit.call(i)},debug:!1,ignore:".no-validation",rules:{name:{required:!0,taskname:!0},addresses:{required:!0,multiemails:!0},nbobjs:{min:1,max:function(){return"RUNMINI"==i.$_typeSelect.val()?250:1e5}},start:{time:!0,start_time:i.$_periodLimit.find("input[name=end]")},end:{time:!0},"schedule.hour":{min:0,max:23},"schedule.minute":{min:0,max:59},dayOfWeekSelected:{requireScheduleDays:{name:"schedule.dayOfWeek"}},dayOfMonthSelected:{requireScheduleDays:{name:"schedule.dayOfMonth"}},b1:{required:!0,min:function(){return.1}},b2:{required:!0},mintime:{required:!0},sensorSelected:{require_from_group:[1,".sensor-check"]}},errorElement:"p",messages:{name:{required:t.errEnterReportName,taskname:t.errReportNamePattern},addresses:{required:t.errEnterTaskEmails,multiemails:function(i,n){var s=e(n).data("errorEmails"),a=t.errEnterTaskEmailsPattern+' <span class="nobr">';return a+=s.join('</span>, <span class="nobr">')+"</span>"}},nbobjs:{min:t.errors.selectAtLeastOneObject,max:function(e){t.errMaxObjectsForExport.replace("#max#",e).replace("#t#",this.totalItems)}},start:{start_time:t.errors.startMoreTnanEndTime,time:t.errors.invalidTimeEntered},end:{time:t.errors.invalidTimeEntered},"schedule.hour":t.errEnterCorrectStartTime,"schedule.minute":t.errEnterCorrectStartTime,b1:{required:t.errLimitRequired,min:function(e){return t.errEnterLimitNotLessThan.replace("#name#",t.speedLimit+" 1").replace("#min#",e)}},b2:{required:t.errLimitRequired},mintime:{required:t.errMintimeRequired},sensorSelected:{require_from_group:t.errSelectAtLeastOneSensor},dayOfWeekSelected:{requireScheduleDays:t.errslectDaysOfWeek},dayOfMonthSelected:{requireScheduleDays:t.errslectDaysOfMonth}},errorPlacement:function(e,t){var n=t[0].name,s=t.parent();"nbobjs"==n?e.insertBefore(s):-1!=n.indexOf("schedule.")?e.prependTo(s):"sensorSelected"==n?e.insertBefore(i.$el.find(".rep-params fieldset").first()):"start"==n||"end"==n?e.appendTo(t.closest(".field")):s.append(e)}})},renderObjects:function(){var e=this.model.get("parameters"),t="objectId"in e?e.objectId.slice(0):[],n="groupId"in e?e.groupId.slice(0):[],s="";this.$_selectedObjects.html(""),i.each(n,function(e){var t;(t=App.getDevicesGroup(e))?s+=d({id:t.id,title:t.get("name"),isGroup:!0}):n=i.without(n,e)}),i.each(t,function(e){var n;(n=App.getDevice(e))?s+=d({id:n.id,extId:n.get("extId"),title:n.get("name")+" (#"+n.get("extId")+")",isGroup:!1}):t=i.without(t,e)}),this._groupId=n,this._objectId=t,this.$_selectedObjects.append(s),p.onChangeObjectsCount.call(this)},initSearch:function(){var t=this,i=this.$el.find("input[name=q]");i.catcomplete({delay:0,appendTo:this.$el,minLength:2,source:function(e,i){var n=App.TYPE_MOBILE;return n=App.hasModule("stat")&&App.hasModule("mobile")?parseInt(t.$el.find("input[name=objType]:checked").val()):App.hasModule("stat")?App.TYPE_STAT:App.TYPE_MOBILE,t.module.search(e.term,n).done(function(e){i(e)}).fail(function(){i([])})},select:function(i,n){return e(i.target).val(""),p.addObject.call(t,n.item.model),!1}})},initTimepickers:function(){var t=this.$_periodLimit.find(".bootstrap-timepicker input");if(e.fn.timepicker){t.timepicker({minuteStep:1,showMeridian:!1,showInputs:!1}).on("changeTime.timepicker",function(){e(this).valid(),"end"==this.name&&t.filter("[name=start]").valid()});var i="00:00",n="00:00";if("day"==this.model.get("period")){var s,a=this.model.get("start"),r=this.model.get("end");null!==a&&(s=Math.floor(a/36e5),i=s.padLeft(2)+":"+Math.floor((a-36e5*s)/6e4).padLeft(2)),null!==r&&(s=Math.floor(r/36e5),n=s.padLeft(2)+":"+Math.floor((r-36e5*s)/6e4).padLeft(2))}t.filter("[name=start]").timepicker("setTime",i),t.filter("[name=end]").timepicker("setTime",n)}},addObject:function(e){var t=parseInt(e.id),i=this.module.getTexts(),n=!1;return e.isGroup&&0===e.nbItems?(alert(i.emptyObjGroupAddWarning.replace("#name#",e.name),i.attention),!1):(e.isGroup?-1==this._groupId.indexOf(t)&&(this._groupId.push(t),this.$_selectedObjects.append(d({id:t,title:e.name,isGroup:!0})),n=!0):-1==this._objectId.indexOf(t)&&(this._objectId.push(e.id),this.$_selectedObjects.append(d({id:t,extId:e.extId,title:e.name+" (#"+e.extId+")",isGroup:!1})),n=!0),n&&p.onChangeObjectsCount.call(this),n)},deleteObject:function(e,t){t?this._groupId=i.without(this._groupId,e):this._objectId=i.without(this._objectId,e),p.onChangeObjectsCount.call(this)},onSubmit:function(){if(this.loading)return!1;var e=this,t=this.module,s=!1,r=setTimeout(function(){s=!0,e.$el.addClass("loading")},200),o=e.$el.find(".task-params").find("input,select,textarea").not(".ignore").serializeObject(),d=o.parameters={};if(i.each(["objectId","groupId"],function(e){"undefined"!=typeof o[e]?(d[e]=i.isArray(o[e])?o[e]:[o[e]],delete o[e]):d[e]=[]}),o.schedule=p.serializeSchedule.call(e),i.extend(d,p.serializeExtraParams.call(e)),d.objType=o.objType,"day"===o.period&&i.each(["start","end"],function(e){var t=o[e];o[e]="end"===e&&"00:00"===t?864e5:c(t)}),/^(RUN|MOVEPARK|SPEEDING|SPEEDING1B|DRIVESAFETY|ACCELERATION|TEMPERATURE)$/.test(o.type)){var l=d.properties,u="MOVEPARK"===o.type,m=u?["extId","name"]:["extId"];"fake"===l?l=m:u&&i.indexOf(l,"extId")<0&&i.indexOf(l,"name")<0&&(l=m.concat(l)),l=i.without(l,"fake"),d.properties=l}switch(o.type){case"TEMPERATURE":d.mintime=60*parseInt(d.minutes)+parseInt(d.seconds);break;case"DRIVESAFETY":var h=this.totalObjects>1,f=App.isMapMatchingAllowed(),v=f?a.getDrivesafetyMapMatchingDefaultParameters():a.getDrivesafetyDefaultParameters(),g=function(e,t){return""===e?t:(e=Number(e),i.isNaN(e)?t:e)};f?(i.each(["speedLimits","speedWeights"],function(e){var t=e.replace("speed","speedExcess"),n=v[t];"speedExcessLimits"===t&&(n=n[v.speedExcessUnits]),d[e]=i.map(d[t],function(e,t){return g(e,n[t])}),delete d[t]}),d.isPercents="percentage"===d.speedExcessUnits,d.useCount="quantity"===d.useMileageOrQuantity,delete d.speedExcessUnits,delete d.useMileageOrQuantity):i.each(["speedLimits","speedWeights","gradeThresholds"],function(e){var t=v[e];d[e]=i.map(d[e],function(e,i){return g(e,t[i])})}),i.each(["accelerationMintime","speedingMintime","accelerationLimit","accelerationWeight","brakingLimit","brakingWeight"],function(e){var t,n=v[e],s=d[e];t=""===s?n:Number(s),d[e]=i.isNaN(t)?n:t}),d.brakingLimit>0&&(d.brakingLimit=0-d.brakingLimit),h?f?(d.showTop="showTop"in d,d.showStatistics="showObjectsStatistics"in d):i.each(["showSummary","showTop","showListWithViolations","showListWithSumScore","showObjectsStatistics"],function(e){d[e]=e in d}):(i.each(["showStatistics","showCalculation"],function(e){d[e]=e in d}),d.showStatistics||f||(d.hideDetails=1));break;case"RUN":var b=d.params;b="fake"===b?[]:i.without(b,"fake");var y=i.indexOf(b,"moveStartEndTime"),x=i.indexOf(b,"moveStartEndPlace");-1!=y?-1!=x?(b.splice(x,1),b.splice(y,1,"moveStart","moveStartPlace","moveEnd","moveEndPlace")):b.splice(y,1,"moveStart","moveEnd"):-1!=x&&b.splice(x,1,"moveStartPlace","moveEndPlace"),d.params=b;break;case"MOVEPARK":i.each(["showMoves","showParks"],function(e){d[e]="undefined"==typeof d[e]?0:Number(d[e])});break;case"OBJST":var k={gps_days:0,gps_hours:0,gps_minutes:0,gsm_days:0,gsm_hours:0,gsm_minutes:0};d.properties="string"==typeof d.prop?[d.prop]:d.prop,d.stateFields="string"==typeof d.sf?[d.sf]:d.sf,delete d.prop,delete d.sf,i.each(k,function(e,t){k[t]=parseInt(!d[t]||(""+d[t]).match(/\D/)?0:d[t])}),d.noGpsMinutes&&(d.noGpsMinutes=60*24*k.gps_days+60*k.gps_hours+k.gps_minutes),d.noGsmMinutes&&(d.noGsmMinutes=60*24*k.gsm_days+60*k.gsm_hours+k.gsm_minutes);break;case"DEVICE":case"DEVICERUN":case"CANDEVICERUN":for(var T="CANDEVICERUN"==o.type?24:7,j=new Array(T),F="",_=0;T>_;_++)F="dev"+(_+1),"undefined"!=typeof o.parameters[F]?(j[_]=parseInt(o.parameters[F]),delete o.parameters[F]):j[_]=0;o.parameters.dev=parseInt(j.reverse().join(""),2);break;case"OBJSERVICE":d.roundToDays="roundToDays"in d&&1==d.roundToDays,d.detailed=1==d.objectId.length}return"DRIVESAFETY"==o.type&&this.totalObjects>1&&(o.type="DRIVESAFETYSUM"),t.saveTask(o).done(function(){var e=t.getTexts();n.growl.open(e.taskSaved,{position:"br"})}).always(function(){clearTimeout(r),s&&e.$el.removeClass("loading")&&(s=!1),e.loading=!1}).fail(i.bind(e.showErrors,e)),!1},serializeSchedule:function(){var t={};return this.$el.find("input[name^=schedule]").not(":disabled").each(function(){var i=this.name.substr(this.name.indexOf(".")+1);"dayOfWeek"==i||"dayOfMonth"==i?this.checked&&(t[i]=t[i]||"",t[i]+=(t[i]?",":"")+e(this).val()):t[i]=e(this).val()}),t},getSelectValues:function(e){var t=e.val()||[];return i.map(t,function(e){return Number(e)})},serializeExtraParams:function(){var t={},n=this.$el.find(".rep-params input[name]").not(":disabled"),s=this.$el.find(".rep-params select[name]").not(":disabled");return s.each(function(){var i=e(this),n=this.name,s=p.getSelectValues(i);n&&(t[n]=s)}),n.each(function(){var n=this.name,s=e(this).data("invertname")||n,a=e(this).data("invertempty");if("checkbox"==this.type){if(e(this).data("invert"))this.checked?a||(t[s]=0):t[s]=1;else if(this.checked){var r=this.value;(1==this.value||"true"==this.value)&&(r=1),"undefined"==typeof t[s]?t[s]=r:i.isArray(t[s])?t[s].push(r):(t[s]=[t[s]],t[s].push(r))}}else"radio"==this.type?this.checked&&(t[s]=this.value):s in t?(i.isArray(t[s])||(t[s]=[t[s]]),t[s].push(this.value)):t[s]=this.value;s!=n&&delete t[n]}),console.log("serializeExtraParams",t),t},onChangeObjectsType:function(e){var t=this.$_typeSelect,i=t.find("optgroup"),n=t.val();this.model.set("objType",e),e==App.TYPE_STAT?(i.filter("[data-mobile]").hide(),"OBJST"!=n&&"ALERTSUM"!=n&&t.find("[value=OBJST]").prop("selected",!0)):i.show(),t.trigger("change"),this._objectId=[],this._groupId=[],this.$_selectedObjects.empty(),p.onChangeObjectsCount.call(this)},onChangeReportType:function(e){var t=this.$el.find(".rep-params"),i=t.find(".rep-params-content"),n=this.$el.find(".params-group.report-period select"),s=this.$el.find(".report-period-limit input");this.off("totalobjects:change"),p.getReportExtraFields.call(this,e).done(function(e,t){i.html(e),t&&t(i)}).fail(function(){i.html("")}),"objst"==e?(n.prop("disabled",!0),s.prop("disabled",!0)):(n.prop("disabled",!1),s.prop("disabled",!1))},onChangePeriod:function(e){var t=this.$el.find(".field-run-daily"),i=this.$el.find(".field-run-weekdays"),n=i.find("input[type=checkbox]"),s=this.$el.find(".field-run-monthdays"),a=this.$el.find("input[name=when]").val();if("day"==e)t.removeClass("hidden"),i.removeClass("hidden"),this.$_periodLimit.removeClass("hidden").find("input").prop("disabled",!1),"dayOfWeek"==a&&n.removeAttr("disabled");else if(t.addClass("hidden"),i.addClass("hidden"),this.$_periodLimit.removeClass("hidden").addClass("hidden").find("input").prop("disabled",!0),"week"==e)i.removeClass("hidden"),t.find("input[type=radio]").prop("checked")&&(i.find("input[type=radio]").prop("checked",!0),n.removeAttr("disabled"));else{n.prop("disabled",!0);var r=s.find("input[type=checkbox]");s.find("input[type=radio]").prop("checked",!0),r.prop("disabled",!1)}},onChangeWhenToSend:function(e){var t=this.$el.find(".field-run-weekdays .checkbox-rows input[type=checkbox]"),i=this.$el.find(".field-run-monthdays .checkbox-rows input[type=checkbox]");switch(e){case"dayOfWeek":t.removeAttr("disabled"),i.attr("disabled","disabled");break;case"dayOfMonth":t.attr("disabled","disabled"),i.removeAttr("disabled");break;case"daily":t.attr("disabled","disabled"),i.attr("disabled","disabled")}},onChangeObjectsCount:function(){var e=this._objectId.slice(0),t=this.totalObjects,n=this.$_objectsQty.siblings("input");i.each(this._groupId,function(t){e=e.concat(App.getAllDeviceIdsInGroup(t))}),this.totalObjects=i.uniq(e).length,this.$_objectsQty.text(this.totalObjects),n.val(this.totalObjects),n.hasClass("error")&&this.totalObjects>0&&n.parent().siblings(".error").remove(),this.trigger("totalobjects:change",t,this.totalObjects),this.$el.find(".rep-device-params").length&&p.renderDiscretsNames.call(this)},getReportExtraFields:function(t){"DRIVESAFETYSUM"==t&&(t="DRIVESAFETY");var i=t.toLowerCase().ucFirst(),n=new e.Deferred;return this["build"+i+"ExtraFields"]?this["build"+i+"ExtraFields"]().done(function(e,t){n.resolve(e,t||function(){})}).fail(function(){n.reject("can not build params")}):(this.$el.find(".params-actions").addClass("hidden"),n.reject("no params")),n},prepareMobileObjstFieldsData:function(e){var t=this.model.get("parameters"),n=this.module.getTexts(),s=t.noGsmMinutes||e.noGsmMinutes,a=Math.floor(s/1440),r=Math.floor((s-1440*a)/60),o=s?s-1440*a-60*r:30,d=t.noGpsMinutes||e.noGpsMinutes,l=Math.floor(d/1440),c=Math.floor((d-1440*l)/60),u=d?d-1440*l-60*c:30,p={extId:n.objIdNumber,name:n.objName,status:n.objStatus,shortDescription:n.description,groups:n.objGroup,carId:n.licenseNumber,model:n.objModel,type:n.vehicleType,year:n.objYear,vin:n.objVin,color:n.color.ucFirst()},m={gsm:n.connection.ucFirst(),gsmTime:n.objectReport.connectionTime,gps:n.coords.ucFirst(),gpsTime:n.objectReport.coordinatesTime,power:n.power.ucFirst(),ign:n.ignition.ucFirst(),spd:n.speed.ucFirst(),rid:n.objTrackReading},h="undefined"==typeof t.properties?e.properties:"string"==typeof t.properties?[t.properties]:t.properties,f="undefined"==typeof t.stateFields?e.stateFields:"string"==typeof t.stateFields?[t.stateFields]:t.stateFields;
(App.allowed("objects.edit")||App.allowed("objects.create"))&&i.extend(p,{sim:n.simCard+" 1",sim1Provider:n.gsmProvider+" 1",sim2:n.simCard+" 2",sim2Provider:n.gsmProvider+" 2",pass:n.objServerPassword}),i.extend(p,{imei:"IMEI",rev:n.rev,comment:n.comments.ucFirst(),extraHardware:n.objExtraHardware}),App.userHasRole("supervisor")||(m.address=n.address.ucFirst()),i.each(h,function(e){e in p||(h=i.without(h,e))}),i.each(f,function(e){e in m||(f=i.without(f,e))});var v=i.keys(p).length,g=i.keys(m).length,b={i18n:n,checkedProps:h,allProps:p,totalProps:v,allSf:m,checkedSf:f,totalSf:g,noGsmMinutes:s,noGpsMinutes:d,gsm_days:a||"",gsm_hours:r||"",gsm_minutes:o,gps_days:l||"",gps_hours:c||"",gps_minutes:u};return b},prepareStatObjstFieldsData:function(e){var t=this.model.get("parameters"),n=!this.model.id,s=this.module.getTexts(),a={extId:s.objIdNumber,name:s.objName,status:s.objStatus,shortDescription:s.description,address:s.address.ucFirst(),groups:s.objGroup},r={gsmTime:s.timeOfLastAlert},o=n?e.alerts_days:parseInt(t.alerts_days),d=n?e.alerts_hours:parseInt(t.alerts_hours),l=n?e.alerts_minutes:parseInt(t.alerts_minutes),c="undefined"==typeof t.properties?e.properties:"string"==typeof t.properties?[t.properties]:t.properties,u="undefined"==typeof t.stateFields?e.stateFields:"string"==typeof t.stateFields?[t.stateFields]:t.stateFields;(App.allowed("objects.edit")||App.allowed("objects.create"))&&i.extend(a,{sim:s.simCard+" 1",sim1Provider:s.gsmProvider+" 1",sim2:s.simCard+" 2",sim2Provider:s.gsmProvider+" 2",pass:s.objServerPassword}),i.extend(a,{imei:"IMEI",rev:s.rev,comment:s.comments.ucFirst(),extraHardware:s.objExtraHardware,equipmentIds:s.objEquipmentIds}),i.each(c,function(e){e in a||(c=i.without(c,e))});var p=i.keys(a).length,m=i.keys(r).length,h={i18n:s,checkedProps:c,allProps:a,totalProps:p,allSf:r,checkedSf:u,totalSf:m,noAlertsMinutes:t.noAlertsMinutes||e.noAlertsMinutes,alerts_days:o,alerts_hours:d,alerts_minutes:l};return h},renderDiscretsNames:function(){var t=this,n=this._objectId.slice(0);i.each(this._groupId,function(e){n=n.concat(App.getAllDeviceIdsInGroup(e))}),t.$el.find(".rep-device-params").addClass("loading"),this.module.getDiscretsNames(i.uniq(n)).done(function(i){var n=t.$el.find(".rep-device-params");if(n.length){var s=null;n.find(".checkbox").each(function(){var t=e(this);s=t.find("input")[0];var n=parseInt(s.name.replace("dev",""));i[n]&&t.html(s).append(i[n])})}}).fail(function(){}).always(function(){t.$el.find(".rep-device-params").removeClass("loading")})}};return i.each([,"buildTemperatureExtraFields","buildVoltageExtraFields"],function(e){!function(e){u.prototype[e]=function(){return a[e].call(this,this.totalObjects)}}(e)}),i.each(["_buildParameterReportFields","_renderDrivesafetyExtraFields","_initDrivesafetyExtraFields","buildObjserviceExtraFields","_getObjectPropertiesForReport","_renderPropertiesCheckboxes"],function(e){!function(e){u.prototype[e]=function(){return a[e].apply(this,arguments)}}(e)}),u}),define("_common/reports/schedule/ScheduleModule",["jquery","underscore","jface","abstracts/Module","./ScheduleTasksCollection","./ScheduleTaskModel","./views/ScheduleListView","./views/ScheduleTaskView","_common/reports/ReportsMixin","i18n!mobile/nls/mobile"],function(e,t,i,n,s,a,r,o,d,l){var c=App.getBaseUrl()+"rsch/save/",u=App.getBaseUrl()+"rsch/delete/",p=App.getBaseUrl()+"rsch/run/",m=["run","runshort","accesscard","movepark","speeding1b","speeding","acceleration","objst","device","device2","can","alertssummary","temperature","drivesafety","objservice"],h=["run","runshort","accesscard","movepark","speeding1b","speeding","acceleration","drivesafety","device","device2","can","temperature"],f=n.extend({constructor:function(){this.items=new s,this._searchCache={},this._viewList=null,this._viewTask=null,n.apply(this,arguments)},defaults:{container:null,allowedReports:{},currentTask:null,creation:!1,spdLimit1:60,accLimit1:3,accLimit2:-3.5},initialize:function(){var t=this;this._i18n=e.extend({},this.get("parent").getTexts(),l),this._searchCache[App.TYPE_MOBILE]={},this._searchCache[App.TYPE_STAT]={};var i=this.get("parent").getSpeedLimits();this.set({spdLimit1:i[0],spdLimit2:i[1]});for(var n={},s=App.getAllowedReports(),a=!1,d=0,c=m.length;c>d;++d)m[d]in s&&(a=!0,n[m[d]]=s[m[d]]);"drivesafety"in n&&(n.drivesafetysum=n.drivesafety),this.set({creation:a,allowedReports:n}),this._viewList=new r({module:this,collection:this.items}),this.on("change:currentTask",function(e,i){t._viewTask&&(t._viewTask.remove(),t._viewTask=null),i&&(t._viewTask=new o({model:i,module:t}))}),this.items.fetch().done(function(){t.items.length||t.get("creation")||(t._viewList.remove(),t.get("container").html("<p>"+t._i18n.tasksCreationIsImpossible+" "+t._i18n.accountRightsAreLimited+"</p>"))})},reportsAllowed:function(e){return App.reportsAllowed(e,this.get("allowedReports"))},getGroupedReports:function(){var e,i=this.reportsAllowed("mobile"),n=this.get("allowedReports"),s=[],a={runshort:"RUNMINI",device2:"DEVICERUN",can:"CANDEVICERUN",alertssummary:"ALERTSUM"};return t.each(["objst","objservice","alertssummary"],function(i){i in n&&(e=t.extend({},n[i],{type:i in a?a[i]:i.toUpperCase()}),s.push(e))}),i&&t.each(h,function(i){i in n&&(e=t.extend({},n[i],{type:i in a?a[i]:i.toUpperCase()}),s.push(e))}),t.groupBy(s,"group")},editTask:function(e){var i;if(e){if(!(i=this.items.get(e)))return;if(this.has("currentTask")&&this.get("currentTask").id==i.id)return}else{var n=this.getGroupedReports(),s=t.values(n)[0][0];i=new a({parameters:{objectId:[],groupId:[]},objType:App.reportsAllowed("mobile")?App.TYPE_MOBILE:App.TYPE_STAT,type:s.type},{parse:!0})}this.set("currentTask",i)},translateDrivesafetyParamsForStorage:function(e){var i=App.isMapMatchingAllowed();if(i){var n=e.isPercents,s=e.useCount,a=d.getDrivesafetyMapMatchingDefaultParameters().speedExcessLimits,r=this.getUserData("params.drivesafety");e.speedExcessUnits=n?"percentage":"kmh",e.useMileageOrQuantity=s?"quantity":"mileage",e.speedExcessWeights=e.speedWeights,e.speedExcessLimits=t.extend({},a,r?r.speedExcessLimits:{}),e.speedExcessLimits[e.speedExcessUnits]=e.speedLimits,delete e.speedLimits,delete e.speedWeights,delete e.isPercent,delete e.useCount}return e},saveTask:function(e){var i=this,n=e.parameters,s=e.type.toLowerCase(),a=t.omit(n,"objectId","groupId","objType","locale");"objst"==s?s+="_"+n.objType:"drivesafety"===s&&(a=this.translateDrivesafetyParamsForStorage(a)),this.setUserData("params."+s,a);var r=!1,o=i.get("currentTask").id;o?e.uuid=o:(r=!0,e.uuid=null);var d=v.prepareTaskPostData.call(this,e);return"dataSource"in n&&"properties"in n&&this.setUserData("params."+d.type.toLowerCase(),a),v.save.call(i,d).done(function(t){var n=i.get("currentTask");n.set(e,{parse:!0}),r&&(n.set("uuid",t.uuid),i.items.add(n))})},saveMultipleTasks:function(t){var i=this,n=new e.Deferred,s=[],a=100,r=t.length,o=t.length,d=0;if(!r)return n.resolve();for(;o--;)s.push(v.prepareTaskPostData.call(this,t[o].attributes));var l=setInterval(function(){o++,s[o]?v.save.call(i,s[o]).done(function(){++d>=r&&(clearInterval(l),n.resolve())}).fail(function(){++d>=r&&(clearInterval(l),n.reject(i.getTexts().copyReportParametersError))}):clearInterval(l)},a);return n},removeTask:function(t){var n,s=this,a=new e.Deferred;return"undefined"==typeof t&&(t=s.get("currentTask").id||0),(n=this.items.get(t))?v.remove(t).done(function(){var e=s.getTexts();s.has("currentTask")&&s.get("currentTask").id==t&&s.set("currentTask",null),s.items.remove(t),i.growl.open(e.taskDeleted,{position:"br"}),a.resolve(t)}).fail(function(){a.reject(arguments[0])}):a.reject("Task does not exist"),a},runTask:function(t){var i,n=this,s=new e.Deferred;return"undefined"==typeof t&&(t=n.get("currentTask").id||0),(i=this.items.get(t))?v.run.call(this,t).done(function(){s.resolve(t)}).fail(function(){s.reject(arguments[0])}):s.reject("Task does not exist"),s},search:function(t,i){var n=this,s=new e.Deferred;return t=t.toLowerCase(),t in this._searchCache[i]?s.resolve(this._searchCache[i][t]):App.searchObjectsAndGroups(t,i).done(function(e){n._searchCache[i][t]=e,s.resolve(e)}).fail(function(){s.reject()}),s},getDiscretsNames:function(i){var n=new e.Deferred,s=this.getTexts(),a=[];return e.ajax({url:App.getBaseUrl()+"objects/obj-settings/",data:{objectId:i}}).done(function(e){for(var e=t.toArray(e),i=0,r="",o=1;6>=o;o++){for(r="",i=e.length;i--;){if(""!=r&&e[i]["D"+o+"Name"]!=r){r=s.discretSensor+" "+o;break}r=e[i]["D"+o+"Name"]?e[i]["D"+o+"Name"]:s.discretSensor+" "+o}a[o]=r}n.resolve(a)}).fail(function(){n.reject("Can not get objects settings")}),n},getReportPredefinedParams:function(e,i){var n=this.getUserData("params."+e)||{};return t.extend(i,n)},getTexts:function(){return this._i18n}}),v={prepareTaskPostData:function(e){var i=e.parameters,n=t.clone(e);return"dataSource"in i&&"properties"in i&&(n.type=i.dataSource),"schedule"in n&&t.each(n.schedule,function(e,i){"dayOfWeek"!=i&&"dayOfMonth"!=i||!t.isArray(e)||(n.schedule[i]=e.join(","))}),n.parameters=JSON.stringify(i),n.format="xls"==e.format?"EXCEL":"PDF",n.schedule=JSON.stringify(e.schedule),n},save:function(t){return e.ajax({url:c,data:t})},remove:function(t){var i=new e.Deferred;return e.ajax({url:u,data:{uuid:t},complete:function(e){e.status>=200&&e.status<300?i.resolve():i.reject(e)}}),i},run:function(t){var i=new e.Deferred;return e.ajax({url:p,data:{uuid:t},complete:function(e){e.status>=200&&e.status<300?i.resolve():i.reject(e)}}),i}};return f});