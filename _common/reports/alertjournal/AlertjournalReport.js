define(["jquery","underscore","jface","_common/reports/Report","./views/AlertjournalReportView","_libs/fileSaver/FileSaver"],function(e,t,r,s,o){var a=s.extend({url:App.getBaseUrl()+"fullalertjournal/start/",defaults:t.extend({},s.prototype.defaults,{uuid:"",percent:0,error:null,downloadStarted:!1}),constructor:function(){this._updateTimeout=null,this._update=this._update.bind(this),this._updateXhr=null,this.removed=!1,s.apply(this,arguments)},initialize:function(){["alertGroupId","channelName","alertMessageCode","logComment"].forEach(function(e){var r="all"+e.ucFirst();if(this.has(e)&&!this.has(r)){var s=this.get(e);t.isArray(s)||(s=[s],this.set(e,s)),this.setUserData(e,s)}else this.set(e,null),this.setUserData(e,null)}.bind(this));var r=this.get("customLogComment");("undefined"==typeof r||"string"==typeof r&&0===e.trim(r).length)&&(r=null),this.set("customLogComment",r),this.setUserData("customLogComment",r),this.has("allParams")?this.setUserData("params",null):this.setUserData("params",this.get("params")),s.prototype.initialize.call(this,o),this.on("sync",this._onSync).on("error",this._onError).on("remove",this._onRemoved)},getPostParams:function(){var e=s.prototype.getPostParams.call(this),t="mobile"===this.get("objType"),r=this.getTexts(),o=this.get("params"),a={receivedAt:r.timeOfReceive,alertTs:r.timeOfCreation,code:r.alertCode,message:r.alertOrCommentMessage,group:r.alertsGroup,extId:r.objIdNumber,address:r.address.ucFirst(),objectName:r.objTitle,areaNum:r.objArea,areaName:r.objAreaName,zoneNum:r.objZoneKey,zoneName:r.objZoneKeyName,channelName:r.inputStream,userId:r.userid,userName:r.username.ucFirst()};return["alertGroupId","channelName","alertMessageCode","logComment"].forEach(function(t){this.has(t)&&(e[t]=this.get(t))}.bind(this)),this.has("customLogComment")&&(e.customLogComment=this.get("customLogComment")),t&&(o=o.filter(function(e){return!/^address|areaNum|areaName|zoneNum|zoneName$/.test(e)})),e.alertParams=o,e.alertParamNames=o.map(function(e){return a[e]}),e.objType=t?App.TYPE_MOBILE:App.TYPE_STAT,e},readyForExport:function(){return!1},download:function(t){var s=this.getTexts(),o=this.get("name");return this.get("percent")<100?(t&&alert(s.errorReportBuildingStillInProgress,s.attention),(new e.Deferred).reject()):this.get("downloadStarted")?(t&&alert(s.errorReportAlreadyDownloaded,s.attention),(new e.Deferred).reject()):(this.set({downloadStarted:!0}),e.ajax({url:App.getBaseUrl()+"fullalertjournal/report/",data:{uuid:this.get("uuid")},dataType:"text"}).done(function(e){saveAs(new window.Blob([e],{type:"text/csv;charset="+document.characterSet}),o.replace(/\s+/g,"_")+".csv"),this.remove(),r.growl.open(o+" "+s.hasBeenDownloaded)}.bind(this)).fail(function(){this.set({error:s.errorReportDownload})}.bind(this)),void 0)},exportTo:function(){return this.download(!0)},remove:function(){this.collection.remove(this),this._module.getView().showList()},_onSync:function(){var e=this.get("uuid");e?this._setUpdateTimeout():this.set("error",this.getTexts().errorReportBuilding+" (no uuid)")},_onError:function(){this.set("error",this.getTexts().errorReportBuilding+" (start has failed)")},_onRemoved:function(){this._stopUpdate(),this.get("downloadStarted")||e.ajax({url:App.getBaseUrl()+"fullalertjournal/cancel/",data:{uuid:this.get("uuid")}})},_setUpdateTimeout:function(){this._updateTimeout=setTimeout(this._update,5e3)},_update:function(){if(!this.removed){var t=this.getTexts().errorReportBuilding;this._updateXhr=e.ajax({url:App.getBaseUrl()+"fullalertjournal/percent/",data:{uuid:this.get("uuid")}}).done(function(e){this.removed||("percent"in e?(this.set("percent",Math.min(100,e.percent)),this.get("percent")<100?this._setUpdateTimeout():this.download()):this.set("error",t+" (no progress data)"))}.bind(this)).fail(function(){this.removed||this.set("error",t+" (progress has failed)")}.bind(this))}},_stopUpdate:function(){this.removed=!0,this._updateXhr&&(this._updateXhr.abort(),this._updateXhr=null),(this._updateTimeout=null)&&(clearTimeout(this._updateTimeout),this._updateTimeout=null)}});return a});