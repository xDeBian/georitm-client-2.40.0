define(["jquery","underscore","../../views/ReportView","text!../../tmpl/reportTable.html","text!../tmpl/thead.html","text!../../tmpl/day.html","text!../tmpl/row.html","text!../tmpl/rowObject.html","text!../../tmpl/noDataRow.html"],function(e,t,a,r,o,n,s,l,i){var d="ObjectAlertLog";r=t.template(r),o=t.template(o),n=t.template(n),s=t.template(s),l=t.template(l),i=t.template(i);var m=a.extend({constructor:function(){a.apply(this,arguments)},render:function(){var t=new e.Deferred;a.prototype.render.apply(this,arguments),this.$el.addClass("objjournal-report"),this.buildMetaInfo(),this.content.append(r({key:this.model.get("key"),theadHtml:'<colgroup><col style="width:20%"><col style="width:80%"></colgroup>'}));var o=this.content.find("tbody");return o.append(this._buildRows()),t.resolve(),t},_buildRows:function(){for(var e,a,r,d,m,u=this,h=this.model,p=h.getTexts(),c="",g=h.get("body"),f=h.get("footer"),y=h.get("header"),b=y.keyOrder,v=[],x=0,w=0,A={},N=0,Z=0,k=null,D=2,j=0,T=b.length;T>j;++j)e=b[j],a=g[e],r="data"in a&&t.keys(a.data).length,d=r?a.data:null,k=f[e],c+=l({i18n:p,colspan:D,name:a.name,extId:a.extId,total:a.totalRecords,totalAlarms:a.alarms,totalAlerts:a.alerts,totalLogs:a.logs,totalUsers:a.totalUsers,users:a.users||{},hasData:r,isSingle:1==b.length}),r&&(c+=o({i18n:p,headPosition:++N}),v=t.keys(d),t.each(d,function(t,a){if(w=Number(a),c+=n({rowPosition:0==x++?"first":"",colspan:D,dateStr:u.formatDate(w)+" ("+u.getDayOfWeek(w)+")",isWeekend:u.isWeekend(w)}),t.length){Z=t.length;for(var r=0;Z>r;++r)A=t[r],m=A.bgColor?"background-color:"+A.bgColor+";":"",m+=A.fgColor?"color:"+A.fgColor+";":"",c+=s({ts:0,time:u.formatDateTime(A.receivedAt/App.MS),text:u._buildHistoryRowText(A,f[e]||{}),bgAndColor:m,isLast:v.length==x&&r==Z-1})}else c+=i({rowPosition:v.length==x?"last":0,text:p.noDataForDay,colspan:D})}));return c},_groupDataByDays:function(e){var a,r,o,n,s={},l=this.model.get("header"),i=this.getDaysPeriods(l.sd,l.ed),d=0,m=e.length;return i=t.values(i).reverse(),t.each(i,function(t){if(a=t*App.MS,r=[],d>=m||e[d].receivedAt<a);else for(o=e[d],n=o.receivedAt;n>=a&&m>d&&(r.push(o),m-1>d);)o=e[++d],n=o.receivedAt;s[t]=r}),s},_buildHistoryRowText:function(e,a){var r="type"in e&&e.type==d,o=[],n=this.model.getTexts(),s="";if(r)s=0===e.comment.indexOf(n.rrTeamShort)?"":e.userName+": ",o.push(e.comment);else if(o.push(e.messageText+" ("+e.code+")"),"area"in e&&e.area>0){var l=e.area,i=" (#"+l+")",m="",u=l in a&&"areaZonesNames"in a[l]?a[l].areaZonesNames:{},h="";m=e.areaName?e.areaName+i:l in a&&a[l].areaName?a[l].areaName+i:n.objArea+" "+l;var p=e.areaZone;h=e.areaZoneName?e.areaZoneName+" (#"+p+")":e.isKey?n.key.ucFirst()+" "+p:p in u&&u[p]?u[p]+" (#"+p+")":n.objZone+" "+p,m=t.escape(m),h=t.escape(h),o.push(m,h)}return s+o.join(", ")},_getAreaZoneName:function(e){var t=this.model.getTexts(),a=e.areaZoneName;return a||("areaZone"in e&&null!==e.areaZone?(a=e.isKey?t.key.ucFirst():t.objZone,a+=" "+e.areaZone):a="-"),a}});return m});