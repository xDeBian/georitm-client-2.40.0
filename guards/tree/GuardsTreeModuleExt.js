define(["jquery","underscore","./GuardsTreeModule","./views/GuardsTreeViewExt","_common/guards/GuardExt","_common/guards/GuardsExtCollection","_common/guards/GuardGroupsCollection"],function(t,e,s,r,a,n,i){function o(t){t.guards&&t.guards.length&&t.guards.sort(function(t,e){return t.name.localeCompare(e.name)})}s.prototype;var u=s.extend({_hasTopGroup:!1,groups:new i,items:new n,constructor:function(){this._openedGroups=[],s.apply(this,arguments)},initialize:function(){this.items.dataSource=this.getDataSource(),this._view=new r({el:this.get("container"),model:this}),this._bindEvents(),this.loadTree()},getDataSource:function(){return this.get("options").dataSource},loadTree:function(){var e=this.getDataSource(),s=new t.Deferred,r=this._openedGroups;return this.set({hasItems:null,loading:!0}),this._clearTree(),e.fetchLatest().done(function(t){var e=[];t.forEach(function(t){t.guards.length<=15&&r.push(t.id),t.guards.forEach(function(t){e.push(t.id)})}),this.get("parent").setUserData("watched.items",e),this._onDataLoaded(t),s.resolve()}.bind(this)).fail(function(){this.set({loading:!1,hasItems:!1}),this._view.showErrors.apply(this._view,arguments),s.reject()}.bind(this)),s},parse:function(t){var e=this,s=this.treeData,r=this._sortCondition();this._each(t,function(t){"guards"in t&&r&&o(t),s.push(e.prepareTreeObject.apply(e,arguments))})},extractGroups:function(){return[]},extractItems:function(t){return t.guards},_updateItems:function(t){this._clearExpireTimeout(),this._clearTree(),this._onDataLoaded(t),this.set({lastUpdateTs:+new Date,expired:!1})},_loadItemsData:function(){var t=this.getDataSource();return t.fetchLatest()},_onDataLoaded:function(t){var e=t.length>0;e&&(this.parse(t),this._initTree()),this.set({loading:!1,hasItems:e},{success:!0,hasItems:e})},_each:function(t,e,s,r){s="undefined"!=typeof s?s:0,r=0===s?null:r;for(var a=0,n=t.length;n>a;++a){var i=t[a],o="guards"in i;o&&(i.nbItems=i.guards.length),e(i,o,s,r),o&&this._each(i.guards,e,s+1,i)}},_clearTree:function(){this.treeData=[],this.groups=new i,this.items=new n},_copyParams:function(t,e){e.name=t.name,e.hwStatus=a.detectHardwareStatus(t)},_sortCondition:function(){return!0},_onStartSearch:function(){var t=this.get("q");if("string"==typeof t&&t.length>=2){t=t.toLowerCase();var s=[],r=this.get("propertyId"),a=this.dataView.getItems();e.each(a,function(e){if(!e.isgroup&&e.name.toLowerCase().indexOf(t)>-1||String(e.extId)===t){s.push(e[r]);for(var a=e.parent;a;)s.push(a[r].toString()),a.closed&&(a.closed=!1,this.trigger("group.expand",a)),a=a.parent}}.bind(this)),this.searchResult=e.uniq(s),this.dataView.refresh()}else this.searchResult=[],this.dataView.refresh()}});return u});