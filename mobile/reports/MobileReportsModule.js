var PRODUCTION=!0;define("mobile/reports/MobileReportsModule",["jquery","underscore","jface","abstracts/Module","_common/reports/ReportsMixin","i18n!mobile/nls/mobile","jquerytiny"],function(e,t,n,a,s,r){var i=a.extend({constructor:function(){a.apply(this,arguments)},initialize:function(){this._i18n=e.extend({},this.get("parent").getTexts(),r),this.publish("ready",this)},loadReportClass:function(t){var n=t.ucFirst()+"Report",a=t.toLowerCase(),s=new e.Deferred;return requirejs(["mobile/reports/"+a+"/"+n],function(e){s.resolve(e)},function(e){console.error(e),s.reject(e)}),s},getTexts:function(){return this._i18n},getSpeedLimits:function(){return this.get("parent").getSpeedLimits()},getAccLimits:function(){return this.get("parent").getAccLimits()},_initFuelNormSelect:function(e){var t=e.find("input[type=checkbox]").filter("[data-fuel-consumption]"),n=e.find("input[name=season]"),a=function(){var e=t.filter(":checked").length<=0;n.prop("disabled",e).parent().toggleClass("disabled",e)};t.on("click",a),a()},buildRunExtraFields:function(){var a=new e.Deferred,s=this;return requirejs(["text!mobile/reports/run/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(r,i){var o=s.get("parent"),d=o.getUserData("run.properties")||["extId","name"],l=o.getUserData("run.params")||["moveStartEndTime","moveTime","parkTime","avgSpeed"],m=o.getUserData("run.season")||"auto";a.resolve(t.template(r,{i18n:s._i18n,propertiesHtml:t.template(i,{properties:d,i18n:s._i18n}),params:l,season:m,showDetails:o.getUserData("run.showDetails")}),function(t){s._initFuelNormSelect(t),t.closest("form").on("click",".btn[data-target=reports]",function(a){if(!t.data("confirmed")&&t.find("input[value=moveStartEndPlace]").filter(":checked").length){var r=e(this);return n.confirm(s._i18n.runExtraParamsWarning,s._i18n.attention,{okCallback:function(){t.data("confirmed",!0),r.click()},btnNames:{ok:s._i18n.continue}}),a.stopPropagation(),!1}})})},function(){a.reject()}),a},buildMoveparkExtraFields:function(){var n=new e.Deferred,a=this;return requirejs(["text!mobile/reports/movepark/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e,s){var r=a.get("parent"),i=r.getUserData("movepark.showMoves"),o=r.getUserData("movepark.showParks"),d=r.getUserData("movepark.season")||"auto",l=r.getUserData("movepark.properties")||["extId","name"];t.isNumber(i)||(i=1),t.isNumber(o)||(o=1),n.resolve(t.template(e,{i18n:a._i18n,showMoves:i,showParks:o,season:d,propertiesHtml:t.template(s,{properties:l,i18n:a._i18n})}))},function(){n.reject()}),n},buildSpeeding1bExtraFields:function(){return this.buildSpeedingExtraFields.call(this,!0)},buildSpeedingExtraFields:function(n){n=n===!0;var a=new e.Deferred,r=this,i=n?"speeding1b":"speeding";return requirejs(["text!mobile/reports/speeding1b/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(o,d){var l=r.getSpeedLimits(),m=r.get("parent"),c=m.getUserData(i+".properties")||["extId","name"],u=!!n;a.resolve(t.template(o,{i18n:r._i18n,mintime:m.getUserData(i+".mintime")||20,showDetails:m.getUserData(i+".showDetails"),b1:m.getUserData(i+".b1")?m.getUserData(i+".b1"):l[0],b2:n?!1:m.getUserData(i+".b2")?m.getUserData(i+".b2"):l[1],showSelectorZone:u,propertiesHtml:t.template(d,{properties:c,i18n:r._i18n})}),function(t){var a=t.find("input[name=b1],input[name=b2]");if(u){var o=m.getUserData(i+".zoneId");s.buildSelectorZone.call(this,{htmlBlock:t,i18n:r._i18n,selected:o})}t.find("input[name=mintime]").numeric({decimal:!1,negative:!1}),a.numeric({decimal:".",negative:!1}),n||a.on("change",function(){var n=e(this),a=Number(this.name.replace("b","")),s=parseFloat(n.val()),r=t.find("input[name=b"+(1==a?2:1)+"]");if(1==a)0>=s&&(s=1,n.val(s)),r.val()<=s&&r.val(s+1);else if(2==a){var i=Math.max(s-1,1);i>=s&&n.val(i+1),r.val()>=s&&r.val(i)}})})},function(){a.reject()}),a},buildFlowExtraFields:function(){var n=new e.Deferred,a=this;return requirejs(["text!mobile/reports/flow/tmpl/params.html"],function(e){var s=a.get("parent"),r=s.getUserData("flow.dataSource")||"fuelrate",i="flow"==r&&s.getUserData("flow.buildCharts")||!1,o=s.getUserData("flow.season")||"auto";n.resolve(t.template(e,{i18n:a._i18n,useCalcValues:s.getUserData("flow.useCalcValues")||!1,dataSource:r,chartsDisabled:"flow"!=r,buildCharts:i,season:o}),function(e){e.find("input[name=dataSource]").click(function(){var t=e.find("input[name=buildCharts]");this.checked&&"flow"==this.value?t.prop("disabled",!1).prop("checked",i):t.prop("disabled",!0).prop("checked",!1)})})},function(){n.reject()}),n},buildFuelsumExtraFields:function(){var n=new e.Deferred,a=this,s="fuelsum";return requirejs(["text!mobile/reports/"+s+"/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e,r){var i=a.get("parent"),o=i.getUserData(s+".params")||["startF","endF","fillVolume","plumVolume","realConsumption","consumption100km","dist","ignOnTime","firstIgnTime","lastIgnTime"],d=i.getUserData(s+".properties")||["extId","name"];n.resolve(t.template(e,{i18n:a._i18n,anIndex:i.getUserData(s+".anIndex")||1,movingIndex:i.getUserData(s+".movingIndex")||!1,ignition:i.getUserData(s+".ignition")||!1,params:o,propertiesHtml:t.template(r,{properties:d,i18n:a._i18n})}),function(){})},function(){n.reject()}),requirejs(["text!mobile/reports/speeding1b/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e){var r=a.getSpeedLimits(),i=a.get("parent");i.getUserData(s+".properties")||["extId","name"],n.resolve(t.template(e,{i18n:a._i18n,mintime:i.getUserData(s+".mintime")||20,showDetails:i.getUserData(s+".showDetails"),b1:i.getUserData(s+".b1")?i.getUserData(s+".b1"):r[0],b2:singleThreshold?!1:i.getUserData(s+".b2")?i.getUserData(s+".b2"):r[1]}),function(){})},function(){n.reject()}),n},_buildFuelExtraFields:function(n){var a=new e.Deferred,s=this;return requirejs(["text!mobile/reports/fuel/tmpl/params.html"],function(e){var r=s.get("parent");a.resolve(t.template(e,{i18n:s._i18n,anIndex:r.getUserData(n+".anIndex")||1,movingIndex:r.getUserData(n+".movingIndex")||!1,ignition:r.getUserData(n+".ignition")||!1,buildCharts:r.getUserData(n+".buildCharts")||!1,checkDiscret1:r.getUserData(n+".checkDiscret1")||!1}),function(e){e.on("click","input[name=buildCharts]",function(){var t=e.find("input[name=checkDiscret1]");t.prop("disabled",!this.checked)})})},function(){a.reject()}),a},buildFuelExtraFields:function(){return this._buildFuelExtraFields("fuel")},buildFuel2ExtraFields:function(){return this._buildFuelExtraFields("fuel2")},buildAccesscardExtraFields:function(){var n=new e.Deferred,a=this;return requirejs(["text!mobile/reports/accesscard/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e,s){var r=a.get("parent"),i=r.getUserData("accesscard.properties")||["extId","name"],o=r.getUserData("accesscard.showAddress");null===o&&(o=!1),n.resolve(t.template(e,{i18n:a._i18n,showAddress:o,propertiesHtml:t.template(s,{properties:i,i18n:a._i18n})}),function(){})},function(e){console.log("reject e",e),n.reject()}),n},_buildDeviceExtraFields:function(n,a){var s=new e.Deferred,r=this;return this.get("parent").getObjectsSettings(t.pluck(n,"id")).done(function(e){for(var e=t.toArray(e),n=0,i=[],o="",d=1;6>=d;d++){for(o="",n=e.length;n--;){if(""!=o&&e[n]["D"+d+"Name"]!=o){o=r._i18n.discretSensor+" "+d;break}o=e[n]["D"+d+"Name"]?e[n]["D"+d+"Name"]:r._i18n.discretSensor+" "+d}i[d]=o}for(n=e.length,o="";n--;){if(""!=o&&e[n].POWER_NAME!=o){o=r._i18n.power.ucFirst();break}o=e[n].POWER_NAME?e[n].POWER_NAME:r._i18n.power.ucFirst()}requirejs(["text!mobile/reports/device/tmpl/params.html"],function(e){var n=r.get("parent"),d=n.getUserData(a+".checked"),l=0;if(d&&d.length)for(var m=0,c=d.length;c>m;m++)d[m]&&l++;else{d=[];for(var m=0;6>m;m++)d[m]=!0,l++}var u=n.getUserData(a+".powerChecked");null===u&&(u=!0),s.resolve(t.template(e,{i18n:r._i18n,dur:n.getUserData(a+".dur")||5,discrets:i,checked:d,nbChecked:l,powerName:o,powerChecked:u,simul:n.getUserData(a+".simul")||!1}),function(e){e.find("input[name=dur]").numeric({decimal:!1,negative:!1}),e.selectAll({selector:"input[name^=dev]"})})},function(){s.reject()})}).fail(function(){s.reject("Can not get objects settings")}),s},buildDeviceExtraFields:function(e){return this._buildDeviceExtraFields(e,"device")},buildDevice2ExtraFields:function(e){return this._buildDeviceExtraFields(e,"device2")},buildCanExtraFields:function(){var n=new e.Deferred,a=this;return requirejs(["text!mobile/reports/can/tmpl/params.html","i18n!_common/reports/nls/canReport"],function(s,r){var i=a._i18n,o=a.get("parent"),d=o.getUserData("can.checked"),l=[1,1,1],m=24,c={},u=0;if(!d||!d.length)for(d=[],u=0;m>u;u++)d[u]=0;u=0,t.each(r.names,function(e){c[++u]=e});var h=m/3;for(u=0;u<l.length;u++)for(var p=h*u;h*(u+1)>p;p++)if(!d[p]){l[u]=0;break}n.resolve(t.template(s,{names:c,checked:d,checkedGroups:l,dur:o.getUserData("can.dur")||5,i18n:t.extend({},i,r)}),function(t){t.find("input[name=dur]").numeric({decimal:!1,negative:!1}),t.find("fieldset").each(function(){e(this).selectAll({selector:"input[name^=dev]"})})})},function(){n.reject()}),n},buildPassExtraFields:function(){var n=new e.Deferred,a=this;return requirejs(["text!mobile/reports/pass/tmpl/params.html"],function(e){var s=a.get("parent");n.resolve(t.template(e,{i18n:a._i18n,split:s.getUserData("pass.split")||"none"}))},function(){n.reject()}),n},buildObjstExtraFields:function(){var n=new e.Deferred,a=this,s=a._i18n,r={extId:s.objIdNumber,name:s.objName,status:s.objStatus,shortDescription:s.description,groups:s.objGroup,carId:s.licenseNumber,model:s.objModel,type:s.vehicleType,year:s.objYear,vin:s.objVin,color:s.color.ucFirst()},i={gsm:s.connection.ucFirst(),gsmTime:s.objectReport.connectionTime,gps:s.coords.ucFirst(),gpsTime:s.objectReport.coordinatesTime,power:s.power.ucFirst(),ign:s.ignition.ucFirst(),spd:s.speed.ucFirst(),rid:s.objTrackReading};(App.allowed("objects.edit")||App.allowed("objects.create"))&&t.extend(r,{sim:s.simCard+" 1",sim1Provider:s.gsmProvider+" 1",sim2:s.simCard+" 2",sim2Provider:s.gsmProvider+" 2",pass:s.objServerPassword}),t.extend(r,{imei:"IMEI",rev:s.rev,comment:s.comments.ucFirst(),extraHardware:s.objExtraHardware}),App.userHasRole("supervisor")||(i.address=s.address.ucFirst());var o=t.keys(r).length,d=t.keys(i).length;return requirejs(["text!mobile/reports/objst/tmpl/params.html"],function(s){var l=a.get("parent"),m=l.getUserData("objst.prop")||[],c=l.getUserData("objst.sf")||[];t.each(m,function(e){e in r||(m=t.without(m,e))}),t.each(c,function(e){e in i||(c=t.without(c,e))}),m.length||m.push("extId"),n.resolve(t.template(s,{i18n:a._i18n,checkedProps:m,allProps:r,totalProps:o,allSf:i,checkedSf:c,totalSf:d,noGsmMinutes:l.getUserData("objst.noGsmMinutes"),gsm_days:l.getUserData("objst.gsm_days")?l.getUserData("objst.gsm_days"):"",gsm_hours:l.getUserData("objst.gsm_hours")?l.getUserData("objst.gsm_hours"):"",gsm_minutes:l.getUserData("objst.gsm_minutes")?l.getUserData("objst.gsm_minutes"):"30",noGpsMinutes:l.getUserData("objst.noGpsMinutes"),gps_days:l.getUserData("objst.gps_days")?l.getUserData("objst.gps_days"):"",gps_hours:l.getUserData("objst.gps_hours")?l.getUserData("objst.gps_hours"):"",gps_minutes:l.getUserData("objst.gps_minutes")?l.getUserData("objst.gps_minutes"):"30"}),function(n){n.find("input[type=text]").on("keypress",function(n){var a=n.keyCode||n.charCode,s=e(n.target).val()+(32>a?"":String.fromCharCode(a));-1==t.indexOf([8,37,38,39,40,46],a)&&s.match(/\D/)&&n.preventDefault()}),n.find("fieldset").each(function(){e(this).selectAll({selector:"input[name="+e(this).data("key")+"]:not([readonly])"})})})},function(){n.reject()}),n},buildAccelerationExtraFields:function(){var n=new e.Deferred,a=this;return requirejs(["text!mobile/reports/acceleration/tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(e,r){var i=a.get("parent"),o=a.getAccLimits(),d=i.getUserData("acceleration.properties")||["extId","name"],l=i.getUserData("acceleration.showBraking"),m=i.getUserData("acceleration.showAccel"),c=i.getUserData("acceleration.zoneId");n.resolve(t.template(e,{i18n:a._i18n,mintime:i.getUserData("acceleration.mintime")||3,showDetails:i.getUserData("acceleration.showDetails"),showCorners:i.getUserData("acceleration.showCorners"),showBraking:null===l?!0:l,showAccel:null===m?!0:m,b1:i.getUserData("acceleration.b1")?i.getUserData("acceleration.b1"):o[0],b2:i.getUserData("acceleration.b2")?i.getUserData("acceleration.b2"):o[1],propertiesHtml:t.template(r,{properties:d,i18n:a._i18n})}),function(e){s.buildSelectorZone.call(this,{htmlBlock:e,i18n:a._i18n,selected:c}),e.find("input[name=mintime]").numeric({decimal:!1,negative:!1}),e.find("input[name=b1]").numeric({decimal:".",negative:!1}),e.find("input[name=b2]").numeric({decimal:".",negative:!0})})},function(){n.reject()}),n},buildDiscretesExtraFields:function(t){var n=new e.Deferred,a=this;return requirejs(["mobile/reports/discretes/views/DiscretesReportParamsView"],function(e){var r=new e({controller:a});n.resolve(r.render(),function(e){r.setContainer(e),s._initObjectsPropertiesToggle(e,t.length>1)})},function(){n.reject()}),n},buildDistanceExtraFields:function(){var t=new e.Deferred,n=this;return requirejs(["mobile/reports/distance/views/DistanceReportParamsView"],function(e){var a=n.get("parent"),s=a.getUserData("distance.properties")||["extId","name"],r=new e({controller:n});t.resolve(r.render(s),function(e){r.setContainer(e)})},function(){t.reject()}),t},_initParameterReportFields:function(e,t,n){s._initObjectsPropertiesToggle(t,n.showProperties),s._initParameterReportFields.apply(this,arguments)},buildTimeseriesExtraFields:function(){var n=new e.Deferred,a=this;return requirejs(["mobile/reports/timeseries/TimeseriesReport","text!mobile/reports/timeseries/tmpl/params.html"],function(s,r){var i,o,d=a.get("parent"),l=s.getParameterGroups(a._i18n),m=s.getAvailableParameters(a._i18n),c=t.groupBy(m,"group"),u=[],h=[],p=d.getUserData("timeseries.checked")||[];for(var f in c)i=c[f],o=t.filter(i,function(e){return p.indexOf(e.key)>-1}).length,o===i.length?u.push(f):o>0&&h.push(f);n.resolve(t.template(r,{groups:l,checkedGroups:u,openedGroups:u.concat(h),params:c,checkedParams:p}),function(t){var n=t.closest(".processor");h.forEach(function(e){t.find(".select-all[value="+e+"]").data("indeterminate",!0).prop("indeterminate",!0)}),t.find("fieldset").each(function(){e(this).selectAll({indeterminates:!0,selector:"input[data-group="+e(this).data("group")+"]"})}),t.on("click",".group-toggle",function(){var t=e(this).closest("fieldset");t.toggleClass("opened",!t.is(".opened")),n.trigger("contentchange")})})},function(e){console.error(e),n.reject()}),n},getStoredParam:function(e,n){var a=this.get("parent").getUserData(e+"."+n);return t.isUndefined(a)||t.isNull(a)?null:a},clearStoredParam:function(e,t){this.get("parent").setUserData(e+"."+t,null)}});return t.each(["_buildParameterReportFields","buildTemperatureExtraFields","buildVoltageExtraFields","buildEngspeedExtraFields","buildObjserviceExtraFields","_getObjectPropertiesForReport","_renderPropertiesCheckboxes","buildDrivesafetyExtraFields","buildDrivesafetysumExtraFields","_renderDrivesafetyExtraFields","_initDrivesafetyExtraFields","buildAlertjournalExtraFields"],function(e){!function(e){i.prototype[e]=function(){return s[e].apply(this,arguments)}}(e)}),i}),define("text!mobile/reports/acceleration/tmpl/thead.html",[],function(){return'<tr data-head="<%= headIndex %>">\n    <th data-key="date"><%= i18n.date.ucFirst() %></th>\n    <th data-key="begin"><%= i18n.moveStart %></th>\n    <th><%= i18n.actionType %></th>\n    <th data-key="duration"><%= i18n.actionTime %>/<%= i18n.speed %></th>\n    <th data-key="address"><%= i18n.placeOfAction %></th>\n</tr>'}),define("text!mobile/reports/acceleration/tmpl/row.html",[],function(){return'<tr class="<%= rowClass %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <td data-key="date" data-value="<%= date %>"><%= dateS %></td>\n    <td data-key="begin" data-value="<%= begin %>"><%= beginS %></td>\n    <td class="text-left"><%= description %></td>\n    <td data-key="duration" data-value="<%= duration %>"><%= durationS %></td>\n    <td class="address text-left" data-key="address" data-geoid="<%= geoId %>" data-lat="<%= lat %>" data-lon="<%= lon %>">\n        <a href="javascript:;" class="build-track-segment" data-id="<%= objectId %>" data-from="<%= begin * 1000 %>" data-to="<%= end * 1000 %>">\n            <% if(address) {print(address)} else { %>\n            <span class="loading-address" data-geoid="<%= geoId %>"><%= loadingAddress %></span>\n            <% } %>\n        </a>\n    </td>\n</tr>'}),define("text!mobile/reports/acceleration/tmpl/rowObject.html",[],function(){return'<tr class="obj">\n    <td colspan="<%= colspan %>" class="summary">\n        <div class="sum-header">\n            <% if(App.reportAllowedByType(\'MOVEPARK\')) {%>\n            <a href="javascript:;" title="<%= i18n.build.ucFirst() + \' \' + i18n.reportsNames.movepark %>" class="build-another" data-type="movepark"\n               data-id="<%= id %>" data-from="<%= dayStart %>" data-to="<%= dayEnd %>">\n                <strong><%- name %> (#<%- extId %>)</strong>\n            </a>\n            <% } else { %>\n            <strong><%- name %> (#<%- extId %>)</strong>\n            <% } %>\n\n            <a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n        </div>\n        <div class="sum-content">\n            <% if(hasData) {%>\n\n            <% } else {%>\n            <p class="no-data"><%= i18n.noDataForObject %></p>\n            <% } %>\n        </div>\n    </td>\n</tr>'}),define("text!mobile/reports/acceleration/tmpl/summaryRow.html",[],function(){return'<tr<% if(isLast) {%> data-row="last"<% } %> class="<%= rowClass %>">\n    <% _.each(props, function(prop) {%>\n<td class="text-center"><%= prop in data ? data[prop] : \'\' %></td>\n    <% }) %>\n<% if(showAccel) { %>\n<td data-key="exceed_b1" data-value="<%= data.exceed_b1 %>"><%= data.exceed_b1 %></td>\n<% } %>\n<% if(showBraking) { %>\n<td data-key="exceed_b2" data-value="<%= data.exceed_b2 %>"><%= data.exceed_b2 %></td>\n<% } %>\n    <% if(showCorners) { %>\n<td data-key="corner_b1" data-value="<%= data.corner_b1 %>"><%= data.corner_b2 %></td>\n<td data-key="corner_b2" data-value="<%= data.corner_b2 %>"><%= data.corner_b1 %></td>\n    <% } %>\n</tr>'}),define("text!mobile/reports/acceleration/tmpl/summaryTable.html",[],function(){return'<table class="selectable rep-table acceleration-rep-table">\n\n    <tr>\n        <th colspan="<%= colspan %>" class="text-left"><%= i18n.summaryData %></th>\n    </tr>\n\n    <tr data-head="<%= headIndex %>">\n        <% _.each(props, function(prop) {%>\n        <th data-key="<%= prop %>"><%= propNames[prop] %></th>\n        <% }) %>\n        <% if(showAccel) { %>\n        <th data-key="exceed_b1"><%= i18n.timesAgressiveAcceleration %> <span class="nobr">(> <%= limits[0] + \' \' + i18n.ms2 %>)</span>\n        </th>\n        <% } %>\n        <% if(showBraking) { %>\n        <th data-key="exceed_b2"><%= i18n.timesAgressiveInhibition %> <span class="nobr">(> <%= Math.abs(limits[1]) + \' \' + i18n.ms2 %>)</span>\n        </th>\n        <% } %>\n        <% if(showCorners) { %>\n        <th data-key="corner_b1"><%= i18n.timesAgressiveCorners %></th>\n        <th data-key="corner_b2"><%= i18n.timesAverageCorners %></th>\n        <% } %>\n    </tr>\n\n    <%= rowsHtml %>\n\n</table>'}),define("mobile/reports/acceleration/views/AccelerationReportView",["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/acceleration/tmpl/thead.html","text!_common/reports/tmpl/day.html","text!mobile/reports/acceleration/tmpl/row.html","text!mobile/reports/acceleration/tmpl/rowObject.html","text!mobile/reports/acceleration/tmpl/summaryRow.html","text!mobile/reports/acceleration/tmpl/summaryTable.html"],function(e,t,n,a,s,r,i,o,d,l){s=t.template(s),r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d),l=t.template(l);var m=n.extend({constructor:function(){this._headIndex=0,n.apply(this,arguments)},render:function(){var s=new e.Deferred;if(n.prototype.render.apply(this,arguments),this.$el.addClass("acc-report"),this.buildMetaInfo(),this.model.get("showDetails")){this.content.append(t.template(a,{key:this.model.get("key"),theadHtml:""}));var r=this.content.find("tbody"),i=c.buildRows.call(this);r.append(i)}return this.content.append(c.buildSummaryTable.call(this)),s.resolve(),s}}),c={buildRows:function(){var e=this,n=this.model.get("header"),a=n.keyOrder,d=this.model.get("body"),l=this.model.get("footer"),m="",c=this.model.getTexts(),u=[],h=this.getDaysPeriods(n.sd,n.ed);return t.each(h,t.bind(function(n,h){m+=r({colspan:5,dateStr:this.formatDate(n)+" ("+this.getDayOfWeek(n)+")",isWeekend:this.isWeekend(n)});for(var p=null,f=null,g=null,v=null,b=0,y=0,w=a.length;w>y;++y)b=a[y],v=d[b],p=v[h],p&&(f=p.accels,g=p.corners,m+=o({colspan:5,i18n:c,id:b,name:l[b].name,dayStart:n*App.MS,dayEnd:n*App.MS+864e5,extId:l[b].extId,hasData:f.length||g.length}),(f.length>0||g.length>0)&&(m+=s({i18n:c,headIndex:++e._headIndex})),f.length>0&&t.each(f,t.bind(function(e,t,n,a){var s=(n.accel>0?c.acceleration:c.deceleration)+": "+n.accel+" "+c.ms2,r=Date.formatSeconds(n.end-n.begin,!0);n.address||u.push(n),m+=i({dateS:this.formatDate(n.begin),beginS:this.formatTime(n.begin),date:this.formatDate(n.begin),begin:n.begin,end:n.end,description:s,duration:r,durationS:r,address:n.address,geoId:n.geoId,lat:n.lat,lon:n.lon,rowClass:n.accel>0?"alert2":"gray",objectId:b,loadingAddress:c.loadingAddress,rowPosition:0==t&&e==a?"last":""})},this,f.length-1,g.length)),g.length>0&&t.each(g,t.bind(function(e,t,n){var a=1==t.type?c.averageCorner:c.agressiveCorner,s=t.speed+" "+c.kmh;t.address||u.push(t),m+=i({begin:t.tstart,beginS:this.formatTime(t.tstart)+" - "+this.formatTime(t.tend),date:this.formatDate(t.tstart),dateS:this.formatDate(t.tstart),end:t.tend,description:a,duration:t.speed,durationS:s,address:t.address,geoId:t.geoId,lat:t.lat,lon:t.lon,rowClass:1==t.type?"alert1":"alert2",objectId:b,loadingAddress:c.loadingAddress,rowPosition:n==e?"last":""})},this,g.length-1)))},this)),u.length&&this.listenTo(this.model,"afterrender",function(){e.model.searchAddresses(u)}),m},buildSummaryTable:function(){var e,t=this.model,n=t.getTexts(),a="",s=t.get("showAccel"),r=t.get("showBraking"),i=t.get("showCorners"),o=t.get("footer"),m=t.get("header").keyOrder,c=t.get("properties"),u=c.length;s&&u++,r&&u++,i&&(u+=2);for(var h=0,p=m.length;p>h;++h)e=o[m[h]],a+=d({data:e,props:c,showAccel:s,showBraking:r,showCorners:i,rowClass:h+1?"even":"odd",isLast:h===p-1});return l({i18n:n,colspan:u,rowsHtml:a,showAccel:s,showBraking:r,showCorners:i,limits:[this.model.get("b1"),this.model.get("b2")],headIndex:++this._headIndex,props:c,propNames:this.mobileProps})}};return m}),define("mobile/reports/drivesafety/views/constants",{MAX_SCORE:5}),define("mobile/reports/drivesafety/views/utils",["./constants"],function(e){function t(e,t){return t=void 0===t?1:t,Math._round(Math.max(e,0),t)}function n(n){return Math.floor(Math.min(Math.max(0,t(n)),e.MAX_SCORE))}function a(e,n){return n=void 0===n?1:n,t(e,n).toFixed(n)}function s(e){return'<span class="nobr"> '+e+"</span>"}function r(e,t,n,a){var r=[],i=t?e.drivesafety.numberOfSpeeding:e.drivesafety.mileageWithExcess,o="kmh"===a?s(e.kmh):"%",d=t?"":", "+e.km;return _.each(n,function(e){r.push(i+" >"+e+o+d)}),r}function i(e,t,n){return[e.drivesafety.accNumber+" >"+t+s(e.ms2),e.drivesafety.brakingNumber+" >"+n+s(e.ms2)]}function o(e){for(var t=0,n=0,a=e.length,s=[[90,180],[-90,-180]],r=0;a>r;++r)n=e[r].lon,t=e[r].lat,t>s[1][0]&&(s[1][0]=t),t<s[0][0]&&(s[0][0]=t),n>s[1][1]&&(s[1][1]=n),n<s[0][1]&&(s[0][1]=n);return s}return{formatScore:a,getGradeByScore:n,formatUnit:s,getSpeedingHeaders:r,getStyleHeaders:i,calcHeatMapBounds:o}}),define("text!mobile/reports/drivesafety/tmpl/reportMeta.html",[],function(){return'<div class="rep-meta selectable">\n    <div class="items-list">\n        <span class="item"><%= title %></span>\n    </div>\n\n    <% if(properties.length) {%>\n    <div class="summary">\n        <div class="sum-content">\n            <table class="object-properties">\n                <tbody>\n                <% for(var i = 0, l = properties.length; i < l; i++) { %>\n                <tr>\n                    <td><%= names[properties[i]] %>:</td>\n                    <td class="value"><%= values[properties[i]] || \'--\' %></td>\n                </tr>\n                <% } %>\n                </tbody>\n            </table>\n        </div>\n    </div>\n    <% } %>\n\n    <p class="dates"><%= i18n.reportPeriod %>:\n        <span class="nobr"><%= Date.format(i18n.DateTime.longFormat, startTime) %></span> -\n        <span class="nobr"><%= Date.format(i18n.DateTime.longFormat, endTime) %></span>\n    </p>\n\n    <% if(!_.isUndefined(zonesStr)) {%>\n    <p class="dates">\n        <%= zonesStr %>\n    </p>\n    <% } %>\n\n    <p>\n        <%= i18n.drivesafety.mintimeSpeed %>: <%= speedingMintime %>&nbsp;<%= i18n.sec %>\n    </p>\n\n    <p>\n        <%= i18n.drivesafety.mintimeAcceleration %>: <%= accelerationMintime %>&nbsp;<%= i18n.sec %>\n    </p>\n</div>\n\n\n\n'}),define("text!mobile/reports/drivesafety/tmpl/summarySingle.html",[],function(){return'<div class="drive-summary">\n\n    <div class="drive-summary-content">\n        <div class="grade" data-grade="<%= grade %>">\n            <h4 class="grade-header">\n                <%= i18n.drivesafety.grade %>\n            </h4>\n            <div class="grade-value">\n                <%= score %>\n            </div>\n            <div class="grade-label">\n                <%= gradeLabel %>\n            </div>\n        </div>\n\n        <div class="grade-details">\n\n            <div class="grade-details-row">\n                <svg class="svg-icon grade-icon">\n                    <use xlink:href="#smb-speed"></use>\n                </svg>\n                <span class="grade-bar">\n                    <span class="grade-bar-indicator" data-grade="<%= gradeBySpeeding %>"\n                          style="width: <%= speedingBarWidth %>%"></span>\n                </span>\n                <span class="grade-value"><%= scoreBySpeedings %></span>\n                <span class="grade-label"><%= gradeBySpeedingLabel %></span>\n            </div>\n\n            <div class="grade-details-row">\n                <svg class="svg-icon grade-icon">\n                    <use xlink:href="#smb-brake"></use>\n                </svg>\n                <span class="grade-bar">\n                    <span class="grade-bar-indicator" data-grade="<%= gradeByStyle %>"\n                          style="width: <%= styleBarWidth %>%"></span>\n                </span>\n                <span class="grade-value"><%= scoreByStyle %></span>\n                <span class="grade-label"><%= gradeByStyleLabel %></span>\n            </div>\n\n        </div>\n    </div><!--/.drive-summary-content-->\n\n    <%= legendHtml %>\n\n</div><!--/.drive-summary-->\n'}),define("text!mobile/reports/drivesafety/tmpl/legend.html",[],function(){return'<div class="drive-summary-legend">\n    <span class="drive-summary-legend-item"><%= i18n.drivesafety.thresholdsSet %>:</span>\n    <% _.each(legendItems, function(item){ %>\n    <span class="drive-summary-legend-item" data-grade="<%= item.grade %>"><%= item.label %></span>\n    <% }) %>\n</div>'}),define("text!mobile/reports/drivesafety/tmpl/row.html",[],function(){return'<tr class="<%= rowClass %>">\n    <td data-ts="<%= dayStart %>"><%= dateS %></td>\n    <td><%= distanceS %></td>\n    <td><%= data.spd1.exceed_b1 %></td>\n    <td><%= data.spd1.exceed_b2 %></td>\n    <td><%= data.spd2.exceed_b1 %></td>\n    <td><%= data.spd2.exceed_b2 %></td>\n    <td><%= data.acc.exceed_b1 %></td>\n    <td><%= data.acc.exceed_b2 %></td>\n</tr>'}),define("text!mobile/reports/drivesafety/tmpl/statisticsTable.html",[],function(){return'<h3 class="rep-table-header"><%= header %></h3>\n<table class="rep-table rep-table-drivesafety selectable">\n    <thead class="rep-table-head header-copy"></thead>\n    <tbody>\n\n        <tr data-head="1">\n            <th><%= i18n.date.ucFirst() %></th>\n            <th><%= i18n.runDistance %></th>\n            <th><%= i18n.drivesafety.speedings %> <%= speedLimits[0]%><%= i18n.kmh %></th>\n            <th><%= i18n.drivesafety.speedings %> <%= speedLimits[1]%><%= i18n.kmh %></th>\n            <th><%= i18n.drivesafety.speedings %> <%= speedLimits[2]%><%= i18n.kmh %></th>\n            <th><%= i18n.drivesafety.speedings %> <%= speedLimits[3]%><%= i18n.kmh %></th>\n            <th><%= i18n.drivesafety.accelerations %> <%= accelerationLimit %><%= i18n.ms2 %></th>\n            <th><%= i18n.drivesafety.brakings %> <%= brakingLimit %><%= i18n.ms2 %></th>\n        </tr>\n\n        <%= rowsHtml %>\n\n        <tr data-row="last">\n            <th><%= i18n.summary %></th>\n            <th><%= totalDistance %></th>\n            <th><%= totalSpeedings[0] %></th>\n            <th><%= totalSpeedings[1] %></th>\n            <th><%= totalSpeedings[2] %></th>\n            <th><%= totalSpeedings[3] %></th>\n            <th><%= totalAccelerations %></th>\n            <th><%= totalBrakings %></th>\n        </tr>\n\n    </tbody>\n</table><!-- /rep-table -->'}),define("text!mobile/reports/drivesafety/tmpl/calculationTable.html",[],function(){return'<h3 class="rep-table-header"><%= header %></h3>\n<table class="rep-table selectable">\n    <colgroup>\n        <col style="width: 25%">\n    </colgroup>\n    <thead>\n        <tr>\n            <th class="text-left"><%= i18n.drivesafety.indicator %></th>\n            <th><%= i18n.drivesafety.totalQuantity %></th>\n            <th><%= i18n.drivesafety.quantity100km %></th>\n            <th><%= i18n.drivesafety.indicatorWeight %></th>\n            <th><%= i18n.drivesafety.gradeByIndicator %></th>\n            <th><%= i18n.drivesafety.summaryScore %></th>\n        </tr>\n    </thead>\n    <tbody>\n        <% _.each(rows, function(row, i) {%>\n        <tr>\n            <td class="text-left"><%= row.indicator %></td>\n            <td><%= row.quantity %></td>\n            <td><%= row.quantity100km %></td>\n            <td><%= row.weight %></td>\n            <td><%= row.score %></td>\n            <% if(i === 0) {%>\n            <td rowspan="<%= rows.length %>"><%= totalScore %></td>\n            <% } %>\n        </tr>\n        <% }) %>\n    </tbody>\n</table><!-- /rep-table -->'}),define("mobile/reports/drivesafety/views/DrivesafetyReportView",["jquery","underscore","./utils","_common/reports/views/ReportView","text!../tmpl/reportMeta.html","text!../tmpl/summarySingle.html","text!../tmpl/legend.html","text!../tmpl/row.html","text!../tmpl/statisticsTable.html","text!../tmpl/calculationTable.html"],function(e,t,n,a,s,r,i,o,d,l){a.prototype,s=t.template(s),r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d),l=t.template(l);var m=a.extend({constructor:function(){this.objectId=0,this._headIndex=0,a.apply(this,arguments)},reportClassName:"drivesafety-report",initialize:function(){this.objectId=this.model.get("objectId")[0],a.prototype.initialize.apply(this,arguments)},render:function(){var t=new e.Deferred,n="";return a.prototype.render.apply(this,arguments),this.$el.addClass(this.reportClassName),this.buildMetaInfo(),this.hasDataForGrading()?(n+=this._renderSummary(),this.model.get("showStatistics")&&(n+=this._renderStatistics()),this.model.get("showCalculation")&&(n+=this._renderCalculation())):this.content.append('<p class="no-data">'+this.model.getTexts().noDataForPeriod+"</p>"),this.content.append(n),t.resolve(),t},buildMetaInfo:function(){if(this.content){var e=this.model,n=e.getTexts(),a=this.getObjectSummary(),r=e.get("properties"),i=this.getZoneStr();this.content.append(s({title:a.name+(-1==r.indexOf("extId")?"":" (#"+a.extId+")"),i18n:n,properties:t.without(r,"name","extId"),names:this.mobileProps,values:a,startTime:e.get("startTime"),endTime:e.get("endTime"),speedingMintime:e.get("speedingMintime"),accelerationMintime:e.get("accelerationMintime"),zonesStr:i}))
}},hasDataForGrading:function(){var e=this.getObjectSummary();return e&&"totalScore"in e},getObjectSummary:function(){var e=this.objectId,t=this.model.get("footer");return e in t?t[e]:null},getGradeLegend:function(e){var t,n=this.model.getTexts().drivesafety;switch(e){case 0:t=n.gradeGoodLegend;break;case 1:t=n.gradeMiddleLegend;break;case 2:t=n.gradeBadLegend;break;default:t=""}return t},getLegendItems:function(){var e=[],n=this.model.get("gradeThresholds");return t.each([0,1,2],function(t){e.push({grade:t,label:this.getGradeLegend(t)+" "+(0==t?n[0]:n[1])})}.bind(this)),e},getGradeLabel:function(e){var t,n=this.model.getTexts().drivesafety;switch(e){case 0:t=n.gradeGood;break;case 1:t=n.gradeMiddle;break;case 2:t=n.gradeBad;break;default:t=""}return t},getGradeDescription:function(e){var t,n=this.model.getTexts().drivesafety;switch(e){case 0:t=n.gradeGoodDescription;break;case 1:t=n.gradeMiddleDescription;break;case 2:t=n.gradeBadDescription;break;default:t=""}return t},_renderSummary:function(){var e=this.model.getTexts(),a=this.getObjectSummary(),s={i18n:e},o=this.model.get("gradeThresholds"),d=Math.max(10,o[1],a.speedScore,a.accScore);return t.extend(s,{grade:a.totalGrade,score:n.formatScore(a.totalScore,1),gradeLabel:this.getGradeLabel(a.totalGrade),scoreBySpeedings:n.formatScore(a.speedScore,1),gradeBySpeeding:a.speedGrade,gradeBySpeedingLabel:e.drivesafety.speedKeeping+" - "+this.getGradeDescription(a.speedGrade),speedingBarWidth:Math.round(100*a.speedScore/d),scoreByStyle:n.formatScore(a.accScore,1),gradeByStyle:a.accGrade,gradeByStyleLabel:e.drivesafety.driveStyle+" - "+this.getGradeDescription(a.accGrade),styleBarWidth:Math.round(100*a.accScore/d),legendHtml:i({i18n:e,legendItems:this.getLegendItems()})}),r(s)},_renderStatistics:function(){var e=this.model,t=e.getTexts(),n=this.getObjectSummary(),a=this._renderRows();return d({header:t.drivesafety.objectStatistics,i18n:t,speedLimits:e.get("speedLimits"),accelerationLimit:e.get("accelerationLimit"),brakingLimit:Math.abs(e.get("brakingLimit")),totalDistance:this.formatDistance(n.totalRun),totalSpeedings:[n.totalSpd1,n.totalSpd2,n.totalSpd3,n.totalSpd4],totalAccelerations:n.totalAcc,totalBrakings:n.totalBrk,rowsHtml:a})},_renderRows:function(){var e=this.model,n=e.getTexts(),a="",s=e.get("body")[this.objectId],r=0;return t.each(s,function(e,t){a+=o({i18n:n,dayStart:t,dateS:this.formatDate(t/App.MS),distanceS:this.formatDistance(e.run.distance),data:e,rowClass:++r%2?"odd":"even"})}.bind(this)),a},_renderCalculation:function(){var e,a,s=this.model,r=s.getTexts(),i=this.getObjectSummary(),o=s.get("speedLimits"),d=s.get("speedWeights"),m=s.get("accelerationLimit"),c=s.get("accelerationWeight"),u=s.get("brakingLimit"),h=s.get("brakingWeight"),p={i18n:r,header:r.drivesafety.speedCalculation},f="",g=[];return t.each([1,2,3,4],function(t,s){e={indicator:r.drivesafety.speedings+" "+o[s]+r.kmh,quantity:i["totalSpd"+t],quantity100km:0,weight:d[s],score:n.formatScore(0)},a="spd"+t+"Per100km",a in i&&(e.quantity100km=i[a]),a="spd"+t+"Score",a in i&&(e.score=n.formatScore(i[a],2)),g.push(e)}.bind(this)),p.rows=g,p.totalScore=n.formatScore(i.speedScore,1),f=l(p),p.header=r.drivesafety.styleCalculation,p.rows=[{indicator:r.drivesafety.accelerations+" "+m+r.ms2,quantity:i.totalAcc,quantity100km:"aPer100km"in i?i.aPer100km:0,weight:c,score:n.formatScore("aScore"in i?i.aScore:0,2)},{indicator:r.drivesafety.brakings+" "+u+r.ms2,quantity:i.totalBrk,quantity100km:"bPer100km"in i?i.bPer100km:0,weight:h,score:n.formatScore("bScore"in i?i.bScore:0,2)}],p.totalScore=n.formatScore(i.accScore,1),f+=l(p)}});return m}),define("text!mobile/reports/drivesafety/tmpl/summary.html",[],function(){return'<div class="drive-summary">\n\n    <div class="drive-summary-headers">\n        <h4 class="drive-summary-header grade-header">\n            <%= i18n.drivesafety.gradeByGroup %>\n        </h4>\n        <h4 class="drive-summary-header grade-details-header">\n            <%= i18n.drivesafety.gradeDistributionbyObjects %>\n        </h4>\n    </div>\n\n    <div class="drive-summary-content">\n\n        <div class="grade" data-grade="<%= grade %>">\n            <div class="grade-value">\n                <%= score %>\n            </div>\n        </div>\n\n        <div class="grade-details drive-summary-details">\n            <div class="grade-details-content">\n                <div class="grade-labels">\n                    <% _.each(rows, function(row){%>\n                    <div class="grade-label" data-grade="<%= row.grade %>"><%= row.label %></div>\n                    <% }) %>\n                </div>\n                <div class="grade-bars">\n                    <% _.each(rows, function(row){%>\n                    <div class="grade-bar">\n                        <div class="grade-bar-indicator" data-grade="<%= row.grade %>" style="width: <%= row.barWidth %>%"></div>\n                    </div>\n                    <% }) %>\n                </div>\n                <div class="grade-percents">\n                    <% _.each(rows, function(row){%>\n                    <div data-grade="<%= row.grade %>" class="grade-percent"><%= row.nb %> (<%= row.percent %>%)</div>\n                    <% }) %>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n'}),define("text!mobile/reports/drivesafety/tmpl/top.html",[],function(){return'<div class="drive-top rep-chart">\n    <div class="chart-header clearfix">\n        <h4><%= title %></h4>\n    </div>\n    <div class="chart-content"></div>\n</div>'}),define("text!mobile/reports/drivesafety/tmpl/objectsTable.html",[],function(){return'<h3 class="rep-table-header"><%= header %></h3>\n<table class="rep-table drivesafetysum-rep-table">\n    <tr data-head="1">\n        <% for(var i = 0, l = names.length; i < l; i++) { %>\n        <th><%= names[i] %></th>\n        <% } %>\n    </tr>\n\n    <%= html %>\n</table>'}),define("text!mobile/reports/drivesafety/tmpl/objectRow.html",[],function(){return'<tr<% if(isLast) {%> data-row="last"<% } %>\n    <% if(hasData) { %> data-index="<%= index %>"<% } %>\n    class="rep-row <%= rowClass %>">\n<% _.each(properties, function(key){ %>\n<td>\n    <% if(hasData) { %>\n    <a href="javascript:;">\n        <%= key in summary ? summary[key] : \'--\' %>\n    </a>\n    <% } else { %>\n    <%= key in summary ? summary[key] : \'--\' %>\n    <% } %>\n</td>\n<% }) %>\n\n<% if(hasData) { %>\n    <% if(showListWithViolations) { %>\n    <td><%= summary.totalDistance %></td>\n    <td><%= summary.totalSpeedings[0] %></td>\n    <td><%= summary.totalSpeedings[1] %></td>\n    <td><%= summary.totalSpeedings[2] %></td>\n    <td><%= summary.totalSpeedings[3] %></td>\n    <td><%= summary.totalAccelerations %></td>\n    <td><%= summary.totalBrakings %></td>\n    <% } %>\n\n    <% if(showListWithSumScore) { %>\n    <td class="cell-score" data-grade="<%= summary.accGrade %>">\n        <%= summary.accScore %>\n    </td><td class="cell-score" data-grade="<%= summary.speedGrade %>">\n        <%= summary.speedScore %>\n    </td><td class="cell-score" data-grade="<%= summary.totalGrade %>">\n        <%= summary.totalScore %>\n    </td>\n    <% } %>\n<% } else { %>\n    <% if(showListWithViolations) { %>\n        <td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td><td>--</td>\n    <% } %>\n    <% if(showListWithSumScore) { %>\n        <td>--</td><td>--</td><td>--</td>\n    <% } %>\n<% } %>\n\n</tr>'}),define("mobile/reports/drivesafety/views/DrivesafetySumReportView",["jquery","underscore","./utils","_common/reports/views/ReportView","./DrivesafetyReportView","text!../tmpl/summary.html","text!../tmpl/top.html","text!../tmpl/objectsTable.html","text!../tmpl/objectRow.html","text!../tmpl/legend.html","_libs/charts/jqChart/src/js/jquery.jqChart.dev","css!_libs/charts/jqChart/css/jquery.jqChart.css"],function(e,t,n,a,s,r,i,o,d,l){var m=a.prototype,c=s.prototype;i=t.template(i),o=t.template(o),d=t.template(d),l=t.template(l);var u=a.extend({constructor:function(){this.$summary=null,this.$top=null,this.$chart=null,this.$list=null,this._objects=[],a.apply(this,arguments)},reportClassName:"drivesafety-report drivesafetysum-report",tmplSummary:t.template(r),render:function(){var t=new e.Deferred,n=this.model,a="";return m.render.apply(this,arguments),this.$el.addClass(this.reportClassName),this.buildMetaInfo(),this._filterDataForGrading(),this._objects.length?(n.get("showSummary")&&this._renderSummary(),n.get("showTop")&&this._renderTop(),this._shouldRenderList()&&this._renderList(),this._renderLegend()):this.content.append('<p class="no-data">'+this.model.getTexts().noDataForPeriod+"</p>"),this.content.append(a),t.resolve(),t},getObjectSummary:function(e){var t=this.model.get("footer");return e in t?t[e]:null},getAvgScore:function(){for(var e=0,t=this._objects,n=t.length;n--;)e+=t[n].totalScore;return Math._round(e/t.length,1)},getAvgGrade:function(){for(var e=0,t=this._objects,n=t.length;n--;)e+=t[n].totalGrade;return Math.round(e/t.length)},getLegendItems:function(){return c.getLegendItems.apply(this,arguments)},getGradeLegend:function(){return c.getGradeLegend.apply(this,arguments)},getGradeLabel:function(){return c.getGradeLabel.apply(this,arguments)},getBarValue:function(e){return e.totalScore},getBarColor:function(e){var t,n=e.totalGrade;switch(n){case 0:t="#57ba29";break;case 1:t="#ffb03d";break;case 2:t="#db2e1a";break;default:t="#cccccc"}return t},getPercent:function(e,t){var n=100*e/t,a=Math._round(n,1>n||n>=99.5?2:0);return a},_filterDataForGrading:function(){for(var e,n=!1,a=this.model.get("objectId"),s=[],r=a.length;r--;)e=this.getObjectSummary(a[r]),e&&"totalScore"in e&&(e.totalScore=Math._round(e.totalScore,1),n=!0,s.push(e));return this._objects=t.sortBy(s,function(e){return 0-e.totalScore}),n},_filterObjectsByGrade:function(e){return t.filter(this._objects,function(t){return t.totalGrade==e})},_renderSummary:function(){var n,a,s,r=this,i=this.model,o=this._objects,d=(o.length,i.get("objectId").length),l=d-o.length,m=i.getTexts(),c=this.getAvgGrade(),u=[],h=[];t.each([0,1,2],function(e){n=t.reduce(o,function(t,n){return t+(n.totalGrade==e?1:0)},0),n>0&&(a=r.getPercent(n,d),h.push(a),u.push({label:r.getGradeLabel(e),grade:e,nb:n,percent:a}))}),l>0&&(a=r.getPercent(l,d),h.push(a),u.push({label:m.noData.ucFirst(),grade:"",nb:l,percent:a})),s=t.max(h),t.each(u,function(e){e.barWidth=100*e.percent/s}),this.$summary=e(this.tmplSummary({i18n:m,score:this.getAvgScore(),grade:c,gradeLabel:this.getGradeLabel(c),rows:u})).appendTo(this.content),this.$summary.find(".grade-details [data-grade]").on("click",function(){var n=r._filterObjectsByGrade(e(this).data("grade"));n.length&&i.buildChildReport(t.pluck(n,"id"))})},_renderChart:function(e){this.$chart.jqChart({title:!1,height:250,width:this.$chart.width()+"px",border:{lineWidth:0},legend:{visible:!1},series:e})},_getChartTitle:function(){return this.model.getTexts().drivesafety.objectsWithWorstScore},_renderTop:function(){var n,a=this.model,s=a.get("properties").indexOf("extId")>-1,r=(a.getTexts(),this._objects),o=r.slice(0,5),d=[],l=[],m=null;this.$top=e(i({title:this._getChartTitle()})).appendTo(this.content),this.$chart=this.$top.find(".chart-content");for(var c=function(e){return e.name+(s?" (#"+e.extId+")":"")},u=0,h=o.length;h>u;++u)n=o[u],d.push(this.getBarColor(n)),l.push([c(n),this.getBarValue(n)]);this.$chart.jqChart({title:!1,height:250,width:this.$chart.width()+"px",border:{lineWidth:0},legend:{visible:!1},series:[{type:"column",pointWidth:Math.max(Math.min(.4,.8/o.length),.25),fillStyles:d,data:l}]}),this.listenTo(App,"layoutchange",function(e){if(e&&e.leftWidth){var t=this.$top.width();t>0&&this._resizeCharts(t)}}.bind(this)),this.$chart.on("dataPointMouseDown",function(e,t){m=o[t.index]}).on("dataPointMouseUp",function(){m&&a.buildChildReport([m.id])}).on("dataPointMouseLeave",function(){m=null}).on("axisLabelMouseDown",function(e,n){var s=t.find(o,function(e){return c(e)===n.text});s&&a.buildChildReport([s.id])}).on("axisLabelMouseUp",function(){})},_shouldRenderList:function(){return this.model.get("showListWithViolations")||this.model.get("showListWithSumScore")},_renderList:function(){var n,a,s=this.model,r=s.get("showListWithViolations"),i=s.get("showListWithSumScore"),l=s.getTexts(),m=l.drivesafety,c=this._objects,u=[],h=this.model.get("objectId"),p=h.length,f=s.get("properties"),g="",v=0,b=this.mobileProps,y=[],w=m.objectsList+" ";if(c.length<p){var S;for(n=h.length;n--;)S=this.getObjectSummary(h[n]),!S||"totalScore"in S||u.push(S)}if(p=u.length+c.length,w+=r&&i?m.withViolationsAndTotalScore:r?m.withViolations:m.withTotalScore,t.each(f,function(e){y.push(b[e])}),r){var x=s.get("speedLimits"),k=s.get("accelerationLimit"),D=s.get("brakingLimit"),_=0;for(y.push(l.runDistance);_++<4;)y.push(m.speedings+" "+x[_-1]+" "+l.kmh);y.push(m.accelerations+" "+k+" "+l.ms2),y.push(m.brakings+" "+D+" "+l.ms2)}i&&(y=t.union(y,[m.accScore,m.speedScore,m.summaryScore])),t.each(c,function(e){a=this._prepareRowData(e),a.index=v,a.rowClass=++v%2?"odd":"even",a.isLast=v===p,g+=d(a)}.bind(this)),u.length&&t.each(u,function(e){a=this._prepareRowData(e),a.index=v,a.rowClass=++v%2?"odd":"even",a.isLast=v===p,g+=d(a)}.bind(this)),this.$list=e(o({header:w,names:y,html:g})).appendTo(this.content),this._initObjectStatisticsRows()},_initObjectStatisticsRows:function(){var t,n=this.model,a=this._objects;this.$list.on("mousedown",".rep-row[data-index]",function(){var n=e(this).data("index");t={ts:+new Date,index:n,data:a[n]}}).on("mouseup",".rep-row[data-index]",function(){if(t){var a=e(this).data("index"),s=+new Date;a===t.index&&s-t.ts<300&&n.buildChildReport([t.data.id])}})},_prepareRowData:function(e){var a=this.model.get("showListWithViolations"),s=this.model.get("showListWithSumScore");"totalScore"in e&&(a&&t.extend(e,{totalDistance:this.formatDistance(e.totalRun),totalSpeedings:[e.totalSpd1,e.totalSpd2,e.totalSpd3,e.totalSpd4],totalAccelerations:e.totalAcc,totalBrakings:e.totalBrk}),s&&t.extend(e,{accScore:n.formatScore(e.accScore,1),speedScore:n.formatScore(e.speedScore,1),totalScore:n.formatScore(e.totalScore,1)}));var r={summary:e};return r.properties=this.model.get("properties"),r.hasData="totalScore"in e,r.showListWithViolations=a,r.showListWithSumScore=s,r},_renderLegend:function(){e(l({i18n:this.model.getTexts(),legendItems:this.getLegendItems()})).appendTo(this.content)},_resizeCharts:function(e){var t=e+"px";this.$chart.jqChart("option","width",t)}});return u}),define("mobile/reports/drivesafety/DrivesafetyLegacyReport",["jface","_common/reports/Report","_common/reports/ReportsMixin","./views/DrivesafetyReportView","./views/DrivesafetySumReportView"],function(e,t,n,a,s){var r=n.getDrivesafetyDefaultParameters(),i=t.extend({url:function(){var e=this.isSummary()?"DRIVESAFETYSUMOLD":"DRIVESAFETYOLD";return App.getBaseUrl()+"reports/"+e+"/"},constructor:function(){t.apply(this,arguments)},defaultParameters:r,defaults:_.extend({},t.prototype.defaults,r),ViewClassSum:s,ViewClassSingle:a,initialize:function(e){t.prototype.initialize.call(this,this.isSummary()?this.ViewClassSum:this.ViewClassSingle),this._prepareDeviceProperties(),this._processParameters(e),"source"in e&&e.source.registerChild(this)},isSummary:function(){return this.get("items").length>1},getSpeedLimits:function(){var e,t;return(e=this.getUserData("b1"))&&(t=this.getUserData("b2"))?[e,t]:this.get("module").getSpeedLimits()},getPostParams:function(){var e=this,n=t.prototype.getPostParams.call(this);return this.get("speedLimits"),n.properties=this.get("properties"),n.zoneId=this.get("zoneId"),n.zoneId||0===n.zoneId||"0"===n.zoneId||delete n.zoneId,_.each(this.defaultParameters,function(t,a){n[a]=e.get(a)}),this.get("showStatistics")||(n.hideDetails=1),n},_getChildReportParams:function(){var e={};return _.each(this.defaultParameters,function(t,n){e[n]=this.get(n)}.bind(this)),e},_processSpeedLimitParameters:function(e){var t,n,a="source"in e;_.each(["speedLimits","speedWeights","gradeThresholds"],function(e){n=r[e],t=this.get(e),this.set(e,_.map(t,function(e,t){return""===e?n[t]:(e=Number(e),_.isNaN(e)?n[t]:e)})),!a&&this.setUserData(e,this.get(e))}.bind(this))},_processAccelerationParameters:function(e){var t,n,a,s="source"in e;_.each(["accelerationMintime","speedingMintime","accelerationLimit","accelerationWeight","brakingLimit","brakingWeight"],function(e){t=this.get(e),a=""===t?n:Number(t),this.set(e,_.isNaN(a)?n:a),!s&&this.setUserData(e,this.get(e))}.bind(this));var r="brakingLimit";t=this.get(r),t>0&&this.set(r,0-t),!s&&this.setUserData(r,this.get(r))},_processParameters:function(e){var t,n="source"in e;if(this._processSpeedLimitParameters(e),this._processAccelerationParameters(e),this.isSummary()){var a=!1;_.each(["showSummary","showTop","showListWithViolations","showListWithSumScore"],function(s){t=s in e,a=a||t,this.set(s,t),!n&&this.setUserData(s,t)}.bind(this)),a||(this.set("showSummary",!0),!n&&this.setUserData("showSummary",!0))}else _.each(["showStatistics","showCalculation"],function(a){t=a in e,this.set(a,t),!n&&this.setUserData(a,t)}.bind(this))}});return i}),define("text!mobile/reports/drivesafety/tmpl/summarySingleMapMatching.html",[],function(){return'<div class="drive-summary drive-summary-2020">\n    <div class="grade">\n        <div class="grade-value" data-grade="<%= objectGrade %>">\n            <%= objectScore %>\n        </div>\n\n        <div class="grade-stars">\n            <% for(var i = 1; i <= 5; ++i ) {\n            var starPercent = Math.max(0, Math.min(1, ( objectScore - i + 1 ))) * 100;\n            %>\n            <div class="grade-star"\n                 style="background-image: linear-gradient(90deg, #888 0%, #888 <%= starPercent %>%, #e1e1e1 <%= starPercent %>%, #e1e1e1 100%);"\n            ></div>\n            <% } %>\n        </div>\n        <div class="grade-label">\n            <%= i18n.drivesafety.overallGrade %>\n        </div>\n    </div>\n    <div class="grade-details">\n        <div class="grade-details-header">\n            <%= i18n.drivesafety.penaltyPoints %>\n        </div>\n        <div class="grade-details-row">\n            <div class="grade-details-row-prefix">\n                <%= objectSpeedPenalty %>\n            </div>\n            <div class="grade-bar" data-grade="<%= gradeBySpeeding %>">\n                <div class="grade-bar-indicator" style="width: <%= speedingBarWidth %>%"></div>\n            </div>\n            <div class="grade-details-row-postfix">\n                <%= i18n.drivesafety.speedKeeping%> - <strong><%= gradeBySpeedingLabel%></strong>\n            </div>\n        </div>\n        <div class="grade-details-row">\n            <div class="grade-details-row-prefix">\n                <%= objectStylePenalty %>\n            </div>\n            <div class="grade-bar" data-grade="<%= gradeByStyle %>">\n                <div class="grade-bar-indicator" style="width: <%= styleBarWidth %>%"></div>\n            </div>\n            <div class="grade-details-row-postfix">\n                <%= i18n.drivesafety.driveStyle%> - <strong><%= gradeByStyleLabel %></strong>\n            </div>\n        </div>\n    </div>\n</div>\n'}),define("text!mobile/reports/drivesafety/tmpl/statisticsTableMapMatching.html",[],function(){return'<h3 class="rep-table-header"><%= i18n.drivesafety.objectStatistics %></h3>\n<table class="rep-table rep-table-drivesafety selectable">\n    <thead class="rep-table-head header-copy"></thead>\n    <tbody>\n\n    <tr data-head="1">\n        <% for(var i = 0, l = names.length; i < l; i++) { %>\n        <th><%= names[i] %></th>\n        <% } %>\n    </tr>\n\n    <%= rowsHtml %>\n\n    </tbody>\n</table><!-- /rep-table -->\n'}),define("text!mobile/reports/drivesafety/tmpl/dateRowMapMatching.html",[],function(){return'<tr class="<%= rowClass %>">\n    <td><%= dateS %></td>\n    <td><%= totalDistance %></td>\n    <% _.each(speeding, function(v) {%>\n    <td><%= v %></td>\n    <% }) %>\n    <td><%= accViolations %></td>\n    <td><%= brkViolations %></td>\n    <td class="cell-grade" data-grade="<%= speedGrade %>"><%= speedScore %></td>\n    <td class="cell-grade" data-grade="<%= styleGrade %>"><%= styleScore %></td>\n    <td class="cell-grade" data-grade="<%= grade %>"><%= score %></td>\n</tr>\n'}),define("text!mobile/reports/drivesafety/tmpl/rowSummaryMapMatching.html",[],function(){return'<tr data-row="last">\n    <th colspan="<%= colspan %>"\n    <% if(colspan > 1) {%> class="text-right"<% } %>><%= i18n.summary %></th>\n    <% _.each(values, function(v){ %>\n    <th><%= v %></th>\n    <% }) %>\n    <% _.each(scores, function(score){ %>\n    <th data-grade="<%= score.grade %>"><%= score.value %></th>\n    <% }) %>\n</tr>\n'}),define("text!mobile/reports/drivesafety/tmpl/calculationTableMapMatching.html",[],function(){return'<h3 class="rep-table-header"><%= header %></h3>\n<table class="rep-table selectable">\n    <colgroup>\n        <col style="width: 30%">\n    </colgroup>\n    <thead>\n    <tr>\n        <th class="text-left"><%= i18n.drivesafety.indicator %></th>\n        <th><%= i18n.drivesafety.value %></th>\n        <th><%= i18n.drivesafety.value100km %></th>\n        <th><%= i18n.drivesafety.indicatorWeight %></th>\n        <th><%= i18n.drivesafety.penaltyPointsByIndicator %></th>\n        <th><%= i18n.drivesafety.penaltyPoint %></th>\n        <th><%= i18n.drivesafety.grade %></th>\n    </tr>\n    </thead>\n    <tbody>\n    <% _.each(rows, function(row, i) {%>\n    <tr>\n        <td class="text-left"><%= row.indicator %></td>\n        <td><%= row.value %></td>\n        <td><%= row.value100km %></td>\n        <td><%= row.weight %></td>\n        <td><%= row.penaltyPoints %></td>\n        <% if(i === 0) {%>\n        <td rowspan="<%= rows.length %>"><%= totalPenaltyPoints %></td>\n        <td rowspan="<%= rows.length %>"><%= totalScore %></td>\n        <% } %>\n    </tr>\n    <% }) %>\n    </tbody>\n</table><!-- /rep-table -->\n'}),define("mobile/reports/drivesafety/views/DrivesafetyMapMatchingReportView",["jquery","underscore","./constants","./utils","./DrivesafetyReportView","text!../tmpl/summarySingleMapMatching.html","text!../tmpl/statisticsTableMapMatching.html","text!../tmpl/dateRowMapMatching.html","text!../tmpl/rowSummaryMapMatching.html","text!../tmpl/calculationTableMapMatching.html"],function(e,t,n,a,s,r,i,o,d,l){function m(e){return Math._round(e,2).toFixed(2)}function c(e){return e>5?">5":m(e)}function u(e){return Math.min(Math.round(100*e/n.MAX_SCORE),100)}function h(e,n,a,s,r){return r=r||{},s=s||a+v,function(i){return'<a href="#" class="build-another" title="" data-type="'+n+'" '+'data-id="'+e+'"  '+'data-from="'+a+'" '+'data-to="'+s+'" '+t.map(t.keys(r),function(e){return"data-"+e+'="'+r[e]+'"'}).join(" ")+">"+i+"</a>"}}function p(e,t,n,a,s){var r={min:a[0]};return a[1]&&(r.max=a[1]),r.percents=s,h(e,"speeding1b",t,n,r)}function f(e,t,n,a){return h(e,"acceleration",t,n,{acc:a,brk:!a})}r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d),l=t.template(l);var g=s.prototype,v=864e5,b=s.extend({constructor:function(){s.apply(this,arguments)},reportClassName:g.reportClassName+" drivesafety-2020-report",initialize:function(){this.objectId=this.model.get("objectId")[0];var e="quantity"===this.model.get("useMileageOrQuantity");this.formatViolation=function(t){return e?t:this.formatDistance(t)}.bind(this),g.initialize.apply(this,arguments)},getObjectSummary:function(){var e=this.objectId,t=this.model.get("body");return e in t?t[e]:null},hasDataForGrading:function(){var e=this.getObjectSummary();return"objectScore"in e},getScoreDescription:function(e){var t=a.getGradeByScore(e),n=this.model.getTexts().drivesafety;switch(t){case 5:return n.gradeExcellentDescription;case 4:return n.gradeGoodDescription;case 3:return n.gradeMiddleDescription;case 2:return n.gradeBadDescription;case 1:case 0:return n.gradeUglyDescription;default:return""}},_renderSummary:function(){var e=this.model,t=e.getTexts(),n=this.getObjectSummary(),s=n.objectSpeedScore,i=n.objectSpeedPenalty,o=n.objectStyleScore,d=n.objectStylePenalty,l={i18n:t,objectScore:a.formatScore(n.objectScore),objectGrade:a.getGradeByScore(n.objectScore),objectSpeedPenalty:c(i),gradeBySpeeding:a.getGradeByScore(s),gradeBySpeedingLabel:this.getScoreDescription(s),speedingBarWidth:u(i),objectStylePenalty:c(d),gradeByStyle:a.getGradeByScore(o),gradeByStyleLabel:this.getScoreDescription(o),styleBarWidth:u(d)};return r(l)},_renderStatistics:function(){var e=this.model,s=e.getTexts(),r=s.drivesafety,l=this.getObjectSummary(),m=this.objectId,c=e.get("header"),u=c.sd*App.MS,h=c.ed*App.MS,g=[s.date.ucFirst(),s.runDistance+", "+s.km],b=this.getDaysPeriods(c.sd,c.ed),y=Math.abs(e.get("brakingLimit")),w=e.get("accelerationLimit"),S=e.get("speedExcessUnits"),x="percentage"===S,k=e.get("useMileageOrQuantity"),D=e.get("speedExcessLimits"),_="quantity"===k,T=_?"Count":"Dist",j="",M=0,C=new Array(D.length).fill(0),R=0,I=0;t.each(b,function(e){var s,r=e*App.MS;if(r in l){var i=l[r],d=Math.max(r,u),c=Math.min(r+v,h),g=f(m,d,c,!0),b=f(m,d,c,!1),y=function(e,t){var n=e in i?i[e]:0,a=this.formatViolation(n);return n>0?p(m,d,c,t,x)(a):a}.bind(this),w="styleScore"in i?i.styleScore:n.MAX_SCORE,S="speedScore"in i?i.speedScore:n.MAX_SCORE,k="score"in i?i.score:n.MAX_SCORE;s={totalDistance:this.formatDistance(i.distKm||0),speeding:[],styleScore:a.formatScore(w),styleGrade:a.getGradeByScore(w),speedScore:a.formatScore(S),speedGrade:a.getGradeByScore(S),score:a.formatScore(k),grade:a.getGradeByScore(k)};for(var _=1;_<=D.length;++_){var P="b"+_+T,F=[D[_-1]];_<D.length&&(F[1]=D[_]),s.speeding.push(y(P,F)),C[_-1]+=P in i?i[P]:0}s.accViolations=i.accCount?g(i.accCount):"0",s.brkViolations=i.brkCount?b(i.brkCount):"0",R+=i.accCount||0,I+=i.brkCount||0}else{var A="--";s={totalDistance:A,speeding:new Array(D.length).fill(A),accViolations:A,brkViolations:A,styleScore:A,styleGrade:A,speedScore:A,speedGrade:A,score:A,grade:A}}t.extend(s,{dateS:this.formatDate(e),rowClass:++M%2?"odd":"even"}),j+=o(s)}.bind(this)),g=g.concat(a.getSpeedingHeaders(s,_,D,S)).concat(a.getStyleHeaders(s,w,y)),g.push(r.speedingGrade),g.push(r.drivingStyleGrade),g.push(r.overallGrade);var P=c.sd*App.MS,F=c.ed*App.MS;return j+=d({i18n:s,colspan:1,values:[this.formatDistance(l.objectDistKm)].concat(t.map(C,function(e,t){var n=this.formatViolation(e);if(e>0){var a=[D[t]];t<D.length-1&&(a[1]=D[t+1]);var s=p(m,P,F,a,x);return s(n)}return n}.bind(this))).concat([R>0?f(m,P,F,!0)(R):"0",I>0?f(m,P,F,!1)(I):"0"]),scores:[{value:a.formatScore(l.objectSpeedScore),grade:a.getGradeByScore(l.objectSpeedScore)},{value:a.formatScore(l.objectStyleScore),grade:a.getGradeByScore(l.objectStyleScore)},{value:a.formatScore(l.objectScore),grade:a.getGradeByScore(l.objectScore)}]}),i({i18n:s,names:g,rowsHtml:j})},_renderCalculation:function(){var e,n=this.model,s=n.get("header"),r=this.objectId,i=1e3*s.sd,o=1e3*s.ed,d=n.getTexts(),c=this.getObjectSummary(),u=n.get("speedExcessWeights"),h=Math.abs(n.get("brakingLimit")),g=n.get("accelerationLimit"),v=n.get("speedExcessUnits"),b=n.get("useMileageOrQuantity"),y=n.get("speedExcessLimits"),w="quantity"===b,S=w?"Count":"Dist",x="",k=function(e,t){var n=e in c?c[e]:0,a=this.formatViolation(n),s=[y[t]];t<y.length-1&&(s[1]=y[t+1]);var d=p(r,i,o,s,"percentage"===v);return n>0?d(a):a}.bind(this),D=function(e){var t=e in c?c[e]:0;return Math._round(t,2).toFixed(2)}.bind(this),_=a.getSpeedingHeaders(d,w,y,v);return e=t.map(_,function(e,t){var n="b"+(t+1),a=n+S+"Per100",s=n+"Penalty";return{indicator:e,value:k(n+S,t),value100km:D(a),weight:u[t],penaltyPoints:m(c[s]||0)}}),x+=l({i18n:d,header:d.drivesafety2020.speedCalculation,rows:e,totalPenaltyPoints:m(c.objectSpeedPenalty),totalScore:a.formatScore(c.objectSpeedScore)}),_=a.getStyleHeaders(d,g,h),e=[{indicator:_[0],value:c.accCount>0?f(r,i,o,!0)(c.accCount):"0",value100km:D("accCountPer100"),weight:n.get("accelerationWeight"),penaltyPoints:m(c.accPenalty||0)},{indicator:_[1],value:c.brkCount>0?f(r,i,o,!1)(c.brkCount):"0",value100km:D("brkCountPer100"),weight:n.get("brakingWeight"),penaltyPoints:m(c.brkPenalty||0)}],x+=l({i18n:d,header:d.drivesafety2020.styleCalculation,rows:e,totalPenaltyPoints:m(c.objectStylePenalty),totalScore:a.formatScore(c.objectStyleScore)})}});return b}),define("text!mobile/reports/drivesafety/tmpl/objectRowMapMatching.html",[],function(){return'<tr <% if(hasData) { %> data-index="<%= index %>"<% } %>\nclass="rep-row <%= rowClass %>">\n<% _.each(properties, function(key){ %>\n<td>\n    <% if(hasData) { %>\n    <a href="javascript:;">\n        <%= key in summary ? summary[key] : \'--\' %>\n    </a>\n    <% } else { %>\n    <%= key in summary ? summary[key] : \'--\' %>\n    <% } %>\n</td>\n<% }) %>\n\n<% if(hasData) { %>\n<td><%= summary.totalDistance %></td>\n<% _.each(summary.speeding, function(v) {%>\n<td><%= v %></td>\n<% }) %>\n<td><%= summary.accViolations %></td>\n<td><%= summary.brkViolations %></td>\n<td class="cell-grade" data-grade="<%= summary.speedGrade %>"><%= summary.objectSpeedScore %></td>\n<td class="cell-grade" data-grade="<%= summary.styleGrade %>"><%= summary.objectStyleScore %></td>\n<td class="cell-grade" data-grade="<%= summary.grade %>"><%= summary.objectScore %></td>\n<% } else { %>\n<td>--</td>\n<td>--</td>\n<td>--</td>\n<td>--</td>\n<td>--</td>\n<td>--</td>\n<td>--</td>\n<td>--</td>\n<td>--</td>\n<td>--</td>\n<% } %>\n\n</tr>\n'}),define("text!mobile/reports/drivesafety/tmpl/summaryMapMatching.html",[],function(){return'<div class="drive-summary drive-summary-2020">\n    <div class="grade">\n        <div class="grade-value" data-grade="<%= avgGrade %>">\n            <%= avgScore %>\n        </div>\n        <div class="grade-stars">\n            <% for(var i = 1; i <= 5; ++i ) {\n            var starPercent = Math.max(0, Math.min(1, ( avgScore - i + 1 ))) * 100;\n            %>\n            <div class="grade-star"\n                 style="background-image: linear-gradient(90deg, #888 0%, #888 <%= starPercent %>%, #e1e1e1 <%= starPercent %>%, #e1e1e1 100%);"\n            ></div>\n            <% } %>\n        </div>\n        <div class="grade-label">\n            <%= i18n.drivesafety2020.gradeByGroup%>\n        </div>\n    </div>\n\n    <div class="grade-details">\n        <div class="grade-bars">\n            <% _.each(rows, function(row){%>\n            <div class="grade-bar" data-grade="<%= row.grade %>" data-value="<%= row.nb %>">\n                <div class="grade-bar-prefix">\n                    <%= row.label || row.grade %>\n                </div>\n                <% if(row.barWidth > 0) {%>\n                <div class="grade-bar-indicator" style="width: calc((100% - 32px) * <%= row.barWidth / 100 %>)"></div>\n                <% } %>\n                <div class="grade-bar-postfix">\n                    <%= row.nb %> (<%= row.percent %>%)\n                </div>\n            </div>\n            <% }) %>\n        </div>\n    </div>\n</div>\n'}),define("mobile/reports/drivesafety/views/DrivesafetyMapMatchingSumReportView",["jquery","underscore","./DrivesafetySumReportView","./constants","./utils","text!../tmpl/objectsTable.html","text!../tmpl/objectRowMapMatching.html","text!../tmpl/rowSummaryMapMatching.html","text!../tmpl/summaryMapMatching.html"],function(e,t,n,a,s,r,i,o,d){function l(e){return function(n){return'<a href="#" class="build-heatmap" title="" '+t.map(t.keys(e),function(t){return"data-"+t+'="'+e[t]+'"'}).join(" ")+">"+n+"</a>"}}function m(e,t){return l({mnemonic:"spd",range:e,mintime:t})}function c(e,t){return l({mnemonic:"acc",limit:e,mintime:t})}var u=n.prototype;r=t.template(r),i=t.template(i),o=t.template(o);var h={0:"#e64322",1:"#ff6f31",2:"#ff9f02",3:"#ffcf02",4:"#9ace6a",5:"#57bb8a"},p=n.extend({constructor:function(){this._clearHeatMap=null,this._heatMapCache={},n.apply(this,arguments)},reportClassName:u.reportClassName+" drivesafety-2020-report drivesafetysum-2020-report",tmplSummary:t.template(d),initialize:function(){var t=this,n=this.model;u.initialize.apply(this,arguments),this.$el.on("click",".build-heatmap",function(){var a=e(this).data(),s=JSON.stringify(a);
s in t._heatMapCache?t._handleHeatMapResponse(t._heatMapCache[s]):(showCursor(),n.fetchHeatMap(e(this).data()).done(function(e){t._heatMapCache[s]=e,t._handleHeatMapResponse(e)}).always(hideCursor))});var a=function(){t._clearHeatMap&&t._clearHeatMap()};this.listenTo(this.model,"remove",a),this.listenTo(App,"clearmap",a)},_handleHeatMapResponse:function(e){var t=e.body.data,n=s.calcHeatMapBounds(t);this._clearHeatMap&&this._clearHeatMap(),App.modules.maps.setBounds(n,{maxZoom:13,padding:[20,20]}),this._clearHeatMap=window._clearHeatMap=App.modules.maps.buildHeatMap(t)},getAvgScore:function(){var e=this.model.get("footer");return"scoreTotal"in e?e.scoreTotal:a.MAX_SCORE},getObjectSummary:function(e){var t=this.model.get("body");return e in t?t[e]:null},getBarValue:function(e){return Math._round(e.objectScore,1)},getBarColor:function(e){var t=this.getBarValue(e);return h[s.getGradeByScore(t)]},_filterDataForGrading:function(){for(var e,n=!1,a=this.model.get("objectId"),s=[],r=a.length;r--;)e=this.getObjectSummary(a[r]),e&&"objectScore"in e&&(n=!0,s.push(e));return this._objects=t.sortBy(s,function(e){return e.objectScore}),n},_renderSummary:function(){for(var n,r,i=this,o=this.model,d=this._objects,l=o.get("objectId").length,m=l-d.length,c=o.getTexts(),u=[],h=-1,p=this.getAvgScore(),f=a.MAX_SCORE;f>=0;--f)r=this._filterObjectsByScore(f),(r.length||f>0)&&(n=this.getPercent(r.length,l),h=Math.max(h,n),u.push({grade:f,nb:r.length,percent:n}));m>0&&(n=this.getPercent(m,l),h=Math.max(h,n),u.push({label:"&ndash;",grade:"",nb:m,percent:n})),t.each(u,function(e){e.barWidth=100*e.percent/h}),this.$summary=e(this.tmplSummary({i18n:c,avgScore:s.formatScore(p),avgGrade:s.getGradeByScore(p),rows:u})).appendTo(this.content),this.$summary.find(".grade-details [data-grade]").on("click",function(){var n=Number(e(this).data("grade"));if(!t.isNaN(n)){var a=i._filterObjectsByScore(n);a.length&&o.buildChildReport(t.pluck(a,"id"))}})},_getChartTitle:function(){return this.model.getTexts().drivesafety2020.objectsWithWorstScore},_renderTop:function(){u._renderTop.apply(this,arguments),this.$chart.jqChart("option","axes",[{type:"linear",maximum:a.MAX_SCORE,minimum:0}])},_filterObjectsByScore:function(e){return t.filter(this._objects,function(t){return t.objectScore>=e&&t.objectScore<e+1})},_prepareRowData:function(e){var n="objectScore"in e,a=t.extend({},e);if(n){var r=this.model,i="quantity"===r.get("useMileageOrQuantity"),o=i?"Count":"Dist",d=r.get("speedExcessLimits"),l=function(t){var n=t in e?e[t]:0;return i?n:this.formatDistance(n)}.bind(this);t.extend(a,{objectStyleScore:s.formatScore(e.objectStyleScore),styleGrade:s.getGradeByScore(e.objectStyleScore),objectSpeedScore:s.formatScore(e.objectSpeedScore),speedGrade:s.getGradeByScore(e.objectSpeedScore),objectScore:s.formatScore(e.objectScore),grade:s.getGradeByScore(e.objectScore),speeding:[],totalDistance:this.formatDistance(e.objectDistKm||0)});for(var m=1;m<=d.length;++m){var c="b"+m+o;a.speeding.push(l(c))}a.accViolations=e.accCount||0,a.brkViolations=e.brkCount||0}var u={summary:a};return u.properties=this.model.get("properties"),u.hasData=n,u},_shouldRenderList:function(){return this.model.get("showObjectsStatistics")},_renderList:function(){var n,d,l=this.model,u=l.getTexts(),h=u.drivesafety,p=l.get("objectId"),f=Math.abs(l.get("brakingLimit")),g=l.get("accelerationMintime"),v=l.get("accelerationLimit"),b=l.get("speedExcessUnits"),y=l.get("useMileageOrQuantity"),w=l.get("speedingMintime"),S=l.get("speedExcessLimits"),x=p.length,k=this._objects,D=[],_=[],T=h.objectsStatistics,j=l.get("properties"),M=this.mobileProps,C="",R=0,I=0,P=new Array(S.length).fill(0),F=0,A=0;if(k.length<x){var z;for(d=p.length;d--;)z=this.getObjectSummary(p[d]),!z||"objectScore"in z||D.push(z)}t.each(j,function(e){_.push(M[e])}),_.push(u.runDistance+", "+u.km);var O="quantity"===y;_=_.concat(s.getSpeedingHeaders(u,O,S,b)).concat(s.getStyleHeaders(u,v,f)),_.push(h.speedingGrade),_.push(h.drivingStyleGrade),_.push(h.overallGrade),t.each(k,function(e){n=this._prepareRowData(e),n.index=R,n.rowClass=++R%2?"odd":"even",C+=i(n),I+=Number(n.summary.totalDistance),P=t.map(P,function(e,t){return e+Number(n.summary.speeding[t])}),F+=Number(n.summary.accViolations),A+=Number(n.summary.brkViolations)}.bind(this)),D.length&&t.each(D,function(e){n=this._prepareRowData(e),n.index=R,n.rowClass=++R%2?"odd":"even",C+=i(n)}.bind(this));var L=function(e,t){var n=O?e:this.formatDistance(e);return e>0?m(t,w)(n):n}.bind(this),E=l.get("footer"),V="speedScoreTotal"in E?E.speedScoreTotal:a.MAX_SCORE,U="styleScoreTotal"in E?E.styleScoreTotal:a.MAX_SCORE;C+=o({i18n:u,colspan:j.length,values:[this.formatDistance(I)].concat(t.map(P,L)).concat([F>0?c(v,g)(F):"0",A>0?c(-f,g)(A):"0"]),scores:[{value:s.formatScore(V),grade:s.getGradeByScore(V)},{value:s.formatScore(U),grade:s.getGradeByScore(U)},{value:s.formatScore(this.getAvgScore()),grade:s.getGradeByScore(this.getAvgScore())}]}),this.$list=e(r({header:T,names:_,html:C})).appendTo(this.content),this._initObjectStatisticsRows()},_renderLegend:function(){}});return p}),define("mobile/reports/drivesafety/DrivesafetyMapMatchingReport",["jquery","jface","_common/reports/Report","_common/reports/ReportsMixin","./DrivesafetyLegacyReport","./views/DrivesafetyMapMatchingReportView","./views/DrivesafetyMapMatchingSumReportView"],function(e,t,n,a,s,r,i){var o=a.getDrivesafetyMapMatchingDefaultParameters(),d=s.extend({constructor:function(){s.apply(this,arguments)},url:function(){var e=this.isSummary()?"DRIVESAFETYSUM":"DRIVESAFETY";return App.getBaseUrl()+"reports/"+e+"/"},defaultParameters:o,defaults:_.extend({},s.prototype.defaults,o),ViewClassSum:i,ViewClassSingle:r,_processSpeedLimitParameters:function(e){function t(t,n){var a=e[t];return _.map(a,function(e,t){var a=Number(e);return isNaN(a)?n[t]:a})}var n=e.speedExcessUnits,a=o.speedExcessLimits[n],s=o.speedExcessWeights,r=e.useMileageOrQuantity,i=t("speedExcessLimits",a),d=t("speedExcessWeights",s);this.set({speedExcessLimits:i,speedExcessWeights:d});var l=Object.assign({},o.speedExcessLimits,this.getUserData("speedExcessLimits"));l[n]=i,this.setUserData("zoneId",this.get("zoneId")),this.setUserData("speedExcessUnits",n),this.setUserData("speedExcessLimits",l),this.setUserData("speedExcessWeights",d),this.setUserData("useMileageOrQuantity",r)},_processParameters:function(e){var t,n,a=!1;if(this.has("source")&&(a=!0,n=this.get("module").items.get(this.get("source"))),this._processSpeedLimitParameters(e),this._processAccelerationParameters(e),this.isSummary()){var s=!1;_.each(["showSummary","showTop","showObjectsStatistics"],function(r){a?(s=!0,this.set(r,n.get(r))):(t=r in e,s=s||t,this.set(r,t),this.setUserData(r,t))}.bind(this)),s||(this.set("showSummary",!0),!a&&this.setUserData("showSummary",!0))}else _.each(["showStatistics","showCalculation"],function(n){t=n in e,this.set(n,t),!a&&this.setUserData(n,t)}.bind(this))},getPostParams:function(){var e=this,t=n.prototype.getPostParams.call(this),a=this.isSummary();return t.properties=this.get("properties"),_.each(["accelerationLimit","accelerationMintime","accelerationWeight","brakingLimit","brakingWeight","speedingMintime","showSummary"],function(n){t[n]=e.get(n)}),t.speedLimits=this.get("speedExcessLimits"),t.speedWeights=this.get("speedExcessWeights"),t.isPercents="percentage"===this.get("speedExcessUnits"),t.useCount="quantity"===this.get("useMileageOrQuantity"),t.zoneId=this.get("zoneId"),t.zoneId||0===t.zoneId||"0"===t.zoneId||delete t.zoneId,a?(t.showTop=this.get("showTop"),t.showStatistics=this.get("showObjectsStatistics")):(t.showStatistics=this.get("showStatistics"),t.showCalculation=this.get("showCalculation")),t},fetchHeatMap:function(t){var a=t.mnemonic,s=Number(t.mintime),r=n.prototype.getPostParams.call(this);if(r.heatMapParam=a,"spd"===a){var i=Number(t.range),o=this.get("speedExcessLimits");r.isPercents="percentage"===this.get("speedExcessUnits"),r.speedingMintime=s,r.speedLimits=[o[i],i>=o.length-1?5e4:o[i+1]]}else"acc"===a&&(r.accelerationLimit=Number(t.limit),r.accelerationMintime=s);return r.zoneId=this.get("zoneId"),r.zoneId||0===r.zoneId||"0"===r.zoneId||delete r.zoneId,e.ajax({url:App.getBaseUrl()+"reports/DRIVESAFETYHM/",data:r})}});return d}),define("mobile/reports/acceleration/AccelerationReport",["_common/reports/Report","_common/tracks/TracksModule","mobile/reports/acceleration/views/AccelerationReportView","mobile/reports/drivesafety/DrivesafetyMapMatchingReport"],function(e,t,n,a){var s=e.extend({url:App.getBaseUrl()+"reports/ACCELERATION/",constructor:function(){this.addressesLoaded=!1,e.apply(this,arguments)},initialize:function(){var s=null;if(this.makeTracksModule(t),e.prototype.initialize.call(this,n),this.has("source")&&(s=this.get("module").items.get(this.get("source"))),s)s instanceof a&&this.set({properties:s.get("properties"),mintime:s.get("accelerationMintime"),showDetails:!0,showCorners:!1,b1:s.get("accelerationLimit"),b2:s.get("brakingLimit"),zoneId:s.get("zoneId"),filterViolations:!0});else{this._prepareDeviceProperties();var r=this.get("mintime");0>=r&&this.set("mintime",3),this.setUserData("showDetails",this.get("showDetails")?1:0),this.setUserData("showCorners",this.get("showCorners")?1:0),this.setUserData("showBraking",this.get("showBraking")?1:0),this.setUserData("showAccel",this.get("showAccel")?1:0),this.setUserData("b1",this.get("b1")),this.setUserData("b2",this.get("b2")),this.setUserData("zoneId",this.get("zoneId")),this.setUserData("mintime",this.get("mintime"))}},getPostParams:function(){var t=e.prototype.getPostParams.call(this);return t.properties=this.get("properties"),this.get("showAccel")||(t.hideAccel=1),this.get("showBraking")||(t.hideBraking=1),this.get("filterViolations")?t.hideBraking?t.b1=this.get("b1"):t.b2=this.get("b2"):(t.b1=this.get("b1"),t.b2=this.get("b2")),t.mintime=this.get("mintime"),this.get("showCorners")||(t.hideCorners=1),this.get("showDetails")||(t.hideDetails=1),t.zoneId=this.get("zoneId"),t.zoneId||0===t.zoneId||"0"===t.zoneId||delete t.zoneId,t}});return s}),define("text!mobile/reports/accesscard/tmpl/thead.html",[],function(){return'<tr data-head="1">\n    <% _.each(fields, function(key) {%>\n    <th data-key="<%= key %>"><%= text[key] %></th>\n    <% }) %>\n</tr>'}),define("text!mobile/reports/accesscard/tmpl/row.html",[],function(){return'<tr class="">\n\n    <% _.each(fields, function(key) {%>\n    <% if(key == \'address\') { %>\n    <td class="address text-left" data-key="address" data-geoid="<%= data.geoId %>" data-lat="<%= data.lat %>"\n        data-lon="<%= data.lon %>">\n        <a href="javascript:;" class="put-marker" data-id="<%= data.geoId %>">\n            <% if(data.address) {%>\n            <span class="address" data-geoid="<%= data.geoId %>"><%= data.address %></span>\n            <% } else { %>\n            <span class="loading-address" data-geoid="<%= data.geoId %>">\n                        <%= i18n.addressNotFound %> [<%= data.lat %>,<%= data.lon %>]\n                    </span>\n            <% } %>\n        </a>\n    </td>\n\n    <% } else { %>\n    <td\n            data-key="<%= key %>"\n            data-value="<%= data[key] %>"\n    >\n        <%= data[key] %>\n    </td>\n\n    <% } %>\n    <% }) %>\n</tr>'}),define("mobile/reports/accesscard/AccesscardReportView",["jquery","underscore","moment","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/accesscard/tmpl/thead.html","text!mobile/reports/accesscard/tmpl/row.html","text!_common/reports/tmpl/pins.svg"],function(e,t,n,a,s,r,i,o){r=t.template(r),i=t.template(i),o=t.template(o);var d=a.extend({constructor:function(){a.apply(this,arguments)},initialize:function(){a.prototype.initialize.apply(this,arguments)},render:function(){var n=new e.Deferred;a.prototype.render.apply(this,arguments),this.$el.addClass("accesscard-report"),this.buildMetaInfo(),this.content.append(t.template(s,{key:this.model.get("key"),theadHtml:""}));var r=this.content.find("tbody"),i=l.buildRows.call(this);return r.append(i),this._initMarkersLinks(this.putAccesscardMarker),n.resolve(),n},putAccesscardMarker:function(e){if(e&&e.lat&&e.lon){var t=this.putMarkers([e],{icon:new L.PinIcon({html:o({type:"accesscard"}),addClassName:"accesscard-marker"}),popup:{type:"accesscard",className:"track-info fuel-change-info accesscard-popup",wraperClassName:"accesscard-popup-wraper",offset:[0,-25]},zoom:!0});return t}}}),l={getFields:function(e){var t=e.model,n=t.get("properties");return t?(n.push("date"),n.push("idCard"),t.get("showAddress")&&n.push("address"),n):n},getText:function(e){var t=e.i18n,n={extId:t.objIdNumber,name:t.objName,groups:t.objGroup,carId:t.licenseNumber,model:t.objModel,type:t.vehicleType,vin:t.objVin,year:t.objYear,date:t.accesscardReport.date,idCard:t.accesscardReport.idCard,address:t.accesscardReport.address};return n},getRowData:function(e){var t=e.item,n=e.objs,a=e.text,s=Object.assign({},n[t.objectId],t);return s.date=t.ts?l.formatTime(t.ts):"",s.idCard=t.card||"",s.text=a,s},formatTime:function(e){return n.unix(e).format("DD.MM.YYYY HH:mm:ss")},buildRows:function(){var e=this,n=this.model.get("body"),a="",s=this.model.getTexts(),o=[],d=this.model.get("showAddress"),m=l.getFields({model:this.model}),c=l.getText({i18n:s});return a+=r({fields:m,text:c}),t.each(n.data,t.bind(function(t){var r=l.getRowData({item:t,objs:n,text:c});d&&!t.address&&o.push(t),e._markerData[t.geoId]=r,a+=i({fields:m,data:r,i18n:s})},this)),o.length&&this.listenTo(this.model,"afterrender",function(){e.model.searchAddresses(o)}),a}};return d}),define("mobile/reports/accesscard/AccesscardReport",["underscore","_common/reports/Report","mobile/reports/accesscard/AccesscardReportView","_common/tracks/TracksModule"],function(e,t,n,a){var s=t.extend({constructor:function(){this.addressesLoaded=!1,t.apply(this,arguments)},url:App.getBaseUrl()+"reports/ACCESSCARD/",defaults:e.extend({},t.prototype.defaults,{properties:["extId","name"],showAddress:!0}),initialize:function(s){this.makeTracksModule(a),t.prototype.initialize.call(this,n);var r=s.properties||["extId","name"];this.set({showAddress:!!s.showAddress&&1==s.showAddress,properties:e.without(r,"fake")}),this._storeUserData()},getPostParams:function(){var e=t.prototype.getPostParams.call(this);return e.showAddress=this.get("showAddress"),e.properties=this.get("properties"),e},_storeUserData:function(){this.setUserData("showAddress",this.get("showAddress")),this.setUserData("properties",this.get("properties"))}});return s}),define("text!mobile/reports/device/tmpl/thead.html",[],function(){return'<tr data-head="<%= headIndex %>">\n    <th data-key="date"><%= i18n.deviceReport.date %></th>\n    <th data-key="time"><%= i18n.deviceReport.time %></th>\n    <th data-key="event"><%= i18n.deviceReport.event %></th>\n    <th data-key="dur"><%= i18n.deviceReport.eventDuration %></th>\n    <th data-key="dist"><%= i18n.deviceReport.run %>, <%= i18n.km %></th>\n    <th data-key="place"><%= i18n.place %></th>\n</tr>'}),define("text!mobile/reports/device/tmpl/headers.html",[],function(){return'<tr class="<%= rowClass %>"<% if(type == \'overallData\') { %> data-row="last"<% } %>>\n\n    <% if(type == \'state1\') { %>\n    <td colspan="6" class="text-left"><%= i18n.deviceReport.deviceStatus %> <%= i18n.deviceReport.beforePeriod %></td>\n    <% } %>\n\n    <% if(type == \'state2\') { %>\n    <td colspan="6" class="text-left"><%= i18n.deviceReport.deviceStatus %> <%= i18n.deviceReport.atthePeriod %></td>\n    <% } %>\n\n    <% if(type == \'state3\') { %>\n    <td colspan="6" class="text-left"><%= i18n.deviceReport.deviceStatus %> <%= i18n.deviceReport.endPeriod %></td>\n    <% } %>\n\n    <% if(type == \'nodata\') { %>\n    <td colspan="6" class="text-left"><%= i18n.deviceReport.noData %></td>\n    <% } %>\n\n    <% if(type == \'overallData\') { %>\n    <td colspan="6" class="text-left"><%= i18n.summaryData %></td>\n    <% } %>\n\n    <% if(type == \'summaryNoData\') { %>\n    <td colspan="7" class="text-left"><%= i18n.deviceReport.noData %></td>\n    <% } %>\n\n    <% if(type == \'minDelay\') { %>\n    <td colspan="6" class="text-left"><%= i18n.deviceReport.minDelay %> <%= time %></td>\n    <% } %>\n\n</tr>'}),define("text!mobile/reports/device/tmpl/title.html",[],function(){return'<tr class="obj">\n    <td colspan="6">\n        <strong><%= i18n.object.ucFirst() %> #<%= obj.extId %> [<%= obj.name %>]</strong>\n        <a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n    </td>\n</tr>\n'}),define("text!mobile/reports/device/tmpl/summaryhead.html",[],function(){return'<% if(type == 0) { %>\n<tr>\n    <td colspan="6" style="padding: 0;">\n        <table cellpadding="0" cellspacing="0" style="width: 100%">\n            <thead>\n                <tr>\n                    <th data-key="sensor"><%= i18n.deviceReport.sensor %></th>\n                    <th data-key="periodOn"><%= i18n.deviceReport.switchedon %></th>\n                    <th data-key="periodOff"><%= i18n.deviceReport.switchedoff %></th>\n                    <th data-key="distanceOn"><%= i18n.deviceReport.runswitchedon %>, <%= i18n.km %></th>\n                    <th data-key="distanceOff"><%= i18n.deviceReport.runswitchedoff %>, <%= i18n.km %></th>\n                    <th data-key="countOn"><%= i18n.deviceReport.inclusions %></th>\n                    <th data-key="countOff"><%= i18n.deviceReport.shutdowns %></th>\n                </tr>\n            </thead>\n            <tbody>\n<% } else { %>\n            </tbody>\n        </table>\n    </td>\n</tr>\n<% } %>\n'}),define("text!mobile/reports/device/tmpl/row.html",[],function(){return'<tr class="<%= rowClass %>">\n    <% if(type == 0) { %>\n    <td data-key="date"><%= date %></td>\n    <td data-key="time"><%= time %></td>\n    <td data-key="event"><%= event %></td>\n    <td data-key="duration" data-value="<%= dur %>"><%= eventDuration %></td>\n    <td data-key="dist" data-value="<%= dist %>"><%= distS %></td>\n    <td class="address text-left" data-key="address" data-geoid="<%= geoId %>" data-lat="<%= lat %>" data-lon="<%= lon %>">\n        <a href="javascript:;" class="build-track-segment" data-id="<%= objectId %>" data-from="<%= begin*1000 %>" data-to="<%= end*1000 %>">\n            <% if(address) {print(address)} else { %>\n            <span class="loading-address" data-geoid="<%= geoId %>"><%= i18n.loadingAddress %></span>\n            <% } %>\n        </a>\n    </td>\n    <% } else { %>\n    <td data-key="sensor"><%= sensor %></td>\n    <td data-key="periodOn" data-value="<%= periodOn %>"><%= periodOnS %></td>\n    <td data-key="periodOff" data-value="<%= periodOff %>"><%= periodOffS %></td>\n    <td data-key="distanceOn" data-value="<%= distanceOn %>"><%= distanceOnS %></td>\n    <td data-key="distanceOff" data-value="<%= distanceOff %>"><%= distanceOffS %></td>\n    <td data-key="countOn" data-value="<%= countOn %>"><%= countOn %></td>\n    <td data-key="countOff" data-value="<%= countOff %>"><%= countOff %></td>\n    <% } %>\n</tr>'}),define("mobile/reports/device/views/DeviceReportView",["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/device/tmpl/thead.html","text!mobile/reports/device/tmpl/headers.html","text!mobile/reports/device/tmpl/title.html","text!mobile/reports/device/tmpl/summaryhead.html","text!mobile/reports/device/tmpl/row.html"],function(e,t,n,a,s,r,i,o,d){s=t.template(s),o=t.template(o),r=t.template(r),i=t.template(i),d=t.template(d);var l=n.extend({FIX_HEADER:1,constructor:function(){n.apply(this,arguments)},initialize:function(){n.prototype.initialize.apply(this,arguments)},render:function(){var s=new e.Deferred;n.prototype.render.apply(this,arguments),this.$el.addClass("device-report"),this.buildMetaInfo(),this.content.append(t.template(a,{key:this.model.get("key"),theadHtml:""}));var r=this.content.find("tbody"),i=m.buildRows.call(this);return r.append(i),s.resolve(),s}}),m={buildRows:function(){var e=this,n=this.model.get("body"),a="",l=this.model.getTexts(),m=[],c=0;return t.each(n,t.bind(function(n){var u=([n.report.init,n.report.history,n.report["final"]],n.report.history),h=n.report.summary,p={};t.each(n.devices,t.bind(function(e){e.devNo<7?(e.name=e.name?e.name:l.discretSensor+" "+e.devNo,e.off=e.off?e.off:'"'+e.name+'" '+l.deviceReport.switchedoff.toLowerCase(),e.on=e.on?e.on:'"'+e.name+'" '+l.deviceReport.switchedon.toLowerCase()):(e.name=l.deviceReport.emergencyPower,e.off=l.deviceReport.mainPower,e.on=l.deviceReport.emergencyPower),p[e.devNo]=e},this)),a+=i({extId:n.extId,name:n.name,i18n:l}),a+=s({i18n:l,headIndex:++c});var f=1;if(a+=r({i18n:l,type:"state"+(f+1),rowClass:"device-status-title"}),u.length>0){var g="";t.each(u,t.bind(function(t,s){!t.address&&m.push(t),g=t.devNo>0?p[t.devNo][t.state?"on":"off"]:t.state?l.deviceReport.allSwitchedOn:l.deviceReport.allSwitchedOff,a+=d({i18n:l,rowClass:"device-row"+(f%2?s%2?"":"2":""),objectId:n.objectId,lat:t.lat,lon:t.lon,geoId:t.geoId,begin:t.sts,end:t.ets,type:0,date:e.formatDate(t.sts),time:e.formatTime(t.sts),event:g,dur:t.dur,eventDuration:Date.formatSeconds(t.dur),dist:t.dist,distS:Math._round(t.dist,2),address:t.address})},this))}else a+=r({i18n:l,type:"nodata",rowClass:"device-nodata"});a+=r({i18n:l,type:"overallData",rowClass:"device-summary"}),a+=o({i18n:l,type:0}),h.length?t.each(h,t.bind(function(e){a+=d({i18n:l,rowClass:"device-row",type:1,sensor:e.devNo>0?p[e.devNo].name:l.deviceReport.allSensors,periodOn:e.periodOn,periodOnS:Date.formatSeconds(e.periodOn),periodOff:e.periodOff,periodOffS:Date.formatSeconds(e.periodOff),distanceOn:e.distanceOn,distanceOnS:Math._round(e.distanceOn,2),distanceOff:e.distanceOff,distanceOffS:Math._round(e.distanceOff,2),countOn:e.countOn,countOff:e.countOff})},this)):a+=r({i18n:l,type:"summaryNoData",rowClass:"device-summary"}),a+=o({i18n:l,type:1})},this)),a+=r({i18n:l,type:"minDelay",rowClass:"device-summary",time:Date.formatSeconds(this.model.get("dur"),!0)}),m.length&&this.listenTo(this.model,"afterrender",function(){e.model.searchAddresses(m)}),a},buildSummaryTable:function(){}};return l}),define("mobile/reports/device/DeviceReport",["underscore","_common/reports/Report","mobile/reports/device/views/DeviceReportView","_common/tracks/TracksModule"],function(e,t,n,a){var s=t.extend({url:App.getBaseUrl()+"reports/DEVICE/",constructor:function(){this.addressesLoaded=!1,"undefined"==typeof this._sensorsNumber&&(this._sensorsNumber=7),t.apply(this,arguments)},initialize:function(){this.makeTracksModule(a),t.prototype.initialize.call(this,n),this._normalizeParams(),this._storeUserData()},getPostParams:function(){var e=t.prototype.getPostParams.call(this);return e.dur=this.get("dur"),e.simul=this.get("simul"),e.dev=parseInt(this._getChecked.call(this).reverse().join(""),2),e},_normalizeParams:function(){this.set("dur",Math.min(86400,Math.max(this.get("dur"),1)))},_getChecked:function(){for(var e=new Array(this._sensorsNumber),t="",n=0;n<this._sensorsNumber;n++)t="dev"+(n+1),e[n]=this.has(t)?parseInt(this.get(t)):0;return e},_storeUserData:function(){this.setUserData("dur",this.get("dur")),this.setUserData("simul",this.get("simul"));var t=this._getChecked.call(this);this.setUserData("checked",e.initial(t)),this.setUserData("powerChecked",e.last(t))}});return s}),define("text!mobile/reports/device2/tmpl/summary.html",[],function(){return'<% if(showSensorsSummary && ( sensors.length || power )) {%>\n<div class="summary">\n    <h3><%= i18n.sumOfObjectsWork %></h3>\n    <div class="sum-content">\n        <table>\n            <% _.each(sensors, function(d) {%>\n            <tr>\n                <td><%- d.name %></td>\n                <td class="value" data-value="<%= d.time %>"><%= Date.formatSeconds(d.time) %></td>\n            </tr>\n            <% }) %>\n            <% if(power) {%>\n            <tr>\n                <td><%= power.name %></td>\n                <td class="value" data-value="<%= power.time %>"><%= Date.formatSeconds(power.time) %></td>\n            </tr>\n            <% } %>\n        </table>\n    </div>\n</div>\n<% } %>\n\n<div class="summary">\n    <h3><%= i18n.sumOfObjectsMovesParks %></h3>\n        <div class="sum-content">\n        <table>\n            <tr>\n                <td><%= i18n.moveTime %></td>\n                <td data-key="totalMoveTime" data-value="<%= totalMoveTime %>" class="value"><%= totalMoveTimeS %></td>\n            </tr><tr>\n                <td><%= i18n.parkTime %></td>\n                <td data-key="totalParkTime" data-value="<%= totalParkTime %>" class="value"><%= totalParkTimeS %></td>\n            </tr><tr>\n                <td><%= i18n.totalDistance %>, <%= i18n.km %></td>\n                <td data-key="totalDist" data-value="<%= totalDist %>" class="value"><%= Math._round(totalDist,2) %></td>\n            </tr>\n        </table>\n    </div>\n</div>'}),define("text!mobile/reports/device2/tmpl/thead.html",[],function(){return'<tr data-head="1">\n    <th><%= i18n.objIdNumber %></th>\n    <th><%= i18n.objName %></th>\n    <% _.each(sensors, function(d){ %>\n        <th><%= d.name %></th>\n    <% }) %>\n    <% if(power){ %>\n        <th><%= power.name %></th>\n    <% } %>\n    <th><%= i18n.runDistance %>, <%= i18n.km %></th>\n    <th><%= i18n.moveStart %></th>\n    <th><%= i18n.moveEnd %></th>\n    <th><%= i18n.moveTime %></th>\n    <th><%= i18n.parkTime %></th>\n</tr>'}),define("text!mobile/reports/device2/tmpl/row.html",[],function(){return'<tr<% if(last) {%> data-row="last"<% } %>>\n    <td data-key="extId"><%= extId %></td>\n    <td data-key="name" class="text-left"><%= name %></td>\n\n    <% if(!sensorsTime && !powerTime) {%>\n        <td class="no-data" colspan="<%= totalSensors %>"><%= i18n.noData %></td>\n    <% } else {%>\n        <% _.each(sensorsTime, function(time) {%>\n            <td data-value="<%= time %>"><%= Date.formatSeconds(time) %></td>\n        <% }) %>\n        <% if(powerTime !== null) {%>\n            <td data-value="<%= powerTime %>"><%= Date.formatSeconds(powerTime) %></td>\n        <% } %>\n    <% } %>\n\n    <td data-key="distance" data-value="<%= distance %>"><%= Math._round(distance,2) %></td>\n    <td data-key="moveStart" data-value="<%= moveStart %>"><%= moveStartS %></td>\n    <td data-key="moveEnd" data-value="<%= moveEnd %>"><%= moveEndS %></td>\n    <td data-key="moveTime" data-value="<%= moveTime %>"><%= Date.formatSeconds(moveTime) %></td>\n    <td data-key="parkTime" data-value="<%= parkTime %>"><%= Date.formatSeconds(parkTime) %></td>\n</tr>'}),define("mobile/reports/device2/views/Device2ReportView",["jquery","underscore","util","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!../tmpl/summary.html","text!../tmpl/thead.html","text!../tmpl/row.html"],function(e,t,n,a,s,r,i,o){r=t.template(r),i=t.template(i);var d=a.extend({constructor:function(){this.sensors=[],this.power=null,this.showSensorsSummary=!0,this.tbody=null,this._powerIndex=7,a.apply(this,arguments)},_tmplRow:t.template(o),render:function(){var n=new e.Deferred,r=this.model.getTexts();if(a.prototype.render.apply(this,arguments),this.$el.addClass("report-wide device-report device2-report"),this.buildMetaInfo(),this._setSensorsSummary(),this._powerIndex&&this._setPowerSummary(),this.content.append(this._buildSummary()),this.content.append(t.template(s,{key:this.model.get("key"),theadHtml:""})),this.tbody=this.content.find(".rep-table tbody"),this._renderTableHead(),this.tbody.append(this._buildRows()),this.sensors.length>1){var i=this.$el.find(".box-content"),o=this.$el.find(".fixed-header");this.$el.addClass("rep-wide"),this.tbody.width()<i.width()?this.$el.find(".rep-table").width("99.9%"):(o.prependTo(i),o[0].style.margin="0px",i.on("scroll",function(){o[0].style.top=i[0].scrollTop+"px"}))}return this.content.append('<p style="font-size:11px; margin:5px 0 0 5px">'+r.deviceReport.minDelay+" "+Date.formatSeconds(this.model.get("dur"),!0)+"</p>"),n.resolve(),n},_setSensorsSummary:function(){var e=this.model.get("footer");if(e){var n,a=t.indexBy(e.devices||[],"devNo"),s=this.model.getTexts(),r="";for(n=1;6>=n;++n)this.model.has("dev"+n)&&(r=a[n].devName||s.discretSensor+" "+n,this.sensors.push({name:r,time:a[n].periodOn,index:n}))}},_setPowerSummary:function(){var e=this.model.get("footer");if(e){var n=t.indexBy(e.devices||[],"devNo"),a=this.model.getTexts();this.model.has("dev7")&&"undefined"!=typeof n[7]&&(this.power={name:a.deviceReport.emergencyPower,time:n[7].periodOn,index:7})}},_renderTableHead:function(){this.model.has("body")&&this.tbody.append(i({sensors:this.sensors,power:this.power,i18n:this.model.getTexts()}))},_buildRows:function(){var e=this,n=this._tmplRow,a=this.model.get("body"),s="",r=this.model.getTexts(),i={},o=a&&a.length,d=0,l=0;return d=t.keys(this.sensors).length+(this.power?1:0),a&&t.each(a,t.bind(function(a){i={i18n:r,objectId:a.id};var m=t.indexBy(a.report.summary,"devNo");t.each(["extId","name","distance","moveStart","moveEnd","moveTime","parkTime"],function(e){i[e]=a[e]}),i.sensorsTime=this._getDeviceSensorsTime(m,a),i.powerTime=e.power?m[7].periodOn:null,i.totalSensors=d,t.each(["moveStart","moveEnd"],function(t){i[t+"S"]=a[t]?e.formatDateTime(a[t]):"-"}),i.last=++l==o,s+=n(i)},this)),s},_getDeviceSensorsTime:function(e){for(var t=this.sensors.length,n=new Array(t);t--;)n[t]=e[this.sensors[t].index].periodOn;return n},_buildSummary:function(){var e=this.model.getTexts(),t=this.model.get("footer");return t?r({sensors:this.sensors,power:this.power,showSensorsSummary:this.showSensorsSummary,totalMoveTime:t.totalMoveTime,totalMoveTimeS:Date.formatSeconds(t.totalMoveTime),totalParkTime:t.totalParkTime,totalParkTimeS:Date.formatSeconds(t.totalParkTime),totalDist:t.totalDist,i18n:e}):""}});return d}),define("mobile/reports/device2/Device2Report",["underscore","_common/reports/Report","mobile/reports/device/DeviceReport","mobile/reports/device2/views/Device2ReportView"],function(e,t,n,a){var s=n.extend({url:App.getBaseUrl()+"reports/DEVICERUN/",constructor:function(){n.apply(this,arguments)},initialize:function(){t.prototype.initialize.call(this,a),this._normalizeParams(),this._storeUserData()}});return s}),define("mobile/reports/drivesafety/DrivesafetyReport",["./DrivesafetyLegacyReport","./DrivesafetyMapMatchingReport","./views/DrivesafetyReportView","./views/DrivesafetySumReportView","./views/DrivesafetyMapMatchingReportView","./views/DrivesafetyMapMatchingSumReportView"],function(e,t){return App.isMapMatchingAllowed()?t:e}),define("text!_common/reports/tmpl/chart.html",[],function(){return"<div class=\"rep-chart clearfix<% if('undefined' != typeof addClass){ print(' ' + addClass) }%>\"\n<% if('undefined' != typeof data) { _.each(data, function(value, key){ print('data-' + key+'=\"' + value + '\"') })}%>>\n    <div class=\"chart-header clearfix\">\n        <% if(title) {%>\n        <h4><%= title %></h4>\n        <% } %>\n        <div class=\"chart-actions\">\n            <a href=\"javascript:;\" class=\"chart-switcher\">\n                <span class=\"s\"><%= showTxt %></span><span class=\"h\"><%= hideTxt %></span>\n            </a>\n        </div>\n    </div>\n    <div<% if('undefined' != typeof id){ print(' id=\"'+ id + '\"') }%> class=\"chart-content\"></div>\n    <% if('undefined' != typeof footer){ print(footer) }%>\n</div>"}),define("text!mobile/reports/flow/tmpl/rowObject.html",[],function(){return'<tr class="obj">\n    <td colspan="<%= colspan %>" class="summary">\n        <div class="sum-header">\n            <a href="javascript:;" title="<%= i18n.build.ucFirst() + \' \' + i18n.reportsNames.movepark %>" class="build-another" data-type="movepark"\n               data-id="<%= id %>" data-from="<%= periodStart %>" data-to="<%= periodEnd %>">\n                <strong><%- name %> (#<%- extId %>)</strong>\n            </a>\n            <% if(hasData) { %>\n            <a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n            <% } %>\n        </div>\n        <div class="sum-content">\n            <% if(hasData) {%>\n            <table>\n                <tbody>\n                <tr>\n                    <td><%= i18n.fillingsNumber %></td>\n                    <td class="value"><%= fillingsNumber %></td>\n                </tr><tr>\n                    <td><%= i18n.fillingsVolume %></td>\n                    <td class="value"><%= fillingsVolume %></td>\n                </tr><tr>\n                    <td><%= i18n.dischargesNumber %></td>\n                    <td class="value"><%= dischargesNumber %></td>\n                </tr><tr>\n                    <td><%= i18n.dischargesVolume %></td>\n                    <td class="value"><%= dischargesVolume %></td></tr><tr>\n                </tr>\n                </tbody>\n            </table>\n            <% } else {%>\n            <p class="no-data"><%= i18n.noDataForObject %></p>\n            <% } %>\n        </div>\n    </td>\n</tr>'
}),define("text!mobile/reports/flow/tmpl/row.html",[],function(){return'<tr data-index=<%= rowIndex %> class="<%= rowClass %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <td data-key="name" class="text-left">\n        <% if(App.reportAllowedByType(\'MOVEPARK\')) {%>\n        <a href="javascript:;" title="<%= buildMovePark %>" class="build-another" data-type="movepark"\n           data-id="<%= id %>" data-from="<%= dayStart %>" data-to="<%= dayEnd %>">\n            <%- name %> (#<%- extId %>)\n        </a>\n        <% } else { %>\n        <%- name %> (#<%- extId %>)\n        <% } %>\n    </td>\n    <td data-key="distance"><%= distanceS %></td>\n    <td data-key="moveStart" data-value="<%= moveStart %>"><%= moveStartS %></td>\n    <td data-key="moveEnd" data-value="<%= moveEnd %>"><%= moveEndS %></td>\n    <td data-key="moveTime" data-value="<%= moveTime %>" class="text-left"><%= moveTimeS %></td>\n    <td data-key="parkTime" data-value="<%= parkTime %>" class="text-left"><%= parkTimeS %></td>\n    <td data-key="avgSpeed" data-value="<%= avgSpeed %>"><%= avgSpeedS %></td>\n    <td data-key="consum100km" data-value="<%= consum100km %>"><%= consum100kmS %></td>\n    <td data-key="fuelConsum" data-value="<%= fuelConsum %>"><%= fuelConsumS %></td>\n</tr>'}),define("text!mobile/reports/flow/tmpl/rowNoObjectData.html",[],function(){return'<tr data-index=<%= rowIndex %> class="<%= rowClass %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n<td data-key="name" class="text-left">\n    <%- name %> (#<%- extId %>)\n</td>\n<td colspan="8" class="no-data text-left"><%= i18n.noDataForObject %></td>\n</tr>'}),define("text!_common/reports/tmpl/noDataRow.html",[],function(){return'<tr<% if (\'undefined\' != typeof rowPosition){ %> data-row="<%= rowPosition %>"\n<% } else if(\'undefined\' != typeof isLast && isLast) {%> data-row="last"<% } %>>\n    <td class="text-left no-data"<%if(!_.isUndefined(colspan)) {%> colspan="<%= colspan %>"<% } %>><%- text %></td>\n</tr>'}),define("text!mobile/reports/flow/tmpl/summaryLine.html",[],function(){return'<tr>\n    <th colspan="<%= colspan %>" class="text-left"><%= i18n.summaryData %></th>\n</tr>'}),define("text!mobile/reports/flow/tmpl/summaryRow.html",[],function(){return'<tr class="<%= rowClass %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <td data-key="name" class="text-left"><%- name %> <% if(typeof extId != \'undefined\') { %>(#<%- extId %>)<% } %></td>\n    <td data-key="distance" data-value="<%= distance %>"><%= distance.toFixed(2) %></td>\n    <td data-key="moveStart" data-value="<%= moveStart %>"><%= moveStartS %></td>\n    <td data-key="moveEnd" data-value="<%= moveEnd %>"><%= moveEndS %></td>\n    <td data-key="moveTime" data-value="<%= moveTime %>" class="text-left"><%= Date.formatSeconds(moveTime) %></td>\n    <td data-key="parkTime" data-value="<%= parkTime %>" class="text-left"><%= Date.formatSeconds(parkTime) %></td>\n    <td data-key="avgSpeed" data-value="<%= avgSpeed %>"><%= avgSpeed.toFixed(2) %></td>\n    <td data-key="consum100km" data-value="<%= consum100km %>"><%= consum100kmS %></td>\n    <td data-key="realConsum" data-value="<%= fuelConsum %>"><%= fuelConsumS %></td>\n</tr>'}),define("mobile/reports/flow/views/FlowReportView",["jquery","underscore","_libs/charts/Chart","_common/reports/views/ReportView","text!_common/reports/tmpl/chart.html","text!_common/reports/tmpl/reportTable.html","text!_common/reports/tmpl/day.html","text!mobile/reports/flow/tmpl/rowObject.html","text!mobile/reports/flow/tmpl/row.html","text!mobile/reports/flow/tmpl/rowNoObjectData.html","text!_common/reports/tmpl/noDataRow.html","text!mobile/reports/flow/tmpl/summaryLine.html","text!mobile/reports/flow/tmpl/summaryRow.html"],function(e,t,n,a,s,r,i,o,d,l,m,c,u){s=t.template(s),d=t.template(d),i=t.template(i),o=t.template(o),l=t.template(l),m=t.template(m),u=t.template(u),c=t.template(c);var h=null,p=null,f=null,g=a.extend({FIX_HEADER:1,constructor:function(){a.apply(this,arguments)},initialize:function(){a.prototype.initialize.apply(this,arguments)},render:function(){var n=this,s=new e.Deferred;a.prototype.render.apply(this,arguments),this.$el.addClass("flow-report"),this.buildMetaInfo();var i=["text!mobile/reports/flow/tmpl/thead.html"];return"tank"==this.model.get("dataSource")&&(i[0]="text!mobile/reports/flow/tmpl/theadTank.html",i[1]="text!mobile/reports/flow/tmpl/noFuelChanges.html",i[2]="text!mobile/reports/flow/tmpl/fuelChange.html",i[3]="text!mobile/reports/flow/tmpl/fuelChangesDaySummary.html"),requirejs(i,function(e){arguments[1]&&(h=t.template(arguments[1])),arguments[2]&&(p=t.template(arguments[2])),arguments[3]&&(f=t.template(arguments[3])),arguments[4]&&n.model.makeTracksModule(arguments[4]),e=t.template(e),n.content.append(t.template(r,{key:n.model.get("key"),theadHtml:""}));var a=n.content.find("tbody"),i=v["build"+n.model.get("dataSource").ucFirst()+"Rows"].call(n,e);a.append(i),s.resolve()}),s}}),v={buildFuelrateRows:function(e){var n=this,a=this.model.get("header"),s=a.keyOrder,r=this.model.get("footer"),o=this.model.get("body"),h=t.keys(o).length,p=0,f=0,g={},b="",y="",w=0,S=this.model.getTexts(),x=this.getDaysPeriods(a.sd,a.ed);if(f=t.keys(x).length,b=e({i18n:S,headIndex:1}),t.each(x,function(e){b+=i({colspan:9,dateStr:n.formatDate(e)+" ("+n.getDayOfWeek(e)+")",isWeekend:n.isWeekend(e)}),y="";for(var t,r,c=0,u=0,x=0,k=s.length;k>x;++x)t=s[x],r=o[t],u++,"history"in r&&"undefined"!=typeof r.history[p]?(g=r.history[p],g.id=r.id,g.name=r.name,g.extId=r.extId,v.setCommonValues.call(n,c,S,a,e,p,g),g.rowPosition=u==h&&p==f-1?"last":"",y+=d(g),w++):y+=l({extId:r.extId,name:r.name,rowIndex:c,rowClass:++c%2?"odd":"even",i18n:S,rowPosition:p==f-1?"last":""});y||(y=m({text:S.noDataForDay,colspan:9,rowPosition:p==f-1?"last":""})),b+=y,p++}),w){b+=c({i18n:S,colspan:9})+e({i18n:S,headIndex:2});for(var k,g,D=0,_=s.length;_>D;++D){k=s[D],g=r[k],g.rowPosition=D==_-1?"last":"",g.rowClass=D+1?"odd":"even",g.moveStartS=g.moveStart>0?n.formatDateTime(g.moveStart):"-",g.moveEndS=g.moveEnd>0?n.formatDateTime(g.moveEnd):"-";var T=n.model.get("useCalcValues"),j=g.realConsum,M=g.norm100km,C=g.consum100km;j?(g.fuelConsum=j,g.consum100km="avgConsum100km"in g?g.avgConsum100km:g.distance>0?100*j/g.distance:0):M>0?T?(g.fuelConsum=C,g.consum100km=M):(g.fuelConsum=null,g.consum100km=null):(g.fuelConsum=null,g.consum100km=null),g.consum100kmS=t.isNumber(g.consum100km)?g.consum100km.toFixed(1):"-",g.fuelConsumS=t.isNumber(g.fuelConsum)?g.fuelConsum.toFixed(1):"-",b+=u(g)}}return b},buildFlowRows:function(e){var n=this,a=this.model.get("header"),s=this.model.get("footer"),r=this.model.get("body"),o={},l=0,h=0,p="",f="",g=this.model.getTexts();p=e({i18n:g,headIndex:1});var b=this.getDaysPeriods(a.sd,a.ed);if(t.each(b,function(e){p+=i({colspan:9,dateStr:n.formatDate(e)+" ("+n.getDayOfWeek(e)+")",isWeekend:n.isWeekend(e)}),f="";var s=0;"undefined"!=typeof r[l]&&"undefined"!=typeof r[l].objects&&(o=r[l].objects,t.each(o,function(t){v.setCommonValues.call(n,s,g,a,e,l,t),h++,f+=d(t)})),f||(f=m({text:g.noDataForDay,colspan:9})),p+=f,l++}),h){p+=c({i18n:g,colspan:9})+e({i18n:g,headIndex:2});var y=0,w=t.keys(s).length;t.each(s,function(e){e.rowPosition=w>++y?"":"last",e.rowClass=y%2?"odd":"even",e.moveStartS=e.moveStart>0?n.formatTime(e.moveStart):"-",e.moveEndS=e.moveEnd>0?n.formatTime(e.moveEnd):"-";var a=n.model.get("useCalcValues"),s=e.realConsum,r=e.norm100km,i=e.consum100km;s?(e.fuelConsum=s,e.consum100km="avgConsum100km"in e?e.avgConsum100km:e.distance>0?100*s/e.distance:0):r>0?a?(e.fuelConsum=i,e.consum100km=r):(e.fuelConsum=null,e.consum100km=null):(e.fuelConsum=null,e.consum100km=null),e.consum100kmS=t.isNumber(e.consum100km)?e.consum100km.toFixed(1):"-",e.fuelConsumS=t.isNumber(e.fuelConsum)?e.fuelConsum.toFixed(1):"-",p+=u(e)})}return p},buildTankRows:function(e){var n=this,a=this.model.get("header"),s=(this.model.get("footer"),this.model.get("items")),r=this.model.get("body"),d=0,l=0,c=!1,u={},g=!1,v=[],b=[],y="",w="",S=0,x=0,k=0,D=this.model.getTexts(),_=5,T=this.getDaysPeriods(a.sd,a.ed);return t.each(s,function(s){u=t.findWhere(r,{id:s.id}),u&&(g=!1,w="",d=0,t.each(T,function(e){if(w+=i({colspan:_,dateStr:n.formatDate(e)+" ("+n.getDayOfWeek(e)+")",isWeekend:n.isWeekend(e)}),u.history[d]){if(g=!0,u.history[d].filplums&&u.history[d].filplums.length&&(c=!0),!c)return w+=h({colspan:_,i18n:D}),d++,void 0;v=u.history[d].filplums,l=0,t.each(v,function(e){e.volume>=0?x++:k++,e.addr||b.push(e),e.address=e.addr||"",e.delta=e.volume,w+=p(t.extend({},e,{startTimeS:n.formatDateTime(e.startTime),endTimeS:n.formatDateTime(e.endTime),i18n:D,rowIndex:++l,objectId:u.id,loadingAddress:D.loadingAddress,rowPosition:v.length==l?"last":""}))}),w+=f({i18n:D,colspan:_,fillingsVolume:u.history[d].totalFills,dischargesVolume:u.history[d].totalPlums}),function(e,a){n.listenTo(n.model,"afterrender",function(){for(var s,r=e.length;r--;)s=e[r],n.content.find(".fuel-change .put-fuel-marker[data-id="+a.id+"][data-index="+r+"]").data("fuelChange",t.extend({},s,{extId:a.extId,name:a.name,begin:s.startTime,end:s.endTime,address:s.addr,delta:s.volume}))})}(v,u)}else w+=m({text:D.noDataForDay,colspan:_});d++}),y+=o({i18n:D,hasData:g,colspan:_,id:s.id,extId:s.extId,name:s.name,periodStart:a.sd*App.MS,periodEnd:a.ed*App.MS,fillingsNumber:x,fillingsVolume:u.grandTotalFills,dischargesNumber:k,dischargesVolume:u.grandTotalPlums}),y+=e({i18n:D,headIndex:++S}),y+=w)}),b.length&&this.listenTo(this.model,"afterrender",function(){n.model.searchAddresses(b)}),y},setCommonValues:function(e,n,a,s,r,i){i.distanceS=this.formatDistance(i.distance),i.moveStartS=i.moveStart>0?this.formatTime(i.moveStart):"-",i.moveEndS=i.moveEnd>0?this.formatTime(i.moveEnd):"-",i.moveTimeS=Date.formatSeconds(i.moveTime),i.parkTimeS=Date.formatSeconds(i.parkTime),i.avgSpeedS=i.avgSpeed.toFixed(2);var o=this.model.get("useCalcValues"),d=!1,l=i.realConsum,m=i.norm100km,c=i.consum100km;"00:00:00"==i.moveEndS&&(i.moveEndS="24:00:00"),l?(i.fuelConsum=l,i.consum100km="avgConsum100km"in i?i.avgConsum100km:i.distance>0?100*l/i.distance:0):m>0?o?(i.fuelConsum=c,i.consum100km=m,d=!0):(i.fuelConsum=null,i.consum100km=null):(i.fuelConsum=null,i.consum100km=null),i.consum100kmS=t.isNumber(i.consum100km)?i.consum100km.toFixed(1):"-",d&&t.isNumber(i.consum100km)&&(i.consum100kmS+=' <span class="nobr">('+n.byNorm+")</span>"),i.fuelConsumS=t.isNumber(i.fuelConsum)?i.fuelConsum.toFixed(1):"-";var u=(r?s:Math.min(s,a.sd))*App.MS;i.dayStart=u,i.dayEnd=Math.min(u+864e5,a.ed*App.MS),i.rowIndex=e,i.rowClass=++e%2?"odd":"even",i.buildMovePark=n.build.ucFirst()+" "+n.reportsNames.movepark},buildSummaryTable:function(){},addChart:function(e,t,n){var a=this.model.getTexts(),r=a.fuelFlowChartTitle,i="";r+=","+a.l1h+"; "+a.object.ucFirst()+":&nbsp;#"+e.extId+" ["+e.name+"];"+(e.rev?" REV:&nbsp;"+e.rev:"");var i=s({title:r,id:"timechart-"+this.model.id+"-"+e.id,data:{id:e.id,index:t},addClass:n?"closed":"",showTxt:a.showChart,hideTxt:a.hideChart});return i},buildChart:function(){}};return g}),define("mobile/reports/flow/FlowReport",["underscore","_common/reports/Report","_common/tracks/TracksModule","mobile/reports/flow/views/FlowReportView"],function(e,t,n,a){var s=t.extend({defaults:e.extend({},t.prototype.defaults,{season:"auto"}),url:function(){return App.getBaseUrl()+"reports/"+this.get("dataSource").toUpperCase()+"/"},constructor:function(){this.addressesLoaded=!0,t.apply(this,arguments)},initialize:function(){this.makeTracksModule(n),t.prototype.initialize.call(this,a);var s=this;e.each(["useCalcValues","buildCharts","dataSource"],function(e){s.setUserData(e,s.get(e))}),this.setUserData("season",this.get("season"))},getPostParams:function(){var e=t.prototype.getPostParams.call(this);return e.season=this.get("season"),e.suppress_graphs=1,this.get("useCalcValues")&&(e.useCalcValues=1),e}});return s}),define("text!mobile/reports/fuel/tmpl/chartLegend.html",[],function(){return'<div class="legend">\n    <ul>\n        <li><span class="spot bgr-park first"></span> <%= i18n.parks %></li>\n        <li><span class="spot bgr-fuelFilling"></span> <%= i18n.fillings.ucFirst() %></li>\n        <li><span class="spot bgr-fuelSteal"></span> <%= i18n.discharges.ucFirst() %></li>\n        <% if(checkDiscret1) { %><li><span class="spot bgr-parkIgnitionOn"></span> <%= i18n.parksIgnOn %></li><% } %>\n    </ul>\n</div>'}),define("text!mobile/reports/fuel/tmpl/thead.html",[],function(){return"<tr data-head=\"<%= headIndex %>\">\n    <th>#</th>\n    <th><%= i18n.date.ucFirst() + ' ' + i18n.and + ' ' + i18n.time %></th>\n    <th><%= i18n.filling.ucFirst() + ' / ' + i18n.discharge %></th>\n    <th><%= i18n.volume.ucFirst() %>, <%= i18n.l %></th>\n    <th><%= i18n.beforeValue %>, <%= i18n.l %></th>\n    <th><%= i18n.afterValue %>, <%= i18n.l %></th>\n    <th><%= i18n.address.ucFirst() %></th>\n</tr>\n"}),define("text!mobile/reports/fuel/tmpl/fuelChange.html",[],function(){return'<tr class="fuel-change <% if(delta < 0) {%> negative<% } %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <td><%= rowIndex %></td>\n    <td class="text-left" data-value="<%= begin %>"><%= dateS %></td>\n    <td><%= delta > 0 ? i18n.filling.ucFirst() : i18n.discharge.ucFirst() %></td>\n    <td data-value="<%= delta %>"><%= Math.abs(Math._round(delta,1)) %></td>\n    <td data-value="<%= startf %>"><%= startf.toFixed(1) %></td>\n    <td data-value="<%= endf %>"><%= endf.toFixed(1) %></td>\n    <td class="address text-left" data-key="address" data-geoid="<%= geoId %>" data-lat="<%= lat %>" data-lon="<%= lon %>">\n        <a href="javascript:;" class="put-fuel-marker" data-id="<%= objectId %>" data-index="<%= rowIndex-1 %>">\n            <% if(address) {print(address)} else { %>\n            <span class="loading-address" data-geoid="<%= geoId %>"><%= i18n.loadingAddress %></span>\n            <% } %>\n        </a>\n    </td>\n</tr>'}),define("text!mobile/reports/fuel/tmpl/objSummary.html",[],function(){return'<!--<div id="jqChart"></div>-->\n<table class="fuel-summary">\n    <tbody>\n    <tr>\n        <td colspan="2"><strong><%= i18n.fuelVolumeInTank %></strong></td>\n        <td colspan="2"><strong><%= i18n.runDistance %> <%= i18n.and %> <%= i18n.speed %></strong></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.startVolume %>, <%= i18n.l %></td>\n        <% if(\'undefined\' != typeof startF ) {%>\n        <td class="value nobr" data-value="<%= startF %>"><%= Math._round(startF,1) %></td>\n        <% } else { %>\n        <td class="value no-data"><%= i18n.noData %></td>\n        <% } %>\n        <td><%= i18n.runDistance %>, <%= i18n.km %></td>\n        <td class="value nobr" data-value="<%= distInKm %>"><%= distInKm %></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.endVolume %>, <%= i18n.l %></td>\n        <% if(\'undefined\' != typeof endF ) {%>\n        <td class="value nobr" data-value="<%= endF %>"><%= Math._round(endF,1) %></td>\n        <% } else { %>\n        <td class="value no-data"><%= i18n.noData %></td>\n        <% } %>\n        <td><%= i18n.avgSpeed %>, <%= i18n.kmh %></td>\n        <td class="value nobr" data-value="<%= avgSpeedInKmh %>"><%= avgSpeedInKmh %></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.minVolume %>, <%= i18n.l %></td>\n        <td class="value nobr" data-value="<%= minVolume %>"><%= Math._round(minVolume,1) %></td>\n        <td colspan="2"><strong><%= i18n.wayTime %></strong></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.maxVolume %>, <%= i18n.l %></td>\n        <td class="value nobr" data-value="<%= maxVolume %>"><%= Math._round(maxVolume,1) %></td>\n        <td><%= i18n.totalMoveTime %></td>\n        <td class="value" data-value="<%= moveTimeInSec %>"><%= moveTimeS %></td>\n    </tr>\n\n    <tr>\n        <td colspan="2"><strong><%= i18n.fuelsAndDischarges %></strong></td>\n        <td><%= i18n.totalParkTime %></td>\n        <td class="value" data-value="<%= parkTimeInSec %>"><%= parkTimeS %></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.fillingsVolume %>, <%= i18n.l %></td>\n        <td class="value nobr" data-value="<%= fillVolume %>"><%= Math._round(fillVolume,1) %></td>\n        <td colspan="2"><strong><%= i18n.engineWorkTime %></strong></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.dischargesVolume %>, <%= i18n.l %></td>\n        <td class="value nobr" data-value="<%= plumVolume %>"><%= Math._round(plumVolume,1) %></td>\n        <td><%= i18n.ignOnTime %></td>\n        <td class="value" data-value="<%= ignOnTimeInSec %>"><%= ignOnTimeInSecS %></td>\n    </tr>\n\n    <tr>\n        <td colspan="2"><strong><%= i18n.totalFuelConsumption %></strong></td>\n        <td><%= i18n.firstIgnTime %></td>\n        <td class="value" data-value="<%= firstIgnTime %>"><%= firstIgnTimeS %></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.totalRealConsumption %>, <%= i18n.l %></td>\n        <td class="value nobr" data-value="<%= realConsumption %>"><%= Math._round(realConsumption,1) %></td>\n        <td><%= i18n.lastIgnTime %></td>\n        <td class="value" data-value="<%= lastIgnTime %>"><%= lastIgnTimeS %></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.consumption100km %>, <%= i18n.l100km %></td>\n        <td class="value nobr" data-value="<%= consumption100km %>"><%= Math._round(consumption100km, 1) %>\n        <td colspan="2"><strong><%= i18n.engineWorkTimeWhileMoving %></strong></td>\n    </tr>\n\n    <tr>\n        <td><%= i18n.consumption1hIgn %>, <%= i18n.l1h %></td>\n        <td class="value nobr" data-value="<%= consumption1hIgn %>"><%= Math._round(consumption1hIgn, 1) %></td>\n        <td><%= i18n.ignOnMoveTime %></td>\n        <td class="value" data-value="<%= ignOnMoveTimeInSec %>"><%= ignOnMoveTimeInSecS %></td>\n    </tr>\n\n    <tr>\n        <!-- Consumption while moving is temporary removed due to GR-1343-->\n        <!--<td colspan="2"><strong><%= i18n.consumWhileMoving %></strong></td>-->\n        <td colspan="2" rowspan="3"></td>\n        <td colspan="2"><strong><%= i18n.engineWorkTimeOnParks %></strong></td>\n    </tr>\n\n    <tr>\n        <!--<td><%= i18n.consumWhileMovingShort %>, <%= i18n.l %></td>\n        <td class="value nobr" data-value="<%= consumWhileMoving %>"><%= Math._round(consumWhileMoving, 1) %></td>-->\n        <td><%= i18n.ignOnParkTime %></td>\n        <td class="value" data-value="<%= ignOnParkTimeInSec %>"><%= ignOnParkTimeInSecS %></td>\n    </tr>\n\n    <tr>\n        <!--<td><%= i18n.consumWhileMovingShort %>, <%= i18n.l100km %></td>\n        <td class="value nobr" data-value="<%= consumWhileMoving100km %>"><%= Math._round(consumWhileMoving100km, 1) %></td>-->\n        <td><%= i18n.ignOffParkTime %></td>\n        <td class="value" data-value="<%= ignOffParkTimeInSec %>"><%= ignOffParkTimeInSecS %></td>\n    </tr>\n\n    <!--<tr>\n        <td><%= i18n.consumption1h %>, <%= i18n.l1h %></td>\n        <td class="value nobr" data-value="<%= consumption1hMove %>"><%=  Math._round(consumption1hMove, 1) %></td>\n        <td colspan="2"></td>\n    </tr>-->\n\n    </tbody>\n</table>'}),define("text!mobile/reports/fuel/tmpl/headers.html",[],function(){return'<h4><%= i18n.fuelsAndDischarges %> <%= i18n.byObject %> #<%= objData.extId %> [<%= objData.name %>]</h4>\n<% if(\'undefined\' != typeof objData.fuels && objData.fuels.length) { %>\n<a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n<% } %>'}),define("mobile/reports/fuel/views/FuelReportView",["jquery","underscore","_libs/charts/Chart","_common/mobile/MobileObject","_common/reports/views/ReportView","text!_common/reports/tmpl/chart.html","text!mobile/reports/fuel/tmpl/chartLegend.html","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/fuel/tmpl/thead.html","text!mobile/reports/fuel/tmpl/fuelChange.html","text!mobile/reports/fuel/tmpl/objSummary.html","text!mobile/reports/fuel/tmpl/headers.html"],function(e,t,n,a,s,r,i,o,d,l,m,c){var u=null,h=null,p=15,f=24;r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d),l=t.template(l),m=t.template(m);var g=20,v=400,b=s.extend({constructor:function(){this._fuelChanges=[],s.apply(this,arguments)},render:function(){var a=new e.Deferred;s.prototype.render.apply(this,arguments),this.$el.addClass("fuel-report"),this.buildMetaInfo();var r="",i=this,o=this.model.getTexts(),d=this.model.get("body").objects,l=0,m=0;return t.each(d,function(e){if(r="",i.model.get("buildCharts")&&"undefined"!=typeof e.fuels&&(r+=i._addCharts.call(i,e,l)),"undefined"!=typeof e.fuels?(i._fuelChanges=i._fuelChanges.concat(e.fuels),r+=t.template(c,{i18n:o,objData:e}),r+=i._buildFuelChangesTable(e,m+1),r+=i._buildSummaryTable(e,m+2),m+=2):r+="<h4>#"+e.extId+" ["+e.name+']</h4><p class="no-data">'+o.noDataForObject+"</p>",l++,i.content.append(r),"undefined"!=typeof e.fuels)for(var n=e.fuels.length;n--;)i.content.find(".fuel-change .put-fuel-marker[data-id="+e.id+"][data-index="+n+"]").data("fuelChange",t.extend({},e.fuels[n],{extId:e.extId,name:e.name}))}),1==d.length?i._buildCharts(d[0]):this.content.find(".rep-chart").one("chart.show",function(){var t=e(this),n=t.data("index"),a=t.data("type");d[n]&&i["_buildChart"+a.ucFirst()].call(i,d[n],t)}),this.content.append(this._buildPeriodsTable(this.model.get("body"))),this.listenTo(App,"layoutchange",function(e){e&&e.leftWidth&&i._resizeCharts(e.leftWidth)}).listenTo(this.model,"remove",function(){i.stopListening(App),i.$el.find("div.chart-content").each(function(){n.destroy(e(this))})}),a.resolve(),a},_buildPeriodsTable:function(){return""},_addCharts:function(e,t){var n=this.model.get("body").objects.length,s=this.model.getTexts(),i=s.fuelTimeChartTitle,o="",d="",l="",m=this.model.get("anIndex");return d=e.rev&&a.detectCANbyRev(e.rev)?"CAN":1==m||2==m?s.analogueSensor1+" "+m:s.analogueSensors1+" 1+2",i=i.replace("#source#",d),o="; "+s.object.ucFirst()+":&nbsp;#"+e.extId+" ["+e.name+"];"+(e.rev?" REV:&nbsp;"+e.rev:""),l=r({title:i+o,id:"timechart-"+this.model.id+"-"+e.id,data:{id:e.id,index:t,type:"time"},addClass:n>1?"closed":"",showTxt:s.showChart,hideTxt:s.hideChart}),i=s.fuelDistanceChartTitle.replace("#source#",d)+o,l+=r({title:i,id:"distchart-"+this.model.id+"-"+e.id,data:{id:e.id,index:t,type:"distance"},addClass:n>1?"closed":"",showTxt:s.showChart,hideTxt:s.hideChart})},_buildFuelChangesTable:function(e,n){var a=this.model.getTexts();if(!e.fuels||!e.fuels.length)return'<p class="no-data">'+a.noFuelsOrDischarges+"</p>";var s=this,r="",i=0,m=[];t.each(e.fuels,function(n){!n.address&&m.push(n),r+=l(t.extend({},n,{i18n:a,rowIndex:++i,objectId:e.id,dateS:s.formatDateTime(n.begin),rowPosition:i==e.fuels.length?"last":""}))});var c=o({key:this.model.get("key"),theadHtml:"",tbodyHtml:d({i18n:a,headIndex:n})+r});return m.length&&this.listenTo(this.model,"afterrender",function(){s.model.searchAddresses(m)}),c},_buildSummaryTable:function(e){var n=this.model.get("endTime")-this.model.get("startTime"),a=this.model.getTexts(),s=t.extend({},e,{i18n:a});return s.moveTimeS=Date.formatSeconds(Math.round(s.moveTimeInSec)),s.parkTimeInSec=Math.round(n/App.MS)-s.moveTimeInSec,s.parkTimeS=Date.formatSeconds(Math.round(s.parkTimeInSec)),s.ignOnTimeInSecS=Date.formatSeconds(Math.round(s.ignOnTimeInSec)),s.ignOnParkTimeInSecS=Date.formatSeconds(Math.round(s.ignOnParkTimeInSec)),s.ignOffParkTimeInSecS=Date.formatSeconds(Math.round(s.ignOffParkTimeInSec)),s.ignOnMoveTimeInSecS=Date.formatSeconds(Math.round(s.ignOnMoveTimeInSec)),s.firstIgnTimeS=s.firstIgnTime>0?this.formatDateTime(s.firstIgnTime):"-",s.lastIgnTimeS=s.lastIgnTime>0?this.formatDateTime(s.lastIgnTime):"-",m(s)},_buildCharts:function(e,t){if(!t)var n=this.$el.find("div.rep-chart").filter("[data-id="+e.id+"]");return"undefined"!=typeof e.fuelByDist&&e.fuelByDist.length?(this._buildChartTime(e),e.distInKm>.01?this._buildChartDistance(e):this.$el.find('div.rep-chart[data-type="distance"]').remove(),void 0):(n.remove(),!1)},_buildChartTime:function(a){var s,r,o=this,d=e("#timechart-"+this.model.id+"-"+a.id),l=this.model.getTexts(),m=n.getDefaults(),c=m.axes[0],u=m.axes[1],h=m.height,p=1,f=20,g=[],b=[],y=this._getChartColors();if(v=d.width(),p=f*(a.maxVolume-a.minVolume)/h,u.majorGridLines.interval=Math.ceil(p),a.parks&&a.parks.length&&(s=new Array(a.parks.length),r=0,t.each(a.parks,function(e){s[r]=[new Date(e.start*App.MS),new Date(e.end*App.MS),y.PARK_BAND],r++}),e.merge(b,s)),this.model.get("checkDiscret1")&&a.parksWithIgns&&a.parksWithIgns.length&&(s=new Array(a.parksWithIgns.length),r=0,t.each(a.parksWithIgns,function(e){s[r]=[new Date(e.start*App.MS),new Date(e.end*App.MS),y.PARK_IGN_BAND],r++}),e.merge(b,s)),a.fuels&&a.fuels.length){var w=[],S=[],x=[],k=null,D=null,_=null,T=0,j=0;if(this._fuelChanges=a.fuels,t.each(a.fuels,function(e){k=new Date(e.begin*App.MS),D=new Date(e.end*App.MS),e.delta>=0?(T++,_=o._makeFuelChangeMarker(j+T,e),w.push([k,e.startf,_]),S.push([k,D,y.FUEL_BAND])):(++j,_=o._makeFuelChangeMarker(j+T,e),w.push([k,e.startf,_]),x.push([k,D,y.DISCHARGE_BAND]))}),w.length)var M={type:"scatter",markers:{type:"image",offset:20},data:w};e.merge(b,S,x)}g.push({type:"line",markers:null,data:this._prepareTimeChartData(a)}),"undefined"!=typeof M&&g.push(M),b.length&&(c=e.extend({},c,{bands:b})),new n(d,{width:v+"px",axes:[c,u],series:g}),d.bind("tooltipFormat",function(e,t){var n=o.formatUTC("DD.MM HH:mm",t.x)+"<br />";if("scatter"==t.series.type){var s=a.fuels[t.index];n+=(s.delta>0?l.filling:l.discharge).ucFirst(),n+=": <strong>"+Math._round(s.delta,2)+"&nbsp;"+l.l+"</strong>",s.address&&(n+="<br />"+s.address)}else n+=l.volume.ucFirst()+": <strong>"+t.y+" "+l.l+"</strong><br />";return n}),d.after(i({i18n:l,checkDiscret1:"undefined"!=typeof this.model.get("checkDiscret1")}))},_buildChartDistance:function(a){var s=this.model.getTexts(),r=e("#distchart-"+this.model.id+"-"+a.id),i=n.getDefaults(),o=i.axes[1],d=i.height,l=20,m=[],c=this._getChartColors();v=r.width();var u=l*(a.maxVolume-a.minVolume)/d;if(o.majorGridLines.interval=Math.ceil(u),a.fuels&&a.fuels.length){var h=this,p=[],f=[],g=[],b=null,y=0,w=0,S=0,x=0;t.each(a.fuels,function(e){S=a.fuelByDist[e.sid].distInKm,x=a.fuelByDist[e.eid].distInKm,e.delta>=0?(y++,b=h._makeFuelChangeMarker(w+y,e),p.push([S,e.startf,b]),f.push([S,x,c.FUEL_BAND])):(++w,b=h._makeFuelChangeMarker(w+y,e),p.push([S,e.startf,b]),g.push([S,x,c.DISCHARGE_BAND]))}),e.merge(m,f,g)}var k=e.extend({},i.axes[0],{type:"linear",labels:{stringFormat:null}});"undefined"!=typeof f&&e.merge(m,f),"undefined"!=typeof g&&e.merge(m,g),m.length&&(k.bands=m);var D=[{type:"line",markers:null,data:this._prepareDistChartData(a)}];if("undefined"!=typeof p&&p.length){var _={type:"scatter",markers:{type:"image",offset:20},data:p};D.push(_)}new n(r,{width:v+"px",axes:[k,o],series:D}),r.bind("tooltipFormat",function(e,t){var n="";if("scatter"==t.series.type){var r=a.fuels[t.index];n+=h.formatUTC("DD.MM HH:mm",r.begin*App.MS)+"<br />",n+=s.runDistance+": "+t.x.toFixed(1)+" "+s.km+"<br />",n+=(r.delta>0?s.filling:s.discharge).ucFirst(),n+=": <strong>"+Math._round(r.delta,2)+"&nbsp;"+s.l+"</strong>",r.address&&(n+="<br />"+r.address)}else n=t.x.toFixed(1)+" "+s.km+"<br />"+s.volume.ucFirst()+": <strong>"+t.y+" "+s.l+"</strong><br />";return n})},_prepareTimeChartData:function(e){for(var t=e.fuelByDist,n=t.length,a=new Array(t.len),s={},r=App.MS,i=0;n>i;++i)s=t[i],a[i]=[new Date(s.date*r),s.value];return a},_prepareDistChartData:function(e){for(var t=e.fuelByDist,n=t.length,a=new Array(t.len),s={},r=0;n>r;++r)s=t[r],a[r]=[s.distInKm,s.value];return a},_resizeCharts:function(t){var a=t-g+"px";this.$el.find("div.chart-content").each(function(){n.setWidth(e(this),a)})},_makeContext:function(){u=document.createElement("canvas"),u.width=p,u.height=f,u.className="hidden",document.body.appendChild(u),h=u.getContext("2d")},_makeFuelChangeMarker:function(e,t){return null==h&&this._makeContext(),h.clearRect(0,0,p,f),h.beginPath(),h.rect(0,0,p,f),h.fillStyle=t.delta>=0?"green":"red",h.fill(),h.font="15px bold Arial",h.textAlign="center",h.fillStyle="#fff",h.fillText(e,p/2,f/2+5),u.toDataURL()},onAddressLoad:function(e){s.prototype.onAddressLoad.apply(this,arguments),t.each(this._fuelChanges,function(t){t.address||t.geoId!=e.geoId||(t.address=e.address)})}});return b}),define("mobile/reports/fuel/FuelReport",["underscore","_common/tracks/TracksModule","_common/reports/Report","mobile/reports/fuel/views/FuelReportView"],function(e,t,n,a){var s=n.extend({url:App.getBaseUrl()+"reports/FUEL/",constructor:function(){this.addressesLoaded=!1,n.apply(this,arguments)},initialize:function(){var s=!1;this.has("source")&&(s=!0,this.get("source").registerChild(this)),this.makeTracksModule(t),n.prototype.initialize.call(this,a);var r=this;e.each(["anIndex","movingIndex","ignition"],function(e){r.setUserData(e,r.get(e))}),s||e.each(["buildCharts","checkDiscret1"],function(e){r.setUserData(e,r.get(e))})},getPostParams:function(){var e=n.prototype.getPostParams.call(this);return e.anIndex=this.get("anIndex"),e.movingIndex=this.get("movingIndex")||0,e.ignition=this.get("ignition")||0,this.get("buildCharts")||(e.suppress_graphs=1),this.get("checkDiscret1")&&(e.paint_graphs=1),e}});return s}),define("text!mobile/reports/fuel2/tmpl/thead.html",[],function(){return'<br />\n<table class="selectable rep-table">\n    <tbody>\n        <tr data-head="<%= headPosition %>">\n            <th><%= i18n.date.ucFirst() %></th>\n            <!--<th><%= i18n.object.ucFirst() %></th>-->\n            <th><%= i18n.runDistance.ucFirst() %>, <%= i18n.km %></th>\n            <th><%= i18n.moveStart %></th>\n            <th><%= i18n.moveEnd %></th>\n            <th><%= i18n.moveTime %></th>\n            <th><%= i18n.startVolume %>, <%= i18n.l %></th>\n            <th><%= i18n.endVolume %>, <%= i18n.l %></th>\n            <th><%= i18n.fillingsVolume %>, <%= i18n.l %></th>\n            <th><%= i18n.dischargesVolume %>, <%= i18n.l %></th>\n            <th><%= i18n.consumption100km %>, <%= i18n.l100km %></th>\n            <th><%= i18n.consumption1h %></th>\n        </tr>\n        <%= rows %>\n    </tbody>\n</table>\n'}),define("text!mobile/reports/fuel2/tmpl/row.html",[],function(){return'<tr<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <td><%= date %></td>\n    <!--<td><%= objId %></td>-->\n    <td data-value="<%= dayDistance %>"><%= Math._round(dayDistance, 2) %></td>\n    <td data-value="<%= moveStart %>"><%= moveStartS %></td>\n    <td data-value="<%= moveEnd %>"><%= moveEndS %></td>\n    <td data-value="<%= moveTime %>"><%= Date.formatSeconds(moveTime) %></td>\n    <td data-value="<%= fuelValueStart %>"><%= Math._round(fuelValueStart, 1) %></td>\n    <td data-value="<%= fuelValueEnd %>"><%= Math._round(fuelValueEnd, 1) %></td>\n    <td data-value="<%= fuelFillings %>"><%= Math._round(fuelFillings, 1) %></td>\n    <td data-value="<%= fuelSteals %>"><%= Math._round(fuelSteals, 1) %></td>\n    <td data-value="<%= consumption100km %>"><%= consumption100kmS %></td>\n    <td data-value="<%= consumptionWhileMoving1h %>"><%= consumptionWhileMoving1hS %></td>\n</tr>'}),define("text!mobile/reports/fuel2/tmpl/summaryTable.html",[],function(){return'<h3 class="report-objst-summary"><%= i18n.summary %></h3>\n<table class="selectable rep-table">\n    <thead>\n        <tr>\n            <th><%= i18n.object.ucFirst() %></th>\n            <th><%= i18n.moveTime %></th>\n            <th><%= i18n.totalRealConsumption %>, <%= i18n.l %></th>\n            <th><%= i18n.fillingsVolume %>, <%= i18n.l %></th>\n            <th><%= i18n.dischargesVolume %>, <%= i18n.l %></th>\n            <th><%= i18n.runDistance %>, <%= i18n.km %></th>\n        </tr>\n    </thead>\n    <tbody>\n        <%= rows %>\n    </tbody>\n</table>\n'}),define("text!mobile/reports/fuel2/tmpl/summaryRow.html",[],function(){return"<tr>\n    <td><%= name %></td>\n    <td data-value=\"<% if(typeof ignOnMoveTimeInSec != 'undefined') { %><%= ignOnMoveTimeInSec %><% } %>\"><% if(typeof ignOnMoveTimeInSec != 'undefined') { %><%= Date.formatSeconds( ignOnMoveTimeInSec ) %><% } %></td>\n    <td data-value=\"<% if(typeof realConsumption != 'undefined') { %><%= realConsumption %><% } %>\"><% if(typeof realConsumption != 'undefined') { %><%= Math._round(realConsumption, 1) %><% } %></td>\n    <td data-value=\"<% if(typeof fillVolume != 'undefined') { %><%= fillVolume %><% } %>\"><% if(typeof fillVolume != 'undefined') { %><%= Math._round(fillVolume, 1) %><% } %></td>\n    <td data-value=\"<% if(typeof plumVolume != 'undefined') { %><%= plumVolume %><% } %>\"><% if(typeof plumVolume != 'undefined') { %><%= Math._round(plumVolume, 1) %><% } %></td>\n    <td data-value=\"<% if(typeof distInKm != 'undefined') { %><%= distInKm %><% } %>\"><% if(typeof distInKm != 'undefined') { %><%= Math._round(distInKm, 2) %><% } %></td>\n</tr>"
}),define("mobile/reports/fuel2/views/Fuel2ReportView",["jquery","underscore","mobile/reports/fuel/views/FuelReportView","text!mobile/reports/fuel2/tmpl/thead.html","text!mobile/reports/fuel2/tmpl/row.html","text!mobile/reports/fuel2/tmpl/summaryTable.html","text!mobile/reports/fuel2/tmpl/summaryRow.html"],function(e,t,n,a,s,r,i){a=t.template(a),s=t.template(s),i=t.template(i);var o=n.extend({constructor:function(){n.apply(this,arguments)},_buildSummaryTable:function(e,n){var r=this,i=this.model.get("header"),o=this.getDaysPeriods(i.sd,i.ed),d=o.length-1,l="",m="",c=0;return t.each(o,function(n){if(e.periods[c]){var a=e.periods[c],i={dayDistance:0,dayMoveTime:0,moveStart:0,moveEnd:0,fuelFillings:0,fuelSteals:0,fuelSpent100km:0,fuelSpent1h:0};i.dayDistance=a.distInKm,i.moveTime=a.moveTime/App.MS,"undefined"!=a.moveStart&&(i.moveStart=a.moveStart),"undefined"!=a.moveEnd&&(i.moveEnd=a.moveEnd),i.fuelValueStart=a.startF,i.fuelValueEnd=a.endF,i.fuelFillings=a.fillVolume,i.fuelSteals=a.plumVolume,i.consumption100km=a.consumption100km,i.consumptionWhileMoving1h=a.consumptionWhileMoving1h,m=i.moveEnd>0?r.formatTime(i.moveEnd/App.MS):"-","00:00:00"==m&&(m="24:00:00"),l+=s(t.extend({},i,{date:r.formatDate(n),objId:a.extId,moveStartS:i.moveStart>0?r.formatTime(i.moveStart/App.MS):"-",moveEndS:m,consumption100kmS:i.moveTime>0?Math._round(i.consumption100km,1):"-",consumptionWhileMoving1hS:Math._round(i.consumptionWhileMoving1h,1),rowPosition:d==c?"last":""})),c++}}),a({i18n:this.model.getTexts(),rows:l,headPosition:n})},_buildSummaryTableOld:function(e){var n=this.model.get("header"),r=this.getDaysPeriods(n.sd,n.ed),i="",o=0,d=0,l=e.fuelByDist.length;return t.each(r,t.bind(function(n){for(var a,r=0,m={totalPoints:0,dayDistance:0,dayMoveTime:0,moveStart:0,moveEnd:0,fuelFillings:0,fuelSteals:0,fuelSpent100km:0,fuelSpent1h:0},c={pointsCount:0,resultRun:0,parksPeriods:[]},u=o,h=0,p=0,f=n.getTime()/1e3,g=86399+n.getTime()/1e3,v=0;l-1>=o&&g>=r;)a=o,r=e.fuelByDist[o].date,++o;o--,c.pointsCount=o-u,v=o==l-1?e.distInKm:e.fuelByDist[o].distInKm,c.resultRun=v-e.fuelByDist[u].distInKm;var b=e.parks.length;for(a=0;b>a;++a){var y=e.parks[a],w=y.start,S=y.end;if(!(f>S||w>g)){var x={start:y.start,end:y.end};f>w&&(x.start=f),S>g&&(x.end=g),c.parksPeriods.push(x)}}var k=c.parksPeriods.length;if(c.resultMoveStart=f,c.resultMoveEnd=g,k>0)for(c.parksPeriods[0].start==f&&(c.resultMoveStart=c.parksPeriods[0].end),c.parksPeriods[k-1].end==g&&(c.resultMoveEnd=c.parksPeriods[k-1].start),a=k;a--;)p+=c.parksPeriods[a].end-c.parksPeriods[a].start;else p=g-f;for(h=g-f-p,(c.resultMoveStart>c.resultMoveEnd||c.pointsCount<=1)&&(c.resultMoveStart=0,c.resultMoveEnd=0),m.totalPoints=c.pointsCount,m.dayDistance=c.resultRun,m.dayMoveTime=h,m.moveStart=c.resultMoveStart,m.moveEnd=c.resultMoveEnd,r=0,u=d,m.fuelValueStart=e.fuelByDist[d].value;d<e.fuelByDist.length-1&&g>r;)r=e.fuelByDist[d].date,++d;m.fuelValueEnd=e.fuelByDist[d].value,m.fuelFillings=0,m.fuelSteals=0,t.each(e.fuels,function(e){e.sid>d||e.sid<u||(e.delta>0?m.fuelFillings+=e.delta:m.fuelSteals+=e.delta)});var D=m.fuelFillings+m.fuelValueStart-m.fuelValueEnd-Math.abs(m.fuelSteals);m.fuelSpent100km=0!=m.dayDistance?100*D/m.dayDistance:0,m.fuelSpent1h=0!=m.dayMoveTime?D/(m.dayMoveTime/3600):0,m.fuelFillings=Math.round(10*m.fuelFillings)/10,m.fuelSteals=Math.round(10*m.fuelSteals)/10,i+=s({date:this.formatDate(n.getTime()/1e3),objId:e.extId,dayDistance:m.dayDistance,moveStart:m.moveStart,moveStartS:m.moveStart>0?this.formatTime(m.moveStart):"-",moveEnd:m.moveEnd,moveEndS:m.moveEnd>0?this.formatTime(m.moveEnd):"-",dayMoveTime:m.dayMoveTime,fuelValueStart:m.fuelValueStart,fuelValueEnd:m.fuelValueEnd,fuelFillings:m.fuelFillings,fuelSteals:m.fuelSteals,fuelSpent100km:m.fuelSpent100km,fuelSpent100kmS:m.dayMoveTime>0?Math._round(m.fuelSpent100km,1):"-",fuelSpent1h:m.fuelSpent1h,fuelSpent1hS:m.dayMoveTime>0?Math._round(m.fuelSpent1h,1):"-"})},this)),a({i18n:this.model.getTexts(),rows:i})},_buildPeriodsTable:function(e){var n="";return t.each(e.objects,function(e){n+=i(e)}),t.template(r,{i18n:this.model.getTexts(),rows:n})}});return o}),define("mobile/reports/fuel2/Fuel2Report",["underscore","_common/tracks/TracksModule","_common/reports/Report","mobile/reports/fuel/FuelReport","mobile/reports/fuel2/views/Fuel2ReportView"],function(e,t,n,a,s){var r=a.extend({url:App.getBaseUrl()+"reports/FUEL2/",constructor:function(){a.apply(this,arguments)},initialize:function(){this.makeTracksModule(t),n.prototype.initialize.call(this,s);var a=this;e.each(["anIndex","movingIndex","ignition","buildCharts","checkDiscret1"],function(e){a.setUserData(e,a.get(e))})}});return r}),define("text!mobile/reports/lostfix/tmpl/thead.html",[],function(){return'<tr data-head="1">\n    <th data-key="id">ID</th>\n    <th data-key="vehicleNumber"><%= i18n.vehicleNumber %></th>\n    <th data-key="name"><%= i18n.name %></th>\n    <th data-key="rev"><%= i18n.rev %></th>\n    <th data-key="glonassLosesCount"><%= i18n.glonassLosesCount %></th>\n    <th data-key="glonassLostPoint"><%= i18n.glonassLostPoint %></th>\n    <th data-key="glonassRestorePoint"><%= i18n.glonassRestorePoint %></th>\n    <th data-key="losesLesser10min"><%= i18n.losesLesser10min %></th>\n    <th data-key="losesLonger10min"><%= i18n.losesLonger10min %></th>\n    <th data-key="losesLonger30min"><%= i18n.losesLonger30min %></th>\n    <th data-key="onlineTime"><%= i18n.onlineTime %></th>\n    <th data-key="offlineTime"><%= i18n.offlineTime %></th>\n</tr>'}),define("text!mobile/reports/lostfix/tmpl/row.html",[],function(){return'<% if(rowClass == \'row-object\') { %>\n<tr data-index=<%= rowIndex %> class="<%= rowClass %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n\n    <td data-key="id" class="text-left"><%= id %></td>\n    <td data-key="vehicleNumber"><%= number %></td>\n    <td data-key="name"><%= name %></td>\n    <td data-key="rev"><%= rev %></td>\n    <td data-key="glonassLosesCount"><%= glonassLosesCount %></td>\n    <td data-key="glonassLostPoint"></td>\n    <td data-key="glonassRestorePoint"></td>\n    <td data-key="losesLesser10min"><%= losesLesser10min %></td>\n    <td data-key="losesLonger10min" class="blue"><%= losesLonger10min %></td>\n    <td data-key="losesLonger30min" class="red"><%= losesLonger30min %></td>\n    <td data-key="onlineTime"><%= online %></td>\n    <td data-key="offlineTime"><%= offline %></td>\n\n</tr>\n<% } else if(rowClass == \'row-total\') { %>\n<tr data-index=<%= rowIndex %> class="<%= rowClass %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n\n    <td data-key="empty" colspan="4" class="text-left"><%= i18n.summary %>:</td>\n    <td data-key="glonassLosesCount"><%= glonassLosesCount %></td>\n    <td data-key="empty" colspan="2"></td>\n    <td data-key="losesLesser10min"><%= losesLesser10min %></td>\n    <td data-key="losesLonger10min" class="blue"><%= losesLonger10min %></td>\n    <td data-key="losesLonger30min" class="red"><%= losesLonger30min %></td>\n    <td data-key="onlineTime"><%= online %></td>\n    <td data-key="offlineTime"><%= offline %></td>\n\n</tr>\n<% } else { %>\n<tr data-index=<%= rowIndex %> class="<%= rowClass %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n\n    <td data-key="empty" colspan="5"></td>\n    <td data-key="glonassLostPoint"><%= start %></td>\n    <td data-key="glonassRestorePoint"><%= end %></td>\n    <td data-key="" colspan="4"></td>\n    <td data-key="offline"><%= offline %></td>\n\n</tr>\n<% } %>'}),define("text!mobile/reports/lostfix/tmpl/rowGroup.html",[],function(){return'<tr>\n    <td colspan="12" class="text-left"><%= i18n.group %>: <%= group.groupName %> (#<%= group.groupId %>)</td>\n</tr>'}),define("mobile/reports/lostfix/views/LostfixReportView",["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/lostfix/tmpl/thead.html","text!mobile/reports/lostfix/tmpl/row.html","text!mobile/reports/lostfix/tmpl/rowGroup.html","text!_common/reports/tmpl/noDataRow.html"],function(e,t,n,a,s,r,i){var r=t.template(r),i=t.template(i),o=n.extend({FIX_HEADER:1,constructor:function(){n.apply(this,arguments)},initialize:function(){n.prototype.initialize.apply(this,arguments)},render:function(){var r=new e.Deferred;n.prototype.render.apply(this,arguments),this.$el.addClass("lostfix-report"),this.buildMetaInfo(),this.content.append(t.template(a,{key:this.model.get("key"),theadHtml:""}));var i=this.content.find("tbody"),o=d.buildRows.call(this);return i.append(t.template(s,{i18n:this.model.getTexts()})+o),r.resolve(),r}}),d={buildRows:function(){var e=this,n=this.model.get("header"),a=this.model.get("body"),s="",o=0,d=0,l=null,m=null,c=this.model.getTexts(),u=[0,0,0,0,0,0],h=n.ed-n.sd,p=0,f=0;return t.each(a,t.bind(function(n){s+=i({group:n,i18n:this.model.getTexts()}),t.each(n.objects,t.bind(function(n){p=h,m=[0,0,0,0],l=[];var a=o++;n.parks&&t.each(n.parks,t.bind(function(t){d=t.duration,600>d?(m[0]++,u[0]++):d>=600&&1800>d?(m[1]++,u[1]++):(m[2]++,u[2]++),m[3]+=d,u[3]+=d,l.push({start:e.formatDateTime(t.start),end:e.formatDateTime(t.end),offline:Date.formatSeconds(d,!0),rowIndex:++o,rowClass:"row-lost",i18n:c})},this)),f=n.parks?n.parks.length:0,u[4]+=f,u[5]+=h-m[3],s+=r({id:n.extId,number:n.number,rev:n.rev,name:n.name,glonassLosesCount:f,losesLesser10min:m[0],losesLonger10min:m[1],losesLonger30min:m[2],online:Date.formatSeconds(h-m[3],!0),offline:Date.formatSeconds(m[3],!0),rowIndex:a,rowClass:"row-object",i18n:c}),t.each(l,t.bind(function(e){s+=r(e)},this))},this))},this)),s+=r({glonassLosesCount:u[4],losesLesser10min:u[0],losesLonger10min:u[1],losesLonger30min:u[2],online:Date.formatSeconds(u[5],!0),offline:Date.formatSeconds(u[3],!0),rowClass:"row-total",rowIndex:++o,i18n:c,rowPosition:"last"})},buildSummaryTable:function(){}};return o}),define("mobile/reports/lostfix/LostfixReport",["underscore","_common/reports/Report","mobile/reports/lostfix/views/LostfixReportView"],function(e,t,n){var a=t.extend({url:App.getBaseUrl()+"reports/LOSTFIX/",constructor:function(){t.apply(this,arguments)},initialize:function(){t.prototype.initialize.call(this,n)}});return a}),define("text!mobile/reports/movepark/tmpl/settings.html",[],function(){return'<div class="dropdown add-on rep-settings">\n    <a class="dropdown-toggle" data-toggle="dropdown" href="#">\n        <i class="svg-icon svg-icon-cog"></i>\n    </a>\n    <ul class="dropdown-menu nav nav-list">\n        <li class="control-group no-margin">\n            <label><%= i18n.timeFormat %></label>\n            <select name="repTimeUnits">\n                <option value="hms"><%= i18n.hours %>, <%= i18n.minutes %>, <%= i18n.sec %></option>\n                <option value="m"<% if(timeFormat == \'m\') {%> selected="selected"<% } %>><%= i18n.minutes %></option>\n            </select>\n        </li>\n    </ul>\n</div>'}),define("text!mobile/reports/movepark/tmpl/moveparkTable.html",[],function(){return'<table class="rep-table movepark-rep-table">\n    <colgroup>\n        <col style="width: 12%;">\n        <col style="width: 12%;">\n        <col style="width: 15%;">\n        <col style="width: 15%;">\n        <col style="width: 18%;">\n    </colgroup>\n    <thead class="hidden">\n        <%= theadHtml %>\n    </thead>\n\n    <tbody>\n\n    </tbody>\n</table><!-- /run-rep-table -->'}),define("text!mobile/reports/movepark/tmpl/thead.html",[],function(){return'<tr data-head="<%= headIndex %>">\n    <th rowspan="<%= rowspan %>">#</th>\n    <th rowspan="<%= rowspan %>"><%= i18n.action %></th>\n    <th rowspan="<%= rowspan %>" data-key="start"><%= i18n.actionStart %></th>\n    <th rowspan="<%= rowspan %>" data-key="end"><%= i18n.actionEnd %></th>\n    <th rowspan="<%= rowspan %>" data-key=""><%= i18n.actionTime %></th>\n    <% if(showParks) {%>\n    <th colspan="<%= rowspan %>" data-key="address"><%= i18n.parkAddress %></th>\n    <% } else if(showMoves) {%>\n    <th style="width:20%" data-key="avgSpeed"><%= i18n.avgSpeed %>, <%= i18n.kmh %></th>\n    <th style="width:20%" data-key="distance"><%= i18n.runDistance %>, <%= i18n.km %></th>\n    <% } %>\n</tr>\n<% if(showParks && showMoves) {%>\n<tr data-head="<%= headIndex %>">\n    <th data-key="avgSpeed"><%= i18n.avgSpeed %>, <%= i18n.kmh %></th>\n    <th data-key="distance"><%= i18n.runDistance %>, <%= i18n.km %></th>\n</tr>\n<% } %>'}),define("text!mobile/reports/movepark/tmpl/rowObject.html",[],function(){return'<tr class="obj">\n    <td colspan="<%= colspan %>" class="summary">\n        <div class="sum-header">\n            <strong><%= title %></strong>\n            <% if(hasData) {%>\n            <a class="build-track nobr" href="javascript:;"\n               data-id="<%= objectId %>" data-from="<%= periodStart %>" data-to="<%= periodEnd %>" >\n                <%= i18n.showFullTrack %>\n            </a>\n            <a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n            <% } %>\n        </div>\n        <div class="sum-content">\n            <% if(hasData) {%>\n            <table>\n                <tbody>\n                    <% _.each(objProps, function(key) {%>\n                    <tr>\n                        <td><%= objPropsNames[key] %></td>\n                        <td class="value"><%- objSummaryData[key] %></td>\n                    </tr>\n                    <% }) %>\n                    <tr>\n                        <td><%= i18n.totalTime %></td>\n                        <td class="value"><span class="rep-time-data" data-value="<%= totalTime %>"><%= totalTimeS %></span></td>\n                    </tr><tr>\n                        <td><%= i18n.totalParkTime %></td>\n                        <td class="value"><span class="rep-time-data" data-value="<%= objSummaryData.totalParkTime %>"><%= totalParkTimeS %></span> (<%= totalParkTimePercent %>%)</td></tr><tr>\n                    </tr><tr>\n                        <td><%= i18n.totalMoveTime %></td>\n                        <td class="value"><span class="rep-time-data" data-value="<%= objSummaryData.totalMoveTime %>"><%= totalMoveTimeS %></span> (<%= totalMoveTimePercent %>%)</td>\n                    </tr><tr>\n                        <td><%= i18n.totalDistance %>, <%= i18n.km %></td>\n                        <td class="value"><%= totalDistanceS %></td>\n                    </tr><tr>\n                        <td><%= i18n.avgSpeed %>, <%= i18n.kmh %></td>\n                        <td class="value"><%= avgSpeedS %></td>\n                    </tr><tr>\n                        <td><%= i18n.calcConsumBy100kmNorm %>, <%= i18n.l %></td>\n                        <td class="value"><%= calcConsumBy100kmNorm %> (<%= objSummaryData.consum100km %> <%= i18n.l100km %>)</td>\n                    </tr><tr>\n                        <td><%= i18n.calcConsumBy1hNorm %>, <%= i18n.l %></td>\n                        <td class="value"><%= calcConsumBy1hNorm %> (<%= objSummaryData.consum1h %> <%= i18n.l1h %>)</td>\n                    </tr>\n                </tbody>\n            </table>\n            <% } else {%>\n            <p class="no-data"><%= i18n.noDataForObject %></p>\n            <% } %>\n        </div>\n    </td>\n</tr>'}),define("text!mobile/reports/movepark/tmpl/rowMove.html",[],function(){return'<tr class="row-move"<% if(isLast) {%> data-row="last"<% } %>>\n    <td><%= rowIndex %></td>\n    <td>\n        <a href="javascript:;" class="build-track-segment" data-id="<%= objectId %>" data-from="<%= start * App.MS %>" data-to="<%= end * App.MS %>">\n            <%= action %>\n        </a>\n    </td>\n    <td data-key="start" data-value="<%= start %>"><%= startS %></td>\n    <td data-key="end" data-value="<%= end %>"><%= endS %></td>\n    <td data-key="duration" data-value="<%= duration %>" class="rep-time-data"><%= durationS %></td>\n    <td data-key="avgSpeed" data-value="<%= avgSpeed %>"><%= avgSpeedS %></td>\n    <td data-key="distance" data-value="<%= distance %>"><%= distanceS %></td>\n</tr>'}),define("text!mobile/reports/movepark/tmpl/rowPark.html",[],function(){return'<tr class="row-park"<% if(isLast) {%> data-row="last"<% } %>>\n    <td><%= rowIndex %></td>\n    <td>\n        <a href="javascript:;" class="build-track-segment" data-id="<%= objectId %>" data-from="<%= start * App.MS %>" data-to="<%= end * App.MS %>">\n            <%= action %>\n        </a>\n    </td>\n    <td data-key="start" data-value="<%= start %>"><%= startS %></td>\n    <td data-key="end" data-value="<%= end %>"><%= endS %></td>\n    <td data-key="duration" data-value="<%= duration %>" class="rep-time-data"><%= durationS %></td>\n    <td colspan="<%= colspan ? 2 : 1%>" class="address" data-key="address" data-geoid="<%= geoId %>" data-lat="<%= lat %>" data-lon="<%= lon %>">\n        <% if(address) {print(address)} else { %>\n        <span class="loading-address" data-geoid="<%= geoId %>"><%= loadingAddress %></span>\n        <% } %>\n    </td>\n</tr>'}),define("mobile/reports/movepark/views/MoveparkReportView",["jquery","underscore","moment","_common/reports/views/ReportView","text!../tmpl/settings.html","text!../tmpl/moveparkTable.html","text!../tmpl/thead.html","text!_common/reports/tmpl/day.html","text!../tmpl/rowObject.html","text!../tmpl/rowMove.html","text!../tmpl/rowPark.html","text!_common/reports/tmpl/noDataRow.html"],function(e,t,n,a,s,r,i,o,d,l,m,c){s=t.template(s),r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d),m=t.template(m),l=t.template(l),c=t.template(c);var u=a.extend({constructor:function(){a.apply(this,arguments)},initialize:function(){a.prototype.initialize.apply(this,arguments)},render:function(){var t=this,n=new e.Deferred,i=this.model.getTexts();a.prototype.render.apply(this,arguments),this.$el.addClass("movepark-report").find(">.rep-header").addClass("append").append(s({i18n:i,timeFormat:this.model.getUserData("timeFormat")||"hms"}));var o=this.$el.find("select[name=repTimeUnits]");this.$el.find("select[name=repTimeUnits]").on("change",function(){var e=o.val();t.model.setUserData("timeFormat",e),o.parent().trigger("click"),h.switchTimeFormat.call(t,e)}),this.buildMetaInfo(),this.content.append(r({key:this.model.get("key"),theadHtml:""}));var d=this.content.find("tbody");return d.append(h.buildRows.call(this)),n.resolve(),n}}),h={buildRows:function(){for(var e,n,a,s=this,r=this.model.get("items"),u=this.model.get("footer"),h=this.model.get("header"),p=h.keyOrder,f=this.model.get("body"),g=this.model.getTexts(),v=0,b=0,y=0,w="",S=this.model.get("showParks"),x=this.model.get("showMoves"),k=S||x,D=!1,_=!1,T=0,j="",M={},C={},R={},I="",P=0,F=this.model.getUserData("timeFormat"),A=[],z=0,O=0,L=0,E=0,V="",U=this.model.get("properties"),N=t.indexOf(U,"name")>-1,B=t.indexOf(U,"extId")>-1,G=0,W=p.length;W>G;++G)e=p[G],""+e in f&&(n=t.findWhere(r,{id:e}),M=f[e],D=!1,I="",R=u[e],v=0,k&&t.each(M,function(e,a){if(y=t.keys(M).length,_=!1,a=Number(a),b=a*App.MS,T=0,I+=o({rowPosition:0===v?"first":"",colspan:x?7:6,dateStr:s.formatDate(a)+" ("+s.getDayOfWeek(a)+")",isWeekend:s.isWeekend(a)}),e){if(e.intervals&&e.intervals.length&&(_=!0),!_)return I+=c({isLast:y-1===v,text:g.noDataForDay,colspan:x?7:6}),v++,void 0;var r=!1,i=0;D=!0;for(var d=0,u=e.intervals.length;u>d;++d)C=e.intervals[d],C.start=Math.round(C.start),C.end=Math.round(C.end),L=C.start,P=C.end-C.start,E=C.end,V=s.formatTime(E),"00:00:00"==V&&(V="24:00:00"),C.distance>0?x&&(r=y-1==v&&(u-1==d||!S&&u-2==d),I+=l({rowIndex:++i,isLast:r,objectId:n.id,action:g.movement,start:L,startS:s.formatTime(C.start),end:E,endS:V,duration:P,durationS:Date.formatSeconds(P,!0,F),avgSpeed:C.avgSpeed,avgSpeedS:C.avgSpeed.toFixed(2),distance:C.distance,distanceS:s.formatDistance(C.distance)}),T++):S&&(C.address||A.push(C),r=y-1==v&&(u-1==d||!x&&u-2==d),I+=m({rowIndex:++i,isLast:r,colspan:x,objectId:n.id,action:g.park,start:L,startS:s.formatTime(L),end:E,endS:V,duration:P,durationS:Date.formatSeconds(P,!0,F),lon:C.lon,lat:C.lat,geoId:C.geoId,address:C.address?C.address:null,loadingAddress:g.loadingAddress}),T++);T||(I+=c({isLast:y-1==v,text:g.noDataForDay,colspan:x?7:6}))}else I+=c({isLast:y-1==v,text:g.noDataForDay,colspan:x?7:6});v++}),a=B&&N?n.name+" [#"+n.extId+"]":B?"#"+n.extId:n.name,C={title:a,hasData:D,objSummaryData:R,objProps:t.without(U,"name","extId"),objPropsNames:this.mobileProps,i18n:g},D&&(C.objectId=n.id,C.periodStart=h.sd*App.MS,C.periodEnd=h.ed*App.MS,C.totalTime=h.ed-h.sd,C.totalTimeS=Date.formatSeconds(C.totalTime,!0,F),C.totalParkTimeS=Date.formatSeconds(R.totalParkTime,!0,F),C.totalParkTimePercent=(100*R.totalParkTime/C.totalTime).toFixed(2),C.totalMoveTimeS=Date.formatSeconds(R.totalMoveTime,!0,F),C.totalMoveTimePercent=(100-parseFloat(C.totalParkTimePercent)).toFixed(2),C.totalDistanceS=R.totalDistance.toFixed(2),C.avgSpeedS=R.totalAvgSpeed.toFixed(2),C.calcConsumBy100kmNorm=R.totalConsum100km.toFixed(2),C.calcConsumBy1hNorm=R.totalConsum1h.toFixed(2)),C.colspan=x?7:6,j=d(C),D&&(O++,z=0),I=j+(D&&k?i({i18n:g,headIndex:O,rowspan:x&&S?2:1,showMoves:x,showParks:S}):"")+I,w+=I);return A.length&&this.listenTo(this.model,"afterrender",function(){s.model.searchAddresses(A)}),w},switchTimeFormat:function(t){this.$el.find(".rep-time-data").each(function(){var n=e(this),a=n.data("value")||0;a>0&&n.html(Date.formatSeconds(a,!0,t))})}};return u}),define("mobile/reports/movepark/MoveparkReport",["underscore","_common/tracks/TracksModule","_common/reports/Report","mobile/reports/movepark/views/MoveparkReportView"],function(e,t,n,a){var s=n.prototype,r=n.extend({url:App.getBaseUrl()+"reports/MOVEPARK/",defaults:e.extend({},n.prototype.defaults,{properties:["extId","name"],season:"auto"}),constructor:function(){this.addressesLoaded=!1,n.apply(this,arguments)},initialize:function(){this.makeTracksModule(t),s.initialize.call(this,a),this._prepareDeviceProperties(),this.has("source")||(this.setUserData("showMoves",this.get("showMoves")?1:0),this.setUserData("showParks",this.get("showParks")?1:0)),this.setUserData("season",this.get("season"))},getPostParams:function(){var e=s.getPostParams.call(this);return e.properties=this.get("properties"),e.showMoves=this.get("showMoves")?1:0,e.showParks=this.get("showParks")?1:0,e.season=this.get("season"),e},_prepareDeviceProperties:function(){var t=this.get("properties");"fake"===t?t=["extId","name"]:e.indexOf(t,"extId")<0&&e.indexOf(t,"name")<0&&(t=["extId","name"].concat(t)),this.set("properties",e.without(t,"fake")),this.setUserData("properties",this.get("properties"))}});return r}),define("_common/reports/objst/ObjstReport",["underscore","_common/reports/Report"],function(e,t){var n=t.extend({url:App.getBaseUrl()+"reports/OBJST/",constructor:function(){t.apply(this,arguments),this._jsonData=""},initialize:function(){t.prototype.initialize.call(this,this.getViewClass()),this.unset("startTime"),this.unset("endTime"),this.unset("timeFrom"),this.unset("timeTo"),this.unset("dateFrom"),this.unset("dateTo"),this.set("time",(new Date).getTime());var e=this.get("prop")||["extId"],n=this.get("sf")||[];e=[].concat(e),n=[].concat(n),this.set({time:(new Date).getTime(),prop:e,sf:n}),this.setUserData("prop",e),this.setUserData("sf",n)},getPostParams:function(){var n=t.prototype.getPostParams.call(this);return delete n.from,delete n.to,n.properties=[].concat(this.get("prop")?this.get("prop"):[]),n.stateFields=[].concat(this.get("sf")?this.get("sf"):[]),e.isString(n.properties)&&(n.properties=[n.properties]),e.isString(n.stateFields)&&(n.stateFields=[n.stateFields]),n},readyForExport:function(){return!1}});return n}),define("text!_common/reports/objst/tmpl/reportMeta.html",[],function(){return'<div class="rep-meta selectable">\n    <% if(!_.isUndefined(objectsList)) {%>\n    <%= objectsList %>\n    <% } %>\n\n    <p class="dates"><%= i18n.dataForDate.ucFirst() %>: <%= Date.format(i18n.DateTime.longFormat, time) %></p>\n    <%if(tzName) {%><p class="dates"><%= tzName %></p><% } %>\n    <p><%= i18n.nObjectsSelected[i18n.whichLabels(nbObjects)].replace(\'#n#\', nbObjects) %></p>\n\n</div>'}),define("text!_common/reports/objst/tmpl/controls.html",[],function(){return'<div class="rep-table-controls form-horizontal">\n    <% if(sortFields) { %>\n    <div class="control-group">\n        <label class="control-label"><%= i18n.sort %></label>\n        <select class="form-control" name="sort">\n            <% _.each(sortFields, function(key) {%>\n            <option value="<%= key %>"<% if(key == curSortField) {%> selected<% } %>><%= names[key] %></option>\n            <% }) %>\n        </select>\n        <select class="form-control" name="sortType">\n            <option value="asc"<% if(\'asc\' == curSortType) {%> selected<% } %>><%= i18n.sortTypeAsc %></option>\n            <option value="desc"<% if(\'desc\' == curSortType) {%> selected<% } %>><%= i18n.sortTypeDesc %></option>\n        </select>\n    </div>\n    <% } %>\n    <% if(groupFields) { %>\n    <div class="control-group">\n        <label class="control-label"><%= i18n.groupBy %></label>\n        <select class="form-control" name="group">\n            <option value=""><%= i18n.no.ucFirst() %></option>\n            <% _.each(groupFields, function(key) {%>\n            <option value="<%= key %>"<% if(key == curGroupField) {%> selected<% } %>><%= names[key] %></option>\n            <% }) %>\n        </select>\n    </div>\n    <% } %>\n</div>'}),define("text!_common/reports/objst/tmpl/thead.html",[],function(){return'<tr data-head="1">\n    <% for(var i = 0, l = fields.length; i < l; i++) { %>\n    <th data-key="<%= fields[i] %>"><%= names[fields[i]] %></th>\n    <% } %>\n</tr>'}),define("text!_common/reports/objst/tmpl/rowGroup.html",[],function(){return'<tr>\n    <td class="row-group" colspan="<%= colspan %>"><%= label %> (<%= nb %>)</td>\n</tr>'}),define("_common/reports/objst/views/ObjstReportView",["jquery","underscore","abstracts/Model","_common/reports/views/ReportView","text!_common/tmpl/itemsList.html","text!../tmpl/reportMeta.html","text!../tmpl/controls.html","text!_common/reports/tmpl/reportTable.html","text!../tmpl/thead.html","text!../tmpl/rowGroup.html"],function(e,t,n,a,s,r,i,o,d,l){s=t.template(s),r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d),l=t.template(l);var m=a.prototype,c=a.extend({constructor:function(){this.names={},this.fields={},this.hasControls=!1,this.sortFields={},this.curSortField=!1,this.curSortType="asc",this.groupFields={},this.curGroupField=!1,this.$tbody=null,a.apply(this,arguments)},initialize:function(){var e=this.model;this._setNames(),this._setStatusNames(),this.fields=t.union(e.get("prop")||[],e.get("sf")||[]),this._setGroupFields(),this._setSortFields();var n=this.sortFields;if(e.get("items").length>1&&(n.length||this.groupFields.length)){var a=e.get("sort");this.hasControls=!0,this.curSortField=n.indexOf(a)<0?n[0]:a}m.initialize.apply(this,arguments)},render:function(){var t=new e.Deferred,n=this.model,a=n.getTexts();m.render.apply(this,arguments),this.$el.addClass("objst-report"),this.buildMetaInfo();var s=this._renderRows();return s?(this.hasControls&&(this.content.append(this._renderControls()),this._initControls()),this.content.append(o({key:n.get("key"),theadHtml:""})),this.$tbody=this.content.find("tbody"),this.$tbody.append(s),this._makeExternalLinks.call(this,this.$tbody.find('td[data-key="comment"], td[data-key="extraHardware"]')),this.content.append(this._renderSummary())):this.content.append('<p class="no-data">'+a.noObjectsWithFaultsForReport+"<p>"),t.resolve(),t},buildMetaInfo:function(){if(this.content){var e=this.model.get("items"),t=this.model.getTexts();this.content.append(r({objectsList:s({items:e,i18n:t,limit:3}),nbObjects:e.length,time:this.model.get("time"),tzName:this._tzName,i18n:t}))}},_setNames:function(){var e=this.model.getTexts();this.names={extId:e.objIdNumber,name:e.objName,status:e.objStatus,shortDescription:e.description,address:e.address.ucFirst(),groups:e.objGroup,sim:e.simCard+" 1",sim1Provider:e.gsmProvider+" 1",sim2:e.simCard+" 2",sim2Provider:e.gsmProvider+" 2",pass:e.objServerPassword,imei:"IMEI",rev:e.rev,gsmTime:e.timeOfLastAlert,comment:e.comments.ucFirst(),extraHardware:e.objExtraHardware}},_setStatusNames:function(){var e=this.model.getTexts();this.statusNames={0:e.objNotServed,1:e.objServed,2:e.service,4:e.alertsControl}},_getStatusName:function(e){return this.statusNames&&this.statusNames[e]||""},_getGroupPossibleFields:function(){return["groups","sim1Provider","sim2Provider","rev"]},_setGroupFields:function(){var e=this.fields,t=this._getGroupPossibleFields(),n=[];t.forEach(function(t){-1!=e.indexOf(t)&&n.push(t)}),this.groupFields=n},_getSortPossibleFields:function(){return["extId","name","gsmTime","equipmentIds"]},_setSortFields:function(){var e=this.fields,t=this._getSortPossibleFields(),n=[];t.forEach(function(t){-1!=e.indexOf(t)&&n.push(t)}),this.sortFields=n},_getSelected:function(){return{}},_renderHead:function(){return d({i18n:this.model.getTexts(),fields:this.fields,names:this.names})},_renderControls:function(){var e=this.sortFields.length?this.sortFields:!1,t=this.groupFields.length?this.groupFields:!1,n=this.model.getTexts();return i({sortFields:e,curSortField:this.curSortField,curSortType:this.curSortType,groupFields:t,curGroupField:this.curGroupField,names:this.names,i18n:n})},_initControls:function(){var e=this,t=this.content.find("select[name=sort]"),n=this.content.find("select[name=sortType]"),a=this.content.find("select[name=group]");t.on("change",function(){e.curSortField=t.val(),e._rerender()}),n.on("change",function(){e.curSortType=n.val(),e._rerender()}),a.on("change",function(){e.curGroupField=a.val(),e._rerender()})},_rerender:function(){this.$tbody.html(this._renderRows()),this._makeExternalLinks.call(this,this.$tbody.find('td[data-key="comment"], td[data-key="extraHardware"]')),this._createHeaderClones()},_renderRows:function(){var e=this.model.get("body"),n=t.keys(e).length;if(!n)return!1;var a=this._renderHead(),s=0,r=this._groupAndSortData();if(this.curGroupField){var i=this.fields.length;t.each(r,function(e){a+=l({colspan:i,label:this._getGroupLabel(e.key),nb:e.rows.length}),a+=this._renderSortedRows(e.rows,function(){return++s==n})}.bind(this))}else a+=this._renderSortedRows(r,function(){return++s==n});return a},_getGroupLabel:function(e){return this.names[this.curGroupField]+": "+e},_renderSortedRows:function(){return""},_renderSummary:function(){return""},_groupAndSortData:function(){var e=this.model,n=e.get("body"),a=[];if(this.hasControls){var s=this.curSortField,r=this.curGroupField;if(r){var i,o={},d=this.model.getTexts(),l=[],m=d.noData.ucFirst();t.each(n,function(e){i=this._getGroupValue(e,r),i.length?(o[i]=o[i]||[],o[i].push(e)):l.push(e)}.bind(this)),t.each(o,function(e,t){a.push({key:t,rows:this._sortData(e,s)})}.bind(this)),a=t.sortBy(a,function(e){return e.key.toLowerCase()}),l.length&&a.push({key:m,rows:this._sortData(l,s)})}else a=this._sortData(n,s)}else{var c=e.get("header").keyOrder;t.each(c,function(e){a.push(n[e])})}return a},_getGroupValue:function(e,t){return t in e?String(e[t]).trim():""},_sortData:function(e,n){var a=t.sortBy(e,function(e){return this._getSortValue(e,n)}.bind(this));return"desc"==this.curSortType?a.reverse():a},_getSortValue:function(e,t){var n=e[t]||"",a=this.curSortType;switch(t){case"extId":n=parseInt(n);break;case"gpsTime":case"gsmTime":n=n||("asc"==a?+new Date(2200,0,1):-1);break;default:n=n.toLowerCase()}return n},_prepareRowData:function(e){return{fields:this.fields,obj:this._getSelected(e),rowClass:"",isLast:!1}},_makeExternalLinks:function(e){var n=/(https?:\/\/\S+)/gi,a=new RegExp("\\n","gi"),s='<a class="link" target="_blank" href="$1">$1</a>',r="<br/>";e.each(function(){var e=this.innerHTML.trim(),i=t.escape(e);i=i.replace(a,r),i=i.replace(n,s),this.innerHTML=i})}});return c}),define("text!mobile/reports/objst/tmpl/row.html",[],function(){return'<tr class="<%= rowClass %>"<% if(isLast) { %> data-row="last"<% } %>>\n<% for(var field in obj) { %>\n<td class="colObjst" data-key="<%= field %>" data-value="<%= obj[field] %>">\n    <% if(field == \'address\') { %>\n    <% if(obj.address) {print(obj.address)} else { %>\n    <span class="loading-address" data-geoid="<%= geoId %>"><%= loadingAddress %></span>\n    <% } %>\n    <% } else { print(obj[field]); } %>\n</td>\n<% } %>\n</tr>'
}),define("text!mobile/reports/objst/tmpl/summary.html",[],function(){return'<h3 class="report-objst-summary"><%= i18n.summary %></h3>\n<ul class="summary">\n    <% if(typeof data.gsm != \'undefined\'){ %>\n    <li class="summary-item">\n        <table>\n            <tr>\n                <td class="title" colspan="3"><%= i18n.objectReport.connection %></td>\n            </tr>\n            <tr>\n                <td class="summary-cell"><%= i18n.objectReport.set %></td>\n                <td class="summary-cell"><%= data.gsm %></td>\n                <td class="summary-cell"><%= Math.round( 100 * data.gsm / count ) %>%</td>\n            </tr>\n            <tr>\n                <td class="summary-cell"><%= i18n.objectReport.notSet %></td>\n                <td class="summary-cell"><%= count - data.gsm %></td>\n                <td class="summary-cell"><%= Math.round( 100 * (count - data.gsm) / count ) %>%</td>\n            </tr>\n        </table>\n    </li>\n    <% } %>\n\n    <% if(typeof data.gps != \'undefined\'){ %>\n    <li class="summary-item">\n        <table>\n            <tr>\n                <td class="title" colspan="3"><%= i18n.objectReport.coordinates %></td>\n            </tr>\n            <tr>\n                <td class="summary-cell"><%= i18n.objectReport.detected %></td>\n                <td class="summary-cell"><%= data.gps %></td>\n                <td class="summary-cell"><%= Math.round( 100 * data.gps / count ) %>%</td>\n            </tr>\n            <tr>\n                <td class="summary-cell"><%= i18n.objectReport.coordsNotDetected %></td>\n                <td class="summary-cell"><%= count - data.gps %></td>\n                <td class="summary-cell"><%= Math.round( 100 * (count -  data.gps) / count ) %>%</td>\n            </tr>\n        </table>\n    </li>\n    <% } %>\n\n    <% if(typeof data.power != \'undefined\'){ %>\n    <li class="summary-item">\n        <table>\n            <tr>\n                <td class="title" colspan="3"><%= i18n.objectReport.power %></td>\n            </tr>\n            <tr>\n                <td class="summary-cell"><%= i18n.normalValue %></td>\n                <td class="summary-cell"><%= data.power %></td>\n                <td class="summary-cell"><%= Math.round( 100 * data.power / count ) %>%</td>\n            </tr>\n            <tr>\n                <td class="summary-cell"><%= i18n.objectReport.no %></td>\n                <td class="summary-cell"><%= count - data.power %></td>\n                <td class="summary-cell"><%= Math.round( 100 * ( count - data.power ) / count ) %>%</td>\n            </tr>\n        </table>\n    </li>\n    <% } %>\n\n    <% if(typeof data.ign != \'undefined\'){ %>\n    <li class="summary-item">\n        <table>\n            <tr>\n                <td class="title" colspan="3"><%= i18n.objectReport.ignition %></td>\n            </tr>\n            <tr>\n                <td class="summary-cell"><%= i18n.objectReport.turnedOn %></td>\n                <td class="summary-cell"><%= data.ign %></td>\n                <td class="summary-cell"><%= Math.round( 100 * data.ign / count ) %>%</td>\n            </tr>\n            <tr>\n                <td class="summary-cell"><%= i18n.objectReport.turnedOff %></td>\n                <td class="summary-cell"><%= count - data.ign %></td>\n                <td class="summary-cell"><%= Math.round( 100 * (count - data.ign) / count ) %>%</td>\n            </tr>\n        </table>\n\n    </li>\n    <% } %>\n</ul>'}),define("mobile/reports/objst/views/ObjstReportView",["jquery","underscore","abstracts/Model","_common/reports/objst/views/ObjstReportView","text!mobile/reports/objst/tmpl/row.html","text!mobile/reports/objst/tmpl/summary.html"],function(e,t,n,a,s,r){s=t.template(s),r=t.template(r);var i=a.prototype,o=a.extend({constructor:function(){this._showAddress=!1,this._noAddressData={},a.apply(this,arguments)},render:function(){return this._showAddress=-1!=t.indexOf(this.fields,"address"),this.listenTo(this.model,"afterrender",function(){var e=Object.values(this._noAddressData);e.length&&this.model.searchAddresses(e)}),i.render.apply(this,arguments)},onAddressLoad:function(e,t){var n=this._noAddressData,a=t.geoId;return a&&a in n?(i.onAddressLoad.apply(this,arguments),n[a].address=e.address,delete n[a],void 0):!1},_setNames:function(){var e=this.model.getTexts();i._setNames.call(this),t.extend(this.names,{carId:e.licenseNumber,model:e.objModel,type:e.vehicleType,year:e.objYear,vin:e.objVin,color:e.color.ucFirst(),spd:e.speed.ucFirst(),rid:e.objTrackReading,gps:e.coords.ucFirst(),gpsTime:e.objectReport.coordinatesTime,gsm:e.connection.ucFirst(),gsmTime:e.objectReport.connectionTime,power:e.objectReport.power,ign:e.objectReport.ignition})},_getSelected:function(e){for(var t=this.fields,n={},a="",s=null,r=this.model.getTexts(),i=0,o=t.length;o>i;i++){switch(a=t[i],s=e[a],a){case"status":s=this._getStatusName(s);break;case"rid":var d=e.localRid,l=e.remoteRid,m=0;s=d+" "+r.from+" "+l,l>0&&(m=Math.round(100*d/l),s+=" ("+(m>100?100:m)+"%)");break;case"spd":s=s.toFixed(2)+" "+r.kmh;break;case"gsm":s=s?r.objectReport.set:r.objectReport.notSet;break;case"gsmTime":case"gpsTime":s=s?this.formatDateTime(s):r.objectReport.notSet;break;case"gps":s=s?r.objectReport.detected:r.objectReport.coordsNotDetected;break;case"power":s=s?r.objectReport.no:r.normalValue;break;case"ign":s=s?r.objectReport.turnedOn:r.objectReport.turnedOff}n[t[i]]=s}return n},_getSortValue:function(e,t){var n;switch(t){case"rid":var a=e.localRid,s=e.remoteRid;n=0,s>0&&(n=100*a/s);break;default:n=i._getSortValue.call(this,e,t)}return n},_getGroupPossibleFields:function(){return i._getGroupPossibleFields().concat(["model","type","year","color","gsm","gps","power","ign"])},_getSortPossibleFields:function(){return i._getSortPossibleFields().concat(["gpsTime","rid"])},_getGroupLabel:function(e){var t=i._getGroupLabel.call(this,e),n=this.curGroupField;if(/^(gsm|gps|power|ign)$/.test(n)){t=this.names[n]+": ";var a=this.model.getTexts(),s="";switch(n){case"gsm":s=1==e?a.objectReport.set:a.objectReport.notSet;break;case"gps":s=1==e?a.objectReport.detected:a.objectReport.coordsNotDetected;break;case"power":s=0==e?a.normalValue:a.objectReport.no;break;case"ign":s=1==e?a.objectReport.turnedOn:a.objectReport.turnedOff}t+=s}return t},_renderSortedRows:function(e,n){for(var a,r,i=this.model,o="",d=this._showAddress,l=i.getTexts().loadingAddress,m=[],c=0,u=e.length;u>c;++c)a=e[c],r=this._prepareRowData(a),r.isLast=n(),d&&!a.address&&a.geoId&&(m[a.geoId]=a,r.loadingAddress=l,r.geoId=a.geoId),o+=s(r);return t.extend(this._noAddressData,m),o},_rerender:function(){i._rerender.call(this);var e=Object.values(this._noAddressData);e.length&&this.model.searchAddresses(e)},_renderSummary:function(){var e=t.without([].concat(this.model.get("sf")),"spd","rid","address"),n=this.model.get("footer"),a="",s={};return e.length&&(-1!=t.indexOf(e,"gsm")&&(s.gsm=n.connected),-1!=t.indexOf(e,"gps")&&(s.gps=n.coordinatesFixed),-1!=t.indexOf(e,"power")&&(s.power=n.power),-1!=t.indexOf(e,"ign")&&(s.ign=n.ignition),a=r({data:s,i18n:this.model.getTexts(),width:100/e.length-.1,count:n.total})),a}});return o}),define("mobile/reports/objst/ObjstReport",["underscore","_common/reports/objst/ObjstReport","./views/ObjstReportView"],function(e,t,n){var a=t.prototype,s=t.extend({constructor:function(){t.apply(this,arguments)},initialize:function(){a.initialize.call(this),24*60*this.get("gsm_days")+60*this.get("gsm_hours")+this.get("gsm_minutes")<10&&(this.set("gsm_days",0),this.set("gsm_hours",0),this.set("gsm_minutes",10)),24*60*this.get("gps_days")+60*this.get("gps_hours")+this.get("gps_minutes")<10&&(this.set("gps_days",0),this.set("gps_hours",0),this.set("gps_minutes",10)),this.setUserData("noGsmMinutes",!!this.get("noGsmMinutes")),this.setUserData("gsm_days",this.get("gsm_days")),this.setUserData("gsm_hours",this.get("gsm_hours")),this.setUserData("gsm_minutes",this.get("gsm_minutes")),this.setUserData("noGpsMinutes",!!this.get("noGpsMinutes")),this.setUserData("gps_days",this.get("gps_days")),this.setUserData("gps_hours",this.get("gps_hours")),this.setUserData("gps_minutes",this.get("gps_minutes"))},getViewClass:function(){return n},getPostParams:function(){var t=a.getPostParams.call(this);return e.isString(this.get("noGsmMinutes"))&&(t.noGsmMinutes=24*60*this.get("gsm_days")+60*this.get("gsm_hours")+this.get("gsm_minutes"),t.noGsmMinutes=t.noGsmMinutes<10?10:t.noGsmMinutes),e.isString(this.get("noGpsMinutes"))&&(t.noGpsMinutes=24*60*this.get("gps_days")+60*this.get("gps_hours")+this.get("gps_minutes"),t.noGpsMinutes=t.noGpsMinutes<10?10:t.noGpsMinutes),t.objType=App.TYPE_MOBILE,t}});return s}),define("text!mobile/reports/pass/tmpl/passTable.html",[],function(){return'<table class="rep-table pass-rep-table">\n    <colgroup>\n        <col style="width: 25%"/>\n        <col/>\n        <col/>\n        <col/>\n        <col style="width: 15%"/>\n    </colgroup>\n    <thead>\n        <%= theadHtml %>\n    </thead>\n\n    <tbody>\n\n    </tbody>\n</table><!-- /run-rep-table -->'}),define("text!mobile/reports/pass/tmpl/thead.html",[],function(){return'<tr data-head="<%= headIndex %>">\n    <th><%= i18n.period.ucFirst() %></th>\n    <th><%= i18n.passQuantityExt %></th>\n    <th><%= i18n.moveTime %></th>\n    <th><%= i18n.parkTime %></th>\n    <th><%= i18n.runDistance %>, <%= i18n.km %></th>\n</tr>'}),define("text!mobile/reports/pass/tmpl/rowObject.html",[],function(){return'<tr class="obj">\n    <td colspan="5" class="summary">\n        <div class="sum-header">\n            <strong><%= title %></strong>\n            <% if(dist > 0) {%>\n            <a class="build-track nobr" href="javascript:;"\n               data-id="<%= id %>" data-from="<%= periodStart %>" data-to="<%= periodEnd %>" >\n                <%= i18n.showFullTrack %>\n            </a>\n            <a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n            <% } %>\n        </div>\n        <div class="sum-content">\n            <table>\n                <tbody>\n                    <tr>\n                        <td><%= i18n.moveTime %></td>\n                        <td class="value"><span class="rep-time-data" data-value="<%= moveTime %>"><%= moveTimeS %></span></td>\n                    </tr><tr>\n                        <td><%= i18n.parkTime %></td>\n                        <td class="value"><span class="rep-time-data" data-value="<%= parkTime %>"><%= parkTimeS %></span></td>\n                    </tr><tr>\n                        <td><%= i18n.runDistance %>, <%= i18n.km %></td>\n                        <td class="value"><span class="rep-time-data" data-value="<%= dist %>"><%= distS %></span></td>\n                    </tr><tr>\n                        <td><%= i18n.passQuantityExt %></td>\n                        <td class="value"><span class="rep-time-data" data-value="<%= pcount %>"><%= pcount %></span></td>\n                    </tr><tr>\n                        <td><%= i18n.passQuantity %></td>\n                        <td class="value"><span class="rep-time-data" data-value="<%= halfPcount %>"><%= Math.floor(halfPcount) %></span></td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n    </td>\n</tr>'}),define("text!mobile/reports/pass/tmpl/row.html",[],function(){return'<tr class="<%= rowClass %>"<% if(isLast) {%> data-row="last"<% } %>>\n    <td><%= period %></td>\n    <td><%= pcount %></td>\n    <td><%= moveTimeS %></td>\n    <td><%= parkTimeS %></td>\n    <td><%= distS %></td>\n</tr>'}),define("text!mobile/reports/pass/tmpl/subSummary.html",[],function(){return'<tr>\n    <th><%= i18n.sumPassQuantityExt %></th>\n    <th><%= pcount %></th>\n    <th colspan="2"><%= i18n.totalDistance %>, <%= i18n.km %></th>\n    <th><%= distS %></th>\n</tr>\n<tr<% if(isLast) {%> data-row="last"<% } %>>\n    <th><%= i18n.sumPassQuantity %></th>\n    <th><%= Math.floor(halfPcount) %></th>\n    <th colspan="3">&nbsp;</th>\n</tr>'}),define("mobile/reports/pass/views/PassReportView",["jquery","underscore","_common/reports/views/ReportView","text!../tmpl/passTable.html","text!../tmpl/thead.html","text!../tmpl/rowObject.html","text!_common/reports/tmpl/day.html","text!../tmpl/row.html","text!../tmpl/subSummary.html","text!_common/reports/tmpl/noDataRow.html"],function(e,t,n,a,s,r,i,o,d,l){var a=t.template(a),s=t.template(s),r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d),l=t.template(l),m=n.extend({constructor:function(){n.apply(this,arguments)},initialize:function(){n.prototype.initialize.apply(this,arguments)},render:function(){var t=new e.Deferred;this.$el.addClass("pass-report"),n.prototype.render.apply(this,arguments),this.buildMetaInfo(),this.content.append(a({key:this.model.get("key"),theadHtml:""}));var s=this.content.find("tbody");return s.append(c.buildRows.call(this)),t.resolve(),t}}),c={buildRows:function(){for(var e,n=this,a=this.model.get("header"),o=this.model.get("body"),m=this.model.get("split"),u=this.model.getTexts(),h="",p="",f={},g={},v="",b=0,y=0,w=0,S=o.length;S>w;++w){if(f=o[w],g=f.total,v="",e=t.extend({},g,{title:f.name+" [#"+f.extId+"]",id:f.id,i18n:u,periodStart:a.sd*App.MS,periodEnd:a.ed*App.MS,moveTimeS:Date.formatSeconds(g.moveTime),parkTimeS:Date.formatSeconds(g.parkTime),distS:this.formatDistance(g.dist)}),p=r(e),"none"!=m)if("intervals"in f||!f.intervals.length){if(v+=s({headIndex:++b,i18n:u}),"days"==m)v+=c.buildIntervalsRows.call(n,f.intervals,!0);else{y=0;var x=this.getDaysPeriods(a.sd,a.ed),k=t.keys(x).length;t.each(x,function(e){v+=i({colspan:5,dateStr:n.formatDate(e)+" ("+n.getDayOfWeek(e)+")",isWeekend:n.isWeekend(e)});var t=c.getDayIntervals.call(n,e,f.intervals);v+=c.buildIntervalsRows.call(n,t,++y==k)})}v+=d(t.extend({},f.total,{i18n:u,distS:this.formatDistance(f.total.dist),isLast:!0}))}else v=l({colspan:5,text:u.noData});h+=p+v}return h},getDayIntervals:function(e,n){e*=App.MS;var a=e+864e5,s=t.filter(n,function(t){return t.sd>=e&&t.ed<=a});return s},buildIntervalsRows:function(e){for(var t,n="",a=this.model.get("split"),s=!1,r="",i=0,d=e.length;d>i;++i)t=e[i],s=!1,"hours"==a&&(r=i==d-1?"24:00":this.formatUTC("HH:mm",t.ed)),n+=o({period:"days"==a?this.formatDate(new Date(t.sd)):this.formatUTC("HH:mm",t.sd)+" - "+r,pcount:t.pcount,moveTimeS:Date.formatSeconds(t.moveTime),parkTimeS:Date.formatSeconds(t.parkTime),distS:this.formatDistance(t.dist),rowClass:(i+1)%2?"":"even",isLast:s});return n}};return m}),define("mobile/reports/pass/PassReport",["underscore","_common/tracks/TracksModule","_common/reports/Report","./views/PassReportView"],function(e,t,n,a){var s=n.prototype,r=n.extend({url:App.getBaseUrl()+"reports/PASS/",constructor:function(){this.addressesLoaded=!1,n.apply(this,arguments)},defaults:e.extend({},s.defaults,{split:"none"}),initialize:function(){this.makeTracksModule(t),s.initialize.call(this,a),this.setUserData("split",this.get("split"))},getPostParams:function(){var e=s.getPostParams.call(this);return e.split=this.get("split"),e}});return r}),define("text!mobile/reports/run/tmpl/thead.html",[],function(){return'<tr data-head="<%= headPosition %>">\n    <% for(var i = 0, l = fields.length; i < l; i++) { %>\n    <th data-key="<%= fields[i] %>"><%= names[fields[i]] %></th>\n    <% } %>\n</tr>'}),define("text!mobile/reports/run/tmpl/row.html",[],function(){return'<tr<% if(isLast) {%> data-row="last"<% } %> data-index=<%= rowIndex %> class="<%= rowClass %>">\n<% for(var field in data) { %>\n<td data-key="<%= field %>">\n    <%= data[field] %>\n</td>\n<% } %>\n</tr>'}),define("text!mobile/reports/run/tmpl/summary.html",[],function(){return'<tr class="summary" data-row="last">\n    <td class="sum-header" colspan="<%= colspan %>">\n        <h3><%= i18n.summaryData %></h3>\n    </td>\n</tr>\n<%= theadHtml %>\n<%= rowsHtml %>'}),define("text!mobile/reports/run/tmpl/summaryConsumption.html",[],function(){return'<% if(consum100km !== null) {%>\n<tr class="summary" data-row="last">\n    <td colspan="<%= colspan %>" class="sum-header"><%= i18n.sumConsumBy100kmNorm %>:\n        <%= consum100km.toFixed(1) %> <%= i18n.l %></td>\n</tr>\n<% } %>\n<% if(consum1h !== null) {%>\n<tr class="summary">\n    <td colspan="<%= colspan %>" class="sum-header"><%= i18n.sumConsumBy1hNorm %>:\n        <%= consum1h.toFixed(1) %> <%= i18n.l %></td>\n</tr>\n<% } %>'}),define("mobile/reports/run/views/RunReportView",["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/run/tmpl/thead.html","text!_common/reports/tmpl/day.html","text!mobile/reports/run/tmpl/row.html","text!_common/reports/tmpl/noDataRow.html","text!mobile/reports/run/tmpl/summary.html","text!mobile/reports/run/tmpl/summaryConsumption.html"],function(e,t,n,a,s,r,i,o,d,l){s=t.template(s),i=t.template(i),r=t.template(r),o=t.template(o),d=t.template(d);var m=n.extend({constructor:function(){this.names={},this.fields=[],this._periods={},this._noAddressData=[],n.apply(this,arguments)},render:function(){var r=new e.Deferred,i=this.model.getTexts();this.names=t.extend({},this.mobileProps,{distance:i.runDistance+", "+i.km,moveStart:i.moveStart,moveStartPlace:i.moveStartPlace,moveEnd:i.moveEnd,moveEndPlace:i.moveEndPlace,moveTime:i.moveTime,parkTime:i.parkTime,avgSpeed:i.avgSpeed+", "+i.kmh,consum100km:i.calcConsumBy100kmNorm+", "+i.l,consum1h:i.calcConsumBy1hNorm+", "+i.l}),this.fields=t.union(this.model.get("properties"),["distance"],this.model.get("params")),n.prototype.render.apply(this,arguments),this.$el.addClass("run-report"),this.buildMetaInfo();var o="";this.model.get("showDetails")?(this.content.append(t.template(a,{key:this.model.get("key"),theadHtml:""})),o+=s({i18n:i,names:this.names,fields:this.fields,headPosition:1})+c.buildRows.call(this)):this.content.append(t.template(a,{key:this.model.get("key")})),o+=d({i18n:i,colspan:this.fields.length,theadHtml:s({i18n:i,names:this.names,fields:this.fields,headPosition:2}),rowsHtml:c.buildSummaryRows.call(this)});var l=this,m=this.content.find("tbody");return m.append(o),this._noAddressData.length&&this.listenTo(this.model,"afterrender",function(){l.model.searchAddresses(l._noAddressData)}),r.resolve(),r}}),c={buildRows:function(){var e,n,a,s=this,d=this.model.get("header"),l=d.keyOrder,m=this.model.get("body"),u="",h="",p=this.model.getTexts(),f=0,g=0;return this._periods=this.getDaysPeriods(d.sd,d.ed),t.each(this._periods,function(t,v){u+=r({colspan:s.fields.length,dateStr:s.formatDate(t)+" ("+s.getDayOfWeek(t)+")",isWeekend:s.isWeekend(t)}),h="";for(var b,y,w=0,S=0,x=l.length;x>S;++S)b=l[S],y=m[b],v in y&&(f=Math.max(t,d.sd)*App.MS,g=Math.min(t+86400,d.ed)*App.MS,e=y[v],n=c.getSelected.call(s,y,e,f,g),"moveStart"in n&&(n.moveStart=e.moveStart>0?s.formatTime(e.moveStart):"--"),"moveEnd"in n&&(e.moveEnd>0?(n.moveEnd=s.formatTime(e.moveEnd),"00:00:00"==n.moveEnd&&(n.moveEnd="24:00:00")):n.moveEnd="--"),a={data:n,rowIndex:w,rowClass:++w%2?"odd":"even",isLast:!1},h+=i(a));h||(h=o({text:p.noDataForDay,colspan:s.fields.length})),u+=h}),u},getSelected:function(e,n,a,s){var r=this.fields,i=this.model.getTexts(),o=this.model.get("header"),d={},l="",m=null,c=0;"moveTime"in n?c=100*n.moveTime/n.fullTime:"parkTime"in n&&(c=100*(n.fullTime-n.parkTime)/n.fullTime);for(var u=0,h=r.length;h>u;u++){switch(l=r[u],m=l in n?n[l]:l in e?e[l]:"TODO",l){case"distance":m=App.reportAllowedByType("MOVEPARK")?'<a href="#" class="build-another" data-type="movepark" title="'+i.build.ucFirst()+" "+i.reportsNames.movepark+'"'+' data-id="'+e.id+'"'+' data-from="'+a+'"'+' data-to="'+s+'">'+this.formatDistance(m)+"</a>":this.formatDistance(m);break;case"moveTime":m=n.moveStart>0&&n.moveEnd>0?Date.formatSeconds(n.moveTime)+" ("+c.toFixed(2)+"%)":Date.formatSeconds(0)+" (0%)";break;case"parkTime":m=n.moveStart>0&&n.moveEnd>0?Date.formatSeconds(n.parkTime)+" ("+(100-c).toFixed(2)+"%)":Date.formatSeconds((Math.min(a+86400*App.MS,o.ed*App.MS)-a)/App.MS)+" (100%)";break;case"avgSpd":m=m.toFixed(2)+" "+i.kmh;break;case"moveStartPlace":case"moveEndPlace":l+"GeoId"in n?l in n&&n[l]||(m='<span class="loading-address" data-geoid="'+n[l+"GeoId"]+'">'+i.loadingAddress+"</span>",this._noAddressData.push({geoId:n[l+"GeoId"],lat:n[l+"Lat"],lon:n[l+"Lon"]})):m="--";break;default:m=t.escape(m)}d[r[u]]=m}return d},buildSummaryRows:function(){for(var e,n,a,s=this.model.getTexts(),r=this.model.get("header"),o=r.keyOrder,d=this.model.get("body"),m=this.model.get("footer"),u="",h={},p=0,f=0,g=0,v=0,b=-1!=t.indexOf(this.fields,"consum100km"),y=-1!=t.indexOf(this.fields,"consum1h"),w=0,S=o.length;S>w;++w)e=o[w],n=m[e],h=d[""+e],v=100*n.moveTime/n.fullTime,a=c.getSelected.call(this,h,n,r.sd*App.MS,r.ed*App.MS),"moveStart"in a&&(a.moveStart=n.moveStart>0?this.formatDate(n.moveStart)+" "+this.formatTime(n.moveStart):"--"),"moveEnd"in a&&(n.moveEnd>0?(a.moveEnd=this.formatDate(n.moveEnd)+" "+this.formatTime(n.moveEnd),"00:00:00"==a.moveEnd&&(a.moveEnd="24:00:00")):a.moveEnd="--"),"parkTime"in a&&!n.moveEnd&&!n.moveStart&&(a.parkTime=Date.formatSeconds(r.ed-r.sd)+" (100%)"),b&&(f+=n.consum100km),y&&(g+=n.consum1h),u+=i({data:a,rowIndex:p,rowClass:++p%2?"odd":"even",isLast:p==S});return(b||y)&&(u+=t.template(l,{i18n:s,colspan:this.fields.length,consum100km:b?f:null,consum1h:y?g:null})),u}};return m}),define("mobile/reports/run/RunReport",["underscore","_common/reports/Report","mobile/reports/run/views/RunReportView"],function(e,t,n){var a=t.extend({url:App.getBaseUrl()+"reports/RUN/",constructor:function(){t.apply(this,arguments)},defaults:e.extend({},t.prototype.defaults,{properties:["extId","name"],params:["moveStartEndTime","moveTime","parkTime","avgSpeed"],season:"auto"}),initialize:function(){t.prototype.initialize.call(this,n);var a=this.get("params");this._prepareDeviceProperties(),"fake"===a?this.set("params",[]):(a=e.without(a,"fake"),this.set("params",a)),this.setUserData("params",a),this.setUserData("season",this.get("season")),this.setUserData("showDetails",this.get("showDetails")?1:0);var s=e.indexOf(a,"moveStartEndTime"),r=e.indexOf(a,"moveStartEndPlace");s>-1?r>-1?(a.splice(r,1),a.splice(s,1,"moveStart","moveStartPlace","moveEnd","moveEndPlace")):a.splice(s,1,"moveStart","moveEnd"):r>-1&&a.splice(r,1,"moveStartPlace","moveEndPlace")},getPostParams:function(){var e=t.prototype.getPostParams.call(this);return e.properties=this.get("properties"),e.params=this.get("params"),e.season=this.get("season"),this.get("showDetails")||(e.hideDetails=1),e}});return a}),define("text!mobile/reports/runshort/tmpl/thead.html",[],function(){return'<tr data-head="1">\n    <th><%= dayAndObject %></th>\n    <% _.each(names, function(name) {%>\n    <th scope="col"><%- name %></th>\n    <% }) %>\n    <th><%= summary %></th>\n</tr>'}),define("text!mobile/reports/runshort/tmpl/row.html",[],function(){return'<tr class="day <% if(isWeekend) {%>weekend <% } %>">\n    <td><%= dateStr %></td>\n    <% _.each(data, function(distance) {%>\n    <td data-value="<%= distance %>"><%= distance %></td>\n    <% }) %>\n    <td data-value="<%= sum %>"><%= sum %></td>\n</tr>'}),define("text!mobile/reports/runshort/tmpl/summaryRow.html",[],function(){return'<tr class="summary" data-row="last">\n    <th><%= runDistance %></th>\n    <% var total = 0.00, rounded = 0.00;\n    _.each(data, function(objData) { rounded = Math._round(objData.distance, 2); total+= rounded %>\n    <th scope="col" data-value="<%= objData.distance %>"><%= rounded %></th>\n    <% }) %>\n    <th data-value="<%= total %>"><%= Math._round(total, 2) %></th>\n</tr>'}),define("mobile/reports/runshort/views/RunshortReportView",["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/runshort/tmpl/thead.html","text!mobile/reports/runshort/tmpl/row.html","text!mobile/reports/runshort/tmpl/summaryRow.html"],function(e,t,n,a,s,r,i){s=t.template(s),r=t.template(r),i=t.template(i);var o=n.extend({constructor:function(){n.apply(this,arguments)},render:function(){var r=new e.Deferred,i=this.model.getTexts();n.prototype.render.apply(this,arguments),this.$el.addClass("report-wide run-report run-short-report"),this.buildMetaInfo();var o="",l=this.model.get("header").keyOrder,m=l.length,c=this.model.get("body");this.content.append(t.template(a,{key:this.model.get("key"),theadHtml:""}));for(var u=new Array(m),h=0;m>h;++h)u[h]=c[l[h]].name;o+=s({dayAndObject:i.dayAndObject,summary:i.summaryByDay,names:u})+d.buildRows.call(this),o+=d.buildSummaryRows.call(this);var p=this.content.find("tbody");return p.append(o),this._prepareWideReportFixedHeader(),r.resolve(),r}}),d={buildRows:function(){for(var e,n,a=this,s=this.model.getTexts(),i=this.model.get("header"),o=i.keyOrder,d=this.model.get("body"),l="",m={},c={},u=this.getDaysPeriods(i.sd,i.ed),h=0,p=o.length;p>h;++h)e=o[h],n=d[e],t.each(u,function(e,t){if(m[t]=m[t]||[],c[t]=c[t]||0,t in n){var r=n[t];m[t].push(a.formatDistance(r.distance)),c[t]+=r.distance}else m[t].push(s.noData)});return t.each(c,function(e,t){c[t]=a.formatDistance(e)}),t.each(u,function(e,t){l+=r({dateStr:a.formatDate(e),isWeekend:a.isWeekend(e),data:m[t],sum:c[t]})}),l},buildSummaryRows:function(){for(var e=this.model.get("footer"),t=this.model.get("header").keyOrder,n=[],a=0,s=t.length;s>a;++a)n[a]=e[t[a]];return i({runDistance:this.model.getTexts().summaryByObject,data:n})}};return o}),define("mobile/reports/runshort/RunshortReport",["underscore","_common/reports/Report","mobile/reports/runshort/views/RunshortReportView"],function(e,t,n){var a=t.extend({url:App.getBaseUrl()+"reports/RUNMINI/",constructor:function(){t.apply(this,arguments)},initialize:function(){t.prototype.initialize.call(this,n)},exportTo:function(){var e=250,n=this.get("items").length;return n>e?(new $.Deferred).reject(this.getTexts().errMaxObjectsForExport.replace("#max#",e).replace("#t#",n)):t.prototype.exportTo.apply(this,arguments)}});return a}),define("text!mobile/reports/speeding1b/tmpl/thead.html",[],function(){return'<tr data-head="<%= headIndex %>">\n    <th data-key="date"><%= i18n.date.ucFirst() %></th>\n    <th data-key="begin"><%= i18n.exceedStart %></th>\n    <th data-key="speed"><%= i18n.maxSpeed %>, <span class="nobr"><%= i18n.kmh %></span></th>\n    <th data-key="speed"><%= i18n.speedLimitExt %>, <span class="nobr"><%= i18n.kmh %></span></th>\n    <th data-key="speed"><%= i18n.exceedValue %>, <span class="nobr"><%= i18n.kmh %></span></th>\n    <th data-key="duration"><%= i18n.actionTime %></th>\n    <th data-key="distance"><%= i18n.runDistance %>, <%= i18n.km %></th>\n    <th data-key="address"><%= i18n.placeOfMax %></th>\n</tr>'}),define("text!mobile/reports/speeding1b/tmpl/rowObject.html",[],function(){return'<tr class="obj">\n    <td colspan="<%= colspan %>" class="summary">\n        <div class="sum-header">\n            <% if(App.reportAllowedByType(\'MOVEPARK\')) {%>\n            <a href="javascript:;" title="<%= i18n.build.ucFirst() + \' \' + i18n.reportsNames.movepark %>" class="build-another" data-type="movepark"\n               data-id="<%= id %>" data-from="<%= periodStart %>" data-to="<%= periodEnd %>">\n                <strong><%- name %> (#<%- extId %>)</strong>\n            </a>\n            <% } else { %>\n            <strong><%- name %> (#<%- extId %>)</strong>\n            <% } %>\n\n            <a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n        </div>\n        <div class="sum-content">\n            <% if(hasData) {%>\n            <table>\n                <tbody>\n                <tr>\n                    <td>\n                        <%= totalB2 !== false ? i18n.totalB1Exceeds : i18n.totalSpeedLimitExceeds %>\n                    </td>\n                    <td class="value"><%= totalB1 %></td>\n                </tr>\n                <% if(totalB2 !== false) {%><tr>\n                    <td><%= i18n.totalB2Exceeds %> <span class="nobr">(<%= limits[1] + \' \' + i18n.kmh %>)</span></td>\n                    <td class="value"><%= totalB2 %></td></tr><tr>\n                </tr>\n                <% } %>\n                </tbody>\n            </table>\n            <% } else {%>\n            <p class="no-data"><%= i18n.noDataForObject %></p>\n            <% } %>\n        </div>\n    </td>\n</tr>'}),define("text!mobile/reports/speeding1b/tmpl/row.html",[],function(){return'<tr class="<%= rowClass %>"<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <td data-value="<%= date %>"><%= dateS %></td>\n    <td data-value="<%= begin %>"><%= beginS %></td>\n    <td data-value="<%= speed %>"><%= speedS %></td>\n    <td data-value="<%= speedLimit %>"><%= speedLimit %></td>\n    <td data-value="<%= exceedValue %>"><%= exceedValue %></td>\n    <td data-key="duration" data-value="<%= duration %>"><%= durationS %></td>\n    <td data-key="distance" data-value="<%= distance %>"><%= distanceS %></td>\n    <td class="address text-left" data-key="address" data-geoid="<%= geoId %>" data-lat="<%= lat %>" data-lon="<%= lon %>">\n        <a href="javascript:;" class="build-track-segment" data-id="<%= objectId %>" data-from="<%= begin*1000 %>" data-to="<%= end*1000 %>">\n            <% if(typeof address != \'undefined\' && address) {print(address)} else { %>\n            <span class="loading-address" data-geoid="<%= geoId %>"><%= loadingAddress %></span>\n            <% } %>\n        </a>\n    </td>\n</tr>'}),define("text!mobile/reports/speeding1b/tmpl/rowNoObjectData.html",[],function(){return'<tr>\n    <td colspan="<%= colspan %>" class="no-data text-left"><%= i18n.noDataForObject %></td>\n</tr>'}),define("text!mobile/reports/speeding1b/tmpl/rowNoExceeds.html",[],function(){return'<tr>\n    <td colspan="<%= colspan %>" class="text-left"><%= i18n.noSpeedExceeds %></td>\n</tr>'}),define("text!mobile/reports/speeding1b/tmpl/summary.html",[],function(){return'<div class="summary">\n    <h3 class="sum-header"><%= i18n.summaryData %></h3>\n    <div class="sum-content">\n        <table class="rep-table">\n\n            <tr data-head="<%= headIndex %>">\n                <% _.each(props, function(prop) {%>\n                <th data-key="<%= prop %>"><%= propNames[prop] %></th>\n                <% }) %>\n                <th><%= i18n.totalSpeedLimitExceeds %></th>\n            </tr>\n\n            <%= rowsHtml %>\n\n        </table>\n    </div>\n</div>'}),define("text!mobile/reports/speeding1b/tmpl/summaryRow.html",[],function(){return'<tr<% if(isLast) {%> data-row="last"<% } %>>\n    <% _.each(props, function(prop) {%>\n    <td class="text-center"><%= prop in data ? data[prop] : \'\' %></td>\n    <% }) %>\n<% if(\'undefined\' != typeof data.total) {%>\n<td class="text-center"><%= data.total %></td>\n    <% } else { %>\n    <td colspan="2" class="no-data text-center"><%= i18n.noDataForObject %></td>\n    <% } %>\n</tr>\n'}),define("mobile/reports/speeding1b/views/Speeding1bReportView",["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!../tmpl/thead.html","text!_common/reports/tmpl/day.html","text!../tmpl/rowObject.html","text!../tmpl/row.html","text!../tmpl/rowNoObjectData.html","text!../tmpl/rowNoExceeds.html","text!../tmpl/summary.html","text!../tmpl/summaryRow.html"],function(e,t,n,a,s,r,i,o,d,l,m,c){var u=n.prototype;s=t.template(s),o=t.template(o),r=t.template(r),i=t.template(i),d=t.template(d),l=t.template(l),m=t.template(m),c=t.template(c);var h=n.extend({constructor:function(){this._headIndex=0,this._singleThreshold=!0,this._totalSpeedingsByObject=null,n.apply(this,arguments)},render:function(){var n=new e.Deferred;if(u.render.apply(this,arguments),this.$el.addClass("speed-report"),this.buildMetaInfo(),this.model.get("showDetails")){this.content.append(t.template(a,{key:this.model.get("key"),theadHtml:""}));var s=this.content.find("tbody"),r=p.buildRows.call(this);s.append(r)}return this.content.append(p.buildSummary.call(this)),n.resolve(),n},_renderSummaryRow:function(e){return c(e)
},_renderSummary:function(e){return m(e)}}),p={buildRows:function(){var e,n,a=this,m=this.model,c="speeding"===m.get("type"),u=m.get("items"),h=m.get("header"),p=h.keyOrder,f={},g=m.get("body"),v={},b=!1,y=8,w="",S="",x=this.model.getTexts(),k=0,D=0,_=0,T=0,j=this.model.getSpeedLimits(),M=[],C={},R=this.getDaysPeriods(h.sd,h.ed);return t.each(R,function(R,I){S+=r({colspan:y,dateStr:a.formatDate(R)+" ("+a.getDayOfWeek(R)+")",isWeekend:a.isWeekend(R)});for(var P=0,F=p.length;F>P;++P)if(n=p[P],""+n in g){if(e=t.findWhere(u,{id:n}),v=g[n],v=g[""+n],f=a.model.get("footer")[""+n],b=!1,w="",k=0,_=0,T=0,C[n]=C[n]||0,I in v)if(b=!0,"speedings"in v[I]&&v[I].speedings.length){var A=v[I].speedings,z=A.length;C[n]+=z,w+=s({i18n:x,headIndex:++a._headIndex}),t.each(A,function(e,t){if(e.address||M.push(e),e.objectId=n,e.date=R,e.dateS=a.formatDate(e.date),e.beginS=a.formatTime(e.begin),e.duration=e.end-e.begin,e.durationS=Date.formatSeconds(e.duration),e.distanceS=a.formatDistance(e.distance/1e3),e.speedS=e.speed.toFixed(2),e.rowClass=(++k%2?"odd":"even")+" alert"+e.exceededLimit,e.loadingAddress=x.loadingAddress,e.rowPosition=t===z-1?"last":"",c){var s=2===e.exceededLimit?m.get("b2"):m.get("b1");e.speedLimit=s,e.exceedValue=e.speed-s}2===e.exceededLimit?T++:_++,w+=o(e)})}else w+=l({colspan:y,i18n:x});else w+=d({colspan:y,i18n:x});D=Math.max(R,h.sd)*App.MS,S+=i({i18n:x,hasData:b,colspan:y,id:n,extId:e.extId,name:e.name,periodStart:D,periodEnd:Math.min(D+864e5,h.ed*App.MS),totalB1:_,totalB2:a._singleThreshold?!1:T,limits:j}),S+=w}}),M.length&&this.listenTo(this.model,"afterrender",function(){a.model.searchAddresses(M)}),this._totalSpeedingsByObject=C,S},buildSummary:function(){for(var e,n,a=this,s=this.model,r=s.getTexts(),i=s.get("items"),o=s.get("footer"),d=s.get("header").keyOrder,l=s.get("properties"),m={i18n:r,rowsHtml:"",headIndex:++this._headIndex,props:l,propNames:this.mobileProps},c=0,u=d.length;u>c;++c)e=d[c],""+e in o?(n=o[""+e],s.has("minExceedValue")?n.total=this._totalSpeedingsByObject[e]:"exceed_b1"in n&&(n.total=n.exceed_b1)):n=t.findWhere(i,{id:e}),m.rowsHtml+=this._renderSummaryRow({props:l,data:n,isLast:c===u-1});return m.limits=a.model.getSpeedLimits(),this._renderSummary(m)}};return h}),define("mobile/reports/speeding1b/Speeding1bReport",["_common/reports/Report","_common/tracks/TracksModule","./views/Speeding1bReportView","mobile/reports/drivesafety/DrivesafetyMapMatchingReport"],function(e,t,n,a){var s=e.prototype,r=e.extend({url:App.getBaseUrl()+"reports/SPEEDING1B/",constructor:function(){this.addressesLoaded=!0,e.apply(this,arguments)},initialize:function(e,r){this.makeTracksModule(t);var i=null;if(s.initialize.call(this,r||n),this.has("source")&&(i=this.get("module").items.get(this.get("source"))),i)i instanceof a&&this.set({properties:i.get("properties"),zoneId:i.get("zoneId"),mintime:i.get("speedingMintime"),showDetails:!0});else{this._prepareDeviceProperties();var o=this.get("mintime");0>=o&&this.set("mintime",20),this.setUserData("b1",this.get("b1")),this.setUserData("zoneId",this.get("zoneId")),this.setUserData("mintime",this.get("mintime")),this.setUserData("showDetails",this.get("showDetails")?1:0)}},getSpeedLimits:function(){var e,t=[];if(e=this.getUserData("b1"))t=[e];else{var n=this.get("module").getSpeedLimits();t=[n[0]]}return t},getPostParams:function(){var e=s.getPostParams.call(this);if(e.properties=this.get("properties"),this.has("minExceedValue")){var t=this.get("minExceedValue"),n=this.get("maxExceedValue")||1e4,a=this.get("isPercents");e.r1=t,e.r2=n,e.isPercents=a?1:0}else{var r=this.getSpeedLimits();e.b1=r[0]}return e.mintime=this.get("mintime"),e.zoneId=this.get("zoneId"),e.zoneId||0===e.zoneId||"0"===e.zoneId||delete e.zoneId,this.get("showDetails")||(e.hideDetails=1),e}});return r}),define("text!mobile/reports/speeding/tmpl/summary.html",[],function(){return'<div class="summary">\n    <h3 class="sum-header"><%= i18n.summaryData %></h3>\n    <div class="sum-content">\n        <table class="rep-table">\n\n            <tr data-head="<%= headIndex %>">\n                <% _.each(props, function(prop) {%>\n                <th data-key="<%= prop %>"><%= propNames[prop] %></th>\n                <% }) %>\n                <th><%= i18n.totalB1Exceeds %> <span class="nobr">(<%= limits[0] + \' \' + i18n.kmh %>)</span></th>\n                <th><%= i18n.totalB2Exceeds %> <span class="nobr">(<%= limits[1] + \' \' + i18n.kmh %>)</span></th>\n            </tr>\n\n            <%= rowsHtml %>\n\n        </table>\n    </div>\n</div>'}),define("text!mobile/reports/speeding/tmpl/summaryRow.html",[],function(){return'<tr<% if(isLast) {%> data-row="last"<% } %>>\n    <% _.each(props, function(prop) {%>\n    <td class="text-center"><%= prop in data ? data[prop] : \'\' %></td>\n    <% }) %>\n    <% if(\'undefined\' != typeof data.exceed_b1 && \'undefined\' != typeof data.exceed_b2) {%>\n    <td class="text-center"><%= data.exceed_b1 %></td>\n    <td class="text-center"><%= data.exceed_b2 %></td>\n    <% } else { %>\n    <td colspan="2" class="no-data text-center"><%= i18n.noDataForObject %></td>\n    <% } %>\n</tr>'}),define("mobile/reports/speeding/views/SpeedingReportView",["jquery","underscore","mobile/reports/speeding1b/views/Speeding1bReportView","text!../tmpl/summary.html","text!../tmpl/summaryRow.html"],function(e,t,n,a,s){a=t.template(a),s=t.template(s);var r=n.prototype,i=n.extend({constructor:function(){n.apply(this,arguments)},initialize:function(){this._singleThreshold=!1,r.initialize.apply(this,arguments)},_renderSummaryRow:function(e){return s(e)},_renderSummary:function(e){return a(e)}});return i}),define("mobile/reports/speeding/SpeedingReport",["mobile/reports/speeding1b/Speeding1bReport","./views/SpeedingReportView"],function(e,t){var n=e.prototype,a=e.extend({url:App.getBaseUrl()+"reports/SPEEDING/",constructor:function(){e.apply(this,arguments)},initialize:function(e){n.initialize.call(this,e,t),this.setUserData("b2",this.get("b2"))},getSpeedLimits:function(){var e,t;return(e=this.getUserData("b1"))&&(t=this.getUserData("b2"))?[e,t]:this.get("module").getSpeedLimits()},getPostParams:function(){var e=n.getPostParams.call(this),t=this.getSpeedLimits();return e.b2=t[1],e}});return a}),define("text!mobile/reports/zoneviz/tmpl/thead.html",[],function(){return'<tr data-head="1">\n    <th data-key="zone"><%= i18n.geozone.ucFirst() %></th>\n    <th data-key="numberzonevisit"><%= i18n.zoneReport.numberZoneVisit %></th>\n    <th data-key="object"><%= i18n.object.ucFirst() %></th>\n    <th data-key="numberobjectvisit"><%= i18n.zoneReport.numberCurrentObjVisit %></th>\n    <th data-key="timeenter"><%= i18n.zoneReport.enterTime %></th>\n    <th data-key="timeexit"><%= i18n.zoneReport.exitTime %></th>\n    <th data-key="timeinzome"><%= i18n.zoneReport.timeInZone %></th>\n    <th data-key="runbetweenzoneenters"><%= i18n.zoneReport.runBetweenZoneEnters %></th>\n</tr>'}),define("text!mobile/reports/zoneviz/tmpl/row.html",[],function(){return'<tr<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <% if(index == 0) { %>\n    <td rowspan="<%= count %>" class="text-left no-select">\n        <a data-geozoneid="<%= zoneId %>" href="#"><%- zone %></a>\n    </td>\n    <% } %>\n    <td data-key="numberzonevisit" data-value="<%= numberzonevisit %>"><%= numberzonevisit %></td>\n    <td data-key="object" data-value="<%= object %>"><%= object %></td>\n    <td data-key="numberobjectvisit" data-value="<%= numberobjectvisit %>"><%= numberobjectvisit %></td>\n    <td data-key="timeenter" data-value="<%= timeenter %>"><%= timeenter %></td>\n    <td data-key="timeexit" data-value="<%= timeexit %>"><%= timeexit %></td>\n    <td data-key="timeinzome" data-value="<%= timeinzome %>"><%= timeinzome %></td>\n    <td data-key="runbetweenzoneenters" data-value="<%= runbetweenzoneenters %>"><%= runbetweenzoneenters %></td>\n</tr>'}),define("text!mobile/reports/zoneviz/tmpl/rowEmpty.html",[],function(){return'<tr<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <td class="text-left no-select">\n        <a data-geozoneid="<%= zoneId %>" href="#"><%- zone %></a>\n    </td>\n    <td colspan="7"><%= text %></td>\n</tr>'}),define("text!mobile/reports/zoneviz/tmpl/summaryTable.html",[],function(){return'<table class="selectable rep-table zoneviz-rep-table">\n    <thead>\n        <tr>\n            <th colspan="9" class="text-left"><%= i18n.summaryData %></th>\n        </tr>\n        <tr>\n            <th data-key="zone"><%= i18n.geozone.ucFirst() %></th>\n            <th data-key="object"><%= i18n.object.ucFirst() %></th>\n            <th data-key="visitCount"><%= i18n.zoneReport.visitsCount %></th>\n            <th data-key="timeinzone"><%= i18n.zoneReport.timeInZone %></th>\n            <th data-key="timeoutzone"><%= i18n.zoneReport.timeOutZone %></th>\n            <th data-key="runinzone"><%= i18n.zoneReport.runInZone %></th>\n            <th data-key="runoutzone"><%= i18n.zoneReport.runOutZone %></th>\n            <th data-key="firstenter"><%= i18n.zoneReport.firstEnter %></th>\n            <th data-key="lastexit"><%= i18n.zoneReport.lastExit %></th>\n        </tr>\n    </thead>\n    <tbody>\n        <%= body %>\n    </tbody>\n</table>'}),define("text!mobile/reports/zoneviz/tmpl/summaryRow.html",[],function(){return'<tr>\n    <% if(index == 0) { %>\n    <td rowspan="<%= count %>" class="text-left no-select">\n        <a data-geozoneid="<%= zoneId %>" href="#"><%- zone %></a>\n    </td>\n    <% } %>\n    <td data-key="object" data-value="<%= object %>"><%= object %></td>\n    <td data-key="visitCount" data-value="<%= visitcount %>"><%= visitcount %></td>\n    <td data-key="timeinzone" data-value="<%= timeinzone %>"><%= timeinzone %></td>\n    <td data-key="timeoutzone" data-value="<%= timeoutzone %>"><%= timeoutzone %></td>\n    <td data-key="runinzone" data-value="<%= runinzone %>"><%= runinzone %></td>\n    <td data-key="runoutzone" data-value="<%= runoutzone %>"><%= runoutzone %></td>\n    <td data-key="firstenter" data-value="<%= firstenter %>"><%= firstenter %></td>\n    <td data-key="lastexit" data-value="<%= lastexit %>"><%= lastexit %></td>\n</tr>'}),define("mobile/reports/zoneviz/views/ZonevizReportView",["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/zoneviz/tmpl/thead.html","text!_common/reports/tmpl/day.html","text!mobile/reports/zoneviz/tmpl/row.html","text!mobile/reports/zoneviz/tmpl/rowEmpty.html","text!mobile/reports/zoneviz/tmpl/summaryTable.html","text!mobile/reports/zoneviz/tmpl/summaryRow.html"],function(e,t,n,a,s,r,i,o,d,l){function m(e){for(var t={},n=e.length;n--;){var a=e[n],s=a.sd;"undefined"==typeof t[s]&&(t[s]=[]),t[s].push(a)}return t}r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d),l=t.template(l);var c=n.extend({FIX_HEADER:1,constructor:function(){n.apply(this,arguments)},initialize:function(){n.prototype.initialize.apply(this,arguments)},render:function(){var a=new e.Deferred;n.prototype.render.apply(this,arguments),this.$el.addClass("zones-report"),this.buildMetaInfo(),this.content.append(t.template(this.getTableTemplate(),{key:this.model.get("key"),theadHtml:""}));var s=this.content.find("tbody"),r=t.template(this.getTHeadTemplate(),{i18n:this.model.getTexts()})+this.buildRowsHtml();return s.append(r),this.content.append(this.buildSummaryTable()),a.resolve(),a},buildRowsHtml:function(){return u.buildRows.call(this)},buildSummaryTable:function(){return u.buildSummaryTable.call(this)},getTHeadTemplate:function(){return s},getTableTemplate:function(){return a}}),u={buildRows:function(){var e=this,n=this.model.getTexts(),a=this.model.get("header"),s=this.model.get("body"),d=(this.getDaysPeriods(a.sd,a.ed),""),l=null,c=0,u=function(t){var n,a=e.model.get("footer");for(var s in a){var r=a[s];if(r.zoneId==t){if(n=r.visits[0],""!=n.inTime&&""!=n.outTime)return-1;if(""==n.inTime&&""!=n.outTime)return 0;if(""!=n.inTime&&""==n.outTime)return 1}}},h=m(s),p=0,f=t.keys(h).length;for(var g in h){p++;var v=h[g],b=g instanceof Date?g:g*App.MS,y=(g instanceof Date?g.getTime():b)/App.MS;d+=r({colspan:8,dateStr:e.formatDate(y)+" ("+e.getDayOfWeek(y)+")",isWeekend:e.isWeekend(y)}),t.each(v,function(a){if(0==a.visits.length){var s,r=u(a.zoneId);-1==r?s=n.objectInZoneUndefined:1==r?s=n.objectInZoneTrue:0==r&&(s=n.objectInZoneFalse),d+=o({zone:a.zoneName,zoneId:a.zoneId,text:s,rowPosition:f==p?"last":""})}else l=[],c=0,t.each(t.pluck(a.visits,"vizits"),t.bind(function(e){l=l.concat(e)},e)),t.each(a.visits,t.bind(function(s){t.each(s.vizits,t.bind(function(t){d+=i({zone:a.zoneName,zoneId:a.zoneId,numberzonevisit:t.zoneVizit,object:s.name,numberobjectvisit:t.objectVizit,timeenter:t["in"]?e.formatDateTime(t["in"]):"-",timeexit:t.out?e.formatDateTime(t.out):"-",timeinzome:Date.formatSeconds(t.dur,!0),runbetweenzoneenters:t.distFromLast+" "+n.km,index:c,count:l.length,rowPosition:f==p&&c==l.length-1?"last":""}),++c},e))},e))})}return d},buildSummaryTable:function(){var e,n=this.model.getTexts(),a=this.model.get("footer"),s="";return t.each(a,t.bind(function(a){t.each(a.visits,t.bind(function(t,r){e="total"==t.name?n.totalLabel:t.name,s+=l({zone:a.zoneName,zoneId:a.zoneId,object:e,visitcount:t.count,timeinzone:Date.formatSeconds(t.inTime,!0),timeoutzone:Date.formatSeconds(t.outTime,!0),runinzone:t.distIn+" "+n.km,runoutzone:t.distOut+" "+n.km,firstenter:t.firstInTime?this.formatDateTime(t.firstInTime):"-",lastexit:t.lastOutTime?this.formatDateTime(t.lastOutTime):"-",count:a.visits.length,index:r})},this))},this)),d({i18n:n,body:s})}};return c}),define("mobile/reports/zoneviz/ZonevizReport",["underscore","_common/reports/Report","mobile/reports/zoneviz/views/ZonevizReportView"],function(e,t,n){var a=t.extend({type:"zoneviz",url:function(e){var t="ZONEVIZ";return"zoneex"!=this.type||"pdf"!=e&&"xls"!=e||(t="ZONEEX"),App.getBaseUrl()+"reports/"+t+"/"},constructor:function(){t.apply(this,arguments)},initialize:function(){t.prototype.initialize.call(this,n)},getPostParams:function(){var e=t.prototype.getPostParams.call(this);return e.zoneId=this.get("zoneId"),e}});return a}),define("text!mobile/reports/zoneex/tmpl/thead.html",[],function(){return'<tr data-head="1">\n    <th data-key="zone"><%= i18n.geozone.ucFirst() %></th>\n    <th data-key="numberzonevisit"><%= i18n.zoneReport.numberZoneVisit %></th>\n    <th data-key="object"><%= i18n.object.ucFirst() %></th>\n    <th data-key="numberobjectvisit"><%= i18n.zoneReport.numberCurrentObjVisit %></th>\n    <th data-key="timeexit"><%= i18n.zoneReport.exitTime %></th>\n</tr>'}),define("text!mobile/reports/zoneex/tmpl/row.html",[],function(){return'<tr<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <% if(index == 0) { %>\n    <td rowspan="<%= count %>" class="text-left no-select">\n        <a data-geozoneid="<%= zoneId %>" href="#"><%- zone %></a>\n    </td>\n    <% } %>\n    <td data-key="numberzonevisit" data-value="<%= numberzonevisit %>"><%= numberzonevisit %></td>\n    <td data-key="object" data-value="<%= object %>"><%= object %></td>\n    <td data-key="numberobjectvisit" data-value="<%= numberobjectvisit %>"><%= numberobjectvisit %></td>\n    <td data-key="timeexit" data-value="<%= timeexit %>"><%= timeexit %></td>\n</tr>'}),define("text!mobile/reports/zoneex/tmpl/summaryTable.html",[],function(){return'<table class="selectable rep-table zoneviz-rep-table">\n    <thead>\n        <tr>\n            <th colspan="6" class="text-left"><%= i18n.summaryData %></th>\n        </tr>\n        <tr>\n            <th data-key="zone"><%= i18n.geozone.ucFirst() %></th>\n            <th data-key="object"><%= i18n.object.ucFirst() %></th>\n            <th data-key="visitCount"><%= i18n.zoneReport.visitsCount %></th>\n            <th data-key="timeinzone"><%= i18n.zoneReport.timeInZone %></th>\n            <th data-key="runinzone"><%= i18n.zoneReport.runInZone %></th>\n            <th data-key="lastexit"><%= i18n.zoneReport.lastExit %></th>\n        </tr>\n    </thead>\n    <tbody>\n        <%= body %>\n    </tbody>\n</table>'}),define("text!mobile/reports/zoneex/tmpl/summaryRow.html",[],function(){return'<tr>\n    <% if(index == 0) { %>\n    <td rowspan="<%= count %>" class="text-left no-select">\n        <a data-geozoneid="<%= zoneId %>" href="#"><%- zone %></a>\n    </td>\n    <% } %>\n    <td data-key="object" data-value="<%= object %>"><%= object %></td>\n    <td data-key="visitCount" data-value="<%= visitcount %>"><%= visitcount %></td>\n    <td data-key="timeinzone" data-value="<%= timeinzone %>"><%= timeinzone %></td>\n    <td data-key="runinzone" data-value="<%= runinzone %>"><%= runinzone %></td>\n    <td data-key="lastexit" data-value="<%= lastexit %>"><%= lastexit %></td>\n</tr>'}),define("text!mobile/reports/zoneex/tmpl/rowEmpty.html",[],function(){return'<tr<% if(typeof rowPosition != \'undefined\') { %> data-row="<%= rowPosition %>"<% } %>>\n    <td colspan="5"><%= i18n.noData %></td>\n</tr>'}),define("mobile/reports/zoneex/views/ZoneexReportView",["jquery","underscore","mobile/reports/zoneviz/views/ZonevizReportView","text!_common/reports/tmpl/reportTable.html","text!mobile/reports/zoneex/tmpl/thead.html","text!_common/reports/tmpl/day.html","text!mobile/reports/zoneex/tmpl/row.html","text!mobile/reports/zoneex/tmpl/summaryTable.html","text!mobile/reports/zoneex/tmpl/summaryRow.html","text!mobile/reports/zoneex/tmpl/rowEmpty.html"],function(e,t,n,a,s,r,i,d,l,m){r=t.template(r),i=t.template(i),l=t.template(l),m=t.template(m);var c=n.extend({FIX_HEADER:1,constructor:function(){n.apply(this,arguments)},buildRowsHtml:function(){return u.buildRows.call(this)},buildSummaryTable:function(){return u.buildSummaryTable.call(this)},getTHeadTemplate:function(){return s},getTableTemplate:function(){return a}}),u={buildRows:function(){var e=this.model.getTexts(),n=this.model.get("header"),a=this.model.get("body"),s=this.getDaysPeriods(n.sd,n.ed),o=t.keys(s).length,d="",l=null,c=0,u=0;return t.each(s,t.bind(function(n){var s=t.filter(a,function(e){return e.sd>=n&&e.ed<=n+86400&&e.visits.length});d+=r({colspan:5,dateStr:this.formatDate(n)+" ("+this.getDayOfWeek(n)+")",isWeekend:this.isWeekend(n)}),s.length?t.each(s,t.bind(function(e){l=[],c=0,t.each(t.pluck(e.visits,"vizits"),t.bind(function(e){l=l.concat(e)},this)),t.each(e.visits,t.bind(function(n){t.each(n.vizits,t.bind(function(t){d+=i({zone:e.zoneName,zoneId:e.zoneId,numberzonevisit:t.zoneVizit,object:n.name,numberobjectvisit:t.objectVizit,timeexit:t.out?this.formatTime(t.out):"-",index:c,count:l.length,rowPosition:l.length==c-1&&o==u-1?"last":""}),++c},this))},this))},this)):d+=m({i18n:e,rowPosition:o-1==u?"last":""}),u++},this)),d},buildSummaryTable:function(){var e=this.model.getTexts(),n=this.model.get("footer"),a="";return t.each(n,t.bind(function(n){t.each(n.visits,t.bind(function(t,s){o="total"==t.name?e.totalLabel:t.name,a+=l({zone:n.zoneName,zoneId:n.zoneId,object:o,visitcount:t.count,timeinzone:Date.formatSeconds(t.inTime,!0),runinzone:t.distIn+" "+e.km,lastexit:t.lastOutTime?this.formatDateTime(t.lastOutTime):"-",count:n.visits.length,index:s})},this))},this)),t.template(d,{i18n:e,body:a})}};return c}),define("mobile/reports/zoneex/ZoneexReport",["underscore","_common/reports/Report","mobile/reports/zoneviz/ZonevizReport","mobile/reports/zoneex/views/ZoneexReportView"],function(e,t,n,a){var s=n.extend({type:"zoneex",constructor:function(){n.apply(this,arguments)},initialize:function(){t.prototype.initialize.call(this,a)}});return s}),define("mobile/reports/alertssummary/views/AlertssummaryReportView",["_common/reports/alertssummary/views/AlertssummaryReportView"],function(e){var t=e.extend({constructor:function(){e.apply(this,arguments)}});return t}),define("mobile/reports/alertssummary/AlertssummaryReport",["underscore","_common/reports/alertssummary/AlertssummaryReport","mobile/reports/alertssummary/views/AlertssummaryReportView"],function(e,t,n){var a=t.extend({constructor:function(){t.apply(this,arguments)},initialize:function(){t.prototype.initialize.call(this,n)}});return a}),define("text!_common/reports/alerts/tmpl/thead.html",[],function(){return'<tr data-head="<%= headPosition %>">\n    <th data-key="alertTs"><%= i18n.timeOfCreation %></th>\n    <th data-key="receivedAt"><%= i18n.timeOfReceive %></th>\n    <th data-key="code"><%= i18n.alertCode %></th>\n    <th data-key="message"><%= i18n.alert.ucFirst() %></th>\n    <th data-key="group"><%= i18n.alertsGroup %></th>\n    <th data-key="areaZone"><%= i18n.objZoneKey %></th>\n    <th data-key="areaZoneName"><%= i18n.objZoneKeyName %></th>\n    <th data-key="area"><%= i18n.objArea %></th>\n    <th data-key="areaName"><%= i18n.objAreaName %></th>\n    <th data-key="channelName"><%= i18n.inputStream %></th>\n</tr>'}),define("text!_common/reports/alerts/tmpl/row.html",[],function(){return'<tr<% if(isLast) {%> data-row="last"<% } %>>\n    <td data-key="alertTs" data-value="<%= alertTs %>"><%= alertTsS %></td>\n    <td data-key="receivedAt" data-value="<%= receivedAt %>"><%= receivedAtS %></td>\n    <td data-key="code"><%= code %></td>\n    <td data-key="message" class="text-left"><%- message %></td>\n    <td data-key="group"><%= \'undefined\' != typeof group && group ? group : \'-\' %></td>\n    <td data-key="areaZone"><%= \'undefined\' != typeof areaZone ? areaZone : \'-\' %></td>\n    <td data-key="areaZoneName"><%= \'undefined\' != typeof areaZoneName && areaZoneName ? areaZoneName : \'-\' %></td>\n    <td data-key="area"><%= \'undefined\' != typeof area ? area : \'-\' %></td>\n    <td data-key="areaName"><%= \'undefined\' != typeof areaName && areaName ? areaName : \'-\' %></td>\n    <td data-key="channelName"><%= \'undefined\' != typeof channelName && channelName ? channelName : \'-\' %></td>\n</tr>'}),define("text!_common/reports/alerts/tmpl/rowObject.html",[],function(){return"<tr class=\"obj\">\n    <td colspan=\"<%= colspan %>\" class=\"summary\">\n        <div class=\"sum-content\">\n            <% if(groups.length) {%>\n                <%= i18n['selectedAlertGroup' + ( groups.length == 1 ? '' : 's' )] %>:\n                <strong><%= groups.join(', ').toLowerCase().ucFirst() %></strong>\n\n                <br /><%= i18n[alarms ? ( alerts ? 'totalAlertsAndAlarms' : 'totalAlarms' ) : 'totalAlerts'] %>:\n                <strong><%= total %></strong>\n            <% } else { %>\n                <%= i18n.noSelectedAlertGroups %>\n            <% } %>\n        </div>\n    </td>\n</tr>"}),define("_common/reports/alerts/views/AlertsReportView",["jquery","underscore","../../views/ReportView","text!../../tmpl/reportTable.html","text!../tmpl/thead.html","text!../../tmpl/day.html","text!../tmpl/row.html","text!../tmpl/rowObject.html","text!../../tmpl/noDataRow.html"],function(e,t,n,a,s,r,i,o,d){a=t.template(a),s=t.template(s),r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d);var l=1,m=n.extend({FIX_HEADER:1,render:function(){var t=new e.Deferred;n.prototype.render.apply(this,arguments),this.$el.addClass("alerts-report"),this.buildMetaInfo(),this.content.append(a({key:this.model.get("key"),theadHtml:'<colgroup><col style="width:9%"><col style="width:9%"><col style="width:8%"><col style="width:22%"><col style="width:9%"><col style="width:7%"><col style="width:9%"><col style="width:8%"><col style="width:10%"><col style="width:9%"></colgroup>'}));var s=this.content.find("tbody");return s.append(this._buildRows()),t.resolve(),t},_buildRows:function(){for(var e,n,a=this,m=this.model.getTexts(),c="",u=this.model.get("body"),h=this.model.get("footer"),p=this.model.get("header"),f=p.keyOrder,g=this.model.get("alertGroupId"),v=g.length?t.pluck(p.groups,"name"):[],b=-1!=t.indexOf(g,l),y=[],w=0,S="",x=0,k={},D=0,_=[],T=0,j=null,M=10,C=0,R=f.length;R>C;++C)if(e=f[C],n=u[e],j=h[e],c+=o({i18n:m,colspan:M,groups:v,alarms:b,alerts:b&&v.length>1||!b&&v.length,total:j.alerts+j.alarms}),v.length){c+=s({i18n:m,headPosition:++D}),y=t.filter(t.keys(n),function(e){return!t.isNaN(Number(e))});for(var I=y.length;I--;)if(S=y[I],x=Number(S),c+=r({rowPosition:0==w++?"first":"",colspan:M,dateStr:a.formatDate(x)+" ("+a.getDayOfWeek(x)+")",isWeekend:a.isWeekend(x)}),S in n&&"alerts"in n[S]&&n[S].alerts.length){_=n[S].alerts,T=_.length;for(var P=0;T>P;++P)k=_[P],k.alertTsS=a.formatTime(k.alertTs),k.receivedAtS=a.formatTime(k.receivedAt),k.isLast=y.length==w&&P==T-1,c+=i(k)}else c+=d({rowPosition:y.length-1==w?"last":0,text:m.noDataForDay,colspan:M})}return c}});return m}),define("mobile/reports/alerts/views/AlertsReportView",["_common/reports/alerts/views/AlertsReportView"],function(e){var t=e.extend({constructor:function(){e.apply(this,arguments)},initialize:function(){e.prototype.initialize.apply(this,arguments)}});return t}),define("mobile/reports/alerts/AlertsReport",["underscore","_common/reports/alerts/AlertsReport","./views/AlertsReportView"],function(e,t,n){var a=t.extend({constructor:function(){t.apply(this,arguments)},initialize:function(){t.prototype.initialize.call(this,n)}});return a}),define("_common/reports/ParameterReport",["underscore","./Report","_common/tracks/TracksModule"],function(e,t,n){var a=t.prototype,s=t.extend({constructor:function(){this.addressesLoaded=!1,t.apply(this,arguments)},defaults:e.extend({},a.defaults,{properties:["extId","name"],min:-200,max:-200,mintime:300,thresholds:[],showDetails:!1,rangesOfInterest:null,minStep:1,koef:1}),initialize:function(t){this.makeTracksModule(n),a.initialize.call(this,t);var s=this,r=null;1==this.get("items").length&&this.set("showDetails",!0),this.has("source")&&(r=this.get("module").items.get(this.get("source"))),r?this.set(r.pick("minutes","seconds","mintime","thresholds","properties")):this.has("minutes")&&this.has("seconds")&&this.set("mintime",60*this.get("minutes")+this.get("seconds"));var i=this.get("properties");if("fake"===i?this.set("properties",["extId"]):this.set("properties",e.without(i,"fake")),e.each(["mintime","properties"],function(e){s.setUserData(e,s.get(e))}),this.has("dataSource")){r&&this.set("dataSource",r.get("dataSource"));var o=this.get("dataSource");this.setUserData("dataSource",o),this.setUserData(o+".thresholds",this.get("thresholds"))}else s.setUserData("thresholds",s.get("thresholds"))},getPostParams:function(){var t=a.getPostParams.call(this);return e.extend(t,this.pick("properties","mintime")),t.thresholds=this.get("thresholds").slice(0),this.get("showDetails")||(t.hideDetails=1),this.has("rangesOfInterest")&&(t.rangesOfInterest=this.get("rangesOfInterest")),t}});return s}),define("_common/reports/temperature/TemperatureReport",["underscore","_common/reports/ParameterReport"],function(e,t){var n=t.prototype,a=t.extend({url:function(){return App.getBaseUrl()+"reports/"+this.get("dataSource")+"/"},constructor:function(){t.apply(this,arguments)},defaults:e.extend({},n.defaults,{dataSource:"DEVTEMP",min:-50,max:120,thresholds:[-40,85]}),getPostParams:function(){var e=n.getPostParams.call(this);return e.thresholds[0]-=.001,e.thresholds[1]+=.001,e}});return a}),define("text!_common/reports/tmpl/paramsReportSummary.html",[],function(){return'<table class="rep-table">\n    <tr class="summary">\n        <td class="sum-header" colspan="<%= colspan %>">\n            <h3><%= summaryTitle %></h3>\n        </td>\n    </tr>\n    <%= theadHtml %>\n    <%= rowsHtml %>\n</table>\n'}),define("text!_common/reports/tmpl/paramsReportSummaryRow.html",[],function(){return'<tr<% if(isLast) {%> data-row="last"<% } %> data-index=<%= rowIndex %> class="<%= rowClass %>">\n<% for(var field in properties) { %>\n<td data-key="<%= field %>">\n    <%- properties[field] %>\n</td>\n<% } %>\n<td class="count">\n    <% if(hasData) {%>\n    <a href="#" class="build-another" data-type="<%= type %>"\n       title="<%= i18n.build.ucFirst()+\' \'+i18n.reportsNames[type] %>"\n       data-id="<%= id %>"\n       data-from="<%= anotherStart %>"\n       data-to="<%= anotherEnd %>"\n       data-ranges="[0]">\n       <%= violation.count.below %></a>\n    <% } else {%>\n    <%= noData %>\n    <% } %>\n</td>\n<td class="count">\n    <% if(hasData) {%>\n    <a href="#" class="build-another" data-type="<%= type %>"\n       title="<%= i18n.build.ucFirst()+\' \'+i18n.reportsNames[type] %>"\n       data-id="<%= id %>"\n       data-from="<%= anotherStart %>"\n       data-to="<%= anotherEnd %>"\n       data-ranges="[2]">\n        <%= violation.count.above %></a>\n    <% } else {%>\n    <%= noData %>\n    <% } %>\n</td>\n<td><%= hasData ? violationTime : noData %></td>\n<td>\n    <% if(hasData) {%>\n    <%= violationDist %>\n    <% } else {%>\n    <%= noData %>\n    <% } %>\n</td>\n<td class="<% if(hasData && min < thresholds[0]) {%> low<% } %>"><%= hasData ? min : noData %></td>\n<td class="<% if(hasData && max > thresholds[1]) {%> high<% } %>"><%= hasData ? max : noData %></td>\n</tr>'}),define("text!_common/reports/tmpl/paramsReportChart.html",[],function(){return"<div class=\"rep-chart clearfix<% if('undefined' != typeof addClass){ print(' ' + addClass) }%>\"\n    <% if('undefined' != typeof data) { _.each(data, function(value, key){ print('data-' + key+'=\"' + value + '\"') })}%>>\n    <div<% if('undefined' != typeof id){ print(' id=\"'+ id + '\"') }%> class=\"chart-content\"></div>\n</div>"}),define("text!_common/reports/tmpl/paramsReportRow.html",[],function(){return'<tr class="<%= rowClass %>"<% if(isLast) { %> data-row="last"<% } %>>\n<td><%= dateS %></td>\n<td><%= startS %></td>\n<td><%= endS %></td>\n<td><%= value %></td>\n<td><%= avgValue %></td>\n<td><%= timeS %></td>\n<td><%= distS %></td>\n<td class="address text-left" data-key="address" data-geoid="<%= geoId %>" data-lat="<%= lat %>" data-lon="<%= lon %>">\n    <% if(end - start > 0) {%>\n    <a href="#" class="build-track-segment" data-id="<%= id %>" data-from="<%= start %>" data-to="<%= end %>">\n        <% if(typeof address != \'undefined\' && address) {print(address)} else { %>\n        <span class="loading-address" data-geoid="<%= geoId %>"><%= loadingAddress %></span>\n        <% } %>\n    </a>\n    <% } else { %>\n        <% if(typeof address != \'undefined\' && address) {print(address)} else { %>\n        <span class="loading-address" data-geoid="<%= geoId %>"><%= loadingAddress %></span>\n        <% } %>\n    <% } %>\n</td>\n</tr>'}),define("_common/reports/views/ParameterReportView",["jquery","underscore","./ReportView","_libs/charts/Chart","text!../tmpl/paramsReportSummary.html","text!../tmpl/paramsReportSummaryRow.html","text!../tmpl/reportTable.html","text!../tmpl/paramsReportChart.html","text!../tmpl/paramsReportRow.html","_libs/charts/ragAndFunnel/ragAndFunnel","css!_libs/charts/ragAndFunnel/ragAndFunnel.css"],function(e,t,n,a,s,r,i,o,d){var l=n.prototype,m=650;s=t.template(s),r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d);var c=n.extend({constructor:function(){this._noAddressData=[],this._unit="",this._noFactsTxt="",n.apply(this,arguments)},CHARTS_WIDTH_PADDING:10,render:function(){var t=this,n="";if(this.$el.addClass("parameter-report "+this.model.get("type")+"-report"),l.render.apply(this,arguments),this.buildMetaInfo(),this.model.get("showDetails"))for(var s,r=this.model.get("header"),i=r.keyOrder,o=this.model.get("body"),d=0,m=i.length;m>d;++d)s=i[d],n=this._renderDeviceSummary(o[s]),n+=this._renderCharts(o[s]),n+=this._renderDeviceRows(o[s]);else n=this._renderSummary();this.content.append(n),this.model.get("showDetails")&&(this.listenTo(App,"layoutchange",function(e){e&&t._resizeCharts(e)}).listenTo(this.model,"remove",function(){t.stopListening(App),t.$el.find("div.chart-content").each(function(){a.destroy(e(this))})}),this.content.find(".rep-chart").one("chart.show",function(){var n=e(this),a=n.data("id"),s=t.model.get("body"),r=n.hasClass("rag-chart")?"_buildRagChart":"_buildTimeChart";s[a]&&t[r].call(t,s[a],n)}).filter(".rag-chart").on("chart.show chart.hide",function(){t._resizeCharts(t.$el.width())}),this.content.find(".chart-switcher").on("click",function(){var t=e(this),n=t.closest(".charts-group");
if(n.length){var a=t.data("index"),s=n.find(".rep-chart[data-index="+a+"]");s.is(".closed")?(s.removeClass("closed").trigger("chart.show"),this.className=this.className.replace(" s"," h")):(s.addClass("closed").trigger("chart.hide"),this.className=this.className.replace(" h"," s"))}return!1}).end().find(".rag-chart").on("click",".high, .low",function(){t._loadFacts(-1==this.className.indexOf("low")?2:0,e(this).closest(".rep-chart").data("id"))}).end().find("a[data-range]").on("click",function(){var n=e(this);return t._loadFacts(n.data("range"),n.data("id")),!1}))},buildMetaInfo:function(){var e=this.model.getTexts(),t=this._getDataSourcesNames(),n=this.model.get("dataSource"),a=this._getMetaTmpl();l.buildMetaInfo.call(this);var s=a({dataSource:t[n],thresholds:this.model.get("thresholds"),minutes:this.model.get("minutes"),seconds:this.model.get("seconds"),i18n:e});this.content.find(".rep-meta").append(s)},_getMetaTmpl:function(){return null},_getSummaryTheadTmpl:function(){return null},_getSelectedProperties:function(e){for(var t=this.model.get("properties"),n={},a="",s="",r=0,i=t.length;i>r;r++)a=t[r],s=a in e?e[a]:"TODO",n[a]=s;return n},_renderSummary:function(){var e=this.model.getTexts(),t=this.model.get("thresholds"),n=this._renderSummaryRows(),a=this._getSummaryTheadTmpl(),r=this.model.get("properties"),i=s({i18n:e,summaryTitle:this._getSummaryTitle(),colspan:this._getSummaryColspan(),theadHtml:a({i18n:e,names:this.mobileProps,properties:r,thresholds:t,headPosition:1}),rowsHtml:n});return i},_getSummaryColspan:function(){return this.model.get("properties").length+6},_renderSummaryRows:function(){for(var e,n,a,s,r=this.model.getTexts(),i=this.model.get("header"),o=i.sd*App.MS,d=i.ed*App.MS,l=i.keyOrder,m=this.model.get("body"),c=this.model.get("thresholds"),u="",h={},p=0,f=this._getSummaryRowTmpl(),g=0,v=l.length;v>g;++g)e=l[g],h=m[""+e],n=this._calcViolationData(h),a="min"in h&&"max"in h,s={id:e,type:this.model.get("type"),properties:this._getSelectedProperties(h),hasData:a,rowIndex:p,rowClass:++p%2?"odd":"even",isLast:p===v,i18n:r,noData:r.noData},a&&t.extend(s,{thresholds:c,anotherStart:o,anotherEnd:d,violation:n,violationTime:Date.formatSeconds((n.fullTime.below+n.fullTime.above)/App.MS),violationDist:this.formatDistance(n.distance.below+n.distance.above),min:this._formatValue(h.min),max:this._formatValue(h.max)}),u+=f(s);return u},_getSummaryTitle:function(){return this.model.getTexts().summaryData},_renderDeviceSummary:function(e){var n=this.model.getTexts(),a=this.model.get("thresholds"),s=this.model.get("header"),r=this._calcViolationData(e),i=this._getDeviceSummaryTmpl(),o=i(t.extend(t.pick(e,"id","fullDist","fullMoveTime"),{i18n:n,hasData:"undefined"!=typeof e.min&&"undefined"!=typeof e.max,min:this._formatValue(e.min),max:this._formatValue(e.max),start:s.sd*App.MS,end:s.ed*App.MS,thresholds:a,violation:r,fullMoveTimeS:Date.formatSeconds(e.fullMoveTime),fullDistS:this.formatDistance(e.fullDist),belowDistanceS:this.formatDistance(r.distance.below),belowTimeS:Date.formatSeconds(r.fullTime.below/App.MS),aboveDistanceS:this.formatDistance(r.distance.above),aboveTimeS:Date.formatSeconds(r.fullTime.above/App.MS)}));return o},_getDeviceSummaryTmpl:function(){return null},_getSummaryRowTmpl:function(){return r},_getChartsTmpl:function(){return null},_renderDeviceRows:function(e){var n=this.model.get("rangesOfInterest");if(!n||!n.length)return"";var a,s,r=this,o=this.model.getTexts(),d=this._getFactsHeadTmpl(),l=this._getFactsRowTmpl(),m=this.model.get("thresholds"),c=e.facts||[],u=c.length,h="",p="",f=null;if(u>0){this.model.addressesLoaded=!1,this._noAddressData=[],p=d({i18n:o,valueHdr:0==n[0]?o.minimum:o.maximum,aboveOrBelow:(0==n[0]?o.below:o.above).toLowerCase(),threshold:0==n[0]?m[n[0]]:m[n[0]-1]});for(var g=0;u>g;++g)a=c[g],f=new Date(a.start),a.address="",a.address||this._noAddressData.push(a),s=t.extend(a,{id:e.id,value:this._formatValue(0==n[0]?a.min:a.max),avgValue:this._formatValue(a.avg),dateS:this.formatDate(f),startS:this.formatTime(f),endS:this.formatTime(new Date(a.end)),distS:this.formatDistance(a.dist),timeS:Date.formatSeconds((a.end-a.start)/App.MS),rowClass:(g+1)%2?"odd":"even",isLast:g==u-1,loadingAddress:o.loadingAddress,loadAddress:o.loadAddress}),p+=r._renderFactRow(l,s);this._noAddressData.length&&this.listenTo(this.model,"afterrender",function(){r._searchAddresses()}),h=i({key:this.model.get("type")+"-facts",theadHtml:"",tbodyHtml:p})}else"min"in e&&"max"in e&&(h='<p class="no-data no-facts">'+this._noFactsTxt+"</p>");return h},_renderFactRow:function(e,t){return e(t)},_getFactsRowTmpl:function(){return d},_renderCharts:function(e){var t=this.model.getTexts(),n="",a="",s=this._getChartsTmpl();return"undefined"==typeof e.min||"undefined"==typeof e.max||this._calcFullTime(e)<=0?"":(this.$el.width()<m&&(a=" w100"),n+=o({title:"",id:"ragchart-"+this.model.id+"-"+e.id,data:{id:e.id,index:0},addClass:"rag-chart closed"+a}),n+=o({title:"",id:"timechart-"+this.model.id+"-"+e.id,data:{id:e.id,index:1},addClass:"closed"+a}),s({i18n:t,html:n}))},_prepareTimeChartData:function(e){var t,n,a,s,r=e.values,i=r.length,o=[],d={};for(n=0;i>n;++n){for(t=r[n],s=t.length,a=0;s>a;++a)d=t[a],o.push([new Date(d.ts),this._formatValue(d.val)]),this._chartBreak(d.val)&&o.push(null);i-1>n&&o.push(null)}return o},_chartBreak:function(){return!1},_buildRagChart:function(e,t){var n=this._calcFullTime(e),a=this._calcViolationData(e),s=Math._round(100*a.fullTime.below/n,1),r=Math._round(100*a.fullTime.above/n,1),i=Math._round(100-s-r,1),o=this.model.getTexts(),d=this.model.get("thresholds"),l=[o.above+"&nbsp;"+d[1]+this._unit,o.normTemperature,o.below+"&nbsp;"+d[0]+this._unit],m={postfix:"%",rga:["hot high","green","cold low"]},c=t.find(".chart-content");0==s&&a.fullTime.below>0&&(s="&le;0.1"),0==r&&a.fullTime.above>0&&(r="&le;0.1");var u=[r,i,s];new RagChart(c,u,l,m)},_buildTimeChart:function(n){var s,r=this,i=e("#timechart-"+this.model.id+"-"+n.id),o=this.model.get("thresholds"),d=a.getDefaults(),l=d.axes[0],m=d.axes[1],c=d.height,u=1,h=20,p=[],f=[],g=[],v=this._getChartColors(),b=this._formatValue(n.max),y=this._formatValue(n.min),w=this.model.get("minStep"),S=i.width()-this.CHARTS_WIDTH_PADDING;if(u=h*(b-y)/c,m.majorGridLines.interval=Math.ceil(u),m.minimum=Math.min(y,o[0])-w,m.maximum=Math.max(b,o[1])+w,f=this._getTimeChartYBands(m.minimum,m.maximum),m.plotBands=f,n.parks&&n.parks.length){var x=new Array(n.parks.length);s=0,t.each(n.parks,function(e){x[s]={from:new Date(e.start),to:new Date(e.end),fillStyle:v.PARK_BAND,zIndex:0},s++}),e.merge(g,x)}p.push({type:"line",markers:null,nullHandling:"break",data:this._prepareTimeChartData(n)}),g.length&&(l=e.extend({},l,{plotBands:g})),new a(i,{width:S+"px",height:250,axes:[l,m],series:p}),i.bind("tooltipFormat",function(e,t){var n=r.formatUTC("DD.MM HH:mm:ss",t.x)+"<br />";return n+="<strong>"+Math._round(t.y,2)+" "+r._unit+"</strong>"})},_getTimeChartYBands:function(e,t){var n=this.model.get("thresholds");return[{fillStyle:"rgba(170,223,250,0.5)",from:e,to:n[0],zIndex:0},{fillStyle:"rgba(250,170,170,0.5)",from:n[1],to:t,zIndex:1}]},_calcViolationData:function(e){for(var t,n={count:{below:0,above:0},fullTime:{below:0,above:0},moveTime:{below:0,above:0},distance:{below:0,above:0}},a=this.model.get("thresholds"),s=a[0],r=a[1],i=e.ranges||[],o=0,d=i.length;d>o;++o)if(t=i[o],"min"in t&&"max"in t){var l="";this._formatValue(t.upperBound)<=s?l="below":this._formatValue(t.lowerBound)>=r&&(l="above"),l&&"count"in t&&(n.count[l]+=t.count,n.fullTime[l]+=t.time,n.moveTime[l]+=t.moveTime,n.distance[l]+=t.dist)}return n},_calcFullTime:function(e){for(var t,n=0,a=e.ranges||[],s=0,r=a.length;r>s;++s)t=a[s],t.time&&(n+=t.time);return n},_loadFacts:function(t,n){var a=this.model.get("rangesOfInterest"),s=this,r=this.model.get("type");a&&t==a[0]||(a=[t],this.model.set("rangesOfInterest",a),this.$el.addClass("loading"),this.model.fetch({data:s.model.getPostParams()}).done(function(t){s.$el.find("."+r+"-facts-rep-table, .no-facts").remove(),s.model.addressesLoaded=!0,n in t.body&&(s.content.append(s._renderDeviceRows(t.body[n])),"facts"in t.body[n]&&t.body[n].facts.length&&(s._searchAddresses(),e.fn.scrollTo&&s.$el.find(">.box-content").scrollTo(s.$el.find("."+r+"-facts-rep-table")))),s._createHeaderClones()}).fail(function(){var e=s.model.getTexts();alert(e.errCanNotBuildReport,e.error)}).always(function(){s.$el.removeClass("loading")}))},_resizeCharts:function(t){if(t&&this.model.get("module").get("active")){var n=this;setTimeout(function(){var t=n.$el.width();if(t){var s=n.$el.find("div.rep-chart");n.$el.width()<m?s.addClass("w100"):s.removeClass("w100"),n.$el.find("div.rep-chart").not(".rag-chart").each(function(){var t=e(this),s=t.width()-n.CHARTS_WIDTH_PADDING+"px";a.setWidth(t.find(".chart-content"),s)})}},20)}},_searchAddresses:function(){this.model.searchAddresses(this._noAddressData)},_formatValue:function(e){var t=this.model.get("koef");return Math._round(e*t,2)}});return c}),define("text!_common/reports/temperature/tmpl/reportMeta.html",[],function(){return"<p>\n    <%= i18n.dataSource %>:\n    <%= dataSource %>\n</p>\n<p>\n    <%= i18n.allowedTemperature %>:\n    <%= i18n.rangeFrom + '&nbsp;' +  thresholds[0] + ' ' +  i18n.to + '&nbsp;' + thresholds[1] %>&nbsp;&deg;C\n</p>\n<p>\n    <%= i18n.minViolationTime %>:\n    <% if(minutes > 0) {%>\n    <%= minutes %> <%= i18n.minutesLabels[i18n.whichLabels(minutes)] %>\n    <% } %>\n    <% if(seconds > 0 || !minutes) {%>\n    <%= seconds %> <%= i18n.secondsLabels[i18n.whichLabels(seconds)] %>\n    <% } %>\n</p>"}),define("text!_common/reports/temperature/tmpl/summaryThead.html",[],function(){return'<tr data-head="<%= headPosition %>">\n    <% for(var i = 0, l = properties.length; i < l; i++) { %>\n    <th data-key="<%= properties[i] %>"><%= names[properties[i]] %></th>\n    <% } %>\n    <th class="count"><%= i18n.below %> <%= thresholds[0] %>&nbsp;&deg;C</th>\n    <th class="count"><%= i18n.above %> <%= thresholds[1] %>&nbsp;&deg;C</th>\n    <th><%= i18n.violationDuration %></th>\n    <th><%= i18n.violationDistance %>, <%= i18n.km %></th>\n    <th class="deg">Tmin, &deg;C</th>\n    <th class="deg">Tmax, &deg;C</th>\n</tr>'}),define("text!_common/reports/temperature/tmpl/deviceSummary.html",[],function(){return'<table class="rep-table">\n    <colgroup>\n        <col style="width: 35%"/>\n        <col style="width: 15%"/>\n        <col style="width: 35%"/>\n        <col style="width: 15%"/>\n    </colgroup>\n    <tr class="obj">\n        <td class="summary" colspan="4">\n            <div class="sum-header">\n                <strong><%= i18n.summaryData %></strong>\n                <% if(hasData) {%>\n                <a class="build-track nobr" href="#" data-id="<%= id %>" data-from="<%= start %>" data-to="<%= end %>" >\n                    <%= i18n.showFullTrack %>\n                </a>\n                <a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n                <% } %>\n            </div>\n            <div class="sum-content">\n                <table>\n                    <tbody>\n                        <tr>\n                            <td><%= i18n.totalMoveTime %></td>\n                            <td class="value"><span class="rep-time-data"><%= fullMoveTimeS %></span></td>\n                        </tr>\n                            <td><%= i18n.totalDistance %>, <%= i18n.km %></td>\n                            <td class="value">\n                                <% if(App.reportAllowedByType(\'MOVEPARK\')) {%>\n                                <a href="#" class="build-another" data-type="movepark"\n                                     title="<%= i18n.build.ucFirst()+\' \'+i18n.reportsNames.movepark %>"\n                                     data-id="<%= id %>"\n                                     data-from="<%= start %>"\n                                     data-to="<%= end %>">\n                                <%= fullDistS %></a>\n                                <% } else { %>\n                                <%= fullDistS %>\n                                <% } %>\n                            </td>\n                        </tr>\n                    </tbody>\n                </table>\n            </div>\n        </td>\n    </tr>\n    <% if(hasData) {%>\n    <tr>\n        <th colspan="2" class="low"><%= i18n.belowAllowedLevel %></th>\n        <th colspan="2" class="high"><%= i18n.aboveAllowedLevel %></th>\n    </tr><tr>\n        <td><%= i18n.minTemperature %>, &deg;C</td>\n        <td><%= min %></td>\n        <td><%= i18n.maxTemperature %>, &deg;C</td>\n        <td><%= max %></td>\n    </tr><tr>\n        <td><%= i18n.violationCount %> T&nbsp;<&nbsp;<%= thresholds[0] %>&nbsp;&deg;C</td>\n        <td><a href="#" data-id="<%= id %>" data-range="0" class="show-facts"><%= violation.count.below %></a></td>\n        <td><%= i18n.violationCount %> T&nbsp;>&nbsp;<%= thresholds[1] %>&nbsp;&deg;C</td>\n        <td><a href="#" data-id="<%= id %>" data-range="2" class="show-facts"><%= violation.count.above %></a></td>\n    </tr><tr>\n        <td><%= i18n.duration %> T&nbsp;<&nbsp;<%= thresholds[0] %>&nbsp;&deg;C</td>\n        <td><%= belowTimeS %></td>\n        <td><%= i18n.duration %> T&nbsp;>&nbsp;<%= thresholds[1] %>&nbsp;&deg;C</td>\n        <td><%= aboveTimeS %></td>\n    </tr><tr>\n        <td><%= i18n.distanceWhile.replace(\'#t#\', \'T&nbsp;<&nbsp;\'+thresholds[0]) %>&nbsp;&deg;C, <%= i18n.km %></td>\n        <td><%= belowDistanceS %></td>\n        <td><%= i18n.distanceWhile.replace(\'#t#\', \'T&nbsp;>&nbsp;\'+thresholds[1]) %>&nbsp;&deg;C, <%= i18n.km %></td>\n        <td><%= aboveDistanceS %></td>\n    </tr>\n    <% } %>\n</table>\n\n<% if(!hasData) {%>\n<p class="no-data"><%= i18n.noDataForObject %></p>\n<% } %>'}),define("text!_common/reports/temperature/tmpl/thead.html",[],function(){return'<colgroup>\n    <col style="width:11%" />\n    <col style="width:11%" />\n    <col style="width:11%" />\n    <col style="width:11%" />\n    <col style="width:11%" />\n    <col style="width:11%" />\n    <col style="width:11%" />\n    <col style="width:23%" />\n</colgroup>\n<tr class="summary">\n    <td class="sum-header" colspan="8">\n        <h3><%= i18n.temperature %> <%= aboveOrBelow %> <%= threshold %>&nbsp;&deg;C</h3>\n        <a class="clear-map-link hidden nobr" href="javascript:;"><%= i18n.clearMap %></a>\n    </td>\n</tr>\n<tr data-head="1">\n    <th><%= i18n.date.ucFirst() %></th>\n    <th><%= i18n.actionStart %></th>\n    <th><%= i18n.actionEnd %></th>\n    <th><%= valueHdr %>, &deg;C</th>\n    <th><%= i18n.avgValue %>, &deg;C</th>\n    <th><%= i18n.duration %></th>\n    <th><%= i18n.runDistance %>, <%= i18n.km %></th>\n    <th><%= i18n.place %></th>\n</tr>'}),define("text!_common/reports/temperature/tmpl/charts.html",[],function(){return'<div class="charts-group clearfix">\n    <div class="chart-actions">\n        <a data-index="0" href="#" class="chart-switcher s">\n            <span class="s"><%= i18n.toggleViolationChart.replace(\'#t#\', i18n.show.ucFirst()) %></span>\n            <span class="h"><%= i18n.toggleViolationChart.replace(\'#t#\', i18n.hide.ucFirst()) %></span>\n        </a>\n        <a data-index="1" href="#" class="chart-switcher s">\n            <span class="s"><%= i18n.toggleTemperatureTimeChart.replace(\'#t#\', i18n.show.ucFirst()) %></span>\n            <span class="h"><%= i18n.toggleTemperatureTimeChart.replace(\'#t#\', i18n.hide.ucFirst()) %></span>\n        </a>\n    </div>\n    <%= html %>\n</div>'}),define("_common/reports/temperature/views/TemperatureReportView",["jquery","underscore","_libs/charts/Chart","_common/reports/views/ParameterReportView","text!../tmpl/reportMeta.html","text!../tmpl/summaryThead.html","text!../tmpl/deviceSummary.html","text!../tmpl/thead.html","text!../tmpl/charts.html"],function(e,t,n,a,s,r,i,o,d){s=t.template(s),r=t.template(r),i=t.template(i),o=t.template(o),d=t.template(d);var l=a.prototype,m=a.extend({constructor:function(){a.apply(this,arguments)},render:function(){var t=new e.Deferred;return this._unit="&deg;C",this._noFactsTxt=this.model.getTexts().noViolations,l.render.apply(this,arguments),t.resolve(),t},_getDataSourcesNames:function(){var e=this.model.getTexts();return{OUTTEMP:e.externalSensorTemperature,DEVTEMP:e.deviceTemperature,COOLTEMP:e.coolerTemperature}},_getMetaTmpl:function(){return s},_getDeviceSummaryTmpl:function(){return i},_getSummaryTheadTmpl:function(){return r},_getFactsHeadTmpl:function(){return o},_getChartsTmpl:function(){return d},_buildRagChart:function(e,t){l._buildRagChart.apply(this,arguments),t.find(".high, .low").attr("title",this.model.getTexts().showViolations)}});return m}),define("mobile/reports/temperature/views/TemperatureReportView",["_common/reports/temperature/views/TemperatureReportView"],function(e){e.prototype;var t=e.extend({constructor:function(){e.apply(this,arguments)}});return t}),define("mobile/reports/temperature/TemperatureReport",["underscore","_common/reports/temperature/TemperatureReport","./views/TemperatureReportView"],function(e,t,n){var a=t.prototype,s=t.extend({constructor:function(){t.apply(this,arguments)},initialize:function(){a.initialize.call(this,n)}});return s});