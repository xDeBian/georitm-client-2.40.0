define(["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!../tmpl/thead.html","text!../tmpl/theadSingle.html","text!../tmpl/tableHistory.html","text!../tmpl/rowSummary.html","text!../tmpl/row.html","text!../tmpl/rowHistory.html","text!../tmpl/objSummary.html","text!../tmpl/controls.html","text!_common/reports/tmpl/pins.svg","i18n!_common/reports/nls/canReport"],function(t,e,r,s,i,o,n,a,d,l,c,m,h,u){function p(t){return/^\d+$/.test(t)}var f=r.prototype;s=e.template(s),i=e.template(i),o=e.template(o),n=e.template(n),a=e.template(a),d=e.template(d),l=e.template(l),c=e.template(c),h=e.template(h),m=e.template(m);var S=r.extend({constructor:function(){this.sortFieldsPrim={},this.sortFieldsSec={},this.curSortFieldPrim="name",this.curSortFieldSec="countSwitch",this.curSortType="asc",this.$tbody=null,r.apply(this,arguments)},initialize:function(){r.prototype.initialize.apply(this,arguments)},render:function(){var i=new t.Deferred,o=(this.model.getTexts(),this.model);r.prototype.render.apply(this,arguments),this.$el.addClass("discrets-report"),this.buildMetaInfo();var n="";if(o.get("objectId").length>1)this.$el.addClass("report-wide"),this.content.append(this._renderControls()),this._initControls(),this.content.append(s({key:o.get("key"),theadHtml:""})),this.$tbody=this.content.find("tbody"),this._rerender();else{var a=this,d=o.get("body");e.each(d,function(t){n+=g.buildObjectInfo.call(a,t),n+=g.buildObjectRows.call(a,t),o.get("showHistory")&&(n+=g.buildHistoryRows.call(a,t))}),this.content.append(n),this._initAddressesRequests(),this._initMarkersLinks(function(t){var e=u.names[t.num];t.title=e,a.putStateSwitchMarker(t)})}return i.resolve(),i},_rerender:function(){var t=this.model,e=i({propNames:this.mobileProps,properties:t.get("properties"),paramNames:u.names,params:t.get("parameterNums"),metrics:this.getMetricsNames()});e+=g.buildSummaryRows.call(this),this.$tbody.html(e),this._prepareWideReportFixedHeader()},putStateSwitchMarker:function(t){if(t){var e=this.putMarkers([t],{icon:new L.PinIcon({html:h({type:"switch"}),addClassName:"discrete-marker"}),popup:{type:"discreteSwitch",className:"track-info discrete-info"},zoom:!0});return e}},getMetricsNames:function(){var t=this.model.getTexts(),r=this.model.getMetricsDataFields(),s=[],i="";return e.each(r,function(e){i=t.discretes[e+"Short"],e.indexOf("distance")>-1&&(i+=", "+t.km),s.push(i)}),s},formatMetric:function(t,e){var r="";return r=-1!=t.indexOf("distance")?this.formatDistance(e):-1!=t.indexOf("period")?this.formatSeconds(e):String(e)},buildMetaInfo:function(){var t=this.model.getTexts();f.buildMetaInfo.call(this),this.content.find(".rep-meta").append("<p>"+t.deviceReport.minDelay+" "+Date.formatSeconds(this.model.get("dur"),!0)+"</p>")},_sortData:function(t){var r=this._getSortValue.bind(this),s=e.sortBy(t,r);return"desc"===this.curSortType?s.reverse():s},_getSortValue:function(t){var e,r=this.curSortFieldPrim,s=this.curSortFieldSec,i=this.curSortType,o=p(r);if(o){var n=(t.summary||{})[r]||{};e=s in n?n[s]:"asc"===i?1/0:-1/0}else switch(r){case"extId":e=Number(t.obj[r]);break;default:e=(t.obj[r]||"").trim().toLowerCase()}return e},_renderControls:function(){var t=this.model,e=t.getTexts(),r=e.discretes,s=t.get("properties"),i=t.get("parameterNums"),o=t.getMetricsDataFields(),n=this.mobileProps,a=u.names,d=s.map(function(t){return{key:t,name:n[t]}});return d=d.concat(i.map(function(t){var e=String(t);return{key:e,name:a[e]}})),this.sortFieldsPrim=d,this.sortFieldsSec=o.map(function(t){return{key:t,name:r[t+"Short"]}}),m({sortFieldsPrim:this.sortFieldsPrim,sortFieldsSec:this.sortFieldsSec,curSortFieldPrim:this.curSortFieldPrim,curSortFieldSec:this.curSortFieldSec,curSortType:this.curSortType,i18n:e})},_initControls:function(){var t=this,e=this.content.find("select[name=sortPrim]"),r=this.content.find("select[name=sortSec]"),s=this.content.find("select[name=sortType]");e.on("change",function(){var s=e.val();r.prop("disabled",!p(s)),t.curSortFieldPrim=s,t._rerender()}),r.on("change",function(){t.curSortFieldSec=r.val(),t._rerender()}),s.on("change",function(){t.curSortType=s.val(),t._rerender()})}}),g={buildSummaryRows:function(){var t=this,r=this.model,s=this._sortData(r.get("body")),i=r.get("header"),o=i.sd*App.MS,n=i.ed*App.MS,d=r.get("properties"),l=r.get("parameterNums"),c=r.getMetricsDataFields(),m="",h=r.getTexts(),u=!0,p=!0,f=[],S=[],g=0,y="";return e.each(s,function(r){u="summary"in r?r.summary:null,f=[],S=[],e.each(d,function(t){f.push(t in r.obj?r.obj[t]:h.noData)}),e.each(l,function(r){p=u&&r in u,e.each(c,function(e){y=p?t.formatMetric(e,u[r][e]):h.noData,S.push(y)})}),m+=a({properties:f,hasHistory:null!==u,id:r.obj.id,start:o,end:n,values:S,isLast:++g==s.length})}),m},buildObjectInfo:function(t){var e=this.model.getTexts(),r=t.obj,s=this.model.get("header"),i="";return i+=c({i18n:e,id:r.id,start:s.sd*App.MS,end:s.ed*App.MS,totalMoveTime:r.moveTime,totalMoveTimeS:this.formatSeconds(r.moveTime||0),totalDistance:r.distance||0,totalDistanceS:this.formatDistance(r.distance||0)})},buildObjectRows:function(t){var r=this.model,i=r.getTexts(),n=t.summary||null,a="",l="";if(n){var c=this,m=r.getMetricsDataFields(),h=r.get("parameterNums"),p=h.length,f=0,S=!0,g="",y=[];a+=o({heads:[i.discretParam].concat(this.getMetricsNames())}),e.each(h,function(t){S=t in n,y=[],e.each(m,function(e){g=S?c.formatMetric(e,n[t][e]):i.noData,y.push(g)}),a+=d({name:u.names[t],values:y,isLast:++f==p})}),l+=s({key:r.get("key"),theadHtml:"",tbodyHtml:a})}else l='<p class="no-data">'+i.noDataForObject+"</p>";return l},buildHistoryRows:function(t){var r=this.model,s=r.getTexts(),i=t.history||null,o="",a="";if(i&&i.length){for(var d,c,m=t.obj.id,h=0,p=i.length;p>h;++h)d=i[h],c={num:d.num,start:this.formatDateTime(d.sts),end:this.formatDateTime(d.ets),duration:this.formatSeconds(d.dur),name:u.names[d.num],state:0===d.state?s.switchedOffShort:s.switchedOnShort,distance:this.formatDistance(d.dist),rowClass:(h+1)%2?"odd":"even",isLast:h==p-1,loadAddress:s.loadAddress,noAddress:s.noData},"geoId"in d&&0!=d.lat&&0!=d.lon&&(e.extend(c,{geoId:d.geoId,lat:d.lat,lon:d.lon,startTs:d.sts*App.MS,endTs:d.ets*App.MS,objectId:m,showTrack:d.dist>0}),d.address?c.address=d.address:c.loadAddress=s.loadAddress,d.dist<=0&&(c.markerId=++this._markerId,this._markerData[this._markerId]=c)),a+=l(c);o+=n({i18n:s,tbodyHtml:a})}else;return o}};return S});