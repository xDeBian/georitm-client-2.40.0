define(["jquery","underscore","moment","_libs/charts/Chart","_common/reports/views/ReportView","./DiscretsChartView","./SensorsChartView","text!../tmpl/controls.html"],function(t,e,s,i,n,r,a,o){var l=function(){return'<div class="charts-container"><div class="charts-group"></div></div>'},h=function(t,e){return'<div class="chart-mode"><label class="checkbox"><input type="checkbox"'+(t?" checked":"")+" />"+e+"</label></div>"},c=function(){return'<div class="rep-chart sensors-chart"><div class="chart-content"></div></div>'},d=function(t){return'<div class="rep-chart discrets-chart">'+(t?'<div class="chart-labels"><div class="chart-labels-list"></div></div>':"")+'<div class="chart-content"></div></div>'};o=e.template(o);var u=function(t){return'<tr class="chart-value-row"><td class="chart-color-cell"><div class="chart-color" style="background: '+t.color+'"></div></td>'+'<td class="chart-name-cell">'+t.name+(t.units?",&nbsp;"+t.units:"")+"</td>"+'<td class="chart-value-cell">'+(null===t.value?"--":Math._round(t.value,2))+"</td>"+"</tr>"},g=n.extend({constructor:function(){this.$chartsContainer=null,this.$chartsGroup=null,this.$controlsContainer=null,this.$valuesContainer=null,this.$valuesTime=null,this.$valuesTable=null,this.singleParam=null,this.showValues=!1,this._children={sensors:null,discrets:null},n.apply(this,arguments)},render:function(){var e=this.model,s=new t.Deferred;this.$el.addClass("report-no-footer timeseries-report"),n.prototype.render.apply(this,arguments),this.buildMetaInfo(),this.$chartsContainer=t(l()).appendTo(this.content);var i=e.getSelectedParams();return i.length>1?this._renderControls():(this.singleParam=i[0],this.$el.addClass("single-parameter"),this.content.addClass("loading"),this.$chartsContainer.prepend('<h3 class="chart-title">'+i[0].name+"</h3>")),this._renderValuesContainer(),this._bindEvents(),s.resolve(),s},getChartsMinYAxisWidth:function(){var t=0,e=this._children.discrets;return null!==e&&e.isVisible&&(t=e.getYAxisWidth()),t},_bindEvents:function(){var t=this.model;this.listenTo(t,"serie:ready",this._onSerieReady).listenTo(t,"serie:error",this._onSerieError).listenTo(t,"ready",this._renderCharts)},_renderControls:function(){var s=this.model,i=s.getSelectedParams(),n=e.pluck(i,"key");this.$controlsContainer=t(o({all:s.getParams(),checked:n})).appendTo(this.$chartsContainer),this.$controlsContainer.on("click","input[type=checkbox]",function(){s.toggleParameter(this.value,this.checked)})},_renderValuesContainer:function(){this.$valuesContainer=t('<div class="chart-values hidden" />').appendTo(this.$chartsContainer),this.$valuesTime=t('<div class="chart-values-time" />').appendTo(this.$valuesContainer),this.$valuesTable=t("<table />").appendTo(this.$valuesContainer)},_moveCursor:function(t){this.$cursor[0].style.left=t-this.$chartsGroup.offset().left+"px"},_renderValues:function(t,s){this.$valuesTime.html(this.formatDateTime(new Date(t)));var i=e.map(s,function(t){return u(t)});this.$valuesTable.html(i.join(""))},_toggleValues:function(t){this.showValues^t&&(this.showValues=t,this.singleParam||this.$controlsContainer.toggleClass("hidden",t),this.$valuesContainer.toggleClass("hidden",!t),this.$cursor.toggleClass("hidden",!t),t||this.$valuesTable.html(""))},_onSerieReady:function(t,e){this.singleParam?this.content.removeClass("loading"):(this._toggleControlLoading(t.key,!1),this._toggleControlDisabled(t.key,1>e))},_onSerieError:function(t){this.singleParam?this.content.removeClass("loading"):(this._toggleControlLoading(t.key,!1),this._toggleControlDisabled(t.key,!0))},_renderCharts:function(){var s=this.model,i=this.$chartsGroup=this.$chartsContainer.find(".charts-group"),n=function(t){return t.length>0&&e.some(t,function(t){return s.getSerie(t.key).data.length>0})},o=s.getSelectedParams(!1),l=n(o),u=s.getSelectedParams(!0),g=n(u),m=this.singleParam;if(l||g){if(l){if(!s.isRawOnly()){var v=t(h(s.get("useFormatted"),s.getTexts().useFormattedTimeseriesData)).insertBefore(m?i:this.$chartsContainer);v.find("input").on("click",function(){s.set("useFormatted",this.checked)})}var p=new a({model:this.model,parent:this,el:t(c()).appendTo(i),alone:!g,singleParam:m});this._children.sensors=p,this.trigger("chart:update","sensors",p)}if(g){var f=new r({model:this.model,parent:this,el:t(d(null===m)).appendTo(i),alone:!l,singleParam:m});this._children.discrets=f,this.trigger("chart:update","discrets",f)}this.$cursor=t('<div class="charts-cursor hidden" />').appendTo(i),i.on("mousemove",e.throttle(function(t){var e=this._getPointerTimestamp(t);e>0?(this.showValues||this._toggleValues(!0),this._moveCursor(t.pageX),this._renderValues(e,s.getValuesByTs(e))):this.showValues&&this._toggleValues(!1)},50).bind(this)).on("mouseleave",function(){this._toggleValues(!1)}.bind(this)),i.on("click",function(t){var e=this._getPointerTimestamp(t);e>0&&this._buildTrack(e)}.bind(this))}else{var C=s.getTexts();this.singleParam?this.$chartsContainer.append('<p class="no-data">'+C.noChartData+"</p>"):(t('<p class="no-data">'+C.noDataForChartsByParameters+"</p>").insertBefore(this.$chartsContainer),i.remove())}},_buildTrack:function(t){var e=Date.now();if(!(t>e)){var s=this.model,i=s.get("objectId")[0],n=3e4,r=t-n,a=Math.min(t+n,e);s.buildTrackSegment({trackId:null,objectId:[i],startTime:r,endTime:a,sourceElement:this.$el})}},_getPointerTimestamp:function(t){var e=this._children.sensors,s=this._children.discrets,i=t.pageX,n=t.pageY,r=e?e.getTsByXY(i,n):0,a=s?s.getTsByXY(i,n):0;return r||a},_toggleControlLoading:function(t,e){var s=this._findControlByKey(t);s.toggleClass("chart-control-loading",e)},_toggleControlDisabled:function(t,e){var s=this._findControlByKey(t);s.toggleClass("chart-control-disabled",e);var i=s.find("input").prop("disabled",e);e&&i.prop("checked",!1)},_findControlByKey:function(t){return this.$controlsContainer.find('.chart-control[data-key="'+t+'"]')}});return g});