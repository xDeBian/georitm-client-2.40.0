define(["jquery","underscore","_libs/charts/Chart","./ChartView"],function(t,i,e,s){function n(t){var e=1/0,s=-1/0,n=[];if(t.forEach(function(t){null!==t.min&&null!==t.max&&(e=Math.min(e,t.min),s=Math.max(s,t.max),2===t.data.length&&t.min===t.max&&n.push(t))}),e===s)e=Math.floor(.95*e),s=Math.ceil(1.05*s);else if(n.length){var a=i.filter(n,function(t){return t.min===e});a.length&&(e=Math.floor(.95*e))}return[e,s]}var a=s.prototype,r=s.extend({constructor:function(){s.apply(this,arguments)},render:function(){var t=this.model,s=this.$chart,a=e.getDefaults(),r=a.axes[1],h=t.getSelectedParams(!1),o=this._makeSeries(h),l=n(o);if(r.majorGridLines={lineWidth:1,strokeStyle:"#dadada",interval:0},r.minimum=l[0],r.maximum=l[1],this._chart=new e(s,i.extend(this._getCommonChartOptions(),{width:this.isAlone?void 0:this._calcWidth(),height:a.height,axes:[this._getDateTimeAxisOptions(),r],series:o})),null!==this.singleParam){var d=this.parent,g=this.singleParam;s.on("tooltipFormat",function(t,i){var e="<strong>"+d.formatUTC("DD.MM HH:mm:ss",i.x)+"</strong><br />";return e+=""+g.name+": <strong>"+Math._round(i.y,2)+"</strong>"})}},_toggleXAxis:function(){var t=this.getXAxis();t.setOptions(this._getDateTimeAxisOptions()),this.getJqChart().partialDelayedUpdate()},_bindEvents:function(){var t=this.parent;a._bindEvents.call(this),this.listenTo(this.model,"change:useFormatted",function(t){var i=t.getShownParamsWithData(!1);i.length&&this._updateSeries(this._makeSeries(i))}).listenTo(t,"chart:update",function(t,i){"discrets"===t&&this._setPaddingLeft(i.getYAxisWidth()-this.getYAxisWidth())}).listenTo(t,"chart:toggle",function(t,i,e){"discrets"===t&&(this.isAlone=!e,this.isVisible&&(this._setPaddingLeft(e?i.getYAxisWidth()-this.getYAxisWidth():0),this._toggleXAxis(this.isAlone)))}).listenTo(t,"zoom:change",function(t){this.setVisibleRange(t)})},_makeSeries:function(t){var e=this.model,s={type:"line",markers:null,nullHandling:"break"},n=[],a=e.get("useFormatted");return t.forEach(function(t){var r=a?e.getFormattedSerie(t.key):e.getSerie(t.key);r.data.length&&n.push(i.extend({},s,{key:t.key,strokeStyle:t.color,min:r.min,max:r.max,data:r.data}))}),n},_updateSeries:function(t){var i=this._getSeries().length>0,e=n(t);if(this._setSeries(t),t.length>0){if(i||this.$el.removeClass("chart-invisible"),this._setYAxisMinAndMax(e[0],e[1]),!this.isOriginalyAlone){var s=this.parent.getChartsMinYAxisWidth();this._setPaddingLeft(s>0?s-this.getYAxisWidth():0),this._toggleXAxis(this.isAlone)}}else i&&this.$el.addClass("chart-invisible")},_toggleParam:function(t,i){if(!t.discret){var e=this._getSeries().slice(0);if(i){var s=this._makeSeries([t]);e.push(s[0])}else{var n=e.findIndex(function(i){return i.key===t.key});n>-1&&e.splice(n,1)}this._updateSeries(e)}},_getDateTimeAxisOptions:function(){var t=a._getDateTimeAxisOptions.call(this),e=this.isAlone;return t.visible=e,t.zoomEnabled=e,t.labels=i.extend(t.labels,{visible:e}),t.majorTickMarks=i.extend(t.majorTickMarks||{},{visible:e}),t},_setYAxisMinAndMax:function(t,e){var s=this.$chart,n=s.jqChart("option","axes");s.jqChart("option","axes",[n[0],i.extend(n[1],{minimum:t,maximum:e})])},_setPaddingLeft:function(t){this.$el.css("padding-left",t),this.$chart.jqChart("option","width",this._calcWidth()),this.getJqChart().partialDelayedUpdate()},_calcWidth:function(){return this.$el.outerWidth()-parseInt(this.$el.css("padding-left"))},_resize:function(){setTimeout(function(){var t=this.parent.getChartsMinYAxisWidth();this._setPaddingLeft(t>0?t-this.getYAxisWidth():0),this.isAlone&&this._toggleXAxis(!0)}.bind(this),50)}});return r});