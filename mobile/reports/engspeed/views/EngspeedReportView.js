define(["jquery","underscore","util","_libs/charts/Chart","_common/reports/views/ParameterReportView","text!../tmpl/reportMeta.html","text!../tmpl/summaryThead.html","text!../tmpl/summaryRow.html","text!../tmpl/deviceSummary.html","text!../tmpl/thead.html","text!../tmpl/row.html","text!../tmpl/charts.html","text!_common/reports/tmpl/pins.svg"],function(t,e,r,n,a,i,o,s,m,l,h,d,p){i=e.template(i),o=e.template(o),s=e.template(s),m=e.template(m),l=e.template(l),h=e.template(h),d=e.template(d),p=e.template(p);var u=a.prototype,c=a.extend({constructor:function(){a.apply(this,arguments)},render:function(){var e=this,r=new t.Deferred,n=this.model.getTexts();return this._unit=n.rpm,this._noFactsTxt=n.noFactsOfCriticalRpm,u.render.apply(this,arguments),this.content.find(".rag-chart").off("click"),this._initAddressesRequests(),this._initMarkersLinks(e.putCriticalRpmMarker),r.resolve(),r},putCriticalRpmMarker:function(t){if(t){var e=this.putMarkers([t],{icon:new L.PinIcon({html:p({type:"engine"}),addClassName:"rpm-marker negative"}),popup:{type:"criticalRpm",className:"track-info rpm-info negative"},zoom:!0});return e}},_getMetaTmpl:function(){return i},_getDataSourcesNames:function(){return{"default":""}},_getSummaryColspan:function(){return this.model.get("properties").length+4},_renderSummaryRows:function(){for(var t,r,n,a,i=this.model.getTexts(),o=this.model.get("header"),m=o.sd*App.MS,l=o.ed*App.MS,h=o.keyOrder,d=this.model.get("body"),p=this.model.get("thresholds"),u="",c={},f=0,g=0,S=h.length;S>g;++g)t=h[g],c=d[""+t],n="min"in c&&"max"in c,a={id:t,properties:this._getSelectedProperties(c),hasData:n,rowIndex:f,rowClass:++f%2?"odd":"even",isLast:f==S,i18n:i,noData:i.noData},n&&(r=[],e.each(c.ranges,function(t){r.push(Date.formatSeconds("time"in t?t.time/App.MS:0))}),e.extend(a,{thresholds:p,anotherStart:m,anotherEnd:l,durations:r})),u+=s(a);return u},_getSummaryTheadTmpl:function(){return o},_getDeviceSummaryTmpl:function(){return m},_renderDeviceSummary:function(t){var r=this,n=this.model.getTexts(),a=this.model.get("thresholds"),i=this.model.get("header"),o=t.fullMoveTime+t.fullParkTime,s=0,m=[],l=[],h=this._getDeviceSummaryTmpl();e.each(t.ranges,function(t){"avg"in t&&t.avg>0?(m.push(Date.formatSeconds(t.time/App.MS)),l.push(r.formatDistance(t.dist)),t.lowerBound>=0&&(s+=t.time)):(m.push(Date.formatSeconds(0)),l.push(r.formatDistance(0)))}),m[0]=Date.formatSeconds(o-s/App.MS);var d=h(e.extend(e.pick(t,"id","fullDist","fullMoveTime"),{i18n:n,hasData:"undefined"!=typeof t.min&&"undefined"!=typeof t.max,min:this._formatValue(t.min),max:this._formatValue(t.max),start:i.sd*App.MS,end:i.ed*App.MS,thresholds:a,engineWorkTime:Date.formatSeconds(s/App.MS),durations:m,distances:l,fullMoveTimeS:Date.formatSeconds(t.fullMoveTime),fullDistS:this.formatDistance(t.fullDist)}));return d},_getFactsHeadTmpl:function(){return l},_getFactsRowTmpl:function(){return h},_renderFactRow:function(t,e){return e.markerId=++this._markerId,this._markerData[this._markerId]=e,t(e)},_getChartsTmpl:function(){return d},_buildRagChart:function(t,r){var n=this.model.get("header"),a=(n.ed-n.sd)*App.MS,i=this.model.getTexts(),o=(this.model.get("thresholds"),[i.engineCriticalRpmShort,i.engineLoadStateShort,i.engineIdleStateShort,i.engineOffState]),s={postfix:"%",rga:["high","green","low","gray"],rgaLength:4},m=new Array(4),l=0,h=r.find(".chart-content"),d=0;e.each(t.ranges.reverse(),function(t){"time"in t?(m[d]=Math._round(100*t.time/a,1),l+=m[d],0==m[d]&&t.time>0?m[d]="&le;0.1":100==m[d]&&t.time<a&&(m[d]="&ge;99.9")):m[d]=0,d++}),m[3]=Math._round(100-l,1),new RagChart(h,m,o,s)},_chartBreak:function(t){return 0>=t},_getTimeChartYBands:function(t,e){var r=this.model.get("thresholds");return[{fillStyle:"rgba(250,170,170,0.5)",from:r[2],to:e,zIndex:1},{fillStyle:"rgba(87,186,41,0.3)",from:r[1],to:r[2],zIndex:1},{fillStyle:"rgba(170,223,250,0.5)",from:r[0],to:r[1],zIndex:1}]}});return c});