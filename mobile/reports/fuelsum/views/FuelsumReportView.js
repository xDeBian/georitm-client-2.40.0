define(["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!../tmpl/controls.html","text!../tmpl/thead.html","text!../tmpl/row.html","text!../tmpl/rowSummary.html"],function(t,e,i,n,r,a,s,o){n=e.template(n),r=e.template(r),a=e.template(a),s=e.template(s),o=e.template(o);var m=i.extend({constructor:function(){this.sortFields={},this.curSortField="name",this.curSortType="asc",i.apply(this,arguments)},render:function(){var e=new t.Deferred,r=this.model,a=r.getTexts();return this._paramsDataMap={dist:"distInKm",avgSpeed:"avgSpeedInKmh",moveTime:"moveTimeInSec",parkTime:"parkTimeInSec",ignOnTime:"ignOnTimeInSec",ignOnMoveTime:"ignOnMoveTimeInSec",ignOnParkTime:"ignOnParkTimeInSec",ignOffParkTime:"ignOffParkTimeInSec"},this._names={startF:a.startVolume+", "+a.l,endF:a.endVolume+", "+a.l,minVolume:a.minVolume+", "+a.l,maxVolume:a.maxVolume+", "+a.l,fillVolume:a.fillingsVolume+", "+a.l,plumVolume:a.dischargesVolume+", "+a.l,realConsumption:a.totalRealConsumption+", "+a.l,consumption100km:a.avgConsumption+", "+a.l100km,consumption1hIgn:a.avgConsumption1hIgn+", "+a.l1h,dist:a.runDistance+", "+a.km,avgSpeed:a.avgSpeed+", "+a.kmh,moveTime:a.wayTime,parkTime:a.totalParkTime,ignOnTime:a.ignOnTime,firstIgnTime:a.firstIgnTime,lastIgnTime:a.lastIgnTime,ignOnMoveTime:a.ignOnMoveTime,ignOnParkTime:a.ignOnParkTime,ignOffParkTime:a.ignOffParkTime},l.setSortFields.call(this),i.prototype.render.apply(this,arguments),this.$el.addClass("fuelsum-report report-wide"),this.buildMetaInfo(),r.get("objectId").length>1&&(this.content.append(l.renderControls.call(this)),l.initControls.call(this)),this.content.append(n({key:r.get("key"),theadHtml:""})),this.$tbody=this.content.find("tbody"),l.rerender.call(this),l.bindRowsEvents.call(this),e.resolve(),e},formatValue:function(t,e){var i="";return i="dist"===t?this.formatDistance(e):"firstIgnTime"===t||"lastIgnTime"===t?this.formatDateTime(e):"Time"===t.slice(-4)?this.formatSeconds(e):String(e)},sortData:function(){var t=this.curSortField,i=e.sortBy(this.model.get("body").objects,function(e){return this.getSortValue(e,t)}.bind(this));return"desc"===this.curSortType?i.reverse():i},getSortValue:function(t,i){var n=this._paramsDataMap,r=i in n?n[i]:i,a=this.model.get("params"),s=this.curSortType,o=e.indexOf(a,i)>-1,m="";return o?m=r in t.params?t.params[r]:"asc"===s?1/0:-1/0:(m=t[r],m=/^name|groups|model|carId|vin|type|year$/.test(r)?m.toLowerCase():Number(m)),m}}),l={setSortFields:function(){var t=this.model,i=t.get("properties"),n=t.get("params"),r=this.mobileProps,a=this._names,s={};e.each(i,function(t){s[t]=r[t]}),e.each(n,function(t){s[t]=a[t]}),"name"in s||(this.curSortField=e.keys(s)[0]),this.sortFields=s},renderControls:function(){var t=this.model.getTexts();return r({sortFields:this.sortFields,curSortField:this.curSortField,curSortType:this.curSortType,i18n:t})},initControls:function(){var t=this,e=this.content.find("select[name=sort]"),i=this.content.find("select[name=sortType]");e.on("change",function(){t.curSortField=e.val(),l.rerender.call(t)}),i.on("change",function(){t.curSortType=i.val(),l.rerender.call(t)})},rerender:function(){var t=this.model,e=a({propNames:this.mobileProps,properties:t.get("properties"),paramNames:this._names,params:t.get("params")});e+=l.buildRows.call(this),e+=l.buildSummaryRow.call(this),this.$tbody.html(e),this._prepareWideReportFixedHeader()},bindRowsEvents:function(){var e=this.model,i=null,n="tr.has-data[data-id]";this.$tbody.on("mousedown",n,function(){var e=t(this).data("id");i={ts:Date.now(),id:e}}).on("mouseup",n,function(){if(i){var n=t(this).data("id"),r=Date.now();n===i.id&&r-i.ts<300&&e.buildChildReport([n],"fuel")}})},buildRows:function(){var t=this,i=this.model,n=this._paramsDataMap,r=this.sortData(),a=i.get("header"),o=a.sd*App.MS,m=a.ed*App.MS,l=i.get("properties"),p=i.get("params"),u="",d=i.getTexts(),h=null,c=!0,g=[],f=[],T="",v="";return e.each(r,function(i){h="params"in i?i.params:{},c=e.keys(h).length>0,g=[],f=[],e.each(l,function(t){g.push(t in i?i[t]:d.noData)}),e.each(p,function(e){v=e in n?n[e]:e,T=v in h?t.formatValue(e,h[v]):d.noData,f.push(T)}),u+=s({properties:g,hasData:c,objectId:i.objectId,start:o,end:m,values:f,rowTitle:d.buildReport,rowClass:"rep-row"+(c?" has-data":"")})}),u},buildSummaryRow:function(){var t,i,n,r=this.model,a=r.getTexts(),s=this._paramsDataMap,m=r.get("params"),l=new Array(m.length),p=r.get("body").total;return e.each(m,function(e){t=e in s?s[e]:e,i="total"+t.ucFirst(),n=i in p?this.formatValue(e,p[i]):"",l.push(n)}.bind(this)),o({i18n:a,colspan:r.get("properties").length,values:l})}};return m});