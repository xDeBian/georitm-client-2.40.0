define(["jquery","underscore","_common/reports/views/ReportView","text!_common/reports/tmpl/reportTable.html","text!../tmpl/meta.html","text!../tmpl/tableNoData.html","text!../tmpl/thead.html","text!../tmpl/row.html","text!../tmpl/rowNoData.html","_libs/leaflet/leaflet-src"],function(t,e,a,s,r,i,o,d,n){var l=a.prototype;s=e.template(s),r=e.template(r),i=e.template(i),o=e.template(o),d=e.template(d),n=e.template(n);var p=a.extend({constructor:function(){this._haveData=[],this._noData=[],this._markerId=0,this._markerData={},this._noAddressData=[],this._addressMarker=null,a.apply(this,arguments)},render:function(){var e=new t.Deferred,r=this,d=this.model,n=(d.getTexts(),""),l="";return a.prototype.render.apply(this,arguments),this.$el.addClass("report-no-footer distance-report"),this.buildMetaInfo(),h.separateRows.call(this),this._haveData.length&&(n=o({propNames:this.mobileProps,properties:d.get("properties"),i18n:d.getTexts()}),n+=h.buildRows.call(this),l+=s({key:d.get("key"),theadHtml:"",tbodyHtml:n})),this._noData.length&&(l+=i({i18n:d.getTexts(),propNames:this.mobileProps,properties:d.get("properties"),tbodyHtml:h.buildNoDataRows.call(this)})),this.content.append(l),this._noAddressData.length&&this.listenTo(this.model,"afterrender",function(){d.searchAddresses(r._noAddressData)}),h.putAddressMarker.call(this),this.content.find(".put-address-marker").on("click",function(){h.putAddressMarker.call(r)}),this._initMarkersLinks(function(t){r.putMarkers([t],{icon:new L.PinIcon({addClassName:"nearest-object-marker"}),popup:{type:"nearestObject"},zoom:!1});var e=d.get("module").getMapsModule().getWidget(),a=L.polyline([[d.get("lat"),d.get("lon")],[t.lat,t.lon]]);e.fitBounds(a.getBounds())}),e.resolve(),e},buildMetaInfo:function(){var t=this.model,e=t.getTexts();l.buildMetaInfo.call(this),this.content.find(".rep-meta").append(r({i18n:e,address:t.get("address"),distanceS:this.formatDistance(t.get("maxDistance")),dateS:this.formatDateTime(t.get("time")/App.MS),timeRange:t.get("timeRange")})).find(".dates").hide()}}),h={separateRows:function(){for(var t=this.model.get("body"),e=0,a=t.length;a>e;++e)"data"in t[e]?this._haveData.push(t[e]):this._noData.push(t[e])},buildRows:function(){var t,a,s,r=this,i=this.model,o=this._haveData,n=i.get("header"),l=n.sd*App.MS,p=n.ed*App.MS,h=i.get("properties"),m="",u=i.getTexts(),c=0;return e.each(o,function(i){a=[],s=[],e.each(h,function(t){a.push(t in i.obj?i.obj[t]:u.noData)}),t=e.extend({},i.data,{properties:a,id:i.obj.id,start:l,end:p,timeS:r.formatDateTime(i.data.time/App.MS),distanceS:r.formatDistance(i.data.distance/1e3),speedS:i.data.speed.toFixed(2),isLast:++c==o.length,loadAddress:u.loadAddress,buildAnother:u.build.ucFirst()+" "+u.reportsNames.movepark,markerId:++r._markerId,title:r.buildObjectTitleByProperties(i.obj)}),r._markerData[r._markerId]=t,m+=d(t)}),m},buildNoDataRows:function(){var t,a=this.model,s=this._noData,r=a.get("properties"),i="",o=a.getTexts(),d=0;return e.each(s,function(a){t=[],e.each(r,function(e){t.push(e in a.obj?a.obj[e]:o.noData)}),i+=n({properties:t,isLast:++d==s.length})}),i},putAddressMarker:function(){var t=this.model,e=t.get("module").getMapsModule();this._addressMarker&&this._markers.removeLayer(this._addressMarker);var a={lat:t.get("lat"),lon:t.get("lon"),title:t.get("address")};this._buildMarkersLayer(),this._addressMarker=e.getView().addAddressMarker(a,{openPopup:!1}).addTo(this._markers)}};return p});