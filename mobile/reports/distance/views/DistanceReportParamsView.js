define(["jquery","underscore","abstracts/View","maps/MapsModule","text!../tmpl/params.html","text!_common/reports/tmpl/deviceProps.html"],function(t,e,s,i,n,a){n=e.template(n),a=e.template(a);var r=s.prototype,l=s.extend({constructor:function(){this.controller=null,this._mapsModule=null,this._marker=null,this.$searchForm=null,this.$searchInput=null,this.$lat=null,this.$lon=null,this._data={},this._lat=0,this._lon=0,s.apply(this,arguments)},className:"distance-params",initialize:function(t){this.controller=t.controller,r.initialize.apply(this,arguments)},render:function(t){var s=this.controller.getTexts(),i=App.modules.maps.getView().getWidget().getCenter();return this._data=e.extend({address:"",lat:i.lat,lon:i.lon,maxDistance:1,timeRange:10},this.controller.get("parent").getUserData("distance")||{}),this.$el.html(n(e.extend({},this._data,{i18n:s,propertiesHtml:a({i18n:s,properties:t})}))),this.$el},setContainer:function(){this.$searchForm=this.$el.find(".form-search"),this.$searchInput=this.$el.find("input[name=address]"),this.$lat=this.$el.find("input[name=lat]"),this.$lon=this.$el.find("input[name=lon]"),this._initMap(),this._bindEvents(),this._initSearch(),this.$el.find(".positive").numeric({decimal:".",negative:!1})},_bindEvents:function(){var t=this,e=this.controller.getTexts();this._mapsModule.getView().getWidget(),this.$searchForm.find(".btn-search").on("click",function(){t._search()}),this.$searchForm.find(".icon-clear").on("click",function(){t._clearSearch()}),this._data.address&&this._data.lat&&this._data.lon&&this.listenTo(this._mapsModule,"ready",function(){setTimeout(function(){t._onAddressFound([t._data])},100)}),this.on("searchsuccess",function(e){t._onAddressFound(e)}).on("searcherror",function(){alert(e.commonSearchError)}).on("suggestsuccess",function(t,e){e&&e(t)}).on("suggestcomplete",function(){t.$searchInput.removeClass("ui-autocomplete-loading")})},_initMap:function(){var t=App.modules.maps.get("usedMap"),e=[this._data.lat,this._data.lon];this._mapsModule=new i({id:"reports/distance/params/maps",container:this.$el.find(".map"),parent:this.controller,usedMap:-1!=t.indexOf("Yandex")?"YandexMap":"GoogleMap",center:e[0]&&e[1]?e:App.modules.maps.getView().getWidget().getCenter()})},_initSearch:function(){var t=this,e=this._mapsModule,s=this.$searchInput,i=e.getView().getWidget();s.autocomplete({minLength:2,source:function(s,n){var a={q:s.term,type:"address",center:i.getCenter(),bounds:i.getBounds()};e.publish("needsuggest",a,n,t)},select:function(e,i){return i.item&&(s.val(i.item.value),t._search(i.item.original||null)),window.setTimeout(function(){s.blur()},0),!1}})},_search:function(e){var s=t.trim(this.$searchInput.val());if(s.length){this.$searchForm.addClass("active");var i=this._mapsModule.getView().getWidget(),n={q:s,type:"address",center:i.getCenter()};this._mapsModule.publish("needsearch",n,this,e||null)}},_clearSearch:function(){this._marker&&this._marker.trigger("destroy"),this.$lat.val(""),this.$lon.val(""),this.$searchForm.removeClass("active"),this.$searchInput.val("").focus()},_onAddressFound:function(t){if(!t.length&&!t.address)return this._marker&&this._marker.trigger("destroy"),this.$lat.val(""),this.$lon.val(""),alert(this.controller.getTexts().nothingFoundByYourRequest);if(t.length){var e=this,s=t[0],i=this._mapsModule.getView().getWidget();this._marker&&this._marker.trigger("destroy"),this.$lat.val(s.lat),this.$lon.val(s.lon),this._marker=i.addAddressMarker(s,{popup:!1,routingModule:null}),i.zoom({to:14,center:s}),this._marker.on("dragend",function(){var t=e._marker.getLatLng();e.$lat.val(t.lat),e.$lon.val(t.lng),e._mapsModule.trigger("needgeoinfo",t,e)})}else this.$searchInput.val(t.address)}});return l});