define(["jquery","underscore","_libs/charts/Chart","dashboard/views/DashboardWidgetView","text!dashboard/objq/tmpl/content.html","text!dashboard/objq/tmpl/settings.html"],function(t,e,s,i,n,a){n=e.template(n),a=e.template(a);var o=".rag-bars-bar, .rag-figs-fig, .rag-txts-txt",l=i.extend({constructor:function(){this.total=null,i.apply(this,arguments)},initialize:function(){this.$el.addClass("d-objq"),i.prototype.initialize.apply(this,arguments)},render:function(){var t=this.model,e=t.getTexts();r.bindEvents.call(this),i.prototype.render.call(this,{content:n({i18n:e,subTitle:t.getSubTitle()}),settings:this.renderSettings()}),this.content.addClass("selectable"),this.total=this.$el.find(".total")},renderSettings:function(){var t=this.model,e=t.getTexts(),s=t.get("options")||{};return a({id:t.id,served:s.served,i18n:e})},update:function(){var t=this.model,s=t.getTexts(),i=(t.get("options"),t.get("total"));if(i){-1!=this.el.className.indexOf("empty")&&this.$el.removeClass("empty"),this.total.text(i);var n=this,a=0;e.each({mobile:String(App.TYPE_MOBILE),stat:String(App.TYPE_STAT)},function(e,o){if(App.hasModule(o)){var l=t.get(e);if("mobile"==o)a=Math.round(100*l/i),100==a&&i>l&&(a=Math._round(100*l/i,1));else{var r=100-a;a=Math.round(r),0==a&&l>0&&(a=Math._round(r,1))}n.$el.find("."+o+"-nb").text(l).end().find("."+o+"-percent").text(a).end().find("."+o+"-text").text(s.objectsLabels[s.whichLabels(l)])}}),this.$el.find(o).attr("title",s.showOnMap)}else this.$el.addClass("empty")}}),r={bindEvents:function(){var e=this;this.listenTo(this.model,"update",function(){this.model.has("total")&&e.update()}),this.$el.on("click",o,function(){if(!e.module.get("processing")){e.module.set("processing",!0);var s=t(this).data("type");e.$el.addClass("loading"),e.model.getDevices(s).done(function(t){App.trigger("showobjects",t)}).fail(function(s){var i=e.model.getTexts(),n=i.error,a=i.errDevicesLoadingFailed;try{a=t.parseJSON(s.responseText).msg}catch(o){}alert(a,n)}).always(function(){e.$el.removeClass("loading"),e.module.set("processing",!1)})}})}};return l});