define(["jquery","underscore","abstracts/Module","storage","jface","text!./tmpl/resetPassword.html","i18n!resetPassword/nls/resetPassword","jquerytiny"],function(e,r,t,o,n,s,a){function i(){var e={},r=Backbone.history.location.search;if(!r)return e;r=r.replace(/^\?/,"");for(var t,o=r.split("&"),n=0,s=o.length;s>n;n++)t=o[n].split("="),2==t.length&&(e[decodeURIComponent(t[0])]=decodeURIComponent(t[1]));return e}e.ajaxSetup({crossDomain:!0,method:"POST",type:"POST",dataType:"json",processData:!1,contentType:"application/json",traditional:!0,beforeSend:function(e,r){r.data=JSON.stringify(r.data),"GET"==r.type&&(r.type="POST"),e.setRequestHeader("Accept-Language",LOCALE)}});var c=o,l="",u=null,d=t.extend({constructor:function(){window.App=this,this._form=null,t.apply(this,arguments)},defaults:r.extend({},t.prototype.defaults,{code:""}),initialize:function(){var t=this;this.on("authsuccess",function(e){t.getStorage().rootSet("user",e)}),this.on("localechange",function(e){setCookie("locale",e,180),window.location.reload()}),f.loadServerSettings().done(function(o){var n=o;t.setBaseUrl((o.protocol||"http")+"://"+o.host+(o.port?":"+o.port:"")+"/clientmanager-rest/"),t.render(),f.validateServer.call(t,o).done(function(){u=n,f.loadServerSkin().done(function(e){r.extend(u,e),f.onSkinResolve.call(t)}).fail(function(){f.onSkinResolve.call(t)})}).fail(function(r){e("#connecting").addClass("hidden"),alert(a.error+". "+r)})})},render:function(){e("#page").html(r.template(s,{i18n:a})),n.init(),n.addDialogs()},getStorage:function(){return c},getLocale:function(){return LOCALE},getLocaleName:function(){var e={"ru-ru":"Русский","en-en":"English","it-it":"Italiano"};return e[LOCALE]},setBaseUrl:function(e){l=e},getBaseUrl:function(){return l},getServerSettings:function(){return u},validate:function(t){var o=[],n=50;if(r.each(t,function(r,o){t[o]=e.trim(r)}),t.password){var s=!1,i=/[а-яё]/i;t.password.length>n&&(o.push({key:"password",msg:a.errPassLength.replace("#max#",n)}),s=!0),i.test(t.password)&&(o.push({key:"password",msg:a.errPassCyr}),s=!0),-1!=t.password.indexOf(":")&&(o.push({key:"password",msg:a.errPassColon}),s=!0),s||t.passwordRepeat==t.password||o.push({key:"passwordRepeat",msg:t.password&&t.passwordRepeat!=t.password?a.errPassRepeat:""})}else o.push({key:"password",msg:a.errPass});return o.length?o:null},showErrors:function(t){var o=this._form;if(r.isArray(t)){var n=[];r.each(t,function(e){o.find("[name="+e.key+"]").closest(".control-group").addClass("error"),e.msg&&n.push(e.msg+".")}),alert(n.join("<br />"),a.error,{closeCallback:function(){o.find(".control-group.error:first input").focus()}})}else if(t.responseText){var s;(s=e.parseJSON(t.responseText))?alert(s.msg,s.hdr||a.error):alert(a.callServerFailed,a.error)}else alert(a.callServerFailed,a.error)}}),f={loadServerSettings:function(){return e.ajax({url:"./config/server.json",method:"GET",type:"GET",cache:!1,crossDomain:!1,processData:!0})},validateServer:function(r){var t=new e.Deferred;return e.ajax({method:"post",timeout:1e3,url:(r.protocol||"http")+"://"+r.host+(r.port?":"+r.port:"")+"/clientmanager-rest/ping/"}).done(function(e){t.resolve(e)}).fail(function(e,r){switch(r){case"timeout":t.reject(a.serverConnectionTimeout);break;default:t.reject(a.serverConnection)}}),t},loadServerSkin:function(){return e.ajax({url:"./config/skin.json",method:"GET",type:"GET",cache:!1,crossDomain:!1,processData:!0})},onSkinResolve:function(){var r=this;e("#connecting").addClass("hidden"),u.skinUrl?requirejs(["css!"+u.skinUrl],function(){f.startReset.call(r)}):f.startReset.call(r)},startReset:function(){var r=this,t=i(),o=e("#reset-box").removeClass("hidden");this.set("code",t.code||"");var n=this._form=o.find("form");n.find("input[type=password]").first().focus(),this._form.on("submit",function(){return n.addClass("loading").find(".error").removeClass("error"),f.save.call(r).done(function(e){f.onSuccess.call(r,e)}).fail(function(e){r.showErrors(e)}).always(function(){n.removeClass("loading")}),!1})},save:function(){var r,t=new e.Deferred,o=this._form,n=o.serializeObject();return(r=this.validate(n))?t.reject(r):(delete n.passwordRepeat,n.uid=this.get("code"),e.ajax({url:this.getBaseUrl()+"clients/set-password/",data:n,success:function(e){e.password=n.password,e.login=e.username,t.resolve(e)},error:function(e){t.reject(e)}})),t},onSuccess:function(e){var r=this;this._form.addClass("loading"),f.authorize.call(this,e.login,e.password).done(function(e){c.rootSet("user",e),setTimeout(function(){r._form.removeClass("loading"),window.location.href="index.html?confirmed=1"},100)}).fail(function(e){r._form.removeClass("loading"),r.showErrors(e)})},getRestapiBase:function(){return(u.protocol||"http")+"://"+u.host+(u.port?":"+u.port:"")+(u.connector?"/"+u.connector:"")+"/"},authorize:function(r,t){return e.ajax({url:f.getRestapiBase()+"users/login/",timeout:1e4,data:{login:r,password:t}})}};return d});